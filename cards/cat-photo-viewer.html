<h2 id="cat-photo-viewer" style="margin-top:0;">Cat Photo Viewer</h2>

<form aria-describedby="cpv-desc">
  <p id="cpv-desc" class="small">
    Browse cat photos from free public APIs. Features infinite scrolling, favorites, and breed info.
  </p>

  <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
    <div class="field">
      <label for="cpv-breed">Breed</label>
      <select id="cpv-breed" style="width:100%;">
        <option value="all">All Breeds</option>
        <option value="abys">Abyssinian</option>
        <option value="beng">Bengal</option>
        <option value="birm">Birman</option>
        <option value="bsho">British Shorthair</option>
        <option value="pers">Persian</option>
        <option value="mcoo">Maine Coon</option>
        <option value="siam">Siamese</option>
        <option value="ragd">Ragdoll</option>
        <option value="sphy">Sphynx</option>
        <option value="norw">Norwegian Forest</option>
      </select>
    </div>
    
    <div class="field">
      <label for="cpv-order">Order</label>
      <select id="cpv-order" style="width:100%;">
        <option value="RANDOM" selected>Random</option>
        <option value="ASC">Newest</option>
        <option value="DESC">Oldest</option>
      </select>
    </div>
  </div>

  <div class="actions" style="margin-top:12px;">
    <button type="button" onclick="loadMoreCats()" style="background:#4dabf7;">Load More Cats</button>
    <button type="button" onclick="toggleFavoritesView()" id="cpv-fav-toggle">Show Favorites (0)</button>
    <button type="button" onclick="refreshCats()" class="secondary">Refresh</button>
  </div>
</form>

<div id="cpv-status" style="margin-top:12px; padding:8px 12px; border-radius:6px; background:#f8f9fa; display:none;">
  <div class="small" id="cpv-status-text"></div>
</div>

<div style="margin-top:12px;">
  <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
    <h3 class="small" style="margin:0;">Cat Gallery</h3>
    <div class="small" style="opacity:0.7;">
      <span id="cpv-count-display">0</span> cats loaded
    </div>
  </div>
  
  <div id="cpv-output" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;"></div>
  
  <div id="cpv-empty" style="text-align:center; padding:40px 20px; background:#f8f9fa; border-radius:8px; display:none;">
    <div style="font-size:1.2em; color:#6c757d; margin-bottom:8px;">No cats to display</div>
    <div class="small" style="opacity:0.7;">Click "Load More Cats" to fetch some feline friends!</div>
  </div>
  
  <div style="text-align:center; margin-top:16px;">
    <button onclick="loadMoreCats()" style="padding:8px 24px; background:#4dabf7; color:white; border:none; border-radius:6px; cursor:pointer;">
      Load More Cats
    </button>
  </div>
</div>

<div id="cpv-favorites-view" style="margin-top:20px; display:none;">
  <h4 class="small">Your Favorite Cats</h4>
  <div id="cpv-favorites" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;margin-top:8px;"></div>
  <div id="cpv-no-favs" style="text-align:center; padding:20px; background:#f8f9fa; border-radius:8px; display:none;">
    <div class="small" style="opacity:0.7;">No favorite cats yet. Click the heart on any cat to add it!</div>
  </div>
</div>

<script>
/* Cat Photo Viewer - Multiple API Sources
   Using actual working public cat APIs
*/

let allCats = [];
let favorites = JSON.parse(localStorage.getItem('catFavorites') || '[]');
let currentPage = 0;
let isLoading = false;
let isFavoritesView = false;
let currentBreed = 'all';

// Breed information mapping
const breedInfo = {
  'abys': { name: 'Abyssinian', desc: 'Active, playful, and intelligent' },
  'beng': { name: 'Bengal', desc: 'Energetic, confident, and athletic' },
  'birm': { name: 'Birman', desc: 'Gentle, affectionate, and calm' },
  'bsho': { name: 'British Shorthair', desc: 'Easygoing, loyal, and dignified' },
  'pers': { name: 'Persian', desc: 'Sweet, gentle, and quiet' },
  'mcoo': { name: 'Maine Coon', desc: 'Gentle giant, friendly, and intelligent' },
  'siam': { name: 'Siamese', desc: 'Vocal, affectionate, and intelligent' },
  'ragd': { name: 'Ragdoll', desc: 'Docile, affectionate, and relaxed' },
  'sphy': { name: 'Sphynx', desc: 'Energetic, affectionate, and outgoing' },
  'norw': { name: 'Norwegian Forest', desc: 'Sweet, gentle, and intelligent' }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  updateFavoriteCount();
  loadMoreCats();
  
  // Setup breed selector change
  document.getElementById('cpv-breed').addEventListener('change', function() {
    currentBreed = this.value;
    refreshCats();
  });
  
  // Setup infinite scroll
  window.addEventListener('scroll', function() {
    if (isFavoritesView || isLoading) return;
    
    const scrollPosition = window.innerHeight + window.scrollY;
    const pageHeight = document.documentElement.offsetHeight;
    
    if (scrollPosition >= pageHeight - 500) {
      loadMoreCats();
    }
  });
});

function showStatus(message, type) {
  const status = document.getElementById('cpv-status');
  const text = document.getElementById('cpv-status-text');
  
  if (!status || !text) return;
  
  status.style.display = 'block';
  status.style.background = type === 'error' ? '#f8d7da' : 
                           type === 'success' ? '#d4edda' : '#f8f9fa';
  status.style.borderLeft = `4px solid ${type === 'error' ? '#dc3545' : 
                                               type === 'success' ? '#28a745' : 
                                               '#4dabf7'}`;
  text.textContent = message;
}

function hideStatus() {
  const status = document.getElementById('cpv-status');
  if (status) {
    status.style.display = 'none';
  }
}

async function loadMoreCats() {
  if (isLoading) return;
  
  isLoading = true;
  currentPage++;
  showStatus(`Loading more cats... (Page ${currentPage})`, 'info');
  
  try {
    const breed = currentBreed;
    const order = document.getElementById('cpv-order').value;
    const newCats = await fetchCatsFromAPI(breed, order, currentPage);
    
    if (newCats.length === 0) {
      showStatus('No more cats available for this breed', 'info');
      isLoading = false;
      return;
    }
    
    // Filter out duplicates
    const existingIds = allCats.map(cat => cat.id);
    const uniqueNewCats = newCats.filter(cat => !existingIds.includes(cat.id));
    
    if (uniqueNewCats.length === 0) {
      // All cats were duplicates, try next page
      currentPage++;
      const moreCats = await fetchCatsFromAPI(breed, order, currentPage);
      allCats.push(...moreCats);
    } else {
      allCats.push(...uniqueNewCats);
    }
    
    renderCats();
    document.getElementById('cpv-count-display').textContent = allCats.length;
    
    // Hide empty state
    document.getElementById('cpv-empty').style.display = 'none';
    
    showStatus(`Loaded ${uniqueNewCats.length} new cats! Total: ${allCats.length}`, 'success');
    setTimeout(hideStatus, 2000);
    
  } catch (error) {
    console.error('Error loading cats:', error);
    showStatus('Failed to load cats. Trying alternative source...', 'error');
    
    // Try fallback
    try {
      const fallbackCats = await fetchFallbackCats();
      allCats.push(...fallbackCats);
      renderCats();
      showStatus(`Loaded ${fallbackCats.length} cats from fallback source`, 'success');
      setTimeout(hideStatus, 2000);
    } catch (fallbackError) {
      showStatus('All sources failed. Please try again later.', 'error');
      setTimeout(hideStatus, 3000);
    }
  }
  
  isLoading = false;
}

async function fetchCatsFromAPI(breed, order, page) {
  // Use multiple API endpoints for better reliability
  const endpoints = [
    // Primary: Cat API
    breed === 'all' 
      ? `https://api.thecatapi.com/v1/images/search?limit=12&order=${order}&page=${page}`
      : `https://api.thecatapi.com/v1/images/search?limit=12&breed_ids=${breed}&order=${order}&page=${page}`,
    
    // Secondary: Cataas API (Cat as a Service)
    `https://cataas.com/cat?json=true&limit=12&skip=${(page-1)*12}`,
    
    // Tertiary: Random cat images
    `https://aws.random.cat/meow`
  ];
  
  try {
    // Try first endpoint
    const response = await fetch(endpoints[0], {
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      }
    });
    
    if (response.ok) {
      const cats = await response.json();
      return cats.map(cat => ({
        id: cat.id || `cat-${Date.now()}-${Math.random()}`,
        url: cat.url,
        width: cat.width,
        height: cat.height,
        breeds: cat.breeds || []
      }));
    }
  } catch (e) {
    console.log('Primary API failed, trying secondary...');
  }
  
  // Try secondary endpoint
  try {
    if (page === 1) { // Cataas doesn't support pagination well, only use for first page
      const response = await fetch(endpoints[1]);
      const data = await response.json();
      
      if (Array.isArray(data)) {
        return data.map(cat => ({
          id: cat._id || `cataas-${Date.now()}`,
          url: `https://cataas.com${cat.url || '/cat'}`,
          width: 400,
          height: 400
        }));
      }
    }
  } catch (e) {
    console.log('Secondary API failed');
  }
  
  // Fallback to random cat
  try {
    const response = await fetch(endpoints[2]);
    const data = await response.json();
    
    return [{
      id: `random-${Date.now()}`,
      url: data.file || 'https://cataas.com/cat',
      width: 500,
      height: 500
    }];
  } catch (e) {
    throw new Error('All APIs failed');
  }
}

async function fetchFallbackCats() {
  // Static fallback cat images from reliable sources
  const fallbackUrls = [
    'https://cdn2.thecatapi.com/images/0XYvRd7oD.jpg',
    'https://cdn2.thecatapi.com/images/1PQYQB2rC.jpg',
    'https://cdn2.thecatapi.com/images/3pj-qSgGg.jpg',
    'https://cdn2.thecatapi.com/images/6phcmqG5H.jpg',
    'https://cdn2.thecatapi.com/images/9u1A2vK5t.jpg',
    'https://cdn2.thecatapi.com/images/a3b.jpg',
    'https://cdn2.thecatapi.com/images/bn.jpg',
    'https://cdn2.thecatapi.com/images/cj.jpg',
    'https://cdn2.thecatapi.com/images/dp.jpg',
    'https://cdn2.thecatapi.com/images/ed.jpg'
  ];
  
  return fallbackUrls.map((url, index) => ({
    id: `fallback-${index}-${Date.now()}`,
    url: url,
    width: 500,
    height: 500
  }));
}

function renderCats() {
  const output = document.getElementById('cpv-output');
  if (!output) return;
  
  // Clear and render all cats
  output.innerHTML = '';
  
  allCats.forEach(cat => {
    const catCard = createCatCard(cat);
    output.appendChild(catCard);
  });
}

function createCatCard(cat) {
  const card = document.createElement('div');
  card.className = 'cat-card';
  card.style.cssText = `
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    background: white;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    cursor: pointer;
  `;
  
  const isFavorite = favorites.some(fav => fav.id === cat.id);
  
  // Image
  const img = document.createElement('img');
  img.loading = 'lazy';
  img.src = cat.url;
  img.alt = 'Cat photo';
  img.style.cssText = `
    width: 100%;
    height: 180px;
    object-fit: cover;
    display: block;
    transition: transform 0.3s ease;
  `;
  
  // Placeholder while loading
  img.style.background = '#f8f9fa';
  img.onload = function() {
    this.style.background = 'none';
  };
  
  img.onerror = function() {
    // Use fallback image if this one fails
    this.src = 'https://cdn2.thecatapi.com/images/0XYvRd7oD.jpg';
  };
  
  // Favorite button
  const favButton = document.createElement('button');
  favButton.innerHTML = isFavorite ? '‚ù§Ô∏è' : 'ü§ç';
  favButton.style.cssText = `
    position: absolute;
    top: 8px;
    right: 8px;
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 36px;
    height: 36px;
    font-size: 18px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    z-index: 10;
  `;
  
  favButton.onclick = function(e) {
    e.stopPropagation();
    toggleFavorite(cat);
    this.innerHTML = favorites.some(fav => fav.id === cat.id) ? '‚ù§Ô∏è' : 'ü§ç';
    updateFavoriteCount();
  };
  
  // Info overlay (appears on hover)
  const infoOverlay = document.createElement('div');
  infoOverlay.style.cssText = `
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    background: linear-gradient(transparent, rgba(0,0,0,0.7));
    color: white;
    padding: 12px;
    transform: translateY(100%);
    transition: transform 0.3s ease;
    font-size: 0.85em;
  `;
  
  if (currentBreed !== 'all' && breedInfo[currentBreed]) {
    infoOverlay.innerHTML = `
      <div style="font-weight:500; margin-bottom:4px;">${breedInfo[currentBreed].name}</div>
      <div>${breedInfo[currentBreed].desc}</div>
    `;
  } else {
    infoOverlay.innerHTML = `
      <div style="font-weight:500;">Click to view larger</div>
    `;
  }
  
  // Hover effects
  card.onmouseenter = function() {
    this.style.transform = 'translateY(-4px)';
    this.style.boxShadow = '0 8px 16px rgba(0,0,0,0.1)';
    img.style.transform = 'scale(1.05)';
    infoOverlay.style.transform = 'translateY(0)';
  };
  
  card.onmouseleave = function() {
    this.style.transform = 'translateY(0)';
    this.style.boxShadow = 'none';
    img.style.transform = 'scale(1)';
    infoOverlay.style.transform = 'translateY(100%)';
  };
  
  // Click to view larger
  card.onclick = function() {
    const modal = document.createElement('div');
    modal.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      cursor: pointer;
    `;
    
    const modalImg = document.createElement('img');
    modalImg.src = cat.url;
    modalImg.style.cssText = `
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
      border-radius: 8px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    `;
    
    modal.appendChild(modalImg);
    document.body.appendChild(modal);
    
    modal.onclick = function() {
      document.body.removeChild(modal);
    };
  };
  
  // Assemble card
  card.appendChild(img);
  card.appendChild(favButton);
  card.appendChild(infoOverlay);
  
  return card;
}

function toggleFavorite(cat) {
  const existingIndex = favorites.findIndex(fav => fav.id === cat.id);
  
  if (existingIndex !== -1) {
    favorites.splice(existingIndex, 1);
    showStatus('Removed from favorites', 'info');
  } else {
    favorites.push({
      id: cat.id,
      url: cat.url,
      added: new Date().toISOString()
    });
    showStatus('Added to favorites! ‚ù§Ô∏è', 'success');
  }
  
  localStorage.setItem('catFavorites', JSON.stringify(favorites));
  
  if (isFavoritesView) {
    showFavoritesView();
  }
  
  setTimeout(hideStatus, 2000);
}

function updateFavoriteCount() {
  const favToggle = document.getElementById('cpv-fav-toggle');
  if (favToggle) {
    favToggle.textContent = `Show Favorites (${favorites.length})`;
  }
}

function toggleFavoritesView() {
  isFavoritesView = !isFavoritesView;
  const favView = document.getElementById('cpv-favorites-view');
  const gallery = document.getElementById('cpv-output').parentElement;
  const favToggle = document.getElementById('cpv-fav-toggle');
  
  if (isFavoritesView) {
    favView.style.display = 'block';
    gallery.style.display = 'none';
    favToggle.textContent = 'Show Gallery';
    favToggle.style.background = '#ff6b6b';
    showFavoritesView();
  } else {
    favView.style.display = 'none';
    gallery.style.display = 'block';
    favToggle.textContent = `Show Favorites (${favorites.length})`;
    favToggle.style.background = '';
  }
}

function showFavoritesView() {
  const favoritesContainer = document.getElementById('cpv-favorites');
  const noFavs = document.getElementById('cpv-no-favs');
  
  if (!favoritesContainer) return;
  
  if (favorites.length === 0) {
    favoritesContainer.innerHTML = '';
    noFavs.style.display = 'block';
    return;
  }
  
  noFavs.style.display = 'none';
  favoritesContainer.innerHTML = '';
  
  favorites.forEach(fav => {
    const favCard = document.createElement('div');
    favCard.style.cssText = `
      position: relative;
      border-radius: 8px;
      overflow: hidden;
      background: white;
      border: 1px solid #dee2e6;
    `;
    
    const img = document.createElement('img');
    img.src = fav.url;
    img.alt = 'Favorite cat';
    img.style.cssText = `
      width: 100%;
      height: 140px;
      object-fit: cover;
      display: block;
    `;
    
    // Remove button
    const removeBtn = document.createElement('button');
    removeBtn.innerHTML = '‚ùå';
    removeBtn.style.cssText = `
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      font-size: 14px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    `;
    
    removeBtn.onclick = function(e) {
      e.stopPropagation();
      toggleFavorite(fav);
      showFavoritesView();
    };
    
    favCard.appendChild(img);
    favCard.appendChild(removeBtn);
    favoritesContainer.appendChild(favCard);
  });
}

function refreshCats() {
  allCats = [];
  currentPage = 0;
  document.getElementById('cpv-output').innerHTML = '';
  document.getElementById('cpv-empty').style.display = 'block';
  document.getElementById('cpv-count-display').textContent = '0';
  
  if (isFavoritesView) {
    toggleFavoritesView();
  }
  
  loadMoreCats();
}
</script>

<style>
.cat-card:hover {
  cursor: pointer;
}

.cat-card img {
  transition: transform 0.3s ease;
}

.actions button {
  transition: all 0.2s ease;
}

.actions button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

button {
  cursor: pointer;
}

#cpv-favorites-view {
  transition: opacity 0.3s ease;
}

@media (max-width: 768px) {
  #cpv-output {
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 8px;
  }
  
  .actions {
    flex-wrap: wrap;
  }
  
  .actions button {
    flex: 1;
    min-width: 120px;
    margin-bottom: 4px;
  }
}
</style>
