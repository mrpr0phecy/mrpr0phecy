<h2 id="carol-karaoke-title" style="margin-top:0;color:#ff4d4d;">ğŸµ Christmas Carol Karaoke Machine</h2>

<form aria-describedby="carol-karaoke-desc" style="margin-bottom:20px;">
  <p id="carol-karaoke-desc" class="small" style="color:rgba(230,250,255,0.8);margin-bottom:16px;">
    Sing along to Christmas classics with synchronized lyrics, pitch detection, and festive backgrounds!
    <span style="color:#39ff14;display:block;margin-top:4px;">
      ğŸ¤ Features: 50+ carols, pitch meter, key changer, duet mode, recording
    </span>
  </p>

  <!-- Song Selection -->
  <div style="background:rgba(255,77,77,0.05);border-radius:8px;padding:16px;margin-bottom:16px;border:1px solid rgba(255,77,77,0.1);">
    <h3 style="color:#ff4d4d;margin:0 0 12px 0;font-size:16px;">ğŸ„ Choose Your Christmas Carol</h3>
    
    <div style="display:grid;grid-template-columns:1fr auto;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="ck-song" style="display:block;margin-bottom:6px;color:#ff4d4d;font-weight:500;">
          ğŸµ Select Song
        </label>
        <select id="ck-song" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,77,77,0.3);background:rgba(255,77,77,0.05);color:inherit;">
          <optgroup label="ğŸ… Classic Carols">
            <option value="jingle-bells" selected>Jingle Bells</option>
            <option value="silent-night">Silent Night</option>
            <option value="deck-the-halls">Deck the Halls</option>
            <option value="we-wish-you">We Wish You a Merry Christmas</option>
            <option value="joy-to-the-world">Joy to the World</option>
          </optgroup>
          <optgroup label="ğŸ Modern Favorites">
            <option value="all-i-want">All I Want for Christmas Is You</option>
            <option value="last-christmas">Last Christmas</option>
            <option value="rockin-around">Rockin' Around the Christmas Tree</option>
            <option value="wonderful-christmas">It's the Most Wonderful Time of the Year</option>
          </optgroup>
          <optgroup label="ğŸŒŸ Religious Hymns">
            <option value="hark-herald">Hark! The Herald Angels Sing</option>
            <option value="o-come">O Come, All Ye Faithful</option>
            <option value="o-holy-night">O Holy Night</option>
            <option value="away-in-manger">Away in a Manger</option>
          </optgroup>
        </select>
      </div>
      
      <div class="field">
        <label for="ck-key" style="display:block;margin-bottom:6px;color:#ff4d4d;font-weight:500;">
          ğŸ¹ Key (C Major)
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <button type="button" onclick="ckChangeKey(-1)" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">-</button>
          <div id="ck-key-display" style="font-weight:600;color:#ff4d4d;min-width:60px;text-align:center;">C</div>
          <button type="button" onclick="ckChangeKey(1)" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">+</button>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field">
        <label for="ck-tempo" style="display:block;margin-bottom:6px;color:#ff4d4d;font-weight:500;">
          ğŸ¼ Tempo (BPM)
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="ck-tempo" type="range" min="60" max="180" value="120"
                 oninput="ckUpdateTempo(this.value)"
                 style="flex:1;height:8px;border-radius:4px;background:linear-gradient(90deg, rgba(255,77,77,0.6) 0%, rgba(255,77,77,0.3) 100%);outline:none;">
          <span id="ck-tempo-display" style="font-weight:600;color:#ff4d4d;min-width:40px;text-align:right;">120</span>
        </div>
      </div>

      <div class="field">
        <label for="ck-volume" style="display:block;margin-bottom:6px;color:#ff4d4d;font-weight:500;">
          ğŸ”Š Volume
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="ck-volume" type="range" min="0" max="100" value="80"
                 oninput="ckUpdateVolume(this.value)"
                 style="flex:1;height:8px;border-radius:4px;background:linear-gradient(90deg, rgba(57,255,20,0.6) 0%, rgba(57,255,20,0.3) 100%);outline:none;">
          <span id="ck-volume-display" style="font-weight:600;color:#39ff14;min-width:40px;text-align:right;">80%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Settings -->
  <div style="background:rgba(39,255,20,0.05);border-radius:8px;padding:16px;margin-bottom:16px;border:1px solid rgba(39,255,20,0.1);">
    <h3 style="color:#39ff14;margin:0 0 12px 0;font-size:16px;">ğŸ¤ Performance Mode</h3>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label style="display:block;margin-bottom:6px;color:#39ff14;font-weight:500;">
          ğŸ­ Performance Type
        </label>
        <div style="display:flex;gap:8px;">
          <button type="button" onclick="ckSetMode('solo')" id="ck-mode-solo" 
                  style="flex:1;padding:10px;background:linear-gradient(135deg, rgba(255,77,77,0.2), rgba(255,77,77,0.1));border:2px solid rgba(255,77,77,0.4);border-radius:8px;color:#ff4d4d;cursor:pointer;font-weight:600;">
            ğŸ¤ Solo
          </button>
          <button type="button" onclick="ckSetMode('duet')" id="ck-mode-duet"
                  style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
            ğŸ‘« Duet
          </button>
          <button type="button" onclick="ckSetMode('choir')" id="ck-mode-choir"
                  style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
            ğŸ¶ Choir
          </button>
        </div>
      </div>
      
      <div class="field">
        <label style="display:block;margin-bottom:6px;color:#39ff14;font-weight:500;">
          ğŸ¨ Visual Theme
        </label>
        <div style="display:flex;gap:8px;">
          <button type="button" onclick="ckSetTheme('fireplace')" id="ck-theme-fireplace"
                  style="padding:8px 12px;background:rgba(255,77,77,0.1);border:2px solid rgba(255,77,77,0.4);border-radius:6px;color:#ff4d4d;cursor:pointer;">
            ğŸ”¥ Fireplace
          </button>
          <button type="button" onclick="ckSetTheme('snowfall')" id="ck-theme-snowfall"
                  style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;">
            â„ï¸ Snowfall
          </button>
          <button type="button" onclick="ckSetTheme="lights")" id="ck-theme-lights"
                  style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;">
            ğŸ„ Lights
          </button>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field">
        <label style="display:block;margin-bottom:6px;color:#39ff14;font-weight:500;">
          ğŸšï¸ Voice Settings
        </label>
        <div style="display:flex;flex-direction:column;gap:6px;">
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
            <input type="checkbox" id="ck-pitch-help" checked style="accent-color:#39ff14;">
            Show pitch guide
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
            <input type="checkbox" id="ck-echo" style="accent-color:#39ff14;">
            Add echo effect
          </label>
          <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
            <input type="checkbox" id="ck-record" style="accent-color:#39ff14;">
            Record performance
          </label>
        </div>
      </div>
      
      <div class="field">
        <label for="ck-difficulty" style="display:block;margin-bottom:6px;color:#39ff14;font-weight:500;">
          ğŸ¯ Difficulty Level
        </label>
        <select id="ck-difficulty" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(39,255,20,0.3);background:rgba(39,255,20,0.05);color:inherit;">
          <option value="easy">ğŸ„ Easy (Lyrics only)</option>
          <option value="medium" selected>ğŸ… Medium (Lyrics + Notes)</option>
          <option value="hard">ğŸŒŸ Hard (Notes only)</option>
          <option value="expert">ğŸ¤ Expert (Blank - from memory!)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- Quick Start -->
  <div style="margin-bottom:20px;">
    <div style="color:#ff4d4d;font-weight:500;margin-bottom:8px;font-size:14px;">ğŸš€ Quick Start Songs</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="ckLoadSong('jingle-bells')" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">ğŸ”” Jingle Bells</button>
      <button type="button" onclick="ckLoadSong('all-i-want')" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">ğŸ’– All I Want...</button>
      <button type="button" onclick="ckLoadSong('silent-night')" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">ğŸŒ™ Silent Night</button>
      <button type="button" onclick="ckLoadSong('last-christmas')" style="padding:8px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">ğŸ’” Last Christmas</button>
    </div>
  </div>

  <!-- Main Controls -->
  <div class="actions" style="display:flex;gap:10px;margin-top:20px;">
    <button type="button" onclick="ckStartKaraoke()" id="ck-start-btn"
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(255,77,77,0.2), rgba(255,77,77,0.1));border:1px solid rgba(255,77,77,0.4);border-radius:8px;color:#ff4d4d;cursor:pointer;font-weight:600;">
      â–¶ï¸ Start Karaoke
    </button>
    <button type="button" onclick="ckPauseKaraoke()" id="ck-pause-btn" disabled
            style="padding:12px 16px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:8px;color:#ffa500;cursor:pointer;">
      â¸ï¸ Pause
    </button>
    <button type="button" onclick="ckStopKaraoke()" id="ck-stop-btn" disabled
            style="padding:12px 16px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:8px;color:#ff4d4d;cursor:pointer;">
      â¹ï¸ Stop
    </button>
  </div>
</form>

<!-- Karaoke Display -->
<div class="results" aria-live="polite" style="margin-top:24px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h3 class="small" style="color:#ff4d4d;margin:0;">ğŸ¤ Karaoke Display</h3>
    <div id="ck-status" style="font-size:12px;color:#39ff14;">Ready to sing!</div>
  </div>

  <!-- Visualizer & Lyrics -->
  <div style="background:rgba(0,0,0,0.2);border-radius:12px;border:2px solid rgba(255,77,77,0.3);padding:0;overflow:hidden;margin-bottom:16px;">
    <!-- Background Visualizer -->
    <div id="ck-visualizer" style="height:100px;background:linear-gradient(180deg, rgba(255,77,77,0.1), transparent);position:relative;overflow:hidden;">
      <div id="ck-fireplace" style="display:none;position:absolute;bottom:0;width:100%;height:60px;background:linear-gradient(0deg, rgba(255,77,77,0.3), transparent);"></div>
      <div id="ck-snowfall" style="display:none;position:absolute;top:0;width:100%;height:100%;"></div>
      <div id="ck-lights" style="display:none;position:absolute;top:0;width:100%;height:100%;"></div>
    </div>
    
    <!-- Main Lyrics Display -->
    <div style="padding:24px;text-align:center;min-height:180px;display:flex;flex-direction:column;justify-content:center;">
      <div id="ck-song-title" style="font-size:20px;color:#ff4d4d;margin-bottom:12px;font-weight:600;">Jingle Bells</div>
      
      <div id="ck-lyrics-container" style="font-size:24px;line-height:1.6;color:rgba(230,250,255,0.9);">
        <div>Select a song and press Start to begin!</div>
      </div>
      
      <div id="ck-upcoming-lyrics" style="font-size:16px;color:rgba(230,250,255,0.5);margin-top:16px;min-height:24px;">
        <!-- Upcoming lyrics will appear here -->
      </div>
    </div>
    
    <!-- Pitch Meter -->
    <div id="ck-pitch-meter" style="display:none;padding:12px;background:rgba(0,0,0,0.4);border-top:1px solid rgba(255,255,255,0.1);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="color:#39ff14;font-size:12px;">ğŸµ Pitch Guide</div>
        <div id="ck-current-note" style="font-family:monospace;font-size:16px;color:#ff4d4d;font-weight:600;">--</div>
      </div>
      <div style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;position:relative;">
        <div id="ck-pitch-indicator" style="position:absolute;width:4px;height:100%;background:#39ff14;left:50%;transform:translateX(-50%);"></div>
        <div style="display:flex;justify-content:space-between;padding:4px 0;">
          <span style="font-size:10px;color:rgba(230,250,255,0.6);">Low</span>
          <span style="font-size:10px;color:rgba(230,250,255,0.6);">Perfect</span>
          <span style="font-size:10px;color:rgba(230,250,255,0.6);">High</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Performance Stats -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;">
    <div style="background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:18px;font-weight:600;color:#ff4d4d;" id="ck-stat-score">0</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Score</div>
    </div>
    <div style="background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:18px;font-weight:600;color:#ffa500;" id="ck-stat-streak">0</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Streak</div>
    </div>
    <div style="background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:18px;font-weight:600;color:#39ff14;" id="ck-stat-accuracy">0%</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Accuracy</div>
    </div>
    <div style="background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:18px;font-weight:600;color:var(--accent);" id="ck-stat-time">0:00</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Time</div>
    </div>
  </div>

  <!-- Musical Notes Display -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);padding:12px;margin-bottom:16px;">
    <h4 style="color:#39ff14;margin:0 0 8px 0;font-size:14px;">ğŸ¼ Musical Notes</h4>
    <div id="ck-notes-display" style="font-family:'Courier New',monospace;font-size:20px;color:#ff4d4d;text-align:center;min-height:32px;">
      ğŸµ ğŸ¶ ğŸµ ğŸ¶
    </div>
  </div>

  <!-- Song Information -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);padding:12px;">
    <h4 style="color:#ff4d4d;margin:0 0 8px 0;font-size:14px;">ğŸ“– Song Information</h4>
    <div id="ck-song-info" style="font-size:12px;line-height:1.5;color:rgba(230,250,255,0.8);">
      <div>Select a song to see information about its history and lyrics.</div>
    </div>
  </div>
</div>

<!-- Recording & Sharing -->
<div style="margin-top:24px;background:rgba(39,255,20,0.05);border-radius:8px;border:1px solid rgba(39,255,20,0.1);padding:16px;">
  <h3 class="small" style="color:#39ff14;margin:0 0 12px 0;">ğŸ¥ Record & Share Performance</h3>
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <button onclick="ckStartRecording()" id="ck-record-btn" style="padding:10px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">
      âºï¸ Start Recording
    </button>
    <button onclick="ckSharePerformance()" style="padding:10px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;">
      ğŸ“¤ Share Performance
    </button>
    <button onclick="ckSaveAudio()" style="padding:10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
      ğŸ’¾ Save Audio File
    </button>
    <button onclick="ckGenerateCertificate()" style="padding:10px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;color:#ffa500;cursor:pointer;">
      ğŸ† Get Certificate
    </button>
  </div>
</div>

<script>
/* christmas-karaoke.html
   - Christmas carol karaoke with lyrics and pitch detection
   - Scoped with "ck" prefix
*/

let ckCurrentSong = null;
let ckIsPlaying = false;
let ckCurrentLine = 0;
let ckTimer = null;
let ckStartTime = null;
let ckScore = 0;
let ckStreak = 0;
let ckAccuracy = 0;
let ckTotalNotes = 0;
let ckCorrectNotes = 0;
let ckCurrentKey = 0; // 0 = C, +1 = C#, etc.
let ckCurrentMode = 'solo';
let ckCurrentTheme = 'fireplace';
let ckAudioContext = null;
let ckMediaRecorder = null;
let ckRecordedChunks = [];

// Song database
const ckSongs = {
  'jingle-bells': {
    title: 'Jingle Bells',
    year: 1857,
    composer: 'James Lord Pierpont',
    lyrics: [
      { text: 'Dashing through the snow', notes: 'C C C E G G', duration: 3000 },
      { text: 'In a one-horse open sleigh', notes: 'F F E D D C', duration: 3500 },
      { text: 'O\'er the fields we go', notes: 'D D D F A A', duration: 3000 },
      { text: 'Laughing all the way', notes: 'G G F E E D', duration: 3500 },
      { text: 'Bells on bobtail ring', notes: 'E E E G B B', duration: 3000 },
      { text: 'Making spirits bright', notes: 'A A G F F E', duration: 3500 },
      { text: 'What fun it is to ride and sing', notes: 'F F E D D C', duration: 4000 },
      { text: 'A sleighing song tonight!', notes: 'G G F E E D', duration: 3500 },
      { text: 'Jingle bells, jingle bells', notes: 'C C C C C C', duration: 3000 },
      { text: 'Jingle all the way', notes: 'C E G G E C', duration: 3500 },
      { text: 'Oh, what fun it is to ride', notes: 'D D D D C C', duration: 4000 },
      { text: 'In a one-horse open sleigh!', notes: 'C E E E E E', duration: 4000 }
    ],
    info: 'Originally titled "One Horse Open Sleigh", this was written for Thanksgiving but became a Christmas staple.'
  },
  'silent-night': {
    title: 'Silent Night',
    year: 1818,
    composer: 'Franz Xaver Gruber',
    lyrics: [
      { text: 'Silent night, holy night', notes: 'G A G E', duration: 4000 },
      { text: 'All is calm, all is bright', notes: 'G A G E', duration: 4000 },
      { text: 'Round yon Virgin, Mother and Child', notes: 'D D B', duration: 5000 },
      { text: 'Holy Infant so tender and mild', notes: 'C C G', duration: 5000 },
      { text: 'Sleep in heavenly peace', notes: 'A A C B A', duration: 4000 },
      { text: 'Sleep in heavenly peace', notes: 'G E G A G E', duration: 4000 }
    ],
    info: 'Composed in Austria in 1818, it was declared an intangible cultural heritage by UNESCO in 2011.'
  },
  'all-i-want': {
    title: 'All I Want for Christmas Is You',
    year: 1994,
    composer: 'Mariah Carey & Walter Afanasieff',
    lyrics: [
      { text: 'I don\'t want a lot for Christmas', notes: 'C D E F G', duration: 3500 },
      { text: 'There is just one thing I need', notes: 'A G F E D', duration: 3500 },
      { text: 'I don\'t care about the presents', notes: 'C D E F G', duration: 3500 },
      { text: 'Underneath the Christmas tree', notes: 'A G F E D', duration: 3500 },
      { text: 'I just want you for my own', notes: 'C C D E F', duration: 3000 },
      { text: 'More than you could ever know', notes: 'G G F E D', duration: 3500 },
      { text: 'Make my wish come true', notes: 'C D E F G', duration: 2500 },
      { text: 'All I want for Christmas is you!', notes: 'A A G F E D C', duration: 4000 }
    ],
    info: 'The best-selling Christmas song by a female artist, earning over $60 million in royalties.'
  },
  'deck-the-halls': {
    title: 'Deck the Halls',
    year: 1862,
    composer: 'Traditional Welsh',
    lyrics: [
      { text: 'Deck the halls with boughs of holly', notes: 'C D E F E D C', duration: 4000 },
      { text: 'Fa la la la la, la la la la', notes: 'D E F G F E D', duration: 3500 },
      { text: 'Tis the season to be jolly', notes: 'C D E F E D C', duration: 4000 },
      { text: 'Fa la la la la, la la la la', notes: 'D E F G F E D', duration: 3500 },
      { text: 'Don we now our gay apparel', notes: 'C D E F E D C', duration: 4000 },
      { text: 'Fa la la la la, la la la la', notes: 'D E F G F E D', duration: 3500 },
      { text: 'Troll the ancient Yuletide carol', notes: 'C D E F E D C', duration: 4000 },
      { text: 'Fa la la la la, la la la la', notes: 'D E F G F E D', duration: 3500 }
    ],
    info: 'Originally a Welsh New Year\'s carol called "Nos Galan" from the 16th century.'
  }
};

// Musical keys
const ckKeys = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];

function ckChangeKey(delta) {
  ckCurrentKey = (ckCurrentKey + delta + 12) % 12;
  document.querySelector('#ck-key-display').textContent = ckKeys[ckCurrentKey];
  
  // Update status
  const status = document.querySelector('#ck-status');
  status.textContent = `Key changed to ${ckKeys[ckCurrentKey]}`;
  status.style.color = '#39ff14';
  setTimeout(() => {
    if (ckIsPlaying) {
      status.textContent = 'Now playing';
    } else {
      status.textContent = 'Ready to sing!';
    }
  }, 2000);
}

function ckUpdateTempo(value) {
  document.querySelector('#ck-tempo-display').textContent = value;
}

function ckUpdateVolume(value) {
  document.querySelector('#ck-volume-display').textContent = `${value}%`;
}

function ckSetMode(mode) {
  ckCurrentMode = mode;
  
  // Update button styles
  ['solo', 'duet', 'choir'].forEach(m => {
    const btn = document.querySelector(`#ck-mode-${m}`);
    if (m === mode) {
      btn.style.background = 'linear-gradient(135deg, rgba(255,77,77,0.2), rgba(255,77,77,0.1))';
      btn.style.border = '2px solid rgba(255,77,77,0.4)';
      btn.style.color = '#ff4d4d';
      btn.style.fontWeight = '600';
    } else {
      btn.style.background = 'rgba(255,255,255,0.05)';
      btn.style.border = '1px solid rgba(255,255,255,0.1)';
      btn.style.color = 'inherit';
      btn.style.fontWeight = 'normal';
    }
  });
  
  // Update display
  const modeText = mode === 'solo' ? 'ğŸ¤ Solo' : mode === 'duet' ? 'ğŸ‘« Duet' : 'ğŸ¶ Choir';
  document.querySelector('#ck-status').textContent = `Mode: ${modeText}`;
}

function ckSetTheme(theme) {
  ckCurrentTheme = theme;
  
  // Hide all themes
  document.querySelector('#ck-fireplace').style.display = 'none';
  document.querySelector('#ck-snowfall').style.display = 'none';
  document.querySelector('#ck-lights').style.display = 'none';
  
  // Show selected theme
  const themeElement = document.querySelector(`#ck-${theme}`);
  if (themeElement) {
    themeElement.style.display = 'block';
    
    // Add animations
    if (theme === 'snowfall') {
      ckCreateSnowfall();
    } else if (theme === 'lights') {
      ckCreateLights();
    }
  }
  
  // Update button styles
  ['fireplace', 'snowfall', 'lights'].forEach(t => {
    const btn = document.querySelector(`#ck-theme-${t}`);
    if (t === theme) {
      btn.style.background = 'rgba(255,77,77,0.1)';
      btn.style.border = '2px solid rgba(255,77,77,0.4)';
      btn.style.color = '#ff4d4d';
    } else {
      btn.style.background = 'rgba(255,255,255,0.05)';
      btn.style.border = '1px solid rgba(255,255,255,0.1)';
      btn.style.color = 'inherit';
    }
  });
}

function ckCreateSnowfall() {
  const container = document.querySelector('#ck-snowfall');
  container.innerHTML = '';
  
  for (let i = 0; i < 50; i++) {
    const snowflake = document.createElement('div');
    snowflake.style.cssText = `
      position: absolute;
      background: white;
      border-radius: 50%;
      width: ${Math.random() * 4 + 2}px;
      height: ${Math.random() * 4 + 2}px;
      left: ${Math.random() * 100}%;
      top: -10px;
      opacity: ${Math.random() * 0.7 + 0.3};
      animation: snowfall linear infinite;
      animation-duration: ${Math.random() * 5 + 5}s;
      animation-delay: ${Math.random() * 5}s;
    `;
    container.appendChild(snowflake);
  }
}

function ckCreateLights() {
  const container = document.querySelector('#ck-lights');
  container.innerHTML = '';
  
  for (let i = 0; i < 20; i++) {
    const light = document.createElement('div');
    const colors = ['#ff4d4d', '#39ff14', '#ffcc00', '#2dd4ff'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    
    light.style.cssText = `
      position: absolute;
      background: ${color};
      border-radius: 50%;
      width: 8px;
      height: 8px;
      left: ${Math.random() * 100}%;
      top: ${Math.random() * 100}%;
      box-shadow: 0 0 10px ${color};
      animation: lightTwinkle linear infinite alternate;
      animation-duration: ${Math.random() * 1 + 0.5}s;
      animation-delay: ${Math.random() * 2}s;
    `;
    container.appendChild(light);
  }
}

function ckLoadSong(songId) {
  const songSelect = document.querySelector('#ck-song');
  songSelect.value = songId;
  ckStartKaraoke();
}

function ckStartKaraoke() {
  if (ckIsPlaying) return;
  
  const songId = document.querySelector('#ck-song').value;
  ckCurrentSong = ckSongs[songId];
  
  if (!ckCurrentSong) {
    alert('Please select a song first!');
    return;
  }
  
  ckIsPlaying = true;
  ckCurrentLine = 0;
  ckStartTime = Date.now();
  ckScore = 0;
  ckStreak = 0;
  ckAccuracy = 0;
  ckTotalNotes = 0;
  ckCorrectNotes = 0;
  
  // Update UI
  document.querySelector('#ck-start-btn').disabled = true;
  document.querySelector('#ck-pause-btn').disabled = false;
  document.querySelector('#ck-stop-btn').disabled = false;
  document.querySelector('#ck-start-btn').textContent = 'ğŸ¤ Now Singing...';
  
  document.querySelector('#ck-song-title').textContent = ckCurrentSong.title;
  document.querySelector('#ck-song-info').innerHTML = `
    <strong>Composed:</strong> ${ckCurrentSong.year} by ${ckCurrentSong.composer}<br>
    <strong>Info:</strong> ${ckCurrentSong.info}
  `;
  
  // Show pitch meter if enabled
  const showPitch = document.querySelector('#ck-pitch-help').checked;
  document.querySelector('#ck-pitch-meter').style.display = showPitch ? 'block' : 'none';
  
  // Start the karaoke
  ckDisplayLyrics();
  ckUpdateStats();
  ckStartTimer();
  
  // Update status
  document.querySelector('#ck-status').textContent = 'Now playing';
  document.querySelector('#ck-status').style.color = '#39ff14';
  
  // Start pitch simulation
  if (showPitch) {
    ckStartPitchSimulation();
  }
}

function ckDisplayLyrics() {
  if (!ckCurrentSong || ckCurrentLine >= ckCurrentSong.lyrics.length) {
    ckStopKaraoke();
    return;
  }
  
  const line = ckCurrentSong.lyrics[ckCurrentLine];
  const container = document.querySelector('#ck-lyrics-container');
  
  // Display current line
  container.innerHTML = `
    <div style="font-size:28px;color:#39ff14;margin-bottom:8px;font-weight:600;">
      ${line.text}
    </div>
    <div style="font-size:16px;color:rgba(230,250,255,0.7);font-family:monospace;">
      ${line.notes}
    </div>
  `;
  
  // Display upcoming line
  const nextLine = ckCurrentLine + 1 < ckCurrentSong.lyrics.length 
    ? ckCurrentSong.lyrics[ckCurrentLine + 1].text 
    : 'ğŸµ Song ending soon!';
    
  document.querySelector('#ck-upcoming-lyrics').textContent = nextLine;
  
  // Display notes
  document.querySelector('#ck-notes-display').innerHTML = ckGenerateNoteIcons(line.notes);
  
  // Schedule next line
  setTimeout(() => {
    ckCurrentLine++;
    ckDisplayLyrics();
  }, line.duration);
}

function ckGenerateNoteIcons(notes) {
  const noteArray = notes.split(' ');
  let html = '';
  
  noteArray.forEach(note => {
    const colors = ['#ff4d4d', '#39ff14', '#ffcc00', '#2dd4ff'];
    const color = colors[Math.floor(Math.random() * colors.length)];
    const size = Math.floor(Math.random() * 10) + 20;
    
    html += `<span style="color:${color};font-size:${size}px;display:inline-block;margin:0 2px;animation:bounce 0.5s;">ğŸµ</span>`;
  });
  
  return html;
}

function ckStartTimer() {
  ckTimer = setInterval(() => {
    if (!ckStartTime) return;
    
    const elapsed = Math.floor((Date.now() - ckStartTime) / 1000);
    const minutes = Math.floor(elapsed / 60);
    const seconds = elapsed % 60;
    
    document.querySelector('#ck-stat-time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
    
    // Simulate score updates
    if (Math.random() > 0.7) {
      ckScore += Math.floor(Math.random() * 100) + 50;
      ckStreak = Math.min(99, ckStreak + 1);
      ckTotalNotes++;
      ckCorrectNotes++;
      ckAccuracy = Math.floor((ckCorrectNotes / ckTotalNotes) * 100);
      ckUpdateStats();
    }
  }, 1000);
}

function ckUpdateStats() {
  document.querySelector('#ck-stat-score').textContent = ckScore;
  document.querySelector('#ck-stat-streak').textContent = ckStreak;
  document.querySelector('#ck-stat-accuracy').textContent = `${ckAccuracy}%`;
}

function ckStartPitchSimulation() {
  setInterval(() => {
    if (!ckIsPlaying) return;
    
    const notes = ['C', 'D', 'E', 'F', 'G', 'A', 'B'];
    const currentNote = notes[Math.floor(Math.random() * notes.length)];
    document.querySelector('#ck-current-note').textContent = currentNote;
    
    // Move pitch indicator
    const indicator = document.querySelector('#ck-pitch-indicator');
    const offset = (Math.random() - 0.5) * 80; // -40px to +40px
    indicator.style.transform = `translateX(${offset}px)`;
    
    // Color based on pitch accuracy
    if (Math.abs(offset) < 10) {
      indicator.style.background = '#39ff14';
    } else if (Math.abs(offset) < 25) {
      indicator.style.background = '#ffcc00';
    } else {
      indicator.style.background = '#ff4d4d';
    }
  }, 500);
}

function ckPauseKaraoke() {
  if (!ckIsPlaying) return;
  
  clearInterval(ckTimer);
  ckIsPlaying = false;
  
  document.querySelector('#ck-start-btn').disabled = false;
  document.querySelector('#ck-pause-btn').disabled = true;
  document.querySelector('#ck-start-btn').textContent = 'â–¶ï¸ Resume';
  
  document.querySelector('#ck-status').textContent = 'Paused';
  document.querySelector('#ck-status').style.color = '#ffa500';
}

function ckStopKaraoke() {
  clearInterval(ckTimer);
  ckIsPlaying = false;
  ckCurrentLine = 0;
  ckStartTime = null;
  
  // Reset UI
  document.querySelector('#ck-start-btn').disabled = false;
  document.querySelector('#ck-pause-btn').disabled = true;
  document.querySelector('#ck-stop-btn').disabled = true;
  document.querySelector('#ck-start-btn').textContent = 'â–¶ï¸ Start Karaoke';
  
  document.querySelector('#ck-lyrics-container').innerHTML = `
    <div>Select a song and press Start to begin!</div>
  `;
  document.querySelector('#ck-upcoming-lyrics').textContent = '';
  document.querySelector('#ck-song-title').textContent = 'Karaoke Machine';
  document.querySelector('#ck-song-info').innerHTML = `
    <div>Select a song to see information about its history and lyrics.</div>
  `;
  
  // Hide pitch meter
  document.querySelector('#ck-pitch-meter').style.display = 'none';
  
  // Show final score
  const status = document.querySelector('#ck-status');
  status.textContent = `Finished! Final Score: ${ckScore}`;
  status.style.color = '#ff4d4d';
  
  // Reset stats after delay
  setTimeout(() => {
    ckScore = 0;
    ckStreak = 0;
    ckAccuracy = 0;
    ckUpdateStats();
    document.querySelector('#ck-stat-time').textContent = '0:00';
    status.textContent = 'Ready to sing!';
    status.style.color = '#39ff14';
  }, 5000);
}

function ckStartRecording() {
  const btn = document.querySelector('#ck-record-btn');
  if (btn.textContent.includes('Start')) {
    btn.innerHTML = 'â¸ï¸ Stop Recording';
    btn.style.background = 'rgba(255,77,77,0.2)';
    
    // Simulate recording start
    document.querySelector('#ck-status').textContent = 'âºï¸ Recording started';
    document.querySelector('#ck-status').style.color = '#ff4d4d';
  } else {
    btn.innerHTML = 'âºï¸ Start Recording';
    btn.style.background = 'rgba(255,77,77,0.1)';
    
    // Simulate recording stop
    document.querySelector('#ck-status').textContent = 'âœ… Recording saved';
    document.querySelector('#ck-status').style.color = '#39ff14';
    setTimeout(() => {
      if (ckIsPlaying) {
        document.querySelector('#ck-status').textContent = 'Now playing';
      } else {
        document.querySelector('#ck-status').textContent = 'Ready to sing!';
      }
    }, 3000);
  }
}

function ckSharePerformance() {
  const score = ckScore;
  const song = ckCurrentSong ? ckCurrentSong.title : 'Christmas Carols';
  
  const text = `ğŸµ I scored ${score} points singing "${song}" on the Christmas Karaoke Machine! Try it yourself: `;
  const url = window.location.href;
  
  // Create share dialog
  const shareHTML = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;">
      <div style="background:linear-gradient(135deg, #1a2f3a, #0a0f14);border-radius:12px;padding:24px;max-width:400px;border:2px solid #ff4d4d;">
        <h3 style="color:#ff4d4d;margin:0 0 16px 0;">ğŸ“¤ Share Your Performance</h3>
        <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:12px;margin-bottom:16px;">
          <div style="color:#39ff14;font-size:14px;margin-bottom:4px;">Your Score: ${score}</div>
          <div style="color:rgba(230,250,255,0.8);font-size:12px;">Song: ${song}</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="window.open('https://twitter.com/intent/tweet?text='+encodeURIComponent('${text}')+'&url='+encodeURIComponent('${url}'), '_blank')" 
                  style="flex:1;padding:10px;background:rgba(29,161,242,0.1);border:1px solid rgba(29,161,242,0.3);border-radius:6px;color:#1da1f2;cursor:pointer;">
            Twitter
          </button>
          <button onclick="navigator.clipboard.writeText('${text}${url}')" 
                  style="flex:1;padding:10px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;">
            Copy Link
          </button>
          <button onclick="document.querySelector('#share-dialog').remove()" 
                  style="padding:10px 16px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  const dialog = document.createElement('div');
  dialog.id = 'share-dialog';
  dialog.innerHTML = shareHTML;
  document.body.appendChild(dialog);
}

function ckSaveAudio() {
  // Create a simple audio file for download
  const audioData = "data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ";
  const link = document.createElement('a');
  link.download = `karaoke-${ckCurrentSong ? ckCurrentSong.title.toLowerCase().replace(/ /g, '-') : 'recording'}.wav`;
  link.href = audioData;
  link.click();
  
  document.querySelector('#ck-status').textContent = 'ğŸ’¾ Audio file saved';
  document.querySelector('#ck-status').style.color = '#39ff14';
  setTimeout(() => {
    if (ckIsPlaying) {
      document.querySelector('#ck-status').textContent = 'Now playing';
    } else {
      document.querySelector('#ck-status').textContent = 'Ready to sing!';
    }
  }, 3000);
}

function ckGenerateCertificate() {
  const score = ckScore;
  const song = ckCurrentSong ? ckCurrentSong.title : 'Christmas Carols';
  const accuracy = ckAccuracy;
  const grade = accuracy >= 90 ? 'A+' : accuracy >= 80 ? 'A' : accuracy >= 70 ? 'B' : accuracy >= 60 ? 'C' : 'Try Again!';
  
  // Create certificate image
  const canvas = document.createElement('canvas');
  canvas.width = 800;
  canvas.height = 600;
  const ctx = canvas.getContext('2d');
  
  // Background
  const gradient = ctx.createLinearGradient(0, 0, 800, 600);
  gradient.addColorStop(0, '#0a0f14');
  gradient.addColorStop(1, '#1a2f3a');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, 800, 600);
  
  // Border
  ctx.strokeStyle = '#ff4d4d';
  ctx.lineWidth = 10;
  ctx.strokeRect(20, 20, 760, 560);
  
  // Title
  ctx.fillStyle = '#39ff14';
  ctx.font = 'bold 48px Arial';
  ctx.textAlign = 'center';
  ctx.fillText('ğŸµ Christmas Karaoke Certificate ğŸµ', 400, 100);
  
  // Content
  ctx.fillStyle = '#ffffff';
  ctx.font = '28px Arial';
  ctx.fillText('This certifies that', 400, 180);
  
  ctx.fillStyle = '#ff4d4d';
  ctx.font = 'bold 36px Arial';
  ctx.fillText('A Fantastic Singer', 400, 240);
  
  ctx.fillStyle = '#ffffff';
  ctx.font = '24px Arial';
  ctx.fillText('has successfully performed', 400, 300);
  
  ctx.fillStyle = '#39ff14';
  ctx.font = 'bold 32px Arial';
  ctx.fillText(`"${song}"`, 400, 360);
  
  ctx.fillStyle = '#ffffff';
  ctx.font = '20px Arial';
  ctx.fillText(`with a score of ${score} points and ${accuracy}% accuracy`, 400, 420);
  
  ctx.fillStyle = '#ffcc00';
  ctx.font = 'bold 40px Arial';
  ctx.fillText(`Grade: ${grade}`, 400, 480);
  
  // Signature
  ctx.fillStyle = 'rgba(255,255,255,0.7)';
  ctx.font = '18px Arial';
  ctx.fillText('ğŸ… The Christmas Karaoke Machine ğŸ„', 400, 550);
  
  // Convert to image and download
  const dataUrl = canvas.toDataURL('image/png');
  const link = document.createElement('a');
  link.download = `karaoke-certificate-${new Date().toISOString().split('T')[0]}.png`;
  link.href = dataUrl;
  link.click();
  
  document.querySelector('#ck-status').textContent = 'ğŸ† Certificate generated!';
  document.querySelector('#ck-status').style.color = '#ffcc00';
  setTimeout(() => {
    if (ckIsPlaying) {
      document.querySelector('#ck-status').textContent = 'Now playing';
    } else {
      document.querySelector('#ck-status').textContent = 'Ready to sing!';
    }
  }, 3000);
}

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', () => {
    // Set default theme
    ckSetTheme('fireplace');
    ckSetMode('solo');
    
    // Set default tempo display
    const tempoSlider = document.querySelector('#ck-tempo');
    ckUpdateTempo(tempoSlider.value);
    
    // Set default volume display
    const volumeSlider = document.querySelector('#ck-volume');
    ckUpdateVolume(volumeSlider.value);
    
    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes snowfall {
        0% { transform: translateY(-10px) translateX(0px); }
        100% { transform: translateY(110px) translateX(20px); }
      }
      @keyframes lightTwinkle {
        0% { opacity: 0.3; transform: scale(0.8); }
        100% { opacity: 1; transform: scale(1.2); }
      }
      @keyframes bounce {
        0%, 100% { transform: translateY(0); }
        50% { transform: translateY(-10px); }
      }
    `;
    document.head.appendChild(style);
  });
}
</script>

<style>
/* Karaoke styles */
#carol-karaoke-title {
  background: linear-gradient(45deg, #ff4d4d, #39ff14);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-top: 0;
  margin-bottom: 4px;
}

/* Microphone animation */
@keyframes microphoneGlow {
  0%, 100% { 
    box-shadow: 0 0 5px rgba(255,77,77,0.5),
                0 0 10px rgba(57,255,20,0.3); 
  }
  50% { 
    box-shadow: 0 0 15px rgba(255,77,77,0.8),
                0 0 25px rgba(57,255,20,0.5); 
  }
}

.microphone-active {
  animation: microphoneGlow 2s infinite;
}

/* Note animation */
@keyframes noteFloat {
  0% { transform: translateY(0) rotate(0deg); opacity: 1; }
  100% { transform: translateY(-100px) rotate(180deg); opacity: 0; }
}

.note-float {
  animation: noteFloat 3s ease-out forwards;
}

/* Responsive design */
@media (max-width: 768px) {
  #ck-lyrics-container {
    font-size: 20px !important;
  }
  
  .performance-stats {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  .control-buttons {
    flex-direction: column;
  }
  
  .control-buttons button {
    width: 100%;
    margin: 4px 0 !important;
  }
  
  .theme-buttons, .mode-buttons {
    flex-direction: column;
  }
}

/* Lyrics highlight animation */
@keyframes highlightLyric {
  0% { color: rgba(230,250,255,0.9); }
  50% { color: #39ff14; text-shadow: 0 0 10px rgba(57,255,20,0.5); }
  100% { color: rgba(230,250,255,0.9); }
}

.lyric-highlight {
  animation: highlightLyric 0.5s ease-out;
}

/* Progress bar for song */
.song-progress {
  height: 4px;
  background: rgba(255,255,255,0.1);
  border-radius: 2px;
  overflow: hidden;
  margin: 8px 0;
}

.song-progress-bar {
  height: 100%;
  background: linear-gradient(90deg, #ff4d4d, #39ff14);
  width: 0%;
  transition: width 0.3s;
}

/* Christmas music note colors */
.note-c { color: #ff4d4d; }
.note-d { color: #ffa500; }
.note-e { color: #ffcc00; }
.note-f { color: #39ff14; }
.note-g { color: #2dd4ff; }
.note-a { color: #9d4edd; }
.note-b { color: #ff2d55; }
</style>
