<h2 id="complex-numbers-title" style="margin-top:0;color:var(--accent);">ğŸ§® Complex Numbers Calculator</h2>

<form aria-describedby="complex-numbers-desc" style="margin-bottom:20px;">
  <p id="complex-numbers-desc" class="small" style="color:rgba(230,250,255,0.8);margin-bottom:16px;">
    Perform operations with complex numbers in rectangular (a+bi) and polar (râˆ Î¸) forms. 
    Visualize results on the complex plane with step-by-step solutions.
    <span style="color:var(--accent);display:block;margin-top:4px;">
      âœ… Supports: + âˆ’ Ã— Ã· âˆš ^ log sin cos conjugate modulus argument
    </span>
  </p>

  <!-- Input Section -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
    <div class="field">
      <label for="cn-a" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        ğŸ…° Complex Number A
      </label>
      <div style="display:flex;gap:8px;">
        <input id="cn-a" type="text" placeholder="e.g. 3+4i or 5âˆ 53.13Â°" 
               style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        <button type="button" onclick="cnInsertExample('a')" title="Insert example" style="padding:0 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">ğŸ²</button>
      </div>
      <div id="cn-a-info" style="font-size:11px;margin-top:4px;color:rgba(230,250,255,0.6);">
        Rectangular: a+bi, Polar: râˆ Î¸Â° (Î¸ in degrees)
      </div>
    </div>

    <div class="field">
      <label for="cn-b" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        ğŸ…± Complex Number B (optional)
      </label>
      <div style="display:flex;gap:8px;">
        <input id="cn-b" type="text" placeholder="e.g. 1-2i or 2âˆ -45Â°" 
               style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        <button type="button" onclick="cnInsertExample('b')" title="Insert example" style="padding:0 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">ğŸ²</button>
      </div>
      <div id="cn-b-info" style="font-size:11px;margin-top:4px;color:rgba(230,250,255,0.6);">
        Required for binary operations (+ âˆ’ Ã— Ã·)
      </div>
    </div>
  </div>

  <!-- Operation Selection -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
    <div class="field">
      <label for="cn-operation" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        ğŸ”§ Operation
      </label>
      <select id="cn-operation" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <optgroup label="Binary Operations">
          <option value="add" selected>â• Addition (A + B)</option>
          <option value="subtract">â– Subtraction (A âˆ’ B)</option>
          <option value="multiply">âœ–ï¸ Multiplication (A Ã— B)</option>
          <option value="divide">â— Division (A Ã· B)</option>
          <option value="power">âš¡ Power (A^B)</option>
        </optgroup>
        <optgroup label="Unary Operations">
          <option value="conjugate">ğŸ”„ Conjugate (conj(A))</option>
          <option value="modulus">ğŸ“ Modulus (|A|)</option>
          <option value="argument">ğŸ“ Argument (arg(A))</option>
          <option value="sqrt">âˆš Square Root (âˆšA)</option>
          <option value="exp">e^x Exponential (e^A)</option>
          <option value="log">ln Natural Log (ln A)</option>
          <option value="sin">sin Sine (sin A)</option>
          <option value="cos">cos Cosine (cos A)</option>
        </optgroup>
      </select>
    </div>

    <div class="field">
      <label for="cn-precision" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        ğŸ¯ Decimal Precision
      </label>
      <select id="cn-precision" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <option value="2">2 decimal places</option>
        <option value="4" selected>4 decimal places</option>
        <option value="6">6 decimal places</option>
        <option value="8">8 decimal places</option>
        <option value="10">10 decimal places</option>
      </select>
    </div>

    <div class="field">
      <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        ğŸ“ Display Options
      </label>
      <div style="display:flex;gap:8px;">
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input id="cn-show-steps" type="checkbox" checked style="accent-color:var(--accent);">
          Show Steps
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input id="cn-show-polar" type="checkbox" checked style="accent-color:var(--accent);">
          Polar Form
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input id="cn-show-visual" type="checkbox" checked style="accent-color:var(--accent);">
          Visualize
        </label>
      </div>
    </div>
  </div>

  <!-- Quick Examples -->
  <div style="margin-bottom:16px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:6px;font-size:13px;">ğŸš€ Quick Examples</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="cnLoadExample('euler')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Euler's Identity (e^iÏ€)</button>
      <button type="button" onclick="cnLoadExample('roots')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Cube Roots of Unity</button>
      <button type="button" onclick="cnLoadExample('mandelbrot')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Mandelbrot Set (zÂ²+c)</button>
      <button type="button" onclick="cnLoadExample('phasor')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">AC Circuit Phasors</button>
    </div>
  </div>

  <!-- Actions -->
  <div class="actions" style="display:flex;gap:10px;margin-top:20px;">
    <button type="button" onclick="cnCalculate(this)" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      ğŸ§® Calculate
    </button>
    <button type="button" onclick="cnReset(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸ”„ Reset
    </button>
    <button type="button" onclick="cnCopy(this)"
            style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      ğŸ“‹ Copy Result
    </button>
  </div>
</form>

<!-- Results Section -->
<div class="results" aria-live="polite" style="margin-top:24px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h3 class="small" style="color:var(--accent);margin:0;">ğŸ“Š Calculation Results</h3>
    <div id="cn-status" style="font-size:12px;color:rgba(230,250,255,0.7);"></div>
  </div>

  <!-- Quick Stats -->
  <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:16px;display:none;" id="cn-quick-stats">
    <div style="background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:14px;font-weight:600;color:var(--accent);" id="cn-stat-real">0</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Real Part</div>
    </div>
    <div style="background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:14px;font-weight:600;color:#ff4d4d;" id="cn-stat-imag">0</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Imaginary Part</div>
    </div>
    <div style="background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:14px;font-weight:600;color:#ffa500;" id="cn-stat-mod">0</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Modulus</div>
    </div>
    <div style="background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.2);border-radius:6px;padding:8px;text-align:center;">
      <div style="font-size:14px;font-weight:600;color:#39ff14;" id="cn-stat-arg">0Â°</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);">Argument</div>
    </div>
  </div>

  <!-- Main Output -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);padding:16px;margin-bottom:16px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div>
        <h4 style="color:var(--accent);margin:0 0 8px 0;font-size:14px;">ğŸ“ Calculation Details</h4>
        <textarea id="cn-output" rows="12" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(0,0,0,0.4);color:inherit;font-family:'Courier New',monospace;font-size:13px;resize:vertical;"></textarea>
      </div>
      <div>
        <h4 style="color:var(--accent);margin:0 0 8px 0;font-size:14px;">ğŸ“Š Visualization</h4>
        <div id="cn-visualization" style="height:200px;background:rgba(0,0,0,0.3);border-radius:8px;border:1px dashed rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;color:rgba(230,250,255,0.5);">
          <div style="text-align:center;">
            <div style="font-size:48px;margin-bottom:8px;">ğŸ“ˆ</div>
            <div>Enable visualization to see complex plane plot</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Additional Representations -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);padding:12px;">
    <h4 style="color:var(--accent);margin:0 0 8px 0;font-size:14px;">ğŸ”„ Alternative Representations</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);margin-bottom:4px;">
          Rectangular: <span id="cn-rep-rect" style="color:var(--accent);font-family:monospace;">0+0i</span>
        </div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);margin-bottom:4px;">
          Polar: <span id="cn-rep-polar" style="color:#ffa500;font-family:monospace;">0âˆ 0Â°</span>
        </div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);">
          Exponential: <span id="cn-rep-exp" style="color:#39ff14;font-family:monospace;">0e^i0</span>
        </div>
      </div>
      <div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);margin-bottom:4px;">
          Trigonometric: <span id="cn-rep-trig" style="color:#ff4d4d;font-family:monospace;">0(cos0+isin0)</span>
        </div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);margin-bottom:4px;">
          Matrix: <span id="cn-rep-matrix" style="color:var(--accent);font-family:monospace;">[[0,-0],[0,0]]</span>
        </div>
        <div style="font-size:12px;color:rgba(230,250,255,0.8);">
          Python: <span id="cn-rep-python" style="color:#2dd4ff;font-family:monospace;">complex(0,0)</span>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
/* complex-numbers.html
   - Advanced complex numbers calculator with visualization
   - Scoped with "cn" prefix (complex numbers)
*/

// Complex number class with operations
class ComplexNumber {
  constructor(real = 0, imag = 0) {
    this.real = real;
    this.imag = imag;
  }

  // Parse complex number from string
  static parse(str) {
    if (!str) return null;
    
    str = str.replace(/\s+/g, '').toLowerCase();
    
    // Try rectangular form: a+bi or a-bi
    let match = str.match(/^([+\-]?\d*\.?\d+)([+\-]\d*\.?\d+)i$/);
    if (match) {
      return new ComplexNumber(parseFloat(match[1]), parseFloat(match[2]));
    }
    
    // Try rectangular form: bi
    match = str.match(/^([+\-]?\d*\.?\d+)i$/);
    if (match) {
      return new ComplexNumber(0, parseFloat(match[1]));
    }
    
    // Try rectangular form: a
    match = str.match(/^([+\-]?\d*\.?\d+)$/);
    if (match) {
      return new ComplexNumber(parseFloat(match[1]), 0);
    }
    
    // Try polar form: râˆ Î¸
    match = str.match(/^([+\-]?\d*\.?\d+)âˆ ([+\-]?\d*\.?\d+)(Â°|deg)?$/);
    if (match) {
      const r = parseFloat(match[1]);
      let Î¸ = parseFloat(match[2]);
      if (match[3] === 'Â°' || match[3] === 'deg') {
        Î¸ = Î¸ * Math.PI / 180; // Convert to radians
      }
      return ComplexNumber.fromPolar(r, Î¸);
    }
    
    return null;
  }

  static fromPolar(r, Î¸) {
    return new ComplexNumber(r * Math.cos(Î¸), r * Math.sin(Î¸));
  }

  // Basic operations
  add(other) {
    return new ComplexNumber(this.real + other.real, this.imag + other.imag);
  }

  subtract(other) {
    return new ComplexNumber(this.real - other.real, this.imag - other.imag);
  }

  multiply(other) {
    const real = this.real * other.real - this.imag * other.imag;
    const imag = this.real * other.imag + this.imag * other.real;
    return new ComplexNumber(real, imag);
  }

  divide(other) {
    const denominator = other.real * other.real + other.imag * other.imag;
    if (denominator === 0) throw new Error("Division by zero");
    const real = (this.real * other.real + this.imag * other.imag) / denominator;
    const imag = (this.imag * other.real - this.real * other.imag) / denominator;
    return new ComplexNumber(real, imag);
  }

  conjugate() {
    return new ComplexNumber(this.real, -this.imag);
  }

  modulus() {
    return Math.sqrt(this.real * this.real + this.imag * this.imag);
  }

  argument() {
    return Math.atan2(this.imag, this.real);
  }

  power(exponent) {
    if (typeof exponent === 'number') {
      const r = Math.pow(this.modulus(), exponent);
      const Î¸ = this.argument() * exponent;
      return ComplexNumber.fromPolar(r, Î¸);
    } else if (exponent instanceof ComplexNumber) {
      // a^b = exp(b * ln(a))
      return this.log().multiply(exponent).exp();
    }
    return null;
  }

  sqrt() {
    return this.power(0.5);
  }

  exp() {
    const expReal = Math.exp(this.real);
    return new ComplexNumber(expReal * Math.cos(this.imag), expReal * Math.sin(this.imag));
  }

  log() {
    return new ComplexNumber(Math.log(this.modulus()), this.argument());
  }

  sin() {
    return new ComplexNumber(
      Math.sin(this.real) * Math.cosh(this.imag),
      Math.cos(this.real) * Math.sinh(this.imag)
    );
  }

  cos() {
    return new ComplexNumber(
      Math.cos(this.real) * Math.cosh(this.imag),
      -Math.sin(this.real) * Math.sinh(this.imag)
    );
  }

  // String representations
  toString(precision = 4) {
    const format = (x) => {
      if (Math.abs(x) < 1e-10) x = 0;
      return x.toFixed(precision).replace(/\.?0+$/, '');
    };
    
    const realStr = format(this.real);
    const imagStr = format(Math.abs(this.imag));
    const sign = this.imag >= 0 ? '+' : '-';
    
    return `${realStr}${sign}${imagStr}i`;
  }

  toPolarString(precision = 4) {
    const r = this.modulus();
    let Î¸ = this.argument() * 180 / Math.PI; // Convert to degrees
    
    // Normalize to [-180, 180]
    while (Î¸ <= -180) Î¸ += 360;
    while (Î¸ > 180) Î¸ -= 360;
    
    const rStr = r.toFixed(precision).replace(/\.?0+$/, '');
    const Î¸Str = Î¸.toFixed(precision).replace(/\.?0+$/, '');
    
    return `${rStr}âˆ ${Î¸Str}Â°`;
  }

  toExponentialString(precision = 4) {
    const r = this.modulus();
    const Î¸ = this.argument();
    const rStr = r.toFixed(precision).replace(/\.?0+$/, '');
    const Î¸Str = Î¸.toFixed(precision).replace(/\.?0+$/, '');
    
    return `${rStr}e^i${Î¸Str}`;
  }

  toTrigString(precision = 4) {
    const r = this.modulus();
    const Î¸ = this.argument() * 180 / Math.PI;
    const rStr = r.toFixed(precision).replace(/\.?0+$/, '');
    const Î¸Str = Î¸.toFixed(precision).replace(/\.?0+$/, '');
    
    return `${rStr}(cos${Î¸Str}Â° + isin${Î¸Str}Â°)`;
  }
}

let cnCurrentResult = new ComplexNumber(0, 0);

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', cnInitialize);
} else {
  cnInitialize();
}

function cnInitialize() {
  console.log('Complex Numbers Calculator: Initializing...');
  
  // Set up auto-calculation on input change
  const inputs = ['#cn-a', '#cn-b', '#cn-operation'];
  inputs.forEach(selector => {
    const input = document.querySelector(selector);
    if (input) {
      input.addEventListener('change', () => cnCalculate());
    }
  });
  
  // Set up keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      cnCalculate();
    }
  });
  
  // Load default example
  setTimeout(() => {
    const aInput = document.querySelector('#cn-a');
    if (aInput && !aInput.value) {
      aInput.value = '3+4i';
    }
  }, 100);
}

function cnInsertExample(field) {
  const examples = [
    '1+2i',
    '3-4i',
    '5âˆ 53.13Â°',
    '2âˆ -45Â°',
    '0+1i', // i
    '1+0i', // 1
    '0.5+0.866i', // e^(iÏ€/3)
  ];
  
  const randomExample = examples[Math.floor(Math.random() * examples.length)];
  const input = document.querySelector(`#cn-${field}`);
  if (input) {
    input.value = randomExample;
    input.dispatchEvent(new Event('change'));
  }
}

function cnLoadExample(type) {
  const card = document.currentScript?.closest('.card') || document;
  
  switch(type) {
    case 'euler':
      card.querySelector('#cn-a').value = '0+1i'; // i
      card.querySelector('#cn-b').value = '3.14159'; // Ï€
      card.querySelector('#cn-operation').value = 'power';
      break;
    case 'roots':
      card.querySelector('#cn-a').value = '1+0i';
      card.querySelector('#cn-b').value = '0.33333'; // 1/3
      card.querySelector('#cn-operation').value = 'power';
      break;
    case 'mandelbrot':
      card.querySelector('#cn-a').value = '0+0i';
      card.querySelector('#cn-b').value = '-0.7+0.3i';
      card.querySelector('#cn-operation').value = 'power';
      // Actually we need A^2 + B
      break;
    case 'phasor':
      card.querySelector('#cn-a').value = '120âˆ 0Â°';
      card.querySelector('#cn-b').value = '10+5i';
      card.querySelector('#cn-operation').value = 'divide';
      break;
  }
  
  cnCalculate();
}

function cnCalculate(btn) {
  const card = document.currentScript?.closest('.card') || document;
  const status = card.querySelector('#cn-status');
  const output = card.querySelector('#cn-output');
  
  try {
    // Get inputs
    const aStr = card.querySelector('#cn-a').value.trim();
    const bStr = card.querySelector('#cn-b').value.trim();
    const operation = card.querySelector('#cn-operation').value;
    const precision = parseInt(card.querySelector('#cn-precision').value) || 4;
    const showSteps = card.querySelector('#cn-show-steps').checked;
    const showPolar = card.querySelector('#cn-show-polar').checked;
    
    // Parse complex numbers
    const a = ComplexNumber.parse(aStr);
    if (!a) throw new Error("Invalid complex number A. Use format: a+bi or râˆ Î¸Â°");
    
    let b = null;
    if (bStr) {
      b = ComplexNumber.parse(bStr);
      if (!b && ['add', 'subtract', 'multiply', 'divide', 'power'].includes(operation)) {
        throw new Error("Invalid complex number B. Use format: a+bi or râˆ Î¸Â°");
      }
    }
    
    // Perform operation
    let result;
    let steps = [];
    
    switch(operation) {
      case 'add':
        if (!b) throw new Error("Complex B required for addition");
        result = a.add(b);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`B = ${b.toString(precision)}`);
        steps.push(`A + B = (${a.real} + ${b.real}) + i(${a.imag} + ${b.imag})`);
        steps.push(`= ${a.real + b.real} + i(${a.imag + b.imag})`);
        break;
        
      case 'subtract':
        if (!b) throw new Error("Complex B required for subtraction");
        result = a.subtract(b);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`B = ${b.toString(precision)}`);
        steps.push(`A - B = (${a.real} - ${b.real}) + i(${a.imag} - ${b.imag})`);
        steps.push(`= ${a.real - b.real} + i(${a.imag - b.imag})`);
        break;
        
      case 'multiply':
        if (!b) throw new Error("Complex B required for multiplication");
        result = a.multiply(b);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`B = ${b.toString(precision)}`);
        steps.push(`A Ã— B = (${a.real}Ã—${b.real} - ${a.imag}Ã—${b.imag}) + i(${a.real}Ã—${b.imag} + ${a.imag}Ã—${b.real})`);
        steps.push(`= (${a.real * b.real} - ${a.imag * b.imag}) + i(${a.real * b.imag} + ${a.imag * b.real})`);
        steps.push(`= ${a.real * b.real - a.imag * b.imag} + i(${a.real * b.imag + a.imag * b.real})`);
        break;
        
      case 'divide':
        if (!b) throw new Error("Complex B required for division");
        result = a.divide(b);
        const denominator = b.real * b.real + b.imag * b.imag;
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`B = ${b.toString(precision)}`);
        steps.push(`Denominator = ${b.real}Â² + ${b.imag}Â² = ${denominator}`);
        steps.push(`Real part = (${a.real}Ã—${b.real} + ${a.imag}Ã—${b.imag}) / ${denominator}`);
        steps.push(`Imag part = (${a.imag}Ã—${b.real} - ${a.real}Ã—${b.imag}) / ${denominator}`);
        break;
        
      case 'conjugate':
        result = a.conjugate();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`Conjugate(A) = ${a.real} - i${Math.abs(a.imag)}`);
        break;
        
      case 'modulus':
        const mod = a.modulus();
        result = new ComplexNumber(mod, 0);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`|A| = âˆš(${a.real}Â² + ${a.imag}Â²)`);
        steps.push(`= âˆš(${a.real * a.real} + ${a.imag * a.imag})`);
        steps.push(`= âˆš${a.real * a.real + a.imag * a.imag}`);
        steps.push(`= ${mod}`);
        break;
        
      case 'argument':
        const arg = a.argument() * 180 / Math.PI;
        result = new ComplexNumber(arg, 0);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`arg(A) = atan2(${a.imag}, ${a.real})`);
        steps.push(`= ${a.argument()} radians`);
        steps.push(`= ${arg}Â°`);
        break;
        
      case 'sqrt':
        result = a.sqrt();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`âˆšA = âˆš(${a.modulus()})âˆ (${a.argument() * 180 / Math.PI}Â°/2)`);
        break;
        
      case 'exp':
        result = a.exp();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`e^A = e^${a.real}(cos${a.imag} + isin${a.imag})`);
        break;
        
      case 'log':
        result = a.log();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`ln(A) = ln(${a.modulus()}) + iÂ·${a.argument()}`);
        break;
        
      case 'sin':
        result = a.sin();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`sin(A) = sin(${a.real})cosh(${a.imag}) + icos(${a.real})sinh(${a.imag})`);
        break;
        
      case 'cos':
        result = a.cos();
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`cos(A) = cos(${a.real})cosh(${a.imag}) - isin(${a.real})sinh(${a.imag})`);
        break;
        
      case 'power':
        if (!b) throw new Error("Complex B or exponent required for power");
        result = a.power(b);
        steps.push(`A = ${a.toString(precision)}`);
        steps.push(`B = ${b.toString(precision)}`);
        if (b.imag === 0) {
          steps.push(`A^${b.real} = (${a.modulus()}^${b.real})âˆ (${a.argument() * 180 / Math.PI}Â° Ã— ${b.real})`);
        }
        break;
    }
    
    cnCurrentResult = result;
    
    // Build output
    let outputText = `OPERATION: ${card.querySelector('#cn-operation').selectedOptions[0].text}\n`;
    outputText += `A = ${a.toString(precision)}\n`;
    if (b) outputText += `B = ${b.toString(precision)}\n`;
    outputText += `â”€`.repeat(40) + `\n`;
    outputText += `RESULT = ${result.toString(precision)}\n`;
    
    if (showPolar) {
      outputText += `POLAR = ${result.toPolarString(precision)}\n`;
    }
    
    if (showSteps && steps.length > 0) {
      outputText += `\nSTEP-BY-STEP SOLUTION:\n`;
      steps.forEach((step, i) => {
        outputText += `${i + 1}. ${step}\n`;
      });
    }
    
    outputText += `\nPROPERTIES:\n`;
    outputText += `â€¢ Real part: ${result.real.toFixed(precision)}\n`;
    outputText += `â€¢ Imaginary part: ${result.imag.toFixed(precision)}\n`;
    outputText += `â€¢ Modulus: ${result.modulus().toFixed(precision)}\n`;
    outputText += `â€¢ Argument: ${(result.argument() * 180 / Math.PI).toFixed(precision)}Â°\n`;
    
    // Update output
    output.value = outputText;
    
    // Update quick stats
    card.querySelector('#cn-stat-real').textContent = result.real.toFixed(2);
    card.querySelector('#cn-stat-imag').textContent = result.imag.toFixed(2);
    card.querySelector('#cn-stat-mod').textContent = result.modulus().toFixed(2);
    card.querySelector('#cn-stat-arg').textContent = (result.argument() * 180 / Math.PI).toFixed(1) + 'Â°';
    card.querySelector('#cn-quick-stats').style.display = 'grid';
    
    // Update alternative representations
    card.querySelector('#cn-rep-rect').textContent = result.toString(precision);
    card.querySelector('#cn-rep-polar').textContent = result.toPolarString(precision);
    card.querySelector('#cn-rep-exp').textContent = result.toExponentialString(precision);
    card.querySelector('#cn-rep-trig').textContent = result.toTrigString(precision);
    card.querySelector('#cn-rep-matrix').textContent = `[[${result.real.toFixed(2)},${-result.imag.toFixed(2)}],[${result.imag.toFixed(2)},${result.real.toFixed(2)}]]`;
    card.querySelector('#cn-rep-python').textContent = `complex(${result.real.toFixed(precision)}, ${result.imag.toFixed(precision)})`;
    
    // Update visualization if enabled
    if (card.querySelector('#cn-show-visual').checked) {
      cnUpdateVisualization(result, a, b);
    }
    
    // Update status
    status.textContent = 'âœ… Calculation successful';
    status.style.color = '#39ff14';
    
    // Visual feedback if called from button
    if (btn) {
      btn.textContent = 'âœ… Calculated!';
      setTimeout(() => {
        btn.textContent = 'ğŸ§® Calculate';
      }, 1000);
    }
    
  } catch (error) {
    output.value = `ERROR: ${error.message}\n\nPlease check your input format.\n\nValid formats:\nâ€¢ Rectangular: 3+4i, -2.5-1.5i, 7i, 5\nâ€¢ Polar: 5âˆ 53.13Â°, 2âˆ -45Â°`;
    status.textContent = 'âŒ Error in calculation';
    status.style.color = '#ff4d4d';
    
    // Hide quick stats on error
    card.querySelector('#cn-quick-stats').style.display = 'none';
  }
}

function cnUpdateVisualization(result, a, b) {
  const viz = document.querySelector('#cn-visualization');
  if (!viz) return;
  
  // Simple ASCII visualization for now
  // In a real implementation, you might use SVG or Canvas
  const scale = 3;
  const centerX = 10;
  const centerY = 10;
  
  let grid = '';
  for (let y = 0; y < 20; y++) {
    let row = '';
    for (let x = 0; x < 40; x++) {
      const real = (x - centerX) / scale;
      const imag = (centerY - y) / scale;
      
      if (Math.abs(real) < 0.1 && Math.abs(imag) < 0.1) {
        row += 'âŠ•'; // Origin
      } else if (Math.abs(real - result.real) < 0.2 && Math.abs(imag - result.imag) < 0.2) {
        row += 'â˜…'; // Result
      } else if (a && Math.abs(real - a.real) < 0.2 && Math.abs(imag - a.imag) < 0.2) {
        row += 'A'; // Input A
      } else if (b && Math.abs(real - b.real) < 0.2 && Math.abs(imag - b.imag) < 0.2) {
        row += 'B'; // Input B
      } else if (Math.abs(imag) < 0.1) {
        row += 'â”€'; // Real axis
      } else if (Math.abs(real) < 0.1) {
        row += 'â”‚'; // Imaginary axis
      } else {
        row += 'Â·';
      }
    }
    grid += row + '\n';
  }
  
  viz.innerHTML = `<pre style="margin:0;font-size:8px;line-height:1;color:var(--accent);font-family:monospace;">${grid}</pre>`;
}

function cnReset(btn) {
  const card = btn.closest('.card');
  card.querySelector('#cn-a').value = '';
  card.querySelector('#cn-b').value = '';
  card.querySelector('#cn-output').value = '';
  card.querySelector('#cn-status').textContent = '';
  card.querySelector('#cn-quick-stats').style.display = 'none';
  
  // Reset all representations
  ['rect', 'polar', 'exp', 'trig', 'matrix', 'python'].forEach(type => {
    const element = card.querySelector(`#cn-rep-${type}`);
    if (element) element.textContent = '';
  });
  
  // Reset visualization
  const viz = card.querySelector('#cn-visualization');
  if (viz) {
    viz.innerHTML = `
      <div style="text-align:center;">
        <div style="font-size:48px;margin-bottom:8px;">ğŸ“ˆ</div>
        <div>Enable visualization to see complex plane plot</div>
      </div>
    `;
  }
  
  // Visual feedback
  if (btn) {
    btn.textContent = 'âœ… Reset!';
    setTimeout(() => {
      btn.textContent = 'ğŸ”„ Reset';
    }, 1000);
  }
}

function cnCopy(btn) {
  const card = btn.closest('.card');
  const output = card.querySelector('#cn-output').value;
  
  if (!output.trim()) {
    card.querySelector('#cn-status').textContent = 'âŒ No result to copy';
    card.querySelector('#cn-status').style.color = '#ff4d4d';
    return;
  }
  
  navigator.clipboard.writeText(output).then(() => {
    card.querySelector('#cn-status').textContent = 'âœ… Copied to clipboard';
    card.querySelector('#cn-status').style.color = '#39ff14';
    
    if (btn) {
      btn.textContent = 'âœ… Copied!';
      setTimeout(() => {
        btn.textContent = 'ğŸ“‹ Copy Result';
      }, 1000);
    }
  }).catch(() => {
    card.querySelector('#cn-status').textContent = 'âŒ Failed to copy';
    card.querySelector('#cn-status').style.color = '#ff4d4d';
  });
}
</script>

<style>
/* Card-specific styles */
#complex-numbers-title {
  color: var(--accent);
  margin-top: 0;
  margin-bottom: 4px;
}

/* Custom styling for optgroups */
optgroup {
  font-weight: bold;
  color: var(--accent);
}

optgroup option {
  font-weight: normal;
  color: inherit;
}

/* Visualization styling */
#cn-visualization pre {
  letter-spacing: 3px;
  text-align: center;
}

/* Input focus effects */
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px rgba(45,212,255,0.2);
}

/* Responsive design */
@media (max-width: 768px) {
  #complex-numbers-title {
    font-size: 1.2rem;
  }
  
  .input-grid {
    grid-template-columns: 1fr !important;
  }
  
  .results-grid {
    grid-template-columns: 1fr !important;
  }
  
  .actions {
    flex-direction: column;
  }
  
  .actions button {
    width: 100%;
    margin: 4px 0 !important;
  }
  
  .quick-examples {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

/* Animation for results */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.result-item {
  animation: fadeIn 0.3s ease-out;
}

/* Custom scrollbar for output */
textarea::-webkit-scrollbar {
  width: 8px;
}

textarea::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

textarea::-webkit-scrollbar-thumb {
  background: rgba(45,212,255,0.3);
  border-radius: 4px;
}

textarea::-webkit-scrollbar-thumb:hover {
  background: rgba(45,212,255,0.5);
}
</style>
