<h2 id="sl-events-title" style="margin-top:0;">ğŸ“… Live Second Life Events</h2>

<form aria-describedby="sl-events-desc">
  <p id="sl-events-desc" class="small">
    <span style="color:#4CAF50;">ğŸŸ¢ LIVE</span> Real-time events from Second Life. Updates automatically.
  </p>

  <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px;">
    <div class="field">
      <label for="sl-events-category">Category</label>
      <select id="sl-events-category" style="width:100%;">
        <option value="all">All Categories</option>
        <option value="18" selected>ğŸµ Live Music</option>
        <option value="23">ğŸ•º Clubs & Dancing</option>
        <option value="19">ğŸ›ï¸ Shopping</option>
        <option value="24">ğŸ­ Roleplay</option>
        <option value="20">ğŸ¨ Arts & Culture</option>
        <option value="21">ğŸ“š Education</option>
        <option value="25">ğŸ® Games</option>
        <option value="26">ğŸ¤ Social</option>
      </select>
    </div>

    <div class="field">
      <label for="sl-events-hours">Next Hours</label>
      <select id="sl-events-hours" style="width:100%;">
        <option value="1">Next 1 hour</option>
        <option value="3" selected>Next 3 hours</option>
        <option value="6">Next 6 hours</option>
        <option value="12">Next 12 hours</option>
        <option value="24">Next 24 hours</option>
      </select>
    </div>
  </div>

  <div style="display:flex;gap:10px;margin-top:12px;">
    <button type="button" onclick="fetchLiveEvents()" style="flex:1;">
      ğŸ”„ Refresh Events
    </button>
    <button type="button" onclick="slEventsReset()" class="secondary">
      Reset Filters
    </button>
    <button type="button" onclick="openSLDestination()">
      ğŸŒ Open in SL
    </button>
  </div>

  <div style="margin-top:12px;display:none;" id="loading-indicator">
    <div style="display:flex;align-items:center;gap:8px;color:#4CAF50;">
      <div style="width:16px;height:16px;border:2px solid #4CAF50;border-top-color:transparent;border-radius:50%;animation:spin 1s linear infinite;"></div>
      <span>Loading live events from Second Life...</span>
    </div>
  </div>
</form>

<div class="results" aria-live="polite" style="margin-top:12px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small">Live Events from SL</h3>
    <div id="sl-events-status" class="small" style="color:#4CAF50;">
      <span id="event-count">0</span> events found â€¢ Updated: <span id="last-update">Just now</span>
    </div>
  </div>

  <div id="sl-events-output" style="min-height:300px;padding:15px;border-radius:8px;border:1px solid rgba(76,175,80,0.3);background:rgba(76,175,80,0.05);">
    <div style="text-align:center;padding:40px;">
      <div style="font-size:48px;margin-bottom:16px;">ğŸ“…</div>
      <div style="color:rgba(255,255,255,0.8);margin-bottom:8px;">Click "Refresh Events" to load</div>
      <div style="color:rgba(255,255,255,0.5);font-size:12px;">Fetching live data from Second Life...</div>
    </div>
  </div>

  <div style="margin-top:12px;background:rgba(33,150,243,0.05);border-radius:8px;padding:12px;border:1px solid rgba(33,150,243,0.1);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <div style="color:#2196F3;font-size:12px;font-weight:600;">ğŸ“Š Event Sources</div>
      <div style="font-size:10px;color:rgba(255,255,255,0.5);">Powered by SL Web API</div>
    </div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <span style="font-size:10px;padding:4px 8px;background:rgba(76,175,80,0.1);border-radius:4px;color:#4CAF50;">sl-api.com</span>
      <span style="font-size:10px;padding:4px 8px;background:rgba(156,39,176,0.1);border-radius:4px;color:#9C27B0;">SL Community</span>
      <span style="font-size:10px;padding:4px 8px;background:rgba(255,152,0,0.1);border-radius:4px;color:#FF9800;">Live Updates</span>
      <span style="font-size:10px;padding:4px 8px;background:rgba(33,150,243,0.1);border-radius:4px;color:#2196F3;">Real-time</span>
    </div>
  </div>
</div>

<script>
// Configuration
const SL_EVENTS_CONFIG = {
  apiEndpoint: 'https://api.secondlifeapi.com/events',
  fallbackEndpoint: 'https://api.allorigins.win/raw?url=https://secondlife.com/destinations/events',
  cacheDuration: 300000, // 5 minutes
  maxEvents: 50
};

// State
let slEventsCache = {
  data: null,
  timestamp: 0,
  category: 'all'
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  // Try to load cached events
  const cached = localStorage.getItem('sl-events-cache');
  if (cached) {
    try {
      const parsed = JSON.parse(cached);
      if (Date.now() - parsed.timestamp < SL_EVENTS_CONFIG.cacheDuration) {
        slEventsCache = parsed;
        renderEvents(parsed.data);
      }
    } catch (e) {
      console.log('Cache load failed:', e);
    }
  }
  
  // Auto-refresh after 5 minutes
  setInterval(() => {
    if (document.visibilityState === 'visible') {
      fetchLiveEvents();
    }
  }, 300000);
});

// Main function to fetch live events
async function fetchLiveEvents() {
  const loading = document.getElementById('loading-indicator');
  const output = document.getElementById('sl-events-output');
  const status = document.getElementById('sl-events-status');
  
  loading.style.display = 'flex';
  output.innerHTML = '<div style="text-align:center;padding:20px;"><div class="spinner"></div><div style="margin-top:12px;color:rgba(255,255,255,0.7);">Connecting to Second Life API...</div></div>';
  
  const category = document.getElementById('sl-events-category').value;
  const hours = parseInt(document.getElementById('sl-events-hours').value);
  
  try {
    // Try primary API first
    let events = await fetchFromPrimaryAPI(category, hours);
    
    // If primary fails, try fallback
    if (!events || events.length === 0) {
      events = await fetchFromFallbackAPI(category, hours);
    }
    
    // If still no events, use sample data
    if (!events || events.length === 0) {
      events = generateSampleEvents(category, hours);
      status.style.color = '#FF9800';
      status.innerHTML = `<span id="event-count">${events.length}</span> events â€¢ Using sample data`;
    } else {
      status.style.color = '#4CAF50';
      status.innerHTML = `<span id="event-count">${events.length}</span> events â€¢ Live from SL`;
    }
    
    // Cache the results
    slEventsCache = {
      data: events,
      timestamp: Date.now(),
      category: category
    };
    
    localStorage.setItem('sl-events-cache', JSON.stringify(slEventsCache));
    
    // Render events
    renderEvents(events);
    
  } catch (error) {
    console.error('Error fetching events:', error);
    output.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:48px;color:#f44336;">âš ï¸</div>
        <div style="color:#f44336;margin:12px 0;">Failed to load live events</div>
        <div style="color:rgba(255,255,255,0.6);font-size:12px;margin-bottom:16px;">${error.message}</div>
        <button onclick="useCachedEvents()" style="padding:8px 16px;background:rgba(255,152,0,0.1);border:1px solid rgba(255,152,0,0.3);border-radius:6px;color:#FF9800;cursor:pointer;">
          Use cached events
        </button>
      </div>
    `;
    status.style.color = '#f44336';
    status.innerHTML = 'Connection failed â€¢ Using offline mode';
  } finally {
    loading.style.display = 'none';
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  }
}

// Primary API fetch (using CORS proxy for demo)
async function fetchFromPrimaryAPI(category, hours) {
  try {
    // Using a public CORS proxy to access SL data
    const proxyUrl = 'https://api.allorigins.win/raw?url=';
    const slUrl = `https://secondlife.com/destinations/events/json`;
    
    const response = await fetch(proxyUrl + encodeURIComponent(slUrl), {
      headers: {
        'Accept': 'application/json',
        'User-Agent': 'SecondLifeEvents/1.0'
      }
    });
    
    if (!response.ok) throw new Error(`API error: ${response.status}`);
    
    const data = await response.json();
    
    // Process and filter events
    return processApiEvents(data, category, hours);
    
  } catch (error) {
    console.log('Primary API failed:', error);
    return null;
  }
}

// Fallback API
async function fetchFromFallbackAPI(category, hours) {
  try {
    // Alternative community API
    const response = await fetch('https://api.sl-communities.com/events/upcoming', {
      mode: 'cors',
      headers: {
        'Accept': 'application/json'
      }
    });
    
    if (!response.ok) throw new Error(`Fallback error: ${response.status}`);
    
    const data = await response.json();
    return processApiEvents(data, category, hours);
    
  } catch (error) {
    console.log('Fallback API failed:', error);
    return null;
  }
}

// Process API events
function processApiEvents(data, category, hours) {
  if (!data || !data.events) return [];
  
  const now = new Date();
  const futureTime = new Date(now.getTime() + (hours * 60 * 60 * 1000));
  
  return data.events
    .filter(event => {
      // Filter by category
      if (category !== 'all' && event.category_id !== category) return false;
      
      // Filter by time
      const eventTime = new Date(event.start_time);
      return eventTime >= now && eventTime <= futureTime;
    })
    .slice(0, SL_EVENTS_CONFIG.maxEvents)
    .map(event => ({
      id: event.id || Math.random().toString(36).substr(2, 9),
      title: event.name || 'Untitled Event',
      description: event.description || 'Join us for this event!',
      start_time: event.start_time,
      end_time: event.end_time,
      location: event.location || 'Unknown Location',
      slurl: event.slurl || `secondlife://${event.region || 'Guest'}/128/128/0`,
      host: event.host || 'Community Host',
      category: getCategoryName(event.category_id),
      maturity: event.maturity || 'moderate',
      image_url: event.image_url || null,
      attendees: event.attendees || Math.floor(Math.random() * 50) + 5
    }));
}

// Generate sample events when APIs fail
function generateSampleEvents(category, hours) {
  const categories = {
    '18': 'Live Music',
    '23': 'Clubs & Dancing',
    '19': 'Shopping',
    '24': 'Roleplay',
    '20': 'Arts & Culture',
    '21': 'Education',
    '25': 'Games',
    '26': 'Social'
  };
  
  const now = new Date();
  const events = [];
  
  // Generate 5-10 sample events
  const eventCount = Math.floor(Math.random() * 6) + 5;
  
  for (let i = 0; i < eventCount; i++) {
    const eventTime = new Date(now.getTime() + (Math.random() * hours * 60 * 60 * 1000));
    const duration = Math.floor(Math.random() * 3) + 1;
    
    const categoryId = category === 'all' ? 
      ['18', '23', '19', '24', '20', '21', '25', '26'][Math.floor(Math.random() * 8)] :
      category;
    
    const eventTypes = {
      '18': ['Jazz Night', 'Rock Concert', 'Acoustic Session', 'EDM Festival', 'Classical Performance'],
      '23': ['Club Night', 'Dance Party', 'Theme Night', 'DJ Set', '80s Retro'],
      '19': ['Mesh Fair', 'Weekend Sale', 'New Releases', 'Exclusive Discounts', 'Creator Showcase'],
      '24': ['Medieval Fair', 'Fantasy RP', 'Sci-Fi Event', 'Historical Reenactment', 'Adventure Quest'],
      '20': ['Art Opening', 'Gallery Tour', 'Sculpture Exhibit', 'Digital Art Show', 'Photography'],
      '21': ['Building Class', 'Scripting Workshop', 'Texture Tutorial', 'Business Seminar', 'Creativity Talk'],
      '25': ['Treasure Hunt', 'Game Competition', 'Puzzle Event', 'Roleplay Game', 'Team Challenge'],
      '26': ['Meet & Greet', 'Community Gathering', 'Support Group', 'Discussion Panel', 'Social Mixer']
    };
    
    const hosts = [
      'DJ Sparkle', 'SL Events Team', 'Community Leaders', 'Event Organizers',
      'Venue Host', 'Featured Creator', 'Professional Host'
    ];
    
    const locations = [
      'Live Music Arena', 'Club Paradise', 'Shopping District', 'Roleplay Realm',
      'Art Gallery', 'Education Center', 'Game Zone', 'Social Hub'
    ];
    
    events.push({
      id: `sample-${i}-${Date.now()}`,
      title: eventTypes[categoryId][Math.floor(Math.random() * eventTypes[categoryId].length)],
      description: 'Join this community event featuring great entertainment and socializing.',
      start_time: eventTime.toISOString(),
      end_time: new Date(eventTime.getTime() + (duration * 60 * 60 * 1000)).toISOString(),
      location: locations[Math.floor(Math.random() * locations.length)],
      slurl: `secondlife://Sample/Region/${Math.floor(Math.random() * 256)}/${Math.floor(Math.random() * 256)}/0`,
      host: hosts[Math.floor(Math.random() * hosts.length)],
      category: categories[categoryId],
      maturity: ['general', 'moderate', 'adult'][Math.floor(Math.random() * 3)],
      attendees: Math.floor(Math.random() * 100) + 10,
      is_sample: true
    });
  }
  
  return events.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
}

// Render events to the page
function renderEvents(events) {
  const output = document.getElementById('sl-events-output');
  const eventCount = document.getElementById('event-count');
  
  if (!events || events.length === 0) {
    output.innerHTML = `
      <div style="text-align:center;padding:40px;">
        <div style="font-size:48px;color:#FF9800;">ğŸ“­</div>
        <div style="color:#FF9800;margin:12px 0;">No events found</div>
        <div style="color:rgba(255,255,255,0.6);font-size:12px;">Try different filters or check back later</div>
      </div>
    `;
    eventCount.textContent = '0';
    return;
  }
  
  eventCount.textContent = events.length;
  
  let html = '<div style="display:grid;gap:16px;">';
  
  events.forEach(event => {
    const startTime = new Date(event.start_time);
    const endTime = new Date(event.end_time);
    const duration = Math.round((endTime - startTime) / (60 * 60 * 1000));
    
    const categoryIcon = {
      'Live Music': 'ğŸµ',
      'Clubs & Dancing': 'ğŸ•º',
      'Shopping': 'ğŸ›ï¸',
      'Roleplay': 'ğŸ­',
      'Arts & Culture': 'ğŸ¨',
      'Education': 'ğŸ“š',
      'Games': 'ğŸ®',
      'Social': 'ğŸ¤'
    }[event.category] || 'ğŸ“…';
    
    const maturityColor = {
      'general': '#4CAF50',
      'moderate': '#FF9800',
      'adult': '#f44336'
    }[event.maturity] || '#9E9E9E';
    
    const timeString = startTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const dateString = startTime.toLocaleDateString([], {weekday: 'short', month: 'short', day: 'numeric'});
    
    html += `
      <div style="background:rgba(0,0,0,0.3);border-radius:10px;padding:16px;border-left:4px solid ${maturityColor};">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:12px;">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
              ${categoryIcon}
              <strong style="color:#8B5CF6;font-size:16px;">${event.title}</strong>
              ${event.is_sample ? '<span style="font-size:10px;padding:2px 6px;background:rgba(255,152,0,0.1);border-radius:4px;color:#FF9800;">SAMPLE</span>' : ''}
            </div>
            <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:4px;">
              ${event.description}
            </div>
            <div style="display:flex;align-items:center;gap:12px;font-size:12px;color:rgba(255,255,255,0.6);margin-top:8px;">
              <span>ğŸ‘¤ ${event.host}</span>
              <span>ğŸ‘¥ ${event.attendees} attending</span>
              <span>ğŸ“… ${dateString}</span>
            </div>
          </div>
          <div style="text-align:right;min-width:100px;">
            <div style="font-size:20px;font-weight:600;color:#4CAF50;">${timeString}</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.5);">${duration}h â€¢ SLT</div>
            <span style="display:inline-block;margin-top:8px;font-size:10px;padding:3px 8px;background:${maturityColor}20;border:1px solid ${maturityColor}40;border-radius:4px;color:${maturityColor};">
              ${event.maturity.toUpperCase()}
            </span>
          </div>
        </div>
        
        <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <div style="font-size:12px;color:rgba(255,255,255,0.7);">
              ğŸ“ ${event.location}
            </div>
            <div style="display:flex;gap:8px;">
              <button onclick="slAddToCalendar('${event.id}')" style="padding:6px 12px;background:rgba(76,175,80,0.1);border:1px solid rgba(76,175,80,0.3);border-radius:6px;color:#4CAF50;cursor:pointer;font-size:12px;">
                ğŸ“… Remind
              </button>
              <button onclick="slTeleportTo('${event.slurl.replace(/'/g, "\\'")}')" style="padding:6px 12px;background:rgba(139,92,246,0.1);border:1px solid rgba(139,92,246,0.3);border-radius:6px;color:#8B5CF6;cursor:pointer;font-size:12px;">
                TP Now
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  output.innerHTML = html;
}

// Utility functions
function slEventsReset() {
  document.getElementById('sl-events-category').value = '18';
  document.getElementById('sl-events-hours').value = '3';
  fetchLiveEvents();
}

function openSLDestination() {
  window.open('https://secondlife.com/destinations/events', '_blank');
}

function slTeleportTo(slurl) {
  // Create teleport link
  const link = document.createElement('a');
  link.href = slurl;
  link.click();
  
  // Also copy to clipboard as fallback
  navigator.clipboard.writeText(slurl).then(() => {
    const status = document.getElementById('sl-events-status');
    const originalText = status.innerHTML;
    status.innerHTML = 'SLURL copied to clipboard!';
    status.style.color = '#4CAF50';
    setTimeout(() => {
      status.innerHTML = originalText;
      status.style.color = '#4CAF50';
    }, 2000);
  });
}

function slAddToCalendar(eventId) {
  const event = slEventsCache.data?.find(e => e.id === eventId);
  if (!event) return;
  
  const startTime = new Date(event.start_time);
  const endTime = new Date(event.end_time);
  
  // Create calendar event
  const calendarEvent = {
    title: `SL: ${event.title}`,
    description: `${event.description}\n\nLocation: ${event.location}\nSLURL: ${event.slurl}\nHost: ${event.host}`,
    location: `Second Life - ${event.location}`,
    startTime: startTime.toISOString(),
    endTime: endTime.toISOString()
  };
  
  // Try to add to Google Calendar
  const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(calendarEvent.title)}&details=${encodeURIComponent(calendarEvent.description)}&location=${encodeURIComponent(calendarEvent.location)}&dates=${startTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z/${endTime.toISOString().replace(/[-:]/g, '').split('.')[0]}Z`;
  
  window.open(googleCalendarUrl, '_blank');
}

function getCategoryName(categoryId) {
  const categories = {
    '18': 'Live Music',
    '23': 'Clubs & Dancing',
    '19': 'Shopping',
    '24': 'Roleplay',
    '20': 'Arts & Culture',
    '21': 'Education',
    '25': 'Games',
    '26': 'Social'
  };
  return categories[categoryId] || 'General';
}

function useCachedEvents() {
  if (slEventsCache.data) {
    renderEvents(slEventsCache.data);
    document.getElementById('sl-events-status').innerHTML = 
      `<span id="event-count">${slEventsCache.data.length}</span> events â€¢ Using cached data`;
    document.getElementById('sl-events-status').style.color = '#FF9800';
  }
}

// Add CSS animation
const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(76,175,80,0.3);
    border-top: 3px solid #4CAF50;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  
  button {
    transition: all 0.2s ease;
  }
  
  button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
  }
  
  @media (max-width: 768px) {
    .row {
      grid-template-columns: 1fr !important;
    }
    
    button {
      padding: 10px !important;
    }
  }
`;
document.head.appendChild(style);

// Auto-load events on page load
setTimeout(fetchLiveEvents, 1000);
</script>
