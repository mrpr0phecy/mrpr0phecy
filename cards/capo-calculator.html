<h2 id="capo-calculator-title" style="margin-top:0;">üé∏ Capo Calculator</h2>

<form aria-describedby="capo-calculator-desc">
  <p id="capo-calculator-desc" class="small">
    Find capo placement for key transposition, chord conversion, and song adaptation. Supports sharps/flats, multiple fret options, and tuning adjustments.
  </p>

  <!-- INPUT SECTION - THEMED -->
  <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;margin-bottom:20px;">
    <div style="color:#2dd4ff;font-weight:600;margin-bottom:15px;">üéµ Key & Tuning Settings:</div>
    
    <!-- KEYS SECTION -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;">
      <div>
        <label for="capo-original" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#ffa500;">Original Key</span>
        </label>
        <select id="capo-original" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.05);color:#e6faff;font-size:16px;">
          <option value="C">C</option>
          <option value="C#">C# / D‚ô≠</option>
          <option value="D">D</option>
          <option value="D#">D# / E‚ô≠</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / G‚ô≠</option>
          <option value="G" selected>G</option>
          <option value="G#">G# / A‚ô≠</option>
          <option value="A">A</option>
          <option value="A#">A# / B‚ô≠</option>
          <option value="B">B</option>
        </select>
      </div>
      
      <div>
        <label for="capo-target" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#2dd4ff;">Target Key</span>
        </label>
        <select id="capo-target" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:#e6faff;font-size:16px;">
          <option value="C" selected>C</option>
          <option value="C#">C# / D‚ô≠</option>
          <option value="D">D</option>
          <option value="D#">D# / E‚ô≠</option>
          <option value="E">E</option>
          <option value="F">F</option>
          <option value="F#">F# / G‚ô≠</option>
          <option value="G">G</option>
          <option value="G#">G# / A‚ô≠</option>
          <option value="A">A</option>
          <option value="A#">A# / B‚ô≠</option>
          <option value="B">B</option>
        </select>
      </div>
    </div>
    
    <!-- TUNING & CAPO TYPE -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px;">
      <div>
        <label for="capo-tuning" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#39ff14;">Tuning</span>
        </label>
        <select id="capo-tuning" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:#e6faff;font-size:16px;">
          <option value="standard" selected>Standard (E A D G B E)</option>
          <option value="dropD">Drop D (D A D G B E)</option>
          <option value="half-step">¬Ω Step Down (D# G# C# F# A# D#)</option>
          <option value="full-step">Full Step Down (D G C F A D)</option>
          <option value="openG">Open G (D G D G B D)</option>
          <option value="openD">Open D (D A D F# A D)</option>
          <option value="dadgad">DADGAD (D A D G A D)</option>
        </select>
      </div>
      
      <div>
        <label for="capo-type" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#9d4edd;">Capo Type</span>
        </label>
        <select id="capo-type" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(157,78,221,0.3);background:rgba(157,78,221,0.05);color:#e6faff;font-size:16px;">
          <option value="spring" selected>Spring Clamp</option>
          <option value="screw">Screw/Adjustable</option>
          <option value="strap">Strap/Band</option>
          <option value="partial">Partial Capo</option>
          <option value="shubb">Shubb (Roller)</option>
        </select>
      </div>
    </div>
    
    <!-- SPECIFIC CHORD -->
    <div style="margin-bottom:20px;">
      <label for="capo-chord" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
        <span style="color:#ffcc00;">Specific Chord (optional)</span>
      </label>
      <input id="capo-chord" type="text" placeholder="e.g. G, Cadd9, Dm7" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,204,0,0.3);background:rgba(255,204,0,0.05);color:#e6faff;font-size:16px;" />
      <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
        Enter a chord to see its specific conversion
      </div>
    </div>
    
    <!-- DISPLAY SETTINGS -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
      <div>
        <label for="capo-show-chords" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#4dabf7;">Show Chord Conversion</span>
        </label>
        <select id="capo-show-chords" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(77,171,247,0.3);background:rgba(77,171,247,0.05);color:#e6faff;font-size:16px;">
          <option value="yes" selected>Yes</option>
          <option value="no">No</option>
        </select>
      </div>
      
      <div>
        <label for="capo-max-fret" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
          <span style="color:#e83e8c;">Max Fret Display</span>
        </label>
        <select id="capo-max-fret" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(232,62,140,0.3);background:rgba(232,62,140,0.05);color:#e6faff;font-size:16px;">
          <option value="5">5 frets max</option>
          <option value="7" selected>7 frets max</option>
          <option value="9">9 frets max</option>
          <option value="12">12 frets (full octave)</option>
        </select>
      </div>
    </div>
  </div>
  
  <!-- QUICK EXAMPLES -->
  <div style="margin-bottom:25px;">
    <div style="color:rgba(230,250,255,0.8);margin-bottom:10px;font-size:14px;">Common Transpositions:</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button class="capo-example-btn" data-original="G" data-target="C" data-tuning="standard" data-type="spring"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        G ‚Üí C (Fret 5)
      </button>
      <button class="capo-example-btn" data-original="C" data-target="D" data-tuning="standard" data-type="spring"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        C ‚Üí D (Fret 2)
      </button>
      <button class="capo-example-btn" data-original="D" data-target="A" data-tuning="dropD" data-type="screw"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        D ‚Üí A (Fret 5, Drop D)
      </button>
      <button class="capo-example-btn" data-original="E" data-target="G" data-tuning="half-step" data-type="strap"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        E ‚Üí G (Fret 3, ¬Ω Step Down)
      </button>
    </div>
  </div>
  
  <!-- CALCULATE BUTTON -->
  <div style="text-align:center;margin:25px 0;">
    <button id="capo-calculate-btn" 
            style="background:#2dd4ff;color:#000;border:none;padding:14px 32px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;box-shadow:0 4px 15px rgba(45,212,255,0.3);">
      üé∏ CALCULATE CAPO
    </button>
    
    <button id="capo-reset-btn" 
            style="background:rgba(255,255,255,0.08);color:#e6faff;border:1px solid rgba(255,255,255,0.2);padding:14px 24px;border-radius:10px;cursor:pointer;font-size:16px;margin-left:12px;">
      Reset
    </button>
  </div>
  
  <!-- RESULTS DISPLAY -->
  <div id="capo-results" style="display:none;">
    <div style="background:rgba(20,20,20,0.7);border-radius:10px;padding:25px;border:1px solid rgba(57,255,20,0.2);margin-bottom:25px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="color:#39ff14;font-size:18px;font-weight:600;">üéµ Capo Calculation Results</div>
        <button id="capo-copy-btn" 
                style="background:rgba(57,255,20,0.1);color:#39ff14;border:1px solid rgba(57,255,20,0.3);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">
          Copy Results
        </button>
      </div>
      
      <!-- Interval Display -->
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;padding:12px;background:rgba(0,0,0,0.3);border-radius:8px;border:1px solid rgba(45,212,255,0.2);">
        <div>
          <div style="color:rgba(230,250,255,0.8);font-size:12px;">Semitone Steps</div>
          <div id="capo-steps" style="font-size:24px;font-weight:600;color:#39ff14;">‚Äì</div>
        </div>
        <div>
          <div style="color:rgba(230,250,255,0.8);font-size:12px;">Fret Options</div>
          <div id="capo-options" style="font-size:24px;font-weight:600;color:#2dd4ff;">‚Äì</div>
        </div>
        <div>
          <div style="color:rgba(230,250,255,0.8);font-size:12px;">Interval</div>
          <div id="capo-interval-display" style="font-size:16px;font-weight:600;color:#ffa500;">‚Äì</div>
        </div>
      </div>
      
      <!-- Main Results -->
      <div id="capo-result-display" style="font-size:15px;color:#e6faff;line-height:1.6;padding:15px;background:rgba(0,0,0,0.3);border-radius:8px;white-space:pre-line;font-family:monospace;max-height:400px;overflow-y:auto;">
        <!-- Results appear here -->
      </div>
      
      <!-- Status -->
      <div style="margin-top:15px;padding:10px;background:rgba(45,212,255,0.1);border-radius:6px;border:1px solid rgba(45,212,255,0.3);">
        <div style="color:#2dd4ff;font-size:14px;display:flex;justify-content:space-between;">
          <span>Status: <span id="capo-status" style="color:#39ff14;">Ready</span></span>
          <span id="capo-hint" style="color:rgba(230,250,255,0.7);"></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- FRETBOARD VISUALIZATION -->
  <div id="capo-fretboard" style="display:none;margin-top:25px;">
    <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;border:1px solid rgba(255,165,0,0.2);">
      <div style="color:#ffa500;font-weight:600;margin-bottom:15px;font-size:16px;">
        üéØ Fretboard Reference
      </div>
      
      <div style="background:rgba(0,0,0,0.3);padding:15px;border-radius:8px;">
        <!-- Fret numbers -->
        <div style="display:grid;grid-template-columns:repeat(13,1fr);gap:4px;text-align:center;margin-bottom:8px;">
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">Open</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">1</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">2</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">3</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">4</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">5</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">6</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">7</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">8</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">9</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">10</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">11</div>
          <div style="font-weight:600;padding:8px;background:rgba(255,255,255,0.1);border-radius:4px;color:var(--accent);">12</div>
        </div>
        
        <!-- Note display -->
        <div style="display:grid;grid-template-columns:repeat(13,1fr);gap:4px;text-align:center;">
          <div id="capo-fret-0" style="padding:12px;background:rgba(45,212,255,0.2);border-radius:4px;font-weight:600;color:var(--accent);"></div>
          <div id="capo-fret-1" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-2" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-3" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-4" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-5" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-6" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-7" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-8" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-9" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-10" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-11" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
          <div id="capo-fret-12" style="padding:12px;background:rgba(255,255,255,0.05);border-radius:4px;"></div>
        </div>
        
        <!-- Capo marker -->
        <div style="text-align:center;margin-top:12px;">
          <span id="capo-capo-marker" style="background:linear-gradient(135deg,#2dd4ff,#39ff14);color:#000;padding:6px 16px;border-radius:20px;font-weight:600;display:none;"></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- CHORD REFERENCE -->
  <div id="capo-chord-reference" style="display:none;margin-top:25px;">
    <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;border:1px solid rgba(57,255,20,0.2);">
      <div style="color:#39ff14;font-weight:600;margin-bottom:15px;font-size:16px;">
        üéº Chord Conversion Reference
      </div>
      
      <div id="capo-chord-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;"></div>
    </div>
  </div>
  
  <!-- TIPS & FACTS -->
  <div id="capo-tips" style="margin-top:25px;display:block;">
    <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;border:1px solid rgba(255,165,0,0.2);">
      <div style="color:#ffa500;font-weight:600;margin-bottom:15px;font-size:16px;">
        üí° Capo Tips & Facts
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">
        <div style="background:rgba(255,165,0,0.05);padding:12px;border-radius:8px;border-left:3px solid #ffa500;">
          <div style="color:#ffa500;font-weight:600;margin-bottom:5px;">Basic Principle</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">A capo raises pitch by one semitone per fret. Fret 1 = +1 semitone, Fret 2 = +2 semitones (whole step), etc.</div>
        </div>
        
        <div style="background:rgba(45,212,255,0.05);padding:12px;border-radius:8px;border-left:3px solid #2dd4ff;">
          <div style="color:#2dd4ff;font-weight:600;margin-bottom:5px;">Common Uses</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Change key without new chord shapes</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Match vocal range</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Create brighter tone</div>
        </div>
        
        <div style="background:rgba(157,78,221,0.05);padding:12px;border-radius:8px;border-left:3px solid #9d4edd;">
          <div style="color:#9d4edd;font-weight:600;margin-bottom:5px;">Capo Types</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Spring: Quick, one-handed</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Screw: Precise tension</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Strap: Even pressure</div>
        </div>
        
        <div style="background:rgba(57,255,20,0.05);padding:12px;border-radius:8px;border-left:3px solid #39ff14;">
          <div style="color:#39ff14;font-weight:600;margin-bottom:5px;">Pro Tips</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Place capo close to fret wire</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Check all strings ring clearly</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">‚Ä¢ Adjust for different neck widths</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ERROR MESSAGE -->
  <div id="capo-error" style="margin-top:20px;padding:15px;background:rgba(255,77,77,0.1);border-radius:8px;border:1px solid rgba(255,77,77,0.3);display:none;">
    <div style="color:#ff4d4d;font-weight:600;margin-bottom:5px;">‚ö†Ô∏è Please check your inputs</div>
    <div id="capo-error-text" style="color:rgba(255,77,77,0.9);"></div>
  </div>
</form>

<style>
#capo-calculator-title { 
  color: #2dd4ff; 
  margin-top: 0;
  margin-bottom: 10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .capo-example-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
  
  #capo-calculate-btn, #capo-reset-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
  
  #capo-chord-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}
</style>

<script>
/* capo-calculator.html
   - Enhanced Capo Calculator with dark theme
   - Scoped with ca- prefix (capo)
*/

let caPresets = JSON.parse(localStorage.getItem('caPresets') || '[]');
const caChromaticScale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const caIntervalNames = ["Unison", "Minor 2nd", "Major 2nd", "Minor 3rd", "Major 3rd", "Perfect 4th", 
                      "Tritone", "Perfect 5th", "Minor 6th", "Major 6th", "Minor 7th", "Major 7th", "Octave"];

// Common chords for reference
const caCommonChords = {
  "C": ["C", "Dm", "Em", "F", "G", "Am", "Bdim"],
  "G": ["G", "Am", "Bm", "C", "D", "Em", "F#dim"],
  "D": ["D", "Em", "F#m", "G", "A", "Bm", "C#dim"],
  "A": ["A", "Bm", "C#m", "D", "E", "F#m", "G#dim"],
  "E": ["E", "F#m", "G#m", "A", "B", "C#m", "D#dim"],
  "F": ["F", "Gm", "Am", "Bb", "C", "Dm", "Edim"]
};

// Initialize
function caInit() {
    console.log("Capo Calculator: Initializing...");
    
    // Example buttons
    const exampleBtns = document.querySelectorAll('.capo-example-btn');
    exampleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const originalKey = this.dataset.original;
            const targetKey = this.dataset.target;
            const tuning = this.dataset.tuning;
            const type = this.dataset.type;
            
            document.getElementById('capo-original').value = originalKey;
            document.getElementById('capo-target').value = targetKey;
            document.getElementById('capo-tuning').value = tuning;
            document.getElementById('capo-type').value = type;
            
            // Visual feedback
            exampleBtns.forEach(b => {
                b.style.background = 'rgba(255,255,255,0.05)';
                b.style.border = '1px solid rgba(255,255,255,0.1)';
            });
            this.style.background = 'rgba(45,212,255,0.15)';
            this.style.border = '1px solid #2dd4ff';
            
            caClearResults();
        });
    });
    
    // Calculate button
    document.getElementById('capo-calculate-btn').addEventListener('click', caCalculate);
    
    // Reset button
    document.getElementById('capo-reset-btn').addEventListener('click', caReset);
    
    // Copy button
    document.getElementById('capo-copy-btn').addEventListener('click', caCopyResult);
    
    // Enter key support
    const inputs = document.querySelectorAll('#capo-original, #capo-target, #capo-chord');
    inputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                caCalculate();
            }
        });
    });
    
    console.log("‚úÖ Capo Calculator ready!");
}

// Reset function
function caReset() {
    document.getElementById('capo-original').value = 'G';
    document.getElementById('capo-target').value = 'C';
    document.getElementById('capo-tuning').value = 'standard';
    document.getElementById('capo-type').value = 'spring';
    document.getElementById('capo-chord').value = '';
    document.getElementById('capo-show-chords').value = 'yes';
    document.getElementById('capo-max-fret').value = '7';
    
    // Reset example buttons
    document.querySelectorAll('.capo-example-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.border = '1px solid rgba(255,255,255,0.1)';
    });
    
    caClearResults();
    
    // Focus on original key
    setTimeout(() => {
        document.getElementById('capo-original').focus();
    }, 50);
    
    console.log("Capo calculator reset");
}

// Clear results
function caClearResults() {
    document.getElementById('capo-results').style.display = 'none';
    document.getElementById('capo-fretboard').style.display = 'none';
    document.getElementById('capo-chord-reference').style.display = 'none';
    document.getElementById('capo-error').style.display = 'none';
    
    // Reset displays
    document.getElementById('capo-steps').textContent = '‚Äì';
    document.getElementById('capo-options').textContent = '‚Äì';
    document.getElementById('capo-interval-display').textContent = '‚Äì';
    document.getElementById('capo-status').textContent = 'Ready';
    document.getElementById('capo-status').style.color = '#39ff14';
    document.getElementById('capo-hint').textContent = '';
}

// Show error
function caShowError(message) {
    document.getElementById('capo-error-text').textContent = message;
    document.getElementById('capo-error').style.display = 'block';
    document.getElementById('capo-status').textContent = 'Error';
    document.getElementById('capo-status').style.color = '#ff4d4d';
}

// Main calculation function
function caCalculate() {
    console.log("Calculating capo position...");
    
    // Hide previous results/errors
    caClearResults();
    
    // Get inputs
    const originalKey = document.getElementById('capo-original').value;
    const targetKey = document.getElementById('capo-target').value;
    const tuning = document.getElementById('capo-tuning').value;
    const capoType = document.getElementById('capo-type').value;
    const specificChord = document.getElementById('capo-chord').value.trim();
    const showChords = document.getElementById('capo-show-chords').value === 'yes';
    const maxFret = parseInt(document.getElementById('capo-max-fret').value);
    
    document.getElementById('capo-status').textContent = "Calculating...";
    document.getElementById('capo-status').style.color = "#ffa500";
    
    // Calculate semitone steps
    const originalIndex = caChromaticScale.indexOf(originalKey);
    const targetIndex = caChromaticScale.indexOf(targetKey);
    
    if(originalIndex === -1 || targetIndex === -1) {
        caShowError("Invalid key selection");
        return;
    }
    
    let steps = (targetIndex - originalIndex + 12) % 12;
    
    // Find all possible capo positions (within max fret)
    const positions = [];
    for(let i = 0; i <= Math.min(12, maxFret); i++) {
        if((originalIndex + i) % 12 === targetIndex) {
            positions.push(i);
        }
    }
    
    // Also find positions in opposite direction (using different chord shapes)
    for(let i = 0; i <= Math.min(12, maxFret); i++) {
        const checkIndex = (originalIndex - i + 12) % 12;
        if(checkIndex === targetIndex && !positions.includes(12 - i)) {
            positions.push(12 - i);
        }
    }
    
    positions.sort((a, b) => a - b);
    
    // Build result
    let result = `üé∏ CAPO CALCULATOR RESULTS\n`;
    result += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
    result += `Original Key: ${originalKey}\n`;
    result += `Target Key: ${targetKey}\n`;
    result += `Tuning: ${document.querySelector('#capo-tuning option:checked').textContent}\n`;
    result += `Capo Type: ${capoType.charAt(0).toUpperCase() + capoType.slice(1)}\n\n`;
    result += `üìä TRANSFORMATION DETAILS\n`;
    result += `Semitone Steps: ${steps}\n`;
    result += `Musical Interval: ${caIntervalNames[steps]}\n`;
    result += `Fret Options Found: ${positions.length}\n\n`;
    
    // Primary capo position
    if(positions.length > 0) {
        result += `üéØ PRIMARY CAPO POSITION:\n`;
        result += `Place capo at fret ${positions[0]}.\n`;
        result += `Play ${originalKey} chord shapes ‚Üí sounds as ${targetKey}.\n\n`;
        
        if(positions.length > 1) {
            result += `üîÑ ALTERNATIVE POSITIONS (${positions.length - 1} more):\n`;
            for(let i = 1; i < positions.length; i++) {
                result += `‚Ä¢ Fret ${positions[i]}: Use different chord voicings\n`;
            }
            result += `\n`;
        }
    } else {
        result += `‚ùå No capo position found within ${maxFret} frets.\n`;
        result += `Try adjusting max fret display or using different chord shapes.\n\n`;
    }
    
    // Add specific chord conversion if provided
    if(specificChord) {
        result += `üéº SPECIFIC CHORD CONVERSION:\n`;
        const convertedChord = caConvertChord(specificChord, steps);
        result += `Play "${specificChord}" shape with capo at fret ${positions[0] || 0}\n`;
        result += `Sounds as: "${convertedChord}"\n\n`;
    }
    
    // Add tuning notes
    result += `üéµ TUNING NOTES:\n`;
    result += `${caGetTuningNotes(tuning)}\n\n`;
    
    // Add capo type tips
    result += `üí° CAPO TYPE TIPS:\n`;
    result += `${caGetCapoTips(capoType, positions[0] || 0)}\n\n`;
    
    // Add practice tips
    result += `‚ö° PRACTICE TIPS:\n`;
    result += `‚Ä¢ Check all strings ring clearly after placing capo\n`;
    result += `‚Ä¢ Tune guitar after applying capo\n`;
    result += `‚Ä¢ Experiment with different positions for tone variations\n`;
    result += `‚Ä¢ Consider partial capo for creative voicings\n`;
    
    // Display results
    document.getElementById('capo-result-display').textContent = result;
    document.getElementById('capo-steps').textContent = steps;
    document.getElementById('capo-options').textContent = positions.length;
    document.getElementById('capo-interval-display').textContent = caIntervalNames[steps];
    document.getElementById('capo-status').textContent = "Completed ‚úì";
    document.getElementById('capo-status').style.color = "#39ff14";
    document.getElementById('capo-hint').textContent = `${positions.length} fret options found`;
    document.getElementById('capo-results').style.display = 'block';
    
    // Show visualizations
    caUpdateFretboard(positions[0] || 0, originalKey, targetKey);
    document.getElementById('capo-fretboard').style.display = 'block';
    
    // Show chord reference if enabled
    if(showChords && positions.length > 0) {
        caUpdateChordReference(originalKey, steps, positions[0]);
        document.getElementById('capo-chord-reference').style.display = 'block';
    }
    
    // Show tips
    document.getElementById('capo-tips').style.display = 'block';
}

// Convert chord
function caConvertChord(chord, steps) {
    const chordRootMatch = chord.match(/^([A-G]#?b?)/);
    if(!chordRootMatch) return chord;
    
    const root = chordRootMatch[1];
    const quality = chord.substring(root.length);
    const rootIndex = caChromaticScale.indexOf(root);
    
    if(rootIndex === -1) return chord;
    
    const newRootIndex = (rootIndex + steps) % 12;
    const newRoot = caChromaticScale[newRootIndex];
    
    return newRoot + quality;
}

// Get tuning notes
function caGetTuningNotes(tuning) {
    const tunings = {
        standard: "Standard tuning: E2 A2 D3 G3 B3 E4",
        dropD: "Drop D: D2 A2 D3 G3 B3 E4 (lower 6th string to D)",
        "half-step": "¬Ω Step Down: D#2 G#2 C#3 F#3 A#3 D#4 (tune all strings down ¬Ω step)",
        "full-step": "Full Step Down: D2 G2 C3 F3 A3 D4 (tune all strings down whole step)",
        openG: "Open G: D2 G2 D3 G3 B3 D4 (plays G chord when strummed open)",
        openD: "Open D: D2 A2 D3 F#3 A3 D4 (plays D chord when strummed open)",
        dadgad: "DADGAD: D2 A2 D3 G3 A3 D4 (common in Celtic fingerstyle)"
    };
    return tunings[tuning] || tunings.standard;
}

// Get capo tips
function caGetCapoTips(type, fret) {
    const tips = {
        spring: `‚Ä¢ Quick to apply/remove\n‚Ä¢ Good for frequent key changes\n‚Ä¢ May need adjustment for even pressure`,
        screw: `‚Ä¢ Precise tension control\n‚Ä¢ Good for uneven fretboards\n‚Ä¢ Takes longer to adjust`,
        strap: `‚Ä¢ Even pressure across all strings\n‚Ä¢ Works well with 12-string guitars\n‚Ä¢ Can slip if not tight enough`,
        partial: `‚Ä¢ Creative chord voicings\n‚Ä¢ Leaves some strings open\n‚Ä¢ Experiment with different positions`,
        shubb: `‚Ä¢ Roller mechanism prevents string bending\n‚Ä¢ Precise placement\n‚Ä¢ Good for recording situations`
    };
    
    let tip = tips[type] || tips.spring;
    
    if(fret > 5) {
        tip += `\n‚Ä¢ High capo position: Consider lighter gauge strings\n‚Ä¢ Check intonation on higher frets`;
    }
    
    return tip;
}

// Update fretboard visualization
function caUpdateFretboard(capoFret, originalKey, targetKey) {
    // Highlight the capo position
    for(let i = 0; i <= 12; i++) {
        const fretEl = document.getElementById('capo-fret-' + i);
        if(fretEl) {
            if(i === 0) {
                fretEl.textContent = originalKey;
                fretEl.style.background = "rgba(45,212,255,0.3)";
                fretEl.style.color = "#2dd4ff";
                fretEl.style.fontWeight = "600";
            } else if(i === capoFret) {
                fretEl.textContent = targetKey;
                fretEl.style.background = "linear-gradient(135deg, #39ff14, #2dd4ff)";
                fretEl.style.color = "#000";
                fretEl.style.fontWeight = "bold";
                fretEl.style.boxShadow = "0 0 10px rgba(57,255,20,0.5)";
            } else {
                const noteIndex = (caChromaticScale.indexOf(originalKey) + i) % 12;
                fretEl.textContent = caChromaticScale[noteIndex];
                fretEl.style.background = i < capoFret ? "rgba(255,255,255,0.1)" : "rgba(255,255,255,0.05)";
                fretEl.style.color = i < capoFret ? "#e6faff" : "rgba(230,250,255,0.7)";
                fretEl.style.boxShadow = "none";
            }
        }
    }
    
    // Show capo marker
    const marker = document.getElementById('capo-capo-marker');
    if(marker && capoFret > 0) {
        marker.textContent = `üé∏ Capo at Fret ${capoFret}`;
        marker.style.display = "inline-block";
    }
}

// Update chord reference
function caUpdateChordReference(originalKey, steps, capoFret) {
    const grid = document.getElementById('capo-chord-grid');
    if(!grid) return;
    
    // Get common chords for the original key
    const baseKey = originalKey.replace(/[#b]/, '');
    const chords = caCommonChords[baseKey] || ["I", "ii", "iii", "IV", "V", "vi", "vii¬∞"];
    
    grid.innerHTML = "";
    
    chords.forEach(chord => {
        const converted = caConvertChord(chord, steps);
        const chordDiv = document.createElement('div');
        chordDiv.style.cssText = 'background:rgba(0,0,0,0.3);padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.2);transition:all 0.2s;';
        chordDiv.innerHTML = `
            <div style="text-align:center;">
                <div style="font-size:1.3em;font-weight:bold;color:#2dd4ff;">${chord}</div>
                <div style="font-size:0.9em;color:rgba(230,250,255,0.6);margin:6px 0;">with capo @ ${capoFret}</div>
                <div style="font-size:1.2em;color:#39ff14;font-weight:bold;margin:4px 0;">${converted}</div>
                <div style="font-size:0.8em;color:rgba(230,250,255,0.5);margin-top:4px;">sounds as</div>
            </div>
        `;
        
        chordDiv.addEventListener('mouseenter', function() {
            this.style.transform = 'translateY(-2px)';
            this.style.boxShadow = '0 4px 12px rgba(57,255,20,0.2)';
            this.style.borderColor = '#39ff14';
        });
        
        chordDiv.addEventListener('mouseleave', function() {
            this.style.transform = '';
            this.style.boxShadow = '';
            this.style.borderColor = 'rgba(57,255,20,0.2)';
        });
        
        grid.appendChild(chordDiv);
    });
}

// Copy result
function caCopyResult() {
    const result = document.getElementById('capo-result-display').textContent;
    if(!result.trim()) return;
    
    navigator.clipboard.writeText(result).then(() => {
        const copyBtn = document.getElementById('capo-copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = 'rgba(57,255,20,0.2)';
        
        document.getElementById('capo-hint').textContent = 'Results copied to clipboard';
        document.getElementById('capo-hint').style.color = '#39ff14';
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = '';
            document.getElementById('capo-hint').textContent = '';
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', caInit);
} else {
    setTimeout(caInit, 100);
}
</script>
