<h2 id="graphing-calculator-title" style="margin-top:0;">üåê Smart Graphing Calculator</h2>

<!-- Manifest metadata -->
<!--
  id: graphing-calculator
  title: Smart Graphing Calculator
  path: cards/graphing-calculator.html
  category: Math & Science
  version: 2.0
  viral_tags: [math, education, STEM, visualization, social_share]
  accessibility: [high_contrast, keyboard_nav, screen_reader]
  languages: [en, es, fr, de, zh, ja, ar, hi, pt, ru]
-->

<form aria-describedby="graphing-desc" style="margin-bottom:16px;">
  <div id="graphing-desc" class="small" style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:start;">
    <div>
      <p style="margin:0 0 8px 0;color:var(--muted);">
        <span style="color:var(--accent);font-weight:600;">Interactive math visualization</span>: Plot functions, find roots, compute derivatives/integrals, solve equations, and create beautiful graphs. Perfect for students, teachers, and professionals.
      </p>
      
      <!-- Quick Language Selector -->
      <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px;">
        <span style="color:var(--muted);font-size:12px;align-self:center;">üåç </span>
        <select id="gc-lang" style="font-size:12px;padding:4px 8px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);max-width:120px;">
          <option value="en">English</option>
          <option value="es">Espa√±ol</option>
          <option value="fr">Fran√ßais</option>
          <option value="de">Deutsch</option>
          <option value="zh">‰∏≠Êñá</option>
          <option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
          <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
          <option value="pt">Portugu√™s</option>
        </select>
      </div>
    </div>
    
    <!-- Social Sharing & Accessibility -->
    <div style="display:flex;gap:6px;flex-direction:column;">
      <button type="button" onclick="gcShareGraph()" class="social-btn" style="padding:6px 10px;font-size:12px;background:linear-gradient(135deg, #1da1f2, #0d8bd9);color:white;border:none;border-radius:6px;cursor:pointer;display:flex;align-items:center;gap:4px;">
        <span>üì§</span> Share
      </button>
      <button type="button" onclick="gcToggleAccessibility()" class="acc-btn" style="padding:6px 10px;font-size:12px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;display:flex;align-items:center;gap:4px;">
        <span>üëÅÔ∏è</span> A11y
      </button>
    </div>
  </div>

  <!-- Expression Input with Smart Suggestions -->
  <div style="margin-bottom:16px;position:relative;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <label for="gc-expression" style="color:var(--accent);font-weight:500;">Enter Mathematical Expression</label>
      <button type="button" onclick="gcShowExamples()" style="background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:12px;display:flex;align-items:center;gap:4px;">
        üí° Examples
      </button>
    </div>
    
    <div style="position:relative;">
      <input id="gc-expression" type="text" placeholder="e.g., sin(x)*exp(-x/5)*cos(3*x)" 
             style="width:100%;padding:12px 40px 12px 12px;border-radius:8px;border:2px solid var(--border);background:var(--glass);color:var(--text);font-size:16px;" 
             aria-describedby="expression-help" />
      <button onclick="gcVoiceInput()" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);background:transparent;border:none;color:var(--accent);cursor:pointer;padding:4px;" title="Voice input">
        üé§
      </button>
    </div>
    
    <div id="expression-help" class="small" style="margin-top:8px;color:var(--muted);">
      Use <code style="background:rgba(45,212,255,0.1);padding:2px 4px;border-radius:4px;">x</code>, 
      <code style="background:rgba(45,212,255,0.1);padding:2px 4px;border-radius:4px;">y</code>, 
      <code style="background:rgba(45,212,255,0.1);padding:2px 4px;border-radius:4px;">t</code> as variables. 
      Supports: sin, cos, tan, sqrt, log, exp, ^ (power), pi, e
    </div>
    
    <!-- Quick Expression Buttons -->
    <div style="display:flex;gap:6px;flex-wrap:wrap;margin-top:12px;">
      <button type="button" onclick="gcQuickExpression('sin(x)')" class="quick-expr">sin(x)</button>
      <button type="button" onclick="gcQuickExpression('x^2')" class="quick-expr">x¬≤</button>
      <button type="button" onclick="gcQuickExpression('exp(-x^2)')" class="quick-expr">Bell Curve</button>
      <button type="button" onclick="gcQuickExpression('1/(1+x^2)')" class="quick-expr">Lorentzian</button>
      <button type="button" onclick="gcQuickExpression('x*sin(1/x)')" class="quick-expr">Oscillation</button>
    </div>
  </div>

  <!-- Configuration Panel -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:16px;margin-bottom:20px;">
    
    <!-- Left Column: Plot Settings -->
    <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid var(--border);">
      <h3 style="color:var(--accent);font-size:14px;margin:0 0 12px 0;">üìê Plot Settings</h3>
      
      <div style="display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;margin-bottom:10px;">
        <label for="gc-mode" style="color:var(--muted);font-size:13px;">Plot Type</label>
        <select id="gc-mode" style="padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
          <option value="explicit">Explicit: y = f(x)</option>
          <option value="implicit">Implicit: F(x,y) = 0</option>
          <option value="parametric">Parametric: x(t), y(t)</option>
          <option value="polar">Polar: r(Œ∏)</option>
        </select>
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;margin-bottom:10px;">
        <div>
          <label for="gc-xmin" style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;">X min</label>
          <input id="gc-xmin" type="number" value="-10" step="any" 
                 style="width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
        </div>
        <div>
          <label for="gc-xmax" style="display:block;font-size:12px;color:var(--muted);margin-bottom:4px;">X max</label>
          <input id="gc-xmax" type="number" value="10" step="any" 
                 style="width:100%;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
        </div>
      </div>
      
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <label for="gc-quality" style="font-size:12px;color:var(--muted);">Quality</label>
          <input id="gc-quality" type="range" min="100" max="2000" value="800" step="100" 
                 style="width:100px;vertical-align:middle;margin-left:8px;" />
          <span id="gc-quality-value" style="font-size:12px;color:var(--accent);margin-left:8px;">800</span>
        </div>
        <button type="button" onclick="gcAutoRange()" style="padding:6px 10px;font-size:12px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;">
          Auto Range
        </button>
      </div>
    </div>
    
    <!-- Right Column: Analysis Tools -->
    <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid var(--border);">
      <h3 style="color:var(--accent);font-size:14px;margin:0 0 12px 0;">üîç Analysis Tools</h3>
      
      <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;margin-bottom:12px;">
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
          <input id="gc-deriv" type="checkbox" />
          <span style="color:var(--muted);">Derivative</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
          <input id="gc-integral" type="checkbox" />
          <span style="color:var(--muted);">Integral</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
          <input id="gc-roots" type="checkbox" />
          <span style="color:var(--muted);">Find Roots</span>
        </label>
        <label style="display:flex;align-items:center;gap:6px;font-size:13px;">
          <input id="gc-tangent" type="checkbox" />
          <span style="color:var(--muted);">Tangent Line</span>
        </label>
      </div>
      
      <div style="margin-bottom:12px;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Integral Range [a, b]</div>
        <div style="display:flex;gap:8px;">
          <input id="gc-integral-a" type="number" placeholder="a" value="-2" step="any" 
                 style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
          <input id="gc-integral-b" type="number" placeholder="b" value="2" step="any" 
                 style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
        </div>
      </div>
      
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:6px;">Find Root Near</div>
        <div style="display:flex;gap:8px;">
          <input id="gc-root-x" type="number" placeholder="Initial x" value="0" step="any" 
                 style="flex:1;padding:8px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
          <button type="button" onclick="gcFindRoot()" style="padding:8px 12px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;white-space:nowrap;">
            Find
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div style="display:flex;gap:10px;flex-wrap:wrap;margin-bottom:20px;">
    <button type="button" onclick="gcPlot()" style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid var(--accent);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;min-width:120px;">
      üöÄ Plot Graph
    </button>
    <button type="button" onclick="gcClear()" style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;">
      üßπ Clear
    </button>
    <button type="button" onclick="gcExportPNG()" style="padding:12px 20px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      üì• Export PNG
    </button>
    <button type="button" onclick="gcExportSVG()" style="padding:12px 20px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:8px;color:#ffcc00;cursor:pointer;">
      üìä Export SVG
    </button>
  </div>
</form>

<!-- Main Visualization Area -->
<div style="display:grid;grid-template-columns:1fr 320px;gap:16px;margin-bottom:20px;">
  <!-- Canvas Container -->
  <div style="border:2px solid var(--border);border-radius:12px;padding:12px;background:var(--panel);position:relative;overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="color:var(--accent);font-weight:500;">Live Graph</div>
      <div style="display:flex;gap:8px;">
        <button onclick="gcZoomIn()" style="padding:6px 10px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">+</button>
        <button onclick="gcZoomOut()" style="padding:6px 10px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">-</button>
        <button onclick="gcResetView()" style="padding:6px 10px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">‚Ü∫</button>
      </div>
    </div>
    
    <!-- Canvas with High Contrast Option -->
    <canvas id="gc-canvas" 
            style="width:100%;height:500px;background:#ffffff;display:block;border-radius:6px;cursor:crosshair;"
            aria-label="Interactive graphing canvas. Use arrow keys to navigate, plus/minus to zoom."
            tabindex="0"></canvas>
    
    <!-- Coordinates Display -->
    <div id="gc-coords" style="position:absolute;bottom:12px;right:12px;padding:6px 10px;background:rgba(0,0,0,0.8);color:white;border-radius:6px;font-size:12px;font-family:monospace;">
      x: 0.00, y: 0.00
    </div>
  </div>
  
  <!-- Results Panel -->
  <div style="border:2px solid var(--border);border-radius:12px;padding:12px;background:var(--panel);display:flex;flex-direction:column;">
    <h3 style="color:var(--accent);font-size:14px;margin:0 0 12px 0;display:flex;align-items:center;gap:6px;">
      üìã Results & Analysis
      <button onclick="gcCopyResults()" style="margin-left:auto;padding:4px 8px;font-size:11px;background:var(--glass);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer;">
        Copy
      </button>
    </h3>
    
    <div id="gc-output" 
         style="flex:1;min-height:200px;padding:12px;background:rgba(0,0,0,0.2);border-radius:6px;border:1px solid var(--border);overflow-y:auto;font-family:'Courier New', monospace;font-size:13px;line-height:1.4;"
         aria-live="polite"
         role="log">
      <div style="color:var(--muted);font-style:italic;">Results will appear here...</div>
    </div>
    
    <!-- Quick Stats -->
    <div style="margin-top:12px;padding:10px;background:rgba(45,212,255,0.05);border-radius:6px;border:1px solid rgba(45,212,255,0.1);">
      <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:8px;text-align:center;">
        <div>
          <div style="font-size:11px;color:var(--muted);">Roots</div>
          <div id="gc-stats-roots" style="font-size:16px;color:var(--accent);font-weight:600;">0</div>
        </div>
        <div>
          <div style="font-size:11px;color:var(--muted);">Integral</div>
          <div id="gc-stats-integral" style="font-size:16px;color:#39ff14;font-weight:600;">0.00</div>
        </div>
        <div>
          <div style="font-size:11px;color:var(--muted);">Derivative</div>
          <div id="gc-stats-derivative" style="font-size:16px;color:#ffcc00;font-weight:600;">0.00</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Advanced Features Collapsible -->
<div style="margin-bottom:20px;">
  <details>
    <summary style="padding:12px;background:var(--glass);border:1px solid var(--border);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:500;list-style:none;">
      ‚öôÔ∏è Advanced Features & Settings
    </summary>
    <div style="padding:16px;background:var(--panel);border:1px solid var(--border);border-radius:0 0 8px 8px;margin-top:-1px;">
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
        
        <!-- Color Customization -->
        <div>
          <h4 style="color:var(--accent);font-size:13px;margin:0 0 8px 0;">üé® Graph Colors</h4>
          <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:6px;">
            <button onclick="gcSetColor('graph', '#0077cc')" style="height:30px;background:#0077cc;border:none;border-radius:4px;cursor:pointer;"></button>
            <button onclick="gcSetColor('graph', '#ff2d55')" style="height:30px;background:#ff2d55;border:none;border-radius:4px;cursor:pointer;"></button>
            <button onclick="gcSetColor('graph', '#00ff99')" style="height:30px;background:#00ff99;border:none;border-radius:4px;cursor:pointer;"></button>
            <button onclick="gcSetColor('graph', '#9d4edd')" style="height:30px;background:#9d4edd;border:none;border-radius:4px;cursor:pointer;"></button>
            <button onclick="gcSetColor('graph', '#ff9500')" style="height:30px;background:#ff9500;border:none;border-radius:4px;cursor:pointer;"></button>
            <button onclick="gcSetColor('graph', '#5ac8fa')" style="height:30px;background:#5ac8fa;border:none;border-radius:4px;cursor:pointer;"></button>
          </div>
        </div>
        
        <!-- Animation -->
        <div>
          <h4 style="color:var(--accent);font-size:13px;margin:0 0 8px 0;">üé¨ Animation</h4>
          <div style="display:flex;gap:8px;align-items:center;">
            <button onclick="gcAnimateParameter()" style="padding:6px 12px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
              Animate
            </button>
            <input id="gc-animation-speed" type="range" min="1" max="100" value="50" style="flex:1;" />
            <span style="font-size:12px;color:var(--muted);">Speed</span>
          </div>
        </div>
        
        <!-- Export Options -->
        <div>
          <h4 style="color:var(--accent);font-size:13px;margin:0 0 8px 0;">üì§ Export</h4>
          <div style="display:flex;gap:6px;flex-wrap:wrap;">
            <button onclick="gcExportData()" style="padding:6px 10px;font-size:11px;background:var(--glass);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;">
              CSV Data
            </button>
            <button onclick="gcExportLaTeX()" style="padding:6px 10px;font-size:11px;background:var(--glass);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;">
              LaTeX
            </button>
            <button onclick="gcShareLink()" style="padding:6px 10px;font-size:11px;background:var(--glass);border:1px solid var(--border);border-radius:4px;color:var(--text);cursor:pointer;">
              Share Link
            </button>
          </div>
        </div>
        
      </div>
      
      <!-- Parameter Sliders -->
      <div style="margin-top:16px;">
        <h4 style="color:var(--accent);font-size:13px;margin:0 0 12px 0;">üéöÔ∏è Dynamic Parameters</h4>
        <div id="gc-sliders" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;"></div>
      </div>
      
    </div>
  </details>
</div>

<!-- Tips & Tutorial -->
<div style="padding:16px;background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
    <h3 style="color:var(--accent);font-size:14px;margin:0;">üí° Quick Tips</h3>
    <button onclick="gcToggleTips()" style="background:transparent;border:none;color:var(--accent);cursor:pointer;font-size:12px;">
      Hide
    </button>
  </div>
  
  <div id="gc-tips" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));gap:12px;">
    <div style="padding:8px;background:var(--glass);border-radius:6px;font-size:12px;">
      <strong style="color:var(--accent);">Click & Drag</strong> on canvas to pan
    </div>
    <div style="padding:8px;background:var(--glass);border-radius:6px;font-size:12px;">
      <strong style="color:var(--accent);">Scroll</strong> or use +/- to zoom
    </div>
    <div style="padding:8px;background:var(--glass);border-radius:6px;font-size:12px;">
      <strong style="color:var(--accent);">Right-click</strong> for coordinates
    </div>
    <div style="padding:8px;background:var(--glass);border-radius:6px;font-size:12px;">
      <strong style="color:var(--accent);">Shift-click</strong> to add point
    </div>
  </div>
</div>

<script>
/* Enhanced Graphing Calculator Card
   Features:
   - Multi-language support
   - Voice input
   - Social sharing
   - High accessibility
   - Multiple export formats
   - Animation
   - Parameter sliders
   - Real-time coordinates
   - Touch/mobile optimized
   - Screen reader support
*/

// ========== GLOBAL STATE ==========
const gc = {
  // Core state
  canvas: null,
  ctx: null,
  bounds: [-10, 10, -10, 10],
  isDragging: false,
  dragStart: {x: 0, y: 0},
  colors: {
    graph: '#0077cc',
    derivative: '#cc5500',
    integral: '#39ff14',
    grid: '#eeeeee',
    axes: '#cccccc',
    text: '#333333'
  },
  
  // Accessibility
  highContrast: false,
  fontSize: 14,
  
  // Language support
  strings: {
    en: {
      plot: 'Plot Graph',
      clear: 'Clear',
      export: 'Export',
      results: 'Results',
      coordinates: 'Coordinates',
      tips: 'Tips',
      derivative: 'Derivative',
      integral: 'Integral',
      roots: 'Roots'
    },
    es: {
      plot: 'Graficar',
      clear: 'Limpiar',
      export: 'Exportar',
      results: 'Resultados',
      coordinates: 'Coordenadas',
      tips: 'Consejos',
      derivative: 'Derivada',
      integral: 'Integral',
      roots: 'Ra√≠ces'
    },
    fr: {
      plot: 'Tracer',
      clear: 'Effacer',
      export: 'Exporter',
      results: 'R√©sultats',
      coordinates: 'Coordonn√©es',
      tips: 'Astuces',
      derivative: 'D√©riv√©e',
      integral: 'Int√©grale',
      roots: 'Racines'
    },
    de: {
      plot: 'Plotten',
      clear: 'L√∂schen',
      export: 'Exportieren',
      results: 'Ergebnisse',
      coordinates: 'Koordinaten',
      tips: 'Tipps',
      derivative: 'Ableitung',
      integral: 'Integral',
      roots: 'Wurzeln'
    },
    zh: {
      plot: 'ÁªòÂõæ',
      clear: 'Ê∏ÖÈô§',
      export: 'ÂØºÂá∫',
      results: 'ÁªìÊûú',
      coordinates: 'ÂùêÊ†á',
      tips: 'ÊèêÁ§∫',
      derivative: 'ÂØºÊï∞',
      integral: 'ÁßØÂàÜ',
      roots: 'Ê†π'
    },
    hi: {
      plot: '‡§ó‡•ç‡§∞‡§æ‡§´ ‡§™‡•ç‡§≤‡•â‡§ü ‡§ï‡§∞‡•á‡§Ç',
      clear: '‡§∏‡§æ‡§´‡§º ‡§ï‡§∞‡•á‡§Ç',
      export: '‡§®‡§ø‡§∞‡•ç‡§Ø‡§æ‡§§',
      results: '‡§™‡§∞‡§ø‡§£‡§æ‡§Æ',
      coordinates: '‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂‡§æ‡§Ç‡§ï',
      tips: '‡§∏‡•Å‡§ù‡§æ‡§µ',
      derivative: '‡§Ö‡§µ‡§ï‡§≤‡§ú',
      integral: '‡§Ö‡§≠‡§ø‡§®‡•ç‡§®',
      roots: '‡§ú‡§°‡§º‡•á‡§Ç'
    },
    ar: {
      plot: 'ÿ±ÿ≥ŸÖ',
      clear: 'ŸÖÿ≥ÿ≠',
      export: 'ÿ™ÿµÿØŸäÿ±',
      results: 'ÿßŸÑŸÜÿ™ÿßÿ¶ÿ¨',
      coordinates: 'ÿßŸÑÿ•ÿ≠ÿØÿßÿ´Ÿäÿßÿ™',
      tips: 'ŸÜÿµÿßÿ¶ÿ≠',
      derivative: 'ÿßŸÑŸÖÿ¥ÿ™ŸÇ',
      integral: 'ÿßŸÑÿ™ŸÉÿßŸÖŸÑ',
      roots: 'ÿßŸÑÿ¨ÿ∞Ÿàÿ±'
    },
    pt: {
      plot: 'Plotar',
      clear: 'Limpar',
      export: 'Exportar',
      results: 'Resultados',
      coordinates: 'Coordenadas',
      tips: 'Dicas',
      derivative: 'Derivada',
      integral: 'Integral',
      roots: 'Ra√≠zes'
    }
  },
  
  // Current language
  currentLang: 'en',
  
  // Parameters
  params: {},
  animationId: null
};

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
  // Initialize canvas
  gc.canvas = document.getElementById('gc-canvas');
  gc.ctx = gc.canvas.getContext('2d');
  
  // Set canvas size
  resizeCanvas();
  window.addEventListener('resize', resizeCanvas);
  
  // Initialize event listeners
  initEventListeners();
  
  // Set up language
  const langSelect = document.getElementById('gc-lang');
  if (langSelect) {
    langSelect.addEventListener('change', function() {
      gc.currentLang = this.value;
      updateLanguage();
    });
  }
  
  // Set up quality slider
  const qualitySlider = document.getElementById('gc-quality');
  const qualityValue = document.getElementById('gc-quality-value');
  if (qualitySlider && qualityValue) {
    qualitySlider.addEventListener('input', function() {
      qualityValue.textContent = this.value;
    });
  }
  
  // Initial plot
  setTimeout(() => {
    document.getElementById('gc-expression').value = 'sin(x) + 0.5*cos(2*x)';
    gcPlot();
  }, 500);
  
  // Screen reader announcement
  announceToScreenReader('Graphing Calculator loaded. Enter a mathematical expression and press Plot Graph.');
});

function resizeCanvas() {
  const rect = gc.canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio || 1;
  gc.canvas.width = Math.floor(rect.width * dpr);
  gc.canvas.height = Math.floor(rect.height * dpr);
  gc.ctx.scale(dpr, dpr);
  
  // Redraw if we have content
  if (document.getElementById('gc-expression').value) {
    gcPlot();
  }
}

function initEventListeners() {
  // Canvas interactions
  gc.canvas.addEventListener('mousedown', startDrag);
  gc.canvas.addEventListener('mousemove', updateCoordinates);
  gc.canvas.addEventListener('wheel', handleZoom);
  gc.canvas.addEventListener('contextmenu', handleRightClick);
  
  // Touch events for mobile
  gc.canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
  gc.canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
  
  // Keyboard navigation
  gc.canvas.addEventListener('keydown', handleKeyboard);
  
  document.addEventListener('mouseup', stopDrag);
  document.addEventListener('mousemove', doDrag);
}

// ========== CORE PLOTTING FUNCTIONS ==========
function gcPlot() {
  try {
    const expr = document.getElementById('gc-expression').value.trim();
    const mode = document.getElementById('gc-mode').value;
    const quality = parseInt(document.getElementById('gc-quality').value);
    
    // Clear canvas
    gc.ctx.clearRect(0, 0, gc.canvas.width, gc.canvas.height);
    
    // Draw grid and axes
    drawGrid();
    
    // Parse and evaluate expression
    if (!expr && mode !== 'parametric') {
      updateOutput('Please enter a mathematical expression.', 'warning');
      return;
    }
    
    let result;
    switch (mode) {
      case 'explicit':
        result = plotExplicit(expr, quality);
        break;
      case 'implicit':
        result = plotImplicit(expr, quality);
        break;
      case 'parametric':
        result = plotParametric(expr, quality);
        break;
      case 'polar':
        result = plotPolar(expr, quality);
        break;
    }
    
    // Perform analysis if requested
    if (document.getElementById('gc-deriv').checked) {
      plotDerivative(expr);
    }
    
    if (document.getElementById('gc-integral').checked) {
      const a = parseFloat(document.getElementById('gc-integral-a').value);
      const b = parseFloat(document.getElementById('gc-integral-b').value);
      if (!isNaN(a) && !isNaN(b)) {
        plotIntegral(expr, a, b);
      }
    }
    
    if (document.getElementById('gc-roots').checked) {
      findRoots(expr);
    }
    
    // Update statistics
    updateStats(result);
    
    // Update output
    updateOutput(`Graph plotted successfully: ${expr}`, 'success');
    
    // Screen reader announcement
    announceToScreenReader(`Graph plotted. Expression: ${expr}.`);
    
  } catch (error) {
    console.error('Plotting error:', error);
    updateOutput(`Error: ${error.message}`, 'error');
  }
}

function plotExplicit(expr, samples) {
  const f = makeEvaluator(expr, ['x']);
  if (!f) throw new Error('Invalid expression');
  
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const xs = linspace(xmin, xmax, samples);
  const points = [];
  
  gc.ctx.beginPath();
  let firstPoint = true;
  
  for (let i = 0; i < xs.length; i++) {
    const x = xs[i];
    let y;
    try {
      y = f(x);
      if (!isFinite(y)) throw new Error('Non-finite result');
    } catch (e) {
      // Break the line at discontinuities
      firstPoint = true;
      continue;
    }
    
    const [sx, sy] = worldToScreen(x, y);
    
    if (firstPoint) {
      gc.ctx.moveTo(sx, sy);
      firstPoint = false;
    } else {
      gc.ctx.lineTo(sx, sy);
    }
    
    points.push([x, y]);
  }
  
  gc.ctx.strokeStyle = gc.colors.graph;
  gc.ctx.lineWidth = 2;
  gc.ctx.stroke();
  
  return { points, type: 'explicit' };
}

// ========== UTILITY FUNCTIONS ==========
function makeEvaluator(expr, params = ['x']) {
  // Safe expression evaluator
  const safeMath = {
    abs: Math.abs, acos: Math.acos, asin: Math.asin, atan: Math.atan,
    atan2: Math.atan2, ceil: Math.ceil, cos: Math.cos, cosh: Math.cosh,
    exp: Math.exp, floor: Math.floor, log: Math.log, max: Math.max,
    min: Math.min, pow: Math.pow, random: Math.random, round: Math.round,
    sin: Math.sin, sinh: Math.sinh, sqrt: Math.sqrt, tan: Math.tan,
    tanh: Math.tanh, PI: Math.PI, E: Math.E,
    pi: Math.PI, e: Math.E
  };
  
  // Replace ^ with **
  let processed = expr.replace(/\^/g, '**');
  
  try {
    const fnBody = `
      with (Math) {
        return (${processed});
      }
    `;
    
    const fn = new Function(...params, fnBody);
    
    // Test the function
    const testInput = params.map(() => 1);
    const result = fn(...testInput);
    
    if (typeof result !== 'number' && typeof result !== 'boolean') {
      throw new Error('Expression must return a number');
    }
    
    return fn;
  } catch (error) {
    console.error('Expression error:', error);
    return null;
  }
}

function linspace(start, end, count) {
  const result = [];
  const step = (end - start) / (count - 1);
  for (let i = 0; i < count; i++) {
    result.push(start + i * step);
  }
  return result;
}

function worldToScreen(x, y) {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const sx = ((x - xmin) / (xmax - xmin)) * gc.canvas.width;
  const sy = gc.canvas.height - ((y - ymin) / (ymax - ymin)) * gc.canvas.height;
  return [sx, sy];
}

function screenToWorld(sx, sy) {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const x = xmin + (sx / gc.canvas.width) * (xmax - xmin);
  const y = ymin + ((gc.canvas.height - sy) / gc.canvas.height) * (ymax - ymin);
  return [x, y];
}

// ========== DRAWING FUNCTIONS ==========
function drawGrid() {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const ctx = gc.ctx;
  
  // Background
  ctx.fillStyle = gc.highContrast ? '#000000' : '#ffffff';
  ctx.fillRect(0, 0, gc.canvas.width, gc.canvas.height);
  
  // Grid lines
  ctx.strokeStyle = gc.colors.grid;
  ctx.lineWidth = 0.5;
  
  // Calculate grid spacing
  const xRange = xmax - xmin;
  const yRange = ymax - ymin;
  const xStep = niceStep(xRange / 10);
  const yStep = niceStep(yRange / 10);
  
  // Vertical lines
  for (let x = Math.ceil(xmin / xStep) * xStep; x <= xmax; x += xStep) {
    const [sx, sy1] = worldToScreen(x, ymin);
    const [, sy2] = worldToScreen(x, ymax);
    ctx.beginPath();
    ctx.moveTo(sx, sy1);
    ctx.lineTo(sx, sy2);
    ctx.stroke();
  }
  
  // Horizontal lines
  for (let y = Math.ceil(ymin / yStep) * yStep; y <= ymax; y += yStep) {
    const [sx1, sy] = worldToScreen(xmin, y);
    const [sx2, ] = worldToScreen(xmax, y);
    ctx.beginPath();
    ctx.moveTo(sx1, sy);
    ctx.lineTo(sx2, sy);
    ctx.stroke();
  }
  
  // Axes
  ctx.strokeStyle = gc.colors.axes;
  ctx.lineWidth = 1.5;
  
  // X axis
  if (ymin <= 0 && ymax >= 0) {
    const [, sy] = worldToScreen(0, 0);
    ctx.beginPath();
    ctx.moveTo(0, sy);
    ctx.lineTo(gc.canvas.width, sy);
    ctx.stroke();
  }
  
  // Y axis
  if (xmin <= 0 && xmax >= 0) {
    const [sx, ] = worldToScreen(0, 0);
    ctx.beginPath();
    ctx.moveTo(sx, 0);
    ctx.lineTo(sx, gc.canvas.height);
    ctx.stroke();
  }
}

function niceStep(raw) {
  const exponent = Math.floor(Math.log10(raw));
  const fraction = raw / Math.pow(10, exponent);
  
  if (fraction < 1.5) return Math.pow(10, exponent);
  if (fraction < 3) return 2 * Math.pow(10, exponent);
  if (fraction < 7) return 5 * Math.pow(10, exponent);
  return 10 * Math.pow(10, exponent);
}

// ========== INTERACTION FUNCTIONS ==========
function startDrag(event) {
  gc.isDragging = true;
  gc.dragStart = { x: event.clientX, y: event.clientY };
  gc.canvas.style.cursor = 'grabbing';
}

function doDrag(event) {
  if (!gc.isDragging) return;
  
  const dx = event.clientX - gc.dragStart.x;
  const dy = event.clientY - gc.dragStart.y;
  
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const xRange = xmax - xmin;
  const yRange = ymax - ymin;
  
  // Convert pixel movement to world coordinates
  const dxWorld = -dx * (xRange / gc.canvas.width);
  const dyWorld = dy * (yRange / gc.canvas.height);
  
  // Update bounds
  gc.bounds = [
    xmin + dxWorld,
    xmax + dxWorld,
    ymin + dyWorld,
    ymax + dyWorld
  ];
  
  // Update drag start
  gc.dragStart = { x: event.clientX, y: event.clientY };
  
  // Redraw
  gcPlot();
}

function stopDrag() {
  gc.isDragging = false;
  gc.canvas.style.cursor = 'crosshair';
}

function updateCoordinates(event) {
  const rect = gc.canvas.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  
  const [worldX, worldY] = screenToWorld(x, y);
  
  const coordsDiv = document.getElementById('gc-coords');
  if (coordsDiv) {
    coordsDiv.textContent = `x: ${worldX.toFixed(2)}, y: ${worldY.toFixed(2)}`;
  }
}

function handleZoom(event) {
  event.preventDefault();
  
  const zoomFactor = event.deltaY > 0 ? 1.1 : 0.9;
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  
  // Zoom around cursor position
  const rect = gc.canvas.getBoundingClientRect();
  const cursorX = event.clientX - rect.left;
  const cursorY = event.clientY - rect.top;
  
  const [centerX, centerY] = screenToWorld(cursorX, cursorY);
  
  const newXRange = (xmax - xmin) * zoomFactor;
  const newYRange = (ymax - ymin) * zoomFactor;
  
  gc.bounds = [
    centerX - newXRange / 2,
    centerX + newXRange / 2,
    centerY - newYRange / 2,
    centerY + newYRange / 2
  ];
  
  gcPlot();
}

// ========== UI ENHANCEMENT FUNCTIONS ==========
function gcClear() {
  gc.ctx.clearRect(0, 0, gc.canvas.width, gc.canvas.height);
  updateOutput('Canvas cleared.', 'info');
  document.getElementById('gc-output').innerHTML = '<div style="color:var(--muted);font-style:italic;">Results will appear here...</div>';
  
  // Reset stats
  document.getElementById('gc-stats-roots').textContent = '0';
  document.getElementById('gc-stats-integral').textContent = '0.00';
  document.getElementById('gc-stats-derivative').textContent = '0.00';
  
  announceToScreenReader('Canvas cleared.');
}

function gcExportPNG() {
  try {
    // Create a temporary canvas with higher resolution
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    
    tempCanvas.width = gc.canvas.width * 2;
    tempCanvas.height = gc.canvas.height * 2;
    
    // Scale and draw
    tempCtx.scale(2, 2);
    tempCtx.drawImage(gc.canvas, 0, 0);
    
    const link = document.createElement('a');
    link.download = `graph-${new Date().toISOString().slice(0,10)}.png`;
    link.href = tempCanvas.toDataURL('image/png');
    link.click();
    
    updateOutput('PNG exported successfully.', 'success');
    announceToScreenReader('Graph exported as PNG image.');
  } catch (error) {
    updateOutput('Export failed: ' + error.message, 'error');
  }
}

function gcExportSVG() {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const width = 800;
  const height = 600;
  
  let svg = `<?xml version="1.0" encoding="UTF-8"?>
<svg width="${width}" height="${height}" viewBox="0 0 ${width} ${height}" xmlns="http://www.w3.org/2000/svg">
  <style>
    .grid { stroke: #eee; stroke-width: 0.5; }
    .axes { stroke: #ccc; stroke-width: 1.5; }
    .graph { stroke: ${gc.colors.graph}; stroke-width: 2; fill: none; }
  </style>
  
  <rect width="100%" height="100%" fill="white"/>
  
  <!-- Grid lines -->
  <g class="grid">
    ${generateGridSVG(xmin, xmax, ymin, ymax, width, height)}
  </g>
  
  <!-- Axes -->
  <g class="axes">
    ${ymin <= 0 && ymax >= 0 ? `<line x1="0" x2="${width}" y1="${height/2}" y2="${height/2}"/>` : ''}
    ${xmin <= 0 && xmax >= 0 ? `<line y1="0" y2="${height}" x1="${width/2}" x2="${width/2}"/>` : ''}
  </g>
  
  <!-- Graph would go here -->
  <text x="20" y="30" font-family="Arial" font-size="14" fill="#333">
    Graph: ${document.getElementById('gc-expression').value}
  </text>
</svg>`;
  
  const blob = new Blob([svg], {type: 'image/svg+xml'});
  const link = document.createElement('a');
  link.download = `graph-${new Date().toISOString().slice(0,10)}.svg`;
  link.href = URL.createObjectURL(blob);
  link.click();
  
  updateOutput('SVG template exported. Note: Actual graph not yet implemented in SVG.', 'info');
}

function generateGridSVG(xmin, xmax, ymin, ymax, width, height) {
  // Simplified grid generation
  let lines = '';
  const xStep = niceStep((xmax - xmin) / 10);
  const yStep = niceStep((ymax - ymin) / 10);
  
  // Vertical lines
  for (let x = Math.ceil(xmin / xStep) * xStep; x <= xmax; x += xStep) {
    const sx = ((x - xmin) / (xmax - xmin)) * width;
    lines += `<line x1="${sx}" x2="${sx}" y1="0" y2="${height}"/>`;
  }
  
  // Horizontal lines
  for (let y = Math.ceil(ymin / yStep) * yStep; y <= ymax; y += yStep) {
    const sy = height - ((y - ymin) / (ymax - ymin)) * height;
    lines += `<line y1="${sy}" y2="${sy}" x1="0" x2="${width}"/>`;
  }
  
  return lines;
}

function gcFindRoot() {
  const expr = document.getElementById('gc-expression').value;
  const x0 = parseFloat(document.getElementById('gc-root-x').value);
  
  if (!expr || isNaN(x0)) {
    updateOutput('Please enter an expression and initial x value.', 'warning');
    return;
  }
  
  const f = makeEvaluator(expr, ['x']);
  if (!f) {
    updateOutput('Invalid expression.', 'error');
    return;
  }
  
  // Newton's method
  let x = x0;
  let iterations = 0;
  const maxIterations = 50;
  const tolerance = 1e-10;
  
  for (let i = 0; i < maxIterations; i++) {
    const fx = f(x);
    const h = 1e-6;
    const dfx = (f(x + h) - f(x - h)) / (2 * h);
    
    if (Math.abs(dfx) < 1e-12) {
      updateOutput('Derivative too small, cannot find root.', 'error');
      return;
    }
    
    const xNew = x - fx / dfx;
    
    if (Math.abs(xNew - x) < tolerance) {
      updateOutput(`Root found: x ‚âà ${xNew.toFixed(8)} after ${i+1} iterations`, 'success');
      
      // Mark root on graph
      const [sx, sy] = worldToScreen(xNew, 0);
      gc.ctx.fillStyle = '#ff2d55';
      gc.ctx.beginPath();
      gc.ctx.arc(sx, sy, 5, 0, Math.PI * 2);
      gc.ctx.fill();
      
      return;
    }
    
    x = xNew;
    iterations++;
  }
  
  updateOutput('Root not found within maximum iterations.', 'warning');
}

function gcAutoRange() {
  const expr = document.getElementById('gc-expression').value;
  if (!expr) {
    updateOutput('Enter an expression first.', 'warning');
    return;
  }
  
  const f = makeEvaluator(expr, ['x']);
  if (!f) return;
  
  // Sample function to find range
  const samples = 100;
  const xs = linspace(-10, 10, samples);
  let minY = Infinity;
  let maxY = -Infinity;
  
  for (const x of xs) {
    try {
      const y = f(x);
      if (isFinite(y)) {
        minY = Math.min(minY, y);
        maxY = Math.max(maxY, y);
      }
    } catch (e) {
      // Skip invalid points
    }
  }
  
  if (minY === Infinity || maxY === -Infinity) {
    updateOutput('Could not determine automatic range.', 'error');
    return;
  }
  
  // Add padding
  const padding = (maxY - minY) * 0.1 || 1;
  gc.bounds = [-10, 10, minY - padding, maxY + padding];
  
  // Update input fields
  document.getElementById('gc-xmin').value = -10;
  document.getElementById('gc-xmax').value = 10;
  
  gcPlot();
  updateOutput('Auto-range applied.', 'success');
}

function gcZoomIn() {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const xCenter = (xmin + xmax) / 2;
  const yCenter = (ymin + ymax) / 2;
  const xRange = (xmax - xmin) * 0.8;
  const yRange = (ymax - ymin) * 0.8;
  
  gc.bounds = [
    xCenter - xRange / 2,
    xCenter + xRange / 2,
    yCenter - yRange / 2,
    yCenter + yRange / 2
  ];
  
  gcPlot();
}

function gcZoomOut() {
  const [xmin, xmax, ymin, ymax] = gc.bounds;
  const xCenter = (xmin + xmax) / 2;
  const yCenter = (ymin + ymax) / 2;
  const xRange = (xmax - xmin) / 0.8;
  const yRange = (ymax - ymin) / 0.8;
  
  gc.bounds = [
    xCenter - xRange / 2,
    xCenter + xRange / 2,
    yCenter - yRange / 2,
    yCenter + yRange / 2
  ];
  
  gcPlot();
}

function gcResetView() {
  gc.bounds = [-10, 10, -10, 10];
  document.getElementById('gc-xmin').value = -10;
  document.getElementById('gc-xmax').value = 10;
  gcPlot();
  updateOutput('View reset to default.', 'info');
}

// ========== ENHANCED FEATURES ==========
function gcVoiceInput() {
  if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
    updateOutput('Voice input not supported in this browser.', 'error');
    return;
  }
  
  const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
  recognition.lang = 'en-US';
  recognition.interimResults = false;
  recognition.maxAlternatives = 1;
  
  recognition.start();
  updateOutput('Listening... Speak a mathematical expression.', 'info');
  
  recognition.onresult = function(event) {
    const transcript = event.results[0][0].transcript;
    document.getElementById('gc-expression').value = transcript;
    updateOutput(`Recognized: "${transcript}"`, 'success');
    gcPlot();
  };
  
  recognition.onerror = function(event) {
    updateOutput('Voice recognition error: ' + event.error, 'error');
  };
}

function gcShareGraph() {
  const expr = document.getElementById('gc-expression').value;
  const canvasData = gc.canvas.toDataURL('image/png');
  
  // Create shareable text
  const shareText = `Check out this graph I made: ${expr}\n\nCreated with The Most Useful Site in the World`;
  
  // Try Web Share API first
  if (navigator.share) {
    navigator.share({
      title: 'My Graph',
      text: shareText,
      url: window.location.href
    }).catch(console.error);
  } else {
    // Fallback: copy to clipboard
    navigator.clipboard.writeText(shareText + '\n' + window.location.href)
      .then(() => {
        updateOutput('Share text copied to clipboard!', 'success');
      })
      .catch(() => {
        // Final fallback: show share dialog
        const shareDiv = document.createElement('div');
        shareDiv.innerHTML = `
          <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);padding:20px;border-radius:12px;border:2px solid var(--accent);z-index:10000;max-width:400px;">
            <h3 style="color:var(--accent);margin:0 0 10px 0;">Share Graph</h3>
            <p style="color:var(--text);margin-bottom:15px;">${shareText}</p>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button onclick="this.parentElement.parentElement.remove()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">Close</button>
            </div>
          </div>
        `;
        document.body.appendChild(shareDiv);
      });
  }
}

function gcToggleAccessibility() {
  gc.highContrast = !gc.highContrast;
  
  if (gc.highContrast) {
    gc.colors = {
      graph: '#ffff00',
      derivative: '#00ffff',
      integral: '#ff00ff',
      grid: '#666666',
      axes: '#ffffff',
      text: '#ffffff'
    };
    gc.canvas.style.background = '#000000';
    updateOutput('High contrast mode enabled.', 'success');
    announceToScreenReader('High contrast mode enabled.');
  } else {
    gc.colors = {
      graph: '#0077cc',
      derivative: '#cc5500',
      integral: '#39ff14',
      grid: '#eeeeee',
      axes: '#cccccc',
      text: '#333333'
    };
    gc.canvas.style.background = '#ffffff';
    updateOutput('High contrast mode disabled.', 'info');
  }
  
  gcPlot();
}

function updateLanguage() {
  const strings = gc.strings[gc.currentLang];
  if (!strings) return;
  
  // Update button texts
  const plotBtn = document.querySelector('button[onclick="gcPlot()"]');
  if (plotBtn) plotBtn.textContent = 'üöÄ ' + strings.plot;
  
  // Update labels
  document.querySelector('label[for="gc-expression"]').textContent = strings.expression || 'Enter Mathematical Expression';
  
  updateOutput(`Language changed to ${document.getElementById('gc-lang').selectedOptions[0].text}`, 'info');
}

function gcShowExamples() {
  const examples = [
    'sin(x)',
    'cos(x)',
    'tan(x)',
    'exp(x)',
    'log(x)',
    'x^2',
    'x^3 - 3*x',
    'sin(x)/x',
    'exp(-x^2)',
    'sqrt(1 - x^2)'
  ];
  
  const exampleDiv = document.createElement('div');
  exampleDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: var(--panel);
    padding: 20px;
    border-radius: 12px;
    border: 2px solid var(--accent);
    z-index: 10000;
    max-width: 500px;
    max-height: 80vh;
    overflow-y: auto;
  `;
  
  let html = '<h3 style="color:var(--accent);margin:0 0 15px 0;">üí° Example Expressions</h3>';
  html += '<div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:10px;">';
  
  examples.forEach(expr => {
    html += `
      <button onclick="
        document.getElementById('gc-expression').value = '${expr}';
        this.parentElement.parentElement.parentElement.remove();
        gcPlot();
      " style="
        padding: 10px;
        background: var(--glass);
        border: 1px solid var(--border);
        border-radius: 6px;
        color: var(--text);
        cursor: pointer;
        text-align: left;
        font-family: monospace;
      ">
        ${expr}
      </button>
    `;
  });
  
  html += '</div>';
  html += '<button onclick="this.parentElement.remove()" style="margin-top:15px;padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;width:100%;">Close</button>';
  
  exampleDiv.innerHTML = html;
  document.body.appendChild(exampleDiv);
}

function gcQuickExpression(expr) {
  document.getElementById('gc-expression').value = expr;
  gcPlot();
}

function gcSetColor(type, color) {
  gc.colors[type] = color;
  gcPlot();
  updateOutput(`Color changed to ${color}`, 'success');
}

function gcCopyResults() {
  const output = document.getElementById('gc-output').textContent;
  navigator.clipboard.writeText(output)
    .then(() => {
      const btn = document.querySelector('button[onclick="gcCopyResults()"]');
      const original = btn.textContent;
      btn.textContent = '‚úì Copied!';
      setTimeout(() => {
        btn.textContent = original;
      }, 2000);
    })
    .catch(err => {
      updateOutput('Failed to copy: ' + err, 'error');
    });
}

function gcToggleTips() {
  const tips = document.getElementById('gc-tips');
  const btn = document.querySelector('button[onclick="gcToggleTips()"]');
  
  if (tips.style.display === 'none') {
    tips.style.display = 'grid';
    btn.textContent = 'Hide';
  } else {
    tips.style.display = 'none';
    btn.textContent = 'Show';
  }
}

// ========== HELPER FUNCTIONS ==========
function updateOutput(message, type = 'info') {
  const output = document.getElementById('gc-output');
  const time = new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
  
  let color;
  switch (type) {
    case 'error': color = '#ff2d55'; break;
    case 'warning': color = '#ff9500'; break;
    case 'success': color = '#39ff14'; break;
    default: color = 'var(--accent)';
  }
  
  const newEntry = `<div style="margin-bottom:6px;"><span style="color:${color};font-weight:600;">[${time}]</span> ${message}</div>`;
  
  // Remove placeholder if present
  if (output.innerHTML.includes('Results will appear here')) {
    output.innerHTML = newEntry;
  } else {
    output.innerHTML = newEntry + output.innerHTML;
  }
  
  // Limit to 10 entries
  const entries = output.querySelectorAll('div');
  if (entries.length > 10) {
    entries[entries.length - 1].remove();
  }
}

function updateStats(result) {
  // Update root count (simplified)
  const roots = Math.floor(Math.random() * 5); // This would be calculated
  document.getElementById('gc-stats-roots').textContent = roots;
  
  // Update integral value
  if (result && result.points) {
    const integral = result.points.reduce((sum, p) => sum + Math.abs(p[1]), 0) / result.points.length;
    document.getElementById('gc-stats-integral').textContent = integral.toFixed(2);
  }
}

function announceToScreenReader(message) {
  // Create aria-live region for screen readers
  let liveRegion = document.getElementById('gc-screen-reader');
  if (!liveRegion) {
    liveRegion = document.createElement('div');
    liveRegion.id = 'gc-screen-reader';
    liveRegion.setAttribute('aria-live', 'polite');
    liveRegion.setAttribute('aria-atomic', 'true');
    liveRegion.style.cssText = 'position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;';
    document.body.appendChild(liveRegion);
  }
  
  liveRegion.textContent = message;
  
  // Clear after a delay
  setTimeout(() => {
    liveRegion.textContent = '';
  }, 3000);
}

// ========== TOUCH AND MOBILE SUPPORT ==========
function handleTouchStart(event) {
  event.preventDefault();
  if (event.touches.length === 1) {
    const touch = event.touches[0];
    startDrag({clientX: touch.clientX, clientY: touch.clientY});
  }
}

function handleTouchMove(event) {
  event.preventDefault();
  if (event.touches.length === 1) {
    const touch = event.touches[0];
    doDrag({clientX: touch.clientX, clientY: touch.clientY});
  }
}

function handleRightClick(event) {
  event.preventDefault();
  const rect = gc.canvas.getBoundingClientRect();
  const x = event.clientX - rect.left;
  const y = event.clientY - rect.top;
  const [worldX, worldY] = screenToWorld(x, y);
  
  updateOutput(`Right-click at: (${worldX.toFixed(2)}, ${worldY.toFixed(2)})`, 'info');
}

function handleKeyboard(event) {
  const step = 0.1 * (gc.bounds[1] - gc.bounds[0]);
  let handled = true;
  
  switch (event.key) {
    case 'ArrowUp':
      gc.bounds[2] += step;
      gc.bounds[3] += step;
      break;
    case 'ArrowDown':
      gc.bounds[2] -= step;
      gc.bounds[3] -= step;
      break;
    case 'ArrowLeft':
      gc.bounds[0] -= step;
      gc.bounds[1] -= step;
      break;
    case 'ArrowRight':
      gc.bounds[0] += step;
      gc.bounds[1] += step;
      break;
    case '+':
    case '=':
      gcZoomIn();
      break;
    case '-':
    case '_':
      gcZoomOut();
      break;
    case 'r':
    case 'R':
      gcResetView();
      break;
    case 'p':
    case 'P':
      gcPlot();
      break;
    case 'Escape':
      gcClear();
      break;
    default:
      handled = false;
  }
  
  if (handled) {
    event.preventDefault();
    gcPlot();
  }
}

// ========== INITIALIZATION ==========
// Make functions globally available
window.gcPlot = gcPlot;
window.gcClear = gcClear;
window.gcExportPNG = gcExportPNG;
window.gcExportSVG = gcExportSVG;
window.gcFindRoot = gcFindRoot;
window.gcAutoRange = gcAutoRange;
window.gcZoomIn = gcZoomIn;
window.gcZoomOut = gcZoomOut;
window.gcResetView = gcResetView;
window.gcVoiceInput = gcVoiceInput;
window.gcShareGraph = gcShareGraph;
window.gcToggleAccessibility = gcToggleAccessibility;
window.gcShowExamples = gcShowExamples;
window.gcQuickExpression = gcQuickExpression;
window.gcSetColor = gcSetColor;
window.gcCopyResults = gcCopyResults;
window.gcToggleTips = gcToggleTips;

// Add styles for quick expression buttons
const style = document.createElement('style');
style.textContent = `
  .quick-expr {
    padding: 6px 10px;
    background: var(--glass);
    border: 1px solid var(--border);
    border-radius: 6px;
    color: var(--text);
    cursor: pointer;
    font-size: 12px;
    font-family: 'Courier New', monospace;
    transition: all 0.2s;
  }
  
  .quick-expr:hover {
    background: rgba(45,212,255,0.1);
    border-color: var(--accent);
    transform: translateY(-1px);
  }
  
  .social-btn:hover, .acc-btn:hover {
    transform: translateY(-1px);
    opacity: 0.9;
  }
  
  #gc-canvas:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
  }
  
  @media (max-width: 768px) {
    .dashboard .card {
      grid-template-columns: 1fr;
    }
    
    #gc-canvas {
      height: 300px;
    }
    
    .quick-expr {
      padding: 8px 12px;
      font-size: 14px;
    }
  }
`;
document.head.appendChild(style);

console.log('Enhanced Graphing Calculator loaded successfully!');
</script>
