<!-- cards/body-fat-calculator.html -->
<div class="card-content">
<h2 id="body-fat-calculator-title" style="margin-top:0;color:var(--accent);position:relative;">
  üèãÔ∏è Body Fat Percentage Calculator
  <span style="position:absolute;right:0;top:0;font-size:0.7rem;color:rgba(45,212,255,0.7);font-weight:normal;">
    Health & Fitness
  </span>
</h2>

<form aria-describedby="body-fat-calculator-desc">
  <p id="body-fat-calculator-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.9);">
    Estimate your body fat percentage using the U.S. Navy method and understand your fitness level.
  </p>

  <!-- Gender Selection with Visual Indicators -->
  <div style="margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <label style="color:var(--accent);font-weight:500;">üë§ Select Gender</label>
      <span id="bf-gender-indicator" style="font-size:0.9rem;color:#2dd4ff;font-weight:500;">Male</span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <button type="button" id="bf-male-btn" onclick="bfSetGender('male')" 
              style="padding:14px;border-radius:10px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;">
        üë® Male
      </button>
      <button type="button" id="bf-female-btn" onclick="bfSetGender('female')"
              style="padding:14px;border-radius:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;transition:all 0.2s;">
        üë© Female
      </button>
    </div>
  </div>

  <!-- Measurement Inputs -->
  <div style="background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:16px;">
      <!-- Weight -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="bf-weight" style="color:var(--accent);font-weight:500;">‚öñÔ∏è Weight</label>
          <span id="bf-weight-unit" style="font-size:0.9rem;color:rgba(230,250,255,0.7);">kg</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="bf-weight" type="number" min="30" max="200" value="70" 
                 style="flex:1;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button type="button" onclick="bfAdjustValue('weight', 1)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">+1</button>
            <button type="button" onclick="bfAdjustValue('weight', -1)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">-1</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>30kg</span>
          <span>200kg</span>
        </div>
      </div>

      <!-- Height -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="bf-height" style="color:var(--accent);font-weight:500;">üìè Height</label>
          <span id="bf-height-unit" style="font-size:0.9rem;color:rgba(230,250,255,0.7);">cm</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="bf-height" type="number" min="100" max="250" value="175" 
                 style="flex:1;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button type="button" onclick="bfAdjustValue('height', 1)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">+1</button>
            <button type="button" onclick="bfAdjustValue('height', -1)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">-1</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>100cm</span>
          <span>250cm</span>
        </div>
      </div>
    </div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
      <!-- Waist -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="bf-waist" style="color:var(--accent);font-weight:500;">üìê Waist</label>
          <span id="bf-waist-unit" style="font-size:0.9rem;color:rgba(230,250,255,0.7);">cm</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="bf-waist" type="number" min="50" max="150" value="80" 
                 style="flex:1;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button type="button" onclick="bfAdjustValue('waist', 0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">+0.5</button>
            <button type="button" onclick="bfAdjustValue('waist', -0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">-0.5</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>50cm</span>
          <span>150cm</span>
        </div>
      </div>

      <!-- Neck -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="bf-neck" style="color:var(--accent);font-weight:500;">üìè Neck</label>
          <span id="bf-neck-unit" style="font-size:0.9rem;color:rgba(230,250,255,0.7);">cm</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="bf-neck" type="number" min="25" max="60" value="38" 
                 style="flex:1;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button type="button" onclick="bfAdjustValue('neck', 0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">+0.5</button>
            <button type="button" onclick="bfAdjustValue('neck', -0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">-0.5</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>25cm</span>
          <span>60cm</span>
        </div>
      </div>

      <!-- Hip (Female Only) -->
      <div class="field" id="bf-hip-section" style="position:relative;display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="bf-hip" style="color:var(--accent);font-weight:500;">üéÄ Hip</label>
          <span style="font-size:0.9rem;color:rgba(230,250,255,0.7);">cm (females only)</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="bf-hip" type="number" min="60" max="150" value="90" 
                 style="flex:1;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
          <div style="display:flex;flex-direction:column;gap:4px;">
            <button type="button" onclick="bfAdjustValue('hip', 0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">+0.5</button>
            <button type="button" onclick="bfAdjustValue('hip', -0.5)" style="padding:6px 12px;border-radius:6px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);cursor:pointer;">-0.5</button>
          </div>
        </div>
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>60cm</span>
          <span>150cm</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Measurement Help -->
  <div style="margin-bottom:20px;padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
      <span style="color:var(--accent);font-weight:500;">üìù Measurement Guide</span>
      <button onclick="bfToggleGuide()" style="margin-left:auto;padding:4px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.85rem;">
        Show Guide
      </button>
    </div>
    <div id="bf-measurement-guide" style="display:none;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:12px;">
        <div>
          <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">Waist</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">At narrowest point, relax</div>
        </div>
        <div>
          <div style="color:#ffcc00;font-weight:600;margin-bottom:4px;">Neck</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Below Adam's apple</div>
        </div>
        <div>
          <div style="color:#9d4edd;font-weight:600;margin-bottom:4px;">Hip</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Widest point for females</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;margin-top:20px;">
    <button type="button" onclick="bfCalculate()" 
            style="padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;transition:all 0.2s;">
      üßÆ Calculate
    </button>
    <button type="button" onclick="bfSetDefaults()"
            style="padding:14px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      üìä Set Averages
    </button>
    <button type="button" onclick="bfCopyResults()"
            style="padding:14px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);color:#ffcc00;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      üìã Copy Results
    </button>
    <button type="button" onclick="bfReset()"
            style="padding:14px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      üîÑ Reset All
    </button>
  </div>
</form>

<!-- Results Display -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <!-- Main Results Card -->
  <div id="bf-results-section" style="display:none;background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:8px;padding:24px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 style="color:var(--accent);margin:0;font-size:1.1rem;">üìä Your Body Composition</h3>
      <button onclick="bfSaveResults()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.9rem;">
        üíæ Save Results
      </button>
    </div>
    
    <!-- Body Fat Percentage with Visual Scale -->
    <div style="margin-bottom:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);">Body Fat Percentage</div>
          <div id="bf-percentage" style="font-size:2.5rem;font-weight:800;color:#39ff14;line-height:1;">0.0%</div>
        </div>
        <div id="bf-category" style="padding:8px 16px;border-radius:20px;background:rgba(45,212,255,0.1);color:var(--accent);font-weight:600;font-size:0.9rem;">
          Category
        </div>
      </div>
      
      <!-- Body Fat Scale Visualization -->
      <div style="margin-bottom:12px;">
        <div style="height:24px;background:linear-gradient(90deg, #39ff14, #ffcc00, #ff2d55);border-radius:12px;position:relative;margin-bottom:8px;">
          <div id="bf-scale-marker" style="position:absolute;top:-4px;width:4px;height:32px;background:white;border-radius:2px;box-shadow:0 0 8px rgba(255,255,255,0.8);"></div>
        </div>
        <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:rgba(230,250,255,0.7);">
          <span>Essential</span>
          <span>Athlete</span>
          <span>Fitness</span>
          <span>Average</span>
          <span>Obese</span>
        </div>
      </div>
      
      <!-- Category Description -->
      <div id="bf-category-desc" style="padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;font-size:0.9rem;color:rgba(230,250,255,0.9);">
        Enter your measurements to see category description.
      </div>
    </div>
    
    <!-- Detailed Metrics -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">üìà Detailed Analysis</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(160px, 1fr));gap:16px;">
        <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">Fat Mass</div>
          <div id="bf-fat-mass" style="font-size:1.8rem;font-weight:700;color:#ff2d55;">0.0 kg</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Total body fat</div>
        </div>
        
        <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">Lean Mass</div>
          <div id="bf-lean-mass" style="font-size:1.8rem;font-weight:700;color:#39ff14;">0.0 kg</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Muscle & bone</div>
        </div>
        
        <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">BMI</div>
          <div id="bf-bmi" style="font-size:1.8rem;font-weight:700;color:#ffcc00;">0.0</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Body Mass Index</div>
        </div>
        
        <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">W/H Ratio</div>
          <div id="bf-wh-ratio" style="font-size:1.8rem;font-weight:700;color:#9d4edd;">0.0</div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Waist to Height</div>
        </div>
      </div>
    </div>
    
    <!-- Health Recommendations -->
    <div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">üí° Health Recommendations</div>
      <div id="bf-recommendations" style="padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border-left:4px solid var(--accent);">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);line-height:1.5;">
          Enter your measurements to receive personalized health recommendations.
        </div>
      </div>
    </div>
  </div>

  <!-- Body Fat Categories Guide -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">üìã Body Fat Categories</h3>
    
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
        <thead>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
            <th style="text-align:left;padding:12px;color:var(--accent);">Category</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Men</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Women</th>
            <th style="text-align:left;padding:12px;color:var(--accent);">Description</th>
          </tr>
        </thead>
        <tbody>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:12px;"><span style="color:#39ff14;font-weight:600;">Essential Fat</span></td>
            <td style="padding:12px;text-align:center;color:#39ff14;">2-5%</td>
            <td style="padding:12px;text-align:center;color:#39ff14;">10-13%</td>
            <td style="padding:12px;color:rgba(230,250,255,0.9);">Minimum for basic physiological function</td>
          </tr>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:12px;"><span style="color:#2dd4ff;font-weight:600;">Athletes</span></td>
            <td style="padding:12px;text-align:center;color:#2dd4ff;">6-13%</td>
            <td style="padding:12px;text-align:center;color:#2dd4ff;">14-20%</td>
            <td style="padding:12px;color:rgba(230,250,255,0.9);">Typical for athletes, very fit individuals</td>
          </tr>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:12px;"><span style="color:#ffcc00;font-weight:600;">Fitness</span></td>
            <td style="padding:12px;text-align:center;color:#ffcc00;">14-17%</td>
            <td style="padding:12px;text-align:center;color:#ffcc00;">21-24%</td>
            <td style="padding:12px;color:rgba(230,250,255,0.9);">Fit and healthy, moderate fitness level</td>
          </tr>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
            <td style="padding:12px;"><span style="color:#ffa500;font-weight:600;">Average</span></td>
            <td style="padding:12px;text-align:center;color:#ffa500;">18-24%</td>
            <td style="padding:12px;text-align:center;color:#ffa500;">25-31%</td>
            <td style="padding:12px;color:rgba(230,250,255,0.9);">Average for general population</td>
          </tr>
          <tr>
            <td style="padding:12px;"><span style="color:#ff2d55;font-weight:600;">Obese</span></td>
            <td style="padding:12px;text-align:center;color:#ff2d55;">25%+</td>
            <td style="padding:12px;text-align:center;color:#ff2d55;">32%+</td>
            <td style="padding:12px;color:rgba(230,250,255,0.9);">Increased health risks, consider reduction</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Health Tips & Information -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">üí° Health & Fitness Tips</h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">
      <div style="padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;">
        <div style="color:#39ff14;font-weight:600;margin-bottom:8px;">üèÉ‚Äç‚ôÇÔ∏è Exercise Regularly</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">150 minutes of moderate exercise or 75 minutes of vigorous exercise weekly</div>
      </div>
      <div style="padding:16px;background:rgba(57,255,20,0.05);border-radius:8px;">
        <div style="color:#ffcc00;font-weight:600;margin-bottom:8px;">ü•ó Balanced Nutrition</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Focus on whole foods, lean proteins, healthy fats, and complex carbs</div>
      </div>
      <div style="padding:16px;background:rgba(255,204,0,0.05);border-radius:8px;">
        <div style="color:#9d4edd;font-weight:600;margin-bottom:8px;">üí§ Sleep Well</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">7-9 hours of quality sleep supports metabolism and recovery</div>
      </div>
      <div style="padding:16px;background:rgba(157,78,221,0.05);border-radius:8px;">
        <div style="color:#2dd4ff;font-weight:600;margin-bottom:8px;">üíß Stay Hydrated</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Drink at least 2 liters of water daily for optimal metabolic function</div>
      </div>
    </div>
    
    <!-- Important Disclaimer -->
    <div style="padding:16px;background:rgba(255,45,85,0.1);border-radius:8px;border-left:4px solid #ff2d55;">
      <div style="color:#ff2d55;font-weight:600;margin-bottom:8px;">‚ö†Ô∏è Important Disclaimer</div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">
        This calculator provides estimates using the U.S. Navy method. For accurate body composition analysis, 
        consult with a healthcare professional or use more precise methods like DEXA scans, hydrostatic weighing, 
        or professional calipers. Individual results may vary based on factors like age, muscle mass, and ethnicity.
      </div>
    </div>
  </div>
</div>

<script>
// Body Fat Calculator - Complete JavaScript Implementation

// State management
let currentGender = 'male';
let measurementHistory = [];

// Body fat categories with descriptions
const bfCategories = {
    male: {
        essential: { min: 2, max: 5, name: 'Essential Fat', color: '#39ff14', 
                    desc: 'Minimum fat required for basic physiological function. Extremely lean, typical for bodybuilders in competition.' },
        athlete: { min: 6, max: 13, name: 'Athlete', color: '#2dd4ff', 
                   desc: 'Very fit and athletic. Excellent muscle definition, typical for most athletes.' },
        fitness: { min: 14, max: 17, name: 'Fitness', color: '#ffcc00', 
                   desc: 'Fit and healthy. Good muscle tone, visible abs when flexed.' },
        average: { min: 18, max: 24, name: 'Average', color: '#ffa500', 
                   desc: 'Average for general population. Some muscle definition, slight abdominal outline.' },
        obese: { min: 25, max: 100, name: 'Obese', color: '#ff2d55', 
                 desc: 'Above average body fat. Consider reducing for better health and fitness.' }
    },
    female: {
        essential: { min: 10, max: 13, name: 'Essential Fat', color: '#39ff14', 
                     desc: 'Minimum fat required for basic physiological function and hormonal balance.' },
        athlete: { min: 14, max: 20, name: 'Athlete', color: '#2dd4ff', 
                   desc: 'Very fit and athletic. Lean with good muscle definition.' },
        fitness: { min: 21, max: 24, name: 'Fitness', color: '#ffcc00', 
                   desc: 'Fit and healthy. Toned physique with some muscle definition.' },
        average: { min: 25, max: 31, name: 'Average', color: '#ffa500', 
                   desc: 'Average for general population. Healthy weight range.' },
        obese: { min: 32, max: 100, name: 'Obese', color: '#ff2d55', 
                 desc: 'Above average body fat. Consider reduction for improved health.' }
    }
};

// Initialize calculator
function bfInitialize() {
    // Set default gender
    bfSetGender('male');
    
    // Setup input listeners for real-time calculation
    const inputs = ['bf-weight', 'bf-height', 'bf-waist', 'bf-neck', 'bf-hip'];
    inputs.forEach(id => {
        const input = document.getElementById(id);
        if (input) {
            input.addEventListener('input', () => bfCalculate());
        }
    });
    
    // Load history from localStorage
    try {
        const savedHistory = localStorage.getItem('bf-measurement-history');
        if (savedHistory) {
            measurementHistory = JSON.parse(savedHistory);
            if (measurementHistory.length > 0) {
                const lastMeasurement = measurementHistory[measurementHistory.length - 1];
                bfLoadMeasurement(lastMeasurement);
            }
        }
    } catch (e) {
        console.log('No previous measurements found');
    }
    
    // Calculate on initial load
    setTimeout(() => bfCalculate(), 500);
}

// Set gender
function bfSetGender(gender) {
    currentGender = gender;
    
    // Update indicator
    document.getElementById('bf-gender-indicator').textContent = gender.charAt(0).toUpperCase() + gender.slice(1);
    document.getElementById('bf-gender-indicator').style.color = gender === 'male' ? '#2dd4ff' : '#ff69b4';
    
    // Update button styles
    const maleBtn = document.getElementById('bf-male-btn');
    const femaleBtn = document.getElementById('bf-female-btn');
    
    if (gender === 'male') {
        maleBtn.style.background = 'rgba(45,212,255,0.2)';
        maleBtn.style.border = '2px solid var(--accent)';
        maleBtn.style.color = 'var(--accent)';
        
        femaleBtn.style.background = 'rgba(255,255,255,0.05)';
        femaleBtn.style.border = '1px solid rgba(255,255,255,0.1)';
        femaleBtn.style.color = 'inherit';
        
        // Hide hip section for males
        document.getElementById('bf-hip-section').style.display = 'none';
    } else {
        femaleBtn.style.background = 'rgba(255,105,180,0.2)';
        femaleBtn.style.border = '2px solid #ff69b4';
        femaleBtn.style.color = '#ff69b4';
        
        maleBtn.style.background = 'rgba(255,255,255,0.05)';
        maleBtn.style.border = '1px solid rgba(255,255,255,0.1)';
        maleBtn.style.color = 'inherit';
        
        // Show hip section for females
        document.getElementById('bf-hip-section').style.display = 'block';
    }
    
    // Recalculate
    bfCalculate();
}

// Adjust input values
function bfAdjustValue(field, amount) {
    const input = document.getElementById(`bf-${field}`);
    if (input) {
        let value = parseFloat(input.value) + amount;
        // Apply min/max constraints
        const min = parseFloat(input.min);
        const max = parseFloat(input.max);
        if (value < min) value = min;
        if (value > max) value = max;
        input.value = value;
        bfCalculate();
    }
}

// Toggle measurement guide
function bfToggleGuide() {
    const guide = document.getElementById('bf-measurement-guide');
    const button = guide.previousElementSibling.querySelector('button');
    if (guide.style.display === 'none' || !guide.style.display) {
        guide.style.display = 'block';
        button.textContent = 'Hide Guide';
    } else {
        guide.style.display = 'none';
        button.textContent = 'Show Guide';
    }
}

// Main calculation function
function bfCalculate() {
    try {
        // Get input values
        const weight = parseFloat(document.getElementById('bf-weight').value) || 70;
        const height = parseFloat(document.getElementById('bf-height').value) || 175;
        const waist = parseFloat(document.getElementById('bf-waist').value) || 80;
        const neck = parseFloat(document.getElementById('bf-neck').value) || 38;
        const hip = currentGender === 'female' ? (parseFloat(document.getElementById('bf-hip').value) || 90) : 0;
        
        // Calculate body fat percentage using U.S. Navy method
        let bodyFatPercentage;
        if (currentGender === 'male') {
            // Male formula: %Fat = 495 / (1.0324 - 0.19077 * log10(waist - neck) + 0.15456 * log10(height)) - 450
            bodyFatPercentage = 495 / (1.0324 - 0.19077 * Math.log10(waist - neck) + 0.15456 * Math.log10(height)) - 450;
        } else {
            // Female formula: %Fat = 495 / (1.29579 - 0.35004 * log10(waist + hip - neck) + 0.22100 * log10(height)) - 450
            bodyFatPercentage = 495 / (1.29579 - 0.35004 * Math.log10(waist + hip - neck) + 0.22100 * Math.log10(height)) - 450;
        }
        
        // Ensure percentage is positive
        bodyFatPercentage = Math.max(0, bodyFatPercentage);
        
        // Calculate additional metrics
        const bmi = weight / ((height / 100) ** 2);
        const whRatio = waist / height;
        const fatMass = (bodyFatPercentage / 100) * weight;
        const leanMass = weight - fatMass;
        
        // Determine category
        const category = bfGetCategory(bodyFatPercentage);
        
        // Update UI with results
        bfUpdateResults(bodyFatPercentage, bmi, whRatio, fatMass, leanMass, category);
        
    } catch (error) {
        console.error('Calculation error:', error);
        bfShowError();
    }
}

// Get body fat category
function bfGetCategory(percentage) {
    const categories = bfCategories[currentGender];
    for (const [key, cat] of Object.entries(categories)) {
        if (percentage >= cat.min && percentage <= cat.max) {
            return { ...cat, key };
        }
    }
    return categories.obese; // Default to obese if out of range
}

// Update results display
function bfUpdateResults(percentage, bmi, whRatio, fatMass, leanMass, category) {
    // Show results section
    document.getElementById('bf-results-section').style.display = 'block';
    
    // Update main percentage
    document.getElementById('bf-percentage').textContent = `${percentage.toFixed(1)}%`;
    document.getElementById('bf-percentage').style.color = category.color;
    
    // Update category
    const categoryEl = document.getElementById('bf-category');
    categoryEl.textContent = category.name;
    categoryEl.style.background = `${category.color}20`;
    categoryEl.style.color = category.color;
    
    // Update scale marker position (0-100% scale)
    const scaleMarker = document.getElementById('bf-scale-marker');
    const scalePosition = Math.min(Math.max(percentage, 0), 100) / 100 * 100;
    scaleMarker.style.left = `calc(${scalePosition}% - 2px)`;
    
    // Update category description
    document.getElementById('bf-category-desc').innerHTML = `
        <div style="color:${category.color};font-weight:600;margin-bottom:4px;">${category.name} (${percentage.toFixed(1)}%)</div>
        <div>${category.desc}</div>
    `;
    
    // Update detailed metrics
    document.getElementById('bf-fat-mass').textContent = `${fatMass.toFixed(1)} kg`;
    document.getElementById('bf-lean-mass').textContent = `${leanMass.toFixed(1)} kg`;
    document.getElementById('bf-bmi').textContent = bmi.toFixed(1);
    document.getElementById('bf-wh-ratio').textContent = whRatio.toFixed(2);
    
    // Update BMI color based on WHO categories
    const bmiEl = document.getElementById('bf-bmi');
    if (bmi < 18.5) bmiEl.style.color = '#ffcc00'; // Underweight
    else if (bmi < 25) bmiEl.style.color = '#39ff14'; // Normal
    else if (bmi < 30) bmiEl.style.color = '#ffa500'; // Overweight
    else bmiEl.style.color = '#ff2d55'; // Obese
    
    // Update recommendations
    bfUpdateRecommendations(percentage, bmi, whRatio, category);
}

// Update health recommendations
function bfUpdateRecommendations(percentage, bmi, whRatio, category) {
    const recommendations = document.getElementById('bf-recommendations');
    let recs = [];
    
    // Category-based recommendations
    if (category.key === 'essential') {
        recs.push('‚ö†Ô∏è Your body fat is very low. Ensure adequate nutrition for health.');
        recs.push('Consider consulting with a nutritionist or healthcare professional.');
        recs.push('Focus on maintaining, not further reducing, body fat percentage.');
    } else if (category.key === 'athlete' || category.key === 'fitness') {
        recs.push('‚úÖ Excellent fitness level! Maintain your current healthy lifestyle.');
        recs.push('Continue balanced nutrition and regular exercise routine.');
        recs.push('Consider strength training to maintain lean muscle mass.');
    } else if (category.key === 'average') {
        recs.push('üìä You are within the average range for the general population.');
        recs.push('Consider adding 30 minutes of moderate exercise 3-4 times per week.');
        recs.push('Focus on whole foods and portion control for optimal health.');
    } else if (category.key === 'obese') {
        recs.push('üéØ Consider gradual weight loss through diet and exercise.');
        recs.push('Aim for 150-300 minutes of moderate exercise per week.');
        recs.push('Consult with a healthcare professional for personalized guidance.');
    }
    
    // BMI-based recommendations
    if (bmi < 18.5) {
        recs.push('‚öñÔ∏è You are underweight according to BMI. Focus on nutrient-dense foods.');
    } else if (bmi >= 25) {
        recs.push('‚öñÔ∏è Your BMI suggests overweight. Consider lifestyle adjustments.');
    }
    
    // Waist-to-height ratio recommendations
    if (whRatio > 0.5) {
        recs.push('üìè Your waist-to-height ratio suggests increased health risks. Consider reducing abdominal fat.');
    }
    
    recommendations.innerHTML = `
        <div style="color:var(--accent);font-weight:600;margin-bottom:8px;">Personalized Recommendations:</div>
        <ul style="margin:0;padding-left:20px;">
            ${recs.map(rec => `<li style="margin-bottom:8px;">${rec}</li>`).join('')}
        </ul>
        <div style="margin-top:12px;font-size:0.85rem;color:rgba(230,250,255,0.7);">
            Note: These are general recommendations. For personalized advice, consult a healthcare professional.
        </div>
    `;
}

// Set default values
function bfSetDefaults() {
    if (currentGender === 'male') {
        document.getElementById('bf-weight').value = 70;
        document.getElementById('bf-height').value = 175;
        document.getElementById('bf-waist').value = 80;
        document.getElementById('bf-neck').value = 38;
    } else {
        document.getElementById('bf-weight').value = 60;
        document.getElementById('bf-height').value = 165;
        document.getElementById('bf-waist').value = 75;
        document.getElementById('bf-neck').value = 32;
        document.getElementById('bf-hip').value = 90;
    }
    bfCalculate();
}

// Copy results to clipboard
function bfCopyResults() {
    const percentage = document.getElementById('bf-percentage').textContent;
    const category = document.getElementById('bf-category').textContent;
    const fatMass = document.getElementById('bf-fat-mass').textContent;
    const leanMass = document.getElementById('bf-lean-mass').textContent;
    const bmi = document.getElementById('bf-bmi').textContent;
    const whRatio = document.getElementById('bf-wh-ratio').textContent;
    
    const text = `Body Fat Results:
Percentage: ${percentage}
Category: ${category}
Fat Mass: ${fatMass}
Lean Mass: ${leanMass}
BMI: ${bmi}
Waist-to-Height Ratio: ${whRatio}
    
Calculated using The Most Useful Site in the World`;
    
    navigator.clipboard.writeText(text).then(() => {
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Copied!';
        button.style.background = 'rgba(57,255,20,0.2)';
        button.style.color = '#39ff14';
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = 'rgba(255,204,0,0.1)';
            button.style.color = '#ffcc00';
        }, 2000);
    }).catch(err => {
        alert('Failed to copy results. Please select and copy manually.');
    });
}

// Reset all inputs
function bfReset() {
    if (confirm('Are you sure you want to reset all measurements?')) {
        document.getElementById('bf-weight').value = 70;
        document.getElementById('bf-height').value = 175;
        document.getElementById('bf-waist').value = 80;
        document.getElementById('bf-neck').value = 38;
        document.getElementById('bf-hip').value = 90;
        bfSetGender('male');
        document.getElementById('bf-results-section').style.display = 'none';
    }
}

// Save results to history
function bfSaveResults() {
    const measurement = {
        date: new Date().toISOString(),
        gender: currentGender,
        weight: document.getElementById('bf-weight').value,
        height: document.getElementById('bf-height').value,
        waist: document.getElementById('bf-waist').value,
        neck: document.getElementById('bf-neck').value,
        hip: currentGender === 'female' ? document.getElementById('bf-hip').value : null,
        percentage: document.getElementById('bf-percentage').textContent,
        category: document.getElementById('bf-category').textContent
    };
    
    measurementHistory.push(measurement);
    
    // Keep only last 10 measurements
    if (measurementHistory.length > 10) {
        measurementHistory = measurementHistory.slice(-10);
    }
    
    // Save to localStorage
    try {
        localStorage.setItem('bf-measurement-history', JSON.stringify(measurementHistory));
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = '‚úÖ Saved!';
        button.style.background = 'rgba(57,255,20,0.2)';
        button.style.color = '#39ff14';
        setTimeout(() => {
            button.textContent = originalText;
            button.style.background = 'rgba(45,212,255,0.1)';
            button.style.color = 'var(--accent)';
        }, 2000);
    } catch (e) {
        alert('Failed to save results. Your browser may not support local storage.');
    }
}

// Load previous measurement
function bfLoadMeasurement(measurement) {
    document.getElementById('bf-weight').value = measurement.weight;
    document.getElementById('bf-height').value = measurement.height;
    document.getElementById('bf-waist').value = measurement.waist;
    document.getElementById('bf-neck').value = measurement.neck;
    if (measurement.hip) {
        document.getElementById('bf-hip').value = measurement.hip;
    }
    bfSetGender(measurement.gender);
    bfCalculate();
}

// Show error message
function bfShowError() {
    const results = document.getElementById('bf-results-section');
    results.style.display = 'block';
    results.innerHTML = `
        <div style="text-align:center;padding:40px;">
            <div style="color:#ff2d55;font-size:3rem;margin-bottom:20px;">‚ö†Ô∏è</div>
            <div style="color:var(--accent);font-weight:600;margin-bottom:12px;">Calculation Error</div>
            <div style="color:rgba(230,250,255,0.9);">
                Please check your measurements. Ensure all values are within valid ranges.
            </div>
            <button onclick="bfReset()" style="margin-top:20px;padding:10px 24px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);border-radius:8px;cursor:pointer;">
                Reset Measurements
            </button>
        </div>
    `;
}

// Auto-initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bfInitialize);
} else {
    bfInitialize();
}
</script>
</div>
