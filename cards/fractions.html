<!-- cards/fractions-helper.html -->
<h2 id="fractions-helper-title" style="margin-top:0;color:var(--accent);">üî¢ Fractions Calculator & Visualizer</h2>

<form aria-describedby="fractions-helper-desc">
  <p id="fractions-helper-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.8);">
    Master fractions with calculations, visual representations, and step-by-step explanations.
    <span style="color:var(--accent);font-weight:500;">Perfect for students learning fractions!</span>
  </p>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
    <div class="field">
      <label for="frac-a" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Fraction A</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="frac-a-num" type="number" placeholder="Num" min="-999" max="999" 
               style="width:60px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;text-align:center;">
        <span style="color:var(--accent);font-size:20px;">/</span>
        <input id="frac-a-den" type="number" placeholder="Den" min="1" max="999" 
               style="width:60px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;text-align:center;">
        <button type="button" onclick="fracLoadExample('simple')" class="small-btn" style="margin-left:auto;">Example</button>
      </div>
      <div id="frac-a-visual" style="height:40px;margin-top:8px;display:none;"></div>
    </div>

    <div class="field">
      <label for="frac-b" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Fraction B</label>
      <div style="display:flex;gap:8px;align-items:center;">
        <input id="frac-b-num" type="number" placeholder="Num" min="-999" max="999" 
               style="width:60px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;text-align:center;">
        <span style="color:var(--accent);font-size:20px;">/</span>
        <input id="frac-b-den" type="number" placeholder="Den" min="1" max="999" 
               style="width:60px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;text-align:center;">
        <button type="button" onclick="fracToggleFractionB()" id="frac-b-toggle" class="small-btn" style="margin-left:auto;">+ Add</button>
      </div>
      <div id="frac-b-visual" style="height:40px;margin-top:8px;display:none;"></div>
    </div>
  </div>

  <div class="field" style="margin-bottom:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <label for="frac-operation" style="color:var(--accent);font-weight:500;">Operation</label>
      <span id="frac-operation-hint" class="small" style="color:rgba(45,212,255,0.7);font-size:12px;">Simplify a single fraction</span>
    </div>
    <select id="frac-operation" 
            style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:15px;"
            onchange="fracUpdateOperationHint()">
      <option value="simplify" selected>Simplify Fraction</option>
      <option value="decimal">Convert to Decimal</option>
      <option value="percentage">Convert to Percentage</option>
      <option value="mixed">Convert to Mixed Number</option>
      <option value="improper">Convert to Improper Fraction</option>
      <option value="add">Addition (A + B)</option>
      <option value="subtract">Subtraction (A - B)</option>
      <option value="multiply">Multiplication (A √ó B)</option>
      <option value="divide">Division (A √∑ B)</option>
      <option value="compare">Compare Fractions</option>
      <option value="common-denominator">Find Common Denominator</option>
      <option value="reciprocal">Find Reciprocal</option>
    </select>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
    <div class="field">
      <label for="frac-format" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Output Format</label>
      <select id="frac-format" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
        <option value="fraction" selected>Fraction (simplified)</option>
        <option value="decimal">Decimal</option>
        <option value="mixed">Mixed Number</option>
        <option value="percentage">Percentage</option>
        <option value="all">Show All Formats</option>
      </select>
    </div>

    <div class="field">
      <label for="frac-decimal-places" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Decimal Places</label>
      <select id="frac-decimal-places" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
        <option value="2">2 places</option>
        <option value="4" selected>4 places</option>
        <option value="6">6 places</option>
        <option value="8">8 places</option>
      </select>
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
      <input type="checkbox" id="frac-show-steps" checked style="width:18px;height:18px;cursor:pointer;" />
      <span style="color:var(--accent);font-weight:500;">Show step-by-step solution</span>
    </label>
    
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-left:auto;">
      <input type="checkbox" id="frac-show-visual" checked style="width:18px;height:18px;cursor:pointer;" />
      <span style="color:var(--accent);font-weight:500;">Show visual representation</span>
    </label>
  </div>

  <!-- Quick Examples -->
  <div style="margin-bottom:20px;">
    <div class="small" style="color:var(--accent);margin-bottom:8px;">üìö Common Fractions:</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="fracLoadExample('simple')" class="small-btn">3/4</button>
      <button type="button" onclick="fracLoadExample('improper')" class="small-btn">5/2</button>
      <button type="button" onclick="fracLoadExample('compare')" class="small-btn">Compare 1/2 & 2/3</button>
      <button type="button" onclick="fracLoadExample('add')" class="small-btn">1/3 + 1/6</button>
      <button type="button" onclick="fracLoadExample('multiply')" class="small-btn">2/3 √ó 3/4</button>
    </div>
  </div>

  <div class="actions" style="display:flex;gap:10px;">
    <button type="button" onclick="fracCalculate(this)" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(57,255,20,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);font-weight:600;cursor:pointer;font-size:16px;">
      üßÆ Calculate Fractions
    </button>
    <button type="button" onclick="fracReset(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset
    </button>
    <button type="button" onclick="fracGeneratePractice()"
            style="padding:12px 16px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:8px;color:#ffa500;cursor:pointer;">
      Practice
    </button>
  </div>
</form>

<div id="frac-results" aria-live="polite" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">Fraction Results</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="frac-status" class="small" style="color:rgba(45,212,255,0.8);">‚úÖ Solved</div>
    </div>
  </div>

  <div id="frac-output-container" style="min-height:200px;">
    <!-- Results will be inserted here -->
  </div>

  <div id="frac-visual-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìä Visual Representation</h4>
    <div id="frac-visual-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">
      <!-- Visualizations will be inserted here -->
    </div>
  </div>

  <div id="frac-steps-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìù Step-by-Step Solution</h4>
    <div id="frac-steps-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);font-family:'Consolas','Monaco','Courier New',monospace;font-size:13px;line-height:1.6;">
      <!-- Steps will be inserted here -->
    </div>
  </div>

  <div style="margin-top:20px;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      <button onclick="fracCopyResult()" 
              style="padding:10px;background:rgba(45,212,255,0.05);border:1px solid rgba(45,212,255,0.2);border-radius:8px;color:var(--accent);cursor:pointer;font-size:12px;">
        üìã Copy Result
      </button>
      <button onclick="fracCopySteps()" 
              style="padding:10px;background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.2);border-radius:8px;color:#39ff14;cursor:pointer;font-size:12px;">
        üìã Copy Steps
      </button>
      <button onclick="fracDownloadResult()" 
              style="padding:10px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;cursor:pointer;font-size:12px;">
        üíæ Download
      </button>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
      <div id="frac-hint" class="small" style="color:#39ff14;"></div>
      <button onclick="fracShowEquivalent()" 
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        üîÑ Show Equivalent Fractions
      </button>
    </div>
  </div>
</div>

<script>
/* fractions-helper.html
   - Comprehensive fractions calculator with visualization
   - Scoped with frac- prefix
*/

// Fraction examples
const fracExamples = {
  'simple': { aNum: 3, aDen: 4, bNum: 0, bDen: 1 },
  'improper': { aNum: 5, aDen: 2, bNum: 0, bDen: 1 },
  'compare': { aNum: 1, aDen: 2, bNum: 2, bDen: 3 },
  'add': { aNum: 1, aDen: 3, bNum: 1, bDen: 6 },
  'multiply': { aNum: 2, aDen: 3, bNum: 3, bDen: 4 },
  'common': { aNum: 1, aDen: 4, bNum: 1, aDen: 6 }
};

// Operation descriptions
const fracOperationHints = {
  'simplify': 'Reduce fraction to lowest terms',
  'decimal': 'Convert fraction to decimal',
  'percentage': 'Convert fraction to percentage',
  'mixed': 'Convert improper fraction to mixed number',
  'improper': 'Convert mixed number to improper fraction',
  'add': 'Add two fractions',
  'subtract': 'Subtract fraction B from A',
  'multiply': 'Multiply two fractions',
  'divide': 'Divide fraction A by B',
  'compare': 'Compare which fraction is larger',
  'common-denominator': 'Find common denominator',
  'reciprocal': 'Find reciprocal (1/fraction)'
};

// Initialize the tool
function fracInit() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set up event listeners
  const operationSelect = card.querySelector('#frac-operation');
  if (operationSelect) {
    operationSelect.addEventListener('change', fracUpdateOperationHint);
  }
  
  // Input listeners for real-time updates
  const inputs = ['frac-a-num', 'frac-a-den', 'frac-b-num', 'frac-b-den'];
  inputs.forEach(id => {
    const input = card.querySelector(`#${id}`);
    if (input) {
      input.addEventListener('input', () => {
        fracUpdateVisualizations();
        fracUpdateFractionBButton();
      });
    }
  });
  
  // Initialize
  fracUpdateOperationHint();
  fracUpdateFractionBButton();
  console.log('Fractions Helper initialized');
}

// Update operation hint
function fracUpdateOperationHint() {
  const card = document.currentScript?.closest('.card') || document;
  const operation = card.querySelector('#frac-operation').value;
  const hint = card.querySelector('#frac-operation-hint');
  
  if (hint && fracOperationHints[operation]) {
    hint.textContent = fracOperationHints[operation];
  }
}

// Toggle fraction B
function fracToggleFractionB() {
  const card = document.currentScript?.closest('.card') || document;
  const toggleBtn = card.querySelector('#frac-b-toggle');
  const bNumInput = card.querySelector('#frac-b-num');
  const bDenInput = card.querySelector('#frac-b-den');
  const operation = card.querySelector('#frac-operation').value;
  
  const operationsNeedingB = ['add', 'subtract', 'multiply', 'divide', 'compare', 'common-denominator'];
  const needsB = operationsNeedingB.includes(operation);
  
  if (bNumInput.value || bDenInput.value || needsB) {
    // Fraction B is being used or required
    bNumInput.value = bNumInput.value || '1';
    bDenInput.value = bDenInput.value || '4';
    toggleBtn.textContent = '‚àí Remove';
    toggleBtn.style.background = 'rgba(255,77,77,0.1)';
    toggleBtn.style.color = '#ff4d4d';
  } else {
    // Clear fraction B
    bNumInput.value = '';
    bDenInput.value = '';
    toggleBtn.textContent = '+ Add';
    toggleBtn.style.background = '';
    toggleBtn.style.color = '';
  }
  
  fracUpdateVisualizations();
}

// Update fraction B button state
function fracUpdateFractionBButton() {
  const card = document.currentScript?.closest('.card') || document;
  const bNum = card.querySelector('#frac-b-num').value;
  const bDen = card.querySelector('#frac-b-den').value;
  const toggleBtn = card.querySelector('#frac-b-toggle');
  
  if (bNum || bDen) {
    toggleBtn.textContent = '‚àí Remove';
    toggleBtn.style.background = 'rgba(255,77,77,0.1)';
    toggleBtn.style.color = '#ff4d4d';
  } else {
    toggleBtn.textContent = '+ Add';
    toggleBtn.style.background = '';
    toggleBtn.style.color = '';
  }
}

// Load example
function fracLoadExample(exampleKey) {
  const card = document.currentScript?.closest('.card') || document;
  const example = fracExamples[exampleKey];
  
  if (!example) return;
  
  card.querySelector('#frac-a-num').value = example.aNum;
  card.querySelector('#frac-a-den').value = example.aDen;
  
  if (example.bNum && example.bDen) {
    card.querySelector('#frac-b-num').value = example.bNum;
    card.querySelector('#frac-b-den').value = example.bDen;
  } else {
    card.querySelector('#frac-b-num').value = '';
    card.querySelector('#frac-b-den').value = '';
  }
  
  // Set appropriate operation
  const operationMap = {
    'compare': 'compare',
    'add': 'add',
    'multiply': 'multiply',
    'common': 'common-denominator'
  };
  
  if (operationMap[exampleKey]) {
    card.querySelector('#frac-operation').value = operationMap[exampleKey];
    fracUpdateOperationHint();
  }
  
  fracUpdateVisualizations();
  
  // Show hint
  const hint = card.querySelector('#frac-hint');
  hint.textContent = `Loaded ${exampleKey} example`;
  hint.style.color = '#39ff14';
  setTimeout(() => {
    if (hint.textContent.includes('Loaded')) hint.textContent = '';
  }, 2000);
}

// Update visualizations in real-time
function fracUpdateVisualizations() {
  const card = document.currentScript?.closest('.card') || document;
  const showVisual = card.querySelector('#frac-show-visual').checked;
  
  if (!showVisual) return;
  
  // Fraction A visualization
  const aNum = parseFloat(card.querySelector('#frac-a-num').value);
  const aDen = parseFloat(card.querySelector('#frac-a-den').value);
  
  if (aNum && aDen && aDen > 0) {
    const visualA = card.querySelector('#frac-a-visual');
    visualA.style.display = 'block';
    visualA.innerHTML = fracCreateVisualization(aNum, aDen, 'A');
  }
  
  // Fraction B visualization
  const bNum = parseFloat(card.querySelector('#frac-b-num').value);
  const bDen = parseFloat(card.querySelector('#frac-b-den').value);
  
  if (bNum && bDen && bDen > 0) {
    const visualB = card.querySelector('#frac-b-visual');
    visualB.style.display = 'block';
    visualB.innerHTML = fracCreateVisualization(bNum, bDen, 'B');
  }
}

// Create fraction visualization
function fracCreateVisualization(numerator, denominator, label) {
  const size = 120;
  const cellSize = size / Math.min(denominator, 8); // Max 8 cells per row for clarity
  
  let html = `<div style="display:flex;align-items:center;gap:8px;">`;
  html += `<span class="small" style="color:var(--accent);min-width:20px;">${label}:</span>`;
  html += `<div style="position:relative;width:${size}px;height:${cellSize}px;background:rgba(255,255,255,0.05);border-radius:4px;overflow:hidden;">`;
  
  // Create grid
  const cols = Math.min(denominator, 8);
  const rows = Math.ceil(denominator / cols);
  
  for (let i = 0; i < denominator; i++) {
    const row = Math.floor(i / cols);
    const col = i % cols;
    const isFilled = i < numerator;
    
    html += `<div style="position:absolute;left:${col * cellSize}px;top:${row * cellSize}px;width:${cellSize - 1}px;height:${cellSize - 1}px;background:${isFilled ? 'rgba(45,212,255,0.6)' : 'rgba(255,255,255,0.1)'};border:1px solid rgba(255,255,255,0.2);border-radius:2px;"></div>`;
  }
  
  html += `</div>`;
  html += `<span class="small" style="color:var(--accent);">${numerator}/${denominator}</span>`;
  html += `</div>`;
  
  return html;
}

// Greatest Common Divisor
function fracGCD(a, b) {
  a = Math.abs(a);
  b = Math.abs(b);
  while (b) {
    const temp = b;
    b = a % b;
    a = temp;
  }
  return a;
}

// Least Common Multiple
function fracLCM(a, b) {
  return Math.abs(a * b) / fracGCD(a, b);
}

// Simplify fraction
function fracSimplify(numerator, denominator) {
  if (denominator === 0) return { numerator: 0, denominator: 0, error: true };
  
  const gcd = fracGCD(numerator, denominator);
  return {
    numerator: numerator / gcd,
    denominator: denominator / gcd,
    simplified: gcd !== 1
  };
}

// Convert to mixed number
function fracToMixed(numerator, denominator) {
  if (denominator === 0) return { whole: 0, numerator: 0, denominator: 0, error: true };
  
  const whole = Math.floor(numerator / denominator);
  const remainder = numerator % denominator;
  
  return {
    whole: whole,
    numerator: Math.abs(remainder),
    denominator: denominator,
    isMixed: whole !== 0
  };
}

// Convert to improper fraction
function fracToImproper(whole, numerator, denominator) {
  if (denominator === 0) return { numerator: 0, denominator: 0, error: true };
  
  return {
    numerator: whole * denominator + numerator,
    denominator: denominator
  };
}

// Main calculation function
function fracCalculate(btn) {
  const startTime = performance.now();
  const card = btn.closest('.card') || document;
  
  // Get inputs
  const aNum = parseFloat(card.querySelector('#frac-a-num').value);
  const aDen = parseFloat(card.querySelector('#frac-a-den').value);
  const bNum = parseFloat(card.querySelector('#frac-b-num').value);
  const bDen = parseFloat(card.querySelector('#frac-b-den').value);
  const operation = card.querySelector('#frac-operation').value;
  const showSteps = card.querySelector('#frac-show-steps').checked;
  const showVisual = card.querySelector('#frac-show-visual').checked;
  const outputFormat = card.querySelector('#frac-format').value;
  const decimalPlaces = parseInt(card.querySelector('#frac-decimal-places').value);
  
  // Validate inputs
  if (!aNum || !aDen || aDen <= 0) {
    const hint = card.querySelector('#frac-hint');
    hint.textContent = 'Please enter a valid Fraction A (denominator must be positive)';
    hint.style.color = '#ff2d55';
    return;
  }
  
  // Check if fraction B is needed
  const operationsNeedingB = ['add', 'subtract', 'multiply', 'divide', 'compare', 'common-denominator'];
  const needsB = operationsNeedingB.includes(operation);
  
  if (needsB && (!bNum || !bDen || bDen <= 0)) {
    const hint = card.querySelector('#frac-hint');
    hint.textContent = 'This operation requires Fraction B';
    hint.style.color = '#ff2d55';
    return;
  }
  
  // Perform calculation
  const result = fracPerformOperation(aNum, aDen, bNum, bDen, operation, decimalPlaces);
  
  // Display results
  fracDisplayResults(card, result, operation, showSteps, showVisual, outputFormat, decimalPlaces);
  
  // Calculate and show execution time
  const endTime = performance.now();
  const timeTaken = (endTime - startTime).toFixed(2);
  
  // Update hint
  const hint = card.querySelector('#frac-hint');
  hint.textContent = `Calculated in ${timeTaken}ms`;
  hint.style.color = '#39ff14';
  
  // Show results section
  const resultsDiv = card.querySelector('#frac-results');
  resultsDiv.style.display = 'block';
  resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Perform the selected operation
function fracPerformOperation(aNum, aDen, bNum, bDen, operation, decimalPlaces) {
  let result = { operation };
  
  switch (operation) {
    case 'simplify':
      const simplified = fracSimplify(aNum, aDen);
      result = { ...result, ...simplified, original: { aNum, aDen } };
      break;
      
    case 'decimal':
      const decimal = aNum / aDen;
      result = { ...result, decimal, original: { aNum, aDen } };
      break;
      
    case 'percentage':
      const percentage = (aNum / aDen) * 100;
      result = { ...result, percentage, original: { aNum, aDen } };
      break;
      
    case 'mixed':
      const mixed = fracToMixed(aNum, aDen);
      result = { ...result, ...mixed, original: { aNum, aDen } };
      break;
      
    case 'improper':
      // For improper, we assume input is mixed: aNum = whole, aDen = numerator, need third input
      // This would need additional UI, so for now we'll convert aNum/aDen as is
      result = { ...result, numerator: aNum, denominator: aDen, original: { aNum, aDen } };
      break;
      
    case 'add':
      const lcmAdd = fracLCM(aDen, bDen);
      const newNumAdd = (aNum * (lcmAdd / aDen)) + (bNum * (lcmAdd / bDen));
      const sumSimplified = fracSimplify(newNumAdd, lcmAdd);
      result = { ...result, ...sumSimplified, lcm: lcmAdd, original: { aNum, aDen, bNum, bDen } };
      break;
      
    case 'subtract':
      const lcmSub = fracLCM(aDen, bDen);
      const newNumSub = (aNum * (lcmSub / aDen)) - (bNum * (lcmSub / bDen));
      const diffSimplified = fracSimplify(newNumSub, lcmSub);
      result = { ...result, ...diffSimplified, lcm: lcmSub, original: { aNum, aDen, bNum, bDen } };
      break;
      
    case 'multiply':
      const newNumMul = aNum * bNum;
      const newDenMul = aDen * bDen;
      const prodSimplified = fracSimplify(newNumMul, newDenMul);
      result = { ...result, ...prodSimplified, original: { aNum, aDen, bNum, bDen } };
      break;
      
    case 'divide':
      const newNumDiv = aNum * bDen;
      const newDenDiv = aDen * bNum;
      const quotSimplified = fracSimplify(newNumDiv, newDenDiv);
      result = { ...result, ...quotSimplified, original: { aNum, aDen, bNum, bDen } };
      break;
      
    case 'compare':
      const valueA = aNum / aDen;
      const valueB = bNum / bDen;
      result = { 
        ...result, 
        valueA, 
        valueB, 
        comparison: valueA === valueB ? 'equal' : valueA > valueB ? 'greater' : 'less',
        original: { aNum, aDen, bNum, bDen }
      };
      break;
      
    case 'common-denominator':
      const lcmCommon = fracLCM(aDen, bDen);
      const aMultiplier = lcmCommon / aDen;
      const bMultiplier = lcmCommon / bDen;
      result = { 
        ...result, 
        lcm: lcmCommon,
        aEquivalent: { numerator: aNum * aMultiplier, denominator: lcmCommon },
        bEquivalent: { numerator: bNum * bMultiplier, denominator: lcmCommon },
        original: { aNum, aDen, bNum, bDen }
      };
      break;
      
    case 'reciprocal':
      const reciprocal = fracSimplify(aDen, aNum);
      result = { ...result, ...reciprocal, original: { aNum, aDen } };
      break;
  }
  
  return result;
}

// Display results
function fracDisplayResults(card, result, operation, showSteps, showVisual, outputFormat, decimalPlaces) {
  const container = card.querySelector('#frac-output-container');
  const stepsContainer = card.querySelector('#frac-steps-container');
  const stepsContent = card.querySelector('#frac-steps-content');
  const visualContainer = card.querySelector('#frac-visual-container');
  const visualContent = card.querySelector('#frac-visual-content');
  
  // Clear previous content
  container.innerHTML = '';
  stepsContent.innerHTML = '';
  visualContent.innerHTML = '';
  
  // Show/hide containers
  stepsContainer.style.display = showSteps ? 'block' : 'none';
  visualContainer.style.display = showVisual ? 'block' : 'none';
  
  // Generate results based on operation
  let resultsHTML = '';
  let stepsHTML = '';
  let visualHTML = '';
  
  switch (operation) {
    case 'simplify':
      resultsHTML = fracGenerateSimplifyOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGenerateSimplifySteps(result);
      visualHTML = fracGenerateSimplifyVisual(result);
      break;
      
    case 'decimal':
      resultsHTML = fracGenerateDecimalOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGenerateDecimalSteps(result);
      break;
      
    case 'percentage':
      resultsHTML = fracGeneratePercentageOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGeneratePercentageSteps(result);
      break;
      
    case 'add':
      resultsHTML = fracGenerateAddOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGenerateAddSteps(result);
      visualHTML = fracGenerateOperationVisual(result, 'add');
      break;
      
    case 'multiply':
      resultsHTML = fracGenerateMultiplyOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGenerateMultiplySteps(result);
      visualHTML = fracGenerateOperationVisual(result, 'multiply');
      break;
      
    case 'compare':
      resultsHTML = fracGenerateCompareOutput(result, outputFormat, decimalPlaces);
      stepsHTML = fracGenerateCompareSteps(result);
      visualHTML = fracGenerateCompareVisual(result);
      break;
      
    default:
      resultsHTML = `<div style="color:var(--accent);text-align:center;padding:20px;">Operation "${operation}" result will be displayed here</div>`;
  }
  
  // Display results
  container.innerHTML = resultsHTML;
  if (showSteps) stepsContent.innerHTML = stepsHTML;
  if (showVisual) visualContent.innerHTML = visualHTML;
  
  // Store result data for copying
  container.dataset.result = JSON.stringify(result);
}

// Generate simplify output
function fracGenerateSimplifyOutput(result, format, decimalPlaces) {
  const { numerator, denominator, simplified, original } = result;
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  html += `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${numerator}/${denominator}</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">Simplified Form</div>`;
  html += `</div>`;
  
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">`;
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Original</div>`;
  html += `<div style="font-size:24px;font-weight:600;">${original.aNum}/${original.aDen}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#39ff14;">Simplified</div>`;
  html += `<div style="font-size:24px;font-weight:600;">${numerator}/${denominator}</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Additional formats if requested
  if (format === 'all' || format === 'decimal') {
    const decimal = (numerator / denominator).toFixed(decimalPlaces);
    html += `<div style="margin-top:12px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;">`;
    html += `<span style="color:var(--accent);">Decimal:</span> ${decimal}`;
    html += `</div>`;
  }
  
  if (format === 'all' || format === 'percentage') {
    const percentage = ((numerator / denominator) * 100).toFixed(2);
    html += `<div style="margin-top:6px;padding:10px;background:rgba(255,255,255,0.05);border-radius:6px;">`;
    html += `<span style="color:var(--accent);">Percentage:</span> ${percentage}%`;
    html += `</div>`;
  }
  
  html += `</div>`;
  return html;
}

// Generate addition output
function fracGenerateAddOutput(result, format, decimalPlaces) {
  const { numerator, denominator, original } = result;
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  html += `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:32px;color:rgba(230,250,255,0.8);">${original.aNum}/${original.aDen} + ${original.bNum}/${original.bDen} =</div>`;
  html += `<div style="font-size:48px;font-weight:600;color:var(--accent);margin-top:8px;">${numerator}/${denominator}</div>`;
  html += `</div>`;
  
  // Show simplified if different
  const originalSum = original.aNum/original.aDen + original.bNum/original.bDen;
  const simplifiedSum = numerator/denominator;
  
  if (Math.abs(originalSum - simplifiedSum) > 0.0001) {
    html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;margin-bottom:12px;">`;
    html += `<div class="small" style="color:#39ff14;">Simplified from ${(originalSum).toFixed(4)}</div>`;
    html += `</div>`;
  }
  
  html += `</div>`;
  return html;
}

// Generate comparison output
function fracGenerateCompareOutput(result, format, decimalPlaces) {
  const { valueA, valueB, comparison, original } = result;
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  html += `<div style="text-align:center;margin-bottom:20px;">`;
  
  let comparisonSymbol = '=';
  let comparisonText = 'are equal';
  let color = '#39ff14';
  
  if (comparison === 'greater') {
    comparisonSymbol = '>';
    comparisonText = 'is greater than';
    color = '#2dd4ff';
  } else if (comparison === 'less') {
    comparisonSymbol = '<';
    comparisonText = 'is less than';
    color = '#ffa500';
  }
  
  html += `<div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:16px;">`;
  html += `<div style="font-size:32px;font-weight:600;color:var(--accent);">${original.aNum}/${original.aDen}</div>`;
  html += `<div style="font-size:48px;font-weight:600;color:${color};">${comparisonSymbol}</div>`;
  html += `<div style="font-size:32px;font-weight:600;color:var(--accent);">${original.bNum}/${original.bDen}</div>`;
  html += `</div>`;
  
  html += `<div style="color:${color};font-weight:600;">Fraction A ${comparisonText} Fraction B</div>`;
  html += `</div>`;
  
  // Numerical values
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">`;
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Fraction A</div>`;
  html += `<div>${valueA.toFixed(decimalPlaces)}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Fraction B</div>`;
  html += `<div>${valueB.toFixed(decimalPlaces)}</div>`;
  html += `</div>`;
  html += `</div>`;
  
  html += `</div>`;
  return html;
}

// Generate simplify steps
function fracGenerateSimplifySteps(result) {
  const { numerator, denominator, simplified, original } = result;
  const gcd = fracGCD(original.aNum, original.aDen);
  
  let steps = `Step 1: Original fraction: ${original.aNum}/${original.aDen}\n`;
  steps += `Step 2: Find Greatest Common Divisor (GCD)\n`;
  steps += `       GCD(${original.aNum}, ${original.aDen}) = ${gcd}\n`;
  steps += `Step 3: Divide numerator and denominator by GCD\n`;
  steps += `       Numerator: ${original.aNum} √∑ ${gcd} = ${numerator}\n`;
  steps += `       Denominator: ${original.aDen} √∑ ${gcd} = ${denominator}\n`;
  steps += `Step 4: Simplified fraction: ${numerator}/${denominator}\n`;
  
  if (!simplified) {
    steps += `Note: Fraction was already in simplest form`;
  }
  
  return steps;
}

// Generate add steps
function fracGenerateAddSteps(result) {
  const { numerator, denominator, lcm, original } = result;
  
  let steps = `Step 1: Find Least Common Multiple (LCM) of denominators\n`;
  steps += `       LCM(${original.aDen}, ${original.bDen}) = ${lcm}\n`;
  steps += `Step 2: Convert fractions to equivalent fractions with common denominator\n`;
  steps += `       ${original.aNum}/${original.aDen} = (${original.aNum} √ó ${lcm/original.aDen})/${lcm} = ${original.aNum * (lcm/original.aDen)}/${lcm}\n`;
  steps += `       ${original.bNum}/${original.bDen} = (${original.bNum} √ó ${lcm/original.bDen})/${lcm} = ${original.bNum * (lcm/original.bDen)}/${lcm}\n`;
  steps += `Step 3: Add numerators\n`;
  steps += `       ${original.aNum * (lcm/original.aDen)}/${lcm} + ${original.bNum * (lcm/original.bDen)}/${lcm} = ${original.aNum * (lcm/original.aDen) + original.bNum * (lcm/original.bDen)}/${lcm}\n`;
  steps += `Step 4: Simplify if possible\n`;
  steps += `       Result: ${numerator}/${denominator}`;
  
  return steps;
}

// Generate operation visual
function fracGenerateOperationVisual(result, operation) {
  const { numerator, denominator, original } = result;
  const operationSymbol = operation === 'add' ? '+' : operation === 'multiply' ? '√ó' : '√∑';
  
  let visual = `<div style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:20px;">`;
  visual += `<div style="text-align:center;">`;
  visual += `<div class="small" style="color:var(--accent);">Fraction A</div>`;
  visual += `<div style="font-size:24px;">${original.aNum}/${original.aDen}</div>`;
  visual += `</div>`;
  
  visual += `<div style="font-size:32px;color:var(--accent);">${operationSymbol}</div>`;
  
  visual += `<div style="text-align:center;">`;
  visual += `<div class="small" style="color:var(--accent);">Fraction B</div>`;
  visual += `<div style="font-size:24px;">${original.bNum}/${original.bDen}</div>`;
  visual += `</div>`;
  
  visual += `<div style="font-size:32px;color:#39ff14;">=</div>`;
  
  visual += `<div style="text-align:center;">`;
  visual += `<div class="small" style="color:#39ff14;">Result</div>`;
  visual += `<div style="font-size:24px;">${numerator}/${denominator}</div>`;
  visual += `</div>`;
  visual += `</div>`;
  
  return visual;
}

// Reset form
function fracReset(btn) {
  const card = btn.closest('.card') || document;
  
  // Reset form
  card.querySelector('form').reset();
  
  // Hide results
  const resultsDiv = card.querySelector('#frac-results');
  resultsDiv.style.display = 'none';
  
  // Clear outputs
  const container = card.querySelector('#frac-output-container');
  container.innerHTML = '';
  delete container.dataset.result;
  
  // Clear hints
  const hint = card.querySelector('#frac-hint');
  hint.textContent = '';
  
  // Hide visualizations
  const visualA = card.querySelector('#frac-a-visual');
  const visualB = card.querySelector('#frac-b-visual');
  visualA.style.display = 'none';
  visualB.style.display = 'none';
  
  // Reset type hint
  fracUpdateOperationHint();
  fracUpdateFractionBButton();
}

// Copy result
function fracCopyResult() {
  const card = document.currentScript?.closest('.card') || document;
  const resultData = card.querySelector('#frac-output-container').dataset.result;
  
  if (!resultData) {
    fracShowMessage('No result available to copy', '#ff2d55');
    return;
  }
  
  const result = JSON.parse(resultData);
  let text = '';
  
  switch (result.operation) {
    case 'simplify':
      text = `Simplified: ${result.numerator}/${result.denominator}`;
      break;
    case 'add':
      text = `${result.original.aNum}/${result.original.aDen} + ${result.original.bNum}/${result.original.bDen} = ${result.numerator}/${result.denominator}`;
      break;
    case 'compare':
      const symbol = result.comparison === 'equal' ? '=' : result.comparison === 'greater' ? '>' : '<';
      text = `${result.original.aNum}/${result.original.aDen} ${symbol} ${result.original.bNum}/${result.original.bDen}`;
      break;
    default:
      text = 'Fraction calculation result';
  }
  
  navigator.clipboard.writeText(text).then(() => {
    fracShowMessage('‚úÖ Result copied to clipboard!', '#39ff14');
  }).catch(err => {
    console.error('Copy failed:', err);
    fracShowMessage('‚ùå Copy failed', '#ff2d55');
  });
}

// Copy steps
function fracCopySteps() {
  const card = document.currentScript?.closest('.card') || document;
  const stepsContent = card.querySelector('#frac-steps-content');
  
  if (!stepsContent || !stepsContent.textContent.trim()) {
    fracShowMessage('No steps available to copy', '#ff2d55');
    return;
  }
  
  navigator.clipboard.writeText(stepsContent.textContent).then(() => {
    fracShowMessage('‚úÖ Steps copied to clipboard!', '#39ff14');
  }).catch(err => {
    console.error('Copy failed:', err);
    fracShowMessage('‚ùå Copy failed', '#ff2d55');
  });
}

// Download result
function fracDownloadResult() {
  const card = document.currentScript?.closest('.card') || document;
  const resultData = card.querySelector('#frac-output-container').dataset.result;
  const stepsContent = card.querySelector('#frac-steps-content');
  
  if (!resultData) {
    fracShowMessage('No result available to download', '#ff2d55');
    return;
  }
  
  const result = JSON.parse(resultData);
  let text = `FRACTION CALCULATION RESULT\n`;
  text += `Generated: ${new Date().toLocaleString()}\n\n`;
  
  switch (result.operation) {
    case 'simplify':
      text += `Operation: Simplify Fraction\n`;
      text += `Original: ${result.original.aNum}/${result.original.aDen}\n`;
      text += `Simplified: ${result.numerator}/${result.denominator}\n`;
      break;
    case 'add':
      text += `Operation: Addition\n`;
      text += `${result.original.aNum}/${result.original.aDen} + ${result.original.bNum}/${result.original.bDen} = ${result.numerator}/${result.denominator}\n`;
      break;
  }
  
  if (stepsContent && stepsContent.textContent.trim()) {
    text += `\nSTEPS:\n${stepsContent.textContent}\n`;
  }
  
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'fraction-calculation.txt';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  fracShowMessage('‚úÖ Result downloaded as .txt file!', '#39ff14');
}

// Generate practice problem
function fracGeneratePractice() {
  const card = document.currentScript?.closest('.card') || document;
  
  const operations = ['add', 'subtract', 'multiply', 'divide', 'simplify'];
  const operation = operations[Math.floor(Math.random() * operations.length)];
  
  // Generate random fractions
  const aDen = Math.floor(Math.random() * 12) + 2;
  const aNum = Math.floor(Math.random() * aDen) + 1;
  
  let bDen = 0, bNum = 0;
  if (operation !== 'simplify') {
    bDen = Math.floor(Math.random() * 12) + 2;
    bNum = Math.floor(Math.random() * bDen) + 1;
  }
  
  // Set values
  card.querySelector('#frac-a-num').value = aNum;
  card.querySelector('#frac-a-den').value = aDen;
  
  if (operation !== 'simplify') {
    card.querySelector('#frac-b-num').value = bNum;
    card.querySelector('#frac-b-den').value = bDen;
    card.querySelector('#frac-b-toggle').click();
  }
  
  card.querySelector('#frac-operation').value = operation;
  fracUpdateOperationHint();
  
  const hint = card.querySelector('#et-hint');
  hint.textContent = `Practice problem: ${aNum}/${aDen} ${operation === 'simplify' ? 'simplify' : operation === 'add' ? '+' : operation === 'subtract' ? '‚àí' : operation === 'multiply' ? '√ó' : '√∑'} ${operation !== 'simplify' ? `${bNum}/${bDen}` : ''}`;
  hint.style.color = '#ffa500';
  setTimeout(() => hint.textContent = '', 3000);
}

// Show equivalent fractions
function fracShowEquivalent() {
  const card = document.currentScript?.closest('.card') || document;
  const aNum = parseFloat(card.querySelector('#frac-a-num').value);
  const aDen = parseFloat(card.querySelector('#frac-a-den').value);
  
  if (!aNum || !aDen) {
    fracShowMessage('Enter a fraction first', '#ff2d55');
    return;
  }
  
  let equivalents = '';
  for (let i = 2; i <= 5; i++) {
    equivalents += `${aNum * i}/${aDen * i}, `;
  }
  
  const hint = card.querySelector('#frac-hint');
  hint.textContent = `Equivalent fractions: ${equivalents.slice(0, -2)}`;
  hint.style.color = '#39ff14';
  setTimeout(() => {
    if (hint.textContent.includes('Equivalent fractions')) hint.textContent = '';
  }, 4000);
}

// Helper function to show messages
function fracShowMessage(message, color) {
  const card = document.currentScript?.closest('.card') || document;
  const hint = card.querySelector('#frac-hint');
  hint.textContent = message;
  hint.style.color = color;
  setTimeout(() => {
    if (hint.textContent === message) hint.textContent = '';
  }, 2000);
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', fracInit);
} else {
  fracInit();
}
</script>

<style>
#fractions-helper-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.3rem;
}

.small-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  color: inherit;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
  padding: 4px 8px;
}

.small-btn:hover {
  background: rgba(45,212,255,0.1);
  border-color: rgba(45,212,255,0.3);
}

@media (max-width: 768px) {
  .field {
    grid-column: 1 / -1 !important;
  }
  
  .actions {
    flex-direction: column;
  }
  
  .actions button {
    width: 100%;
    margin: 4px 0 !important;
  }
}
</style>
