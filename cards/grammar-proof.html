<!-- cards/grammar-proofreader.html -->

<h2 id="grammar-proofreader-title">Grammar Proofreader ‚úçÔ∏è</h2>

<form aria-describedby="grammar-proofreader-desc">
  <p id="grammar-proofreader-desc" class="small">Check text for grammar, spelling, punctuation, and style issues. Get suggestions and explanations to improve your writing.</p>

  <div style="display:grid;grid-template-columns:1fr;gap:12px;margin-bottom:16px;">
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
        <label for="gp-text" style="color:var(--accent);font-weight:500;">Enter Text to Check</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <button type="button" onclick="gpPasteExample(this)" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;">Example Text</button>
          <button type="button" onclick="gpClearText(this)" style="padding:4px 8px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:4px;color:#ff4d4d;cursor:pointer;font-size:11px;">Clear</button>
        </div>
      </div>
      <textarea id="gp-text" rows="8" placeholder="Paste or type your text here..."
                style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-family:inherit;resize:vertical;"></textarea>
    </div>
  </div>

  <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
    <button type="button" onclick="gpCheckGrammar(this)" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      üîç Check Grammar
    </button>
    <button type="button" onclick="gpApplyAll(this)"
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1));border:1px solid rgba(57,255,20,0.4);border-radius:8px;color:#39ff14;cursor:pointer;font-weight:600;">
      ‚úÖ Apply All Fixes
    </button>
    <button type="button" onclick="gpResetForm(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset All
    </button>
  </div>

  <div style="margin-top:16px;display:flex;gap:16px;flex-wrap:wrap;align-items:center;">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input id="gp-show-explanations" type="checkbox" checked 
             style="transform:scale(1.1);accent-color:var(--accent);" />
      <span style="color:rgba(230,250,255,0.9);font-size:13px;">Show explanations</span>
    </label>
    
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input id="gp-auto-check" type="checkbox"
             style="transform:scale(1.1);accent-color:var(--accent);" />
      <span style="color:rgba(230,250,255,0.9);font-size:13px;">Auto-check on paste</span>
    </label>
    
    <div style="margin-left:auto;display:flex;align-items:center;gap:6px;">
      <span style="color:rgba(230,250,255,0.7);font-size:12px;">Check level:</span>
      <select id="gp-check-level" style="padding:4px 8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:12px;">
        <option value="basic">Basic</option>
        <option value="standard" selected>Standard</option>
        <option value="strict">Strict</option>
      </select>
    </div>
  </div>
</form>

<div aria-live="polite" style="margin-top:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:8px;">üìä Analysis Results</h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:16px;">
    <div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;text-align:center;">
      <div style="color:var(--accent);font-size:24px;font-weight:600;" id="gp-total-issues">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Total Issues</div>
    </div>
    <div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:8px;text-align:center;">
      <div style="color:#ffcc00;font-size:24px;font-weight:600;" id="gp-grammar-issues">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Grammar</div>
    </div>
    <div style="padding:12px;background:rgba(255,107,157,0.05);border-radius:8px;text-align:center;">
      <div style="color:#ff6b9d;font-size:24px;font-weight:600;" id="gp-spelling-issues">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Spelling</div>
    </div>
    <div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:8px;text-align:center;">
      <div style="color:#9d4edd;font-size:24px;font-weight:600;" id="gp-style-issues">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Style</div>
    </div>
  </div>
</div>

<div aria-live="polite" style="margin-top:20px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:0;">üîß Suggestions & Fixes</h3>
    <div style="display:flex;gap:8px;">
      <button onclick="gpSortBy('severity')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;">Sort by Severity</button>
      <button onclick="gpSortBy('type')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;">Sort by Type</button>
    </div>
  </div>
  
  <div id="gp-suggestions-list" style="max-height:400px;overflow-y:auto;padding-right:8px;">
    <!-- Suggestions will appear here -->
    <div style="padding:30px;text-align:center;color:rgba(230,250,255,0.5);font-style:italic;">
      No text checked yet. Paste or type text above and click "Check Grammar".
    </div>
  </div>
</div>

<div style="margin-top:20px;padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.2);">
  <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;">üìñ Common Grammar Rules</h4>
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;font-size:13px;">
    <div>
      <div style="color:#ff6b9d;font-weight:600;margin-bottom:4px;">its vs. it's</div>
      <div style="color:rgba(230,250,255,0.8);">"its" = possessive (the dog chased its tail). "it's" = contraction for "it is" or "it has".</div>
    </div>
    <div>
      <div style="color:#ffcc00;font-weight:600;margin-bottom:4px;">your vs. you're</div>
      <div style="color:rgba(230,250,255,0.8);">"your" = possessive (your book). "you're" = contraction for "you are".</div>
    </div>
    <div>
      <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">their/there/they're</div>
      <div style="color:rgba(230,250,255,0.8);">"their" = possessive. "there" = location. "they're" = contraction for "they are".</div>
    </div>
    <div>
      <div style="color:#9d4edd;font-weight:600;margin-bottom:4px;">then vs. than</div>
      <div style="color:rgba(230,250,255,0.8);">"then" = time sequence. "than" = comparison (better than, more than).</div>
    </div>
  </div>
</div>

<div id="gp-toast" style="position:fixed;top:20px;right:20px;padding:12px 16px;background:rgba(20,20,20,0.95);border-radius:8px;border:1px solid var(--accent);z-index:10000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
  <div style="display:flex;align-items:center;gap:8px;">
    <div style="color:var(--accent);font-size:18px;">‚úÖ</div>
    <div>
      <div style="color:var(--accent);font-weight:600;font-size:14px;" id="gp-toast-title">Success</div>
      <div id="gp-toast-message" style="color:rgba(230,250,255,0.9);font-size:13px;"></div>
    </div>
    <button onclick="document.getElementById('gp-toast').style.display='none'" 
            style="margin-left:12px;background:transparent;border:none;color:rgba(230,250,255,0.7);cursor:pointer;">‚úï</button>
  </div>
</div>

<script>
/* grammar-proofreader.html
   - Grammar checking and proofreading tool
   - Scoped with gp- prefix
*/

// Issue type definitions
const issueTypes = {
  'grammar': { emoji: 'üîß', color: '#ffcc00', label: 'Grammar' },
  'spelling': { emoji: 'üî†', color: '#ff6b9d', label: 'Spelling' },
  'punctuation': { emoji: '‚è∏Ô∏è', color: '#39ff14', label: 'Punctuation' },
  'style': { emoji: 'üé®', color: '#9d4edd', label: 'Style' },
  'clarity': { emoji: '‚ú®', color: '#2dd4ff', label: 'Clarity' }
};

// Severity levels
const severityLevels = {
  'critical': { emoji: 'üî¥', color: '#ff4d4d', label: 'Critical' },
  'major': { emoji: 'üü†', color: '#ff9500', label: 'Major' },
  'minor': { emoji: 'üü°', color: '#ffcc00', label: 'Minor' },
  'suggestion': { emoji: 'üîµ', color: '#2dd4ff', label: 'Suggestion' }
};

// Common grammar rules and patterns
const grammarPatterns = [
  {
    pattern: /\bits\b(?=\s+(?:is|was|has|will|should|not|n't))/gi,
    replacement: "it's",
    type: 'grammar',
    severity: 'major',
    message: "Use \"it's\" (contraction of 'it is' or 'it has') here",
    explanation: "\"it's\" is a contraction meaning \"it is\" or \"it has\". Use \"its\" for possession."
  },
  {
    pattern: /\bit's\b(?=\s+(?:[a-z]+)(?:\s+[a-z]+)*(?:\s+(?:of|for|to))?)/gi,
    test: (match, context) => {
      // Check if "it's" is being used as possessive incorrectly
      const after = context.slice(context.indexOf(match) + match.length, context.indexOf(match) + match.length + 20);
      const nextWords = after.trim().split(/\s+/)[0];
      // If followed by a noun, might be possessive
      return /^(book|car|house|color|size|name|type|kind|version)/i.test(nextWords);
    },
    replacement: "its",
    type: 'grammar',
    severity: 'major',
    message: "Use \"its\" (possessive) instead of \"it's\" here",
    explanation: "\"its\" shows possession. \"it's\" is only for \"it is\" or \"it has\"."
  },
  {
    pattern: /\byour\b(?=\s+(?:going|doing|thinking|feeling|looking|saying|reading|writing))/gi,
    replacement: "you're",
    type: 'grammar',
    severity: 'major',
    message: "Use \"you're\" (contraction of 'you are') before a verb",
    explanation: "\"you're\" means \"you are\". Use \"your\" for possession."
  },
  {
    pattern: /\byoure\b/gi,
    replacement: "you're",
    type: 'spelling',
    severity: 'minor',
    message: "Correct spelling: \"you're\" (you are)",
    explanation: "\"you're\" is the contraction of \"you are\". \"youre\" is incorrect."
  },
  {
    pattern: /\btheir\b(?=\s+(?:are|were|have|had))/gi,
    replacement: "they're",
    type: 'grammar',
    severity: 'major',
    message: "Use \"they're\" (they are) instead of \"their\" here",
    explanation: "\"they're\" = they are. \"their\" = possessive. \"there\" = location."
  },
  {
    pattern: /\bthen\b(?=\s+(?:more|less|better|worse|rather|other))/gi,
    replacement: "than",
    type: 'grammar',
    severity: 'major',
    message: "Use \"than\" for comparisons",
    explanation: "\"than\" is used for comparisons. \"then\" refers to time sequence."
  },
  {
    pattern: / {2,}/g,
    replacement: " ",
    type: 'punctuation',
    severity: 'minor',
    message: "Replace multiple spaces with a single space",
    explanation: "Use only one space between words and after punctuation."
  },
  {
    pattern: /([.!?])([A-Za-z])/g,
    replacement: "$1 $2",
    type: 'punctuation',
    severity: 'minor',
    message: "Add space after punctuation",
    explanation: "Always put a space after periods, question marks, and exclamation marks."
  },
  {
    pattern: /\s+([,.;:])/g,
    replacement: "$1",
    type: 'punctuation',
    severity: 'minor',
    message: "Remove space before punctuation",
    explanation: "Don't put spaces before commas, periods, semicolons, or colons."
  },
  {
    pattern: /\b([a-z]+) \1\b/gi,
    replacement: "$1",
    type: 'grammar',
    severity: 'minor',
    message: "Remove repeated word",
    explanation: "The same word appears twice consecutively."
  },
  {
    pattern: /(\s|^)i(\s|[.,!?;:])/g,
    replacement: "$1I$2",
    type: 'grammar',
    severity: 'minor',
    message: "Capitalize the pronoun \"I\"",
    explanation: "Always capitalize the pronoun \"I\" when referring to yourself."
  },
  // Common misspellings
  {
    pattern: /\bseperate\b/gi,
    replacement: "separate",
    type: 'spelling',
    severity: 'minor',
    message: "Correct spelling: \"separate\"",
    explanation: "\"Separate\" is often misspelled as \"seperate\"."
  },
  {
    pattern: /\bdefinately\b/gi,
    replacement: "definitely",
    type: 'spelling',
    severity: 'minor',
    message: "Correct spelling: \"definitely\"",
    explanation: "\"Definitely\" is often misspelled as \"definately\"."
  },
  {
    pattern: /\brecieve\b/gi,
    replacement: "receive",
    type: 'spelling',
    severity: 'minor',
    message: "Correct spelling: \"receive\" (i before e except after c)",
    explanation: "Remember: i before e except after c."
  },
  // Contractions
  {
    pattern: /\bdont\b/gi,
    replacement: "don't",
    type: 'spelling',
    severity: 'minor',
    message: "Use contraction: \"don't\"",
    explanation: "\"don't\" is the contraction of \"do not\"."
  },
  {
    pattern: /\bdoesnt\b/gi,
    replacement: "doesn't",
    type: 'spelling',
    severity: 'minor',
    message: "Use contraction: \"doesn't\"",
    explanation: "\"doesn't\" is the contraction of \"does not\"."
  },
  {
    pattern: /\bwont\b/gi,
    replacement: "won't",
    type: 'spelling',
    severity: 'minor',
    message: "Use contraction: \"won't\"",
    explanation: "\"won't\" is the contraction of \"will not\"."
  }
];

// Example texts
const exampleTexts = [
  "Their going to the park later, but your not comming with us. Its fine though, your probably busy then we are. I think your friend should come to.",
  "The dog chased it's tail around in circles. Its funny to watch, but sometimes it gets dizzy. Your right, its probably not good for the dog.",
  "I went too the store yesterday and bought some apples. There more expensive then I expected, but their still tasty. Your going too love them!",
  "Weather your a student or a profesional writer, good grammar is important. Its not just about following rules, its about communicating clearly."
];

let currentIssues = [];
let currentSort = 'severity';

// Clear text
function gpClearText(btn) {
  const card = btn.closest('.card') || document;
  card.querySelector('#gp-text').value = '';
  gpResetResults();
  gpShowToast('Text cleared', 'success');
}

// Paste example
function gpPasteExample(btn) {
  const card = btn.closest('.card') || document;
  const textArea = card.querySelector('#gp-text');
  const randomExample = exampleTexts[Math.floor(Math.random() * exampleTexts.length)];
  textArea.value = randomExample;
  
  if (card.querySelector('#gp-auto-check').checked) {
    setTimeout(() => gpCheckGrammar(btn), 100);
  }
  
  gpShowToast('Example text loaded', 'info');
}

// Reset form
function gpResetForm(btn) {
  const card = btn.closest('.card') || document;
  card.querySelector('#gp-text').value = '';
  gpResetResults();
  gpShowToast('All settings reset', 'info');
}

// Reset results
function gpResetResults() {
  document.getElementById('gp-total-issues').textContent = '0';
  document.getElementById('gp-grammar-issues').textContent = '0';
  document.getElementById('gp-spelling-issues').textContent = '0';
  document.getElementById('gp-style-issues').textContent = '0';
  
  const list = document.getElementById('gp-suggestions-list');
  list.innerHTML = `
    <div style="padding:30px;text-align:center;color:rgba(230,250,255,0.5);font-style:italic;">
      No text checked yet. Paste or type text above and click "Check Grammar".
    </div>
  `;
}

// Check grammar
function gpCheckGrammar(btn) {
  const card = btn.closest('.card') || document;
  const text = card.querySelector('#gp-text').value.trim();
  const showExplanations = card.querySelector('#gp-show-explanations').checked;
  const checkLevel = card.querySelector('#gp-check-level').value;
  
  if (!text) {
    gpShowToast('Please enter some text to check', 'error');
    return;
  }
  
  currentIssues = analyzeText(text, checkLevel);
  
  // Update statistics
  const grammarCount = currentIssues.filter(i => i.type === 'grammar').length;
  const spellingCount = currentIssues.filter(i => i.type === 'spelling').length;
  const styleCount = currentIssues.filter(i => i.type === 'style' || i.type === 'clarity').length;
  
  document.getElementById('gp-total-issues').textContent = currentIssues.length;
  document.getElementById('gp-grammar-issues').textContent = grammarCount;
  document.getElementById('gp-spelling-issues').textContent = spellingCount;
  document.getElementById('gp-style-issues').textContent = styleCount;
  
  // Render suggestions
  gpRenderSuggestions(currentIssues, showExplanations);
  
  gpShowToast(`Found ${currentIssues.length} issues`, 'success');
}

// Analyze text
function analyzeText(text, level) {
  const issues = [];
  
  grammarPatterns.forEach(pattern => {
    const regex = new RegExp(pattern.pattern.source, 'g' + (pattern.pattern.flags || ''));
    let match;
    
    while ((match = regex.exec(text)) !== null) {
      // Apply severity filter based on check level
      if (level === 'basic' && pattern.severity !== 'critical') continue;
      if (level === 'standard' && pattern.severity === 'suggestion') continue;
      
      // Run test function if provided
      if (pattern.test && !pattern.test(match[0], text)) continue;
      
      const startIndex = match.index;
      const originalText = match[0];
      const replacement = typeof pattern.replacement === 'function' 
        ? pattern.replacement(match, text) 
        : match[0].replace(pattern.pattern, pattern.replacement);
      
      issues.push({
        id: Date.now() + Math.random(),
        startIndex,
        length: originalText.length,
        original: originalText,
        replacement,
        type: pattern.type,
        severity: pattern.severity,
        message: pattern.message,
        explanation: pattern.explanation,
        context: getContext(text, startIndex, originalText.length)
      });
    }
  });
  
  // Additional checks
  checkSentenceCapitalization(text, issues, level);
  checkPunctuation(text, issues, level);
  checkWordiness(text, issues, level);
  
  // Remove duplicates (same position and type)
  const uniqueIssues = [];
  const seen = new Set();
  
  issues.forEach(issue => {
    const key = `${issue.startIndex}:${issue.type}:${issue.original}`;
    if (!seen.has(key)) {
      uniqueIssues.push(issue);
      seen.add(key);
    }
  });
  
  return uniqueIssues.sort((a, b) => a.startIndex - b.startIndex);
}

// Helper functions
function getContext(text, start, length) {
  const contextStart = Math.max(0, start - 20);
  const contextEnd = Math.min(text.length, start + length + 20);
  return text.substring(contextStart, contextEnd);
}

function checkSentenceCapitalization(text, issues, level) {
  if (level === 'basic') return;
  
  const sentenceRegex = /(^|[.!?]\s+)([a-z])/g;
  let match;
  
  while ((match = sentenceRegex.exec(text)) !== null) {
    const startIndex = match.index + match[1].length;
    issues.push({
      id: Date.now() + Math.random(),
      startIndex,
      length: 1,
      original: match[2],
      replacement: match[2].toUpperCase(),
      type: 'grammar',
      severity: 'minor',
      message: "Capitalize first letter of sentence",
      explanation: "The first word of a sentence should start with a capital letter.",
      context: getContext(text, startIndex, 1)
    });
  }
}

function checkPunctuation(text, issues, level) {
  if (level === 'basic') return;
  
  // Check for missing punctuation at sentence ends
  const sentences = text.split(/(?<=[.!?])\s+/);
  let currentPos = 0;
  
  sentences.forEach(sentence => {
    if (sentence.trim() && !/[.!?]$/.test(sentence)) {
      const lastWord = sentence.split(/\s+/).pop();
      const pos = currentPos + sentence.length - lastWord.length;
      
      issues.push({
        id: Date.now() + Math.random(),
        startIndex: pos,
        length: lastWord.length,
        original: lastWord,
        replacement: lastWord + '.',
        type: 'punctuation',
        severity: 'suggestion',
        message: "Consider adding punctuation at sentence end",
        explanation: "Sentences should end with a period, question mark, or exclamation point.",
        context: getContext(text, pos, lastWord.length)
      });
    }
    currentPos += sentence.length + 1;
  });
}

function checkWordiness(text, issues, level) {
  if (level !== 'strict') return;
  
  const wordyPhrases = [
    { phrase: 'due to the fact that', suggestion: 'because', type: 'style' },
    { phrase: 'in order to', suggestion: 'to', type: 'style' },
    { phrase: 'at this point in time', suggestion: 'now', type: 'style' },
    { phrase: 'in the event that', suggestion: 'if', type: 'style' },
    { phrase: 'very unique', suggestion: 'unique', type: 'clarity' }
  ];
  
  wordyPhrases.forEach(({ phrase, suggestion, type }) => {
    const regex = new RegExp(`\\b${phrase}\\b`, 'gi');
    let match;
    
    while ((match = regex.exec(text)) !== null) {
      issues.push({
        id: Date.now() + Math.random(),
        startIndex: match.index,
        length: match[0].length,
        original: match[0],
        replacement: suggestion,
        type,
        severity: 'suggestion',
        message: `Consider using "${suggestion}" instead of "${phrase}"`,
        explanation: `"${suggestion}" is more concise than "${phrase}".`,
        context: getContext(text, match.index, match[0].length)
      });
    }
  });
}

// Render suggestions
function gpRenderSuggestions(issues, showExplanations) {
  const list = document.getElementById('gp-suggestions-list');
  
  if (issues.length === 0) {
    list.innerHTML = `
      <div style="padding:30px;text-align:center;color:rgba(230,250,255,0.5);font-style:italic;">
        ‚úÖ No issues found! Your text looks good.
      </div>
    `;
    return;
  }
  
  // Sort issues
  let sortedIssues = [...issues];
  if (currentSort === 'severity') {
    const severityOrder = { 'critical': 0, 'major': 1, 'minor': 2, 'suggestion': 3 };
    sortedIssues.sort((a, b) => severityOrder[a.severity] - severityOrder[b.severity]);
  } else if (currentSort === 'type') {
    sortedIssues.sort((a, b) => a.type.localeCompare(b.type));
  }
  
  let html = '';
  sortedIssues.forEach(issue => {
    const type = issueTypes[issue.type] || issueTypes.grammar;
    const severity = severityLevels[issue.severity] || severityLevels.minor;
    const contextText = issue.context.length > 60 
      ? '...' + issue.context.substring(0, 60) + '...' 
      : issue.context;
    
    html += `
      <div class="suggestion-item" data-id="${issue.id}" 
           style="background:rgba(255,255,255,0.03);border-left:3px solid ${type.color};margin-bottom:12px;padding:12px;border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span style="font-size:16px;">${type.emoji}</span>
              <div style="font-weight:600;color:var(--accent);font-size:14px;">${issue.message}</div>
              <span style="color:${severity.color};background:${severity.color}20;padding:2px 8px;border-radius:12px;font-size:11px;">
                ${severity.emoji} ${severity.label}
              </span>
            </div>
            <div style="display:flex;gap:12px;margin-top:4px;font-size:13px;">
              <span style="color:rgba(230,250,255,0.8);">
                "${issue.original}" ‚Üí "${issue.replacement}"
              </span>
            </div>
          </div>
          <div style="display:flex;gap:4px;">
            <button onclick="gpApplySuggestion('${issue.id}')" style="background:transparent;border:none;color:#39ff14;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;">Apply</button>
            <button onclick="gpIgnoreSuggestion('${issue.id}')" style="background:transparent;border:none;color:#ff4d4d;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;">Ignore</button>
          </div>
        </div>
        
        <div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:6px;">
          <div style="color:rgba(230,250,255,0.7);font-size:12px;margin-bottom:4px;">Context:</div>
          <div style="color:rgba(230,250,255,0.9);font-size:12px;font-family:monospace;">${contextText}</div>
        </div>
        
        ${showExplanations ? `
          <div style="margin-top:8px;padding:8px 12px;background:rgba(45,212,255,0.1);border-radius:6px;">
            <div style="color:var(--accent);font-weight:600;font-size:12px;margin-bottom:2px;">Explanation:</div>
            <div style="color:rgba(230,250,255,0.8);font-size:12px;">${issue.explanation}</div>
          </div>
        ` : ''}
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// Sort suggestions
function gpSortBy(sortType) {
  currentSort = sortType;
  const showExplanations = document.querySelector('#gp-show-explanations').checked;
  gpRenderSuggestions(currentIssues, showExplanations);
}

// Apply a single suggestion
function gpApplySuggestion(issueId) {
  const card = document.currentScript?.closest('.card') || document;
  const textArea = card.querySelector('#gp-text');
  const issue = currentIssues.find(i => i.id == issueId);
  
  if (!issue) return;
  
  let text = textArea.value;
  const before = text.substring(0, issue.startIndex);
  const after = text.substring(issue.startIndex + issue.length);
  text = before + issue.replacement + after;
  
  textArea.value = text;
  
  // Remove the applied issue
  currentIssues = currentIssues.filter(i => i.id != issueId);
  
  // Update display
  const showExplanations = card.querySelector('#gp-show-explanations').checked;
  gpRenderSuggestions(currentIssues, showExplanations);
  
  // Update stats
  const grammarCount = currentIssues.filter(i => i.type === 'grammar').length;
  const spellingCount = currentIssues.filter(i => i.type === 'spelling').length;
  const styleCount = currentIssues.filter(i => i.type === 'style' || i.type === 'clarity').length;
  
  document.getElementById('gp-total-issues').textContent = currentIssues.length;
  document.getElementById('gp-grammar-issues').textContent = grammarCount;
  document.getElementById('gp-spelling-issues').textContent = spellingCount;
  document.getElementById('gp-style-issues').textContent = styleCount;
  
  gpShowToast('Suggestion applied', 'success');
}

// Ignore a suggestion
function gpIgnoreSuggestion(issueId) {
  const card = document.currentScript?.closest('.card') || document;
  currentIssues = currentIssues.filter(i => i.id != issueId);
  
  const showExplanations = card.querySelector('#gp-show-explanations').checked;
  gpRenderSuggestions(currentIssues, showExplanations);
  
  // Update stats
  const grammarCount = currentIssues.filter(i => i.type === 'grammar').length;
  const spellingCount = currentIssues.filter(i => i.type === 'spelling').length;
  const styleCount = currentIssues.filter(i => i.type === 'style' || i.type === 'clarity').length;
  
  document.getElementById('gp-total-issues').textContent = currentIssues.length;
  document.getElementById('gp-grammar-issues').textContent = grammarCount;
  document.getElementById('gp-spelling-issues').textContent =
