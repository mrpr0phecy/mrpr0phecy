<!-- cards/battery-sizing.html -->
<h2 id="battery-sizing-title">Battery Sizing Calculator</h2>

<div class="description">
  Calculate battery capacity for your power needs.
  <span class="disclaimer">‚ö†Ô∏è Educational tool only ‚Äî always consult professionals.</span>
</div>

<div class="tool-body">
  <!-- üîã POWER INPUT SECTION -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
    <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 15px;">‚ö° Enter Your Power Requirements:</div>
    
    <!-- POWER INPUTS -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <div>
        <label for="bs-load" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #ffa500;">Load Power (W)</span>
          <button type="button" onclick="bsShowExample('load')" style="margin-left: 6px; background: none; border: none; color: #2dd4ff; cursor: help; font-size: 12px;">?</button>
        </label>
        <div style="display: flex; align-items: center;">
          <input type="number" id="bs-load" placeholder="e.g., 100" min="1"
                 style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(255,165,0,0.3); background: rgba(255,165,0,0.05); color: #e6faff; font-size: 16px;">
          <div style="margin-left: 8px; color: rgba(255,165,0,0.8); white-space: nowrap;">Watts</div>
        </div>
        <div id="bs-load-example" style="display: none; margin-top: 6px; color: rgba(255,165,0,0.7); font-size: 13px; background: rgba(255,165,0,0.1); padding: 6px; border-radius: 4px;">
          Examples: LED light (10W), Laptop (60W), Mini fridge (100W), TV (150W)
        </div>
      </div>
      
      <div>
        <label for="bs-voltage" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #2dd4ff;">System Voltage (V)</span>
          <button type="button" onclick="bsShowExample('voltage')" style="margin-left: 6px; background: none; border: none; color: #2dd4ff; cursor: help; font-size: 12px;">?</button>
        </label>
        <div style="display: flex; align-items: center;">
          <input type="number" id="bs-voltage" placeholder="e.g., 12" min="1.5" step="0.1"
                 style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(45,212,255,0.3); background: rgba(45,212,255,0.05); color: #e6faff; font-size: 16px;">
          <div style="margin-left: 8px; color: rgba(45,212,255,0.8); white-space: nowrap;">Volts</div>
        </div>
        <div id="bs-voltage-example" style="display: none; margin-top: 6px; color: rgba(45,212,255,0.7); font-size: 13px; background: rgba(45,212,255,0.1); padding: 6px; border-radius: 4px;">
          Common: Car battery (12V), Solar system (12/24/48V), AA battery (1.5V), USB (5V)
        </div>
      </div>
    </div>
    
    <!-- RUNTIME & EFFICIENCY -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
      <div>
        <label for="bs-runtime" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #39ff14;">Desired Runtime (hours)</span>
          <button type="button" onclick="bsShowExample('runtime')" style="margin-left: 6px; background: none; border: none; color: #2dd4ff; cursor: help; font-size: 12px;">?</button>
        </label>
        <div style="display: flex; align-items: center;">
          <input type="number" id="bs-runtime" placeholder="e.g., 5" min="0.1" step="0.1"
                 style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(57,255,20,0.3); background: rgba(57,255,20,0.05); color: #e6faff; font-size: 16px;">
          <div style="margin-left: 8px; color: rgba(57,255,20,0.8); white-space: nowrap;">Hours</div>
        </div>
        <div id="bs-runtime-example" style="display: none; margin-top: 6px; color: rgba(57,255,20,0.7); font-size: 13px; background: rgba(57,255,20,0.1); padding: 6px; border-radius: 4px;">
          Examples: Overnight (8h), Weekend trip (48h), Emergency backup (24h)
        </div>
      </div>
      
      <div>
        <label for="bs-eff" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #9d4edd;">System Efficiency (%)</span>
          <button type="button" onclick="bsShowExample('efficiency')" style="margin-left: 6px; background: none; border: none; color: #2dd4ff; cursor: help; font-size: 12px;">?</button>
        </label>
        <div style="display: flex; align-items: center; gap: 10px;">
          <input type="range" id="bs-eff-slider" min="50" max="100" value="85" step="1"
                 style="flex: 1; height: 6px; border-radius: 3px; background: linear-gradient(to right, #ff4d4d, #ffa500, #39ff14); outline: none;">
          <input type="number" id="bs-eff" value="85" min="50" max="100" step="1"
                 style="width: 70px; padding: 8px; border-radius: 6px; border: 1px solid rgba(157,78,221,0.3); background: rgba(157,78,221,0.1); color: #e6faff; text-align: center;">
          <div style="color: rgba(157,78,221,0.8); white-space: nowrap;">%</div>
        </div>
        <div id="bs-efficiency-example" style="display: none; margin-top: 6px; color: rgba(157,78,221,0.7); font-size: 13px; background: rgba(157,78,221,0.1); padding: 6px; border-radius: 4px;">
          85% typical for good systems, 70% for basic, 95% for high-end
        </div>
      </div>
    </div>
    
    <!-- SAFETY MARGIN -->
    <div style="margin-top: 20px;">
      <label for="bs-safety-toggle" style="display: flex; align-items: center; gap: 10px; cursor: pointer; color: rgba(230,250,255,0.8);">
        <input type="checkbox" id="bs-safety-toggle" checked style="cursor: pointer;">
        <div>
          <div style="font-weight: 600; color: #ffcc00;">Add 20% Safety Margin</div>
          <div style="font-size: 13px; color: rgba(230,250,255,0.6);">Accounts for battery aging, temperature, and discharge limits</div>
        </div>
      </label>
    </div>
  </div>
  
  <!-- üöÄ QUICK EXAMPLES -->
  <div style="margin-bottom: 25px;">
    <div style="color: rgba(230,250,255,0.8); margin-bottom: 10px; font-size: 14px;">Quick Examples:</div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="bs-example-btn" data-load="10" data-voltage="12" data-runtime="8" data-efficiency="85" 
              style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; color: #e6faff; font-size: 13px;">
        üí° LED Light (10W, 12V, 8h)
      </button>
      <button class="bs-example-btn" data-load="60" data-voltage="19" data-runtime="4" data-efficiency="85"
              style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; color: #e6faff; font-size: 13px;">
        üíª Laptop (60W, 19V, 4h)
      </button>
      <button class="bs-example-btn" data-load="100" data-voltage="12" data-runtime="24" data-efficiency="80"
              style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; color: #e6faff; font-size: 13px;">
        üöó Car Fridge (100W, 12V, 24h)
      </button>
      <button class="bs-example-btn" data-load="300" data-voltage="24" data-runtime="10" data-efficiency="90"
              style="padding: 8px 12px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 6px; cursor: pointer; color: #e6faff; font-size: 13px;">
        ‚òÄÔ∏è Solar System (300W, 24V, 10h)
      </button>
    </div>
  </div>
  
  <!-- üöÄ CALCULATE BUTTON -->
  <div style="text-align: center; margin: 25px 0;">
    <button id="bs-calculate-btn" 
            style="background: #2dd4ff; color: #000; border: none; padding: 14px 32px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 15px rgba(45,212,255,0.3);">
      üîã CALCULATE BATTERY SIZE
    </button>
    
    <button id="bs-reset-btn" 
            style="background: rgba(255,255,255,0.08); color: #e6faff; border: 1px solid rgba(255,255,255,0.2); padding: 14px 24px; border-radius: 10px; cursor: pointer; font-size: 16px; margin-left: 12px;">
      Reset
    </button>
  </div>
  
  <!-- üìä RESULTS DISPLAY -->
  <div id="bs-results" style="display: none;">
    <div style="background: rgba(20,20,20,0.7); border-radius: 10px; padding: 25px; border: 1px solid rgba(57,255,20,0.2); margin-bottom: 25px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div style="color: #39ff14; font-size: 18px; font-weight: 600;">üîã Battery Calculation Results</div>
        <button id="bs-copy-btn" 
                style="background: rgba(57,255,20,0.1); color: #39ff14; border: 1px solid rgba(57,255,20,0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          Copy Results
        </button>
      </div>
      
      <div id="bs-result-display" style="font-size: 20px; color: #39ff14; text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
        <!-- Results appear here -->
      </div>
      
      <div id="bs-interpretation" style="color: #e6faff; font-size: 15px; line-height: 1.6; padding: 15px; background: rgba(30,30,30,0.5); border-radius: 8px;">
        <!-- Interpretation appears here -->
      </div>
    </div>
  </div>
  
  <!-- ‚ö†Ô∏è SAFETY & FACTS -->
  <div id="bs-safety-info" style="margin-top: 20px; display: block;">
    <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; border: 1px solid rgba(255,165,0,0.2);">
      <div style="color: #ffa500; font-weight: 600; margin-bottom: 15px; font-size: 16px;">
        ‚ö†Ô∏è Important Battery Safety & Facts
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: rgba(255,165,0,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #ffa500;">
          <div style="color: #ffa500; font-weight: 600; margin-bottom: 5px;">Formula: Ah = (W √ó h) / (V √ó Efficiency)</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Amp-hours = (Watts √ó Hours) √∑ (Volts √ó Efficiency)</div>
        </div>
        
        <div style="background: rgba(255,77,77,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #ff4d4d;">
          <div style="color: #ff4d4d; font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è Critical Safety</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">‚Ä¢ Always consult qualified electricians<br>‚Ä¢ Follow manufacturer datasheets<br>‚Ä¢ Comply with local electrical codes</div>
        </div>
        
        <div style="background: rgba(30,144,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #1e90ff;">
          <div style="color: #1e90ff; font-weight: 600; margin-bottom: 5px;">Battery Types</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">‚Ä¢ Lead-acid: Cheap, heavy, 50% DoD<br>‚Ä¢ Lithium: Light, expensive, 80% DoD<br>‚Ä¢ Deep-cycle: Best for long runtime</div>
        </div>
        
        <div style="background: rgba(57,255,20,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #39ff14;">
          <div style="color: #39ff14; font-weight: 600; margin-bottom: 5px;">Pro Tips</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">‚Ä¢ Add 20-30% safety margin<br>‚Ä¢ Consider temperature effects<br>‚Ä¢ Factor in battery aging<br>‚Ä¢ Include inverter losses</div>
        </div>
      </div>
      
      <div style="margin-top: 15px; padding: 10px; background: rgba(255,165,0,0.1); border-radius: 6px; border: 1px solid rgba(255,165,0,0.3);">
        <div style="color: #ffa500; font-weight: 600; font-size: 14px;">Disclaimer:</div>
        <div style="color: rgba(255,165,0,0.9); font-size: 13px; margin-top: 4px;">
          This tool provides educational estimates only. Actual battery sizing requires professional engineering review. Always verify with manufacturer specifications and local regulations.
        </div>
      </div>
    </div>
  </div>
  
  <!-- üö® ERROR MESSAGE -->
  <div id="bs-error" style="margin-top: 20px; padding: 15px; background: rgba(255,77,77,0.1); border-radius: 8px; border: 1px solid rgba(255,77,77,0.3); display: none;">
    <div style="color: #ff4d4d; font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è Please check your inputs</div>
    <div id="bs-error-text" style="color: rgba(255,77,77,0.9);"></div>
  </div>
</div>

<style>
#battery-sizing-title { 
  color: #2dd4ff; 
  margin-top: 0;
  margin-bottom: 10px;
}

.description {
  color: rgba(230,250,255,0.8);
  margin-bottom: 20px;
  font-size: 14px;
}

.disclaimer {
  display: block;
  color: rgba(255,165,0,0.8);
  font-size: 12px;
  margin-top: 5px;
  font-style: italic;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .bs-example-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
  
  #bs-calculate-btn, #bs-reset-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
}
</style>

<script>
// ============================================
// BATTERY SIZING CALCULATOR - PROPERLY SCOPED
// All functions prefixed with "bs" (battery sizing)
// ============================================

let bsExampleActive = null;

// Initialize the tool
function bsInit() {
    console.log("Battery Sizing Calculator: Initializing...");
    
    // Efficiency slider and input synchronization
    const effSlider = document.getElementById('bs-eff-slider');
    const effInput = document.getElementById('bs-eff');
    
    effSlider.addEventListener('input', function() {
        effInput.value = this.value;
    });
    
    effInput.addEventListener('input', function() {
        let value = parseInt(this.value);
        if (value < 50) value = 50;
        if (value > 100) value = 100;
        this.value = value;
        effSlider.value = value;
    });
    
    // Example buttons
    const exampleBtns = document.querySelectorAll('.bs-example-btn');
    exampleBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            const load = this.dataset.load;
            const voltage = this.dataset.voltage;
            const runtime = this.dataset.runtime;
            const efficiency = this.dataset.efficiency;
            
            document.getElementById('bs-load').value = load;
            document.getElementById('bs-voltage').value = voltage;
            document.getElementById('bs-runtime').value = runtime;
            document.getElementById('bs-eff').value = efficiency;
            effSlider.value = efficiency;
            
            // Visual feedback
            exampleBtns.forEach(b => {
                b.style.background = 'rgba(255,255,255,0.05)';
                b.style.border = '1px solid rgba(255,255,255,0.1)';
            });
            this.style.background = 'rgba(45,212,255,0.15)';
            this.style.border = '1px solid #2dd4ff';
            
            bsExampleActive = this;
            bsClearResults();
        });
    });
    
    // Calculate button
    document.getElementById('bs-calculate-btn').addEventListener('click', bsCalculate);
    
    // Reset button
    document.getElementById('bs-reset-btn').addEventListener('click', bsReset);
    
    // Copy button
    document.getElementById('bs-copy-btn').addEventListener('click', bsCopyResult);
    
    // Enter key support
    const allInputs = document.querySelectorAll('#bs-load, #bs-voltage, #bs-runtime, #bs-eff');
    allInputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                bsCalculate();
            }
        });
    });
    
    // Set default values
    bsSetDefaultValues();
    
    console.log("‚úÖ Battery Sizing Calculator ready!");
}

// Set default values
function bsSetDefaultValues() {
    document.getElementById('bs-load').value = '100';
    document.getElementById('bs-voltage').value = '12';
    document.getElementById('bs-runtime').value = '5';
    document.getElementById('bs-eff').value = '85';
    document.getElementById('bs-eff-slider').value = '85';
    document.getElementById('bs-safety-toggle').checked = true;
}

// Show example help text
function bsShowExample(type) {
    const examples = document.querySelectorAll('[id^="bs-"][id$="-example"]');
    examples.forEach(div => div.style.display = 'none');
    
    const exampleDiv = document.getElementById(`bs-${type}-example`);
    if (exampleDiv) {
        exampleDiv.style.display = 'block';
        setTimeout(() => {
            exampleDiv.style.display = 'none';
        }, 5000);
    }
}

// Main calculation function
function bsCalculate() {
    console.log("Calculating battery size...");
    
    // Hide previous results/errors
    document.getElementById('bs-results').style.display = 'none';
    document.getElementById('bs-error').style.display = 'none';
    
    // Get inputs
    const P = parseFloat(document.getElementById('bs-load').value);
    const V = parseFloat(document.getElementById('bs-voltage').value);
    const t = parseFloat(document.getElementById('bs-runtime').value);
    const eff = parseFloat(document.getElementById('bs-eff').value) || 85;
    const addSafety = document.getElementById('bs-safety-toggle').checked;
    
    // Validate inputs
    if (!P || !V || !t || P <= 0 || V <= 0 || t <= 0) {
        bsShowError('Please enter valid power (W), voltage (V), and runtime (hours)');
        return;
    }
    
    if (eff < 50 || eff > 100) {
        bsShowError('Efficiency must be between 50% and 100%');
        return;
    }
    
    try {
        // Calculate basic Ah
        const Ah = (P * t) / (V * (eff / 100));
        
        // Calculate with safety margin
        const safetyFactor = addSafety ? 1.2 : 1.0;
        const AhSafe = Ah * safetyFactor;
        
        // Calculate energy in Wh and kWh
        const Wh = P * t;
        const kWh = Wh / 1000;
        
        // Prepare results
        let result = `Estimated Battery Capacity:\n`;
        result += `üîã Basic: ${Ah.toFixed(1)} Ah\n`;
        if (addSafety) {
            result += `üõ°Ô∏è With 20% safety: ${AhSafe.toFixed(1)} Ah\n`;
        }
        result += `‚ö° Energy needed: ${Wh.toFixed(0)} Wh (${kWh.toFixed(2)} kWh)`;
        
        // Prepare detailed interpretation
        let interpretation = `üìù Calculation Details:\n`;
        interpretation += `‚Ä¢ Load Power: ${P} W\n`;
        interpretation += `‚Ä¢ System Voltage: ${V} V\n`;
        interpretation += `‚Ä¢ Desired Runtime: ${t} hours\n`;
        interpretation += `‚Ä¢ System Efficiency: ${eff}%\n\n`;
        interpretation += `üßÆ Formula: Ah = (P √ó t) √∑ (V √ó Efficiency)\n`;
        interpretation += `            = (${P} √ó ${t}) √∑ (${V} √ó ${eff/100})\n`;
        interpretation += `            = ${Ah.toFixed(1)} Ah\n\n`;
        
        if (addSafety) {
            interpretation += `üõ°Ô∏è Safety margin (20%): ${Ah.toFixed(1)} √ó 1.2 = ${AhSafe.toFixed(1)} Ah\n\n`;
        }
        
        interpretation += `üí° Real-world considerations:\n`;
        interpretation += `‚Ä¢ Battery type affects usable capacity\n`;
        interpretation += `‚Ä¢ Temperature reduces capacity\n`;
        interpretation += `‚Ä¢ Inverters add additional losses\n`;
        interpretation += `‚Ä¢ Battery aging reduces capacity over time\n\n`;
        interpretation += `‚ö†Ô∏è Always consult manufacturer datasheets and qualified professionals for final sizing.`;
        
        // Display results
        document.getElementById('bs-result-display').innerHTML = result.replace(/\n/g, '<br>');
        document.getElementById('bs-interpretation').innerHTML = interpretation.replace(/\n/g, '<br>');
        document.getElementById('bs-results').style.display = 'block';
        
    } catch (error) {
        console.error('Calculation error:', error);
        bsShowError('Unable to calculate. Please check your inputs.');
    }
}

// Reset function
function bsReset() {
    bsSetDefaultValues();
    
    // Reset example buttons
    if (bsExampleActive) {
        bsExampleActive.style.background = 'rgba(255,255,255,0.05)';
        bsExampleActive.style.border = '1px solid rgba(255,255,255,0.1)';
        bsExampleActive = null;
    }
    
    document.querySelectorAll('.bs-example-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.border = '1px solid rgba(255,255,255,0.1)';
    });
    
    bsClearResults();
    
    // Focus on load input
    setTimeout(() => {
        document.getElementById('bs-load').focus();
        document.getElementById('bs-load').select();
    }, 50);
    
    console.log("Battery calculator reset");
}

// Clear results
function bsClearResults() {
    document.getElementById('bs-results').style.display = 'none';
    document.getElementById('bs-error').style.display = 'none';
}

// Copy result
function bsCopyResult() {
    const result = document.getElementById('bs-result-display').textContent;
    const interpretation = document.getElementById('bs-interpretation').textContent;
    const text = `Battery Sizing Calculator Results\n\n${result}\n\n${interpretation}`;
    
    navigator.clipboard.writeText(text).then(() => {
        const copyBtn = document.getElementById('bs-copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = 'rgba(57,255,20,0.2)';
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = '';
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}

// Show error
function bsShowError(message) {
    document.getElementById('bs-error-text').textContent = message;
    document.getElementById('bs-error').style.display = 'block';
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', bsInit);
} else {
    setTimeout(bsInit, 100);
}
</script>
