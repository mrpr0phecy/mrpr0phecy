// ============================================
// ANATOMY TOOLS - FIXED VERSION
// ============================================

// Global flag to prevent double initialization
let anatomyToolsInitialized = false;

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initAnatomyTools);

function initAnatomyTools() {
    if (anatomyToolsInitialized) return;
    anatomyToolsInitialized = true;
    
    console.log("Anatomy Tools: Initializing...");
    
    // Tool buttons
    const toolBtns = document.querySelectorAll('.anat-tool-btn');
    toolBtns.forEach(btn => {
        // Remove any existing listeners first
        const newBtn = btn.cloneNode(true);
        btn.parentNode.replaceChild(newBtn, btn);
    });
    
    // Re-select buttons after cloning
    const refreshedToolBtns = document.querySelectorAll('.anat-tool-btn');
    refreshedToolBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            // Update active button
            refreshedToolBtns.forEach(b => {
                b.style.background = 'rgba(255,255,255,0.05)';
                b.style.border = '1px solid rgba(255,255,255,0.1)';
                b.querySelector('div:first-child').style.color = '#e6faff';
                b.classList.remove('active');
            });
            
            this.style.background = 'rgba(45,212,255,0.2)';
            this.style.border = '2px solid #2dd4ff';
            this.querySelector('div:first-child').style.color = '#2dd4ff';
            this.classList.add('active');
            
            // Show corresponding inputs
            const tool = this.dataset.tool;
            document.querySelectorAll('.anat-inputs').forEach(input => {
                input.style.display = 'none';
            });
            
            if (tool === 'bmi') {
                document.getElementById('bmi-inputs').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('anat-weight').focus();
                }, 50);
            } else if (tool === 'bmr') {
                document.getElementById('bmr-inputs').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('bmr-weight').focus();
                }, 50);
            } else if (tool === 'blood') {
                document.getElementById('blood-inputs').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('blood-weight').focus();
                }, 50);
            }
            
            // Clear results
            clearAnatomyResults();
        });
    });
    
    // Calculate button
    const calcBtn = document.getElementById('anat-calculate-btn');
    calcBtn.addEventListener('click', calculateAnatomy);
    
    // Reset button
    const resetBtn = document.getElementById('anat-reset-btn');
    resetBtn.addEventListener('click', resetAnatomy);
    
    // Copy button
    const copyBtn = document.getElementById('anat-copy-btn');
    copyBtn.addEventListener('click', copyAnatomyResult);
    
    // Facts toggle
    const factsToggle = document.getElementById('anat-facts-toggle');
    factsToggle.addEventListener('change', function() {
        document.getElementById('anat-facts').style.display = this.checked ? 'block' : 'none';
    });
    
    // Enter key support for all inputs
    const allInputs = document.querySelectorAll('input[type="number"], input[type="text"], select');
    allInputs.forEach(input => {
        input.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                calculateAnatomy();
            }
        });
    });
    
    // Also allow clicking on input labels to focus
    const allLabels = document.querySelectorAll('label');
    allLabels.forEach(label => {
        const inputId = label.getAttribute('for');
        if (inputId) {
            label.style.cursor = 'pointer';
            label.addEventListener('click', function() {
                const input = document.getElementById(inputId);
                if (input) input.focus();
            });
        }
    });
    
    // Set default values
    setDefaultValues();
    
    // Make sure BMI is active initially
    const bmiBtn = document.getElementById('bmi-btn');
    if (bmiBtn && !bmiBtn.classList.contains('active')) {
        bmiBtn.click();
    }
    
    console.log("✅ Anatomy Tools ready!");
}

// Rest of the functions remain the same...
function setDefaultValues() {
    document.getElementById('anat-weight').value = '70';
    document.getElementById('anat-height').value = '1.75';
    document.getElementById('bmr-weight').value = '70';
    document.getElementById('bmr-height').value = '175';
    document.getElementById('bmr-age').value = '30';
    document.getElementById('blood-weight').value = '70';
}

function calculateAnatomy() {
    console.log("Calculating anatomy metrics...");
    
    // Hide previous results/errors
    document.getElementById('anat-results').style.display = 'none';
    document.getElementById('anat-error').style.display = 'none';
    
    // Get active tool
    const activeTool = document.querySelector('.anat-tool-btn.active').dataset.tool;
    let result = '';
    let interpretation = '';
    
    try {
        if (activeTool === 'bmi') {
            const weight = parseFloat(document.getElementById('anat-weight').value);
            const height = parseFloat(document.getElementById('anat-height').value);
            
            if (!weight || !height || weight <= 0 || height <= 0) {
                showAnatomyError('Please enter valid weight (kg) and height (m)');
                return;
            }
            
            const bmi = weight / (height * height);
            result = `BMI: ${bmi.toFixed(1)}`;
            
            if (bmi < 18.5) {
                interpretation = 'Underweight - Consider consulting a healthcare provider';
            } else if (bmi < 25) {
                interpretation = 'Normal weight - Healthy range';
            } else if (bmi < 30) {
                interpretation = 'Overweight - Consider lifestyle adjustments';
            } else {
                interpretation = 'Obese - Consult healthcare provider for guidance';
            }
            
            interpretation += `\n\nFormula: Weight (${weight} kg) ÷ Height² (${height} m × ${height} m) = ${bmi.toFixed(1)}`;
            
        } else if (activeTool === 'bmr') {
            const weight = parseFloat(document.getElementById('bmr-weight').value);
            const height = parseFloat(document.getElementById('bmr-height').value);
            const age = parseFloat(document.getElementById('bmr-age').value);
            const sex = document.getElementById('bmr-sex').value;
            
            if (!weight || !height || !age || weight <= 0 || height <= 0 || age <= 0) {
                showAnatomyError('Please enter valid weight, height, and age');
                return;
            }
            
            let bmr;
            if (sex === 'male') {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) + 5;
            } else {
                bmr = (10 * weight) + (6.25 * height) - (5 * age) - 161;
            }
            
            result = `BMR: ${bmr.toFixed(0)} calories/day`;
            interpretation = `Your body burns approximately ${bmr.toFixed(0)} calories daily at rest.\n\n`;
            interpretation += `Activity Level Estimates:\n`;
            interpretation += `• Sedentary: ${(bmr * 1.2).toFixed(0)} cal/day\n`;
            interpretation += `• Light exercise: ${(bmr * 1.375).toFixed(0)} cal/day\n`;
            interpretation += `• Moderate exercise: ${(bmr * 1.55).toFixed(0)} cal/day\n`;
            interpretation += `• Very active: ${(bmr * 1.725).toFixed(0)} cal/day\n`;
            interpretation += `• Extra active: ${(bmr * 1.9).toFixed(0)} cal/day`;
            
        } else if (activeTool === 'blood') {
            const weight = parseFloat(document.getElementById('blood-weight').value);
            
            if (!weight || weight <= 0) {
                showAnatomyError('Please enter valid weight (kg)');
                return;
            }
            
            const bloodVolumeMl = weight * 72.5;
            const bloodVolumeLiters = bloodVolumeMl / 1000;
            
            result = `Estimated Blood Volume: ${bloodVolumeLiters.toFixed(1)} liters`;
            interpretation = `An average adult has approximately 70-75 ml of blood per kg of body weight.\n\n`;
            interpretation += `Calculation: ${weight} kg × 72.5 ml/kg = ${bloodVolumeMl.toFixed(0)} ml\n`;
            interpretation += `Converted: ${bloodVolumeMl.toFixed(0)} ml ÷ 1000 = ${bloodVolumeLiters.toFixed(1)} L\n\n`;
            interpretation += `• That's about ${(bloodVolumeLiters * 0.264).toFixed(1)} gallons\n`;
            interpretation += `• Or ${Math.round(bloodVolumeMl / 470)} standard blood donations`;
        }
        
        // Display results
        document.getElementById('anat-result-display').textContent = result;
        document.getElementById('anat-interpretation').innerHTML = interpretation.replace(/\n/g, '<br>');
        document.getElementById('anat-results').style.display = 'block';
        
        // Scroll to results
        setTimeout(() => {
            document.getElementById('anat-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);
        
    } catch (error) {
        console.error('Calculation error:', error);
        showAnatomyError('Unable to calculate. Please check your inputs.');
    }
}

function resetAnatomy() {
    // Reset all inputs to defaults
    setDefaultValues();
    
    // Reset to BMI tool
    document.querySelectorAll('.anat-tool-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.border = '1px solid rgba(255,255,255,0.1)';
        btn.querySelector('div:first-child').style.color = '#e6faff';
        btn.classList.remove('active');
    });
    
    const bmiBtn = document.getElementById('bmi-btn');
    if (bmiBtn) {
        bmiBtn.style.background = 'rgba(45,212,255,0.2)';
        bmiBtn.style.border = '2px solid #2dd4ff';
        bmiBtn.querySelector('div:first-child').style.color = '#2dd4ff';
        bmiBtn.classList.add('active');
    }
    
    // Show BMI inputs
    document.querySelectorAll('.anat-inputs').forEach(input => {
        input.style.display = 'none';
    });
    document.getElementById('bmi-inputs').style.display = 'block';
    
    // Clear results and errors
    clearAnatomyResults();
    
    // Focus on weight input
    setTimeout(() => {
        const weightInput = document.getElementById('anat-weight');
        if (weightInput) {
            weightInput.focus();
            weightInput.select();
        }
    }, 50);
    
    console.log("Anatomy tools reset");
}

function clearAnatomyResults() {
    document.getElementById('anat-results').style.display = 'none';
    document.getElementById('anat-error').style.display = 'none';
}

function copyAnatomyResult() {
    const result = document.getElementById('anat-result-display').textContent;
    const interpretation = document.getElementById('anat-interpretation').textContent;
    const text = `${result}\n\n${interpretation}`;
    
    navigator.clipboard.writeText(text).then(() => {
        const copyBtn = document.getElementById('anat-copy-btn');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '✅ Copied!';
        copyBtn.style.background = 'rgba(57,255,20,0.2)';
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = '';
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Failed to copy. Please select and copy manually.');
    });
}

function showAnatomyError(message) {
    document.getElementById('anat-error-text').textContent = message;
    document.getElementById('anat-error').style.display = 'block';
    
    setTimeout(() => {
        document.getElementById('anat-error').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 100);
}
