<h2 id="tdee-title" style="margin-top:0;color:var(--accent);">‚ö° TDEE & Calorie Calculator</h2>

<form aria-describedby="tdee-desc" style="margin-bottom:20px;">
    <p id="tdee-desc" class="small" style="margin-bottom:20px;color:rgba(var(--text-rgb, 230,250,255),0.9);">
        Calculate your Total Daily Energy Expenditure (TDEE) and calorie needs for weight goals.
        <span style="color:var(--accent);">Based on Mifflin-St Jeor equation.</span>
    </p>
    
    <!-- PERSONAL INFORMATION GRID -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px;">
        <!-- AGE -->
        <div>
            <label for="tdee-age" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Age (years)
            </label>
            <div style="display:flex;align-items:center;gap:8px;">
                <input id="tdee-age" type="number" min="15" max="120" value="30" step="1"
                       style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
                <div style="display:flex;gap:4px;">
                    <button type="button" onclick="tdeeAdjustAge(-1)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">-</button>
                    <button type="button" onclick="tdeeAdjustAge(1)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">+</button>
                </div>
            </div>
        </div>
        
        <!-- GENDER -->
        <div>
            <label for="tdee-gender" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Gender
            </label>
            <div style="display:flex;gap:8px;">
                <button type="button" id="tdee-gender-male" onclick="tdeeSetGender('male')"
                        style="flex:1;padding:12px;border-radius:10px;border:2px solid rgba(var(--accent-rgb, 45,212,255),0.6);background:rgba(var(--accent-rgb, 45,212,255),0.15);color:var(--accent);cursor:pointer;font-weight:600;">
                    ‚ôÇ Male
                </button>
                <button type="button" id="tdee-gender-female" onclick="tdeeSetGender('female')"
                        style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(255,77,77,0.3);background:rgba(255,77,77,0.05);color:rgba(255,77,77,0.9);cursor:pointer;">
                    ‚ôÄ Female
                </button>
            </div>
        </div>
        
        <!-- HEIGHT -->
        <div>
            <label for="tdee-height" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Height (cm)
            </label>
            <div style="display:flex;align-items:center;gap:8px;">
                <input id="tdee-height" type="number" min="50" max="250" value="175" step="1"
                       style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
                <div style="display:flex;gap:4px;">
                    <button type="button" onclick="tdeeAdjustHeight(-1)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">-</button>
                    <button type="button" onclick="tdeeAdjustHeight(1)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">+</button>
                </div>
            </div>
        </div>
        
        <!-- WEIGHT -->
        <div>
            <label for="tdee-weight" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Weight (kg)
            </label>
            <div style="display:flex;align-items:center;gap:8px;">
                <input id="tdee-weight" type="number" min="30" max="300" value="70" step="0.5"
                       style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
                <div style="display:flex;gap:4px;">
                    <button type="button" onclick="tdeeAdjustWeight(-0.5)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">-0.5</button>
                    <button type="button" onclick="tdeeAdjustWeight(0.5)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">+0.5</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ACTIVITY LEVEL SECTION -->
    <div class="field" style="margin-bottom:24px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <label style="color:var(--accent);font-weight:500;">
                Activity Level
            </label>
            <span id="tdee-activity-value" style="color:var(--accent);font-weight:600;font-size:1.1em;">Moderate (√ó1.55)</span>
        </div>
        
        <!-- ACTIVITY SLIDER -->
        <input id="tdee-activity" type="range" min="1" max="5" value="3" step="1"
               style="width:100%;height:8px;-webkit-appearance:none;background:linear-gradient(90deg, #ff4d4d, #ffcc00, #39ff14);border-radius:4px;outline:none;margin-bottom:12px;" />
        
        <!-- ACTIVITY DESCRIPTIONS -->
        <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px;font-size:12px;color:rgba(var(--text-rgb, 230,250,255),0.7);">
            <div style="text-align:center;">
                <div style="color:#ff4d4d;margin-bottom:2px;">Sedentary</div>
                <div style="color:#ff4d4d;font-weight:600;">√ó1.2</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#ff9933;margin-bottom:2px;">Light</div>
                <div style="color:#ff9933;font-weight:600;">√ó1.375</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#ffcc00;margin-bottom:2px;">Moderate</div>
                <div style="color:#ffcc00;font-weight:600;">√ó1.55</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#39ff14;margin-bottom:2px;">Active</div>
                <div style="color:#39ff14;font-weight:600;">√ó1.725</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#2dd4ff;margin-bottom:2px;">Very Active</div>
                <div style="color:#2dd4ff;font-weight:600;">√ó1.9</div>
            </div>
        </div>
    </div>
    
    <!-- WEIGHT GOAL SECTION -->
    <div style="background:rgba(0,0,0,0.15);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);">
        <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;font-size:14px;font-weight:600;">üéØ Weight Goal</h4>
        
        <div style="display:flex;gap:12px;">
            <button type="button" id="tdee-goal-lose" onclick="tdeeSetGoal(-500)"
                    style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(255,77,77,0.3);background:rgba(255,77,77,0.1);color:#ff4d4d;cursor:pointer;font-weight:500;">
                üèÉ‚Äç‚ôÇÔ∏è Lose Weight (-500 kcal)
            </button>
            <button type="button" id="tdee-goal-maintain" onclick="tdeeSetGoal(0)"
                    style="flex:1;padding:12px;border-radius:8px;border:2px solid rgba(var(--accent-rgb, 45,212,255),0.6);background:rgba(var(--accent-rgb, 45,212,255),0.15);color:var(--accent);cursor:pointer;font-weight:600;">
                ‚öñÔ∏è Maintain Weight
            </button>
            <button type="button" id="tdee-goal-gain" onclick="tdeeSetGoal(300)"
                    style="flex:1;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.1);color:#39ff14;cursor:pointer;font-weight:500;">
                üí™ Gain Muscle (+300 kcal)
            </button>
        </div>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div class="actions" style="margin-top:24px;display:flex;gap:10px;">
        <button type="button" onclick="tdeeCalculate(this)" 
                style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(255,204,0,0.2), rgba(255,204,0,0.1));border:1px solid rgba(255,204,0,0.4);border-radius:10px;color:#ffcc00;cursor:pointer;font-weight:600;font-size:15px;">
            ‚ö° Calculate TDEE
        </button>
        <button type="button" onclick="tdeeReset(this)"
                style="padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:inherit;cursor:pointer;">
            Reset
        </button>
    </div>
</form>

<!-- RESULTS SECTION -->
<div class="results" aria-live="polite" style="margin-top:20px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:16px;font-weight:600;">üìä Daily Calorie Needs</h3>
    
    <!-- MAIN TDEE DISPLAY -->
    <div id="tdee-main-result" style="background:linear-gradient(135deg, rgba(255,204,0,0.1), rgba(255,204,0,0.05));border:2px solid rgba(255,204,0,0.3);border-radius:12px;padding:20px;margin-bottom:20px;text-align:center;">
        <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:6px;">Total Daily Energy Expenditure (TDEE)</div>
        <div id="tdee-tdee" style="font-size:48px;font-weight:700;color:#ffcc00;line-height:1;margin-bottom:8px;">--</div>
        <div style="font-size:14px;color:rgba(255,255,255,0.7);">Calories/day to maintain weight</div>
    </div>
    
    <!-- CALORIE BREAKDOWN GRID -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
        <div style="background:linear-gradient(135deg, rgba(255,77,77,0.08), rgba(255,77,77,0.04));border:1px solid rgba(255,77,77,0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(255,77,77,0.9);margin-bottom:4px;">Basal Metabolic Rate (BMR)</div>
            <div id="tdee-bmr" style="font-size:20px;font-weight:600;color:#ff4d4d;">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);">At complete rest</div>
        </div>
        
        <div style="background:linear-gradient(135deg, rgba(57,255,20,0.08), rgba(57,255,20,0.04));border:1px solid rgba(57,255,20,0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(57,255,20,0.9);margin-bottom:4px;">Daily Goal</div>
            <div id="tdee-goal" style="font-size:20px;font-weight:600;color:#39ff14;">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);" id="tdee-goal-text">Based on your goal</div>
        </div>
        
        <div style="background:linear-gradient(135deg, rgba(var(--accent-rgb, 45,212,255),0.08), rgba(var(--accent-rgb, 45,212,255),0.04));border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(var(--accent-rgb, 45,212,255),0.9);margin-bottom:4px;">Weekly Goal</div>
            <div id="tdee-weekly" style="font-size:20px;font-weight:600;color:var(--accent);">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);">Weight change per week</div>
        </div>
    </div>
    
    <!-- MACRO NUTRITION ESTIMATES -->
    <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:14px;font-weight:600;">ü•ó Macro Nutrient Targets</h4>
        
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:12px;">
            <div style="text-align:center;">
                <div style="color:#ff9933;font-size:24px;font-weight:600;" id="tdee-protein">--</div>
                <div style="color:rgba(255,255,255,0.7);font-size:12px;">Protein (g)</div>
                <div style="color:rgba(255,255,255,0.5);font-size:11px;">~30% of calories</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#ffcc00;font-size:24px;font-weight:600;" id="tdee-carbs">--</div>
                <div style="color:rgba(255,255,255,0.7);font-size:12px;">Carbs (g)</div>
                <div style="color:rgba(255,255,255,0.5);font-size:11px;">~40% of calories</div>
            </div>
            <div style="text-align:center;">
                <div style="color:#39ff14;font-size:24px;font-weight:600;" id="tdee-fat">--</div>
                <div style="color:rgba(255,255,255,0.7);font-size:12px;">Fat (g)</div>
                <div style="color:rgba(255,255,255,0.5);font-size:11px;">~30% of calories</div>
            </div>
        </div>
    </div>
    
    <!-- ACTIVITY LEVEL DESCRIPTIONS -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;font-size:12px;">
        <div style="background:rgba(255,77,77,0.05);border-radius:8px;padding:10px;border:1px solid rgba(255,77,77,0.1);">
            <div style="color:#ff4d4d;font-weight:600;margin-bottom:4px;">Sedentary (√ó1.2)</div>
            <div style="color:rgba(var(--text-rgb, 230,250,255),0.7);">Little or no exercise, desk job</div>
        </div>
        <div style="background:rgba(57,255,20,0.05);border-radius:8px;padding:10px;border:1px solid rgba(57,255,20,0.1);">
            <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">Active (√ó1.725)</div>
            <div style="color:rgba(var(--text-rgb, 230,250,255),0.7);">Daily exercise or physical job</div>
        </div>
    </div>
</div>

<!-- EDUCATIONAL CONTENT -->
<details style="margin-top:20px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;background:rgba(0,0,0,0.15);">
    <summary style="color:var(--accent);font-weight:600;cursor:pointer;outline:none;user-select:none;">üìö Understanding TDEE & Calories</summary>
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);">
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
            <div>
                <div style="color:#ff4d4d;font-weight:600;margin-bottom:4px;">BMR (Basal Metabolic Rate)</div>
                <p style="margin:0;color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.4;">
                    Calories burned at complete rest. Your body's minimum energy needs for basic functions.
                </p>
            </div>
            <div>
                <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">TDEE (Total Daily Energy Expenditure)</div>
                <p style="margin:0;color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.4;">
                    BMR √ó Activity Factor. Total calories burned including exercise and daily activities.
                </p>
            </div>
        </div>
        
        <div style="background:rgba(var(--accent-rgb, 45,212,255),0.05);border-radius:8px;padding:12px;border-left:3px solid var(--accent);margin-bottom:12px;">
            <strong style="color:var(--accent);">Mifflin-St Jeor Equation (Most Accurate):</strong><br>
            <code style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                Men: BMR = (10 √ó weight) + (6.25 √ó height) - (5 √ó age) + 5<br>
                Women: BMR = (10 √ó weight) + (6.25 √ó height) - (5 √ó age) - 161
            </code><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.7);font-size:12px;">
                Weight in kg, height in cm, age in years.
            </span>
        </div>
        
        <div style="background:rgba(255,204,0,0.05);border-radius:8px;padding:12px;border-left:3px solid #ffcc00;">
            <strong style="color:#ffcc00;">Weight Loss/Gain Guidelines:</strong><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                ‚Ä¢ <strong>Lose 0.5kg/week:</strong> TDEE - 500 kcal/day<br>
                ‚Ä¢ <strong>Maintain:</strong> TDEE ¬± 0 kcal/day<br>
                ‚Ä¢ <strong>Gain 0.25kg/week:</strong> TDEE + 250 kcal/day<br>
                ‚Ä¢ <strong>Gain 0.5kg/week:</strong> TDEE + 500 kcal/day
            </span>
        </div>
        
        <p style="color:rgba(var(--text-rgb, 230,250,255),0.7);font-size:13px;line-height:1.5;margin-top:12px;">
            <span style="color:#ffcc00;">‚ö†Ô∏è Note:</span> This calculator provides estimates. Individual metabolism,
            genetics, and medical conditions can affect actual calorie needs. Consult a healthcare professional
            for personalized advice, especially if you have health conditions.
        </p>
    </div>
</details>

<!-- SCRIPT -->
<script>
/* tdee.html - TDEE & Calorie Calculator
   - Prefix: tdee
   - Calculates Total Daily Energy Expenditure using Mifflin-St Jeor
   - Includes weight goals and macro nutrient estimates
*/

// Activity factor mapping
const TDEE_ACTIVITY_FACTORS = {
    1: { value: 1.2, label: "Sedentary", desc: "Little or no exercise" },
    2: { value: 1.375, label: "Lightly Active", desc: "Light exercise 1-3 days/week" },
    3: { value: 1.55, label: "Moderately Active", desc: "Moderate exercise 3-5 days/week" },
    4: { value: 1.725, label: "Very Active", desc: "Hard exercise 6-7 days/week" },
    5: { value: 1.9, label: "Extra Active", desc: "Very hard exercise & physical job" }
};

let tdeeCurrentGender = 'male';
let tdeeCurrentGoal = 0; // 0 = maintain, -500 = lose, +300 = gain

// Adjust age
function tdeeAdjustAge(delta) {
    const card = document.currentScript?.closest('.card') || document;
    const ageInput = card.querySelector('#tdee-age');
    let age = parseInt(ageInput.value) || 30;
    age = Math.max(15, Math.min(120, age + delta));
    ageInput.value = age;
    tdeeCalculate();
}

// Set gender
function tdeeSetGender(gender) {
    tdeeCurrentGender = gender;
    const card = document.currentScript?.closest('.card') || document;
    
    // Update button styles
    const maleBtn = card.querySelector('#tdee-gender-male');
    const femaleBtn = card.querySelector('#tdee-gender-female');
    
    if (gender === 'male') {
        maleBtn.style.border = '2px solid rgba(var(--accent-rgb, 45,212,255),0.6)';
        maleBtn.style.background = 'rgba(var(--accent-rgb, 45,212,255),0.15)';
        maleBtn.style.color = 'var(--accent)';
        maleBtn.style.fontWeight = '600';
        
        femaleBtn.style.border = '1px solid rgba(255,77,77,0.3)';
        femaleBtn.style.background = 'rgba(255,77,77,0.05)';
        femaleBtn.style.color = 'rgba(255,77,77,0.9)';
        femaleBtn.style.fontWeight = '500';
    } else {
        femaleBtn.style.border = '2px solid rgba(255,77,77,0.6)';
        femaleBtn.style.background = 'rgba(255,77,77,0.15)';
        femaleBtn.style.color = '#ff4d4d';
        femaleBtn.style.fontWeight = '600';
        
        maleBtn.style.border = '1px solid rgba(var(--accent-rgb, 45,212,255),0.3)';
        maleBtn.style.background = 'rgba(var(--accent-rgb, 45,212,255),0.05)';
        maleBtn.style.color = 'rgba(var(--accent-rgb, 45,212,255),0.9)';
        maleBtn.style.fontWeight = '500';
    }
    
    tdeeCalculate();
}

// Adjust height
function tdeeAdjustHeight(delta) {
    const card = document.currentScript?.closest('.card') || document;
    const heightInput = card.querySelector('#tdee-height');
    let height = parseInt(heightInput.value) || 175;
    height = Math.max(50, Math.min(250, height + delta));
    heightInput.value = height;
    tdeeCalculate();
}

// Adjust weight
function tdeeAdjustWeight(delta) {
    const card = document.currentScript?.closest('.card') || document;
    const weightInput = card.querySelector('#tdee-weight');
    let weight = parseFloat(weightInput.value) || 70;
    weight = Math.max(30, Math.min(300, weight + delta));
    weightInput.value = weight.toFixed(1);
    tdeeCalculate();
}

// Update activity display
function tdeeUpdateActivityDisplay() {
    const card = document.currentScript?.closest('.card') || document;
    const activityInput = card.querySelector('#tdee-activity');
    const display = card.querySelector('#tdee-activity-value');
    
    if (activityInput && display) {
        const level = parseInt(activityInput.value);
        const factor = TDEE_ACTIVITY_FACTORS[level];
        if (factor) {
            display.textContent = `${factor.label} (√ó${factor.value})`;
            display.style.color = level === 1 ? '#ff4d4d' : 
                                 level === 2 ? '#ff9933' :
                                 level === 3 ? '#ffcc00' :
                                 level === 4 ? '#39ff14' : '#2dd4ff';
        }
        
        // Auto-calculate if we have all inputs
        const age = card.querySelector('#tdee-age').value;
        if (age && age > 0) {
            tdeeCalculate();
        }
    }
}

// Set weight goal
function tdeeSetGoal(calorieAdjustment) {
    tdeeCurrentGoal = calorieAdjustment;
    const card = document.currentScript?.closest('.card') || document;
    
    // Update button styles
    const loseBtn = card.querySelector('#tdee-goal-lose');
    const maintainBtn = card.querySelector('#tdee-goal-maintain');
    const gainBtn = card.querySelector('#tdee-goal-gain');
    
    // Reset all buttons
    [loseBtn, maintainBtn, gainBtn].forEach(btn => {
        btn.style.border = '1px solid rgba(255,255,255,0.2)';
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.color = 'rgba(255,255,255,0.8)';
        btn.style.fontWeight = '500';
    });
    
    // Highlight selected button
    if (calorieAdjustment === -500) {
        loseBtn.style.border = '2px solid rgba(255,77,77,0.6)';
        loseBtn.style.background = 'rgba(255,77,77,0.15)';
        loseBtn.style.color = '#ff4d4d';
        loseBtn.style.fontWeight = '600';
    } else if (calorieAdjustment === 0) {
        maintainBtn.style.border = '2px solid rgba(var(--accent-rgb, 45,212,255),0.6)';
        maintainBtn.style.background = 'rgba(var(--accent-rgb, 45,212,255),0.15)';
        maintainBtn.style.color = 'var(--accent)';
        maintainBtn.style.fontWeight = '600';
    } else if (calorieAdjustment === 300) {
        gainBtn.style.border = '2px solid rgba(57,255,20,0.6)';
        gainBtn.style.background = 'rgba(57,255,20,0.15)';
        gainBtn.style.color = '#39ff14';
        gainBtn.style.fontWeight = '600';
    }
    
    tdeeCalculate();
}

// Calculate BMR using Mifflin-St Jeor
function tdeeCalculateBMR(weight, height, age, gender) {
    if (gender === 'male') {
        return (10 * weight) + (6.25 * height) - (5 * age) + 5;
    } else {
        return (10 * weight) + (6.25 * height) - (5 * age) - 161;
    }
}

// Main calculation function
function tdeeCalculate(btn = null) {
    const card = btn ? btn.closest('.card') : (document.currentScript?.closest('.card') || document);
    
    try {
        // Get inputs
        const age = parseInt(card.querySelector('#tdee-age').value) || 0;
        const height = parseFloat(card.querySelector('#tdee-height').value) || 0;
        const weight = parseFloat(card.querySelector('#tdee-weight').value) || 0;
        const activityLevel = parseInt(card.querySelector('#tdee-activity').value) || 3;
        const activityFactor = TDEE_ACTIVITY_FACTORS[activityLevel].value;
        
        // Validate inputs
        if (age < 15 || age > 120) {
            throw new Error('Age must be between 15 and 120 years');
        }
        
        if (height < 50 || height > 250) {
            throw new Error('Height must be between 50 and 250 cm');
        }
        
        if (weight < 30 || weight > 300) {
            throw new Error('Weight must be between 30 and 300 kg');
        }
        
        // Calculate BMR
        const bmr = tdeeCalculateBMR(weight, height, age, tdeeCurrentGender);
        
        // Calculate TDEE
        const tdee = bmr * activityFactor;
        
        // Calculate goal calories
        const goalCalories = tdee + tdeeCurrentGoal;
        
        // Calculate weekly weight change
        let weeklyChange = (tdeeCurrentGoal * 7) / 7700; // 7700 kcal ‚âà 1kg fat
        weeklyChange = Math.round(weeklyChange * 100) / 100; // Round to 0.01kg
        
        // Calculate macro nutrients (standard 30/40/30 split)
        const proteinCalories = goalCalories * 0.3;
        const carbCalories = goalCalories * 0.4;
        const fatCalories = goalCalories * 0.3;
        
        const proteinGrams = Math.round(proteinCalories / 4); // 4 kcal/g
        const carbGrams = Math.round(carbCalories / 4); // 4 kcal/g
        const fatGrams = Math.round(fatCalories / 9); // 9 kcal/g
        
        // Update displays
        card.querySelector('#tdee-tdee').textContent = Math.round(tdee) + ' kcal';
        card.querySelector('#tdee-bmr').textContent = Math.round(bmr) + ' kcal';
        card.querySelector('#tdee-goal').textContent = Math.round(goalCalories) + ' kcal';
        card.querySelector('#tdee-weekly').textContent = weeklyChange + ' kg';
        
        // Update goal text
        const goalText = card.querySelector('#tdee-goal-text');
        if (tdeeCurrentGoal < 0) {
            goalText.textContent = 'Weight loss deficit';
            goalText.style.color = '#ff4d4d';
        } else if (tdeeCurrentGoal > 0) {
            goalText.textContent = 'Weight gain surplus';
            goalText.style.color = '#39ff14';
        } else {
            goalText.textContent = 'Weight maintenance';
            goalText.style.color = 'var(--accent)';
        }
        
        // Update macro displays
        card.querySelector('#tdee-protein').textContent = proteinGrams;
        card.querySelector('#tdee-carbs').textContent = carbGrams;
        card.querySelector('#tdee-fat').textContent = fatGrams;
        
        // Visual feedback
        const mainResult = card.querySelector('#tdee-main-result');
        if (mainResult) {
            mainResult.style.animation = 'pulse 0.5s ease';
            setTimeout(() => {
                mainResult.style.animation = '';
            }, 500);
        }
        
        // Log calculation
        console.log(`TDEE Calculation: Age=${age}, Height=${height}cm, Weight=${weight}kg, Gender=${tdeeCurrentGender}, TDEE=${Math.round(tdee)}kcal`);
        
    } catch (error) {
        // Show error to user
        const tdeeDisplay = card.querySelector('#tdee-tdee');
        if (tdeeDisplay) {
            tdeeDisplay.textContent = 'Error';
            tdeeDisplay.style.color = '#ff2d55';
        }
        
        console.error('TDEE Calculator Error:', error.message);
        
        // Optional: Show alert for user
        if (btn) {
            alert('Error: ' + error.message);
        }
    }
}

// Reset function
function tdeeReset(btn) {
    const card = btn.closest('.card') || document;
    
    // Reset inputs
    card.querySelector('#tdee-age').value = 30;
    card.querySelector('#tdee-height').value = 175;
    card.querySelector('#tdee-weight').value = 70;
    card.querySelector('#tdee-activity').value = 3;
    
    // Reset buttons
    tdeeCurrentGender = 'male';
    tdeeCurrentGoal = 0;
    
    // Reset displays
    card.querySelector('#tdee-tdee').textContent = '--';
    card.querySelector('#tdee-tdee').style.color = '#ffcc00';
    card.querySelector('#tdee-bmr').textContent = '--';
    card.querySelector('#tdee-goal').textContent = '--';
    card.querySelector('#tdee-weekly').textContent = '--';
    card.querySelector('#tdee-protein').textContent = '--';
    card.querySelector('#tdee-carbs').textContent = '--';
    card.querySelector('#tdee-fat').textContent = '--';
    
    // Reset button styles
    tdeeSetGender('male');
    tdeeSetGoal(0);
    tdeeUpdateActivityDisplay();
    
    console.log('TDEE Calculator reset');
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        const card = document.currentScript?.closest('.card') || document;
        
        // Set up activity slider
        const activityInput = card.querySelector('#tdee-activity');
        if (activityInput) {
            activityInput.addEventListener('input', tdeeUpdateActivityDisplay);
            activityInput.addEventListener('change', tdeeUpdateActivityDisplay);
        }
        
        // Set up auto-calculation on input changes
        const inputs = card.querySelectorAll('#tdee-age, #tdee-height, #tdee-weight');
        inputs.forEach(input => {
            input.addEventListener('input', function() {
                clearTimeout(this._timer);
                this._timer = setTimeout(() => {
                    tdeeCalculate();
                }, 300); // Debounce 300ms
            });
        });
        
        // Initialize button states
        tdeeSetGender('male');
        tdeeSetGoal(0);
        tdeeUpdateActivityDisplay();
        
        // Initial calculation
        setTimeout(() => {
            tdeeCalculate();
        }, 100);
        
        console.log('TDEE Calculator initialized');
    });
} else {
    // Run immediately if already loaded
    setTimeout(() => {
        tdeeCalculate();
    }, 100);
}
</script>

<!-- CARD-SPECIFIC STYLES -->
<style>
/* Pulse animation for results */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Customize the range slider */
#tdee-activity::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    box-shadow: 0 0 10px rgba(45, 212, 255, 0.5);
    border: 2px solid white;
}

#tdee-activity::-moz-range-thumb {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    background: var(--accent);
    cursor: pointer;
    border: 2px solid white;
    box-shadow: 0 0 10px rgba(45, 212, 255, 0.5);
}

/* Hover effects for buttons */
button[onclick*="tdeeSetGender"]:hover,
button[onclick*="tdeeSetGoal"]:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    #tdee-title {
        font-size: 1.3rem !important;
    }
    
    #tdee-tdee {
        font-size: 36px !important;
    }
    
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        margin: 4px 0 !important;
    }
    
    /* Stack grids on mobile */
    form > div:first-child {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    .results > div[style*="grid-template-columns:repeat(3,1fr)"] {
        grid-template-columns: 1fr 1fr !important;
    }
    
    /* Stack weight goal buttons */
    div[style*="display:flex;gap:12px;"] {
        flex-direction: column !important;
    }
}

/* Small screen adjustments */
@media (max-width: 480px) {
    .results > div[style*="grid-template-columns:repeat(3,1fr)"] {
        grid-template-columns: 1fr !important;
    }
    
    .results > div[style*="grid-template-columns:repeat(2,1fr)"] {
        grid-template-columns: 1fr !important;
    }
    
    #tdee-title {
        font-size: 1.1rem !important;
    }
    
    #tdee-tdee {
        font-size: 32px !important;
    }
}
</style>
