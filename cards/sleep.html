<div class="card" id="sleep-card">
  <h2 id="sleep-title" style="margin-top:0;">Sleep Calculator</h2>

  <form aria-describedby="sleep-desc">
    <p id="sleep-desc" class="small">Find the best times to wake up or go to bed based on 90‑minute sleep cycles.</p>

    <div class="row" style="display:grid;grid-template-columns:1fr;gap:10px;">
      <div class="field">
        <label for="sleep-bedtime">Planned bedtime</label>
        <input id="sleep-bedtime" type="time" value="23:00" style="width:100%;" />
      </div>

      <div class="field">
        <label for="sleep-cycles">Number of cycles</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="sleep-cycles" type="number" min="1" max="6" value="5" style="width:100%;" />
          <div class="small" style="white-space:nowrap;">(~1.5h each)</div>
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" onclick="sleepCalc(this)" class="primary">Calculate</button>
      <button type="button" class="secondary" onclick="sleepReset(this)">Reset</button>
      <button type="button" onclick="sleepSuggest(this)" class="secondary">Suggest Cycles</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <h3 class="small">Results</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
      <div class="result-box" style="background:rgba(123, 183, 255, 0.1);border-radius:8px;padding:12px;text-align:center;">
        <div class="small" style="margin-bottom:4px;">Wake‑up time</div>
        <div class="value" style="font-size:1.5rem;font-weight:600;" id="sleep-res">–</div>
      </div>
      <div class="result-box" style="background:rgba(123, 183, 255, 0.1);border-radius:8px;padding:12px;text-align:center;">
        <div class="small" style="margin-bottom:4px;">Total sleep</div>
        <div class="value" style="font-size:1.5rem;font-weight:600;" id="sleep-total">–</div>
      </div>
    </div>
  </div>

  <div style="margin-top:12px;">
    <details class="small" style="border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
      <summary style="cursor:pointer;font-weight:500;padding:4px;">How it works</summary>
      <div style="margin-top:8px;padding:4px;border-top:1px solid rgba(255,255,255,0.08);">
        <p style="margin:8px 0;">Sleep cycles last ~90 minutes. This calculator adds cycles to your bedtime to suggest optimal wake‑up times.</p>
        <p style="margin:8px 0;"><strong>Recommended cycles:</strong></p>
        <ul style="margin:8px 0;padding-left:20px;">
          <li>5 cycles: 7.5 hours (optimal)</li>
          <li>6 cycles: 9 hours (extended)</li>
          <li>4 cycles: 6 hours (minimum)</li>
        </ul>
      </div>
    </details>
  </div>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #7bb7ff;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input:focus {
      outline: none;
      border-color: #7bb7ff;
      box-shadow: 0 0 0 2px rgba(123, 183, 255, 0.2);
    }
    
    input[type="time"]::-webkit-calendar-picker-indicator {
      filter: invert(0.8);
      cursor: pointer;
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      height: 24px;
      cursor: pointer;
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #4a86e8;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #3a76d8;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .results h3 {
      color: #7bb7ff;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    .result-box {
      transition: transform 0.2s ease;
    }
    
    .result-box:hover {
      transform: translateY(-2px);
    }
    
    details summary::-webkit-details-marker {
      display: none;
    }
    
    details summary:after {
      content: '▼';
      float: right;
      font-size: 0.75em;
      transition: transform 0.2s ease;
    }
    
    details[open] summary:after {
      transform: rotate(180deg);
    }
  </style>
</div>

<script>
function sleepCalc(btn) {
  const card = btn.closest('.card');
  const bedtimeStr = card.querySelector('#sleep-bedtime').value;
  const cycles = parseInt(card.querySelector('#sleep-cycles').value, 10) || 5;
  
  // Validate cycles
  if (cycles < 1 || cycles > 6) {
    card.querySelector('#sleep-res').textContent = "Invalid cycles";
    card.querySelector('#sleep-total').textContent = "–";
    return;
  }

  if (!bedtimeStr) {
    card.querySelector('#sleep-res').textContent = "–";
    card.querySelector('#sleep-total').textContent = "–";
    return;
  }

  // Parse bedtime
  const [hours, minutes] = bedtimeStr.split(":").map(Number);
  const bedtime = new Date();
  bedtime.setHours(hours, minutes, 0, 0);
  
  // Calculate wake time (add cycles * 90 minutes)
  const wakeTime = new Date(bedtime.getTime() + cycles * 90 * 60000);
  
  // Format wake time
  const hh = wakeTime.getHours().toString().padStart(2, "0");
  const mm = wakeTime.getMinutes().toString().padStart(2, "0");
  const period = wakeTime.getHours() >= 12 ? "PM" : "AM";
  const displayHours = wakeTime.getHours() % 12 || 12;
  
  // Calculate total sleep hours
  const totalHours = (cycles * 1.5).toFixed(1);
  const hoursInt = Math.floor(cycles * 1.5);
  const minutesInt = Math.round((cycles * 1.5 - hoursInt) * 60);
  
  // Display results
  card.querySelector('#sleep-res').textContent = `${displayHours}:${mm} ${period}`;
  card.querySelector('#sleep-total').textContent = `${totalHours}h`;
  
  // Add success hint
  const resultsDiv = card.querySelector('.results');
  if (!resultsDiv.querySelector('.hint')) {
    const hint = document.createElement('div');
    hint.className = 'hint small';
    hint.style.marginTop = '8px';
    hint.style.color = '#8bc34a';
    resultsDiv.appendChild(hint);
  }
  
  const hint = resultsDiv.querySelector('.hint');
  hint.textContent = `Calculated ${cycles} sleep cycle${cycles !== 1 ? 's' : ''}`;
}

function sleepReset(btn) {
  const card = btn.closest('.card');
  card.querySelector('#sleep-bedtime').value = "23:00";
  card.querySelector('#sleep-cycles').value = "5";
  card.querySelector('#sleep-res').textContent = "–";
  card.querySelector('#sleep-total').textContent = "–";
  
  // Clear hint
  const hint = card.querySelector('.hint');
  if (hint) hint.textContent = "";
}

function sleepSuggest(btn) {
  const card = btn.closest('.card');
  const cyclesInput = card.querySelector('#sleep-cycles');
  
  // Cycle through recommendations
  const recommendations = [5, 6, 4, 3];
  const current = parseInt(cyclesInput.value, 10) || 5;
  const currentIndex = recommendations.indexOf(current);
  const nextIndex = (currentIndex + 1) % recommendations.length;
  cyclesInput.value = recommendations[nextIndex];
  
  // Auto-calculate with new value
  const calculateBtn = card.querySelector('button.primary');
  sleepCalc(calculateBtn);
  
  // Show suggestion feedback
  const hint = card.querySelector('.hint') || 
               (() => {
                 const div = document.createElement('div');
                 div.className = 'hint small';
                 div.style.marginTop = '8px';
                 div.style.color = '#ffb74d';
                 card.querySelector('.results').appendChild(div);
                 return div;
               })();
  
  const messages = {
    5: "Optimal: 7.5 hours (5 cycles)",
    6: "Extended: 9 hours (6 cycles)",
    4: "Minimum: 6 hours (4 cycles)",
    3: "Short: 4.5 hours (3 cycles)"
  };
  
  hint.textContent = `Suggested: ${messages[recommendations[nextIndex]]}`;
  hint.style.color = '#ffb74d';
  
  // Reset color after 3 seconds
  setTimeout(() => {
    if (hint.textContent.includes("Suggested:")) {
      hint.style.color = '#8bc34a';
    }
  }, 3000);
}

// Auto-calculate on page load
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('sleep-card');
  if (card) {
    // Set a small timeout to ensure all elements are loaded
    setTimeout(() => {
      const calculateBtn = card.querySelector('button.primary');
      if (calculateBtn) {
        sleepCalc(calculateBtn);
      }
    }, 100);
  }
});

// Auto-calculate when time input changes
document.addEventListener('input', function(e) {
  if (e.target.id === 'sleep-bedtime' || e.target.id === 'sleep-cycles') {
    const card = e.target.closest('.card');
    if (card && card.id === 'sleep-card') {
      const calculateBtn = card.querySelector('button.primary');
      if (calculateBtn) {
        sleepCalc(calculateBtn);
      }
    }
  }
});
</script>
