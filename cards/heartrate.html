<h2 id="hr-calculator-title" style="margin-top:0;color:var(--accent);">‚ù§Ô∏è Advanced Heart Rate & Fitness Calculator</h2>

<form aria-describedby="hr-calculator-desc">
  <p id="hr-calculator-desc" class="small" style="color:var(--muted);margin-bottom:20px;">
    Calculate training zones, VO‚ÇÇ max estimates, heart rate variability (HRV), and recovery metrics.
    <span style="color:var(--accent);font-weight:500;">Professional-grade analytics for athletes!</span>
  </p>

  <!-- User Profile Section -->
  <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
    <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">üë§ User Profile</h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:12px;">
      <div>
        <label for="hr-age" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Age
        </label>
        <input id="hr-age" type="number" min="1" max="120" value="30" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
      </div>
      
      <div>
        <label for="hr-resting-hr" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Resting HR (bpm)
        </label>
        <input id="hr-resting-hr" type="number" min="30" max="120" value="70" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
      </div>
      
      <div>
        <label for="hr-fitness-level" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Fitness Level
        </label>
        <select id="hr-fitness-level" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="sedentary">Sedentary</option>
          <option value="recreational">Recreational</option>
          <option value="active" selected>Active</option>
          <option value="athlete">Athlete</option>
          <option value="elite">Elite</option>
        </select>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
      <div>
        <label for="hr-gender" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Gender
        </label>
        <select id="hr-gender" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="male">Male</option>
          <option value="female">Female</option>
          <option value="other">Other/Prefer not to say</option>
        </select>
      </div>
      
      <div>
        <label for="hr-weight" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Weight (kg)
        </label>
        <input id="hr-weight" type="number" min="30" max="200" value="70" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
      </div>
      
      <div>
        <label for="hr-height" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Height (cm)
        </label>
        <input id="hr-height" type="number" min="100" max="250" value="175" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
      </div>
    </div>
  </div>

  <!-- Calculation Methods -->
  <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
    <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">üìä Calculation Method</h3>
    
    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;">
      <button type="button" onclick="hrSetMethod('fox')" id="hr-method-fox"
              style="padding:10px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:500;">
        Fox (220 - age)
      </button>
      <button type="button" onclick="hrSetMethod('haskell')" id="hr-method-haskell"
              style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
        Haskell (208 - 0.7*age)
      </button>
      <button type="button" onclick="hrSetMethod('gellish')" id="hr-method-gellish"
              style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
        Gellish (206.9 - 0.67*age)
      </button>
      <button type="button" onclick="hrSetMethod('karvonen')" id="hr-method-karvonen"
              style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
        Karvonen Formula
      </button>
    </div>
    
    <div style="font-size:13px;color:var(--muted);">
      <span id="hr-method-description">Fox method: 220 - age (most common)</span>
    </div>
  </div>

  <!-- Action Buttons -->
  <div style="display:flex;gap:10px;margin-bottom:20px;">
    <button type="button" onclick="hrCalculateAll()" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(255,77,77,0.2), rgba(255,77,77,0.1));border:1px solid rgba(255,77,77,0.4);border-radius:8px;color:#ff4d4d;cursor:pointer;font-weight:600;font-size:16px;">
      ‚ù§Ô∏è Calculate Everything
    </button>
    <button type="button" onclick="hrSaveProfile()"
            style="padding:14px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;">
      üíæ Save Profile
    </button>
  </div>
</form>

<!-- Training Zones Visualization -->
<div id="hr-zones-container" style="display:none;margin-bottom:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:12px;">üéØ Heart Rate Training Zones</h3>
  
  <div style="background:rgba(0,0,0,0.3);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1);margin-bottom:16px;">
    <!-- Zone Bar Visualization -->
    <div style="display:flex;height:60px;border-radius:8px;overflow:hidden;margin-bottom:16px;">
      <div id="hr-zone-1" style="flex:1;background:linear-gradient(180deg, #4CAF50, #2E7D32);display:flex;align-items:center;justify-content:center;color:white;font-weight:500;font-size:12px;">
        Recovery
      </div>
      <div id="hr-zone-2" style="flex:1;background:linear-gradient(180deg, #8BC34A, #558B2F);display:flex;align-items:center;justify-content:center;color:white;font-weight:500;font-size:12px;">
        Aerobic
      </div>
      <div id="hr-zone-3" style="flex:1;background:linear-gradient(180deg, #FFC107, #FF8F00);display:flex;align-items:center;justify-content:center;color:white;font-weight:500;font-size:12px;">
        Tempo
      </div>
      <div id="hr-zone-4" style="flex:1;background:linear-gradient(180deg, #FF9800, #EF6C00);display:flex;align-items:center;justify-content:center;color:white;font-weight:500;font-size:12px;">
        Threshold
      </div>
      <div id="hr-zone-5" style="flex:1;background:linear-gradient(180deg, #F44336, #C62828);display:flex;align-items:center;justify-content:center;color:white;font-weight:500;font-size:12px;">
        Max
      </div>
    </div>
    
    <!-- Zones Details -->
    <div id="hr-zones-details" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <!-- Zones will be populated by JavaScript -->
    </div>
  </div>
</div>

<!-- Live Pulse Measurement -->
<div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
  <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">‚åö Live Pulse Measurement</h3>
  
  <div style="text-align:center;margin-bottom:20px;">
    <div id="hr-pulse-visual" style="font-size:64px;color:#ff4d4d;margin-bottom:16px;">‚ù§Ô∏è</div>
    
    <button id="hr-pulse-btn" onclick="hrStartPulseMeasurement()"
            style="padding:16px 32px;background:linear-gradient(135deg, rgba(255,77,77,0.3), rgba(255,77,77,0.1));border:2px solid rgba(255,77,77,0.5);border-radius:50px;color:#ff4d4d;cursor:pointer;font-weight:600;font-size:18px;width:200px;height:200px;border-radius:50%;margin:0 auto 20px;display:flex;align-items:center;justify-content:center;">
      Tap to Measure<br>Pulse
    </button>
    
    <div style="font-size:13px;color:var(--muted);margin-bottom:16px;">
      Tap rhythmically with your heartbeat. Wait for beeps or use your camera flashlight.
    </div>
    
    <!-- Progress and Results -->
    <div id="hr-measurement-progress" style="display:none;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <div style="color:var(--accent);font-size:14px;">Measuring...</div>
        <div id="hr-progress-text" style="color:var(--muted);font-size:12px;">0 taps</div>
      </div>
      <div style="height:6px;background:rgba(255,255,255,0.1);border-radius:3px;overflow:hidden;">
        <div id="hr-progress-bar" style="height:100%;background:linear-gradient(90deg, #ff4d4d, #ffcc00);width:0%;transition:width 0.3s;"></div>
      </div>
    </div>
    
    <!-- Results Display -->
    <div id="hr-pulse-results" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-bottom:16px;">
      <div style="text-align:center;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Current BPM</div>
        <div id="hr-current-bpm" style="font-size:32px;font-weight:600;color:#ff4d4d;">--</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Avg BPM</div>
        <div id="hr-avg-bpm" style="font-size:32px;font-weight:600;color:#ffcc00;">--</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">HRV</div>
        <div id="hr-hrv" style="font-size:32px;font-weight:600;color:#39ff14;">--</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Rhythm</div>
        <div id="hr-rhythm" style="font-size:32px;font-weight:600;color:#2dd4ff;">--</div>
      </div>
    </div>
    
    <!-- Action Buttons for Pulse -->
    <div style="display:flex;gap:10px;justify-content:center;">
      <button type="button" onclick="hrResetMeasurement()"
              style="padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
        Reset
      </button>
      <button type="button" onclick="hrStartMetronome()"
              style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">
        Metronome
      </button>
      <button type="button" onclick="hrUseCameraFlash()"
              style="padding:8px 16px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:8px;color:#ffcc00;cursor:pointer;">
        Flashlight
      </button>
    </div>
  </div>
</div>

<!-- Advanced Metrics -->
<div id="hr-advanced-metrics" style="display:none;margin-bottom:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:12px;">üìà Advanced Fitness Metrics</h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">
    <div style="background:rgba(45,212,255,0.05);border-radius:8px;padding:12px;border:1px solid rgba(45,212,255,0.2);">
      <div style="font-size:12px;color:var(--accent);margin-bottom:4px;">Max HR</div>
      <div id="hr-max-hr" style="font-size:20px;font-weight:600;color:var(--accent);">--</div>
    </div>
    <div style="background:rgba(57,255,20,0.05);border-radius:8px;padding:12px;border:1px solid rgba(57,255,20,0.2);">
      <div style="font-size:12px;color:#39ff14;margin-bottom:4px;">VO‚ÇÇ Max</div>
      <div id="hr-vo2-max" style="font-size:20px;font-weight:600;color:#39ff14;">--</div>
    </div>
    <div style="background:rgba(255,204,0,0.05);border-radius:8px;padding:12px;border:1px solid rgba(255,204,0,0.2);">
      <div style="font-size:12px;color:#ffcc00;margin-bottom:4px;">HR Reserve</div>
      <div id="hr-hr-reserve" style="font-size:20px;font-weight:600;color:#ffcc00;">--</div>
    </div>
    <div style="background:rgba(255,77,77,0.05);border-radius:8px;padding:12px;border:1px solid rgba(255,77,77,0.2);">
      <div style="font-size:12px;color:#ff4d4d;margin-bottom:4px;">Target HR</div>
      <div id="hr-target-hr" style="font-size:20px;font-weight:600;color:#ff4d4d;">--</div>
    </div>
  </div>
  
  <!-- Detailed Information -->
  <div style="margin-top:16px;background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.1);">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Recovery HR (1 min)</div>
        <div id="hr-recovery-1min" style="font-size:16px;font-weight:600;color:#39ff14;">-- bpm drop</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Fat Burn Zone</div>
        <div id="hr-fat-burn-zone" style="font-size:16px;font-weight:600;color:#4CAF50;">-- bpm</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Cardio Zone</div>
        <div id="hr-cardio-zone" style="font-size:16px;font-weight:600;color:#ff9800;">-- bpm</div>
      </div>
      <div>
        <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Peak Zone</div>
        <div id="hr-peak-zone" style="font-size:16px;font-weight:600;color:#f44336;">-- bpm</div>
      </div>
    </div>
  </div>
</div>

<!-- Training Recommendations -->
<div id="hr-recommendations" style="display:none;background:rgba(45,212,255,0.05);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(45,212,255,0.2);">
  <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:12px;">üéØ Personalized Training Recommendations</h3>
  
  <div id="hr-recommendations-content">
    <!-- Recommendations will be populated by JavaScript -->
  </div>
</div>

<!-- History Graph -->
<div id="hr-history-graph" style="display:none;margin-bottom:20px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">üìä Heart Rate History</h3>
    <div style="display:flex;gap:8px;">
      <button type="button" onclick="hrShowGraph('day')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:12px;">Day</button>
      <button type="button" onclick="hrShowGraph('week')" style="padding:4px 8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:12px;">Week</button>
      <button type="button" onclick="hrShowGraph('month')" style="padding:4px 8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:12px;">Month</button>
    </div>
  </div>
  
  <div style="height:200px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);display:flex;align-items:flex-end;padding:12px;gap:4px;">
    <!-- Graph bars will be generated by JavaScript -->
    <div style="text-align:center;color:var(--muted);font-size:12px;flex:1;">
      Graph will appear here after measurements
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div style="display:flex;gap:10px;margin-top:20px;">
  <button type="button" onclick="hrResetAll()" 
          style="flex:1;padding:12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;">
    üîÑ Reset All Data
  </button>
  <button type="button" onclick="hrExportData()"
          style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;">
    üì• Export Data
  </button>
  <button type="button" onclick="hrToggleAdvanced()"
          style="padding:12px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);border-radius:8px;cursor:pointer;">
    ‚öôÔ∏è Advanced
  </button>
</div>

<!-- Information Panel -->
<details style="margin-top:20px;background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
  <summary style="color:var(--accent);font-weight:500;cursor:pointer;outline:none;">
    üìö Understanding Heart Rate Metrics
  </summary>
  <div style="margin-top:12px;font-size:13px;color:var(--muted);">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <div>
        <strong style="color:var(--accent);">Max HR:</strong> Maximum heart rate during all-out effort. Varies by method.
      </div>
      <div>
        <strong style="color:var(--accent);">HRV:</strong> Heart Rate Variability indicates recovery and stress levels.
      </div>
      <div>
        <strong style="color:var(--accent);">VO‚ÇÇ Max:</strong> Maximum oxygen consumption during exercise.
      </div>
      <div>
        <strong style="color:var(--accent);">HR Reserve:</strong> Difference between max and resting HR.
      </div>
    </div>
    <div style="margin-top:12px;">
      <strong style="color:var(--accent);">Training Zones:</strong>
      <ul style="margin:6px 0;padding-left:20px;">
        <li><span style="color:#4CAF50;">Zone 1 (50-60%):</span> Recovery, light activity</li>
        <li><span style="color:#8BC34A;">Zone 2 (60-70%):</span> Aerobic, fat burning</li>
        <li><span style="color:#FFC107;">Zone 3 (70-80%):</span> Tempo, endurance building</li>
        <li><span style="color:#FF9800;">Zone 4 (80-90%):</span> Threshold, lactate buildup</li>
        <li><span style="color:#F44336;">Zone 5 (90-100%):</span> Maximal, VO‚ÇÇ max training</li>
      </ul>
    </div>
  </div>
</details>

<script>
/* heart-rate-calculator.html
   - World-class heart rate calculator with advanced metrics
   - Scoped with hr- prefix (heart rate)
*/

// Global state
let hrMeasurementActive = false;
let hrPulseTimes = [];
let hrMeasurementHistory = [];
let hrCurrentMethod = 'fox';
let hrAudioContext = null;
let hrMetronomeActive = false;

// Initialize when script loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    hrLoadProfile();
    hrUpdateMethodDescription();
    // Show initial calculation
    setTimeout(hrCalculateAll, 100);
    console.log('Advanced Heart Rate Calculator ready');
  });
} else {
  hrLoadProfile();
  hrUpdateMethodDescription();
  setTimeout(hrCalculateAll, 100);
}

// Load saved profile from localStorage
function hrLoadProfile() {
  const saved = localStorage.getItem('hr-profile');
  if (saved) {
    try {
      const profile = JSON.parse(saved);
      document.getElementById('hr-age').value = profile.age || 30;
      document.getElementById('hr-resting-hr').value = profile.restingHR || 70;
      document.getElementById('hr-fitness-level').value = profile.fitnessLevel || 'active';
      document.getElementById('hr-gender').value = profile.gender || 'male';
      document.getElementById('hr-weight').value = profile.weight || 70;
      document.getElementById('hr-height').value = profile.height || 175;
      hrCurrentMethod = profile.method || 'fox';
      hrSetMethod(hrCurrentMethod);
    } catch (e) {
      console.error('Failed to load profile:', e);
    }
  }
  
  // Load measurement history
  const history = localStorage.getItem('hr-history');
  if (history) {
    try {
      hrMeasurementHistory = JSON.parse(history);
      if (hrMeasurementHistory.length > 0) {
        hrShowGraph('day');
        document.getElementById('hr-history-graph').style.display = 'block';
      }
    } catch (e) {
      console.error('Failed to load history:', e);
    }
  }
}

// Save profile to localStorage
function hrSaveProfile() {
  const profile = {
    age: parseInt(document.getElementById('hr-age').value) || 30,
    restingHR: parseInt(document.getElementById('hr-resting-hr').value) || 70,
    fitnessLevel: document.getElementById('hr-fitness-level').value,
    gender: document.getElementById('hr-gender').value,
    weight: parseInt(document.getElementById('hr-weight').value) || 70,
    height: parseInt(document.getElementById('hr-height').value) || 175,
    method: hrCurrentMethod
  };
  
  localStorage.setItem('hr-profile', JSON.stringify(profile));
  hrShowMessage('Profile saved successfully!', 'success');
}

// Set calculation method
function hrSetMethod(method) {
  hrCurrentMethod = method;
  
  // Update button styles
  ['fox', 'haskell', 'gellish', 'karvonen'].forEach(m => {
    const btn = document.getElementById(`hr-method-${m}`);
    if (btn) {
      btn.style.background = m === method ? 'rgba(45,212,255,0.1)' : 'rgba(255,255,255,0.05)';
      btn.style.borderColor = m === method ? 'rgba(45,212,255,0.3)' : 'rgba(255,255,255,0.1)';
      btn.style.color = m === method ? 'var(--accent)' : 'inherit';
    }
  });
  
  hrUpdateMethodDescription();
  hrCalculateAll();
}

function hrUpdateMethodDescription() {
  const desc = document.getElementById('hr-method-description');
  const methods = {
    fox: 'Fox method: 220 - age (most common, general population)',
    haskell: 'Haskell method: 208 - (0.7 √ó age) (more accurate for active individuals)',
    gellish: 'Gellish method: 206.9 - (0.67 √ó age) (research-based, both genders)',
    karvonen: 'Karvonen formula: (220 - age - resting HR) √ó % + resting HR (most accurate)'
  };
  desc.textContent = methods[hrCurrentMethod] || methods.fox;
}

// Main calculation function
function hrCalculateAll() {
  const age = parseInt(document.getElementById('hr-age').value) || 30;
  const restingHR = parseInt(document.getElementById('hr-resting-hr').value) || 70;
  const weight = parseInt(document.getElementById('hr-weight').value) || 70;
  const height = parseInt(document.getElementById('hr-height').value) || 175;
  const fitnessLevel = document.getElementById('hr-fitness-level').value;
  const gender = document.getElementById('hr-gender').value;
  
  // Calculate Max HR based on selected method
  let maxHR;
  switch(hrCurrentMethod) {
    case 'haskell':
      maxHR = Math.round(208 - (0.7 * age));
      break;
    case 'gellish':
      maxHR = Math.round(206.9 - (0.67 * age));
      break;
    case 'karvonen':
      maxHR = Math.round(220 - age); // Base for Karvonen
      break;
    default: // fox
      maxHR = Math.round(220 - age);
  }
  
  // HR Reserve
  const hrReserve = maxHR - restingHR;
  
  // Calculate training zones (Karvonen method zones)
  const zones = [
    { name: 'Recovery', min: 0.5, max: 0.6, color: '#4CAF50' },
    { name: 'Aerobic', min: 0.6, max: 0.7, color: '#8BC34A' },
    { name: 'Tempo', min: 0.7, max: 0.8, color: '#FFC107' },
    { name: 'Threshold', min: 0.8, max: 0.9, color: '#FF9800' },
    { name: 'Max', min: 0.9, max: 1.0, color: '#F44336' }
  ];
  
  // Calculate zone ranges
  const zoneDetails = zones.map(zone => {
    const minBPM = Math.round(restingHR + (hrReserve * zone.min));
    const maxBPM = Math.round(restingHR + (hrReserve * zone.max));
    return { ...zone, minBPM, maxBPM };
  });
  
  // Estimate VO‚ÇÇ Max (Cooper test formula)
  let vo2Max;
  if (gender === 'female') {
    vo2Max = 35 + (0.5 * (fitnessLevel === 'elite' ? 20 : 
                          fitnessLevel === 'athlete' ? 15 : 
                          fitnessLevel === 'active' ? 10 : 
                          fitnessLevel === 'recreational' ? 5 : 0));
  } else {
    vo2Max = 40 + (0.5 * (fitnessLevel === 'elite' ? 25 : 
                          fitnessLevel === 'athlete' ? 20 : 
                          fitnessLevel === 'active' ? 15 : 
                          fitnessLevel === 'recreational' ? 10 : 5));
  }
  
  // Calculate BMI
  const bmi = weight / ((height / 100) * (height / 100));
  
  // Update UI
  hrUpdateUI(maxHR, restingHR, hrReserve, zoneDetails, vo2Max, bmi, age);
  
  // Show containers
  document.getElementById('hr-zones-container').style.display = 'block';
  document.getElementById('hr-advanced-metrics').style.display = 'block';
  document.getElementById('hr-recommendations').style.display = 'block';
}

function hrUpdateUI(maxHR, restingHR, hrReserve, zones, vo2Max, bmi, age) {
  // Update max HR
  document.getElementById('hr-max-hr').textContent = `${maxHR} bpm`;
  
  // Update VO‚ÇÇ Max
  document.getElementById('hr-vo2-max').textContent = `${vo2Max.toFixed(1)} ml/kg/min`;
  
  // Update HR Reserve
  document.getElementById('hr-hr-reserve').textContent = `${hrReserve} bpm`;
  
  // Update target HR (using moderate zone)
  const targetHR = Math.round(restingHR + (hrReserve * 0.7));
  document.getElementById('hr-target-hr').textContent = `${targetHR} bpm`;
  
  // Update training zones visualization
  const zonesContainer = document.getElementById('hr-zones-details');
  zonesContainer.innerHTML = zones.map(zone => `
    <div style="background:${zone.color}20;border-radius:8px;padding:10px;border-left:4px solid ${zone.color};">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
        <div style="font-weight:500;color:${zone.color};">${zone.name}</div>
        <div style="font-size:12px;color:var(--muted);">${Math.round(zone.min * 100)}-${Math.round(zone.max * 100)}%</div>
      </div>
      <div style="font-size:16px;font-weight:600;color:white;">${zone.minBPM}‚Äì${zone.maxBPM} bpm</div>
    </div>
  `).join('');
  
  // Update other metrics
  document.getElementById('hr-recovery-1min').textContent = `${Math.round(hrReserve * 0.15)} bpm drop`;
  document.getElementById('hr-fat-burn-zone').textContent = `${zones[0].minBPM}-${zones[0].maxBPM} bpm`;
  document.getElementById('hr-cardio-zone').textContent = `${zones[1].minBPM}-${zones[2].maxBPM} bpm`;
  document.getElementById('hr-peak-zone').textContent = `${zones[3].minBPM}-${zones[4].maxBPM} bpm`;
  
  // Update training recommendations
  hrUpdateRecommendations(maxHR, restingHR, vo2Max, bmi, age);
}

function hrUpdateRecommendations(maxHR, restingHR, vo2Max, bmi, age) {
  const recommendations = document.getElementById('hr-recommendations-content');
  const fitnessLevel = document.getElementById('hr-fitness-level').value;
  
  let recommendationsHTML = '<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">';
  
  // Based on VO‚ÇÇ Max
  let vo2Category = 'Excellent';
  if (vo2Max < 30) vo2Category = 'Poor';
  else if (vo2Max < 40) vo2Category = 'Fair';
  else if (vo2Max < 50) vo2Category = 'Good';
  else if (vo2Max < 60) vo2Category = 'Very Good';
  
  recommendationsHTML += `
    <div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">VO‚ÇÇ Max Status</div>
      <div style="font-size:16px;font-weight:600;color:#39ff14;">${vo2Category}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">${vo2Max.toFixed(1)} ml/kg/min</div>
    </div>
  `;
  
  // Based on resting HR
  let hrStatus = 'Excellent';
  if (restingHR > 80) hrStatus = 'Poor';
  else if (restingHR > 70) hrStatus = 'Average';
  else if (restingHR > 60) hrStatus = 'Good';
  else if (restingHR > 50) hrStatus = 'Very Good';
  
  recommendationsHTML += `
    <div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Resting HR Status</div>
      <div style="font-size:16px;font-weight:600;color:#2dd4ff;">${hrStatus}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">${restingHR} bpm</div>
    </div>
  `;
  
  // Training recommendation
  let trainingRec = '';
  if (fitnessLevel === 'sedentary') {
    trainingRec = 'Start with 20 min zone 2, 3√ó week';
  } else if (fitnessLevel === 'recreational') {
    trainingRec = 'Mix zone 2 & 3, 4√ó week';
  } else if (fitnessLevel === 'active') {
    trainingRec = 'Include zone 4 intervals, 5√ó week';
  } else if (fitnessLevel === 'athlete') {
    trainingRec = 'Structured periodization with zone 5 work';
  } else {
    trainingRec = 'High-intensity periodized training';
  }
  
  recommendationsHTML += `
    <div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Training Focus</div>
      <div style="font-size:16px;font-weight:600;color:#ffcc00;">${trainingRec}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">Based on your profile</div>
    </div>
  `;
  
  // Recovery recommendation
  let recoveryRec = '';
  if (restingHR > 75) {
    recoveryRec = 'Prioritize sleep & stress reduction';
  } else if (restingHR > 65) {
    recoveryRec = 'Include active recovery days';
  } else {
    recoveryRec = 'Maintain current recovery protocol';
  }
  
  recommendationsHTML += `
    <div>
      <div style="font-size:12px;color:var(--muted);margin-bottom:4px;">Recovery Focus</div>
      <div style="font-size:16px;font-weight:600;color:#9d4edd;">${recoveryRec}</div>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">Monitor morning HR</div>
    </div>
  `;
  
  recommendationsHTML += '</div>';
  recommendations.innerHTML = recommendationsHTML;
}

// Pulse Measurement Functions
function hrStartPulseMeasurement() {
  if (hrMeasurementActive) {
    hrRecordPulse();
    return;
  }
  
  hrMeasurementActive = true;
  hrPulseTimes = [];
  
  // Update UI
  const pulseBtn = document.getElementById('hr-pulse-btn');
  pulseBtn.innerHTML = 'TAP NOW<br>‚ù§Ô∏è';
  pulseBtn.style.background = 'linear-gradient(135deg, rgba(255,77,77,0.5), rgba(255,77,77,0.3))';
  
  // Show progress
  document.getElementById('hr-measurement-progress').style.display = 'block';
  hrUpdateProgress();
  
  // Start visual feedback
  hrAnimatePulse();
  
  // Start beep sound for rhythm
  hrStartBeep();
  
  hrShowMessage('Tap rhythmically with your heartbeat. Keep tapping for 15-30 seconds.', 'info');
}

function hrRecordPulse() {
  const now = Date.now();
  hrPulseTimes.push(now);
  
  // Update progress
  hrUpdateProgress();
  
  // Animate button
  const pulseBtn = document.getElementById('hr-pulse-btn');
  pulseBtn.style.transform = 'scale(0.95)';
  setTimeout(() => {
    pulseBtn.style.transform = 'scale(1)';
  }, 100);
  
  // Animate heart
  const heart = document.getElementById('hr-pulse-visual');
  heart.style.transform = 'scale(1.3)';
  setTimeout(() => {
    heart.style.transform = 'scale(1)';
  }, 200);
  
  // Calculate BPM if we have enough taps
  if (hrPulseTimes.length >= 3) {
    hrCalculateCurrentBPM();
  }
  
  // Auto-stop after 30 taps
  if (hrPulseTimes.length >= 30) {
    setTimeout(hrStopMeasurement, 100);
  }
}

function hrUpdateProgress() {
  const progress = (hrPulseTimes.length / 30) * 100;
  const progressBar = document.getElementById('hr-progress-bar');
  const progressText = document.getElementById('hr-progress-text');
  
  progressBar.style.width = `${progress}%`;
  progressText.textContent = `${hrPulseTimes.length} taps`;
  
  // Change color based on progress
  if (progress > 66) {
    progressBar.style.background = 'linear-gradient(90deg, #39ff14, #2dd4ff)';
  } else if (progress > 33) {
    progressBar.style.background = 'linear-gradient(90deg, #ffcc00, #ff9800)';
  }
}

function hrCalculateCurrentBPM() {
  if (hrPulseTimes.length < 3) return;
  
  // Calculate intervals
  const intervals = [];
  for (let i = 1; i < hrPulseTimes.length; i++) {
    intervals.push(hrPulseTimes[i] - hrPulseTimes[i - 1]);
  }
  
  // Remove outliers
  const filteredIntervals = hrRemoveOutliers(intervals);
  if (filteredIntervals.length < 2) return;
  
  // Calculate BPM
  const avgInterval = filteredIntervals.reduce((a, b) => a + b, 0) / filteredIntervals.length;
  const bpm = Math.round(60000 / avgInterval);
  
  // Calculate HRV (standard deviation of intervals)
  const variance = filteredIntervals.reduce((sum, interval) => {
    return sum + Math.pow(interval - avgInterval, 2);
  }, 0) / filteredIntervals.length;
  const hrv = Math.round(Math.sqrt(variance));
  
  // Calculate rhythm consistency
  const rhythmConsistency = hrCalculateRhythmConsistency(filteredIntervals);
  
  // Update UI
  document.getElementById('hr-current-bpm').textContent = bpm;
  document.getElementById('hr-avg-bpm').textContent = bpm;
  document.getElementById('hr-hrv').textContent = hrv + ' ms';
  document.getElementById('hr-rhythm').textContent = rhythmConsistency > 0.9 ? 'Regular' : 'Irregular';
  
  // Change color based on BPM
  const age = parseInt(document.getElementById('hr-age').value) || 30;
  const maxHR = 220 - age;
  
  if (bpm > maxHR * 0.85) {
    document.getElementById('hr-current-bpm').style.color = '#f44336';
  } else if (bpm > maxHR * 0.7) {
    document.getElementById('hr-current-bpm').style.color = '#ff9800';
  } else if (bpm > maxHR * 0.5) {
    document.getElementById('hr-current-bpm').style.color = '#4CAF50';
  } else {
    document.getElementById('hr-current-bpm').style.color = '#2dd4ff';
  }
}

function hrRemoveOutliers(intervals) {
  if (intervals.length < 3) return intervals;
  
  // Calculate median
  const sorted = [...intervals].sort((a, b) => a - b);
  const median = sorted[Math.floor(sorted.length / 2)];
  
  // Calculate median absolute deviation
  const deviations = sorted.map(x => Math.abs(x - median));
  const mad = deviations[Math.floor(deviations.length / 2)];
  
  // Filter outliers (outside 3 MAD)
  return intervals.filter(x => Math.abs(x - median) <= 3 * mad);
}

function hrCalculateRhythmConsistency(intervals) {
  if (intervals.length < 2) return 0;
  
  const avg = intervals.reduce((a, b) => a + b, 0) / intervals.length;
  const variance = intervals.reduce((sum, interval) => {
    return sum + Math.pow(interval - avg, 2);
  }, 0) / intervals.length;
  
  const cv = Math.sqrt(variance) / avg; // Coefficient of variation
  return Math.max(0, 1 - cv); // Higher = more consistent
}

function hrAnimatePulse() {
  if (!hrMeasurementActive) return;
  
  const heart = document.getElementById('hr-pulse-visual');
  heart.style.transition = 'transform 0.3s ease';
  
  setTimeout(() => {
    heart.style.transform = 'scale(1.1)';
    setTimeout(() => {
      heart.style.transform = 'scale(1)';
      if (hrMeasurementActive) {
        setTimeout(hrAnimatePulse, 600); // Approximate 100 BPM
      }
    }, 150);
  }, 100);
}

function hrStartBeep() {
  if (!hrAudioContext) {
    hrAudioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  let lastBeep = 0;
  const beepInterval = 600; // Approximate 100 BPM
  
  function scheduleBeep() {
    if (!hrMeasurementActive) return;
    
    const now = Date.now();
    if (now - lastBeep > beepInterval) {
      hrPlayBeep();
      lastBeep = now;
    }
    
    setTimeout(scheduleBeep, 100);
  }
  
  scheduleBeep();
}

function hrPlayBeep() {
  if (!hrAudioContext) return;
  
  const oscillator = hrAudioContext.createOscillator();
  const gainNode = hrAudioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(hrAudioContext.destination);
  
  oscillator.frequency.value = 800;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0, hrAudioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(0.1, hrAudioContext.currentTime + 0.01);
  gainNode.gain.linearRampToValueAtTime(0, hrAudioContext.currentTime + 0.1);
  
  oscillator.start();
  oscillator.stop(hrAudioContext.currentTime + 0.1);
}

function hrStopMeasurement() {
  if (!hrMeasurementActive) return;
  
  hrMeasurementActive = false;
  
  // Update UI
  const pulseBtn = document.getElementById('hr-pulse-btn');
  pulseBtn.innerHTML = 'Tap to Measure<br>Pulse';
  pulseBtn.style.background = 'linear-gradient(135deg, rgba(255,77,77,0.3), rgba(255,77,77,0.1))';
  
  // Hide progress
  document.getElementById('hr-measurement-progress').style.display = 'none';
  
  // Record measurement
  if (hrPulseTimes.length >= 3) {
    const bpm = parseInt(document.getElementById('hr-current-bpm').textContent) || 0;
    if (bpm > 0) {
      hrRecordMeasurement(bpm);
      hrShowMessage(`Measurement complete: ${bpm} BPM recorded`, 'success');
    }
  }
  
  // Stop audio
  if (hrAudioContext) {
    hrAudioContext.close();
    hrAudioContext = null;
  }
}

function hrRecordMeasurement(bpm) {
  const measurement = {
    bpm: bpm,
    timestamp: new Date().toISOString(),
    restingHR: parseInt(document.getElementById('hr-resting-hr').value) || 70,
    notes: 'Manual measurement'
  };
  
  hrMeasurementHistory.push(measurement);
  
  // Keep only last 100 measurements
  if (hrMeasurementHistory.length > 100) {
    hrMeasurementHistory = hrMeasurementHistory.slice(-100);
  }
  
  // Save to localStorage
  localStorage.setItem('hr-history', JSON.stringify(hrMeasurementHistory));
  
  // Update graph
  hrShowGraph('day');
  document.getElementById('hr-history-graph').style.display = 'block';
}

function hrShowGraph(range) {
  const graphContainer = document.getElementById('hr-history-graph');
  const graphBars = graphContainer.querySelector('.graph-bars-container');
  
  if (!graphBars) {
    const container = graphContainer.querySelector('div[style*="height:200px"]');
    container.innerHTML = '<div class="graph-bars-container" style="display:flex;align-items:flex-end;gap:2px;height:100%;width:100%;"></div>';
  }
  
  const barsContainer = graphContainer.querySelector('.graph-bars-container');
  barsContainer.innerHTML = '';
  
  // Filter measurements based on range
  const now = new Date();
  let filteredMeasurements = [];
  
  if (range === 'day') {
    filteredMeasurements = hrMeasurementHistory.filter(m => {
      const date = new Date(m.timestamp);
      return date.toDateString() === now.toDateString();
    });
  } else if (range === 'week') {
    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
    filteredMeasurements = hrMeasurementHistory.filter(m => new Date(m.timestamp) >= weekAgo);
  } else if (range === 'month') {
    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
    filteredMeasurements = hrMeasurementHistory.filter(m => new Date(m.timestamp) >= monthAgo);
  }
  
  if (filteredMeasurements.length === 0) {
    barsContainer.innerHTML = '<div style="text-align:center;color:var(--muted);font-size:12px;flex:1;">No measurements recorded yet</div>';
    return;
  }
  
  // Group measurements if there are many
  const maxBars = 50;
  let groupedMeasurements = filteredMeasurements;
  
  if (filteredMeasurements.length > maxBars) {
    const groupSize = Math.ceil(filteredMeasurements.length / maxBars);
    groupedMeasurements = [];
    
    for (let i = 0; i < filteredMeasurements.length; i += groupSize) {
      const group = filteredMeasurements.slice(i, i + groupSize);
      const avgBPM = Math.round(group.reduce((sum, m) => sum + m.bpm, 0) / group.length);
      groupedMeasurements.push({
        bpm: avgBPM,
        timestamp: group[0].timestamp,
        count: group.length
      });
    }
  }
  
  // Find min and max for scaling
  const bpmValues = groupedMeasurements.map(m => m.bpm);
  const minBPM = Math.min(...bpmValues);
  const maxBPM = Math.max(...bpmValues);
  const rangeBPM = maxBPM - minBPM || 1;
  
  // Create bars
  groupedMeasurements.forEach((measurement, index) => {
    const height = ((measurement.bpm - minBPM) / rangeBPM) * 80 + 20; // 20-100% height
    const age = parseInt(document.getElementById('hr-age').value) || 30;
    const maxHR = 220 - age;
    const zonePercent = measurement.bpm / maxHR;
    
    let color = '#4CAF50'; // Zone 1
    if (zonePercent > 0.6) color = '#8BC34A'; // Zone 2
    if (zonePercent > 0.7) color = '#FFC107'; // Zone 3
    if (zonePercent > 0.8) color = '#FF9800'; // Zone 4
    if (zonePercent > 0.9) color = '#F44336'; // Zone 5
    
    const bar = document.createElement('div');
    bar.style.cssText = `
      flex: 1;
      height: ${height}%;
      background: linear-gradient(0deg, ${color}, ${color}80);
      border-radius: 2px;
      min-width: 4px;
      position: relative;
      cursor: pointer;
    `;
    
    bar.title = `${measurement.bpm} BPM\n${new Date(measurement.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    
    barsContainer.appendChild(bar);
  });
}

function hrResetMeasurement() {
  hrMeasurementActive = false;
  hrPulseTimes = [];
  
  // Update UI
  const pulseBtn = document.getElementById('hr-pulse-btn');
  pulseBtn.innerHTML = 'Tap to Measure<br>Pulse';
  pulseBtn.style.background = 'linear-gradient(135deg, rgba(255,77,77,0.3), rgba(255,77,77,0.1))';
  
  document.getElementById('hr-measurement-progress').style.display = 'none';
  document.getElementById('hr-current-bpm').textContent = '--';
  document.getElementById('hr-avg-bpm').textContent = '--';
  document.getElementById('hr-hrv').textContent = '--';
  document.getElementById('hr-rhythm').textContent = '--';
  
  // Stop audio
  if (hrAudioContext) {
    hrAudioContext.close();
    hrAudioContext = null;
  }
}

function hrStartMetronome() {
  if (hrMetronomeActive) {
    hrMetronomeActive = false;
    hrShowMessage('Metronome stopped', 'info');
    return;
  }
  
  hrMetronomeActive = true;
  const bpm = parseInt(document.getElementById('hr-current-bpm').textContent) || 60;
  
  if (!hrAudioContext) {
    hrAudioContext = new (window.AudioContext || window.webkitAudioContext)();
  }
  
  const interval = 60000 / bpm;
  let lastTick = 0;
  
  function tick() {
    if (!hrMetronomeActive) return;
    
    const now = Date.now();
    if (now - lastTick >= interval) {
      hrPlayMetronomeBeep();
      lastTick = now;
    }
    
    setTimeout(tick, 10);
  }
  
  tick();
  hrShowMessage(`Metronome started at ${bpm} BPM`, 'success');
}

function hrPlayMetronomeBeep() {
  if (!hrAudioContext) return;
  
  const oscillator = hrAudioContext.createOscillator();
  const gainNode = hrAudioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(hrAudioContext.destination);
  
  oscillator.frequency.value = 1000;
  oscillator.type = 'sine';
  
  gainNode.gain.setValueAtTime(0, hrAudioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(0.2, hrAudioContext.currentTime + 0.01);
  gainNode.gain.linearRampToValueAtTime(0, hrAudioContext.currentTime + 0.05);
  
  oscillator.start();
  oscillator.stop(hrAudioContext.currentTime + 0.05);
}

function hrUseCameraFlash() {
  if (typeof navigator.mediaDevices === 'undefined') {
    hrShowMessage('Camera flash not supported on this device', 'error');
    return;
  }
  
  // This is a simplified version - in production, you'd want a more robust implementation
  hrShowMessage('Camera flash would be enabled here. Requires camera permission.', 'info');
}

function hrResetAll() {
  if (confirm('Reset all data including profile and measurement history?')) {
    localStorage.removeItem('hr-profile');
    localStorage.removeItem('hr-history');
    
    // Reset form
    document.getElementById('hr-age').value = 30;
    document.getElementById('hr-resting-hr').value = 70;
    document.getElementById('hr-fitness-level').value = 'active';
    document.getElementById('hr-gender').value = 'male';
    document.getElementById('hr-weight').value = 70;
    document.getElementById('hr-height').value = 175;
    
    hrMeasurementHistory = [];
    hrPulseTimes = [];
    hrMeasurementActive = false;
    
    // Reset UI
    hrResetMeasurement();
    document.getElementById('hr-history-graph').style.display = 'none';
    
    hrCalculateAll();
    hrShowMessage('All data has been reset', 'info');
  }
}

function hrExportData() {
  const data = {
    profile: {
      age: document.getElementById('hr-age').value,
      restingHR: document.getElementById('hr-resting-hr').value,
      fitnessLevel: document.getElementById('hr-fitness-level').value,
      gender: document.getElementById('hr-gender').value,
      weight: document.getElementById('hr-weight').value,
      height: document.getElementById('hr-height').value
    },
    measurements: hrMeasurementHistory,
    calculated: {
      maxHR: document.getElementById('hr-max-hr').textContent,
      vo2Max: document.getElementById('hr-vo2-max').textContent,
      hrReserve: document.getElementById('hr-hr-reserve').textContent
    },
    timestamp: new Date().toISOString()
  };
  
  const dataStr = JSON.stringify(data, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `heart-rate-data-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  hrShowMessage('Data exported successfully', 'success');
}

function hrToggleAdvanced() {
  const advanced = document.getElementById('hr-advanced-metrics');
  const recommendations = document.getElementById('hr-recommendations');
  
  if (advanced.style.display === 'none') {
    advanced.style.display = 'block';
    recommendations.style.display = 'block';
  } else {
    advanced.style.display = 'none';
    recommendations.style.display = 'none';
  }
}

function hrShowMessage(message, type = 'info') {
  const card = document.currentScript?.closest('.card') || document;
  
  // Remove existing message
  const existingMsg = card.querySelector('.hr-message');
  if (existingMsg) existingMsg.remove();
  
  // Create message element
  const messageEl = document.createElement('div');
  messageEl.className = 'hr-message';
  messageEl.style.cssText = `
    position:fixed;
    top:20px;
    right:20px;
    padding:12px 16px;
    border-radius:8px;
    background:${type === 'error' ? 'rgba(255,77,77,0.9)' : 
               type === 'success' ? 'rgba(57,255,20,0.9)' : 
               'rgba(45,212,255,0.9)'};
    color:#ffffff;
    z-index:10000;
    backdrop-filter:blur(4px);
    animation:hrSlideIn 0.3s ease;
  `;
  
  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes hrSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes hrFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  messageEl.textContent = message;
  document.body.appendChild(messageEl);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    messageEl.style.animation = 'hrFadeOut 0.3s ease';
    setTimeout(() => messageEl.remove(), 300);
  }, 3000);
}
</script>

<style>
#hr-calculator-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

#hr-pulse-btn {
  transition: all 0.2s ease;
  box-shadow: 0 8px 32px rgba(255, 77, 77, 0.2);
}

#hr-pulse-btn:active {
  transform: scale(0.95) !important;
  box-shadow: 0 4px 16px rgba(255, 77, 77, 0.3);
}

#hr-pulse-visual {
  transition: transform 0.3s ease;
  animation: hrPulse 2s infinite;
}

@keyframes hrPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.1); }
  100% { transform: scale(1); }
}

@media (max-width: 768px) {
  #hr-pulse-btn {
    width: 160px !important;
    height: 160px !important;
    font-size: 16px !important;
  }
  
  .hr-metrics-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  .method-buttons {
    flex-wrap: wrap;
  }
  
  .method-buttons button {
    flex: 1;
    min-width: 120px;
  }
}
</style>
