<!-- cards/japanese-kanji-helper.html -->
<h2 id="kanji-helper-title" style="margin-top:0;color:var(--accent);position:relative;">
  ğŸŒ Japanese Kanji Expert Helper
  <span style="position:absolute;right:0;top:0;font-size:0.7rem;color:rgba(45,212,255,0.7);font-weight:normal;">
    æ¼¢å­—å­¦ç¿’ãƒ„ãƒ¼ãƒ«
  </span>
</h2>

<form aria-describedby="kanji-helper-desc">
  <p id="kanji-helper-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.9);">
    Learn, practice, and master Japanese kanji with REAL stroke order animations, meanings, readings, and example words.
  </p>

  <!-- Search and Input Section -->
  <div style="background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:grid;grid-template-columns:1fr auto;gap:12px;margin-bottom:16px;">
      <div style="position:relative;">
        <label for="kh-kanji-input" style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;">
          ğŸ” Enter Kanji, Meaning, or Reading
        </label>
        <input id="kh-kanji-input" type="text" placeholder="Example: æ°´, water, or ã¿ãš" 
               style="width:100%;padding:14px 16px;border-radius:10px;border:2px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.1rem;" />
        <div class="small" style="margin-top:6px;color:rgba(230,250,255,0.7);">
          Try: æ—¥ (sun), æœˆ (moon), æœ¨ (tree), å±± (mountain), å· (river)
        </div>
      </div>
      
      <div style="display:flex;flex-direction:column;justify-content:flex-end;">
        <button type="button" onclick="khLookupKanji()" 
                style="padding:14px 24px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:10px;color:var(--accent);cursor:pointer;font-weight:600;white-space:nowrap;">
          æ¤œç´¢ ğŸ”
        </button>
      </div>
    </div>

    <!-- JLPT Level Selection -->
    <div style="margin-bottom:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <label style="color:var(--accent);font-weight:500;">ğŸ“š JLPT Level Filter</label>
        <span id="kh-jlpt-indicator" style="font-size:0.9rem;color:#39ff14;">N5 (Basic)</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:6px;">
        <button type="button" onclick="khSetJLPTLevel('N5')" 
                style="padding:10px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;font-weight:500;">
          N5
        </button>
        <button type="button" onclick="khSetJLPTLevel('N4')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          N4
        </button>
        <button type="button" onclick="khSetJLPTLevel('N3')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          N3
        </button>
        <button type="button" onclick="khSetJLPTLevel('N2')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          N2
        </button>
        <button type="button" onclick="khSetJLPTLevel('N1')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          N1
        </button>
      </div>
    </div>

    <!-- Quick Kanji Access -->
    <div>
      <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">âš¡ Quick Access - Common Kanji:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button type="button" onclick="khQuickKanji('æ—¥')" style="padding:10px 14px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:6px;color:#ffcc00;cursor:pointer;font-size:1.2rem;">æ—¥</button>
        <button type="button" onclick="khQuickKanji('æœˆ')" style="padding:10px 14px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:1.2rem;">æœˆ</button>
        <button type="button" onclick="khQuickKanji('æœ¨')" style="padding:10px 14px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:1.2rem;">æœ¨</button>
        <button type="button" onclick="khQuickKanji('å±±')" style="padding:10px 14px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:6px;color:#9d4edd;cursor:pointer;font-size:1.2rem;">å±±</button>
        <button type="button" onclick="khQuickKanji('å·')" style="padding:10px 14px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:1.2rem;">å·</button>
        <button type="button" onclick="khQuickKanji('äºº')" style="padding:10px 14px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;color:#ffa500;cursor:pointer;font-size:1.2rem;">äºº</button>
        <button type="button" onclick="khQuickKanji('æ°´')" style="padding:10px 14px;background:rgba(0,191,255,0.1);border:1px solid rgba(0,191,255,0.3);border-radius:6px;color:#00bfff;cursor:pointer;font-size:1.2rem;">æ°´</button>
        <button type="button" onclick="khQuickKanji('ç«')" style="padding:10px 14px;background:rgba(255,45,85,0.1);border:1px solid rgba(255,45,85,0.3);border-radius:6px;color:#ff2d55;cursor:pointer;font-size:1.2rem;">ç«</button>
      </div>
    </div>
  </div>

  <!-- Practice Tools -->
  <div style="margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <label style="color:var(--accent);font-weight:500;">ğŸ–‹ï¸ Practice Tools</label>
      <span id="kh-tool-indicator" style="font-size:0.85rem;color:#9d4edd;font-weight:500;">Stroke Order</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:8px;">
      <button type="button" onclick="khSetTool('stroke')" 
              style="padding:12px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;font-weight:500;">
        ğŸ–‹ï¸ Stroke Order
      </button>
      <button type="button" onclick="khSetTool('flashcards')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        ğŸ“‡ Flashcards
      </button>
      <button type="button" onclick="khSetTool('quiz')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        â“ Quiz Mode
      </button>
      <button type="button" onclick="khSetTool('writing')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        âœï¸ Writing Practice
      </button>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;margin-top:20px;">
    <button type="button" onclick="khRandomKanji()" 
            style="padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;transition:all 0.2s;">
      ğŸ² Random Kanji
    </button>
    <button type="button" onclick="khPracticeMode()"
            style="padding:14px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ® Practice Now
    </button>
    <button type="button" onclick="khCopyInfo()"
            style="padding:14px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);color:#ffcc00;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ“‹ Copy Info
    </button>
    <button type="button" onclick="khResetTool()"
            style="padding:14px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ”„ Reset
    </button>
  </div>
</form>

<!-- Main Results Display -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <!-- Kanji Display Card -->
  <div id="kh-results-section" style="display:none;background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:8px;padding:24px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;">
      <div>
        <h3 style="color:var(--accent);margin:0 0 4px 0;font-size:1.1rem;" id="kh-kanji-title">Kanji Information</h3>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);" id="kh-kanji-subtitle">Detailed information about the selected kanji</div>
      </div>
      <button onclick="khSaveToStudyList()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.9rem;">
        ğŸ’¾ Save to Study List
      </button>
    </div>
    
    <!-- Kanji Character and Basic Info -->
    <div style="display:grid;grid-template-columns:auto 1fr;gap:24px;align-items:center;margin-bottom:24px;">
      <div style="text-align:center;">
        <div id="kh-kanji-character" style="font-size:120px;font-weight:700;color:#ffcc00;text-shadow:0 4px 20px rgba(255,204,0,0.3);line-height:1;margin-bottom:12px;">
          æ—¥
        </div>
        <div style="display:flex;gap:8px;justify-content:center;">
          <span id="kh-stroke-count" style="padding:4px 12px;background:rgba(45,212,255,0.1);border-radius:20px;color:var(--accent);font-size:0.9rem;">4 strokes</span>
          <span id="kh-jlpt-level" style="padding:4px 12px;background:rgba(57,255,20,0.1);border-radius:20px;color:#39ff14;font-size:0.9rem;">N5</span>
          <span id="kh-frequency" style="padding:4px 12px;background:rgba(255,204,0,0.1);border-radius:20px;color:#ffcc00;font-size:0.9rem;">#1 Common</span>
        </div>
      </div>
      
      <div>
        <div style="margin-bottom:16px;">
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ“– Meanings</div>
          <div id="kh-meanings" style="font-size:1.1rem;font-weight:600;color:#39ff14;">sun, day, Sunday</div>
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
          <div>
            <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ‡¯ğŸ‡µ Kun'yomi (Japanese Reading)</div>
            <div id="kh-kunyomi" style="font-size:1.1rem;font-weight:600;color:var(--accent);">ã², -ã³, -ã‹</div>
          </div>
          <div>
            <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ‡¨ğŸ‡³ On'yomi (Chinese Reading)</div>
            <div id="kh-onyomi" style="font-size:1.1rem;font-weight:600;color:#9d4edd;">ãƒ‹ãƒ, ã‚¸ãƒ„</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Example Words -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ“š Example Words & Compounds</div>
      <div id="kh-example-words" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
        <!-- Will be populated by JavaScript -->
      </div>
    </div>
    
    <!-- REAL Stroke Order Animation -->
    <div id="kh-stroke-order-section" style="margin-bottom:24px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ–‹ï¸ Stroke Order Animation</div>
          <div id="kh-animation-status" style="font-size:0.85rem;color:#ffcc00;">Click "Animate" to see stroke-by-stroke drawing</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button onclick="khStartAnimation()" style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.9rem;">
            â–¶ï¸ Animate
          </button>
          <button onclick="khResetAnimation()" style="padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:0.9rem;">
            ğŸ”„ Reset
          </button>
          <button onclick="khPauseAnimation()" style="padding:8px 16px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:6px;color:#ffcc00;cursor:pointer;font-size:0.9rem;">
            â¸ï¸ Pause
          </button>
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:auto 1fr;gap:24px;">
        <!-- Animation Canvas -->
        <div style="position:relative;">
          <div style="padding:20px;background:white;border-radius:12px;border:2px solid rgba(45,212,255,0.3);margin-bottom:12px;">
            <canvas id="kh-animation-canvas" width="200" height="200" style="border-radius:8px;display:block;margin:0 auto;"></canvas>
          </div>
          <div style="text-align:center;font-size:0.9rem;color:rgba(230,250,255,0.7);">
            Stroke: <span id="kh-current-stroke">0</span>/<span id="kh-total-strokes">0</span>
          </div>
        </div>
        
        <!-- Stroke Guide -->
        <div>
          <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">ğŸ“ Stroke Order Guide</div>
          <div id="kh-stroke-guide" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));gap:12px;">
            <!-- Stroke guide items will be created here -->
          </div>
          <div style="margin-top:16px;padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">
            <div style="color:var(--accent);font-weight:600;margin-bottom:4px;">ğŸ’¡ Writing Tips</div>
            <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">
              â€¢ Write from top to bottom<br>
              â€¢ Write from left to right<br>
              â€¢ Horizontal before vertical when crossing<br>
              â€¢ Center vertical before symmetrical sides
            </div>
          </div>
        </div>
      </div>
      
      <!-- Animation Controls -->
      <div style="margin-top:20px;text-align:center;">
        <div style="display:inline-flex;gap:8px;background:rgba(0,0,0,0.2);padding:8px;border-radius:8px;">
          <button onclick="khAnimationSpeed('slow')" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:0.85rem;">
            Slow
          </button>
          <button onclick="khAnimationSpeed('medium')" style="padding:6px 12px;background:rgba(45,212,255,0.2);border:1px solid var(--accent);border-radius:4px;color:var(--accent);cursor:pointer;font-size:0.85rem;">
            Medium
          </button>
          <button onclick="khAnimationSpeed('fast')" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:0.85rem;">
            Fast
          </button>
          <button onclick="khStepForward()" style="padding:6px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:4px;color:#39ff14;cursor:pointer;font-size:0.85rem;">
            Step â†’
          </button>
          <button onclick="khStepBackward()" style="padding:6px 12px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:4px;color:#ffcc00;cursor:pointer;font-size:0.85rem;">
            â† Step
          </button>
        </div>
      </div>
    </div>
    
    <!-- Radical Information -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ§© Radical & Components</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">
        <div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:6px;">
          <div style="color:var(--accent);font-weight:600;margin-bottom:4px;">Radical</div>
          <div id="kh-radical" style="font-size:1.1rem;font-weight:500;color:rgba(230,250,255,0.9);">æ—¥ (sun)</div>
        </div>
        <div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:6px;">
          <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">Strokes</div>
          <div id="kh-stroke-details" style="font-size:1.1rem;font-weight:500;color:rgba(230,250,255,0.9);">4 total strokes</div>
        </div>
        <div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:6px;">
          <div style="color:#ffcc00;font-weight:600;margin-bottom:4px;">Grade Taught</div>
          <div id="kh-grade" style="font-size:1.1rem;font-weight:500;color:rgba(230,250,255,0.9);">Grade 1 (Age 6)</div>
        </div>
        <div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:6px;">
          <div style="color:#9d4edd;font-weight:600;margin-bottom:4px;">Frequency Rank</div>
          <div id="kh-frequency-rank" style="font-size:1.1rem;font-weight:500;color:rgba(230,250,255,0.9);">#1 (Most Common)</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Study Tools Section -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">ğŸ“š Study & Practice Tools</h3>
    
    <!-- Flashcard Practice -->
    <div id="kh-flashcard-section" style="display:none;margin-bottom:24px;">
      <div style="text-align:center;margin-bottom:16px;">
        <div id="kh-flashcard" style="width:240px;height:180px;margin:0 auto 16px;background:linear-gradient(135deg, rgba(45,212,255,0.1), rgba(45,212,255,0.05));border-radius:12px;border:2px solid rgba(45,212,255,0.3);display:flex;align-items:center;justify-content:center;font-size:72px;color:var(--accent);cursor:pointer;">
          æ—¥
        </div>
        <div style="display:flex;justify-content:center;gap:12px;">
          <button onclick="khFlipCard()" style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            ğŸ”„ Flip Card
          </button>
          <button onclick="khNextCard()" style="padding:8px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;">
            â­ï¸ Next Card
          </button>
        </div>
      </div>
    </div>
    
    <!-- Quiz Mode -->
    <div id="kh-quiz-section" style="display:none;margin-bottom:24px;">
      <div style="text-align:center;margin-bottom:16px;">
        <div style="font-size:1.2rem;color:var(--accent);margin-bottom:12px;" id="kh-quiz-question">What does this kanji mean? <span style="font-size:2rem;color:#ffcc00;">æ—¥</span></div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;max-width:400px;margin:0 auto;">
          <button onclick="khCheckAnswer(1)" style="padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;" id="kh-quiz-option1">Sun, Day</button>
          <button onclick="khCheckAnswer(2)" style="padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;" id="kh-quiz-option2">Moon, Month</button>
          <button onclick="khCheckAnswer(3)" style="padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;" id="kh-quiz-option3">Tree, Wood</button>
          <button onclick="khCheckAnswer(4)" style="padding:12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;" id="kh-quiz-option4">Mountain</button>
        </div>
        <div id="kh-quiz-feedback" style="margin-top:12px;color:#39ff14;font-weight:600;"></div>
      </div>
    </div>
    
    <!-- Writing Practice -->
    <div id="kh-writing-section" style="display:none;">
      <div style="text-align:center;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">âœï¸ Practice Writing This Kanji</div>
        <div style="width:240px;height:240px;margin:0 auto 16px;background:white;border-radius:12px;border:2px solid rgba(45,212,255,0.3);position:relative;">
          <canvas id="kh-writing-canvas" width="240" height="240" style="border-radius:10px;cursor:crosshair;background:white;"></canvas>
        </div>
        <div style="display:flex;justify-content:center;gap:12px;">
          <button onclick="khClearCanvas()" style="padding:8px 16px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">
            ğŸ—‘ï¸ Clear
          </button>
          <button onclick="khShowStrokeGuide()" style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            ğŸ–‹ï¸ Show Guide
          </button>
          <button onclick="khCheckWriting()" style="padding:8px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;">
            âœ… Check
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Learning Tips & Resources -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">ğŸ’¡ Kanji Learning Tips</h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">
      <div style="padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;">
        <div style="color:#39ff14;font-weight:600;margin-bottom:8px;">ğŸ¯ Learn Stroke Order</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Correct stroke order is essential for writing kanji properly and quickly</div>
      </div>
      <div style="padding:16px;background:rgba(57,255,20,0.05);border-radius:8px;">
        <div style="color:#ffcc00;font-weight:600;margin-bottom:8px;">ğŸ“ Practice Daily</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">15 minutes daily is better than 2 hours once a week</div>
      </div>
      <div style="padding:16px;background:rgba(255,204,0,0.05);border-radius:8px;">
        <div style="color:#9d4edd;font-weight:600;margin-bottom:8px;">ğŸ§  Use Mnemonics</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Create stories or images to remember kanji shapes and meanings</div>
      </div>
      <div style="padding:16px;background:rgba(157,78,221,0.05);border-radius:8px;">
        <div style="color:#ff2d55;font-weight:600;margin-bottom:8px;">ğŸ”„ Spaced Repetition</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Review kanji at increasing intervals for long-term retention</div>
      </div>
    </div>
    
    <!-- JLPT Study Guide -->
    <div style="padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border-left:4px solid var(--accent);">
      <div style="color:var(--accent);font-weight:600;margin-bottom:8px;">ğŸ“Š JLPT Kanji Requirements</div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);line-height:1.5;">
        <strong>N5:</strong> ~100 kanji â€¢ <strong>N4:</strong> ~300 kanji â€¢ <strong>N3:</strong> ~650 kanji â€¢ <strong>N2:</strong> ~1000 kanji â€¢ <strong>N1:</strong> ~2000 kanji<br>
        <span style="color:#39ff14;">Tip:</span> Use the animation tool to master stroke order for each kanji level.
      </div>
    </div>
  </div>
</div>

<script>
/* japanese-kanji-helper.html - Enhanced with REAL stroke animation
   - Comprehensive Japanese Kanji learning tool
   - Scoped with kh- prefix
*/

// Kanji database (expanded sample) - NOW WITH STROKE DATA
const khKanjiDatabase = {
  // N5 Kanji (Basic)
  'æ—¥': {
    character: 'æ—¥',
    meanings: ['sun', 'day', 'Sunday'],
    kunyomi: ['ã²', '-ã³', '-ã‹'],
    onyomi: ['ãƒ‹ãƒ', 'ã‚¸ãƒ„'],
    strokes: 4,
    jlpt: 'N5',
    grade: 1,
    frequency: 1,
    radical: 'æ—¥',
    radicalMeaning: 'sun',
    strokeData: [
      { // Stroke 1: Vertical left
        points: [[40, 20], [40, 180]],
        color: '#ff2d55'
      },
      { // Stroke 2: Top horizontal
        points: [[40, 20], [160, 20]],
        color: '#39ff14'
      },
      { // Stroke 3: Vertical right
        points: [[160, 20], [160, 180]],
        color: '#ffcc00'
      },
      { // Stroke 4: Bottom horizontal
        points: [[40, 180], [160, 180]],
        color: '#2dd4ff'
      }
    ],
    examples: [
      { japanese: 'æ—¥æ›œæ—¥', reading: 'ã«ã¡ã‚ˆã†ã³', meaning: 'Sunday' },
      { japanese: 'æ—¥æœ¬', reading: 'ã«ã»ã‚“', meaning: 'Japan' },
      { japanese: 'ä¸€æ—¥', reading: 'ã„ã¡ã«ã¡', meaning: 'one day' },
      { japanese: 'ä»Šæ—¥', reading: 'ãã‚‡ã†', meaning: 'today' }
    ]
  },
  'æœˆ': {
    character: 'æœˆ',
    meanings: ['moon', 'month'],
    kunyomi: ['ã¤ã'],
    onyomi: ['ã‚²ãƒ„', 'ã‚¬ãƒ„'],
    strokes: 4,
    jlpt: 'N5',
    grade: 1,
    frequency: 2,
    radical: 'æœˆ',
    radicalMeaning: 'moon',
    strokeData: [
      { // Stroke 1: Left vertical
        points: [[50, 20], [50, 180]],
        color: '#ff2d55'
      },
      { // Stroke 2: Top horizontal
        points: [[50, 20], [150, 20]],
        color: '#39ff14'
      },
      { // Stroke 3: Right vertical
        points: [[150, 20], [150, 180]],
        color: '#ffcc00'
      },
      { // Stroke 4: Middle horizontal
        points: [[50, 100], [150, 100]],
        color: '#2dd4ff'
      }
    ],
    examples: [
      { japanese: 'æœˆæ›œæ—¥', reading: 'ã’ã¤ã‚ˆã†ã³', meaning: 'Monday' },
      { japanese: 'ä¸€æœˆ', reading: 'ã„ã¡ãŒã¤', meaning: 'January' },
      { japanese: 'æœˆè¦‹', reading: 'ã¤ãã¿', meaning: 'moon viewing' },
      { japanese: 'ä»Šæœˆ', reading: 'ã“ã‚“ã’ã¤', meaning: 'this month' }
    ]
  },
  'æœ¨': {
    character: 'æœ¨',
    meanings: ['tree', 'wood'],
    kunyomi: ['ã', 'ã“'],
    onyomi: ['ãƒœã‚¯', 'ãƒ¢ã‚¯'],
    strokes: 4,
    jlpt: 'N5',
    grade: 1,
    frequency: 3,
    radical: 'æœ¨',
    radicalMeaning: 'tree',
    strokeData: [
      { // Stroke 1: Center vertical
        points: [[100, 20], [100, 180]],
        color: '#ff2d55'
      },
      { // Stroke 2: Top horizontal
        points: [[60, 60], [140, 60]],
        color: '#39ff14'
      },
      { // Stroke 3: Left diagonal
        points: [[60, 120], [100, 180]],
        color: '#ffcc00'
      },
      { // Stroke 4: Right diagonal
        points: [[140, 120], [100, 180]],
        color: '#2dd4ff'
      }
    ],
    examples: [
      { japanese: 'æœ¨æ›œæ—¥', reading: 'ã‚‚ãã‚ˆã†ã³', meaning: 'Thursday' },
      { japanese: 'æœ¨ã®è‘‰', reading: 'ã“ã®ã¯', meaning: 'tree leaves' },
      { japanese: 'æœ¨æ', reading: 'ã‚‚ãã–ã„', meaning: 'lumber' },
      { japanese: 'æœç‰©', reading: 'ãã ã‚‚ã®', meaning: 'fruit (tree thing)' }
    ]
  },
  'å±±': {
    character: 'å±±',
    meanings: ['mountain'],
    kunyomi: ['ã‚„ã¾'],
    onyomi: ['ã‚µãƒ³'],
    strokes: 3,
    jlpt: 'N5',
    grade: 1,
    frequency: 4,
    radical: 'å±±',
    radicalMeaning: 'mountain',
    strokeData: [
      { // Stroke 1: Left vertical
        points: [[60, 20], [60, 160]],
        color: '#ff2d55'
      },
      { // Stroke 2: Center vertical
        points: [[100, 60], [100, 180]],
        color: '#39ff14'
      },
      { // Stroke 3: Right vertical
        points: [[140, 20], [140, 160]],
        color: '#ffcc00'
      }
    ],
    examples: [
      { japanese: 'å±±ç™»ã‚Š', reading: 'ã‚„ã¾ã®ã¼ã‚Š', meaning: 'mountain climbing' },
      { japanese: 'å¯Œå£«å±±', reading: 'ãµã˜ã•ã‚“', meaning: 'Mount Fuji' },
      { japanese: 'ç«å±±', reading: 'ã‹ã–ã‚“', meaning: 'volcano' },
      { japanese: 'å±±ã€…', reading: 'ã‚„ã¾ã‚„ã¾', meaning: 'mountains' }
    ]
  },
  'å·': {
    character: 'å·',
    meanings: ['river', 'stream'],
    kunyomi: ['ã‹ã‚'],
    onyomi: ['ã‚»ãƒ³'],
    strokes: 3,
    jlpt: 'N5',
    grade: 1,
    frequency: 5,
    radical: 'å·',
    radicalMeaning: 'river',
    strokeData: [
      { // Stroke 1: Left stroke
        points: [[50, 20], [50, 180]],
        color: '#ff2d55'
      },
      { // Stroke 2: Center stroke (shorter)
        points: [[100, 40], [100, 160]],
        color: '#39ff14'
      },
      { // Stroke 3: Right stroke
        points: [[150, 20], [150, 180]],
        color: '#ffcc00'
      }
    ],
    examples: [
      { japanese: 'å·è¾º', reading: 'ã‹ã‚ã¹', meaning: 'riverside' },
      { japanese: 'æ²³å·', reading: 'ã‹ã›ã‚“', meaning: 'rivers' },
      { japanese: 'å·ä¸‹ã‚Š', reading: 'ã‹ã‚ãã ã‚Š', meaning: 'river descent' },
      { japanese: 'å°å·', reading: 'ãŠãŒã‚', meaning: 'stream' }
    ]
  },
  'äºº': {
    character: 'äºº',
    meanings: ['person', 'people'],
    kunyomi: ['ã²ã¨', '-ã‚Š', '-ã¨'],
    onyomi: ['ã‚¸ãƒ³', 'ãƒ‹ãƒ³'],
    strokes: 2,
    jlpt: 'N5',
    grade: 1,
    frequency: 6,
    radical: 'äºº',
    radicalMeaning: 'person',
    strokeData: [
      { // Stroke 1: Left diagonal
        points: [[80, 20], [40, 180]],
        color: '#ff2d55'
      },
      { // Stroke 2: Right diagonal
        points: [[120, 20], [80, 180]],
        color: '#39ff14'
      }
    ],
    examples: [
      { japanese: 'æ—¥æœ¬äºº', reading: 'ã«ã»ã‚“ã˜ã‚“', meaning: 'Japanese person' },
      { japanese: 'ä¸€äºº', reading: 'ã²ã¨ã‚Š', meaning: 'one person' },
      { japanese: 'äººå£', reading: 'ã˜ã‚“ã“ã†', meaning: 'population' },
      { japanese: 'äººé–“', reading: 'ã«ã‚“ã’ã‚“', meaning: 'human being' }
    ]
  },
  'æ°´': {
    character: 'æ°´',
    meanings: ['water'],
    kunyomi: ['ã¿ãš'],
    onyomi: ['ã‚¹ã‚¤'],
    strokes: 4,
    jlpt: 'N5',
    grade: 1,
    frequency: 7,
    radical: 'æ°´',
    radicalMeaning: 'water',
    strokeData: [
      { // Stroke 1: Center vertical
        points: [[100, 20], [100, 100]],
        color: '#ff2d55'
      },
      { // Stroke 2: Left stroke
        points: [[60, 60], [100, 100]],
        color: '#39ff14'
      },
      { // Stroke 3: Right stroke
        points: [[140, 60], [100, 100]],
        color: '#ffcc00'
      },
      { // Stroke 4: Bottom strokes
        points: [[60, 140], [140, 140], [100, 180]],
        color: '#2dd4ff'
      }
    ],
    examples: [
      { japanese: 'æ°´æ›œæ—¥', reading: 'ã™ã„ã‚ˆã†ã³', meaning: 'Wednesday' },
      { japanese: 'æ°´æ³³', reading: 'ã™ã„ãˆã„', meaning: 'swimming' },
      { japanese: 'æ°´é“', reading: 'ã™ã„ã©ã†', meaning: 'water supply' },
      { japanese: 'é›¨æ°´', reading: 'ã‚ã¾ã¿ãš', meaning: 'rainwater' }
    ]
  }
};

// Animation variables
let currentTool = 'stroke';
let currentJLPTLevel = 'N5';
let currentKanji = 'æ—¥';
let isCardFlipped = false;
let studyList = [];

// Stroke animation variables
let animationCanvas;
let animationCtx;
let currentStroke = 0;
let isAnimating = false;
let animationInterval;
let animationSpeed = 800; // ms per stroke
let drawnStrokes = [];

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    khInitializeTool();
    khSetJLPTLevel('N5');
    khSetTool('stroke');
    khLookupKanji('æ—¥'); // Show sample kanji on load
    
    // Load study list from localStorage
    const savedList = localStorage.getItem('kh-study-list');
    if (savedList) {
      studyList = JSON.parse(savedList);
    }
    
    // Initialize animation canvas
    khInitializeAnimationCanvas();
  });
}

function khInitializeTool() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set up input event listener
  const input = card.querySelector('#kh-kanji-input');
  input.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      khLookupKanji();
    }
  });
  
  // Initialize writing canvas
  const canvas = card.querySelector('#kh-writing-canvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.lineWidth = 3;
    ctx.lineCap = 'round';
    ctx.strokeStyle = '#000';
    
    let isDrawing = false;
    let lastX = 0;
    let lastY = 0;
    
    canvas.addEventListener('mousedown', (e) => {
      isDrawing = true;
      [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    
    canvas.addEventListener('mousemove', (e) => {
      if (!isDrawing) return;
      ctx.beginPath();
      ctx.moveTo(lastX, lastY);
      ctx.lineTo(e.offsetX, e.offsetY);
      ctx.stroke();
      [lastX, lastY] = [e.offsetX, e.offsetY];
    });
    
    canvas.addEventListener('mouseup', () => isDrawing = false);
    canvas.addEventListener('mouseout', () => isDrawing = false);
  }
}

function khInitializeAnimationCanvas() {
  const card = document.currentScript?.closest('.card') || document;
  animationCanvas = card.querySelector('#kh-animation-canvas');
  
  if (animationCanvas) {
    animationCtx = animationCanvas.getContext('2d');
    animationCtx.lineWidth = 6;
    animationCtx.lineCap = 'round';
    animationCtx.lineJoin = 'round';
  }
}

function khSetJLPTLevel(level) {
  const card = document.currentScript?.closest('.card') || document;
  currentJLPTLevel = level;
  
  // Update JLPT buttons
  card.querySelectorAll('[onclick*="khSetJLPTLevel"]').forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  const activeBtn = card.querySelector(`[onclick="khSetJLPTLevel('${level}')"]`);
  if (activeBtn) {
    activeBtn.style.background = 'rgba(45,212,255,0.2)';
    activeBtn.style.border = '2px solid var(--accent)';
    activeBtn.style.color = 'var(--accent)';
  }
  
  // Update indicator
  const levelNames = {
    'N5': 'N5 (Basic - 100 kanji)',
    'N4': 'N4 (Elementary - 300 kanji)', 
    'N3': 'N3 (Intermediate - 650 kanji)',
    'N2': 'N2 (Advanced - 1000 kanji)',
    'N1': 'N1 (Fluent - 2000 kanji)'
  };
  card.querySelector('#kh-jlpt-indicator').textContent = levelNames[level] || level;
}

function khSetTool(tool) {
  const card = document.currentScript?.closest('.card') || document;
  currentTool = tool;
  
  // Update tool buttons
  card.querySelectorAll('[onclick*="khSetTool"]').forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  const activeBtn = card.querySelector(`[onclick="khSetTool('${tool}')"]`);
  if (activeBtn) {
    activeBtn.style.background = 'rgba(45,212,255,0.2)';
    activeBtn.style.border = '2px solid var(--accent)';
    activeBtn.style.color = 'var(--accent)';
  }
  
  // Update indicator
  const toolNames = {
    'stroke': 'Stroke Order',
    'flashcards': 'Flashcards',
    'quiz': 'Quiz Mode', 
    'writing': 'Writing Practice'
  };
  card.querySelector('#kh-tool-indicator').textContent = toolNames[tool] || tool;
  
  // Show/hide tool sections
  const sections = ['flashcard', 'quiz', 'writing'];
  sections.forEach(section => {
    const sectionEl = card.querySelector(`#kh-${section}-section`);
    if (sectionEl) {
      sectionEl.style.display = section === tool ? 'block' : 'none';
    }
  });
  
  // Initialize tool if needed
  if (tool === 'quiz') {
    khGenerateQuiz();
  } else if (tool === 'flashcards') {
    khInitializeFlashcards();
  }
}

function khLookupKanji(kanji = null) {
  const card = document.currentScript?.closest('.card') || document;
  
  if (!kanji) {
    const input = card.querySelector('#kh-kanji-input');
    kanji = input.value.trim();
  }
  
  // If input is empty, use current kanji
  if (!kanji) {
    kanji = currentKanji;
  }
  
  // Search for kanji in database
  let kanjiData = khKanjiDatabase[kanji];
  
  // If not found by exact character, search by meaning or reading
  if (!kanjiData) {
    // Search by meaning (English)
    for (const key in khKanjiDatabase) {
      const data = khKanjiDatabase[key];
      if (data.meanings.some(m => m.toLowerCase().includes(kanji.toLowerCase()))) {
        kanjiData = data;
        kanji = key;
        break;
      }
    }
    
    // Search by reading (Japanese)
    if (!kanjiData) {
      for (const key in khKanjiDatabase) {
        const data = khKanjiDatabase[key];
        if (data.kunyomi.some(r => r.includes(kanji)) || 
            data.onyomi.some(r => r.includes(kanji))) {
          kanjiData = data;
          kanji = key;
          break;
        }
      }
    }
  }
  
  // If still not found, use default
  if (!kanjiData) {
    kanjiData = khKanjiDatabase['æ—¥'];
    kanji = 'æ—¥';
    
    // Show error message
    const input = card.querySelector('#kh-kanji-input');
    input.value = '';
    input.placeholder = 'Not found. Try: æ—¥, æœˆ, æœ¨, å±±, å·';
  }
  
  currentKanji = kanji;
  
  // Stop any running animation
  khStopAnimation();
  
  // Show results section
  card.querySelector('#kh-results-section').style.display = 'block';
  
  // Scroll to results
  card.querySelector('#kh-results-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Update display with kanji data
  khUpdateKanjiDisplay(kanjiData);
  
  // Update input field
  const input = card.querySelector('#kh-kanji-input');
  input.value = kanji;
  
  // Update quick access buttons
  card.querySelectorAll('[onclick*="khQuickKanji"]').forEach(btn => {
    const btnKanji = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
    btn.style.border = btnKanji === kanji ? '2px solid var(--accent)' : '1px solid rgba(255,255,255,0.3)';
    btn.style.background = btnKanji === kanji ? 'rgba(45,212,255,0.2)' : btn.style.background;
  });
  
  // Initialize stroke animation for this kanji
  khInitializeStrokeAnimation(kanjiData);
}

function khQuickKanji(kanji) {
  khLookupKanji(kanji);
}

function khUpdateKanjiDisplay(data) {
  const card = document.currentScript?.closest('.card') || document;
  
  // Update basic information
  card.querySelector('#kh-kanji-character').textContent = data.character;
  card.querySelector('#kh-stroke-count').textContent = `${data.strokes} stroke${data.strokes !== 1 ? 's' : ''}`;
  card.querySelector('#kh-jlpt-level').textContent = data.jlpt;
  card.querySelector('#kh-frequency').textContent = `#${data.frequency} Common`;
  card.querySelector('#kh-meanings').textContent = data.meanings.join(', ');
  card.querySelector('#kh-kunyomi').textContent = data.kunyomi.join(', ');
  card.querySelector('#kh-onyomi').textContent = data.onyomi.join(', ');
  card.querySelector('#kh-radical').textContent = `${data.radical} (${data.radicalMeaning})`;
  card.querySelector('#kh-stroke-details').textContent = `${data.strokes} total strokes`;
  card.querySelector('#kh-grade').textContent = `Grade ${data.grade} (Age ${data.grade + 5})`;
  card.querySelector('#kh-frequency-rank').textContent = `#${data.frequency} (${khGetFrequencyText(data.frequency)})`;
  
  // Update title
  card.querySelector('#kh-kanji-title').textContent = `Kanji: ${data.character}`;
  card.querySelector('#kh-kanji-subtitle').textContent = `Detailed information about ${data.character}`;
  
  // Update example words
  const examplesContainer = card.querySelector('#kh-example-words');
  examplesContainer.innerHTML = '';
  
  data.examples.forEach(example => {
    const exampleDiv = document.createElement('div');
    exampleDiv.style.padding = '12px';
    exampleDiv.style.background = 'rgba(0,0,0,0.2)';
    exampleDiv.style.borderRadius = '6px';
    exampleDiv.innerHTML = `
      <div style="font-size:1.2rem;color:var(--accent);margin-bottom:4px;">${example.japanese}</div>
      <div style="font-size:0.9rem;color:#ffcc00;margin-bottom:4px;">${example.reading}</div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">${example.meaning}</div>
    `;
    examplesContainer.appendChild(exampleDiv);
  });
  
  // Update stroke counts
  card.querySelector('#kh-total-strokes').textContent = data.strokes;
  
  // Update current tool if needed
  if (currentTool === 'quiz') {
    khGenerateQuiz();
  }
}

function khGetFrequencyText(rank) {
  if (rank <= 10) return 'Most Common';
  if (rank <= 100) return 'Very Common';
  if (rank <= 500) return 'Common';
  if (rank <= 1000) return 'Less Common';
  return 'Rare';
}

function khInitializeStrokeAnimation(kanjiData) {
  const card = document.currentScript?.closest('.card') || document;
  
  // Reset animation state
  currentStroke = 0;
  drawnStrokes = [];
  isAnimating = false;
  
  if (animationCtx) {
    // Clear canvas
    animationCtx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
    
    // Draw faint grid for reference
    animationCtx.strokeStyle = 'rgba(200, 200, 200, 0.2)';
    animationCtx.lineWidth = 1;
    
    // Vertical lines
    for (let x = 0; x <= animationCanvas.width; x += 40) {
      animationCtx.beginPath();
      animationCtx.moveTo(x, 0);
      animationCtx.lineTo(x, animationCanvas.height);
      animationCtx.stroke();
    }
    
    // Horizontal lines
    for (let y = 0; y <= animationCanvas.height; y += 40) {
      animationCtx.beginPath();
      animationCtx.moveTo(0, y);
      animationCtx.lineTo(animationCanvas.width, y);
      animationCtx.stroke();
    }
    
    // Draw center guide
    animationCtx.strokeStyle = 'rgba(45,212,255,0.3)';
    animationCtx.lineWidth = 2;
    animationCtx.setLineDash([5, 5]);
    animationCtx.beginPath();
    animationCtx.moveTo(animationCanvas.width / 2, 0);
    animationCtx.lineTo(animationCanvas.width / 2, animationCanvas.height);
    animationCtx.moveTo(0, animationCanvas.height / 2);
    animationCtx.lineTo(animationCanvas.width, animationCanvas.height / 2);
    animationCtx.stroke();
    animationCtx.setLineDash([]);
    
    // Update stroke count display
    card.querySelector('#kh-current-stroke').textContent = '0';
    card.querySelector('#kh-total-strokes').textContent = kanjiData.strokes;
  }
  
  // Update stroke guide
  khUpdateStrokeGuide(kanjiData);
}

function khUpdateStrokeGuide(kanjiData) {
  const card = document.currentScript?.closest('.card') || document;
  const guideContainer = card.querySelector('#kh-stroke-guide');
  guideContainer.innerHTML = '';
  
  for (let i = 0; i < kanjiData.strokes; i++) {
    const guideItem = document.createElement('div');
    guideItem.style.textAlign = 'center';
    guideItem.style.padding = '8px';
    guideItem.style.background = 'rgba(0,0,0,0.2)';
    guideItem.style.borderRadius = '6px';
    
    // Create mini canvas for stroke preview
    const miniCanvas = document.createElement('canvas');
    miniCanvas.width = 60;
    miniCanvas.height = 60;
    miniCanvas.style.display = 'block';
    miniCanvas.style.margin = '0 auto 4px';
    
    const miniCtx = miniCanvas.getContext('2d');
    miniCtx.lineWidth = 3;
    miniCtx.lineCap = 'round';
    miniCtx.strokeStyle = kanjiData.strokeData[i]?.color || '#ffffff';
    
    // Draw this stroke on mini canvas
    if (kanjiData.strokeData && kanjiData.strokeData[i]) {
      const stroke = kanjiData.strokeData[i];
      miniCtx.beginPath();
      
      // Scale stroke points for mini canvas
      const scale = 0.3; // Scale from 200px to 60px
      const offsetX = 30 - (100 * scale); // Center in mini canvas
      const offsetY = 30 - (100 * scale);
      
      miniCtx.moveTo(stroke.points[0][0] * scale + offsetX, stroke.points[0][1] * scale + offsetY);
      
      for (let j = 1; j < stroke.points.length; j++) {
        miniCtx.lineTo(stroke.points[j][0] * scale + offsetX, stroke.points[j][1] * scale + offsetY);
      }
      
      miniCtx.stroke();
    }
    
    guideItem.innerHTML = `
      ${miniCanvas.outerHTML}
      <div style="font-size:0.8rem;color:var(--accent);font-weight:600;">Stroke ${i + 1}</div>
    `;
    
    guideItem.addEventListener('click', () => {
      khDrawStroke(i);
    });
    
    guideContainer.appendChild(guideItem);
  }
}

function khStartAnimation() {
  if (isAnimating) return;
  
  const card = document.currentScript?.closest('.card') || document;
  const kanjiData = khKanjiDatabase[currentKanji];
  
  if (!kanjiData || !kanjiData.strokeData) return;
  
  isAnimating = true;
  currentStroke = 0;
  drawnStrokes = [];
  
  // Clear canvas
  animationCtx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
  
  // Update status
  card.querySelector('#kh-animation-status').textContent = 'Animating...';
  card.querySelector('#kh-animation-status').style.color = '#39ff14';
  
  // Start animation loop
  animationInterval = setInterval(() => {
    if (currentStroke >= kanjiData.strokes) {
      khStopAnimation();
      card.querySelector('#kh-animation-status').textContent = 'Animation complete!';
      return;
    }
    
    khAnimateSingleStroke(currentStroke);
    currentStroke++;
    
    // Update stroke counter
    card.querySelector('#kh-current-stroke').textContent = currentStroke;
  }, animationSpeed);
}

function khStopAnimation() {
  if (animationInterval) {
    clearInterval(animationInterval);
    animationInterval = null;
  }
  isAnimating = false;
}

function khPauseAnimation() {
  const card = document.currentScript?.closest('.card') || document;
  
  if (isAnimating && animationInterval) {
    clearInterval(animationInterval);
    animationInterval = null;
    card.querySelector('#kh-animation-status').textContent = 'Animation paused';
    card.querySelector('#kh-animation-status').style.color = '#ffcc00';
  } else if (isAnimating) {
    // Resume animation
    khStartAnimation();
  }
}

function khAnimateSingleStroke(strokeIndex) {
  const kanjiData = khKanjiDatabase[currentKanji];
  if (!kanjiData || !kanjiData.strokeData || !kanjiData.strokeData[strokeIndex]) return;
  
  const stroke = kanjiData.strokeData[strokeIndex];
  const points = stroke.points;
  
  if (points.length < 2) return;
  
  // Set stroke style
  animationCtx.strokeStyle = stroke.color;
  animationCtx.lineWidth = 6;
  animationCtx.lineCap = 'round';
  animationCtx.lineJoin = 'round';
  
  // Animate the stroke
  let currentPoint = 0;
  const totalPoints = points.length;
  const animationSteps = 20; // Number of steps for the animation
  
  const animateStep = () => {
    if (currentPoint >= totalPoints - 1) {
      // Stroke complete
      drawnStrokes.push({
        points: points,
        color: stroke.color
      });
      return;
    }
    
    const start = points[currentPoint];
    const end = points[currentPoint + 1];
    
    // Draw the line segment progressively
    for (let i = 0; i <= animationSteps; i++) {
      setTimeout(() => {
        const progress = i / animationSteps;
        const x = start[0] + (end[0] - start[0]) * progress;
        const y = start[1] + (end[1] - start[1]) * progress;
        
        // Clear only the area we're drawing in (to avoid flickering)
        animationCtx.beginPath();
        animationCtx.moveTo(start[0], start[1]);
        animationCtx.lineTo(x, y);
        animationCtx.stroke();
        
        if (i === animationSteps) {
          currentPoint++;
          animateStep();
        }
      }, (animationSpeed / (totalPoints * animationSteps)) * i);
    }
  };
  
  animateStep();
}

function khDrawStroke(strokeIndex) {
  const kanjiData = khKanjiDatabase[currentKanji];
  if (!kanjiData || !kanjiData.strokeData || !kanjiData.strokeData[strokeIndex]) return;
  
  const stroke = kanjiData.strokeData[strokeIndex];
  const points = stroke.points;
  
  if (points.length < 2) return;
  
  // Set stroke style
  animationCtx.strokeStyle = stroke.color;
  animationCtx.lineWidth = 6;
  animationCtx.lineCap = 'round';
  
  // Draw the stroke immediately
  animationCtx.beginPath();
  animationCtx.moveTo(points[0][0], points[0][1]);
  
  for (let i = 1; i < points.length; i++) {
    animationCtx.lineTo(points[i][0], points[i][1]);
  }
  
  animationCtx.stroke();
  
  // Add to drawn strokes
  drawnStrokes[strokeIndex] = {
    points: points,
    color: stroke.color
  };
  
  // Update stroke counter
  currentStroke = strokeIndex + 1;
  const card = document.currentScript?.closest('.card') || document;
  card.querySelector('#kh-current-stroke').textContent = currentStroke;
}

function khResetAnimation() {
  khStopAnimation();
  
  const card = document.currentScript?.closest('.card') || document;
  const kanjiData = khKanjiDatabase[currentKanji];
  
  if (kanjiData) {
    khInitializeStrokeAnimation(kanjiData);
    card.querySelector('#kh-animation-status').textContent = 'Ready to animate';
    card.querySelector('#kh-animation-status').style.color = '#ffcc00';
  }
}

function khAnimationSpeed(speed) {
  const card = document.currentScript?.closest('.card') || document;
  
  // Update speed buttons
  card.querySelectorAll('[onclick*="khAnimationSpeed"]').forEach(btn => {
    btn.style.background = 'rgba(45,212,255,0.1)';
    btn.style.border = '1px solid rgba(45,212,255,0.3)';
  });
  
  const speedBtn = card.querySelector(`[onclick="khAnimationSpeed('${speed}')"]`);
  if (speedBtn) {
    speedBtn.style.background = 'rgba(45,212,255,0.2)';
    speedBtn.style.border = '1px solid var(--accent)';
  }
  
  // Set speed
  switch(speed) {
    case 'slow':
      animationSpeed = 1200;
      break;
    case 'medium':
      animationSpeed = 800;
      break;
    case 'fast':
      animationSpeed = 400;
      break;
  }
  
  // If animation is running, restart with new speed
  if (isAnimating) {
    khStopAnimation();
    setTimeout(khStartAnimation, 100);
  }
}

function khStepForward() {
  const kanjiData = khKanjiDatabase[currentKanji];
  if (!kanjiData) return;
  
  if (currentStroke < kanjiData.strokes) {
    khDrawStroke(currentStroke);
  }
}

function khStepBackward() {
  if (currentStroke > 0) {
    currentStroke--;
    
    // Clear canvas and redraw all strokes up to current
    animationCtx.clearRect(0, 0, animationCanvas.width, animationCanvas.height);
    drawnStrokes = drawnStrokes.slice(0, currentStroke);
    
    // Redraw all strokes
    drawnStrokes.forEach((stroke, index) => {
      if (stroke) {
        animationCtx.strokeStyle = stroke.color;
        animationCtx.lineWidth = 6;
        animationCtx.lineCap = 'round';
        
        animationCtx.beginPath();
        animationCtx.moveTo(stroke.points[0][0], stroke.points[0][1]);
        
        for (let i = 1; i < stroke.points.length; i++) {
          animationCtx.lineTo(stroke.points[i][0], stroke.points[i][1]);
        }
        
        animationCtx.stroke();
      }
    });
    
    // Update stroke counter
    const card = document.currentScript?.closest('.card') || document;
    card.querySelector('#kh-current-stroke').textContent = currentStroke;
  }
}

// [Rest of the functions remain the same as previous version: khRandomKanji, khPracticeMode, etc.]

function khRandomKanji() {
  const card = document.currentScript?.closest('.card') || document;
  const kanjiList = Object.keys(khKanjiDatabase);
  
  // Filter by JLPT level if set
  let filteredList = kanjiList;
  if (currentJLPTLevel) {
    filteredList = kanjiList.filter(k => khKanjiDatabase[k].jlpt === currentJLPTLevel);
  }
  
  if (filteredList.length > 0) {
    const randomIndex = Math.floor(Math.random() * filteredList.length);
    khLookupKanji(filteredList[randomIndex]);
    
    // Visual feedback
    const btn = card.querySelector('[onclick="khRandomKanji()"]');
    btn.innerHTML = 'ğŸ² Randomizing...';
    setTimeout(() => {
      btn.innerHTML = 'ğŸ² Random Kanji';
    }, 1000);
  }
}

function khPracticeMode() {
  khSetTool('quiz');
  
  const card = document.currentScript?.closest('.card') || document;
  const btn = card.querySelector('[onclick="khPracticeMode()"]');
  btn.innerHTML = 'ğŸ¯ Practicing...';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ® Practice Now';
  }, 1000);
}

function khGenerateQuiz() {
  const card = document.currentScript?.closest('.card') || document;
  const currentData = khKanjiDatabase[currentKanji];
  
  if (!currentData) return;
  
  // Create quiz options (correct answer + 3 wrong answers)
  const allKanji = Object.keys(khKanjiDatabase);
  const wrongOptions = [];
  
  // Get 3 random wrong kanji (excluding current)
  while (wrongOptions.length < 3) {
    const randomKanji = allKanji[Math.floor(Math.random() * allKanji.length)];
    if (randomKanji !== currentKanji && !wrongOptions.includes(randomKanji)) {
      wrongOptions.push(randomKanji);
    }
  }
  
  // Create options array with correct answer at random position
  const correctPosition = Math.floor(Math.random() * 4);
  const options = [...wrongOptions];
  options.splice(correctPosition, 0, currentKanji);
  
  // Update quiz display
  card.querySelector('#kh-quiz-question').innerHTML = 
    `What does this kanji mean? <span style="font-size:2rem;color:#ffcc00;">${currentKanji}</span>`;
  
  // Update option buttons
  for (let i = 1; i <= 4; i++) {
    const kanji = options[i-1];
    const data = khKanjiDatabase[kanji];
    const btn = card.querySelector(`#kh-quiz-option${i}`);
    if (btn && data) {
      btn.textContent = data.meanings.join(', ');
      btn.dataset.correct = (kanji === currentKanji) ? 'true' : 'false';
    }
  }
  
  // Clear feedback
  card.querySelector('#kh-quiz-feedback').textContent = '';
}

function khCheckAnswer(optionNumber) {
  const card = document.currentScript?.closest('.card') || document;
  const btn = card.querySelector(`#kh-quiz-option${optionNumber}`);
  const feedback = card.querySelector('#kh-quiz-feedback');
  
  if (btn.dataset.correct === 'true') {
    feedback.textContent = 'âœ… Correct! Well done!';
    feedback.style.color = '#39ff14';
    btn.style.background = 'rgba(57,255,20,0.2)';
    btn.style.border = '1px solid #39ff14';
  } else {
    feedback.textContent = 'âŒ Incorrect. Try again!';
    feedback.style.color = '#ff2d55';
    btn.style.background = 'rgba(255,45,85,0.2)';
    btn.style.border = '1px solid #ff2d55';
  }
  
  // Reset buttons after delay and generate new quiz
  setTimeout(() => {
    card.querySelectorAll('[id^="kh-quiz-option"]').forEach(optionBtn => {
      optionBtn.style.background = 'rgba(255,255,255,0.05)';
      optionBtn.style.border = '1px solid rgba(255,255,255,0.1)';
    });
    feedback.textContent = '';
    khGenerateQuiz();
  }, 2000);
}

function khInitializeFlashcards() {
  const card = document.currentScript?.closest('.card') || document;
  const flashcard = card.querySelector('#kh-flashcard');
  
  if (flashcard) {
    flashcard.textContent = currentKanji;
    flashcard.style.color = 'var(--accent)';
    flashcard.dataset.side = 'front';
    isCardFlipped = false;
  }
}

function khFlipCard() {
  const card = document.currentScript?.closest('.card') || document;
  const flashcard = card.querySelector('#kh-flashcard');
  const currentData = khKanjiDatabase[currentKanji];
  
  if (!flashcard || !currentData) return;
  
  if (flashcard.dataset.side === 'front') {
    // Flip to back (show meaning)
    flashcard.innerHTML = `
      <div style="text-align:center;padding:20px;">
        <div style="font-size:1.5rem;color:#39ff14;margin-bottom:12px;">${currentData.meanings.join(', ')}</div>
        <div style="font-size:1rem;color:var(--accent);">Kun: ${currentData.kunyomi.join(', ')}</div>
        <div style="font-size:1rem;color:#9d4edd;">On: ${currentData.onyomi.join(', ')}</div>
      </div>
    `;
    flashcard.dataset.side = 'back';
    flashcard.style.fontSize = '1.5rem';
  } else {
    // Flip to front (show character)
    flashcard.textContent = currentKanji;
    flashcard.dataset.side = 'front';
    flashcard.style.fontSize = '72px';
    flashcard.style.color = 'var(--accent)';
  }
  
  // Animation effect
  flashcard.style.transform = 'rotateY(90deg)';
  setTimeout(() => {
    flashcard.style.transform = 'rotateY(0deg)';
    flashcard.style.transition = 'transform 0.6s ease';
  }, 10);
}

function khNextCard() {
  khRandomKanji();
  khInitializeFlashcards();
}

function khClearCanvas() {
  const card = document.currentScript?.closest('.card') || document;
  const canvas = card.querySelector('#kh-writing-canvas');
  if (canvas) {
    const ctx = canvas.getContext('2d');
    ctx.clearRect(0, 0, canvas.width, canvas.height);
  }
}

function khShowStrokeGuide() {
  khStartAnimation();
  
  const card = document.currentScript?.closest('.card') || document;
  const btn = card.querySelector('[onclick="khShowStrokeGuide()"]');
  btn.textContent = 'ğŸ¯ Showing Animation...';
  setTimeout(() => {
    btn.textContent = 'ğŸ–‹ï¸ Show Guide';
  }, 2000);
}

function khCheckWriting() {
  const card = document.currentScript?.closest('.card') || document;
  const feedback = card.querySelector('#kh-quiz-feedback') || document.createElement('div');
  
  // Simple check - just provide encouragement
  feedback.textContent = 'ğŸ¯ Good effort! Compare your writing with the stroke order animation above.';
  feedback.style.color = '#ffcc00';
  feedback.style.textAlign = 'center';
  feedback.style.marginTop = '12px';
  
  // If not already in DOM, add it
  if (!feedback.parentNode) {
    const writingSection = card.querySelector('#kh-writing-section');
    writingSection.appendChild(feedback);
  }
}

function khSaveToStudyList() {
  const currentData = khKanjiDatabase[currentKanji];
  if (!currentData) return;
  
  // Check if already in study list
  if (!studyList.some(item => item.character === currentKanji)) {
    studyList.push({
      character: currentKanji,
      added: new Date().toISOString(),
      reviewed: 0,
      mastered: false
    });
    
    // Save to localStorage
    localStorage.setItem('kh-study-list', JSON.stringify(studyList));
    
    // Visual feedback
    const card = document.currentScript?.closest('.card') || document;
    const btn = card.querySelector('[onclick="khSaveToStudyList()"]');
    btn.textContent = 'ğŸ’¾ Saved!';
    btn.style.background = 'rgba(57,255,20,0.1)';
    btn.style.borderColor = '#39ff14';
    
    setTimeout(() => {
      btn.textContent = 'ğŸ’¾ Save to Study List';
      btn.style.background = 'rgba(45,212,255,0.1)';
      btn.style.borderColor = 'rgba(45,212,255,0.3)';
    }, 2000);
  }
}

function khCopyInfo() {
  const currentData = khKanjiDatabase[currentKanji];
  if (!currentData) return;
  
  const text = `Kanji: ${currentKanji}\n` +
               `Meanings: ${currentData.meanings.join(', ')}\n` +
               `Kun'yomi: ${currentData.kunyomi.join(', ')}\n` +
               `On'yomi: ${currentData.onyomi.join(', ')}\n` +
               `Strokes: ${currentData.strokes}\n` +
               `JLPT Level: ${currentData.jlpt}\n\n` +
               `Study Tip: Use the stroke animation tool to practice writing this kanji!`;
  
  navigator.clipboard?.writeText(text).then(() => {
    const card = document.currentScript?.closest('.card') || document;
    const btn = card.querySelector('[onclick="khCopyInfo()"]');
    btn.innerHTML = 'ğŸ“‹ Copied!';
    setTimeout(() => {
      btn.innerHTML = 'ğŸ“‹ Copy Info';
    }, 2000);
  });
}

function khResetTool() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Reset input
  card.querySelector('#kh-kanji-input').value = '';
  
  // Reset animation
  khResetAnimation();
  
  // Reset to defaults
  khSetJLPTLevel('N5');
  khSetTool('stroke');
  khLookupKanji('æ—¥');
  khClearCanvas();
  
  // Hide results section
  card.querySelector('#kh-results-section').style.display = 'none';
  
  // Visual feedback
  const btn = card.querySelector('[onclick="khResetTool()"]');
  btn.innerHTML = 'âœ… Reset Complete';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ”„ Reset';
  }, 1000);
}
</script>

<style>
/* Kanji Helper specific styles */
#kanji-helper-title {
  color: var(--accent);
  margin-top: 0;
  position: relative;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(45,212,255,0.2);
}

/* Kanji character display */
#kh-kanji-character {
  font-family: "MS Mincho", "SimSun", "Hiragino Mincho Pro", serif;
  text-shadow: 0 4px 20px rgba(255,204,0,0.3);
}

/* Stroke animation canvas */
#kh-animation-canvas {
  background: white;
  border: 1px solid rgba(0,0,0,0.1);
}

/* Animation guide items */
#kh-stroke-guide > div {
  cursor: pointer;
  transition: all 0.2s;
}

#kh-stroke-guide > div:hover {
  transform: translateY(-2px);
  background: rgba(45,212,255,0.1) !important;
  border: 1px solid rgba(45,212,255,0.3);
}

/* Flashcard animation */
@keyframes flip-card {
  0% { transform: rotateY(0deg); }
  50% { transform: rotateY(90deg); }
  100% { transform: rotateY(0deg); }
}

.flip-animation {
  animation: flip-card 0.6s ease;
}

/* Writing canvas styling */
#kh-writing-canvas {
  background: white;
  touch-action: none;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  #kh-kanji-character {
    font-size: 80px !important;
  }
  
  .actions {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  [style*="grid-template-columns:repeat(5,1fr)"] {
    grid-template-columns: repeat(3, 1fr) !important;
  }
  
  [style*="grid-template-columns:1fr auto 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  [style*="grid-template-columns:auto 1fr"] {
    grid-template-columns: 1fr !important;
    gap: 16px !important;
  }
  
  #kh-animation-canvas {
    width: 150px !important;
    height: 150px !important;
  }
}

/* Japanese text styling */
.japanese-text {
  font-family: "Hiragino Kaku Gothic Pro", "Meiryo", sans-serif;
}

.kanji-large {
  font-family: "MS Mincho", "SimSun", "Hiragino Mincho Pro", serif;
  font-weight: bold;
}

/* Pulse animation for current stroke */
@keyframes pulse {
  0% { opacity: 1; }
  50% { opacity: 0.7; }
  100% { opacity: 1; }
}

.stroke-pulse {
  animation: pulse 1s infinite;
}
</style>
