<!-- cards/macros-calculator.html -->
<h2 id="macros-calculator-title" style="margin-top:0;color:var(--accent);font-size:1.4rem;margin-bottom:8px;">ü•ó Smart Macros Calculator</h2>

<form aria-describedby="macros-calculator-desc" style="margin-bottom:20px;">
    <p id="macros-calculator-desc" class="small" style="color:rgba(230,250,255,0.9);margin-bottom:20px;line-height:1.5;">
        <span style="color:var(--accent);font-weight:500;">üèãÔ∏è Achieve your goals:</span> Calculate protein, carbs, and fats for weight loss, muscle gain, or maintenance. Get personalized meal plans and food suggestions.
    </p>
    
    <!-- GOAL SELECTOR -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px;">
        <button type="button" onclick="mcSetGoal('loss')" class="goal-btn active" 
                style="padding:12px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all 0.2s ease;">
            <span style="font-size:20px;">üìâ</span>
            <span style="font-size:11px;">Weight Loss</span>
        </button>
        <button type="button" onclick="mcSetGoal('maintenance')" class="goal-btn"
                style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all 0.2s ease;">
            <span style="font-size:20px;">‚öñÔ∏è</span>
            <span style="font-size:11px;">Maintenance</span>
        </button>
        <button type="button" onclick="mcSetGoal('gain')" class="goal-btn"
                style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;transition:all 0.2s ease;">
            <span style="font-size:20px;">üìà</span>
            <span style="font-size:11px;">Muscle Gain</span>
        </button>
    </div>
    
    <!-- PERSONAL INFO -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <div>
            <label for="mc-age" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">üë§</span> Age
            </label>
            <input id="mc-age" type="number" min="15" max="100" value="30"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:15px;">
        </div>
        
        <div>
            <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">‚ö•</span> Gender
            </label>
            <div style="display:flex;gap:8px;">
                <button type="button" onclick="mcSetGender('male')" id="mc-male-btn"
                        style="flex:1;padding:10px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;text-align:center;">
                    Male
                </button>
                <button type="button" onclick="mcSetGender('female')" id="mc-female-btn"
                        style="flex:1;padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;text-align:center;">
                    Female
                </button>
            </div>
        </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:14px;margin-bottom:16px;">
        <div>
            <label for="mc-weight" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">‚öñÔ∏è</span> Weight (kg)
            </label>
            <input id="mc-weight" type="number" min="40" max="200" step="0.5" value="70"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:15px;">
        </div>
        
        <div>
            <label for="mc-height" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">üìè</span> Height (cm)
            </label>
            <input id="mc-height" type="number" min="140" max="220" value="175"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:15px;">
        </div>
    </div>
    
    <!-- ACTIVITY LEVEL -->
    <div style="margin-bottom:16px;">
        <label for="mc-activity" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;font-size:14px;">
            <span style="font-size:16px;">üèÉ</span> Activity Level
        </label>
        <select id="mc-activity" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
            <option value="1.2">Sedentary (little or no exercise)</option>
            <option value="1.375" selected>Lightly active (light exercise 1-3 days/week)</option>
            <option value="1.55">Moderately active (moderate exercise 3-5 days/week)</option>
            <option value="1.725">Very active (hard exercise 6-7 days/week)</option>
            <option value="1.9">Extra active (very hard exercise & physical job)</option>
        </select>
    </div>
    
    <!-- MACRO RATIO CONTROLS -->
    <div style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <label style="display:block;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">üìä</span> Macro Ratios
            </label>
            <div id="mc-ratio-total" style="font-size:13px;color:var(--accent);font-weight:500;">Total: 100%</div>
        </div>
        
        <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
            <!-- Protein -->
            <div style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <div style="color:#2dd4ff;font-weight:500;">
                        <span style="font-size:16px;">üçó</span> Protein
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <input id="mc-protein-slider" type="range" min="10" max="50" value="30" step="1"
                               style="width:120px;height:6px;border-radius:3px;background:rgba(45,212,255,0.3);outline:none;"
                               oninput="mcUpdateProtein(this.value)">
                        <span id="mc-protein-value" style="min-width:40px;text-align:center;color:#2dd4ff;font-weight:500;">30%</span>
                    </div>
                </div>
                <div style="height:6px;background:rgba(45,212,255,0.1);border-radius:3px;overflow:hidden;">
                    <div id="mc-protein-bar" style="height:100%;background:linear-gradient(90deg, #2dd4ff, #39ff14);width:30%;"></div>
                </div>
            </div>
            
            <!-- Carbs -->
            <div style="margin-bottom:12px;">
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <div style="color:#ffcc00;font-weight:500;">
                        <span style="font-size:16px;">üçû</span> Carbohydrates
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <input id="mc-carbs-slider" type="range" min="20" max="60" value="40" step="1"
                               style="width:120px;height:6px;border-radius:3px;background:rgba(255,204,0,0.3);outline:none;"
                               oninput="mcUpdateCarbs(this.value)">
                        <span id="mc-carbs-value" style="min-width:40px;text-align:center;color:#ffcc00;font-weight:500;">40%</span>
                    </div>
                </div>
                <div style="height:6px;background:rgba(255,204,0,0.1);border-radius:3px;overflow:hidden;">
                    <div id="mc-carbs-bar" style="height:100%;background:linear-gradient(90deg, #ffcc00, #ff2d55);width:40%;"></div>
                </div>
            </div>
            
            <!-- Fat -->
            <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
                    <div style="color:#ff2d55;font-weight:500;">
                        <span style="font-size:16px;">ü•ë</span> Fat
                    </div>
                    <div style="display:flex;align-items:center;gap:12px;">
                        <input id="mc-fat-slider" type="range" min="15" max="40" value="30" step="1"
                               style="width:120px;height:6px;border-radius:3px;background:rgba(255,45,85,0.3);outline:none;"
                               oninput="mcUpdateFat(this.value)">
                        <span id="mc-fat-value" style="min-width:40px;text-align:center;color:#ff2d55;font-weight:500;">30%</span>
                    </div>
                </div>
                <div style="height:6px;background:rgba(255,45,85,0.1);border-radius:3px;overflow:hidden;">
                    <div id="mc-fat-bar" style="height:100%;background:linear-gradient(90deg, #ff2d55, #9d4edd);width:30%;"></div>
                </div>
            </div>
            
            <input type="hidden" id="mc-protein" value="30">
            <input type="hidden" id="mc-carbs" value="40">
            <input type="hidden" id="mc-fat" value="30">
        </div>
    </div>
    
    <!-- CUSTOM CALORIES OPTION -->
    <div style="margin-bottom:20px;">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
            <label style="display:block;color:var(--accent);font-weight:500;font-size:14px;">
                <span style="font-size:16px;">üî•</span> Daily Calories
            </label>
            <button type="button" onclick="mcToggleCustomCalories()" id="mc-calories-toggle" 
                    style="padding:4px 8px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:4px;cursor:pointer;font-size:11px;">
                Custom
            </button>
        </div>
        
        <div id="mc-custom-calories-section" style="display:none;">
            <input id="mc-custom-calories" type="number" min="1200" max="5000" step="50" value="2000"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:inherit;font-size:15px;">
            <div style="font-size:11px;color:rgba(230,250,255,0.5);margin-top:4px;">
                Enter your target daily calorie intake
            </div>
        </div>
        
        <div id="mc-calculated-calories" style="text-align:center;padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;border:1px solid rgba(45,212,255,0.3);">
            <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Recommended Calories</div>
            <div id="mc-recommended-calories" style="font-size:20px;font-weight:600;color:var(--accent);">‚Äì</div>
        </div>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div class="actions" style="display:flex;gap:12px;margin-top:20px;">
        <button type="button" onclick="mcCalculate()" id="mc-calculate-btn"
                style="flex:2;padding:14px 20px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.5);border-radius:10px;color:var(--accent);cursor:pointer;font-weight:600;font-size:15px;display:flex;align-items:center;justify-content:center;gap:8px;transition:transform 0.2s ease;">
            <span style="font-size:18px;">ü•ó</span> Calculate Macros
        </button>
        
        <button type="button" onclick="mcGenerateMealPlan()" id="mc-mealplan-btn"
                style="padding:14px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:10px;cursor:pointer;font-weight:500;display:flex;align-items:center;gap:6px;">
            <span style="font-size:16px;">üçΩÔ∏è</span> Meal Plan
        </button>
        
        <button type="button" onclick="mcResetAll()"
                style="padding:14px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:inherit;cursor:pointer;display:flex;align-items:center;gap:6px;">
            <span style="font-size:16px;">üîÑ</span> Reset
        </button>
    </div>
</form>

<!-- RESULTS AREA -->
<div class="results" aria-live="polite" style="margin-top:24px;">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <h3 class="small" style="color:var(--accent);font-size:16px;margin:0;display:flex;align-items:center;gap:8px;">
            <span style="font-size:18px;">üìä</span> Your Macronutrients
        </h3>
        <div id="mc-stats" style="display:flex;gap:12px;font-size:12px;color:rgba(230,250,255,0.7);">
            <span>Calories: <span id="mc-total-calories">‚Äì</span></span>
            <span>Goal: <span id="mc-goal-display">Weight Loss</span></span>
        </div>
    </div>
    
    <!-- MACRO DISTRIBUTION CHART -->
    <div style="margin-bottom:16px;">
        <div style="text-align:center;margin-bottom:8px;font-size:13px;color:var(--accent);font-weight:500;">
            <span style="font-size:16px;">üìà</span> Macro Distribution
        </div>
        <div style="display:flex;height:120px;margin-bottom:12px;background:rgba(20,20,20,0.5);border-radius:8px;border:1px solid rgba(45,212,255,0.2);padding:12px;position:relative;">
            <div id="mc-pie-chart" style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;">
                <!-- Pie chart will be generated here -->
                <div style="text-align:center;color:rgba(230,250,255,0.5);">
                    Calculate to see distribution
                </div>
            </div>
        </div>
    </div>
    
    <!-- MACRO BREAKDOWN -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px;">
        <div style="text-align:center;padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;border:1px solid rgba(45,212,255,0.3);">
            <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">
                <span style="font-size:14px;">üçó</span> Protein
            </div>
            <div id="mc-protein-grams" style="font-size:18px;font-weight:600;color:#2dd4ff;">‚Äì g</div>
            <div id="mc-protein-calories" style="font-size:11px;color:rgba(230,250,255,0.5);margin-top:2px;">‚Äì kcal</div>
        </div>
        
        <div style="text-align:center;padding:12px;background:rgba(255,204,0,0.1);border-radius:8px;border:1px solid rgba(255,204,0,0.3);">
            <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">
                <span style="font-size:14px;">üçû</span> Carbs
            </div>
            <div id="mc-carbs-grams" style="font-size:18px;font-weight:600;color:#ffcc00;">‚Äì g</div>
            <div id="mc-carbs-calories" style="font-size:11px;color:rgba(230,250,255,0.5);margin-top:2px;">‚Äì kcal</div>
        </div>
        
        <div style="text-align:center;padding:12px;background:rgba(255,45,85,0.1);border-radius:8px;border:1px solid rgba(255,45,85,0.3);">
            <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">
                <span style="font-size:14px;">ü•ë</span> Fat
            </div>
            <div id="mc-fat-grams" style="font-size:18px;font-weight:600;color:#ff2d55;">‚Äì g</div>
            <div id="mc-fat-calories" style="font-size:11px;color:rgba(230,250,255,0.5);margin-top:2px;">‚Äì kcal</div>
        </div>
    </div>
    
    <!-- DAILY TARGETS -->
    <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);margin-bottom:16px;">
        <div style="font-size:13px;color:var(--accent);font-weight:500;margin-bottom:8px;">
            <span style="font-size:16px;">üéØ</span> Daily Targets
        </div>
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;font-size:12px;">
            <div>
                <div style="color:rgba(230,250,255,0.7);margin-bottom:2px;">Protein per meal (3 meals):</div>
                <div id="mc-protein-per-meal" style="color:#2dd4ff;font-weight:500;">‚Äì g</div>
            </div>
            <div>
                <div style="color:rgba(230,250,255,0.7);margin-bottom:2px;">Protein per kg body weight:</div>
                <div id="mc-protein-per-kg" style="color:#2dd4ff;font-weight:500;">‚Äì g/kg</div>
            </div>
        </div>
    </div>
    
    <!-- FOOD SUGGESTIONS -->
    <div id="mc-food-suggestions" style="display:none;margin-top:12px;padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;border-left:3px solid #39ff14;">
        <div style="font-weight:600;color:#39ff14;margin-bottom:8px;">üçé Food Suggestions</div>
        <div id="mc-food-content" style="font-size:12px;color:rgba(230,250,255,0.9);">
            <!-- Food suggestions will be generated here -->
        </div>
    </div>
</div>

<!-- NUTRITION TIPS -->
<div style="margin-top:20px;padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border-left:3px solid var(--accent);">
    <div style="display:flex;align-items:flex-start;gap:8px;">
        <span style="font-size:18px;color:var(--accent);">üí°</span>
        <div style="flex:1;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">Nutrition Tips</div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:12px;">
                <div>
                    <div style="font-weight:500;color:rgba(230,250,255,0.9);margin-bottom:4px;">Protein Timing</div>
                    <div style="color:rgba(230,250,255,0.7);">Spread protein intake throughout the day for optimal muscle synthesis.</div>
                </div>
                <div>
                    <div style="font-weight:500;color:rgba(230,250,255,0.9);margin-bottom:4px;">Fiber</div>
                    <div style="color:rgba(230,250,255,0.7);">Aim for 25-30g of fiber daily for digestive health.</div>
                </div>
                <div>
                    <div style="font-weight:500;color:rgba(230,250,255,0.9);margin-bottom:4px;">Hydration</div>
                    <div style="color:rgba(230,250,255,0.7);">Drink 30-35ml per kg of body weight daily.</div>
                </div>
                <div>
                    <div style="font-weight:500;color:rgba(230,250,255,0.9);margin-bottom:4px;">Consistency</div>
                    <div style="color:rgba(230,250,255,0.7);">Track intake consistently for 4+ weeks to see results.</div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- MEAL PLAN MODAL (Hidden by default) -->
<div id="mc-mealplan-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;padding:20px;overflow-y:auto;">
    <div style="max-width:600px;margin:40px auto;background:var(--panel);border-radius:12px;border:1px solid var(--border);padding:24px;position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h3 style="color:var(--accent);margin:0;font-size:1.2rem;">üçΩÔ∏è Personalized Meal Plan</h3>
            <button onclick="mcCloseMealPlan()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px;">√ó</button>
        </div>
        
        <div id="mc-mealplan-content">
            <!-- Meal plan content will be generated here -->
        </div>
    </div>
</div>

<script>
/* macros-calculator.html
   - Advanced macronutrient calculator with meal planning
   - Scoped with mc- prefix
*/

let currentGoal = 'loss';
let currentGender = 'male';
let lastMacroResults = null;

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    console.log('Smart Macros Calculator ready! ü•ó');
    
    // Set up event listeners for auto-calculation
    document.getElementById('mc-age').addEventListener('input', () => mcCalculateCalories());
    document.getElementById('mc-weight').addEventListener('input', () => mcCalculateCalories());
    document.getElementById('mc-height').addEventListener('input', () => mcCalculateCalories());
    document.getElementById('mc-activity').addEventListener('input', () => mcCalculateCalories());
    
    // Initial calculation
    mcCalculateCalories();
});

// Set goal
function mcSetGoal(goal) {
    currentGoal = goal;
    
    // Update button states
    document.querySelectorAll('.goal-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.border = '1px solid rgba(255,255,255,0.1)';
        btn.style.color = 'inherit';
    });
    
    const activeBtn = document.querySelector(`[onclick="mcSetGoal('${goal}')"]`);
    if (activeBtn) {
        activeBtn.style.background = 'rgba(45,212,255,0.2)';
        activeBtn.style.border = '2px solid var(--accent)';
        activeBtn.style.color = 'var(--accent)';
    }
    
    // Update goal display
    const goalNames = {
        'loss': 'Weight Loss',
        'maintenance': 'Maintenance',
        'gain': 'Muscle Gain'
    };
    document.getElementById('mc-goal-display').textContent = goalNames[goal];
    
    // Update macro ratios based on goal
    switch(goal) {
        case 'loss':
            mcUpdateProtein('30');
            mcUpdateCarbs('40');
            mcUpdateFat('30');
            break;
        case 'maintenance':
            mcUpdateProtein('25');
            mcUpdateCarbs('50');
            mcUpdateFat('25');
            break;
        case 'gain':
            mcUpdateProtein('35');
            mcUpdateCarbs('45');
            mcUpdateFat('20');
            break;
    }
    
    mcCalculateCalories();
    mcShowNotification(`Goal set to: ${goalNames[goal]}`, 'info');
}

// Set gender
function mcSetGender(gender) {
    currentGender = gender;
    
    // Update button states
    const maleBtn = document.getElementById('mc-male-btn');
    const femaleBtn = document.getElementById('mc-female-btn');
    
    if (gender === 'male') {
        maleBtn.style.background = 'rgba(45,212,255,0.2)';
        maleBtn.style.border = '2px solid var(--accent)';
        maleBtn.style.color = 'var(--accent)';
        
        femaleBtn.style.background = 'rgba(255,255,255,0.05)';
        femaleBtn.style.border = '1px solid rgba(255,255,255,0.1)';
        femaleBtn.style.color = 'inherit';
    } else {
        maleBtn.style.background = 'rgba(255,255,255,0.05)';
        maleBtn.style.border = '1px solid rgba(255,255,255,0.1)';
        maleBtn.style.color = 'inherit';
        
        femaleBtn.style.background = 'rgba(45,212,255,0.2)';
        femaleBtn.style.border = '2px solid var(--accent)';
        femaleBtn.style.color = 'var(--accent)';
    }
    
    mcCalculateCalories();
}

// Update protein percentage
function mcUpdateProtein(value) {
    document.getElementById('mc-protein').value = value;
    document.getElementById('mc-protein-slider').value = value;
    document.getElementById('mc-protein-value').textContent = value + '%';
    document.getElementById('mc-protein-bar').style.width = value + '%';
    mcUpdateRatioTotal();
    mcCalculateCalories();
}

// Update carbs percentage
function mcUpdateCarbs(value) {
    document.getElementById('mc-carbs').value = value;
    document.getElementById('mc-carbs-slider').value = value;
    document.getElementById('mc-carbs-value').textContent = value + '%';
    document.getElementById('mc-carbs-bar').style.width = value + '%';
    mcUpdateRatioTotal();
    mcCalculateCalories();
}

// Update fat percentage
function mcUpdateFat(value) {
    document.getElementById('mc-fat').value = value;
    document.getElementById('mc-fat-slider').value = value;
    document.getElementById('mc-fat-value').textContent = value + '%';
    document.getElementById('mc-fat-bar').style.width = value + '%';
    mcUpdateRatioTotal();
    mcCalculateCalories();
}

// Update ratio total
function mcUpdateRatioTotal() {
    const protein = parseInt(document.getElementById('mc-protein').value);
    const carbs = parseInt(document.getElementById('mc-carbs').value);
    const fat = parseInt(document.getElementById('mc-fat').value);
    const total = protein + carbs + fat;
    
    const totalElement = document.getElementById('mc-ratio-total');
    totalElement.textContent = `Total: ${total}%`;
    
    if (total !== 100) {
        totalElement.style.color = '#ff2d55';
        totalElement.innerHTML += ' <span style="color:#ff2d55;font-size:11px;">‚ö†Ô∏è Adjust</span>';
    } else {
        totalElement.style.color = 'var(--accent)';
    }
}

// Toggle custom calories
function mcToggleCustomCalories() {
    const section = document.getElementById('mc-custom-calories-section');
    const calculated = document.getElementById('mc-calculated-calories');
    const toggleBtn = document.getElementById('mc-calories-toggle');
    
    if (section.style.display === 'none') {
        section.style.display = 'block';
        calculated.style.display = 'none';
        toggleBtn.innerHTML = 'Auto';
        toggleBtn.style.background = 'rgba(255,45,85,0.1)';
        toggleBtn.style.borderColor = 'rgba(255,45,85,0.3)';
        toggleBtn.style.color = '#ff2d55';
    } else {
        section.style.display = 'none';
        calculated.style.display = 'block';
        toggleBtn.innerHTML = 'Custom';
        toggleBtn.style.background = 'rgba(57,255,20,0.1)';
        toggleBtn.style.borderColor = 'rgba(57,255,20,0.3)';
        toggleBtn.style.color = '#39ff14';
    }
    
    mcCalculateCalories();
}

// Calculate recommended calories
function mcCalculateCalories() {
    const age = parseInt(document.getElementById('mc-age').value) || 30;
    const weight = parseFloat(document.getElementById('mc-weight').value) || 70;
    const height = parseFloat(document.getElementById('mc-height').value) || 175;
    const activity = parseFloat(document.getElementById('mc-activity').value) || 1.375;
    
    // Calculate BMR (Basal Metabolic Rate) using Mifflin-St Jeor Equation
    let bmr;
    if (currentGender === 'male') {
        bmr = 10 * weight + 6.25 * height - 5 * age + 5;
    } else {
        bmr = 10 * weight + 6.25 * height - 5 * age - 161;
    }
    
    // Calculate TDEE (Total Daily Energy Expenditure)
    let tdee = bmr * activity;
    
    // Adjust based on goal
    switch(currentGoal) {
        case 'loss':
            tdee = tdee * 0.85; // 15% deficit for weight loss
            break;
        case 'gain':
            tdee = tdee * 1.15; // 15% surplus for muscle gain
            break;
        // maintenance uses TDEE as is
    }
    
    // Round to nearest 50
    tdee = Math.round(tdee / 50) * 50;
    
    // Update display
    document.getElementById('mc-recommended-calories').textContent = tdee.toLocaleString() + ' kcal';
    
    // Auto-calculate macros if using recommended calories
    if (document.getElementById('mc-custom-calories-section').style.display === 'none') {
        mcCalculate();
    }
}

// Main calculation function
function mcCalculate() {
    // Get calories
    let calories;
    if (document.getElementById('mc-custom-calories-section').style.display === 'none') {
        const recommended = document.getElementById('mc-recommended-calories').textContent;
        calories = parseFloat(recommended.replace(/[^\d.]/g, '')) || 2000;
    } else {
        calories = parseFloat(document.getElementById('mc-custom-calories').value) || 2000;
    }
    
    // Get macro percentages
    const proteinPct = parseInt(document.getElementById('mc-protein').value) || 0;
    const carbsPct = parseInt(document.getElementById('mc-carbs').value) || 0;
    const fatPct = parseInt(document.getElementById('mc-fat').value) || 0;
    
    // Check if percentages total 100
    if (proteinPct + carbsPct + fatPct !== 100) {
        mcShowNotification('Macro percentages must total 100%', 'warning');
        return;
    }
    
    // Calculate grams (Protein: 4 cal/g, Carbs: 4 cal/g, Fat: 9 cal/g)
    const proteinGrams = Math.round((calories * (proteinPct / 100)) / 4);
    const carbsGrams = Math.round((calories * (carbsPct / 100)) / 4);
    const fatGrams = Math.round((calories * (fatPct / 100)) / 9);
    
    // Calculate calories from each macro
    const proteinCalories = proteinGrams * 4;
    const carbsCalories = carbsGrams * 4;
    const fatCalories = fatGrams * 9;
    
    // Store results for later use
    lastMacroResults = {
        calories: calories,
        protein: { grams: proteinGrams, calories: proteinCalories, percent: proteinPct },
        carbs: { grams: carbsGrams, calories: carbsCalories, percent: carbsPct },
        fat: { grams: fatGrams, calories: fatCalories, percent: fatPct }
    };
    
    // Update display
    mcUpdateDisplay();
}

// Update display with results
function mcUpdateDisplay() {
    if (!lastMacroResults) return;
    
    const { calories, protein, carbs, fat } = lastMacroResults;
    const weight = parseFloat(document.getElementById('mc-weight').value) || 70;
    
    // Update total calories
    document.getElementById('mc-total-calories').textContent = calories.toLocaleString();
    
    // Update protein
    document.getElementById('mc-protein-grams').textContent = protein.grams + ' g';
    document.getElementById('mc-protein-calories').textContent = protein.calories + ' kcal';
    
    // Update carbs
    document.getElementById('mc-carbs-grams').textContent = carbs.grams + ' g';
    document.getElementById('mc-carbs-calories').textContent = carbs.calories + ' kcal';
    
    // Update fat
    document.getElementById('mc-fat-grams').textContent = fat.grams + ' g';
    document.getElementById('mc-fat-calories').textContent = fat.calories + ' kcal';
    
    // Update daily targets
    const proteinPerMeal = Math.round(protein.grams / 3);
    document.getElementById('mc-protein-per-meal').textContent = proteinPerMeal + ' g';
    
    const proteinPerKg = (protein.grams / weight).toFixed(1);
    document.getElementById('mc-protein-per-kg').textContent = proteinPerKg + ' g/kg';
    
    // Update pie chart
    mcUpdatePieChart();
    
    // Show food suggestions
    mcGenerateFoodSuggestions();
    
    // Show notification
    mcShowNotification('Macros calculated successfully! ü•ó', 'success');
}

// Update pie chart visualization
function mcUpdatePieChart() {
    if (!lastMacroResults) return;
    
    const { protein, carbs, fat } = lastMacroResults;
    const pieChart = document.getElementById('mc-pie-chart');
    
    // Create pie chart using conic gradients
    pieChart.innerHTML = `
        <div style="width:100px;height:100px;border-radius:50%;background:conic-gradient(
            #2dd4ff 0% ${protein.percent}%,
            #ffcc00 ${protein.percent}% ${protein.percent + carbs.percent}%,
            #ff2d55 ${protein.percent + carbs.percent}% 100%
        );position:relative;">
            <div style="position:absolute;top:50%;left:50%;transform:translate(-50%, -50%);width:60px;height:60px;background:rgba(20,20,20,0.8);border-radius:50%;"></div>
        </div>
        <div style="margin-left:16px;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <div style="width:12px;height:12px;background:#2dd4ff;border-radius:2px;"></div>
                <div style="font-size:12px;color:rgba(230,250,255,0.9);">Protein: ${protein.percent}%</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                <div style="width:12px;height:12px;background:#ffcc00;border-radius:2px;"></div>
                <div style="font-size:12px;color:rgba(230,250,255,0.9);">Carbs: ${carbs.percent}%</div>
            </div>
            <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:12px;height:12px;background:#ff2d55;border-radius:2px;"></div>
                <div style="font-size:12px;color:rgba(230,250,255,0.9);">Fat: ${fat.percent}%</div>
            </div>
        </div>
    `;
}

// Generate food suggestions
function mcGenerateFoodSuggestions() {
    if (!lastMacroResults) return;
    
    const { protein, carbs, fat } = lastMacroResults;
    const foodContainer = document.getElementById('mc-food-suggestions');
    const foodContent = document.getElementById('mc-food-content');
    
    let suggestions = [];
    
    // Protein suggestions
    suggestions.push(`<strong style="color:#2dd4ff;">Protein (${protein.grams}g):</strong> Chicken breast, Greek yogurt, eggs, tofu, lentils`);
    
    // Carb suggestions based on goal
    if (currentGoal === 'loss') {
        suggestions.push(`<strong style="color:#ffcc00;">Carbs (${carbs.grams}g):</strong> Brown rice, sweet potatoes, quinoa, oats, berries`);
    } else {
        suggestions.push(`<strong style="color:#ffcc00;">Carbs (${carbs.grams}g):</strong> Whole grains, potatoes, fruits, vegetables, legumes`);
    }
    
    // Fat suggestions
    suggestions.push(`<strong style="color:#ff2d55;">Fat (${fat.grams}g):</strong> Avocado, nuts, olive oil, fatty fish, seeds`);
    
    // Fiber reminder
    suggestions.push(`<strong style="color:#39ff14;">Fiber:</strong> Aim for 25-30g daily from vegetables, fruits, and whole grains`);
    
    foodContent.innerHTML = suggestions.map(s => `<div style="margin-bottom:6px;">${s}</div>`).join('');
    foodContainer.style.display = 'block';
}

// Generate meal plan
function mcGenerateMealPlan() {
    if (!lastMacroResults) {
        mcShowNotification('Calculate macros first!', 'warning');
        return;
    }
    
    const { protein, carbs, fat } = lastMacroResults;
    const modal = document.getElementById('mc-mealplan-modal');
    const content = document.getElementById('mc-mealplan-content');
    
    // Sample meal plan based on goals and macros
    const mealPlans = {
        loss: {
            breakfast: `Omelette with vegetables (30g protein, 15g carbs, 20g fat)`,
            lunch: `Grilled chicken salad (40g protein, 20g carbs, 15g fat)`,
            dinner: `Salmon with roasted vegetables (35g protein, 25g carbs, 25g fat)`,
            snacks: `Greek yogurt, almonds, apple slices`
        },
        maintenance: {
            breakfast: `Oatmeal with berries and nuts (20g protein, 50g carbs, 15g fat)`,
            lunch: `Quinoa bowl with chickpeas and vegetables (25g protein, 60g carbs, 20g fat)`,
            dinner: `Lean beef stir-fry with rice (40g protein, 40g carbs, 25g fat)`,
            snacks: `Protein shake, banana, rice cakes`
        },
        gain: {
            breakfast: `Protein pancakes with syrup (40g protein, 80g carbs, 15g fat)`,
            lunch: `Chicken and rice with vegetables (50g protein, 100g carbs, 20g fat)`,
            dinner: `Steak with sweet potatoes (45g protein, 60g carbs, 30g fat)`,
            snacks: `Peanut butter sandwich, protein bar, trail mix`
        }
    };
    
    const plan = mealPlans[currentGoal];
    
    let html = `
        <div style="margin-bottom:16px;padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">Daily Targets</div>
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:12px;">
                <div style="text-align:center;">
                    <div style="color:#2dd4ff;font-weight:500;">${protein.grams}g Protein</div>
                </div>
                <div style="text-align:center;">
                    <div style="color:#ffcc00;font-weight:500;">${carbs.grams}g Carbs</div>
                </div>
                <div style="text-align:center;">
                    <div style="color:#ff2d55;font-weight:500;">${fat.grams}g Fat</div>
                </div>
            </div>
        </div>
        
        <div style="margin-bottom:16px;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">üç≥ Breakfast</div>
            <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
                ${plan.breakfast}
            </div>
        </div>
        
        <div style="margin-bottom:16px;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">üç± Lunch</div>
            <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
                ${plan.lunch}
            </div>
        </div>
        
        <div style="margin-bottom:16px;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">üçΩÔ∏è Dinner</div>
            <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
                ${plan.dinner}
            </div>
        </div>
        
        <div style="margin-bottom:16px;">
            <div style="font-weight:600;color:var(--accent);margin-bottom:8px;">ü•ú Snacks</div>
            <div style="background:rgba(255,255,255,0.03);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
                ${plan.snacks}
            </div>
        </div>
        
        <div style="padding:12px;background:rgba(57,255,20,0.1);border-radius:8px;border-left:3px solid #39ff14;">
            <div style="font-weight:600;color:#39ff14;margin-bottom:4px;">üí° Tips</div>
            <div style="font-size:12px;color:rgba(230,250,255,0.9);">
                ‚Ä¢ Drink 3-4 liters of water daily<br>
                ‚Ä¢ Eat protein within 30 minutes post-workout<br>
                ‚Ä¢ Include vegetables with every meal<br>
                ‚Ä¢ Track your intake for best results
            </div>
        </div>
    `;
    
    content.innerHTML = html;
    modal.style.display = 'block';
}

// Close meal plan modal
function mcCloseMealPlan() {
    document.getElementById('mc-mealplan-modal').style.display = 'none';
}

// Reset everything
function mcResetAll() {
    if (confirm('Reset all macro calculations?')) {
        // Reset form
        document.getElementById('mc-age').value = '30';
        document.getElementById('mc-weight').value = '70';
        document.getElementById('mc-height').value = '175';
        document.getElementById('mc-activity').value = '1.375';
        
        // Reset to default settings
        mcSetGoal('loss');
        mcSetGender('male');
        
        // Reset macro ratios
        mcUpdateProtein('30');
        mcUpdateCarbs('40');
        mcUpdateFat('30');
        
        // Reset custom calories
        document.getElementById('mc-custom-calories-section').style.display = 'none';
        document.getElementById('mc-calculated-calories').style.display = 'block';
        document.getElementById('mc-calories-toggle').innerHTML = 'Custom';
        document.getElementById('mc-calories-toggle').style.background = 'rgba(57,255,20,0.1)';
        document.getElementById('mc-calories-toggle').style.borderColor = 'rgba(57,255,20,0.3)';
        document.getElementById('mc-calories-toggle').style.color = '#39ff14';
        
        // Clear results
        lastMacroResults = null;
        document.getElementById('mc-food-suggestions').style.display = 'none';
        
        mcCalculateCalories();
        mcCalculate();
        mcShowNotification('Macro calculator reset', 'info');
    }
}

// Notification system
function mcShowNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 12px 16px;
        background: ${type === 'success' ? 'rgba(57,255,20,0.15)' : 
                     type === 'error' ? 'rgba(255,45,85,0.15)' : 
                     type === 'warning' ? 'rgba(255,204,0,0.15)' : 
                     'rgba(45,212,255,0.15)'};
        border: 1px solid ${type === 'success' ? 'rgba(57,255,20,0.3)' : 
                           type === 'error' ? 'rgba(255,45,85,0.3)' : 
                           type === 'warning' ? 'rgba(255,204,0,0.3)' : 
                           'rgba(45,212,255,0.3)'};
        color: ${type === 'success' ? '#39ff14' : 
                type === 'error' ? '#ff2d55' : 
                type === 'warning' ? '#ffcc00' : 
                'var(--accent)'};
        border-radius: 8px;
        z-index: 10000;
        backdrop-filter: blur(10px);
        font-weight: 500;
        animation: mcSlideIn 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.animation = 'mcSlideOut 0.3s ease';
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 300);
    }, 3000);
}

// Add CSS animations
if (!document.querySelector('#mc-styles')) {
    const style = document.createElement('style');
    style.id = 'mc-styles';
    style.textContent = `
        @keyframes mcSlideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        @keyframes mcSlideOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100%); opacity: 0; }
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        button:active {
            transform: translateY(0);
        }
        input:focus, select:focus {
            border-color: var(--accent) !important;
            outline: none;
            box-shadow: 0 0 0 2px rgba(45,212,255,0.1);
        }
        .goal-btn:hover {
            transform: scale(1.05);
        }
        input[type="range"] {
            -webkit-appearance: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }
        #mc-mealplan-modal {
            backdrop-filter: blur(4px);
        }
    `;
    document.head.appendChild(style);
}
</script>

<style>
/* Card-specific responsive styles */
#macros-calculator-title {
    animation: mcFadeIn 0.5s ease;
}

@media (max-width: 768px) {
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        justify-content: center;
    }
    
    .goal-btn {
        padding: 10px !important;
        font-size: 10px !important;
    }
    
    #mc-age, #mc-weight, #mc-height {
        font-size: 14px !important;
        padding: 8px !important;
    }
    
    #mc-protein-slider, #mc-carbs-slider, #mc-fat-slider {
        width: 80px !important;
    }
}

@keyframes mcFadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}
</style>
