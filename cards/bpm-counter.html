<!-- cards/bpm-tap-counter.html -->
<h2 id="bpm-tap-counter-title">BPM Tap Counter (Pro)</h2>

<div class="description">
  Tap the button or press Space/click anywhere to measure tempo.
  <span class="disclaimer">Educational tool ‚Äî always double-check with a metronome.</span>
</div>

<div class="tool-body">
  <!-- MAIN DISPLAY -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 30px; margin-bottom: 25px; text-align: center;">
    <div id="btc-bpm-display" style="font-size: 4.5rem; font-weight: 800; margin: 20px 0; letter-spacing: -2px; color: #ff3366; font-feature-settings: 'tnum'; font-variant-numeric: tabular-nums;">
      --
    </div>
    
    <div id="btc-tempo-name" style="font-size: 1.3rem; color: rgba(230,250,255,0.7); height: 28px; margin-bottom: 15px;">
      <!-- Tempo name appears here -->
    </div>
    
    <!-- TAP BUTTON -->
    <div style="margin: 25px 0;">
      <button id="btc-tap-button" 
              style="font-size: 1.8rem; padding: 20px 40px; border-radius: 16px; background: #ff3366; color: white; border: none; cursor: pointer; box-shadow: 0 8px 25px rgba(255,51,102,0.4); transition: all 0.2s;">
        üî¥ TAP BEAT
      </button>
    </div>
    
    <!-- BEAT INDICATORS -->
    <div id="btc-beat-indicators" style="display: flex; justify-content: center; gap: 12px; margin: 20px 0;">
      <div class="btc-beat-dot"></div>
      <div class="btc-beat-dot"></div>
      <div class="btc-beat-dot"></div>
      <div class="btc-beat-dot"></div>
    </div>
    
    <!-- STATS -->
    <div style="margin-top: 20px; font-size: 0.95rem; color: rgba(230,250,255,0.7);">
      <div style="display: flex; justify-content: center; gap: 20px;">
        <div>Beats: <span id="btc-beat-count" style="color: #2dd4ff; font-weight: 600;">0</span></div>
        <div>Confidence: <span id="btc-confidence" style="color: #39ff14; font-weight: 600;">‚Äî</span></div>
        <div>Last: <span id="btc-last-tap" style="color: #ffa500;">‚Äî ms</span></div>
      </div>
    </div>
  </div>
  
  <!-- CONTROLS -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
    <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 15px; text-align: center;">
      ‚öôÔ∏è Controls & Settings
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <button id="btc-reset-btn" 
              style="padding: 12px; background: rgba(255,255,255,0.08); color: #e6faff; border: 1px solid rgba(255,255,255,0.2); border-radius: 8px; cursor: pointer; font-weight: 600;">
        üîÑ Reset Counter
      </button>
      
      <button id="btc-audio-toggle" 
              style="padding: 12px; background: rgba(57,255,20,0.1); color: #39ff14; border: 1px solid rgba(57,255,20,0.3); border-radius: 8px; cursor: pointer; font-weight: 600;">
        üîä Audio: ON
      </button>
    </div>
    
    <div style="margin-top: 15px; padding: 12px; background: rgba(45,212,255,0.1); border-radius: 8px; border-left: 3px solid #2dd4ff;">
      <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 5px;">Keyboard Shortcuts:</div>
      <div style="color: rgba(230,250,255,0.8); font-size: 14px;">
        ‚Ä¢ <kbd>Space</kbd> or <kbd>Enter</kbd>: Tap beat<br>
        ‚Ä¢ <kbd>R</kbd>: Reset counter<br>
        ‚Ä¢ <kbd>M</kbd>: Toggle audio
      </div>
    </div>
  </div>
  
  <!-- TEMPO REFERENCE GUIDE -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
    <div style="color: #ffa500; font-weight: 600; margin-bottom: 15px;">
      üìä Tempo Reference Guide
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px;">
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #2dd4ff; font-weight: 600; font-size: 13px;">20‚Äì40 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Largo (very slow)</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #39ff14; font-weight: 600; font-size: 13px;">40‚Äì60 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Lentissimo / Grave</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #ffa500; font-weight: 600; font-size: 13px;">60‚Äì76 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Larghetto / Adagio</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #ff3366; font-weight: 600; font-size: 13px;">76‚Äì108 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Andante (walking)</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #9d4edd; font-weight: 600; font-size: 13px;">108‚Äì120 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Moderato</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #ff4d4d; font-weight: 600; font-size: 13px;">120‚Äì168 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Allegro (fast)</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #ffcc00; font-weight: 600; font-size: 13px;">168‚Äì200 BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Presto (very fast)</div>
      </div>
      <div style="background: rgba(20,20,20,0.7); padding: 10px; border-radius: 6px;">
        <div style="color: #ff1744; font-weight: 600; font-size: 13px;">200+ BPM</div>
        <div style="color: rgba(230,250,255,0.7); font-size: 12px;">Prestissimo</div>
      </div>
    </div>
  </div>
  
  <!-- TIPS & INFO -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px;">
    <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 15px;">
      üí° Tips for Accurate Measurement
    </div>
    
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
      <div style="background: rgba(45,212,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #2dd4ff;">
        <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 5px;">Steady Tempo</div>
        <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Tap consistently for at least 8 beats for accurate BPM</div>
      </div>
      
      <div style="background: rgba(57,255,20,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #39ff14;">
        <div style="color: #39ff14; font-weight: 600; margin-bottom: 5px;">Confidence Score</div>
        <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Higher = more consistent tapping. Aim for 95%+</div>
      </div>
      
      <div style="background: rgba(255,77,77,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #ff4d4d;">
        <div style="color: #ff4d4d; font-weight: 600; margin-bottom: 5px;">Warning</div>
        <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Always verify with a physical metronome for critical work</div>
      </div>
    </div>
  </div>
</div>

<style>
#bpm-tap-counter-title { 
  color: #ff3366; 
  margin-top: 0;
  margin-bottom: 10px;
}

.description {
  color: rgba(230,250,255,0.8);
  margin-bottom: 20px;
  font-size: 14px;
}

.disclaimer {
  display: block;
  color: rgba(255,165,0,0.8);
  font-size: 12px;
  margin-top: 5px;
  font-style: italic;
}

/* Beat dots */
.btc-beat-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  transition: all 0.3s;
}

.btc-beat-dot.active {
  background: #ff3366;
  transform: scale(1.6);
  box-shadow: 0 0 25px rgba(255,51,102,0.6);
}

/* Tap button animation */
#btc-tap-button:active, #btc-tap-button.tapping {
  transform: scale(0.94);
  box-shadow: 0 4px 15px rgba(255,51,102,0.4);
  background: #ff1744;
}

/* Flash animation for visual feedback */
.btc-flash {
  animation: btcFlash 0.1s;
}

@keyframes btcFlash {
  0% { background: rgba(255,51,102,0.3); }
  100% { background: transparent; }
}

/* Keyboard key styling */
kbd {
  background: rgba(30,30,30,0.7);
  color: #e6faff;
  padding: 2px 6px;
  border-radius: 4px;
  font-size: 0.85em;
  font-family: monospace;
  border: 1px solid rgba(255,255,255,0.2);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #btc-bpm-display {
    font-size: 3.5rem !important;
  }
  
  #btc-tap-button {
    font-size: 1.4rem !important;
    padding: 15px 30px !important;
  }
  
  .tool-body > div > div {
    grid-template-columns: 1fr !important;
  }
}
</style>

<script>
// ============================================
// BPM TAP COUNTER - PROPERLY SCOPED
// All functions prefixed with "btc" (BPM tap counter)
// ============================================

// Main state
let btcTaps = [];
let btcTimeoutHandle = null;
let btcAudioCtx = null;
let btcAudioEnabled = true;
let btcLastBPM = null;

// Elements
const btcDisplay = document.getElementById('btc-bpm-display');
const btcTempoNameEl = document.getElementById('btc-tempo-name');
const btcTapButton = document.getElementById('btc-tap-button');
const btcResetBtn = document.getElementById('btc-reset-btn');
const btcAudioToggle = document.getElementById('btc-audio-toggle');
const btcBeatCountEl = document.getElementById('btc-beat-count');
const btcConfidenceEl = document.getElementById('btc-confidence');
const btcLastTapEl = document.getElementById('btc-last-tap');
const btcDots = document.querySelectorAll('.btc-beat-dot');

// Tempo names database
const btcTempoNames = [
  {min: 0, max: 40, name: "Largo", color: "#2dd4ff"},
  {min: 40, max: 60, name: "Lentissimo / Grave", color: "#39ff14"},
  {min: 60, max: 66, name: "Larghissimo", color: "#ffa500"},
  {min: 66, max: 76, name: "Adagio", color: "#ffa500"},
  {min: 76, max: 108, name: "Andante", color: "#ff3366"},
  {min: 108, max: 120, name: "Moderato", color: "#9d4edd"},
  {min: 120, max: 156, name: "Allegro", color: "#ff4d4d"},
  {min: 156, max: 176, name: "Vivace", color: "#ffcc00"},
  {min: 172, max: 200, name: "Presto", color: "#ffcc00"},
  {min: 200, max: 1000, name: "Prestissimo", color: "#ff1744"}
];

// Get tempo name with color
function btcGetTempoName(bpm) {
  for (const t of btcTempoNames) {
    if (bpm >= t.min && bpm < t.max) return {name: t.name, color: t.color};
  }
  return bpm < 20 ? {name: "Larghissimo", color: "#2dd4ff"} : {name: "Prestissimo", color: "#ff1744"};
}

// Play click sound
function btcPlayClick() {
  if (!btcAudioEnabled) return;
  
  try {
    if (!btcAudioCtx) {
      btcAudioCtx = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const osc = btcAudioCtx.createOscillator();
    const amp = btcAudioCtx.createGain();
    osc.connect(amp);
    amp.connect(btcAudioCtx.destination);
    
    // Different frequency based on beat position
    const beatPos = btcTaps.length % 4;
    osc.frequency.value = beatPos === 0 ? 1000 : 800; // Higher pitch on first beat
    osc.type = "sine";
    
    amp.gain.setValueAtTime(0.15, btcAudioCtx.currentTime);
    amp.gain.exponentialRampToValueAtTime(0.001, btcAudioCtx.currentTime + 0.08);
    
    osc.start(btcAudioCtx.currentTime);
    osc.stop(btcAudioCtx.currentTime + 0.08);
  } catch (error) {
    console.warn("Audio context not available:", error);
  }
}

// Visual flash feedback
function btcFlash() {
  document.querySelector('.tool-body').classList.add('btc-flash');
  setTimeout(() => {
    document.querySelector('.tool-body').classList.remove('btc-flash');
  }, 100);
}

// Update beat dots
function btcUpdateDots() {
  btcDots.forEach((dot, i) => {
    const beatPos = btcTaps.length % 4;
    dot.classList.toggle('active', i === beatPos);
  });
}

// Calculate BPM with statistics
function btcCalculateBPM() {
  if (btcTaps.length < 2) {
    btcDisplay.textContent = "--";
    btcTempoNameEl.textContent = "";
    btcConfidenceEl.textContent = "‚Äî";
    btcLastTapEl.textContent = "‚Äî ms";
    return;
  }

  const intervals = [];
  for (let i = 1; i < btcTaps.length; i++) {
    intervals.push(btcTaps[i] - btcTaps[i-1]);
  }

  // Calculate mean and standard deviation
  const mean = intervals.reduce((a, b) => a + b) / intervals.length;
  const variance = intervals.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / intervals.length;
  const stdDev = Math.sqrt(variance);
  
  // Remove outliers (beyond 2 standard deviations)
  const filtered = intervals.filter(x => Math.abs(x - mean) <= 2 * stdDev);

  if (filtered.length === 0) {
    btcDisplay.textContent = "--";
    btcConfidenceEl.textContent = "0%";
    return;
  }

  // Use median for extra robustness
  filtered.sort((a, b) => a - b);
  const medianIndex = Math.floor(filtered.length / 2);
  const medianInterval = filtered.length % 2 === 0
    ? (filtered[medianIndex - 1] + filtered[medianIndex]) / 2
    : filtered[medianIndex];

  // Calculate BPM
  const bpm = Math.round(60000 / medianInterval);
  btcLastBPM = bpm;
  
  // Calculate confidence (0-100%)
  const cv = (stdDev / mean) * 100; // Coefficient of variation
  const confidence = Math.max(0, 100 - Math.min(cv * 2, 100));
  
  // Get tempo name
  const tempoInfo = btcGetTempoName(bpm);
  
  // Update display
  btcDisplay.textContent = bpm;
  btcDisplay.style.color = tempoInfo.color;
  btcTempoNameEl.textContent = tempoInfo.name;
  btcTempoNameEl.style.color = tempoInfo.color;
  
  // Update stats
  btcConfidenceEl.textContent = `${Math.round(confidence)}%`;
  btcConfidenceEl.style.color = confidence > 90 ? "#39ff14" : confidence > 70 ? "#ffa500" : "#ff4d4d";
  
  // Update last tap interval
  const lastInterval = intervals[intervals.length - 1];
  btcLastTapEl.textContent = `${lastInterval} ms`;
}

// Add a tap
function btcAddTap() {
  const now = Date.now();
  
  // Prevent double taps within 100ms
  if (btcTaps.length > 0 && now - btcTaps[btcTaps.length - 1] < 100) {
    return;
  }
  
  btcTaps.push(now);
  
  // Limit to last 16 taps
  if (btcTaps.length > 16) {
    btcTaps = btcTaps.slice(-16);
  }
  
  // Update UI
  btcBeatCountEl.textContent = btcTaps.length;
  btcUpdateDots();
  btcFlash();
  btcPlayClick();
  btcCalculateBPM();
  
  // Reset timeout
  if (btcTimeoutHandle) {
    clearTimeout(btcTimeoutHandle);
  }
  
  // Clear taps after 3 seconds of inactivity
  btcTimeoutHandle = setTimeout(() => {
    btcDisplay.textContent = "--";
    btcTempoNameEl.textContent = "";
    btcConfidenceEl.textContent = "‚Äî";
    btcLastTapEl.textContent = "‚Äî ms";
    btcDots.forEach(dot => dot.classList.remove('active'));
  }, 3000);
}

// Reset counter
function btcReset() {
  btcTaps = [];
  btcBeatCountEl.textContent = "0";
  btcDisplay.textContent = "--";
  btcTempoNameEl.textContent = "";
  btcConfidenceEl.textContent = "‚Äî";
  btcLastTapEl.textContent = "‚Äî ms";
  btcDots.forEach(dot => dot.classList.remove('active'));
  
  if (btcTimeoutHandle) {
    clearTimeout(btcTimeoutHandle);
    btcTimeoutHandle = null;
  }
  
  console.log("BPM counter reset");
}

// Toggle audio
function btcToggleAudio() {
  btcAudioEnabled = !btcAudioEnabled;
  btcAudioToggle.textContent = btcAudioEnabled ? "üîä Audio: ON" : "üîá Audio: OFF";
  btcAudioToggle.style.background = btcAudioEnabled 
    ? "rgba(57,255,20,0.1)" 
    : "rgba(255,77,77,0.1)";
  btcAudioToggle.style.color = btcAudioEnabled ? "#39ff14" : "#ff4d4d";
}

// Initialize the tool
function btcInit() {
  console.log("BPM Tap Counter: Initializing...");
  
  // Tap button
  btcTapButton.addEventListener('click', btcAddTap);
  
  // Reset button
  btcResetBtn.addEventListener('click', btcReset);
  
  // Audio toggle
  btcAudioToggle.addEventListener('click', btcToggleAudio);
  
  // Keyboard shortcuts
  document.addEventListener('keydown', function(e) {
    if (e.target === btcTapButton || e.target === btcResetBtn || e.target === btcAudioToggle) return;
    
    switch(e.key.toLowerCase()) {
      case ' ':
      case 'enter':
        e.preventDefault();
        btcAddTap();
        break;
      case 'r':
        if (e.ctrlKey || e.metaKey) return;
        btcReset();
        break;
      case 'm':
        if (e.ctrlKey || e.metaKey) return;
        btcToggleAudio();
        break;
    }
  });
  
  // Tap anywhere on the card (except buttons)
  document.querySelector('.tool-body').addEventListener('click', function(e) {
    if (e.target === btcTapButton || e.target === btcResetBtn || e.target === btcAudioToggle) return;
    if (e.target.closest('button')) return;
    
    btcAddTap();
  });
  
  console.log("‚úÖ BPM Tap Counter ready!");
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', btcInit);
} else {
  setTimeout(btcInit, 100);
}
</script>
