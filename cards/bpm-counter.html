<h2 style="margin-top:0;">BPM Tap Counter (Pro)</h2>

<div id="bpm-counter">
  <p class="small" style="opacity:0.8;">
    Tap the button or press <kbd>Space</kbd> / click anywhere to measure tempo.<br>
    ‚ö†Ô∏è Educational tool ‚Äî always double-check with a metronome.
  </p>

  <div style="text-align:center;margin:30px 0;">
    <div id="bpm-display" style="font-size:4.5rem;font-weight:800;margin:20px 0;letter-spacing:-2px;">
      --
    </div>
    <div id="tempo-name" style="font-size:1.3rem;opacity:0.7;height:28px;"></div>

    <div style="margin:20px 0;">
      <button id="tap-button" style="font-size:1.8rem;padding:20px 40px;border-radius:16px;">
        üî¥ TAP BEAT
      </button>
    </div>

    <div id="beat-indicators" style="display:flex;justify-content:center;gap:12px;margin:15px 0;">
      <div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div><div class="beat-dot"></div>
    </div>

    <div style="margin-top:20px;font-size:0.95rem;opacity:0.7;">
      Beats: <span id="beat-count">0</span> | 
      Confidence: <span id="confidence">‚Äî</span> | 
      <span id="last-tap" style="opacity:0;">Last: ‚Äî ms</span>
    </div>

    <button id="reset-btn" class="secondary" style="margin-top:20px;padding:8px 16px;font-size:0.9rem;">
      Reset
    </button>
  </div>

  <details style="margin-top:20px;font-size:0.9rem;">
    <summary>Tempo Reference Guide</summary>
    <ul style="margin:8px 0;padding-left:22px;opacity:0.8;line-height:1.6;">
      <li>20‚Äì40 Largo (very slow)</li>
      <li>40‚Äì60 Lentissimo / Grave</li>
      <li>60‚Äì66 Larghetto</li>
      <li>66‚Äì76 Adagio (slow)</li>
      <li>76‚Äì108 Andante (walking pace)</li>
      <li>108‚Äì120 Moderato</li>
      <li>120‚Äì168 Allegro (fast)</li>
      <li>168‚Äì200 Presto (very fast)</li>
      <li>200+ Prestissimo</li>
    </ul>
  </details>
</div>

<style>
  #bpm-counter {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    max-width: 420px;
    margin: 0 auto;
    padding: 20px;
    border-radius: 16px;
    background: rgba(255,255,255,0.05);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.1);
  }
  #tap-button {
    background: #ff3366;
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(255,51,102,0.4);
    transition: all 0.2s;
  }
  #tap-button:active, #tap-button.tapping {
    transform: scale(0.94);
    box-shadow: 0 4px 10px rgba(255,51,102,0.4);
    background: #ff1744;
  }
  .beat-dot {
    width:12px;height:12px;border-radius:50%;
    background:rgba(255,255,255,0.2);
    transition: all 0.3s;
  }
  .beat-dot.active {
    background:#ff3366;
    transform:scale(1.4);
    box-shadow:0 0 20px #ff33664d;
  }
  kbd {
    background:#333;color:#fff;padding:2px 6px;border-radius:4px;font-size:0.8em;
  }
  #bpm-display {
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
  }
  .flash {
    animation: flash 0.1s;
  }
  @keyframes flash {
    0% { background:rgba(255,51,102,0.3); }
    100% { background:transparent; }
  }
</style>

<script>
/* PRO BPM TAP COUNTER v2.0 */
const taps = [];
let timeoutHandle = null;
let audioCtx = null;

const display = document.getElementById('bpm-display');
const tempoNameEl = document.getElementById('tempo-name');
const tapButton = document.getElementById('tap-button');
const resetBtn = document.getElementById('reset-btn');
const beatCountEl = document.getElementById('beat-count');
const confidenceEl = document.getElementById('confidence');
const lastTapEl = document.getElementById('last-tap');
const dots = document.querySelectorAll('.beat-dot');

const tempoNames = [
  {min:0, max:40, name:"Largo"},
  {min:40, max:60, name:"Lentissimo / Grave"},
  {min:60, max:66, name:"Larghissimo"},
  {min:66, max:76, name:"Adagio"},
  {min:76, max:108, name:"Andante"},
  {min:98, max:112, name:"Andante moderato"},
  {min:108, max:120, name:"Moderato"},
  {min:120, max:156, name:"Allegro"},
  {min:156, max:176, name:"Vivace"},
  {min:172, max:200, name:"Presto"},
  {min:200, max:1000, name:"Prestissimo"}
];

function getTempoName(bpm) {
  for (const t of tempoNames) {
    if (bpm >= t.min && bpm < t.max) return t.name;
  }
  return bpm < 20 ? "Larghissimo" : "Prestissimo";
}

function playClick() {
  if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  const osc = audioCtx.createOscillator();
  const amp = audioCtx.createGain();
  osc.connect(amp);
  amp.connect(audioCtx.destination);
  osc.frequency.value = 1200;
  osc.type = "square";
  amp.gain.setValueAtTime(0.15, audioCtx.currentTime);
  amp.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.1);
  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.1);
}

function flash() {
  document.getElementById('bpm-counter').classList.add('flash');
  setTimeout(() => document.getElementById('bpm-counter').classList.remove('flash'), 100);
}

function updateDots() {
  dots.forEach((dot, i) => {
    dot.classList.toggle('active', i < (taps.length % 4));
  });
}

function calculateBPM() {
  if (taps.length < 2) {
    display.textContent = "--";
    tempoNameEl.textContent = "";
    return;
  }

  const intervals = [];
  for (let i = 1; i < taps.length; i++) {
    intervals.push(taps[i] - taps[i-1]);
  }

  // Remove outliers (beyond 2 standard deviations)
  const mean = intervals.reduce((a,b)=>a+b)/intervals.length;
  const stdDev = Math.sqrt(intervals.map(x => (x-mean)**2).reduce((a,b)=>a+b)/intervals.length);
  const filtered = intervals.filter(x => Math.abs(x - mean) <= 2 * stdDev);

  if (filtered.length === 0) return;

  // Use median for extra robustness
  filtered.sort((a,b)=>a-b);
  const medianInterval = filtered.length % 2 === 0
    ? (filtered[filtered.length/2 - 1] + filtered[filtered.length/2]) / 2
    : filtered[Math.floor(filtered.length/2)];

  const bpm = Math.round(60000 / medianInterval);
  const variance = filtered.reduce((sum, val) => sum + (val - median