<div class="card" id="statistics-card">
  <h2 id="statistics-title" style="margin-top:0;">Statistics Helper</h2>

  <form aria-describedby="statistics-desc">
    <p id="statistics-desc" class="small">Calculate basic statistics for a dataset. Paste numbers, choose measures, and get results with formulas shown.</p>

    <div class="row" style="display:grid;grid-template-columns:1fr;gap:10px;">
      <div class="field">
        <label for="stat-data">Data (comma-separated)</label>
        <input id="stat-data" type="text" placeholder="e.g. 5,7,9,10,12" style="width:100%;" value="5,7,9,10,12" />
      </div>

      <div class="field">
        <label for="stat-measures">Measures</label>
        <select id="stat-measures" multiple style="width:100%;height:120px;">
          <option value="mean" selected>Mean</option>
          <option value="median" selected>Median</option>
          <option value="mode" selected>Mode</option>
          <option value="range" selected>Range</option>
          <option value="variance">Variance</option>
          <option value="stddev">Standard Deviation</option>
        </select>
        <div class="small" style="opacity:0.85;margin-top:4px;">Hold Ctrl/Cmd to select multiple</div>
      </div>

      <div class="field">
        <label for="stat-show-steps">Show steps</label>
        <select id="stat-show-steps" style="width:100%;">
          <option value="yes" selected>Yes</option>
          <option value="no">No</option>
        </select>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" onclick="statCalculate(this)" class="primary">Calculate</button>
      <button type="button" class="secondary" onclick="statReset(this)">Reset</button>
      <button type="button" onclick="statCopy(this)">Copy Result</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <h3 class="small">Results</h3>
    <textarea id="stat-output" rows="12" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:inherit;" readonly></textarea>

    <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
      <div id="stat-hint" class="small" style="opacity:0.9;"></div>
    </div>
  </div>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #7bb7ff;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input, 
    .field select {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #7bb7ff;
      box-shadow: 0 0 0 2px rgba(123, 183, 255, 0.2);
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #4a86e8;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #3a76d8;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .actions button:last-of-type {
      background: #2d5a27;
      color: white;
    }
    
    .actions button:last-of-type:hover {
      background: #3d6a37;
    }
    
    .results h3 {
      color: #7bb7ff;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    #stat-output {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      resize: vertical;
      min-height: 180px;
    }
    
    #stat-output:focus {
      outline: none;
      border-color: #7bb7ff;
    }
    
    #stat-hint {
      color: #8bc34a;
      font-style: italic;
    }
  </style>
</div>

<script>
/* statistics.html
   - Calculates mean, median, mode, range, variance, std dev
   - Scoped with stat- prefix
*/

function statReset(btn){
  const card = btn.closest('.card');
  card.querySelector('#stat-data').value = "";
  card.querySelector('#stat-output').value = "";
  card.querySelector('#stat-hint').textContent = "";
  
  // Reset select options to default selected
  const select = card.querySelector('#stat-measures');
  for (let i = 0; i < select.options.length; i++) {
    const option = select.options[i];
    option.selected = ['mean', 'median', 'mode', 'range'].includes(option.value);
  }
}

function statCopy(btn){
  const card = btn.closest('.card');
  const out = card.querySelector('#stat-output').value;
  if(!out.trim()) return;
  
  navigator.clipboard?.writeText(out).then(() => {
    const hint = card.querySelector('#stat-hint');
    hint.textContent = "Copied to clipboard.";
    setTimeout(() => {
      if(hint.textContent === "Copied to clipboard.") {
        hint.textContent = "";
      }
    }, 1600);
  }).catch(() => {
    // Fallback for browsers that don't support clipboard API
    card.querySelector('#stat-output').select();
    document.execCommand('copy');
    const hint = card.querySelector('#stat-hint');
    hint.textContent = "Copied to clipboard.";
    setTimeout(() => {
      if(hint.textContent === "Copied to clipboard.") {
        hint.textContent = "";
      }
    }, 1600);
  });
}

function statCalculate(btn){
  const card = btn.closest('.card');
  const dataInput = card.querySelector('#stat-data').value || "";
  const data = dataInput.split(',')
    .map(s => parseFloat(s.trim()))
    .filter(n => !isNaN(n));
    
  const measures = [...card.querySelector('#stat-measures').selectedOptions]
    .map(o => o.value);
    
  const showSteps = card.querySelector('#stat-show-steps').value === "yes";
  
  if(!data.length) {
    card.querySelector('#stat-hint').textContent = "Please enter numeric data.";
    return;
  }
  
  let output = `Dataset: ${data.join(', ')}\n`;
  output += `Count: ${data.length}\n`;
  output += "─".repeat(40) + "\n\n";
  
  // Calculate mean
  if(measures.includes("mean")){
    const sum = data.reduce((a,b) => a + b, 0);
    const mean = sum / data.length;
    output += `Mean = ${mean.toFixed(4)}\n`;
    if(showSteps) {
      output += `Steps: Sum = ${sum}, Count = ${data.length}\n`;
      output += `Formula: Mean = Sum / Count = ${sum} / ${data.length} = ${mean.toFixed(4)}\n\n`;
    } else {
      output += "\n";
    }
  }
  
  // Calculate median
  if(measures.includes("median")){
    const sorted = [...data].sort((a,b) => a - b);
    const mid = Math.floor(sorted.length / 2);
    const median = sorted.length % 2 ? 
      sorted[mid] : 
      (sorted[mid-1] + sorted[mid]) / 2;
      
    output += `Median = ${median.toFixed(4)}\n`;
    if(showSteps) {
      output += `Steps: Sorted data = ${sorted.join(', ')}\n`;
      if(sorted.length % 2) {
        output += `Formula: Median = middle value = ${median}\n\n`;
      } else {
        output += `Formula: Median = (${sorted[mid-1]} + ${sorted[mid]}) / 2 = ${median}\n\n`;
      }
    } else {
      output += "\n";
    }
  }
  
  // Calculate mode
  if(measures.includes("mode")){
    const freq = {};
    data.forEach(n => freq[n] = (freq[n] || 0) + 1);
    const max = Math.max(...Object.values(freq));
    const modes = Object.keys(freq).filter(k => freq[k] === max);
    
    output += `Mode = ${modes.join(', ')}\n`;
    if(showSteps) {
      output += `Steps: Frequencies: ${Object.entries(freq).map(([k,v]) => `${k}:${v}`).join(', ')}\n`;
      if(modes.length === data.length) {
        output += `All values appear once (no distinct mode)\n\n`;
      } else {
        output += `Highest frequency = ${max} for value(s): ${modes.join(', ')}\n\n`;
      }
    } else {
      output += "\n";
    }
  }
  
  // Calculate range
  if(measures.includes("range")){
    const max = Math.max(...data);
    const min = Math.min(...data);
    const range = max - min;
    
    output += `Range = ${range.toFixed(4)}\n`;
    if(showSteps) {
      output += `Steps: Max = ${max}, Min = ${min}\n`;
      output += `Formula: Range = Max - Min = ${max} - ${min} = ${range}\n\n`;
    } else {
      output += "\n";
    }
  }
  
  // Calculate variance and/or standard deviation
  if(measures.includes("variance") || measures.includes("stddev")){
    const mean = data.reduce((a,b) => a + b, 0) / data.length;
    const variance = data.reduce((sum, n) => sum + (n - mean) ** 2, 0) / data.length;
    
    if(measures.includes("variance")){
      output += `Variance = ${variance.toFixed(4)}\n`;
      if(showSteps) {
        output += `Steps: Mean = ${mean.toFixed(4)}\n`;
        const deviations = data.map(n => {
          const dev = n - mean;
          return `${dev.toFixed(4)}² = ${(dev ** 2).toFixed(4)}`;
        });
        output += `Squared deviations: ${deviations.join(', ')}\n`;
        output += `Sum of squared deviations = ${data.reduce((sum, n) => sum + (n - mean) ** 2, 0).toFixed(4)}\n`;
        output += `Formula: Variance = Sum of squared deviations / Count = ${variance.toFixed(4)}\n\n`;
      } else {
        output += "\n";
      }
    }
    
    if(measures.includes("stddev")){
      const stddev = Math.sqrt(variance);
      output += `Standard Deviation = ${stddev.toFixed(4)}\n`;
      if(showSteps) {
        output += `Formula: Standard Deviation = √Variance = √${variance.toFixed(4)} = ${stddev.toFixed(4)}\n\n`;
      } else {
        output += "\n";
      }
    }
  }
  
  card.querySelector('#stat-output').value = output.trim();
  card.querySelector('#stat-hint').textContent = `Calculated ${measures.length} measure(s) for ${data.length} data point(s).`;
}

// Auto-calculate when the page loads
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('statistics-card');
  if (card) {
    // Set a small timeout to ensure all elements are loaded
    setTimeout(() => {
      const calculateBtn = card.querySelector('.actions button.primary');
      if (calculateBtn) {
        statCalculate(calculateBtn);
      }
    }, 100);
  }
});
</script>
