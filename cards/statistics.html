<!-- 
===========================================
FILE: cards/statistics.html
DESCRIPTION: Advanced statistics calculator with data visualization
===========================================
-->

<div class="card glass glass-md" id="st-card">
    
    <!-- ===== 1. HEADER ===== -->
    <div class="card-header">
        <h3 class="card-title" id="st-title">
            <span style="display:inline-flex;align-items:center;gap:8px;">
                <span style="font-size:20px;">üìä</span>
                <span>Statistics Calculator</span>
            </span>
        </h3>
        <div class="card-actions">
            <button class="btn btn-ghost btn-sm" onclick="stClear()" title="Clear all data">
                üóëÔ∏è Clear
            </button>
        </div>
    </div>
    
    <!-- ===== 2. CONTENT ===== -->
    <div class="card-content">
        
        <!-- Input Section -->
        <div style="margin-bottom:var(--space-major);">
            <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:var(--space-minor);">
                <label for="st-input" style="font-size:var(--text-tiny);font-weight:var(--weight-semibold);color:var(--text-secondary);">
                    Enter numbers (comma or space separated):
                </label>
                <button onclick="stPasteFromClipboard()" class="btn btn-secondary btn-sm">
                    üìã Paste
                </button>
            </div>
            
            <textarea 
                id="st-input" 
                class="input input-textarea glass glass-dark"
                placeholder="Example: 10, 15, 20, 25, 30 or 10 15 20 25 30"
                rows="3"
                oninput="stUpdateStats()"
            >12, 15, 18, 22, 25, 28, 30, 32, 35, 40</textarea>
            
            <div style="display:flex;gap:var(--space-micro);margin-top:var(--space-micro);">
                <button onclick="stGenerateRandom()" class="btn btn-secondary btn-sm" style="flex:1;">
                    üé≤ Random Data
                </button>
                <button onclick="stLoadSample()" class="btn btn-secondary btn-sm" style="flex:1;">
                    üìã Sample Data
                </button>
            </div>
        </div>
        
        <!-- Data Summary -->
        <div id="st-summary" style="margin-bottom:var(--space-major);padding:var(--space-minor);background:var(--bg-glass);border-radius:var(--radius-md);border:1px solid var(--border-light);">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-micro);">
                <div style="font-size:var(--text-tiny);color:var(--text-secondary);">Data Summary</div>
                <div style="font-size:var(--text-micro);color:var(--accent);font-family:var(--font-mono);" id="st-count">10 values</div>
            </div>
            <div id="st-data-preview" style="font-family:var(--font-mono);font-size:var(--text-micro);color:var(--text-secondary);line-height:1.3;">
                [12, 15, 18, 22, 25, 28, 30, 32, 35, 40]
            </div>
        </div>
        
        <!-- Quick Stats Grid -->
        <div class="stats-grid" style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-minor);margin-bottom:var(--space-major);">
            <div class="stat-card">
                <div class="stat-label">Mean (Average)</div>
                <div class="stat-value" id="st-mean">25.7</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Median</div>
                <div class="stat-value" id="st-median">26.5</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Mode</div>
                <div class="stat-value" id="st-mode">-</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Range</div>
                <div class="stat-value" id="st-range">28</div>
            </div>
        </div>
        
        <!-- Detailed Stats Accordion -->
        <div class="accordion" style="margin-bottom:var(--space-major);">
            <button onclick="stToggleDetails()" class="accordion-btn" style="width:100%;text-align:left;padding:var(--space-minor);background:var(--bg-glass);border:1px solid var(--border-light);border-radius:var(--radius-md);display:flex;justify-content:space-between;align-items:center;cursor:pointer;">
                <span style="font-size:var(--text-tiny);font-weight:var(--weight-semibold);color:var(--accent);">
                    üìà Detailed Statistics
                </span>
                <span id="st-accordion-icon" style="font-size:10px;">‚ñº</span>
            </button>
            <div id="st-details" style="display:none;padding:var(--space-minor);background:rgba(255,255,255,0.02);border:1px solid var(--border-light);border-top:none;border-radius:0 0 var(--radius-md) var(--radius-md);">
                
                <!-- Spread Measures -->
                <div style="margin-bottom:var(--space-minor);">
                    <div style="font-size:var(--text-micro);color:var(--text-tertiary);margin-bottom:var(--space-micro);text-transform:uppercase;letter-spacing:0.5px;">
                        Spread Measures
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-micro);">
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Variance</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-variance">65.34</div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Std Deviation</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-stddev">8.08</div>
                        </div>
                    </div>
                </div>
                
                <!-- Quartiles -->
                <div style="margin-bottom:var(--space-minor);">
                    <div style="font-size:var(--text-micro);color:var(--text-tertiary);margin-bottom:var(--space-micro);text-transform:uppercase;letter-spacing:0.5px;">
                        Quartiles
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:var(--space-micro);">
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Min</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-min">12</div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Q1</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-q1">18</div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Q3</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-q3">32</div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Max</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-max">40</div>
                        </div>
                    </div>
                </div>
                
                <!-- Distribution -->
                <div>
                    <div style="font-size:var(--text-micro);color:var(--text-tertiary);margin-bottom:var(--space-micro);text-transform:uppercase;letter-spacing:0.5px;">
                        Distribution
                    </div>
                    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:var(--space-micro);">
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">Sum</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-sum">257</div>
                        </div>
                        <div>
                            <div style="font-size:var(--text-micro);color:var(--text-secondary);">IQR</div>
                            <div style="font-family:var(--font-mono);font-size:var(--text-tiny);color:var(--text);" id="st-iqr">14</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Visualization -->
        <div style="margin-bottom:var(--space-major);">
            <div style="font-size:var(--text-tiny);font-weight:var(--weight-semibold);color:var(--accent);margin-bottom:var(--space-minor);">
                üìä Data Distribution
            </div>
            <div style="height:100px;background:var(--bg-glass);border-radius:var(--radius-md);border:1px solid var(--border-light);position:relative;overflow:hidden;padding:var(--space-minor);">
                <div id="st-histogram" style="height:100%;display:flex;align-items:flex-end;gap:2px;">
                    <!-- Histogram bars will be generated here -->
                </div>
                <div id="st-histogram-labels" style="display:flex;justify-content:space-between;margin-top:4px;font-size:var(--text-micro);color:var(--text-tertiary);">
                    <span id="st-hist-min">12</span>
                    <span id="st-hist-mean">25.7</span>
                    <span id="st-hist-max">40</span>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- ===== 3. FOOTER ===== -->
    <div class="card-footer">
        <div class="card-meta">
            <span style="display:inline-flex;align-items:center;gap:4px;font-size:var(--text-micro);color:var(--text-tertiary);">
                ‚ö° Real-time calculations
            </span>
        </div>
        <div style="display:flex;gap:var(--space-micro);">
            <button onclick="stExportCSV()" class="btn btn-ghost btn-sm">
                üì• Export
            </button>
            <button onclick="stEmbed()" class="btn btn-ghost btn-sm">
                üîó Embed
            </button>
        </div>
    </div>
    
</div>

<!-- ===== 4. JAVASCRIPT ===== -->
<script>
// STATISTICS TOOL FUNCTIONS (prefixed with st-)
const stState = {
    data: [12, 15, 18, 22, 25, 28, 30, 32, 35, 40],
    stats: {}
};

// Parse input string to array of numbers
function stParseInput(input) {
    // Remove any brackets and split by commas or spaces
    const cleaned = input.replace(/[\[\]()]/g, '');
    return cleaned.split(/[,;\s]+/)
        .map(item => parseFloat(item.trim()))
        .filter(item => !isNaN(item) && isFinite(item));
}

// Calculate all statistics
function stCalculateStats(data) {
    if (data.length === 0) {
        return {
            count: 0,
            mean: 0,
            median: 0,
            mode: [],
            range: 0,
            min: 0,
            max: 0,
            sum: 0,
            variance: 0,
            stddev: 0,
            q1: 0,
            q3: 0,
            iqr: 0
        };
    }
    
    const sorted = [...data].sort((a, b) => a - b);
    const n = data.length;
    const sum = sorted.reduce((a, b) => a + b, 0);
    const mean = sum / n;
    
    // Median
    const mid = Math.floor(n / 2);
    const median = n % 2 === 0 ? 
        (sorted[mid - 1] + sorted[mid]) / 2 : 
        sorted[mid];
    
    // Mode
    const frequency = {};
    let maxFreq = 0;
    let mode = [];
    sorted.forEach(num => {
        frequency[num] = (frequency[num] || 0) + 1;
        if (frequency[num] > maxFreq) {
            maxFreq = frequency[num];
            mode = [num];
        } else if (frequency[num] === maxFreq && !mode.includes(num)) {
            mode.push(num);
        }
    });
    
    // Range
    const min = sorted[0];
    const max = sorted[n - 1];
    const range = max - min;
    
    // Variance and Standard Deviation
    const variance = sorted.reduce((acc, val) => acc + Math.pow(val - mean, 2), 0) / n;
    const stddev = Math.sqrt(variance);
    
    // Quartiles
    const q1 = stCalculatePercentile(sorted, 25);
    const q3 = stCalculatePercentile(sorted, 75);
    const iqr = q3 - q1;
    
    return {
        count: n,
        mean: parseFloat(mean.toFixed(2)),
        median: parseFloat(median.toFixed(2)),
        mode: mode.length > 5 ? [`${mode.length} modes`] : mode.map(m => parseFloat(m.toFixed(2))),
        range: parseFloat(range.toFixed(2)),
        min: parseFloat(min.toFixed(2)),
        max: parseFloat(max.toFixed(2)),
        sum: parseFloat(sum.toFixed(2)),
        variance: parseFloat(variance.toFixed(2)),
        stddev: parseFloat(stddev.toFixed(2)),
        q1: parseFloat(q1.toFixed(2)),
        q3: parseFloat(q3.toFixed(2)),
        iqr: parseFloat(iqr.toFixed(2))
    };
}

// Calculate percentile
function stCalculatePercentile(sorted, p) {
    const n = sorted.length;
    const index = (p / 100) * (n - 1);
    const lower = Math.floor(index);
    const fraction = index - lower;
    
    if (lower >= n - 1) return sorted[n - 1];
    if (lower < 0) return sorted[0];
    
    return sorted[lower] + fraction * (sorted[lower + 1] - sorted[lower]);
}

// Update statistics display
function stUpdateStats() {
    const input = document.getElementById('st-input').value;
    stState.data = stParseInput(input);
    stState.stats = stCalculateStats(stState.data);
    
    // Update summary
    document.getElementById('st-count').textContent = `${stState.stats.count} value${stState.stats.count !== 1 ? 's' : ''}`;
    document.getElementById('st-data-preview').textContent = 
        stState.data.length <= 10 ? 
        `[${stState.data.map(n => n.toFixed(1)).join(', ')}]` :
        `[${stState.data.slice(0, 5).map(n => n.toFixed(1)).join(', ')}, ..., ${stState.data.slice(-1)[0].toFixed(1)}]`;
    
    // Update main stats
    document.getElementById('st-mean').textContent = stState.stats.mean;
    document.getElementById('st-median').textContent = stState.stats.median;
    document.getElementById('st-mode').textContent = 
        Array.isArray(stState.stats.mode) ? 
        (stState.stats.mode.length > 0 ? stState.stats.mode.join(', ') : '-') : 
        stState.stats.mode;
    document.getElementById('st-range').textContent = stState.stats.range;
    
    // Update detailed stats
    document.getElementById('st-variance').textContent = stState.stats.variance;
    document.getElementById('st-stddev').textContent = stState.stats.stddev;
    document.getElementById('st-min').textContent = stState.stats.min;
    document.getElementById('st-q1').textContent = stState.stats.q1;
    document.getElementById('st-q3').textContent = stState.stats.q3;
    document.getElementById('st-max').textContent = stState.stats.max;
    document.getElementById('st-sum').textContent = stState.stats.sum;
    document.getElementById('st-iqr').textContent = stState.stats.iqr;
    
    // Update histogram labels
    document.getElementById('st-hist-min').textContent = stState.stats.min;
    document.getElementById('st-hist-mean').textContent = stState.stats.mean;
    document.getElementById('st-hist-max').textContent = stState.stats.max;
    
    // Update histogram
    stUpdateHistogram();
}

// Create histogram visualization
function stUpdateHistogram() {
    const container = document.getElementById('st-histogram');
    if (!container || stState.data.length === 0) return;
    
    // Clear existing bars
    container.innerHTML = '';
    
    // Create bins for histogram
    const data = stState.data;
    const min = Math.min(...data);
    const max = Math.max(...data);
    const range = max - min;
    const binCount = Math.min(10, Math.max(5, Math.floor(Math.sqrt(data.length))));
    const binSize = range / binCount;
    
    // Count frequencies
    const bins = new Array(binCount).fill(0);
    data.forEach(value => {
        const binIndex = Math.min(Math.floor((value - min) / binSize), binCount - 1);
        bins[binIndex]++;
    });
    
    const maxFreq = Math.max(...bins);
    const barGap = 2;
    const availableWidth = container.clientWidth;
    const barWidth = Math.max(4, (availableWidth - (binCount - 1) * barGap) / binCount);
    
    // Create bars
    bins.forEach((freq, i) => {
        const barHeight = (freq / maxFreq) * 80; // Max 80px height
        const bar = document.createElement('div');
        
        // Gradient calculation based on height
        const hue = 192; // Cyan
        const saturation = 100;
        const lightness = 59 - (barHeight / 80) * 20; // Darker for taller bars
        
        bar.style.width = `${barWidth}px`;
        bar.style.height = `${barHeight}px`;
        bar.style.background = `linear-gradient(to top, 
            hsla(${hue}, ${saturation}%, ${lightness}%, 0.8) 0%,
            hsla(${hue}, ${saturation}%, ${lightness + 20}%, 0.4) 100%)`;
        bar.style.borderRadius = '2px 2px 0 0';
        bar.style.position = 'relative';
        bar.style.transition = 'all 0.3s ease';
        
        // Add tooltip with bin range
        const binStart = min + i * binSize;
        const binEnd = min + (i + 1) * binSize;
        bar.title = `${binStart.toFixed(1)}-${binEnd.toFixed(1)}: ${freq} values`;
        
        // Add frequency label for taller bars
        if (freq > 0 && barHeight > 20) {
            const label = document.createElement('div');
            label.textContent = freq;
            label.style.position = 'absolute';
            label.style.top = '-20px';
            label.style.left = '0';
            label.style.width = '100%';
            label.style.textAlign = 'center';
            label.style.fontSize = '10px';
            label.style.fontFamily = 'var(--font-mono)';
            label.style.color = 'var(--text)';
            bar.appendChild(label);
        }
        
        container.appendChild(bar);
    });
}

// Toggle detailed statistics
function stToggleDetails() {
    const details = document.getElementById('st-details');
    const icon = document.getElementById('st-accordion-icon');
    
    if (details.style.display === 'none') {
        details.style.display = 'block';
        icon.textContent = '‚ñ≤';
    } else {
        details.style.display = 'none';
        icon.textContent = '‚ñº';
    }
}

// Clear all data
function stClear() {
    document.getElementById('st-input').value = '';
    stUpdateStats();
    showNotification('Data cleared', 'success');
}

// Generate random data
function stGenerateRandom() {
    const count = Math.floor(Math.random() * 20) + 5;
    const data = Array.from({length: count}, () => 
        Math.floor(Math.random() * 100) + 1
    );
    document.getElementById('st-input').value = data.join(', ');
    stUpdateStats();
    showNotification(`Generated ${count} random values`, 'success');
}

// Load sample data
function stLoadSample() {
    const samples = [
        "68, 72, 65, 70, 75, 80, 85, 90, 95, 100",
        "10.5, 12.3, 14.2, 16.1, 18.0, 20.5, 22.8",
        "150, 155, 160, 165, 170, 175, 180, 185, 190",
        "4, 8, 15, 16, 23, 42, 108, 42, 23, 16, 15, 8, 4"
    ];
    
    const randomSample = samples[Math.floor(Math.random() * samples.length)];
    document.getElementById('st-input').value = randomSample;
    stUpdateStats();
    showNotification('Sample data loaded', 'success');
}

// Paste from clipboard
async function stPasteFromClipboard() {
    try {
        const text = await navigator.clipboard.readText();
        document.getElementById('st-input').value = text;
        stUpdateStats();
        showNotification('Pasted from clipboard', 'success');
    } catch (err) {
        showNotification('Failed to paste from clipboard', 'error');
    }
}

// Export to CSV
function stExportCSV() {
    if (stState.data.length === 0) {
        showNotification('No data to export', 'warning');
        return;
    }
    
    const csv = ['Value', ...stState.data].join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = 'statistics_data.csv';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification('CSV exported', 'success');
}

// Embed tool
function stEmbed() {
    const embedCode = `<iframe src="${window.location.origin}/cards/statistics.html" width="100%" height="500" style="border:none;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);" title="Statistics Calculator - The Most Useful Site"></iframe>`;
    
    navigator.clipboard.writeText(embedCode);
    showNotification('Embed code copied to clipboard!', 'success');
    
    // Track in analytics
    if (window.plausible) {
        window.plausible('Embed Generated', { props: { tool: 'statistics' } });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('üìä Statistics Calculator loaded');
    
    // Initial calculation
    stUpdateStats();
    
    // Auto-update on input with debounce
    let updateTimer;
    document.getElementById('st-input').addEventListener('input', () => {
        clearTimeout(updateTimer);
        updateTimer = setTimeout(stUpdateStats, 300);
    });
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            stClear();
        }
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            stGenerateRandom();
        }
        if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            stLoadSample();
        }
        if (e.key === 'e' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            stExportCSV();
        }
    });
    
    // Resize histogram on window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimer);
        resizeTimer = setTimeout(stUpdateHistogram, 100);
    });
});

// Make functions available globally
window.stUpdateStats = stUpdateStats;
window.stClear = stClear;
window.stGenerateRandom = stGenerateRandom;
window.stLoadSample = stLoadSample;
window.stPasteFromClipboard = stPasteFromClipboard;
window.stExportCSV = stExportCSV;
window.stEmbed = stEmbed;
window.stToggleDetails = stToggleDetails;
</script>

<!-- ===== 5. CARD-SCOPED STYLES ===== -->
<style>
/* Card-specific styles */
#st-card {
    --card-width: min(100%, 400px);
    --card-height: auto;
    min-height: 500px;
}

/* Stat card styling */
.stat-card {
    background: linear-gradient(145deg, 
        rgba(255, 255, 255, 0.03), 
        rgba(255, 255, 255, 0.05));
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-minor);
    text-align: center;
    transition: var(--transition-base);
}

.stat-card:hover {
    border-color: var(--accent);
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

.stat-card .stat-label {
    font-size: var(--text-micro);
    color: var(--text-tertiary);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    margin-bottom: 4px;
}

.stat-card .stat-value {
    font-family: var(--font-mono);
    font-size: var(--text-lg);
    font-weight: var(--weight-bold);
    color: var(--accent);
    line-height: 1.2;
}

/* Accordion button */
.accordion-btn {
    cursor: pointer;
    transition: var(--transition-base);
    background: var(--bg-glass) !important;
}

.accordion-btn:hover {
    background: rgba(255, 255, 255, 0.05) !important;
    border-color: var(--accent) !important;
}

/* Histogram bar hover effect */
#st-histogram div:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 212, 255, 0.3);
}

/* Responsive adjustments */
@media (max-width: 480px) {
    #st-card {
        padding: var(--space-minor);
    }
    
    .stats-grid {
        grid-template-columns: 1fr !important;
    }
    
    .card-actions {
        display: none;
    }
    
    #st-histogram {
        height: 80px;
    }
}

/* Print styles */
@media print {
    #st-card {
        box-shadow: none !important;
        border: 1px solid #ccc !important;
        background: white !important;
        color: black !important;
    }
    
    .card-actions, button, .card-footer {
        display: none !important;
    }
    
    #st-histogram {
        background: #f0f0f0 !important;
        border: 1px solid #ccc !important;
    }
}
</style>

<!-- ===== 6. METADATA FOR CARD LOADER ===== -->
<div style="display:none;" data-card-metadata>
    <!-- Metadata for card loader -->
    <div data-title="Statistics Calculator"></div>
    <div data-description="Advanced statistics calculator with data visualization. Calculate mean, median, mode, variance, standard deviation, quartiles, and visualize data distribution with interactive histogram. Perfect for data analysis, research, and quick statistical calculations."></div>
    <div data-tags="math, statistics, data, analysis, calculator, visualization, mean, median, mode, standard deviation"></div>
    <div data-category="Mathematics"></div>
    <div data-icon="üìä"></div>
    <div data-version="1.0.0"></div>
</div>
