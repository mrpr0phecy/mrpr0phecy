<h2 id="microbiology-title" style="margin-top:0;color:var(--accent);">ğŸ”¬ Microbiology Tools & Facts</h2>

<form aria-describedby="microbiology-desc">
  <p id="microbiology-desc" class="small" style="color:var(--muted);margin-bottom:20px;">
    Calculate essential microbiology values and explore fascinating facts about the invisible world of microbes.
    <span style="color:var(--accent);display:block;margin-top:4px;">ğŸ§« Growth rates â€¢ Dilutions â€¢ Microbial facts â€¢ Educational insights</span>
  </p>

  <!-- MAIN TOOL SELECTION -->
  <div style="background:rgba(255,255,255,0.02);border-radius:12px;padding:20px;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
      <div>
        <label for="micro-tool" style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;font-size:14px;">
          ğŸ§ª Select Tool
        </label>
        <select id="micro-tool" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;cursor:pointer;font-size:14px;">
          <option value="growth-rate" selected>ğŸ“ˆ Bacterial Growth Rate</option>
          <option value="doubling-time">â±ï¸ Doubling Time</option>
          <option value="dilution-factor">ğŸ§´ Dilution Factor</option>
          <option value="cell-density">ğŸ”¬ Cell Density</option>
          <option value="cfu-calculation">ğŸ§« Colony Forming Units</option>
          <option value="generation-time">ğŸ”„ Generation Time</option>
          <option value="optical-density">ğŸŒˆ Optical Density â†’ Cells</option>
          <option value="ph-age">âš—ï¸ pH & Microbial Growth</option>
        </select>
      </div>

      <div>
        <label style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;font-size:14px;">
          ğŸ“‹ Quick Examples
        </label>
        <select id="micro-examples" onchange="microLoadExample(this)" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;cursor:pointer;font-size:14px;">
          <option value="" selected>Load example...</option>
          <option value="growth-example">Growth: N0=100, Nt=800, t=3h</option>
          <option value="dilution-example">Dilution: V1=1mL, V2=10mL</option>
          <option value="cfu-example">CFU: 50 colonies, dilution=10â»â´, volume=0.1mL</option>
          <option value="density-example">Density: 5Ã—10â¶ cells/mL, volume=2mL</option>
          <option value="od-example">OD: OD600=0.5, calibration=2Ã—10â¸ cells/OD</option>
        </select>
      </div>
    </div>

    <!-- DYNAMIC INPUT FIELDS BASED ON TOOL -->
    <div id="micro-input-container">
      <!-- Growth Rate Calculator -->
      <div id="micro-growth-rate-inputs" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
        <div>
          <label for="micro-N0" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Initial cells (Nâ‚€)</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <input id="micro-N0" type="number" placeholder="100" min="1" step="1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
            <div style="color:rgba(230,250,255,0.7);font-size:12px;">cells</div>
          </div>
        </div>
        <div>
          <label for="micro-Nt" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Final cells (Nâ‚œ)</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <input id="micro-Nt" type="number" placeholder="800" min="1" step="1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
            <div style="color:rgba(230,250,255,0.7);font-size:12px;">cells</div>
          </div>
        </div>
        <div>
          <label for="micro-time" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Time (t)</label>
          <div style="display:flex;align-items:center;gap:8px;">
            <input id="micro-time" type="number" placeholder="3" min="0.1" step="0.1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
            <select id="micro-time-unit" style="padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:13px;">
              <option value="hours">hours</option>
              <option value="minutes">minutes</option>
              <option value="days">days</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- ADDITIONAL OPTIONS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="micro-show-facts" checked style="cursor:pointer;width:18px;height:18px;">
        <div>
          <div style="color:var(--accent);font-size:13px;font-weight:500;">Show Microbial Facts</div>
          <div style="color:rgba(230,250,255,0.6);font-size:11px;">Interesting microbiology facts</div>
        </div>
      </label>

      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="micro-show-formula" checked style="cursor:pointer;width:18px;height:18px;">
        <div>
          <div style="color:var(--accent);font-size:13px;font-weight:500;">Show Formula</div>
          <div style="color:rgba(230,250,255,0.6);font-size:11px;">Mathematical formula used</div>
        </div>
      </label>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div style="display:flex;gap:12px;margin-bottom:20px;">
    <button type="button" onclick="microCalculate(this)" 
            style="flex:2;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;font-size:16px;">
      ğŸ§« Calculate Microbiology Value
    </button>
    <button type="button" onclick="microReset(this)"
            style="flex:1;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;font-weight:500;">
      ğŸ”„ Reset
    </button>
    <button type="button" onclick="microCopy(this)"
            style="padding:14px 20px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;font-weight:500;">
      ğŸ“‹ Copy
    </button>
  </div>
</form>

<!-- RESULTS SECTION -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <!-- MAIN RESULTS CARD -->
  <div style="background:linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));border-radius:12px;border:1px solid rgba(255,255,255,0.08);padding:24px;margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="color:var(--accent);font-weight:600;font-size:16px;">ğŸ”¬ Microbiology Result</div>
      <div id="micro-status" style="color:rgba(230,250,255,0.7);font-size:13px;">Ready to calculate</div>
    </div>
    
    <textarea id="micro-output" rows="4" style="width:100%;padding:14px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(0,0,0,0.2);color:inherit;font-family:monospace;font-size:14px;resize:vertical;"></textarea>
    
    <div id="micro-formula-container" style="display:none;margin-top:16px;padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
      <div style="color:var(--accent);font-size:13px;margin-bottom:6px;">ğŸ“ Formula:</div>
      <div id="micro-formula" style="font-family:monospace;color:#39ff14;font-size:13px;"></div>
    </div>
  </div>

  <!-- MICROBIOLOGY FACTS -->
  <div id="micro-facts-container" style="display:none;background:rgba(255,255,255,0.02);border-radius:12px;border:1px solid rgba(255,255,255,0.05);padding:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <div style="color:var(--accent);font-weight:600;font-size:16px;">ğŸ§¬ Fascinating Microbiology Facts</div>
      <button onclick="microNewFacts()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;font-weight:500;">
        ğŸ”„ New Facts
      </button>
    </div>
    
    <div id="micro-facts-grid" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));gap:12px;">
      <!-- Facts will be inserted here -->
    </div>
  </div>

  <!-- MICROBIAL COMPARISON VISUALIZATION -->
  <div id="micro-visualization" style="display:none;margin-top:20px;background:rgba(0,0,0,0.2);border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.1);">
    <div style="color:var(--accent);font-weight:600;margin-bottom:12px;font-size:16px;">ğŸ“Š Microbial Scale Comparison</div>
    <div style="height:40px;background:rgba(255,255,255,0.05);border-radius:8px;overflow:hidden;position:relative;margin-bottom:12px;">
      <div id="micro-size-bar" style="position:absolute;height:100%;background:linear-gradient(90deg, #2dd4ff, #39ff14);width:0%;transition:width 1s ease;"></div>
      <div style="position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:space-between;padding:0 12px;font-size:12px;color:rgba(230,250,255,0.9);">
        <div>Virus (20-300 nm)</div>
        <div>Bacterium (1-5 Âµm)</div>
        <div>Human cell (10-30 Âµm)</div>
      </div>
    </div>
    <div id="micro-scale-text" style="text-align:center;color:rgba(230,250,255,0.7);font-size:13px;"></div>
  </div>

  <!-- EDUCATIONAL INFORMATION -->
  <details style="margin-top:20px;background:rgba(255,255,255,0.02);border-radius:10px;border:1px solid rgba(255,255,255,0.05);overflow:hidden;">
    <summary style="padding:16px;color:var(--accent);font-weight:600;font-size:15px;cursor:pointer;list-style:none;">
      ğŸ“š Microbiology Concepts Explained
    </summary>
    <div style="padding:16px;border-top:1px solid rgba(255,255,255,0.05);">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;">
        <div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
          <div style="color:var(--accent);font-weight:500;margin-bottom:6px;font-size:14px;">ğŸ“ˆ Growth Rate</div>
          <div style="color:rgba(230,250,255,0.8);font-size:13px;line-height:1.5;">
            r = (ln(Nâ‚œ/Nâ‚€)) / t<br>
            Where Nâ‚€ = initial cells, Nâ‚œ = final cells, t = time
          </div>
        </div>
        
        <div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;border:1px solid rgba(57,255,20,0.1);">
          <div style="color:#39ff14;font-weight:500;margin-bottom:6px;font-size:14px;">â±ï¸ Doubling Time</div>
          <div style="color:rgba(230,250,255,0.8);font-size:13px;line-height:1.5;">
            Tâ‚ = ln(2) / r<br>
            Time for population to double at growth rate r
          </div>
        </div>
        
        <div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:8px;border:1px solid rgba(255,204,0,0.1);">
          <div style="color:#ffcc00;font-weight:500;margin-bottom:6px;font-size:14px;">ğŸ§´ Dilution Factor</div>
          <div style="color:rgba(230,250,255,0.8);font-size:13px;line-height:1.5;">
            DF = Vâ‚ / Vâ‚‚<br>
            Ratio of initial volume to final volume
          </div>
        </div>
        
        <div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:8px;border:1px solid rgba(157,78,221,0.1);">
          <div style="color:#9d4edd;font-weight:500;margin-bottom:6px;font-size:14px;">ğŸ§« CFU Calculation</div>
          <div style="color:rgba(230,250,255,0.8);font-size:13px;line-height:1.5;">
            CFU/mL = (colonies Ã— dilution factor) / volume plated
          </div>
        </div>
      </div>
    </div>
  </details>
</div>

<script>
/* microbiology-tools.html
   Comprehensive microbiology calculators with facts and visualizations
   Scoped with 'micro' prefix
*/

// MICROBIOLOGY FACTS DATABASE
const microFacts = [
  {
    category: "ğŸŒ Global Impact",
    text: "Microbes make up about 60% of Earth's living matter and produce 50% of the world's oxygen through photosynthesis.",
    icon: "ğŸŒ"
  },
  {
    category: "ğŸ§¬ Human Body",
    text: "Your body contains about 39 trillion microbial cells â€” slightly more than your 30 trillion human cells.",
    icon: "ğŸ‘¤"
  },
  {
    category: "âš¡ Extreme Life",
    text: "Deinococcus radiodurans can survive radiation doses 3,000 times higher than what would kill a human.",
    icon: "â˜¢ï¸"
  },
  {
    category: "ğŸ¥ Medicine",
    text: "Penicillin, the first antibiotic, was discovered by Alexander Fleming in 1928 from the Penicillium mold.",
    icon: "ğŸ’Š"
  },
  {
    category: "âš—ï¸ Chemistry",
    text: "Some archaea produce methane at deep-sea vents, contributing significantly to the global carbon cycle.",
    icon: "ğŸ”¥"
  },
  {
    category: "ğŸ•°ï¸ History",
    text: "Louis Pasteur's germ theory (1861) revolutionized medicine by proving microorganisms cause disease.",
    icon: "ğŸ“œ"
  },
  {
    category: "ğŸ”¬ Size",
    text: "The smallest bacteria (Mycoplasma) are about 0.2 micrometers â€” 500 could line up across a human hair.",
    icon: "ğŸ“"
  },
  {
    category: "ğŸ§  Neuroscience",
    text: "Your gut microbiome produces neurotransmitters like serotonin that influence mood and brain function.",
    icon: "ğŸ§¬"
  },
  {
    category: "ğŸŒ± Environment",
    text: "One teaspoon of soil contains more microbes than there are people on Earth â€” about 1 billion bacteria.",
    icon: "ğŸŒ¿"
  },
  {
    category: "âš¡ Speed",
    text: "E. coli can replicate every 20 minutes â€” one cell could produce over 1 billion descendants in 10 hours.",
    icon: "â±ï¸"
  },
  {
    category: "ğŸŒŠ Ocean Life",
    text: "Marine microbes called Prochlorococcus produce 20% of the oxygen in our atmosphere.",
    icon: "ğŸŒŠ"
  },
  {
    category: "ğŸ½ï¸ Food",
    text: "Fermentation by yeast and bacteria gives us bread, beer, cheese, yogurt, kimchi, and chocolate.",
    icon: "ğŸ"
  },
  {
    category: "ğŸ’Š Resistance",
    text: "Some bacteria develop resistance to antibiotics in as little as 11 days through rapid evolution.",
    icon: "ğŸ›¡ï¸"
  },
  {
    category: "ğŸ”‹ Energy",
    text: "Microbial fuel cells can generate electricity from organic waste using bacteria like Geobacter.",
    icon: "âš¡"
  },
  {
    category: "ğŸ§¬ Genetics",
    text: "Bacteria can share antibiotic resistance genes through horizontal gene transfer â€” not just reproduction.",
    icon: "ğŸ§¬"
  }
];

// MICROBIOLOGY CALCULATOR CLASS
class MicrobiologyCalculator {
  // Growth rate calculation
  static growthRate(N0, Nt, time, unit = 'hours') {
    // Convert time to hours for consistent calculation
    let timeHours = time;
    if (unit === 'minutes') timeHours = time / 60;
    if (unit === 'days') timeHours = time * 24;
    
    if (N0 <= 0 || Nt <= 0 || timeHours <= 0) return null;
    
    const r = (Math.log(Nt / N0)) / timeHours;
    const Td = Math.log(2) / r; // Doubling time in hours
    
    return {
      r: r.toFixed(4),
      rPerHour: (r).toFixed(4),
      rPerMinute: (r / 60).toFixed(6),
      doublingTime: Td.toFixed(2),
      doublingTimeHours: Td.toFixed(2),
      doublingTimeMinutes: (Td * 60).toFixed(2),
      generations: (Math.log(Nt / N0) / Math.log(2)).toFixed(1)
    };
  }
  
  // Dilution factor calculation
  static dilutionFactor(V1, V2, C1 = null, C2 = null) {
    if (V1 <= 0 || V2 <= 0) return null;
    
    const DF = V1 / V2;
    
    let results = {
      dilutionFactor: DF.toFixed(4),
      dilutionRatio: `1:${(1/DF).toFixed(2)}`,
      logReduction: Math.log10(DF).toFixed(2)
    };
    
    // If concentrations are provided
    if (C1 !== null && C2 !== null) {
      const expectedC2 = C1 / DF;
      results.expectedConcentration = expectedC2.toFixed(2);
      results.accuracy = ((C2 / expectedC2) * 100).toFixed(1) + '%';
    }
    
    return results;
  }
  
  // Cell density calculation
  static cellDensity(cellsPerML, volumeML) {
    if (cellsPerML <= 0 || volumeML <= 0) return null;
    
    const totalCells = cellsPerML * volumeML;
    
    return {
      totalCells: this.formatScientific(totalCells),
      cellsPerML: this.formatScientific(cellsPerML),
      cellsPerUL: (cellsPerML / 1000).toFixed(2),
      volumeML: volumeML.toFixed(2)
    };
  }
  
  // CFU calculation
  static cfuCalculation(colonies, dilutionFactor, volumePlatedML) {
    if (colonies <= 0 || dilutionFactor <= 0 || volumePlatedML <= 0) return null;
    
    const cfuPerML = (colonies * dilutionFactor) / volumePlatedML;
    const cellsInOriginal = cfuPerML; // Assuming 1mL original
    
    return {
      cfuPerML: this.formatScientific(cfuPerML),
      cfuTotal: this.formatScientific(cfuPerML), // For 1mL
      dilutionUsed: `10â»${Math.log10(dilutionFactor).toFixed(0)}`,
      coloniesCounted: colonies,
      confidence: colonies < 30 ? 'Low (count more colonies)' : 
                  colonies > 300 ? 'High (dilute more)' : 'Good'
    };
  }
  
  // Generation time calculation
  static generationTime(initialPop, finalPop, time, unit = 'hours') {
    const growthData = this.growthRate(initialPop, finalPop, time, unit);
    if (!growthData) return null;
    
    return {
      generationTime: growthData.doublingTime + ' hours',
      generations: growthData.generations,
      growthRate: growthData.rPerHour + ' per hour',
      timeFor10Generations: (growthData.doublingTime * 10).toFixed(1) + ' hours'
    };
  }
  
  // Optical density to cells
  static odToCells(od600, calibrationFactor = 8e8) {
    if (od600 <= 0) return null;
    
    const cellsPerML = od600 * calibrationFactor;
    
    return {
      cellsPerML: this.formatScientific(cellsPerML),
      od600: od600.toFixed(3),
      calibrationFactor: this.formatScientific(calibrationFactor),
      range: od600 < 0.1 ? 'Too low for accurate measurement' :
             od600 > 0.8 ? 'Above linear range (dilute sample)' :
             'Within linear range'
    };
  }
  
  // pH and microbial growth
  static phGrowth(pH, microbeType = 'bacteria') {
    let optimal, range, info;
    
    switch(microbeType) {
      case 'bacteria':
        optimal = 6.5;
        range = '4.0-9.0';
        info = 'Most bacteria prefer neutral pH';
        break;
      case 'fungi':
        optimal = 5.5;
        range = '2.0-8.0';
        info = 'Fungi tolerate acidic conditions better';
        break;
      case 'archaea':
        optimal = 2.0;
        range = '0.5-5.0';
        info = 'Acidophilic archaea thrive in extreme acidity';
        break;
      case 'lactic':
        optimal = 5.5;
        range = '4.0-7.0';
        info = 'Lactic acid bacteria produce acid as byproduct';
        break;
    }
    
    const difference = Math.abs(pH - optimal);
    let growth;
    if (difference < 0.5) growth = 'Optimal growth';
    else if (difference < 1.5) growth = 'Good growth';
    else if (difference < 2.5) growth = 'Slow growth';
    else growth = 'Little to no growth';
    
    return {
      currentPH: pH.toFixed(1),
      optimalPH: optimal,
      growthCondition: growth,
      phRange: range,
      additionalInfo: info,
      suitability: difference < 1.5 ? 'Suitable' : 'Suboptimal'
    };
  }
  
  // Helper: Format numbers in scientific notation
  static formatScientific(num) {
    if (num >= 1e6) {
      return (num / 1e6).toFixed(2) + ' Ã— 10â¶';
    } else if (num >= 1e3) {
      return (num / 1e3).toFixed(2) + ' Ã— 10Â³';
    } else {
      return num.toFixed(2);
    }
  }
}

// APPLICATION STATE
let microState = {
  currentTool: 'growth-rate',
  showFacts: true,
  showFormula: true,
  lastResult: null,
  factsShown: []
};

// Initialize
function microInitialize() {
  // Load tool inputs
  microUpdateToolInputs();
  
  // Add event listeners
  document.getElementById('micro-tool').addEventListener('change', microUpdateToolInputs);
  document.getElementById('micro-show-facts').addEventListener('change', microToggleFacts);
  document.getElementById('micro-show-formula').addEventListener('change', microToggleFormula);
  
  // Load some initial facts
  microShowRandomFacts(4);
  
  // Show visualization
  document.getElementById('micro-visualization').style.display = 'block';
  microUpdateVisualization();
}

// Update input fields based on selected tool
function microUpdateToolInputs() {
  const tool = document.getElementById('micro-tool').value;
  microState.currentTool = tool;
  
  const container = document.getElementById('micro-input-container');
  
  switch(tool) {
    case 'growth-rate':
      container.innerHTML = `
        <div id="micro-growth-rate-inputs" style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div>
            <label for="micro-N0" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Initial cells (Nâ‚€)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-N0" type="number" placeholder="100" min="1" step="1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <div style="color:rgba(230,250,255,0.7);font-size:12px;">cells</div>
            </div>
          </div>
          <div>
            <label for="micro-Nt" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Final cells (Nâ‚œ)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-Nt" type="number" placeholder="800" min="1" step="1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <div style="color:rgba(230,250,255,0.7);font-size:12px;">cells</div>
            </div>
          </div>
          <div>
            <label for="micro-time" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Time (t)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-time" type="number" placeholder="3" min="0.1" step="0.1" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <select id="micro-time-unit" style="padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:13px;">
                <option value="hours">hours</option>
                <option value="minutes">minutes</option>
                <option value="days">days</option>
              </select>
            </div>
          </div>
        </div>
      `;
      break;
      
    case 'dilution-factor':
      container.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label for="micro-V1" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Initial volume (Vâ‚)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-V1" type="number" placeholder="1" min="0.01" step="0.01" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <div style="color:rgba(230,250,255,0.7);font-size:12px;">mL</div>
            </div>
          </div>
          <div>
            <label for="micro-V2" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Final volume (Vâ‚‚)</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-V2" type="number" placeholder="10" min="0.01" step="0.01" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <div style="color:rgba(230,250,255,0.7);font-size:12px;">mL</div>
            </div>
          </div>
        </div>
      `;
      break;
      
    case 'cfu-calculation':
      container.innerHTML = `
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
          <div>
            <label for="micro-colonies" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Colonies counted</label>
            <input id="micro-colonies" type="number" placeholder="50" min="1" step="1" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
          </div>
          <div>
            <label for="micro-dilution" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Dilution factor</label>
            <input id="micro-dilution" type="number" placeholder="10000" min="1" step="1" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
          </div>
          <div>
            <label for="micro-volume" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:13px;">Volume plated</label>
            <div style="display:flex;align-items:center;gap:8px;">
              <input id="micro-volume" type="number" placeholder="0.1" min="0.01" step="0.01" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
              <div style="color:rgba(230,250,255,0.7);font-size:12px;">mL</div>
            </div>
          </div>
        </div>
      `;
      break;
      
    // Add more tool inputs as needed...
  }
  
  // Update status
  document.getElementById('micro-status').textContent = `Ready: ${tool.replace('-', ' ')}`;
}

// Load example values
function microLoadExample(select) {
  const example = select.value;
  if (!example) return;
  
  switch(example) {
    case 'growth-example':
      document.getElementById('micro-N0').value = 100;
      document.getElementById('micro-Nt').value = 800;
      document.getElementById('micro-time').value = 3;
      document.getElementById('micro-time-unit').value = 'hours';
      break;
      
    case 'dilution-example':
      document.getElementById('micro-V1').value = 1;
      document.getElementById('micro-V2').value = 10;
      break;
      
    case 'cfu-example':
      document.getElementById('micro-colonies').value = 50;
      document.getElementById('micro-dilution').value = 10000;
      document.getElementById('micro-volume').value = 0.1;
      break;
  }
  
  select.value = '';
}

// Main calculation function
function microCalculate(btn) {
  const tool = microState.currentTool;
  let result, formula, output = '';
  
  try {
    switch(tool) {
      case 'growth-rate':
        const N0 = parseFloat(document.getElementById('micro-N0').value);
        const Nt = parseFloat(document.getElementById('micro-Nt').value);
        const time = parseFloat(document.getElementById('micro-time').value);
        const unit = document.getElementById('micro-time-unit').value;
        
        result = MicrobiologyCalculator.growthRate(N0, Nt, time, unit);
        formula = 'r = ln(Nâ‚œ/Nâ‚€) / t\nTâ‚ = ln(2) / r';
        
        if (result) {
          output = `ğŸ“ˆ Bacterial Growth Rate Analysis:\n`;
          output += `â€¢ Growth rate (r): ${result.r} per hour\n`;
          output += `â€¢ Doubling time: ${result.doublingTimeHours} hours (${result.doublingTimeMinutes} minutes)\n`;
          output += `â€¢ Number of generations: ${result.generations}\n`;
          output += `â€¢ Cells increased: ${(Nt/N0).toFixed(1)}Ã—\n`;
        }
        break;
        
      case 'dilution-factor':
        const V1 = parseFloat(document.getElementById('micro-V1').value);
        const V2 = parseFloat(document.getElementById('micro-V2').value);
        
        result = MicrobiologyCalculator.dilutionFactor(V1, V2);
        formula = 'DF = Vâ‚ / Vâ‚‚\nLog reduction = logâ‚â‚€(DF)';
        
        if (result) {
          output = `ğŸ§´ Dilution Analysis:\n`;
          output += `â€¢ Dilution factor: ${result.dilutionFactor}\n`;
          output += `â€¢ Dilution ratio: 1:${(1/result.dilutionFactor).toFixed(2)}\n`;
          output += `â€¢ Log reduction: ${result.logReduction} logâ‚â‚€\n`;
          output += `â€¢ Concentration reduced to: ${(100/result.dilutionFactor).toFixed(2)}%\n`;
        }
        break;
        
      case 'cfu-calculation':
        const colonies = parseFloat(document.getElementById('micro-colonies').value);
        const dilution = parseFloat(document.getElementById('micro-dilution').value);
        const volume = parseFloat(document.getElementById('micro-volume').value);
        
        result = MicrobiologyCalculator.cfuCalculation(colonies, dilution, volume);
        formula = 'CFU/mL = (colonies Ã— dilution factor) / volume plated';
        
        if (result) {
          output = `ğŸ§« Colony Forming Units:\n`;
          output += `â€¢ CFU/mL: ${result.cfuPerML}\n`;
          output += `â€¢ Dilution used: ${result.dilutionUsed}\n`;
          output += `â€¢ Colonies counted: ${result.coloniesCounted}\n`;
          output += `â€¢ Data quality: ${result.confidence}\n`;
        }
        break;
        
      // Add more tool calculations...
    }
    
    if (!result) {
      output = 'âŒ Please enter valid values for calculation.';
      formula = '';
    }
    
  } catch (error) {
    output = 'âŒ Calculation error. Please check your inputs.';
    formula = '';
    console.error('Microbiology calculation error:', error);
  }
  
  // Update output
  document.getElementById('micro-output').value = output;
  microState.lastResult = result;
  
  // Update formula display
  const formulaContainer = document.getElementById('micro-formula-container');
  const formulaElement = document.getElementById('micro-formula');
  
  if (microState.showFormula && formula) {
    formulaElement.textContent = formula;
    formulaContainer.style.display = 'block';
  } else {
    formulaContainer.style.display = 'none';
  }
  
  // Update status
  document.getElementById('micro-status').textContent = result ? 'âœ… Calculated' : 'âš ï¸ Check inputs';
  
  // Update visualization based on result
  microUpdateVisualization(result);
  
  // Show facts if enabled
  if (microState.showFacts) {
    document.getElementById('micro-facts-container').style.display = 'block';
    if (!microState.factsShown.length) {
      microShowRandomFacts(4);
    }
  }
  
  // Visual feedback
  btn.innerHTML = 'âœ… Calculated!';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ§« Calculate Microbiology Value';
  }, 1000);
}

// Show random microbiology facts
function microShowRandomFacts(count = 4) {
  const container = document.getElementById('micro-facts-grid');
  microState.factsShown = [];
  container.innerHTML = '';
  
  // Get unique random facts
  const shuffled = [...microFacts].sort(() => 0.5 - Math.random());
  const selected = shuffled.slice(0, count);
  
  selected.forEach(fact => {
    microState.factsShown.push(fact);
    
    const factCard = document.createElement('div');
    factCard.style.cssText = `
      background: linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 16px;
      transition: all 0.3s ease;
    `;
    
    factCard.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
        <div style="font-size:20px;">${fact.icon}</div>
        <div style="color:var(--accent);font-weight:500;font-size:13px;">${fact.category}</div>
      </div>
      <div style="color:rgba(230,250,255,0.9);font-size:13px;line-height:1.5;">${fact.text}</div>
    `;
    
    factCard.addEventListener('mouseenter', () => {
      factCard.style.transform = 'translateY(-2px)';
      factCard.style.boxShadow = '0 6px 12px rgba(0,0,0,0.2)';
    });
    
    factCard.addEventListener('mouseleave', () => {
      factCard.style.transform = '';
      factCard.style.boxShadow = '';
    });
    
    container.appendChild(factCard);
  });
}

// Show new random facts
function microNewFacts() {
  microShowRandomFacts(4);
  
  // Visual feedback
  const btn = document.querySelector('[onclick="microNewFacts()"]');
  btn.innerHTML = 'ğŸ”„ Loading...';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ”„ New Facts';
  }, 500);
}

// Update size visualization
function microUpdateVisualization(result = null) {
  const bar = document.getElementById('micro-size-bar');
  const text = document.getElementById('micro-scale-text');
  
  if (result) {
    // If we have growth data, show how many times larger
    if (result.generations) {
      const generations = parseFloat(result.generations);
      const sizeIncrease = Math.min(95, generations * 5); // Scale for visualization
      bar.style.width = `${sizeIncrease}%`;
      text.textContent = `After ${generations} generations, population increased ~${Math.pow(2, generations).toFixed(0)}Ã—`;
    }
  } else {
    // Default visualization
    bar.style.width = '33%';
    text.textContent = 'Microbes exist at scales invisible to the naked eye';
  }
}

// Toggle facts display
function microToggleFacts() {
  microState.showFacts = document.getElementById('micro-show-facts').checked;
  document.getElementById('micro-facts-container').style.display = microState.showFacts ? 'block' : 'none';
}

// Toggle formula display
function microToggleFormula() {
  microState.showFormula = document.getElementById('micro-show-formula').checked;
  const formulaContainer = document.getElementById('micro-formula-container');
  formulaContainer.style.display = microState.showFormula && microState.lastResult ? 'block' : 'none';
}

// Reset everything
function microReset(btn) {
  // Clear inputs
  const container = document.getElementById('micro-input-container');
  container.querySelectorAll('input, select').forEach(el => {
    if (el.type !== 'checkbox') {
      el.value = '';
    }
  });
  
  // Clear outputs
  document.getElementById('micro-output').value = '';
  document.getElementById('micro-formula-container').style.display = 'none';
  document.getElementById('micro-status').textContent = 'Ready to calculate';
  
  // Reset checkboxes to defaults
  document.getElementById('micro-show-facts').checked = true;
  document.getElementById('micro-show-formula').checked = true;
  
  // Update state
  microState.showFacts = true;
  microState.showFormula = true;
  microState.lastResult = null;
  microState.factsShown = [];
  
  // Reset visualization
  microUpdateVisualization();
  
  // Show facts
  document.getElementById('micro-facts-container').style.display = 'block';
  microShowRandomFacts(4);
  
  // Visual feedback
  btn.innerHTML = 'âœ… Reset!';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ”„ Reset';
  }, 1000);
}

// Copy results to clipboard
function microCopy(btn) {
  const output = document.getElementById('micro-output').value;
  if (!output.trim()) return;
  
  navigator.clipboard.writeText(output).then(() => {
    // Visual feedback
    btn.innerHTML = 'âœ… Copied!';
    setTimeout(() => {
      btn.innerHTML = 'ğŸ“‹ Copy';
    }, 1000);
    
    // Update status
    document.getElementById('micro-status').textContent = 'ğŸ“‹ Copied to clipboard';
  }).catch(err => {
    console.error('Copy failed:', err);
    alert('Copy failed. Please select and copy manually.');
  });
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', microInitialize);
} else {
  microInitialize();
}
</script>

<!-- CARD-SPECIFIC STYLES -->
<style>
#microbiology-title {
  background: linear-gradient(135deg, var(--accent), #39ff14);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  margin-bottom: 8px;
}

/* Animations */
@keyframes microPulse {
  0% { transform: scale(1); }
  50% { transform: scale(1.02); }
  100% { transform: scale(1); }
}

@keyframes slideIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.micro-fact-card {
  animation: slideIn 0.4s ease-out;
}

#micro-size-bar {
  animation: microPulse 2s infinite alternate;
}

/* Tool-specific styles */
#micro-input-container input:focus,
#micro-input-container select:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  #micro-input-container > div {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  
  #micro-facts-grid {
    grid-template-columns: 1fr !important;
  }
  
  .actions {
    flex-direction: column !important;
  }
  
  .actions button {
    width: 100% !important;
    margin: 4px 0 !important;
  }
}

/* Print styles */
@media print {
  #micro-facts-container,
  #micro-visualization,
  details,
  button {
    display: none !important;
  }
  
  #micro-output {
    border: 1px solid #000 !important;
    background: white !important;
    color: black !important;
  }
}

/* Custom scrollbar for textarea */
#micro-output::-webkit-scrollbar {
  width: 8px;
}

#micro-output::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 4px;
}

#micro-output::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 4px;
}

/* Hover effects */
#micro-facts-grid > div:hover {
  border-color: var(--accent) !important;
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0,0,0,0.2);
}

/* Scientific notation styling */
.scientific {
  font-family: monospace;
  color: #39ff14;
}

/* Loading animation */
@keyframes loading {
  0% { opacity: 0.5; }
  50% { opacity: 1; }
  100% { opacity: 0.5; }
}

.loading {
  animation: loading 1.5s infinite;
}
</style>
