<h2 id="probability-calculator-title">üé≤ Probability Calculator</h2>

<form aria-describedby="probability-calculator-desc">
    <p id="probability-calculator-desc" class="small">
        Calculate probabilities for various scenarios with detailed explanations.
        <span style="color:var(--accent)">Includes binomial, normal, and combinatorial calculations.</span>
    </p>
    
    <!-- CALCULATION TYPE -->
    <div class="field" style="margin-bottom:20px;">
        <label for="pb-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
            Calculation Type
        </label>
        <select id="pb-type" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;"
                onchange="pbUpdateInputs()">
            <option value="simple">Simple Probability</option>
            <option value="multiple">Multiple Events</option>
            <option value="binomial">Binomial Distribution</option>
            <option value="normal">Normal Distribution</option>
            <option value="combinatorial">Combinatorial Analysis</option>
            <option value="conditional">Conditional Probability</option>
            <option value="expected">Expected Value</option>
            <option value="bayes">Bayes' Theorem</option>
        </select>
    </div>
    
    <!-- DYNAMIC INPUT FIELDS -->
    <div id="pb-inputs" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:20px;">
        <!-- Simple probability inputs -->
        <div>
            <label for="pb-favorable" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Favorable Outcomes
            </label>
            <input id="pb-favorable" type="number" placeholder="e.g., 3" min="0" step="1"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        </div>
        
        <div>
            <label for="pb-total" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Total Outcomes
            </label>
            <input id="pb-total" type="number" placeholder="e.g., 12" min="1" step="1"
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        </div>
    </div>
    
    <!-- ADDITIONAL INPUTS -->
    <div id="pb-extra-inputs" style="display:none;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:20px;">
        <!-- Will be populated dynamically -->
    </div>
    
    <!-- QUICK EXAMPLES -->
    <div style="margin-bottom:20px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;font-size:14px;">Quick Examples:</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" onclick="pbLoadExample('dice')" style="padding:6px 10px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">üé≤ Dice Roll</button>
            <button type="button" onclick="pbLoadExample('coin')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">ü™ô Coin Toss</button>
            <button type="button" onclick="pbLoadExample('cards')" style="padding:6px 10px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:6px;color:#9d4edd;cursor:pointer;font-size:12px;">üÉè Card Draw</button>
            <button type="button" onclick="pbLoadExample('lottery')" style="padding:6px 10px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:12px;">üèÜ Lottery</button>
            <button type="button" onclick="pbLoadExample('normal')" style="padding:6px 10px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;color:#ffa500;cursor:pointer;font-size:12px;">üìà Normal Dist</button>
        </div>
    </div>
    
    <!-- DISPLAY OPTIONS -->
    <div style="margin-bottom:20px;display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
        <div>
            <label for="pb-show-formula" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Show Formula
            </label>
            <select id="pb-show-formula" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="yes" selected>Yes</option>
                <option value="no">No</option>
            </select>
        </div>
        
        <div>
            <label for="pb-decimal-places" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Decimal Places
            </label>
            <select id="pb-decimal-places" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="2">2</option>
                <option value="4" selected>4</option>
                <option value="6">6</option>
                <option value="8">8</option>
            </select>
        </div>
    </div>
    
    <!-- ACTIONS -->
    <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
        <button type="button" onclick="pbCalculate()" 
                style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(157,78,221,0.2), rgba(157,78,221,0.1));border:1px solid rgba(157,78,221,0.4);border-radius:8px;color:#9d4edd;cursor:pointer;font-weight:600;">
            üé≤ Calculate Probability
        </button>
        <button type="button" onclick="pbReset()"
                style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
            Reset
        </button>
        <button type="button" onclick="pbCopyResults()" id="pb-copy-btn"
                style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
            üìã Copy
        </button>
    </div>
</form>

<!-- PROBABILITY VISUALIZATION -->
<div id="pb-visualization" style="display:none;margin-top:20px;padding:20px;background:rgba(0,0,0,0.2);border-radius:12px;border:1px solid rgba(45,212,255,0.2);">
    <h3 class="small" style="color:var(--accent);margin-bottom:12px;">üìä Probability Visualization</h3>
    <div id="pb-chart-container" style="height:200px;position:relative;background:rgba(0,0,0,0.3);border-radius:8px;overflow:hidden;">
        <!-- Chart will be rendered here -->
        <div id="pb-bar-chart" style="display:flex;height:100%;align-items:flex-end;gap:4px;padding:20px;"></div>
    </div>
    <div id="pb-chart-labels" style="display:flex;justify-content:space-between;margin-top:8px;font-size:12px;color:rgba(230,250,255,0.7);"></div>
</div>

<!-- RESULTS -->
<div class="results" aria-live="polite" style="margin-top:16px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:8px;">üìà Calculation Results</h3>
    
    <div id="pb-output" style="padding:20px;background:linear-gradient(135deg, rgba(157,78,221,0.05), rgba(45,212,255,0.05));border-radius:12px;border:1px solid rgba(157,78,221,0.2);min-height:150px;">
        <div style="text-align:center;color:rgba(230,250,255,0.6);padding:40px 20px;">
            <div style="font-size:48px;margin-bottom:16px;">üé≤</div>
            <h3 style="color:var(--accent);margin-bottom:8px;">Probability Calculator Ready</h3>
            <p>Select a calculation type and enter values to begin.</p>
        </div>
    </div>
    
    <!-- DETAILED RESULTS -->
    <div id="pb-results-grid" style="display:none;margin-top:20px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">
            <div style="padding:12px;background:rgba(157,78,221,0.1);border-radius:8px;border:1px solid rgba(157,78,221,0.3);text-align:center;">
                <div style="color:rgba(230,250,255,0.8);font-size:13px;">Probability</div>
                <div id="pb-probability" style="font-size:28px;font-weight:700;color:#9d4edd;">‚Äì</div>
            </div>
            
            <div style="padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;border:1px solid rgba(45,212,255,0.3);text-align:center;">
                <div style="color:rgba(230,250,255,0.8);font-size:13px;">Percentage</div>
                <div id="pb-percentage" style="font-size:28px;font-weight:700;color:var(--accent);">‚Äì</div>
            </div>
            
            <div style="padding:12px;background:rgba(57,255,20,0.1);border-radius:8px;border:1px solid rgba(57,255,20,0.3);text-align:center;">
                <div style="color:rgba(230,250,255,0.8);font-size:13px;">Odds</div>
                <div id="pb-odds" style="font-size:28px;font-weight:700;color:#39ff14;">‚Äì</div>
            </div>
            
            <div style="padding:12px;background:rgba(255,165,0,0.1);border-radius:8px;border:1px solid rgba(255,165,0,0.3);text-align:center;">
                <div style="color:rgba(230,250,255,0.8);font-size:13px;">Complement</div>
                <div id="pb-complement" style="font-size:28px;font-weight:700;color:#ffa500;">‚Äì</div>
            </div>
        </div>
    </div>
    
    <!-- FORMULA AND EXPLANATION -->
    <div id="pb-formula-section" style="display:none;margin-top:20px;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(45,212,255,0.2);">
        <h4 style="color:var(--accent);margin-bottom:12px;">üìù Formula & Explanation</h4>
        <div id="pb-formula-content" style="font-family:monospace;font-size:13px;line-height:1.6;white-space:pre-line;"></div>
    </div>
</div>

<!-- PROBABILITY REFERENCE -->
<div style="margin-top:20px;padding:16px;background:linear-gradient(135deg, rgba(157,78,221,0.05), rgba(45,212,255,0.05));border-radius:8px;border:1px solid rgba(157,78,221,0.3);">
    <h3 class="small" style="color:var(--accent);margin-bottom:8px;">üìö Probability Reference</h3>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
        <div>
            <div style="color:#9d4edd;font-weight:600;margin-bottom:4px;">Basic Rules</div>
            <ul style="margin:0;padding-left:18px;color:rgba(230,250,255,0.9);font-size:13px;line-height:1.5;">
                <li>P(A) = favorable / total</li>
                <li>0 ‚â§ P(A) ‚â§ 1</li>
                <li>P(not A) = 1 - P(A)</li>
                <li>P(A or B) = P(A) + P(B) - P(A and B)</li>
            </ul>
        </div>
        <div>
            <div style="color:var(--accent);font-weight:600;margin-bottom:4px;">Independent Events</div>
            <ul style="margin:0;padding-left:18px;color:rgba(230,250,255,0.9);font-size:13px;line-height:1.5;">
                <li>P(A and B) = P(A) √ó P(B)</li>
                <li>P(A or B) = P(A) + P(B) - P(A)√óP(B)</li>
            </ul>
        </div>
        <div>
            <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">Common Distributions</div>
            <ul style="margin:0;padding-left:18px;color:rgba(230,250,255,0.9);font-size:13px;line-height:1.5;">
                <li>Binomial: P(X=k) = C(n,k)√óp·µè√ó(1-p)‚Åø‚Åª·µè</li>
                <li>Normal: Z = (x-Œº)/œÉ</li>
            </ul>
        </div>
    </div>
</div>

<script>
/* probability-calculator.html
   - Comprehensive probability calculator
   - Scoped with pb- prefix
*/

// Configuration for different calculation types
const pbTypes = {
    simple: {
        name: "Simple Probability",
        inputs: [
            { id: "pb-favorable", label: "Favorable Outcomes", required: true, min: 0 },
            { id: "pb-total", label: "Total Outcomes", required: true, min: 1 }
        ],
        calculate: (favorable, total) => {
            const probability = favorable / total;
            const complement = 1 - probability;
            const odds = `${favorable}:${total - favorable}`;
            
            return {
                probability,
                complement,
                odds,
                favorable,
                total,
                details: `Simple Probability Calculation:\nP(A) = favorable / total\nP(A) = ${favorable} / ${total}\nP(A) = ${probability.toFixed(4)}\n\nComplement: P(not A) = 1 - P(A) = ${complement.toFixed(4)}\nOdds: ${odds}`
            };
        }
    },
    multiple: {
        name: "Multiple Events",
        inputs: [
            { id: "pb-favorable", label: "Favorable for A", required: true },
            { id: "pb-total", label: "Total for A", required: true },
            { id: "pb-favorable-b", label: "Favorable for B", required: true },
            { id: "pb-total-b", label: "Total for B", required: true },
            { id: "pb-relation", label: "Relation", type: "select", options: ["Independent", "Mutually Exclusive", "General"] }
        ],
        calculate: (favA, totalA, favB, totalB, relation) => {
            const pA = favA / totalA;
            const pB = favB / totalB;
            
            let pAnd = 0, pOr = 0, formula = "";
            
            switch(relation) {
                case "Independent":
                    pAnd = pA * pB;
                    pOr = pA + pB - pAnd;
                    formula = `Independent Events:\nP(A and B) = P(A) √ó P(B)\nP(A or B) = P(A) + P(B) - P(A)√óP(B)`;
                    break;
                case "Mutually Exclusive":
                    pAnd = 0;
                    pOr = pA + pB;
                    formula = `Mutually Exclusive Events:\nP(A and B) = 0\nP(A or B) = P(A) + P(B)`;
                    break;
                case "General":
                    // For general case, assume some overlap
                    const overlap = Math.min(favA, favB) * 0.5; // Simplified assumption
                    pAnd = overlap / (totalA + totalB - overlap);
                    pOr = pA + pB - pAnd;
                    formula = `General Case (with overlap):\nP(A and B) = P(A‚à©B) (estimated)\nP(A or B) = P(A) + P(B) - P(A‚à©B)`;
                    break;
            }
            
            return {
                pA,
                pB,
                pAnd,
                pOr,
                relation,
                details: `${formula}\n\nP(A) = ${favA}/${totalA} = ${pA.toFixed(4)}\nP(B) = ${favB}/${totalB} = ${pB.toFixed(4)}\nP(A and B) = ${pAnd.toFixed(4)}\nP(A or B) = ${pOr.toFixed(4)}`
            };
        }
    },
    binomial: {
        name: "Binomial Distribution",
        inputs: [
            { id: "pb-trials", label: "Number of Trials (n)", required: true, min: 1 },
            { id: "pb-successes", label: "Successes (k)", required: true, min: 0 },
            { id: "pb-prob-success", label: "Probability of Success (p)", required: true, min: 0, max: 1, step: 0.01 },
            { id: "pb-cumulative", label: "Cumulative?", type: "select", options: ["No", "‚â§ k", "‚â• k", "= k"] }
        ],
        calculate: (n, k, p, cumulative) => {
            // Binomial coefficient function
            const comb = (n, k) => {
                if (k < 0 || k > n) return 0;
                let result = 1;
                for (let i = 1; i <= k; i++) {
                    result *= (n - i + 1) / i;
                }
                return result;
            };
            
            // Calculate probability for exactly k successes
            const exact = comb(n, k) * Math.pow(p, k) * Math.pow(1 - p, n - k);
            
            let probability = exact;
            let cumulativeText = "";
            
            if (cumulative === "‚â§ k") {
                // Sum probabilities from 0 to k
                let sum = 0;
                for (let i = 0; i <= k; i++) {
                    sum += comb(n, i) * Math.pow(p, i) * Math.pow(1 - p, n - i);
                }
                probability = sum;
                cumulativeText = ` (cumulative ‚â§ ${k})`;
            } else if (cumulative === "‚â• k") {
                // Sum probabilities from k to n
                let sum = 0;
                for (let i = k; i <= n; i++) {
                    sum += comb(n, i) * Math.pow(p, i) * Math.pow(1 - p, n - i);
                }
                probability = sum;
                cumulativeText = ` (cumulative ‚â• ${k})`;
            }
            
            const mean = n * p;
            const variance = n * p * (1 - p);
            const stdDev = Math.sqrt(variance);
            
            return {
                probability,
                exact,
                mean,
                variance,
                stdDev,
                details: `Binomial Distribution${cumulativeText}:\nP(X = k) = C(n,k) √ó p·µè √ó (1-p)‚Åø‚Åª·µè\nP(${cumulative === "= k" ? "=" : cumulative === "‚â§ k" ? "‚â§" : "‚â•"} ${k}) = ${probability.toFixed(6)}\n\nParameters:\nn = ${n}, p = ${p}\nMean = n√óp = ${mean.toFixed(2)}\nVariance = n√óp√ó(1-p) = ${variance.toFixed(2)}\nStd Dev = ‚àövariance = ${stdDev.toFixed(2)}`
            };
        }
    },
    normal: {
        name: "Normal Distribution",
        inputs: [
            { id: "pb-mean", label: "Mean (Œº)", required: true },
            { id: "pb-stddev", label: "Standard Deviation (œÉ)", required: true, min: 0.0001 },
            { id: "pb-x-value", label: "X Value", required: true },
            { id: "pb-calc-type", label: "Calculate", type: "select", options: ["P(X ‚â§ x)", "P(X ‚â• x)", "P(x‚ÇÅ ‚â§ X ‚â§ x‚ÇÇ)"] }
        ],
        calculate: (mean, stdDev, x, calcType) => {
            // Standard normal CDF approximation (Abramowitz & Stegun)
            const phi = (z) => {
                const t = 1 / (1 + 0.2316419 * Math.abs(z));
                const d = 0.3989423 * Math.exp(-z * z / 2);
                let prob = d * t * (0.3193815 + t * (-0.3565638 + t * (1.781478 + t * (-1.821256 + t * 1.330274))));
                return z > 0 ? 1 - prob : prob;
            };
            
            const z = (x - mean) / stdDev;
            let probability = phi(z);
            let details = `Normal Distribution:\nZ = (x - Œº) / œÉ\nZ = (${x} - ${mean}) / ${stdDev} = ${z.toFixed(4)}`;
            
            if (calcType === "P(X ‚â• x)") {
                probability = 1 - probability;
                details += `\nP(X ‚â• ${x}) = 1 - P(X ‚â§ ${x}) = ${probability.toFixed(6)}`;
            } else if (calcType === "P(x‚ÇÅ ‚â§ X ‚â§ x‚ÇÇ)") {
                // For range probability, we need two x values
                // This is handled in the UI with extra inputs
                details += `\nP(X ‚â§ ${x}) = ${probability.toFixed(6)}`;
            } else {
                details += `\nP(X ‚â§ ${x}) = ${probability.toFixed(6)}`;
            }
            
            return {
                probability,
                zScore: z,
                mean,
                stdDev,
                details
            };
        }
    },
    combinatorial: {
        name: "Combinatorial Analysis",
        inputs: [
            { id: "pb-n", label: "n (total items)", required: true, min: 1 },
            { id: "pb-k", label: "k (choose)", required: true, min: 0 },
            { id: "pb-calculation", label: "Calculation", type: "select", options: ["Combinations", "Permutations", "Both"] }
        ],
        calculate: (n, k, calculation) => {
            // Factorial function
            const fact = (x) => {
                if (x <= 1) return 1;
                let result = 1;
                for (let i = 2; i <= x; i++) result *= i;
                return result;
            };
            
            const combinations = fact(n) / (fact(k) * fact(n - k));
            const permutations = fact(n) / fact(n - k);
            
            let resultValue = calculation === "Combinations" ? combinations : permutations;
            let details = `Combinatorial Analysis:\n`;
            
            if (calculation === "Combinations" || calculation === "Both") {
                details += `C(${n},${k}) = n! / (k! √ó (n-k)!) = ${combinations}\n`;
            }
            if (calculation === "Permutations" || calculation === "Both") {
                details += `P(${n},${k}) = n! / (n-k)! = ${permutations}`;
            }
            
            return {
                combinations,
                permutations,
                result: resultValue,
                details
            };
        }
    }
};

// Update input fields based on selected type
function pbUpdateInputs() {
    const card = document.currentScript?.closest('.card') || document;
    const typeSelect = card.querySelector('#pb-type');
    const extraInputsContainer = card.querySelector('#pb-extra-inputs');
    const basicInputs = card.querySelector('#pb-inputs');
    
    const type = typeSelect.value;
    const typeConfig = pbTypes[type];
    
    // Clear extra inputs
    extraInputsContainer.innerHTML = '';
    extraInputsContainer.style.display = 'none';
    
    // Create additional inputs for the type
    const extraInputs = typeConfig.inputs.slice(2); // Skip first two inputs
    
    if (extraInputs.length > 0) {
        extraInputsContainer.style.display = 'grid';
        
        extraInputs.forEach((input, index) => {
            const inputId = input.id;
            const div = document.createElement('div');
            
            if (input.type === 'select') {
                div.innerHTML = `
                    <label for="${inputId}" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                        ${input.label}
                    </label>
                    <select id="${inputId}" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                        ${input.options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
            } else {
                div.innerHTML = `
                    <label for="${inputId}" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                        ${input.label}
                    </label>
                    <input id="${inputId}" type="number" placeholder="${input.label}" 
                           ${input.min ? `min="${input.min}"` : ''}
                           ${input.max ? `max="${input.max}"` : ''}
                           ${input.step ? `step="${input.step}"` : 'step="any"'}
                           style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
                `;
            }
            
            extraInputsContainer.appendChild(div);
        });
    }
    
    // Update description
    const desc = card.querySelector('#probability-calculator-desc');
    desc.innerHTML = `${typeConfig.name}. <span style="color:var(--accent)">Includes detailed formulas and explanations.</span>`;
}

// Load example scenarios
function pbLoadExample(example) {
    const card = document.currentScript?.closest('.card') || document;
    
    switch(example) {
        case 'dice':
            card.querySelector('#pb-type').value = 'simple';
            pbUpdateInputs();
            card.querySelector('#pb-favorable').value = 1;
            card.querySelector('#pb-total').value = 6;
            pbCalculate();
            break;
            
        case 'coin':
            card.querySelector('#pb-type').value = 'simple';
            pbUpdateInputs();
            card.querySelector('#pb-favorable').value = 1;
            card.querySelector('#pb-total').value = 2;
            pbCalculate();
            break;
            
        case 'cards':
            card.querySelector('#pb-type').value = 'simple';
            pbUpdateInputs();
            card.querySelector('#pb-favorable').value = 4;
            card.querySelector('#pb-total').value = 52;
            pbCalculate();
            break;
            
        case 'lottery':
            card.querySelector('#pb-type').value = 'combinatorial';
            pbUpdateInputs();
            card.querySelector('#pb-n').value = 49;
            card.querySelector('#pb-k').value = 6;
            pbCalculate();
            break;
            
        case 'normal':
            card.querySelector('#pb-type').value = 'normal';
            pbUpdateInputs();
            card.querySelector('#pb-mean').value = 100;
            card.querySelector('#pb-stddev').value = 15;
            card.querySelector('#pb-x-value').value = 115;
            pbCalculate();
            break;
    }
}

// Create probability visualization
function pbCreateVisualization(probability, complement) {
    const chartContainer = document.getElementById('pb-bar-chart');
    const chartLabels = document.getElementById('pb-chart-labels');
    
    if (!chartContainer) return;
    
    const probPercent = Math.round(probability * 100);
    const compPercent = Math.round(complement * 100);
    
    chartContainer.innerHTML = `
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;">
            <div style="background:linear-gradient(to top, #9d4edd, #7b2cbf);width:80%;border-radius:4px 4px 0 0;"
                 style="height:${probPercent}%;"></div>
            <div style="margin-top:4px;color:#9d4edd;font-size:12px;font-weight:600;">${probPercent}%</div>
        </div>
        <div style="flex:1;display:flex;flex-direction:column;align-items:center;">
            <div style="background:linear-gradient(to top, var(--accent), #1e90ff);width:80%;border-radius:4px 4px 0 0;"
                 style="height:${compPercent}%;"></div>
            <div style="margin-top:4px;color:var(--accent);font-size:12px;font-weight:600;">${compPercent}%</div>
        </div>
    `;
    
    chartLabels.innerHTML = `
        <div style="color:#9d4edd;">Event A</div>
        <div style="color:var(--accent);">Complement</div>
    `;
    
    document.getElementById('pb-visualization').style.display = 'block';
}

// Main calculation function
function pbCalculate() {
    const card = document.currentScript?.closest('.card') || document;
    const typeSelect = card.querySelector('#pb-type');
    const type = typeSelect.value;
    const typeConfig = pbTypes[type];
    
    // Get input values
    const inputs = [];
    let allValid = true;
    
    // Get basic inputs
    const favorableInput = card.querySelector('#pb-favorable');
    const totalInput = card.querySelector('#pb-total');
    
    if (favorableInput && favorableInput.style.display !== 'none') {
        const favorable = parseFloat(favorableInput.value);
        if (isNaN(favorable) || favorable < 0) allValid = false;
        inputs.push(favorable);
    }
    
    if (totalInput && totalInput.style.display !== 'none') {
        const total = parseFloat(totalInput.value);
        if (isNaN(total) || total <= 0) allValid = false;
        inputs.push(total);
    }
    
    // Get extra inputs
    const extraInputs = card.querySelectorAll('#pb-extra-inputs input, #pb-extra-inputs select');
    extraInputs.forEach(input => {
        if (input.tagName === 'SELECT') {
            inputs.push(input.value);
        } else {
            const value = parseFloat(input.value);
            if (isNaN(value)) allValid = false;
            inputs.push(value);
        }
    });
    
    // Validate inputs
    if (!allValid) {
        card.querySelector('#pb-output').innerHTML = `
            <div style="text-align:center;padding:20px;color:#ff2d55;">
                <div style="font-size:32px;">‚ö†Ô∏è</div>
                <h3 style="color:#ff2d55;margin-top:8px;">Invalid Input</h3>
                <p>Please enter valid numbers in all required fields.</p>
            </div>
        `;
        card.querySelector('#pb-results-grid').style.display = 'none';
        card.querySelector('#pb-formula-section').style.display = 'none';
        document.getElementById('pb-visualization').style.display = 'none';
        return;
    }
    
    // Perform calculation
    try {
        const result = typeConfig.calculate(...inputs);
        
        // Update results display
        pbUpdateResults(result, type);
        
        // Create visualization for simple probability
        if (type === 'simple' && result.probability !== undefined) {
            pbCreateVisualization(result.probability, result.complement);
        } else {
            document.getElementById('pb-visualization').style.display = 'none';
        }
        
    } catch (error) {
        console.error('Calculation error:', error);
        card.querySelector('#pb-output').innerHTML = `
            <div style="text-align:center;padding:20px;color:#ff2d55;">
                <div style="font-size:32px;">‚ùå</div>
                <h3 style="color:#ff2d55;margin-top:8px;">Calculation Error</h3>
                <p>An error occurred during calculation. Please check your inputs.</p>
            </div>
        `;
    }
}

// Update results display
function pbUpdateResults(result, type) {
    const card = document.currentScript?.closest('.card') || document;
    const output = card.querySelector('#pb-output');
    const resultsGrid = card.querySelector('#pb-results-grid');
    const formulaSection = card.querySelector('#pb-formula
