<!-- cards/debt-payoff-calculator.html -->
<h2 id="debt-payoff-calculator-title" style="margin-top:0;color:var(--accent);position:relative;">
  ğŸ’° Debt Payoff Calculator
  <span style="position:absolute;right:0;top:0;font-size:0.7rem;color:rgba(45,212,255,0.7);font-weight:normal;">
    Financial Freedom Tool
  </span>
</h2>

<form aria-describedby="debt-payoff-calculator-desc">
  <p id="debt-payoff-calculator-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.9);">
    Calculate how long it will take to become debt-free and save money with different payoff strategies.
  </p>

  <!-- Debt Details Card -->
  <div style="background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:16px;">
      <!-- Balance -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="dp-balance" style="color:var(--accent);font-weight:500;">ğŸ¦ Debt Balance</label>
          <span id="dp-balance-display" style="font-size:0.9rem;color:#39ff14;">Â£5,000</span>
        </div>
        <input id="dp-balance" type="range" min="100" max="100000" step="100" value="5000"
               style="width:100%;margin-bottom:8px;accent-color:#39ff14;" />
        <input id="dp-balance-input" type="number" min="100" max="500000" value="5000"
               style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:inherit;font-size:1rem;" />
        <div class="small" style="margin-top:4px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>Â£100</span>
          <span>Â£100,000</span>
        </div>
      </div>

      <!-- Interest Rate -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="dp-rate" style="color:var(--accent);font-weight:500;">ğŸ“ˆ Interest Rate</label>
          <span id="dp-rate-display" style="font-size:0.9rem;color:#ffcc00;">5%</span>
        </div>
        <input id="dp-rate" type="range" min="0" max="30" step="0.5" value="5"
               style="width:100%;margin-bottom:8px;accent-color:#ffcc00;" />
        <input id="dp-rate-input" type="number" min="0" max="50" step="0.1" value="5"
               style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,204,0,0.3);background:rgba(255,204,0,0.05);color:inherit;font-size:1rem;" />
        <div class="small" style="margin-top:4px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>0%</span>
          <span>30%</span>
        </div>
      </div>

      <!-- Monthly Payment -->
      <div class="field" style="position:relative;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <label for="dp-payment" style="color:var(--accent);font-weight:500;">ğŸ’° Monthly Payment</label>
          <span id="dp-payment-display" style="font-size:0.9rem;color:#39ff14;">Â£200</span>
        </div>
        <input id="dp-payment" type="range" min="10" max="5000" step="10" value="200"
               style="width:100%;margin-bottom:8px;accent-color:#39ff14;" />
        <input id="dp-payment-input" type="number" min="10" max="10000" value="200"
               style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:inherit;font-size:1rem;" />
        <div class="small" style="margin-top:4px;color:rgba(230,250,255,0.7);display:flex;justify-content:space-between;">
          <span>Â£10</span>
          <span>Â£5,000</span>
        </div>
      </div>
    </div>

    <!-- Debt Type Selector -->
    <div>
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <label style="color:var(--accent);font-weight:500;">ğŸ’³ Debt Type</label>
        <span id="dp-type-indicator" style="font-size:0.9rem;color:#9d4edd;">Personal Loan</span>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;">
        <button type="button" onclick="dpSetDebtType('personal')" 
                style="padding:10px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;font-weight:500;">
          ğŸ’° Personal
        </button>
        <button type="button" onclick="dpSetDebtType('credit')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          ğŸ’³ Credit Card
        </button>
        <button type="button" onclick="dpSetDebtType('student')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          ğŸ“ Student Loan
        </button>
        <button type="button" onclick="dpSetDebtType('mortgage')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          ğŸ  Mortgage
        </button>
        <button type="button" onclick="dpSetDebtType('car')"
                style="padding:10px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
          ğŸš— Car Loan
        </button>
      </div>
    </div>
  </div>

  <!-- Payoff Strategy -->
  <div style="margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <label style="color:var(--accent);font-weight:500;">ğŸ¯ Payoff Strategy</label>
      <span id="dp-strategy-indicator" style="font-size:0.85rem;color:#39ff14;font-weight:500;">Standard</span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:8px;">
      <button type="button" onclick="dpSetStrategy('standard')" 
              style="padding:12px;border-radius:8px;background:rgba(45,212,255,0.2);border:2px solid var(--accent);color:var(--accent);cursor:pointer;font-weight:500;">
        ğŸ“… Standard
      </button>
      <button type="button" onclick="dpSetStrategy('snowball')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        â„ï¸ Snowball
      </button>
      <button type="button" onclick="dpSetStrategy('avalanche')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        ğŸ”ï¸ Avalanche
      </button>
      <button type="button" onclick="dpSetStrategy('extra')"
              style="padding:12px;border-radius:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:inherit;cursor:pointer;">
        âš¡ Extra Payment
      </button>
    </div>
  </div>

  <!-- Extra Payment Controls (Hidden by Default) -->
  <div id="dp-extra-payment-section" style="display:none;margin-bottom:20px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.05);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <span style="color:var(--accent);font-weight:500;">ğŸ’ Extra Payment Strategy</span>
      <button onclick="dpApplyExtraPayment()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
        Apply
      </button>
    </div>
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;">
      <div>
        <label for="dp-extra-amount" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:0.9rem;">Extra Amount</label>
        <input id="dp-extra-amount" type="number" min="0" value="50" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;" />
      </div>
      <div>
        <label for="dp-extra-start" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:0.9rem;">Start Month</label>
        <input id="dp-extra-start" type="number" min="1" value="1" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;" />
      </div>
      <div>
        <label for="dp-extra-months" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:0.9rem;">For Months</label>
        <input id="dp-extra-months" type="number" min="1" value="12" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;" />
      </div>
    </div>
  </div>

  <!-- Quick Payment Suggestions -->
  <div style="margin-bottom:20px;">
    <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">ğŸš€ Quick Payment Suggestions:</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="dpSetPaymentPreset('minimum')" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">Minimum (1%)</button>
      <button type="button" onclick="dpSetPaymentPreset('recommended')" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Recommended (3%)</button>
      <button type="button" onclick="dpSetPaymentPreset('aggressive')" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">Aggressive (5%)</button>
      <button type="button" onclick="dpSetPaymentPreset('double')" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">Double Payment</button>
      <button type="button" onclick="dpSetPaymentPreset('triple')" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">Triple Payment</button>
      <button type="button" onclick="dpSetPaymentPreset('year')" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">Payoff in 1 Year</button>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;margin-top:20px;">
    <button type="button" onclick="dpCalculate(this)" 
            style="padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;transition:all 0.2s;">
      ğŸ§® Calculate
    </button>
    <button type="button" onclick="dpOptimizePayment()"
            style="padding:14px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ’¡ Optimize
    </button>
    <button type="button" onclick="dpCompareStrategies()"
            style="padding:14px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);color:#ffcc00;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ“Š Compare
    </button>
    <button type="button" onclick="dpReset(this)"
            style="padding:14px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;transition:all 0.2s;">
      ğŸ”„ Reset All
    </button>
  </div>
</form>

<!-- Results Display -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <!-- Main Results Card -->
  <div id="dp-results-section" style="display:none;background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:8px;padding:24px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 style="color:var(--accent);margin:0;font-size:1.1rem;">ğŸ“Š Payoff Summary</h3>
      <button onclick="dpCopyResults()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.9rem;">
        ğŸ“‹ Copy
      </button>
    </div>
    
    <!-- Key Metrics -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:16px;margin-bottom:20px;">
      <div style="text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">â±ï¸ Time to Payoff</div>
        <div id="dp-months" style="font-size:1.8rem;font-weight:700;color:#39ff14;">â€“</div>
        <div id="dp-years" style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;"></div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ’° Total Interest</div>
        <div id="dp-total-interest" style="font-size:1.8rem;font-weight:700;color:#ff2d55;">â€“</div>
        <div id="dp-interest-percent" style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;"></div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ¦ Total Payment</div>
        <div id="dp-total-payment" style="font-size:1.8rem;font-weight:700;color:#ffcc00;">â€“</div>
        <div id="dp-total-savings" style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;"></div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ’¸ Interest Saved</div>
        <div id="dp-interest-saved" style="font-size:1.4rem;font-weight:700;color:#9d4edd;">â€“</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">vs minimum payment</div>
      </div>
    </div>
    
    <!-- Payoff Timeline -->
    <div style="margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <span style="color:var(--accent);font-weight:500;">ğŸ“… Payoff Timeline</span>
        <span id="dp-timeline-summary" style="font-size:0.9rem;color:rgba(230,250,255,0.7);"></span>
      </div>
      <div style="height:12px;background:rgba(255,255,255,0.1);border-radius:6px;overflow:hidden;margin-bottom:8px;">
        <div id="dp-progress-bar" style="height:100%;background:linear-gradient(90deg, #2dd4ff, #39ff14);width:0%;transition:width 1s ease;"></div>
      </div>
      <div style="display:flex;justify-content:space-between;font-size:0.8rem;color:rgba(230,250,255,0.6);">
        <span>Today</span>
        <span id="dp-payoff-date">â€“</span>
      </div>
    </div>
    
    <!-- Detailed Breakdown -->
    <div id="dp-details" style="color:rgba(230,250,255,0.9);font-size:0.95rem;line-height:1.5;padding:12px;background:rgba(0,0,0,0.1);border-radius:6px;">
      Enter your debt details to see payoff calculations.
    </div>
  </div>

  <!-- Strategy Comparison -->
  <div id="dp-comparison-section" style="display:none;background:rgba(0,0,0,0.1);border-radius:8px;padding:20px;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:16px;font-size:1.1rem;">ğŸ“Š Strategy Comparison</h3>
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
        <thead>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
            <th style="text-align:left;padding:8px;color:var(--accent);">Strategy</th>
            <th style="text-align:right;padding:8px;color:var(--accent);">Months</th>
            <th style="text-align:right;padding:8px;color:var(--accent);">Total Interest</th>
            <th style="text-align:right;padding:8px;color:var(--accent);">Interest Saved</th>
            <th style="text-align:right;padding:8px;color:var(--accent);">Payoff Date</th>
          </tr>
        </thead>
        <tbody id="dp-comparison-body">
          <!-- Will be populated by JavaScript -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Debt Payoff Tips -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">ğŸ’¡ Debt Payoff Tips</h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:16px;">
      <div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:6px;">
        <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">ğŸ¯ Pay More Than Minimum</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Even small extra payments can significantly reduce payoff time</div>
      </div>
      <div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:6px;">
        <div style="color:#ffcc00;font-weight:600;margin-bottom:4px;">âš¡ Consider Balance Transfer</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">0% APR offers can help you pay down principal faster</div>
      </div>
      <div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:6px;">
        <div style="color:#9d4edd;font-weight:600;margin-bottom:4px;">ğŸ“ Create a Budget</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Track expenses to find extra money for debt payments</div>
      </div>
      <div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:6px;">
        <div style="color:#ff2d55;font-weight:600;margin-bottom:4px;">âš ï¸ Avoid New Debt</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);">Stop accumulating new debt while paying off existing debt</div>
      </div>
    </div>
    
    <!-- Monthly Payment Examples -->
    <div style="padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border-left:4px solid var(--accent);">
      <div style="color:var(--accent);font-weight:600;margin-bottom:8px;">ğŸ’¡ Quick Calculation Tip</div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.9);line-height:1.5;">
        To pay off a Â£5,000 debt in 3 years at 5% interest, you need approximately <strong>Â£150/month</strong>.<br>
        To pay it off in 1 year, you need approximately <strong>Â£430/month</strong>.
      </div>
    </div>
  </div>
</div>

<script>
/* debt-payoff-calculator.html - Enhanced version
   - Advanced debt payoff calculator
   - Scoped with dp- prefix
*/

let currentStrategy = 'standard';
let currentDebtType = 'personal';
let extraPayment = { amount: 50, start: 1, months: 12 };
let debtHistory = [];

// Sync sliders with number inputs
function dpSyncInputs() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Balance sync
  const balanceSlider = card.querySelector('#dp-balance');
  const balanceInput = card.querySelector('#dp-balance-input');
  const balanceDisplay = card.querySelector('#dp-balance-display');
  
  balanceSlider.addEventListener('input', function() {
    const value = parseInt(this.value);
    balanceInput.value = value;
    balanceDisplay.textContent = 'Â£' + value.toLocaleString();
    dpAutoCalculate();
  });
  
  balanceInput.addEventListener('input', function() {
    const value = Math.min(500000, Math.max(100, parseInt(this.value) || 100));
    balanceSlider.value = value;
    balanceDisplay.textContent = 'Â£' + value.toLocaleString();
    dpAutoCalculate();
  });
  
  // Rate sync
  const rateSlider = card.querySelector('#dp-rate');
  const rateInput = card.querySelector('#dp-rate-input');
  const rateDisplay = card.querySelector('#dp-rate-display');
  
  rateSlider.addEventListener('input', function() {
    const value = parseFloat(this.value);
    rateInput.value = value;
    rateDisplay.textContent = value + '%';
    dpAutoCalculate();
  });
  
  rateInput.addEventListener('input', function() {
    const value = Math.min(50, Math.max(0, parseFloat(this.value) || 0));
    rateSlider.value = value;
    rateDisplay.textContent = value + '%';
    dpAutoCalculate();
  });
  
  // Payment sync
  const paymentSlider = card.querySelector('#dp-payment');
  const paymentInput = card.querySelector('#dp-payment-input');
  const paymentDisplay = card.querySelector('#dp-payment-display');
  
  paymentSlider.addEventListener('input', function() {
    const value = parseInt(this.value);
    paymentInput.value = value;
    paymentDisplay.textContent = 'Â£' + value.toLocaleString();
    dpAutoCalculate();
  });
  
  paymentInput.addEventListener('input', function() {
    const value = Math.min(10000, Math.max(10, parseInt(this.value) || 10));
    paymentSlider.value = value;
    paymentDisplay.textContent = 'Â£' + value.toLocaleString();
    dpAutoCalculate();
  });
  
  // Initialize displays
  balanceDisplay.textContent = 'Â£' + balanceInput.value.toLocaleString();
  rateDisplay.textContent = rateInput.value + '%';
  paymentDisplay.textContent = 'Â£' + paymentInput.value.toLocaleString();
}

function dpSetDebtType(type) {
  const card = document.currentScript?.closest('.card') || document;
  currentDebtType = type;
  
  // Update debt type buttons
  card.querySelectorAll('[onclick*="dpSetDebtType"]').forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  const activeBtn = card.querySelector(`[onclick="dpSetDebtType('${type}')"]`);
  if (activeBtn) {
    activeBtn.style.background = 'rgba(45,212,255,0.2)';
    activeBtn.style.border = '2px solid var(--accent)';
    activeBtn.style.color = 'var(--accent)';
  }
  
  // Update type indicator
  const typeNames = {
    'personal': 'Personal Loan',
    'credit': 'Credit Card', 
    'student': 'Student Loan',
    'mortgage': 'Mortgage',
    'car': 'Car Loan'
  };
  card.querySelector('#dp-type-indicator').textContent = typeNames[type] || 'Custom Debt';
  
  // Set typical values for this debt type
  dpSetDebtDefaults(type);
}

function dpSetDebtDefaults(type) {
  const card = document.currentScript?.closest('.card') || document;
  
  const defaults = {
    'personal': { balance: 5000, rate: 7.5, payment: 200 },
    'credit': { balance: 3000, rate: 18.9, payment: 150 },
    'student': { balance: 25000, rate: 4.5, payment: 250 },
    'mortgage': { balance: 200000, rate: 3.2, payment: 1000 },
    'car': { balance: 15000, rate: 5.9, payment: 300 }
  };
  
  const defaultValues = defaults[type] || defaults.personal;
  
  // Update inputs
  card.querySelector('#dp-balance').value = defaultValues.balance;
  card.querySelector('#dp-balance-input').value = defaultValues.balance;
  card.querySelector('#dp-balance-display').textContent = 'Â£' + defaultValues.balance.toLocaleString();
  
  card.querySelector('#dp-rate').value = defaultValues.rate;
  card.querySelector('#dp-rate-input').value = defaultValues.rate;
  card.querySelector('#dp-rate-display').textContent = defaultValues.rate + '%';
  
  card.querySelector('#dp-payment').value = defaultValues.payment;
  card.querySelector('#dp-payment-input').value = defaultValues.payment;
  card.querySelector('#dp-payment-display').textContent = 'Â£' + defaultValues.payment.toLocaleString();
  
  // Auto-calculate
  dpAutoCalculate();
}

function dpSetStrategy(strategy) {
  const card = document.currentScript?.closest('.card') || document;
  currentStrategy = strategy;
  
  // Update strategy buttons
  card.querySelectorAll('[onclick*="dpSetStrategy"]').forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  const activeBtn = card.querySelector(`[onclick="dpSetStrategy('${strategy}')"]`);
  if (activeBtn) {
    activeBtn.style.background = 'rgba(45,212,255,0.2)';
    activeBtn.style.border = '2px solid var(--accent)';
    activeBtn.style.color = 'var(--accent)';
  }
  
  // Update strategy indicator
  const strategyNames = {
    'standard': 'Standard Payoff',
    'snowball': 'Snowball Method', 
    'avalanche': 'Avalanche Method',
    'extra': 'Extra Payment'
  };
  card.querySelector('#dp-strategy-indicator').textContent = strategyNames[strategy] || 'Custom Strategy';
  
  // Show/hide extra payment section
  const extraSection = card.querySelector('#dp-extra-payment-section');
  if (strategy === 'extra') {
    extraSection.style.display = 'block';
  } else {
    extraSection.style.display = 'none';
  }
  
  // Auto-calculate
  dpAutoCalculate();
}

function dpSetPaymentPreset(preset) {
  const card = document.currentScript?.closest('.card') || document;
  const balance = parseFloat(card.querySelector('#dp-balance-input').value) || 5000;
  const rate = parseFloat(card.querySelector('#dp-rate-input').value) / 100 || 0;
  const monthlyRate = rate / 12;
  
  let payment = 200; // default
  
  switch(preset) {
    case 'minimum':
      payment = Math.max(10, balance * 0.01); // 1% minimum
      break;
    case 'recommended':
      payment = Math.max(10, balance * 0.03); // 3% recommended
      break;
    case 'aggressive':
      payment = Math.max(10, balance * 0.05); // 5% aggressive
      break;
    case 'double':
      const current = parseFloat(card.querySelector('#dp-payment-input').value) || 200;
      payment = current * 2;
      break;
    case 'triple':
      const current2 = parseFloat(card.querySelector('#dp-payment-input').value) || 200;
      payment = current2 * 3;
      break;
    case 'year':
      // Calculate payment needed to pay off in 12 months
      const months = 12;
      if (rate === 0) {
        payment = balance / months;
      } else {
        payment = (balance * monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                 (Math.pow(1 + monthlyRate, months) - 1);
      }
      break;
  }
  
  payment = Math.round(payment);
  card.querySelector('#dp-payment-input').value = payment;
  card.querySelector('#dp-payment').value = payment;
  card.querySelector('#dp-payment-display').textContent = 'Â£' + payment.toLocaleString();
  
  // Highlight preset button
  card.querySelectorAll('[onclick*="dpSetPaymentPreset"]').forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = '#e6faff';
  });
  
  const presetBtn = card.querySelector(`[onclick="dpSetPaymentPreset('${preset}')"]`);
  if (presetBtn) {
    presetBtn.style.background = 'rgba(45,212,255,0.1)';
    presetBtn.style.border = '1px solid rgba(45,212,255,0.3)';
    presetBtn.style.color = 'var(--accent)';
  }
  
  // Auto-calculate
  dpAutoCalculate();
}

function dpApplyExtraPayment() {
  const card = document.currentScript?.closest('.card') || document;
  
  extraPayment.amount = parseFloat(card.querySelector('#dp-extra-amount').value) || 50;
  extraPayment.start = parseInt(card.querySelector('#dp-extra-start').value) || 1;
  extraPayment.months = parseInt(card.querySelector('#dp-extra-months').value) || 12;
  
  // Visual feedback
  const btn = card.querySelector('[onclick="dpApplyExtraPayment()"]');
  btn.textContent = 'âœ… Applied';
  btn.style.background = 'rgba(57,255,20,0.1)';
  btn.style.borderColor = 'rgba(57,255,20,0.3)';
  btn.style.color = '#39ff14';
  
  setTimeout(() => {
    btn.textContent = 'Apply';
    btn.style.background = 'rgba(45,212,255,0.1)';
    btn.style.borderColor = 'rgba(45,212,255,0.3)';
    btn.style.color = 'var(--accent)';
  }, 1500);
  
  // Auto-calculate
  dpAutoCalculate();
}

function dpCalculate(btn = null) {
  const card = document.currentScript?.closest('.card') || document;
  let balance = parseFloat(card.querySelector('#dp-balance-input').value) || 0;
  const rate = parseFloat(card.querySelector('#dp-rate-input').value) / 100 || 0;
  let payment = parseFloat(card.querySelector('#dp-payment-input').value) || 0;
  
  const monthlyRate = rate / 12;
  let months = 0;
  let totalInterest = 0;
  let totalPayment = 0;
  
  // Calculate minimum payment for comparison
  const minPayment = Math.max(10, balance * 0.01);
  let minMonths = 0;
  let minTotalInterest = 0;
  let minBalance = balance;
  
  // Calculate with minimum payment for comparison
  while (minBalance > 0 && minMonths < 600) {
    const interest = minBalance * monthlyRate;
    minTotalInterest += interest;
    minBalance = minBalance + interest - minPayment;
    minMonths++;
    if (minBalance <= 0) break;
  }
  
  // Visual feedback
  if (btn) {
    btn.innerHTML = 'â³ Calculating...';
    btn.disabled = true;
  }
  
  setTimeout(() => {
    // Check if payment is sufficient
    if (payment <= balance * monthlyRate) {
      card.querySelector('#dp-months').textContent = "Payment too low";
      card.querySelector('#dp-years').textContent = "";
      card.querySelector('#dp-total-interest').textContent = "â€“";
      card.querySelector('#dp-total-payment').textContent = "â€“";
      card.querySelector('#dp-interest-percent').textContent = "";
      card.querySelector('#dp-total-savings').textContent = "";
      card.querySelector('#dp-interest-saved').textContent = "â€“";
      card.querySelector('#dp-progress-bar').style.width = "0%";
      card.querySelector('#dp-timeline-summary').textContent = "Payment insufficient to cover interest";
      card.querySelector('#dp-payoff-date').textContent = "Never";
      card.querySelector('#dp-details').innerHTML = 
        "âš ï¸ Your monthly payment is less than the monthly interest (Â£" + 
        (balance * monthlyRate).toFixed(2) + "). Increase your payment to start paying down the debt.";
      
      // Hide results section
      card.querySelector('#dp-results-section').style.display = 'none';
      
      if (btn) {
        btn.innerHTML = 'âš ï¸ Insufficient';
        setTimeout(() => {
          btn.innerHTML = 'ğŸ§® Calculate';
          btn.disabled = false;
        }, 1000);
      }
      return;
    }
    
    // Show results section
    card.querySelector('#dp-results-section').style.display = 'block';
    
    // Calculate with current payment and strategy
    let calcBalance = balance;
    
    while (calcBalance > 0 && months < 600) {
      const interest = calcBalance * monthlyRate;
      totalInterest += interest;
      
      let thisPayment = payment;
      
      // Apply strategy adjustments
      if (currentStrategy === 'extra') {
        // Apply extra payment for specified period
        if (months >= extraPayment.start - 1 && months < extraPayment.start - 1 + extraPayment.months) {
          thisPayment += extraPayment.amount;
        }
      }
      
      // Ensure we don't overpay
      thisPayment = Math.min(thisPayment, calcBalance + interest);
      
      calcBalance = calcBalance + interest - thisPayment;
      totalPayment += thisPayment;
      months++;
      
      if (calcBalance <= 0) break;
    }
    
    // Format results
    const years = months / 12;
    const yearsText = years >= 1 ? `(${years.toFixed(1)} years)` : "";
    
    const interestPercent = (totalInterest / balance * 100).toFixed(1);
    const interestSaved = minTotalInterest - totalInterest;
    
    // Update displays
    card.querySelector('#dp-months').textContent = months + " months";
    card.querySelector('#dp-years').textContent = yearsText;
    card.querySelector('#dp-total-interest').textContent = "Â£" + totalInterest.toFixed(2);
    card.querySelector('#dp-total-payment').textContent = "Â£" + (balance + totalInterest).toFixed(2);
    card.querySelector('#dp-interest-percent').textContent = interestPercent + "% of debt";
    card.querySelector('#dp-total-savings').textContent = "Â£" + balance.toLocaleString() + " principal + interest";
    card.querySelector('#dp-interest-saved').textContent = "Â£" + interestSaved.toFixed(2);
    
    // Update progress visualization
    const progressPercent = Math.min(100, (months > 0 ? 10 : 0));
    card.querySelector('#dp-progress-bar').style.width = progressPercent + "%";
    card.querySelector('#dp-timeline-summary').textContent = 
      `Month 1 of ${months} (${progressPercent.toFixed(0)}%)`;
    
    // Calculate payoff date
    const today = new Date();
    const payoffDate = new Date(today);
    payoffDate.setMonth(payoffDate.getMonth() + months);
    const payoffDateStr = payoffDate.toLocaleDateString('en-GB', { 
      day: 'numeric', 
      month: 'short', 
      year: 'numeric' 
    });
    card.querySelector('#dp-payoff-date').textContent = payoffDateStr;
    
    // Generate detailed breakdown
    let details = `<strong>ğŸ“… Payoff Timeline:</strong><br>`;
    if (years >= 5) {
      details += `This debt will take ${years.toFixed(1)} years to pay off.<br>`;
    } else if (years >= 1) {
      details += `You'll be debt-free in about ${years.toFixed(1)} years.<br>`;
    } else {
      details += `You can pay this off in ${months} months!<br>`;
    }
    
    details += `<br><strong>ğŸ’° Payment Breakdown:</strong><br>`;
    details += `â€¢ Monthly payment: <strong>Â£${payment.toFixed(2)}</strong><br>`;
    details += `â€¢ Total interest paid: <strong>Â£${totalInterest.toFixed(2)}</strong><br>`;
    details += `â€¢ Total amount paid: <strong>Â£${(balance + totalInterest).toFixed(2)}</strong><br><br>`;
    
    details += `<strong>ğŸ¯ Tips to Pay Off Faster:</strong><br>`;
    if (payment < balance * 0.03) {
      details += `â€¢ Increase payment to 3% of balance (Â£${(balance * 0.03).toFixed(2)})<br>`;
    }
    if (rate > 0.1) {
      details += `â€¢ Consider a balance transfer to lower rate<br>`;
    }
    if (months > 24) {
      details += `â€¢ Add Â£${(payment * 0.1).toFixed(0)} extra per month to cut payoff time by ${Math.round(months * 0.2)} months<br>`;
    }
    
    card.querySelector('#dp-details').innerHTML = details;
    
    // Save to history
    dpSaveToHistory(balance, rate * 100, payment, months, totalInterest);
    
    // Reset button if clicked
    if (btn) {
      btn.innerHTML = 'âœ… Calculated';
      setTimeout(() => {
        btn.innerHTML = 'ğŸ§® Calculate';
        btn.disabled = false;
      }, 1000);
    }
  }, 300);
}

function dpAutoCalculate() {
  // Debounce auto-calculation
  clearTimeout(window.dpAutoCalcTimeout);
  window.dpAutoCalcTimeout = setTimeout(() => {
    const card = document.currentScript?.closest('.card') || document;
    const balance = parseFloat(card.querySelector('#dp-balance-input').value) || 0;
    if (balance > 0) {
      dpCalculate();
    }
  }, 500);
}

function dpOptimizePayment() {
  const card = document.currentScript?.closest('.card') || document;
  const balance = parseFloat(card.querySelector('#dp-balance-input').value) || 5000;
  const rate = parseFloat(card.querySelector('#dp-rate-input').value) / 100 || 0;
  
  // Calculate optimized payment (pay off in 3 years)
  const monthlyRate = rate / 12;
  const months = 36; // 3 years
  let optimizedPayment;
  
  if (rate === 0) {
    optimizedPayment = balance / months;
  } else {
    optimizedPayment = (balance * monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                      (Math.pow(1 + monthlyRate, months) - 1);
  }
  
  const roundedPayment = Math.ceil(optimizedPayment / 10) * 10; // Round up to nearest Â£10
  
  card.querySelector('#dp-payment-input').value = roundedPayment;
  card.querySelector('#dp-payment').value = roundedPayment;
  card.querySelector('#dp-payment-display').textContent = 'Â£' + roundedPayment.toLocaleString();
  
  // Visual feedback
  const btn = card.querySelector('[onclick="dpOptimizePayment()"]');
  btn.innerHTML = 'âœ… Optimized';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ’¡ Optimize';
  }, 1500);
  
  // Auto-calculate
  dpAutoCalculate();
}

function dpCompareStrategies() {
  const card = document.currentScript?.closest('.card') || document;
  const comparisonSection = card.querySelector('#dp-comparison-section');
  const comparisonBody = card.querySelector('#dp-comparison-body');
  
  if (comparisonSection.style.display === 'none') {
    // Show comparison and calculate
    comparisonSection.style.display = 'block';
    
    const balance = parseFloat(card.querySelector('#dp-balance-input').value) || 5000;
    const rate = parseFloat(card.querySelector('#dp-rate-input').value) / 100 || 0;
    const currentPayment = parseFloat(card.querySelector('#dp-payment-input').value) || 200;
    const monthlyRate = rate / 12;
    
    const strategies = [
      { name: 'Minimum Payment', payment: Math.max(10, balance * 0.01) },
      { name: 'Current Payment', payment: currentPayment },
      { name: '+Â£50 Extra', payment: currentPayment + 50 },
      { name: '+Â£100 Extra', payment: currentPayment + 100 },
      { name: 'Payoff in 1 Year', payment: rate === 0 ? balance / 12 : (balance * monthlyRate * Math.pow(1 + monthlyRate, 12)) / (Math.pow(1 + monthlyRate, 12) - 1) },
      { name: 'Payoff in 3 Years', payment: rate === 0 ? balance / 36 : (balance * monthlyRate * Math.pow(1 + monthlyRate, 36)) / (Math.pow(1 + monthlyRate, 36) - 1) }
    ];
    
    let html = '';
    const today = new Date();
    
    strategies.forEach((strategy, index) => {
      let months = 0;
      let calcBalance = balance;
      let totalInterest = 0;
      
      while (calcBalance > 0 && months < 600) {
        const interest = calcBalance * monthlyRate;
        totalInterest += interest;
        calcBalance = calcBalance + interest - strategy.payment;
        months++;
        if (calcBalance <= 0) break;
      }
      
      // Calculate payoff date
      const payoffDate = new Date(today);
      payoffDate.setMonth(payoffDate.getMonth() + months);
      const payoffDateStr = payoffDate.toLocaleDateString('en-GB', { 
        day: 'numeric', 
        month: 'short', 
        year: 'numeric' 
      });
      
      const interestSaved = strategies[0].totalInterest - totalInterest;
      
      html += `<tr style="border-bottom:1px solid rgba(255,255,255,0.05);${index === 1 ? 'background:rgba(45,212,255,0.05);' : ''}">`;
      html += `<td style="padding:8px;${index === 1 ? 'color:var(--accent);font-weight:600;' : ''}">${strategy.name}</td>`;
      html += `<td style="padding:8px;text-align:right;${index === 1 ? 'color:#39ff14;font-weight:600;' : ''}">${months} mo</td>`;
      html += `<td style="padding:8px;text-align:right;${index === 1 ? 'color:#ff2d55;font-weight:600;' : ''}">Â£${totalInterest.toFixed(2)}</td>`;
      html += `<td style="padding:8px;text-align:right;${index === 1 ? 'color:#9d4edd;font-weight:600;' : ''}">Â£${interestSaved.toFixed(2)}</td>`;
      html += `<td style="padding:8px;text-align:right;${index === 1 ? 'color:#ffcc00;font-weight:600;' : ''}">${payoffDateStr}</td>`;
      html += `</tr>`;
    });
    
    comparisonBody.innerHTML = html;
    
    // Update button
    const compareBtn = card.querySelector('[onclick="dpCompareStrategies()"]');
    compareBtn.innerHTML = 'ğŸ“Š Hide Comparison';
  } else {
    // Hide comparison
    comparisonSection.style.display = 'none';
    const compareBtn = card.querySelector('[onclick="dpCompareStrategies()"]');
    compareBtn.innerHTML = 'ğŸ“Š Compare';
  }
}

function dpSaveToHistory(balance, rate, payment, months, interest) {
  const entry = {
    date: new Date().toISOString(),
    balance: balance,
    rate: rate,
    payment: payment,
    months: months,
    interest: interest,
    type: currentDebtType
  };
  
  debtHistory.unshift(entry);
  if (debtHistory.length > 10) {
    debtHistory = debtHistory.slice(0, 10);
  }
  
  // Save to localStorage
  localStorage.setItem('dp-debt-history', JSON.stringify(debtHistory));
}

function dpCopyResults() {
  const card = document.currentScript?.closest('.card') || document;
  const months = card.querySelector('#dp-months').textContent;
  const interest = card.querySelector('#dp-total-interest').textContent;
  const total = card.querySelector('#dp-total-payment').textContent;
  const payoffDate = card.querySelector('#dp-payoff-date').textContent;
  
  const text = `ğŸ’° Debt Payoff Results:\nTime to Payoff: ${months}\nTotal Interest: ${interest}\nTotal Payment: ${total}\nPayoff Date: ${payoffDate}`;
  
  navigator.clipboard?.writeText(text).then(() => {
    const btn = card.querySelector('[onclick="dpCopyResults()"]');
    btn.innerHTML = 'âœ… Copied!';
    setTimeout(() => {
      btn.innerHTML = 'ğŸ“‹ Copy';
    }, 2000);
  });
}

function dpReset(btn) {
  const card = btn.closest('.card') || document;
  
  // Reset form inputs
  dpSetDebtDefaults('personal');
  
  // Reset strategy
  dpSetStrategy('standard');
  
  // Reset extra payments
  card.querySelector('#dp-extra-amount').value = 50;
  card.querySelector('#dp-extra-start').value = 1;
  card.querySelector('#dp-extra-months').value = 12;
  
  // Hide results and comparison sections
  card.querySelector('#dp-results-section').style.display = 'none';
  card.querySelector('#dp-comparison-section').style.display = 'none';
  
  // Reset comparison button
  const compareBtn = card.querySelector('[onclick="dpCompareStrategies()"]');
  compareBtn.innerHTML = 'ğŸ“Š Compare';
  
  // Visual feedback
  btn.innerHTML = 'âœ… Reset Complete';
  setTimeout(() => {
    btn.innerHTML = 'ğŸ”„ Reset All';
  }, 1000);
}

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    const card = document.currentScript?.closest('.card') || document;
    
    // Set up input synchronization
    dpSyncInputs();
    
    // Set default values
    dpSetDebtType('personal');
    dpSetStrategy('standard');
    
    // Load history from localStorage
    const savedHistory = localStorage.getItem('dp-debt-history');
    if (savedHistory) {
      debtHistory = JSON.parse(savedHistory);
    }
    
    // Auto-calculate on load
    setTimeout(() => dpCalculate(), 300);
    
    console.log('Enhanced Debt Payoff Calculator ready');
  });
} else {
  // Run immediately if already loaded
  const card = document.currentScript?.closest('.card') || document;
  if (card) {
    setTimeout(() => {
      dpSyncInputs();
      dpSetDebtType('personal');
      dpSetStrategy('standard');
      setTimeout(() => dpCalculate(), 300);
    }, 100);
  }
}
</script>

<style>
/* Debt Payoff specific styles */
#debt-payoff-calculator-title {
  color: var(--accent);
  margin-top: 0;
  position: relative;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(45,212,255,0.2);
}

/* Range slider styling */
input[type="range"] {
  height: 6px;
  border-radius: 3px;
  background: rgba(255,255,255,0.1);
  outline: none;
}

input[type="range"]::-webkit-slider-thumb {
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--accent);
  cursor: pointer;
  border: 2px solid rgba(255,255,255,0.2);
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}

/* Table styling */
table {
  background: rgba(255,255,255,0.02);
}

th, td {
  padding: 12px 8px;
}

tr:hover {
  background: rgba(255,255,255,0.03);
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .actions {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  [style*="grid-template-columns:repeat(auto-fit, minmax(140px, 1fr))"] {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  [style*="grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))"] {
    grid-template-columns: 1fr !important;
  }
  
  table {
    font-size: 0.8rem;
  }
}

/* Progress animation */
@keyframes progress-glow {
  0% { box-shadow: 0 0 5px rgba(45,212,255,0.5); }
  50% { box-shadow: 0 0 10px rgba(45,212,255,0.8); }
  100% { box-shadow: 0 0 5px rgba(45,212,255,0.5); }
}

#dp-progress-bar {
  animation: progress-glow 2s infinite;
}

/* Interactive elements */
button:hover {
  transform: translateY(-1px);
  transition: all 0.2s;
}
</style>
