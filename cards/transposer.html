<h2 id="transposer-title">üéµ Music Transposer</h2>

<form aria-describedby="transposer-desc">
  <p id="transposer-desc" class="small">
    Transpose chords, melodies, and entire progressions between keys.
    <span style="color:#ffcc00">‚ö†Ô∏è EDUCATIONAL TOOL ‚Äî Verify with music teacher or professional resources.</span>
  </p>
  
  <!-- Input Section -->
  <div class="field" style="margin-bottom:16px;">
    <label for="tp-input" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
      Chords / Notes (separated by commas)
    </label>
    <input id="tp-input" type="text" placeholder="e.g. C, F, G, Am, Dm7, E7" 
           style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-family:monospace;font-size:14px;" />
    <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-top:4px;">
      Enter chords like C, F#m, Bb7, or notes like C, E, G
    </div>
  </div>
  
  <!-- Transposition Controls -->
  <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:16px;margin-bottom:20px;">
    <!-- Original Key -->
    <div>
      <label for="tp-original-key" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Original Key
      </label>
      <select id="tp-original-key" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
        <option value="C" selected>C Major</option>
        <option value="G">G Major</option>
        <option value="D">D Major</option>
        <option value="A">A Major</option>
        <option value="E">E Major</option>
        <option value="B">B Major</option>
        <option value="F#">F# Major</option>
        <option value="Db">Db Major</option>
        <option value="Ab">Ab Major</option>
        <option value="Eb">Eb Major</option>
        <option value="Bb">Bb Major</option>
        <option value="F">F Major</option>
      </select>
    </div>
    
    <!-- Transposition Direction -->
    <div style="text-align:center;display:flex;flex-direction:column;justify-content:flex-end;gap:8px;">
      <button type="button" onclick="tpSetTransposition('up')" id="tp-direction-up"
              style="padding:8px 16px;background:rgba(45,212,255,0.2);border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
        ‚Üë Up
      </button>
      <button type="button" onclick="tpSetTransposition('down')" id="tp-direction-down"
              style="padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:#e6faff;cursor:pointer;">
        ‚Üì Down
      </button>
      <input id="tp-direction" type="hidden" value="up" />
    </div>
    
    <!-- Target Key -->
    <div>
      <label for="tp-target-key" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Target Key
      </label>
      <select id="tp-target-key" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
        <option value="C">C Major</option>
        <option value="D" selected>D Major</option>
        <option value="G">G Major</option>
        <option value="A">A Major</option>
        <option value="E">E Major</option>
        <option value="B">B Major</option>
        <option value="F#">F# Major</option>
        <option value="Db">Db Major</option>
        <option value="Ab">Ab Major</option>
        <option value="Eb">Eb Major</option>
        <option value="Bb">Bb Major</option>
        <option value="F">F Major</option>
      </select>
    </div>
  </div>
  
  <!-- Semitone Control -->
  <div style="margin-bottom:20px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">üéº Transpose by Semitones</div>
    <div style="display:flex;align-items:center;gap:12px;">
      <div style="display:flex;gap:4px;">
        <button type="button" onclick="tpAdjustSemitones(-1)" 
                style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:16px;">
          ‚àí
        </button>
        <input id="tp-semitones" type="number" min="-12" max="12" value="2" 
               style="width:80px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;text-align:center;font-size:16px;" />
        <button type="button" onclick="tpAdjustSemitones(1)" 
                style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:16px;">
          +
        </button>
      </div>
      <div style="color:rgba(230,250,255,0.8);font-size:13px;">
        <span id="tp-semitone-label">2 semitones up</span>
      </div>
      <div style="margin-left:auto;display:flex;gap:4px;">
        <button type="button" onclick="tpSetSemitones(0)" 
                style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">
          Reset to 0
        </button>
        <button type="button" onclick="tpSetSemitones(12)" 
                style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">
          Octave
        </button>
      </div>
    </div>
    <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-top:4px;">
      1 semitone = 1 fret on guitar, 1 key on piano
    </div>
  </div>
  
  <!-- Common Transpositions -->
  <div style="margin-bottom:20px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">üé∏ Common Transpositions</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
      <button type="button" onclick="tpLoadPreset('cToG')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">C ‚Üí G</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">+7 semitones (perfect 5th)</div>
      </button>
      <button type="button" onclick="tpLoadPreset('gToC')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">G ‚Üí C</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">-7 semitones (perfect 4th)</div>
      </button>
      <button type="button" onclick="tpLoadPreset('capo3')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">Capo 3rd Fret</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">+3 semitones</div>
      </button>
      <button type="button" onclick="tpLoadPreset('vocal')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">Vocal Range +2</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">+2 semitones (whole step)</div>
      </button>
    </div>
  </div>
  
  <!-- Chord Examples -->
  <div style="margin-bottom:20px;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">üé∂ Example Progressions</div>
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:8px;">
      <button type="button" onclick="tpLoadChordProgression('blues')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">12-Bar Blues</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">C7, F7, G7</div>
      </button>
      <button type="button" onclick="tpLoadChordProgression('pop')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">Pop Progression</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">C, G, Am, F</div>
      </button>
      <button type="button" onclick="tpLoadChordProgression('jazz')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">Jazz ii-V-I</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">Dm7, G7, CMaj7</div>
      </button>
      <button type="button" onclick="tpLoadChordProgression('rock')" 
              style="padding:8px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:13px;text-align:left;">
        <div style="font-weight:500;">Rock Power Chords</div>
        <div style="font-size:11px;color:rgba(230,250,255,0.7);">C5, F5, G5</div>
      </button>
    </div>
  </div>
  
  <!-- Actions -->
  <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
    <button type="button" onclick="tpTranspose()" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      üéπ Transpose Now
    </button>
    <button type="button" onclick="tpCopyResult()"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      üìã Copy
    </button>
    <button type="button" onclick="tpReset()"
            style="padding:12px 16px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;">
      üîÑ Reset
    </button>
  </div>
</form>

<!-- Results -->
<div class="results" aria-live="polite" style="margin-top:16px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:8px;">üéº Transposition Results</h3>
  
  <textarea id="tp-output" rows="10" 
            style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(0,0,0,0.2);color:inherit;font-family:monospace;font-size:14px;line-height:1.4;"></textarea>
  
  <!-- Visual Results -->
  <div id="tp-visual-results" style="display:none;margin-top:16px;">
    <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center;">
      <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);text-align:center;">
        <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Original</div>
        <div id="tp-original-display" style="font-weight:600;font-size:18px;color:#2dd4ff;">‚Äì</div>
      </div>
      <div style="text-align:center;color:var(--accent);font-size:20px;">‚Üí</div>
      <div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;border:1px solid rgba(57,255,20,0.2);text-align:center;">
        <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Transposed</div>
        <div id="tp-transposed-display" style="font-weight:600;font-size:18px;color:#39ff14;">‚Äì</div>
      </div>
    </div>
  </div>
  
  <!-- Music Theory Information -->
  <div style="margin-top:16px;padding:16px;background:rgba(255,255,255,0.03);border-radius:8px;border:1px solid rgba(255,255,255,0.06);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">üéµ Music Theory Notes</div>
    <div style="font-size:14px;line-height:1.5;">
      <div style="margin-bottom:8px;padding-left:12px;border-left:3px solid #2dd4ff;">
        <strong>Semitone Chart:</strong><br>
        C ‚Üí C# ‚Üí D ‚Üí D# ‚Üí E ‚Üí F ‚Üí F# ‚Üí G ‚Üí G# ‚Üí A ‚Üí A# ‚Üí B ‚Üí C
      </div>
      <ul style="list-style:disc;padding-left:20px;margin:8px 0;font-size:13px;color:rgba(230,250,255,0.9);">
        <li><strong>Semitone (half-step):</strong> Smallest interval in Western music</li>
        <li><strong>Whole tone (whole-step):</strong> 2 semitones (e.g., C to D)</li>
        <li><strong>Octave:</strong> 12 semitones - same note name, different pitch</li>
        <li><strong>Chord quality preserved:</strong> Maj, min, 7, etc. stay the same</li>
        <li><strong>Key signatures change:</strong> Adjust sharps/flats accordingly</li>
      </ul>
      <div style="margin-top:12px;padding:10px;background:rgba(255,204,0,0.1);border-radius:6px;border:1px solid rgba(255,204,0,0.3);">
        <strong style="color:#ffcc00;">‚ö†Ô∏è Important Disclaimer:</strong><br>
        <span style="font-size:12px;">This tool provides educational examples only. Always consult with a music teacher or professional resources for performance accuracy. Some chord voicings may need adjustment for playability on your instrument.</span>
      </div>
    </div>
  </div>
</div>

<script>
/* transposer.html
   - Music transposer with chord and note support
   - Scoped with tp- prefix (Transposer)
*/

// Music theory constants
const tpChromaticScale = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
const tpChordQualityMap = {
    'm': 'minor',
    'min': 'minor',
    'min7': 'minor seventh',
    'm7': 'minor seventh',
    'Maj7': 'major seventh',
    'M7': 'major seventh',
    '7': 'dominant seventh',
    'dim': 'diminished',
    'aug': 'augmented',
    'sus2': 'suspended second',
    'sus4': 'suspended fourth',
    '5': 'power chord'
};

// Initialize on load
function tpInitialize() {
    const card = document.currentScript?.closest('.card') || document;
    
    // Cache elements
    window.tpElements = {
        input: card.querySelector('#tp-input'),
        originalKey: card.querySelector('#tp-original-key'),
        targetKey: card.querySelector('#tp-target-key'),
        direction: card.querySelector('#tp-direction'),
        directionUp: card.querySelector('#tp-direction-up'),
        directionDown: card.querySelector('#tp-direction-down'),
        semitones: card.querySelector('#tp-semitones'),
        semitoneLabel: card.querySelector('#tp-semitone-label'),
        output: card.querySelector('#tp-output'),
        visualResults: card.querySelector('#tp-visual-results'),
        originalDisplay: card.querySelector('#tp-original-display'),
        transposedDisplay: card.querySelector('#tp-transposed-display')
    };
    
    // Load saved settings
    const savedSettings = localStorage.getItem('tp-settings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            if (settings.input) tpElements.input.value = settings.input;
            if (settings.originalKey) tpElements.originalKey.value = settings.originalKey;
            if (settings.targetKey) tpElements.targetKey.value = settings.targetKey;
            if (settings.direction) tpSetTransposition(settings.direction);
            if (settings.semitones) {
                tpElements.semitones.value = settings.semitones;
                tpUpdateSemitoneLabel();
            }
        } catch (e) {
            console.log('No saved settings found');
        }
    }
    
    // Auto-update when inputs change
    tpElements.input.addEventListener('input', tpSaveSettings);
    tpElements.originalKey.addEventListener('change', function() {
        tpUpdateKeyBasedTransposition();
        tpSaveSettings();
    });
    tpElements.targetKey.addEventListener('change', function() {
        tpUpdateKeyBasedTransposition();
        tpSaveSettings();
    });
    tpElements.semitones.addEventListener('input', function() {
        tpUpdateSemitoneLabel();
        tpUpdateKeyFromSemitones();
        tpSaveSettings();
    });
    
    // Initial updates
    tpUpdateSemitoneLabel();
    tpUpdateKeyBasedTransposition();
    
    console.log('Transposer initialized');
}

// Save settings to localStorage
function tpSaveSettings() {
    if (!window.tpElements) return;
    
    const settings = {
        input: tpElements.input.value,
        originalKey: tpElements.originalKey.value,
        targetKey: tpElements.targetKey.value,
        direction: tpElements.direction.value,
        semitones: tpElements.semitones.value,
        timestamp: new Date().toISOString()
    };
    
    localStorage.setItem('tp-settings', JSON.stringify(settings));
}

// Set transposition direction
function tpSetTransposition(direction) {
    if (!window.tpElements) tpInitialize();
    
    tpElements.direction.value = direction;
    
    if (direction === 'up') {
        tpElements.directionUp.style.background = 'rgba(45,212,255,0.2)';
        tpElements.directionUp.style.border = '1px solid rgba(45,212,255,0.4)';
        tpElements.directionUp.style.color = 'var(--accent)';
        tpElements.directionUp.style.fontWeight = '600';
        
        tpElements.directionDown.style.background = 'rgba(255,255,255,0.05)';
        tpElements.directionDown.style.border = '1px solid rgba(255,255,255,0.1)';
        tpElements.directionDown.style.color = '#e6faff';
        tpElements.directionDown.style.fontWeight = 'normal';
    } else {
        tpElements.directionDown.style.background = 'rgba(45,212,255,0.2)';
        tpElements.directionDown.style.border = '1px solid rgba(45,212,255,0.4)';
        tpElements.directionDown.style.color = 'var(--accent)';
        tpElements.directionDown.style.fontWeight = '600';
        
        tpElements.directionUp.style.background = 'rgba(255,255,255,0.05)';
        tpElements.directionUp.style.border = '1px solid rgba(255,255,255,0.1)';
        tpElements.directionUp.style.color = '#e6faff';
        tpElements.directionUp.style.fontWeight = 'normal';
    }
    
    tpUpdateSemitoneLabel();
    tpUpdateKeyBasedTransposition();
    tpSaveSettings();
}

// Adjust semitones
function tpAdjustSemitones(change) {
    if (!window.tpElements) tpInitialize();
    
    const current = parseInt(tpElements.semitones.value) || 0;
    let newValue = current + change;
    
    // Wrap around at +/- 12 (octave)
    if (newValue > 12) newValue = -12 + (newValue - 13);
    if (newValue < -12) newValue = 12 + (newValue + 13);
    
    tpElements.semitones.value = newValue;
    tpUpdateSemitoneLabel();
    tpUpdateKeyFromSemitones();
    tpSaveSettings();
}

// Set specific semitone value
function tpSetSemitones(value) {
    if (!window.tpElements) tpInitialize();
    
    tpElements.semitones.value = value;
    tpUpdateSemitoneLabel();
    tpUpdateKeyFromSemitones();
    tpSaveSettings();
}

// Update semitone label
function tpUpdateSemitoneLabel() {
    if (!window.tpElements) return;
    
    const semitones = parseInt(tpElements.semitones.value) || 0;
    const direction = semitones >= 0 ? 'up' : 'down';
    const absSemitones = Math.abs(semitones);
    
    let label = `${absSemitones} semitone${absSemitones !== 1 ? 's' : ''} ${direction}`;
    
    // Add interval names for common values
    const intervalNames = {
        1: 'minor 2nd',
        2: 'major 2nd',
        3: 'minor 3rd',
        4: 'major 3rd',
        5: 'perfect 4th',
        6: 'augmented 4th / diminished 5th',
        7: 'perfect 5th',
        8: 'minor 6th',
        9: 'major 6th',
        10: 'minor 7th',
        11: 'major 7th',
        12: 'octave'
    };
    
    if (intervalNames[absSemitones]) {
        label += ` (${intervalNames[absSemitones]})`;
    }
    
    tpElements.semitoneLabel.textContent = label;
}

// Update keys based on semitone transposition
function tpUpdateKeyFromSemitones() {
    if (!window.tpElements) return;
    
    const originalKey = tpElements.originalKey.value;
    const semitones = parseInt(tpElements.semitones.value) || 0;
    
    // Find original key index
    let originalIndex = tpChromaticScale.indexOf(originalKey.replace('b', '#'));
    if (originalIndex === -1) {
        // Handle flats
        const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
        originalIndex = tpChromaticScale.indexOf(flatToSharp[originalKey] || originalKey);
    }
    
    if (originalIndex !== -1) {
        const newIndex = (originalIndex + semitones + 12) % 12;
        const targetKey = tpChromaticScale[newIndex];
        
        // Convert back to flat notation for display if needed
        const sharpToFlat = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
        const displayKey = sharpToFlat[targetKey] || targetKey;
        
        // Update target key select
        const select = tpElements.targetKey;
        for (let option of select.options) {
            if (option.value === displayKey) {
                select.value = displayKey;
                break;
            }
        }
    }
}

// Update semitones based on key selection
function tpUpdateKeyBasedTransposition() {
    if (!window.tpElements) return;
    
    const originalKey = tpElements.originalKey.value;
    const targetKey = tpElements.targetKey.value;
    
    // Convert to sharp notation for calculation
    const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
    const originalSharp = flatToSharp[originalKey] || originalKey;
    const targetSharp = flatToSharp[targetKey] || targetKey;
    
    const originalIndex = tpChromaticScale.indexOf(originalSharp);
    const targetIndex = tpChromaticScale.indexOf(targetSharp);
    
    if (originalIndex !== -1 && targetIndex !== -1) {
        let semitones = targetIndex - originalIndex;
        if (semitones < 0) semitones += 12;
        
        // Determine direction based on shortest path
        const upDistance = semitones;
        const downDistance = 12 - semitones;
        
        if (downDistance < upDistance) {
            semitones = -(12 - semitones);
            tpSetTransposition('down');
        } else {
            tpSetTransposition('up');
        }
        
        tpElements.semitones.value = semitones;
        tpUpdateSemitoneLabel();
    }
}

// Load preset transposition
function tpLoadPreset(preset) {
    if (!window.tpElements) tpInitialize();
    
    const presets = {
        'cToG': { original: 'C', target: 'G', semitones: 7 },
        'gToC': { original: 'G', target: 'C', semitones: -7 },
        'capo3': { original: 'C', target: 'Eb', semitones: 3 },
        'vocal': { original: 'C', target: 'D', semitones: 2 }
    };
    
    const presetData = presets[preset];
    if (!presetData) return;
    
    tpElements.originalKey.value = presetData.original;
    tpElements.targetKey.value = presetData.target;
    tpElements.semitones.value = presetData.semitones;
    
    tpUpdateSemitoneLabel();
    tpSetTransposition(presetData.semitones >= 0 ? 'up' : 'down');
    tpSaveSettings();
}

// Load chord progression
function tpLoadChordProgression(type) {
    if (!window.tpElements) tpInitialize();
    
    const progressions = {
        'blues': 'C7, F7, C7, G7, F7, C7',
        'pop': 'C, G, Am, F, C, G, F, C',
        'jazz': 'Dm7, G7, CMaj7, Am7, Dm7, G7',
        'rock': 'C5, F5, C5, G5, F5, C5'
    };
    
    tpElements.input.value = progressions[type] || '';
    tpSaveSettings();
}

// Parse chord into root and quality
function tpParseChord(chord) {
    chord = chord.trim();
    if (!chord) return null;
    
    // Extract root note (can be 1-2 characters)
    let root = '';
    let quality = '';
    
    if (chord.length >= 2 && chord[1] === '#') {
        root = chord.substring(0, 2);
        quality = chord.substring(2);
    } else if (chord.length >= 2 && chord[1] === 'b') {
        root = chord.substring(0, 2);
        quality = chord.substring(2);
    } else {
        root = chord[0];
        quality = chord.substring(1);
    }
    
    return { root: root.toUpperCase(), quality: quality };
}

// Transpose a single chord
function tpTransposeChord(chord, semitones) {
    const parsed = tpParseChord(chord);
    if (!parsed) return chord;
    
    // Find root note index
    let rootIndex = tpChromaticScale.indexOf(parsed.root);
    if (rootIndex === -1) {
        // Handle flats
        const flatToSharp = { 'Db': 'C#', 'Eb': 'D#', 'Gb': 'F#', 'Ab': 'G#', 'Bb': 'A#' };
        rootIndex = tpChromaticScale.indexOf(flatToSharp[parsed.root] || parsed.root);
    }
    
    if (rootIndex === -1) return chord;
    
    // Calculate new root
    const newIndex = (rootIndex + semitones + 12) % 12;
    let newRoot = tpChromaticScale[newIndex];
    
    // Convert back to flat if original was flat
    if (parsed.root.includes('b')) {
        const sharpToFlat = { 'C#': 'Db', 'D#': 'Eb', 'F#': 'Gb', 'G#': 'Ab', 'A#': 'Bb' };
        newRoot = sharpToFlat[newRoot] || newRoot;
    }
    
    return newRoot + parsed.quality;
}

// Main transposition function
function tpTranspose() {
    if (!window.tpElements) tpInitialize();
    
    const input = tpElements.input.value.trim();
    const semitones = parseInt(tpElements.semitones.value) || 0;
    const originalKey = tpElements.originalKey.value;
    const targetKey = tpElements.targetKey.value;
    const direction = tpElements.direction.value;
    
    if (!input) {
        tpElements.output.value = 'Please enter chords or notes to transpose.';
        tpElements.visualResults.style.display = 'none';
        return;
    }
    
    // Split input by commas
    const items = input.split(',').map(item => item.trim()).filter(item => item);
    
    // Transpose each item
    const transposedItems = items.map(item => tpTransposeChord(item, semitones));
    
    // Format results
    const results = `üéµ MUSIC TRANSPOSITION\n`;
    results += `‚ïê`.repeat(40) + `\n\n`;
    results += `TRANSPOSITION DETAILS:\n`;
    results += `  ‚Ä¢ Original Key: ${originalKey} Major\n`;
    results += `  ‚Ä¢ Target Key: ${targetKey} Major\n`;
    results += `  ‚Ä¢ Semitones: ${semitones > 0 ? '+' : ''}${semitones} ${direction}\n`;
    results += `  ‚Ä¢ Interval: ${tpElements.semitoneLabel.textContent}\n\n`;
    
    results += `ORIGINAL CHORDS/NOTES:\n`;
    results += `  ${items.join(', ')}\n\n`;
    
    results += `TRANSPOSED CHORDS/NOTES:\n`;
    results += `  ${transposedItems.join(', ')}\n\n`;
    
    results += `üé∏ PRACTICAL TIPS:\n`;
    results += `  1. Check chord voicings for playability\n`;
    results += `  2. Consider using a capo for guitar (+${Math.abs(semitones)} fret${Math.abs(semitones) !== 1 ? 's' : ''})\n`;
    results += `  3. Adjust key signature accordingly\n`;
    results += `  4. Verify with your instrument\n`;
    results += `  5. Consult music teacher for accuracy`;
    
    tpElements.output.value = results;
    
    // Update visual display
    if (items.length <= 6) {
        tpElements.originalDisplay.textContent = items.join(' ');
        tpElements.transposedDisplay.textContent = transposedItems.join(' ');
        tpElements.visualResults.style.display = 'grid';
    } else {
        tpElements.visualResults.style.display = 'none';
    }
    
    tpSaveSettings();
}

// Copy results to clipboard
function tpCopyResult() {
    if (!window.tpElements) tpInitialize();
    
    const output = tpElements.output.value;
    if (!output.trim()) return;
    
    navigator.clipboard.writeText(output).then(() => {
        // Visual feedback
        const copyBtn = document.querySelector('button[onclick="tpCopyResult()"]');
        const originalText = copyBtn.textContent;
        copyBtn.textContent = '‚úÖ Copied!';
        copyBtn.style.background = 'rgba(57,255,20,0.1)';
        copyBtn.style.borderColor = 'rgba(57,255,20,0.3)';
        copyBtn.style.color = '#39ff14';
        
        setTimeout(() => {
            copyBtn.textContent = originalText;
            copyBtn.style.background = '';
            copyBtn.style.borderColor = '';
            copyBtn.style.color = '';
        }, 2000);
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

// Reset function
function tpReset() {
    if (!window.tpElements) tpInitialize();
    
    tpElements.input.value = '';
    tpElements.originalKey.value = 'C';
    tpElements.targetKey.value = 'D';
    tpSetTransposition('up');
    tpElements.semitones.value = '2';
    
    tpElements.output.value = '';
    tpElements.visualResults.style.display = 'none';
    
    tpUpdateSemitoneLabel();
    localStorage.removeItem('tp-settings');
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tpInitialize);
} else {
    tpInitialize();
}
</script>

<style>
/* Card-specific styles */
#transposer-title {
    color: var(--accent);
    margin-top: 0;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .key-selection {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    /* Center direction buttons on mobile */
    .key-selection > div:nth-child(2) {
        order: 3;
        display: flex;
        justify-content: center;
        gap: 12px;
    }
    
    /* Adjust button layout for mobile */
    .actions {
        flex-direction: column;
        gap: 8px !important;
    }
    
    .actions button {
        width: 100% !important;
        margin: 0 !important;
        min-height: 48px !important;
    }
    
    /* Make inputs more mobile-friendly */
    input[type="text"] {
        font-size: 16px !important;
    }
    
    /* Stack visual results on mobile */
    #tp-visual-results > div {
        grid-template-columns: 1fr !important;
        gap: 8px !important;
        text-align: center;
    }
    
    #tp-visual-results > div > div:nth-child(2) {
        display: none;
    }
}

/* Touch-friendly improvements */
button, input[type="button"], input[type="submit"] {
    min-height: 44px;
}

input[type="number"], input[type="text"], select {
    font-size: 16px; /* Prevent iOS zoom */
}

/* Focus styles for better accessibility */
input:focus, select:focus, button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

/* Animation for results */
@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-10px); }
    to { opacity: 1; transform: translateY(0); }
}

.results > div {
    animation: fadeIn 0.3s ease-out;
}

/* Smooth transitions */
button, input, select {
    transition: all 0.2s ease;
}

button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

/* Chord styling */
.chord {
    display: inline-block;
    padding: 2px 6px;
    margin: 0 2px;
    background: rgba(45,212,255,0.1);
    border-radius: 4px;
    font-weight: 500;
    color: var(--accent);
    border: 1px solid rgba(45,212,255,0.2);
}

/* Music note styling */
.music-note {
    display: inline-block;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-5px); }
}

/* Responsive typography */
@media (max-width: 480px) {
    #transposer-title {
        font-size: 1.2rem;
    }
    
    .small {
        font-size: 0.85rem;
    }
    
    .field label {
        font-size: 0.9rem;
    }
}
</style>
