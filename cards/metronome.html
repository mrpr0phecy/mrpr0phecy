<h2 id="metronome-title" style="margin-top:0;">üéµ Professional Metronome</h2>

<form aria-describedby="metronome-desc">
  <p id="metronome-desc" class="small">
    Precise audible & visual metronome with subdivisions, tap tempo, and tempo presets.
    <span style="color:#ff6b6b;font-weight:500;">‚ö†Ô∏è Enable sound in your browser</span>
  </p>

  <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
    <div class="field">
      <label for="metro-bpm">BPM (20-300)</label>
      <input id="metro-bpm" type="number" value="120" min="20" max="300" style="width:100%;" />
    </div>

    <div class="field">
      <label for="metro-timesig">Time Signature</label>
      <select id="metro-timesig" style="width:100%;">
        <option value="4,4" selected>4/4 (Common Time)</option>
        <option value="3,4">3/4 (Waltz)</option>
        <option value="6,8">6/8</option>
        <option value="2,4">2/4</option>
        <option value="5,4">5/4</option>
        <option value="7,8">7/8</option>
        <option value="12,8">12/8</option>
      </select>
    </div>
  </div>

  <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:12px;">
    <div class="field">
      <label for="metro-subdivision">Subdivision</label>
      <select id="metro-subdivision" style="width:100%;">
        <option value="1">Quarter Notes</option>
        <option value="2">Eighth Notes</option>
        <option value="3">Triplets</option>
        <option value="4">Sixteenth Notes</option>
        <option value="6">Sextuplets</option>
      </select>
    </div>

    <div class="field">
      <label for="metro-sound">Sound Type</label>
      <select id="metro-sound" style="width:100%;">
        <option value="click">Click</option>
        <option value="beep">Beep</option>
        <option value="wood">Wood Block</option>
        <option value="bell">Bell</option>
      </select>
    </div>
  </div>

  <div class="row" style="margin-top:12px;">
    <div class="field">
      <label for="metro-volume">Volume: <span id="volume-value">80</span>%</label>
      <input type="range" id="metro-volume" min="0" max="100" value="80" style="width:100%;" />
    </div>
  </div>

  <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
    <button type="button" onclick="startMetronome()" id="metro-start-btn">‚ñ∂Ô∏è Start</button>
    <button type="button" class="secondary" onclick="stopMetronome()" id="metro-stop-btn">‚èπÔ∏è Stop</button>
    <button type="button" onclick="tapTempo()" id="metro-tap-btn">üëÜ Tap Tempo</button>
  </div>
</form>

<div class="results" aria-live="polite" style="margin-top:12px;">
  <h3 class="small">Metronome Display</h3>
  
  <div id="metro-display" style="background:rgba(0,0,0,0.2);border-radius:12px;padding:20px;margin-bottom:12px;text-align:center;">
    <div style="font-size:48px;font-weight:bold;color:#4ecdc4;" id="metro-bpm-display">120</div>
    <div style="font-size:14px;color:rgba(230,250,255,0.7);margin-top:8px;" id="metro-tempo-name">Allegro</div>
    
    <div id="metro-beat-visualizer" style="display:flex;justify-content:center;gap:8px;margin:20px 0;height:80px;">
      <!-- Beat circles will be generated here -->
    </div>
    
    <div style="font-size:12px;color:rgba(230,250,255,0.5);" id="metro-beat-count">
      Beat: 0 | Bar: 0
    </div>
  </div>

  <div id="metro-presets" style="margin-top:12px;">
    <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:8px;">Tempo Presets:</div>
    <div style="display:flex;flex-wrap:wrap;gap:6px;">
      <button class="tempo-preset" onclick="setTempo(40)">40 Largo</button>
      <button class="tempo-preset" onclick="setTempo(60)">60 Adagio</button>
      <button class="tempo-preset" onclick="setTempo(72)">72 Andante</button>
      <button class="tempo-preset" onclick="setTempo(90)">90 Moderato</button>
      <button class="tempo-preset" onclick="setTempo(120)">120 Allegro</button>
      <button class="tempo-preset" onclick="setTempo(160)">160 Vivace</button>
      <button class="tempo-preset" onclick="setTempo(180)">180 Presto</button>
    </div>
  </div>

  <div id="metro-hint" class="small" style="opacity:0.9;color:#4ecdc4;margin-top:8px;text-align:center;"></div>
</div>

<style>
/* Metronome specific styles */
.metro-beat-circle {
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
  border: 2px solid rgba(255,255,255,0.2);
  transition: all 0.1s ease;
}

.metro-beat-circle.active {
  background: #4ecdc4;
  transform: scale(1.2);
  box-shadow: 0 0 20px rgba(78,205,196,0.5);
}

.metro-beat-circle.accent {
  background: #ff6b6b;
  transform: scale(1.3);
  box-shadow: 0 0 20px rgba(255,107,107,0.5);
}

.tempo-preset {
  padding: 6px 12px;
  background: rgba(66,153,225,0.1);
  border: 1px solid rgba(66,153,225,0.3);
  border-radius: 6px;
  color: #4299e1;
  font-size: 11px;
  cursor: pointer;
  transition: all 0.2s;
}

.tempo-preset:hover {
  background: rgba(66,153,225,0.2);
  transform: translateY(-1px);
}

.metro-running #metro-start-btn {
  background: #ff6b6b !important;
}

#metro-stop-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

#metro-tap-btn.tapping {
  background: #4ecdc4 !important;
  animation: tapPulse 0.5s ease;
}

@keyframes tapPulse {
  0% { transform: scale(1); }
  50% { transform: scale(0.95); }
  100% { transform: scale(1); }
}

.metro-flash {
  animation: flash 0.15s ease;
}

@keyframes flash {
  0% { opacity: 1; }
  50% { opacity: 0.5; }
  100% { opacity: 1; }
}

#metro-display {
  position: relative;
  overflow: hidden;
}

#metro-display::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 4px;
  background: linear-gradient(90deg, #4ecdc4, #4299e1, #ff6b6b);
}

.beat-line {
  position: absolute;
  bottom: 0;
  width: 2px;
  height: 20px;
  background: rgba(78,205,196,0.5);
  animation: beatLine 0.5s ease-out;
}

@keyframes beatLine {
  0% { height: 0; opacity: 1; }
  100% { height: 20px; opacity: 0; }
}
</style>

<script>
/* Professional Metronome - Complete Working Version */

let metronomeActive = false;
let audioContext = null;
let oscillator = null;
let gainNode = null;
let nextBeatTime = 0;
let beatInterval = 0;
let beatCount = 0;
let barCount = 0;
let beatsPerBar = 4;
let currentBPM = 120;
let tapTimes = [];
let animationFrame = null;
let beatCircles = [];

// Initialize
function initMetronome() {
  console.log("Metronome initializing...");
  
  // Set up event listeners
  document.getElementById('metro-bpm').addEventListener('input', updateBPM);
  document.getElementById('metro-volume').addEventListener('input', updateVolume);
  document.getElementById('metro-timesig').addEventListener('change', updateTimeSignature);
  document.getElementById('metro-subdivision').addEventListener('change', updateSubdivision);
  document.getElementById('metro-sound').addEventListener('change', updateSound);
  
  // Create beat visualizer
  createBeatVisualizer();
  
  // Initialize tempo name
  updateTempoName();
  
  // Set up tap tempo button
  document.getElementById('metro-tap-btn').addEventListener('click', tapTempo);
  
  // Initialize audio context on user interaction
  document.getElementById('metro-start-btn').addEventListener('click', initAudioContext);
  
  showMetroHint('Ready to start', 'info');
}

// Initialize audio context (must be triggered by user gesture)
function initAudioContext() {
  if (audioContext) return;
  
  try {
    audioContext = new (window.AudioContext || window.webkitAudioContext)();
    showMetroHint('Audio initialized', 'success');
  } catch (error) {
    console.error('Audio context failed:', error);
    showMetroHint('‚ö†Ô∏è Audio not supported - Visual only', 'warning');
  }
}

// Create beat visualizer circles
function createBeatVisualizer() {
  const visualizer = document.getElementById('metro-beat-visualizer');
  visualizer.innerHTML = '';
  beatCircles = [];
  
  // Create circles for each beat in the bar
  for (let i = 0; i < beatsPerBar; i++) {
    const circle = document.createElement('div');
    circle.className = 'metro-beat-circle';
    if (i === 0) circle.classList.add('accent');
    visualizer.appendChild(circle);
    beatCircles.push(circle);
  }
}

// Update BPM from input
function updateBPM() {
  let bpm = parseInt(this.value);
  if (isNaN(bpm)) bpm = 120;
  bpm = Math.max(20, Math.min(300, bpm));
  
  currentBPM = bpm;
  document.getElementById('metro-bpm-display').textContent = bpm;
  updateTempoName();
  
  if (metronomeActive) {
    stopMetronome();
    startMetronome();
  }
  
  showMetroHint(`BPM set to ${bpm}`, 'info');
}

// Update volume
function updateVolume() {
  const volume = this.value;
  document.getElementById('volume-value').textContent = volume;
  
  if (gainNode) {
    gainNode.gain.value = volume / 100;
  }
}

// Update time signature
function updateTimeSignature() {
  const parts = this.value.split(',');
  beatsPerBar = parseInt(parts[0]);
  
  createBeatVisualizer();
  
  if (metronomeActive) {
    stopMetronome();
    startMetronome();
  }
}

// Update subdivision
function updateSubdivision() {
  // Implementation would adjust beat timing
  if (metronomeActive) {
    stopMetronome();
    startMetronome();
  }
}

// Update sound type
function updateSound() {
  // Implementation would change oscillator type
  if (metronomeActive) {
    stopMetronome();
    startMetronome();
  }
}

// Update tempo name based on BPM
function updateTempoName() {
  const bpm = currentBPM;
  let tempoName = '';
  
  if (bpm < 40) tempoName = 'Grave (Very Slow)';
  else if (bpm < 60) tempoName = 'Largo (Broad)';
  else if (bpm < 72) tempoName = 'Adagio (Slow)';
  else if (bpm < 96) tempoName = 'Andante (Walking)';
  else if (bpm < 108) tempoName = 'Moderato (Moderate)';
  else if (bpm < 120) tempoName = 'Allegretto (Moderately Fast)';
  else if (bpm < 156) tempoName = 'Allegro (Fast)';
  else if (bpm < 176) tempoName = 'Vivace (Lively)';
  else if (bpm < 200) tempoName = 'Presto (Very Fast)';
  else tempoName = 'Prestissimo (Extremely Fast)';
  
  document.getElementById('metro-tempo-name').textContent = tempoName;
}

// Start metronome
function startMetronome() {
  if (metronomeActive) return;
  
  // Ensure audio context is initialized
  if (!audioContext) {
    initAudioContext();
  }
  
  if (!audioContext) {
    showMetroHint('‚ö†Ô∏è Audio not available - Using visual only', 'warning');
  }
  
  metronomeActive = true;
  beatCount = 0;
  barCount = 0;
  
  // Calculate beat interval in milliseconds
  beatInterval = (60 / currentBPM) * 1000;
  
  // Reset beat circles
  beatCircles.forEach(circle => {
    circle.classList.remove('active', 'accent');
  });
  if (beatCircles[0]) beatCircles[0].classList.add('accent');
  
  // Update UI
  document.getElementById('metro-start-btn').textContent = '‚è∏Ô∏è Pause';
  document.getElementById('metro-start-btn').classList.add('metro-running');
  document.getElementById('metro-stop-btn').disabled = false;
  
  // Start the beat
  nextBeatTime = performance.now();
  scheduleBeat();
  
  showMetroHint('Metronome started', 'success');
}

// Schedule next beat
function scheduleBeat() {
  if (!metronomeActive) return;
  
  const now = performance.now();
  
  // Schedule beats if we're behind
  while (nextBeatTime < now + 100) { // Look ahead 100ms
    const beatTime = nextBeatTime;
    
    // Schedule the beat
    setTimeout(() => {
      if (metronomeActive) {
        playBeat();
        updateBeatDisplay();
      }
    }, beatTime - now);
    
    // Calculate next beat time
    nextBeatTime += beatInterval;
  }
  
  // Continue scheduling
  animationFrame = requestAnimationFrame(scheduleBeat);
}

// Play beat sound
function playBeat() {
  if (!audioContext) return; // Visual only mode
  
  try {
    // Create oscillator for this beat
    oscillator = audioContext.createOscillator();
    gainNode = audioContext.createGain();
    
    // Configure sound based on settings
    const soundType = document.getElementById('metro-sound').value;
    let frequency = 800; // Default frequency
    let type = 'sine';
    
    switch(soundType) {
      case 'click':
        frequency = beatCount === 0 ? 1200 : 800;
        type = 'square';
        break;
      case 'beep':
        frequency = beatCount === 0 ? 1000 : 600;
        type = 'sine';
        break;
      case 'wood':
        frequency = beatCount === 0 ? 400 : 300;
        type = 'sawtooth';
        break;
      case 'bell':
        frequency = beatCount === 0 ? 2000 : 1500;
        type = 'sine';
        break;
    }
    
    // Configure oscillator
    oscillator.type = type;
    oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
    
    // Configure gain (volume envelope)
    const volume = document.getElementById('metro-volume').value / 100;
    gainNode.gain.setValueAtTime(0.001, audioContext.currentTime);
    gainNode.gain.exponentialRampToValueAtTime(volume * 0.3, audioContext.currentTime + 0.001);
    gainNode.gain.exponentialRampToValueAtTime(0.001, audioContext.currentTime + 0.05);
    
    // Connect and play
    oscillator.connect(gainNode);
    gainNode.connect(audioContext.destination);
    
    oscillator.start();
    oscillator.stop(audioContext.currentTime + 0.1);
    
  } catch (error) {
    console.warn('Audio play failed:', error);
    // Continue with visual beat only
  }
}

// Update beat display
function updateBeatDisplay() {
  // Update beat count
  beatCount = (beatCount % beatsPerBar) + 1;
  if (beatCount === 1) {
    barCount++;
  }
  
  // Update counter display
  document.getElementById('metro-beat-count').textContent = 
    `Beat: ${beatCount} | Bar: ${barCount}`;
  
  // Update visualizer
  beatCircles.forEach((circle, index) => {
    circle.classList.remove('active', 'accent');
    
    if (index === beatCount - 1) {
      circle.classList.add('active');
      if (beatCount === 1) {
        circle.classList.add('accent');
      }
    } else if (index === 0) {
      circle.classList.add('accent');
    }
  });
  
  // Flash the display for visual feedback
  document.getElementById('metro-display').classList.add('metro-flash');
  setTimeout(() => {
    document.getElementById('metro-display').classList.remove('metro-flash');
  }, 100);
}

// Stop metronome
function stopMetronome() {
  if (!metronomeActive) return;
  
  metronomeActive = false;
  
  // Stop audio
  if (oscillator) {
    try {
      oscillator.stop();
    } catch (e) {}
  }
  
  // Stop animation frame
  if (animationFrame) {
    cancelAnimationFrame(animationFrame);
    animationFrame = null;
  }
  
  // Reset UI
  document.getElementById('metro-start-btn').textContent = '‚ñ∂Ô∏è Start';
  document.getElementById('metro-start-btn').classList.remove('metro-running');
  document.getElementById('metro-stop-btn').disabled = true;
  
  // Reset beat circles
  beatCircles.forEach(circle => {
    circle.classList.remove('active');
  });
  
  showMetroHint('Metronome stopped', 'info');
}

// Tap tempo function
function tapTempo() {
  const tapBtn = document.getElementById('metro-tap-btn');
  const now = Date.now();
  
  // Add visual feedback
  tapBtn.classList.add('tapping');
  setTimeout(() => {
    tapBtn.classList.remove('tapping');
  }, 200);
  
  // Add this tap time
  tapTimes.push(now);
  
  // Keep only last 4 taps
  if (tapTimes.length > 4) {
    tapTimes.shift();
  }
  
  // Calculate BPM if we have at least 2 taps
  if (tapTimes.length >= 2) {
    const intervals = [];
    for (let i = 1; i < tapTimes.length; i++) {
      intervals.push(tapTimes[i] - tapTimes[i - 1]);
    }
    
    const avgInterval = intervals.reduce((a, b) => a + b) / intervals.length;
    const calculatedBPM = Math.round(60000 / avgInterval);
    
    // Limit to reasonable range
    const clampedBPM = Math.max(20, Math.min(300, calculatedBPM));
    
    // Update BPM
    currentBPM = clampedBPM;
    document.getElementById('metro-bpm').value = clampedBPM;
    document.getElementById('metro-bpm-display').textContent = clampedBPM;
    updateTempoName();
    
    // Restart metronome if running
    if (metronomeActive) {
      stopMetronome();
      startMetronome();
    }
    
    showMetroHint(`Tempo set to ${clampedBPM} BPM`, 'success');
  } else {
    showMetroHint(`Tap ${4 - tapTimes.length + 1} more times...`, 'info');
  }
  
  // Clear old taps after 2 seconds
  clearTimeout(tapTimeout);
  tapTimeout = setTimeout(() => {
    tapTimes = [];
  }, 2000);
}

// Set tempo from preset
function setTempo(bpm) {
  currentBPM = bpm;
  document.getElementById('metro-bpm').value = bpm;
  document.getElementById('metro-bpm-display').textContent = bpm;
  updateTempoName();
  
  if (metronomeActive) {
    stopMetronome();
    startMetronome();
  }
  
  showMetroHint(`Tempo set to ${bpm} BPM`, 'success');
}

// Show hint message
function showMetroHint(message, type = 'info') {
  const hint = document.getElementById('metro-hint');
  hint.textContent = message;
  hint.style.color = type === 'error' ? '#ff6b6b' : 
                     type === 'warning' ? '#ffd166' : 
                     type === 'success' ? '#4ecdc4' : 
                     '#4ecdc4';
  
  setTimeout(() => {
    if (hint.textContent === message) {
      hint.textContent = '';
    }
  }, 2000);
}

// Initialize on load
document.addEventListener('DOMContentLoaded', initMetronome);
</script>
