<h2 style="margin-top:0;">Professional Metronome</h2>

<div id="metronome-pro">
  <p class="small" style="opacity:0.8;margin-bottom:20px;">
    Precise audible & visual metronome with subdivisions and tap tempo.
  </p>

  <!-- Main Display -->
  <div style="text-align:center;margin:30px 0;">
    <div id="bpm-display" style="font-size:5.5rem;font-weight:900;letter-spacing:-3px;margin:10px 0;">
      120
    </div>
    <div id="tempo-name" style="font-size:1.4rem;opacity:0.75;height:30px;">Allegro</div>
  </div>

  <!-- Controls -->
  <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:20px;">
    <button id="decrease-bpm" class="ctrl-btn">−</button>
    <input type="number" id="bpm-input" value="120" min="20" max="300" style="text-align:center;font-size:1.5rem;padding:12px;"/>
    <button id="increase-bpm" class="ctrl-btn">+</button>
  </div>

  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
    <div class="field">
      <label>Time Signature</label>
      <select id="time-sig" style="width:100%;padding:10px;">
        <option value="4,4" selected>4/4</option>
        <option value="3,4">3/4</option>
        <option value="6,8">6/8</option>
        <option value="5,4">5/4</option>
        <option value="7,8">7/8</option>
        <option value="12,8">12/8</option>
      </select>
    </div>
    <div class="field">
      <label>Subdivision</label>
      <select id="subdivision" style="width:100%;padding:10px;">
        <option value="1">Quarter notes</option>
        <option value="2">Eighth notes</option>
        <option value="3">Eighth triplets</option>
        <option value="4">Sixteenth notes</option>
      </select>
    </div>
  </div>

  <!-- Action Buttons -->
  <div style="text-align:center;margin:20px 0;">
    <button id="tap-tempo-btn" style="padding:14px 28px;font-size:1.1rem;margin:0 8px;">
      Tap Tempo
    </button>
    <button id="start-stop-btn" style="padding:18px 40px;font-size:1.4rem;border-radius:50px;background:#00e676;color:#000;font-weight:bold;">
      START
    </button>
  </div>

  <!-- Volume & Visual Beat -->
  <div style="margin:20px 0;">
    <label>Volume <span id="volume-value">80%</span></label>
    <input type="range" id="volume" min="0" max="100" value="80" style="width:100%;"/>
  </div>

  <div id="beat-visualizer" style="display:flex;justify-content:center;gap:12px;margin:20px 0;">
      <!-- Dots generated by JS -->
    </div>

  <details style="margin-top:25px;font-size:0.9rem;">
    <summary>Tempo Reference Guide</summary>
    <ul style="margin:10px 0;padding-left:20px;opacity:0.8;line-height:1.7;">
      <li>40–60: Largo / Very slow</li>
      <li>60–76: Adagio / Slow</li>
      <li>76–108: Andante / Walking pace</li>
      <li>108–120: Moderato</li>
      <li>120–168: Allegro / Fast</li>
      <li>168–200: Presto / Very fast</li>
      <li>200+: Prestissimo</li>
    </ul>
  </details>
</div>

<style>
  #metronome-pro {
    max-width: 460px;
    margin: 0 auto;
    padding: 24px;
    border-radius: 20px;
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.12);
    backdrop-filter: blur(12px);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  }
  .ctrl-btn {
    font-size:2rem;padding:10px 20px;background:#333;color:white;border:none;border-radius:12px;
  }
  #start-stop-btn.running {background:#ff3b30 !important;color:white;}
  #beat-circle {
    width:80px;height:80px;border-radius:50%;background:#333;
    transition: all 0.15s; display:inline-block;
  }
  #beat-circle.accent {background:#00e676;transform:scale(1.3);box-shadow:0 0 30px #00e67688;}
  #beat-circle.normal {background:#888;transform:scale(1);}
  #tap-tempo-btn {background:#444;color:#fff;border:none;border-radius:12px;}
  #tap-tempo-btn.tapping {background:#00e676;transform:scale(0.95);}
</style>

<script>
/* PROFESSIONAL METRONOME v3.0 */
let audioCtx = null;
let isRunning = false;
let scheduler = null;
let nextBeatTime = 0;
let beatCount = 0;
let taps = [];
let tapTimeout;

const bpmDisplay = document.getElementById('bpm-display');
const tempoNameEl = document.getElementById('tempo-name');
const bpmInput = document.getElementById('bpm-input');
const startStopBtn = document.getElementById('start-stop-btn');
const tapTempoBtn = document.getElementById('tap-tempo-btn');
const volumeSlider = document.getElementById('volume');
const volumeValue = document.getElementById('volume-value');
const timeSigSelect = document.getElementById('time-sig');
const subdivSelect = document.getElementById('subdivision');
const visualizer = document.getElementById('beat-visualizer');

let bpm = 120;
let beatsPerBar = 4;
let beatUnit = 4;
let subdivision = 1;

function initAudio() {
  if (audioCtx) return;
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
}

function playSound(isAccent = false) {
  const osc = audioCtx.createOscillator();
  const amp = audioCtx.createGain();
  osc.connect(amp);
  amp.connect(audioCtx.destination);

  osc.frequency.value = isAccent ? 1200 : 800;
  osc.type = "square";
  amp.gain.setValueAtTime(0.001, audioCtx.currentTime);
  amp.gain.exponentialRampToValueAtTime(0.3 * (volumeSlider.value/100), audioCtx.currentTime + 0.001);
  amp.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime +}
