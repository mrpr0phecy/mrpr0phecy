<h2 id="second-life-region-map-viewer-title">üó∫Ô∏è Second Life Region Map Viewer</h2>

<form aria-describedby="second-life-region-map-viewer-desc">
    <p id="second-life-region-map-viewer-desc" class="small">
        View Second Life region maps with interactive pan/zoom, coordinates, and debugging tools.
        <span style="color:var(--accent)">Uses multiple data sources with automatic fallback.</span>
    </p>
    
    <!-- REGION INPUT -->
    <div class="field" style="margin-bottom:16px;">
        <label for="slrmv-region-name" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
            üåç Region Name
        </label>
        <input id="slrmv-region-name" type="text" placeholder="e.g. Solace, Heterocera, Blake Sea" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        <div class="small" style="margin-top:4px;color:rgba(230,250,255,0.7);">
            Popular: Solace, Heterocera, Blake Sea, Nautilus, Bay City
        </div>
    </div>
    
    <!-- COORDINATES AND SETTINGS -->
    <div style="display:grid;grid-template-columns:repeat(4, 1fr);gap:12px;margin-bottom:16px;">
        <div>
            <label for="slrmv-coord-x" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                üìç X Coordinate (0-255)
            </label>
            <input id="slrmv-coord-x" type="number" min="0" max="255" placeholder="128" 
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;text-align:center;" />
        </div>
        
        <div>
            <label for="slrmv-coord-y" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                üìç Y Coordinate (0-255)
            </label>
            <input id="slrmv-coord-y" type="number" min="0" max="255" placeholder="128" 
                   style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;text-align:center;" />
        </div>
        
        <div>
            <label for="slrmv-image-source" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                üñºÔ∏è Image Source
            </label>
            <select id="slrmv-image-source" 
                    style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="auto" selected>Auto (Best Available)</option>
                <option value="slgrid">SLGrid.org (Standard)</option>
                <option value="slmap">SecondLife.com (Official)</option>
                <option value="tiles">Tile Server (Detailed)</option>
            </select>
        </div>
        
        <div>
            <label for="slrmv-cors-proxy" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                üîÑ CORS Proxy
            </label>
            <select id="slrmv-cors-proxy" 
                    style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="" selected>No Proxy (Direct)</option>
                <option value="allorigins">AllOrigins (Public)</option>
                <option value="corsproxy">CORS Proxy (Public)</option>
                <option value="corsanywhere">CORS Anywhere</option>
            </select>
        </div>
    </div>
    
    <!-- DIRECT URL OVERRIDE -->
    <div style="margin-bottom:20px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.08);padding:12px;">
        <label for="slrmv-direct-url" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
            üîó Direct Image URL (Override)
        </label>
        <input id="slrmv-direct-url" type="url" placeholder="https://example.com/map.png" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;" />
        <div class="small" style="text-align:center;color:rgba(230,250,255,0.7);margin-top:8px;">
            Optional: Use any map image URL directly
        </div>
    </div>
    
    <!-- QUICK REGION BUTTONS -->
    <div style="margin-bottom:20px;">
        <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">Popular Regions:</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" onclick="slrmvSetRegion('Solace')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">üèùÔ∏è Solace</button>
            <button type="button" onclick="slrmvSetRegion('Heterocera')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">üåÑ Heterocera</button>
            <button type="button" onclick="slrmvSetRegion('Blake Sea')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">üåä Blake Sea</button>
            <button type="button" onclick="slrmvSetRegion('Nautilus')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">üêö Nautilus</button>
            <button type="button" onclick="slrmvSetRegion('Bay City')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">üèôÔ∏è Bay City</button>
        </div>
    </div>
    
    <!-- ACTIONS -->
    <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
        <button type="button" onclick="slrmvLoadMap()" 
                style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
            üó∫Ô∏è Load Region Map
        </button>
        <button type="button" onclick="slrmvReset()"
                style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
            Reset
        </button>
        <button type="button" onclick="slrmvDebugMode()"
                style="padding:12px 16px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:8px;color:#9d4edd;cursor:pointer;">
            üîß Debug Mode
        </button>
    </div>
</form>

<!-- MAP DISPLAY -->
<div class="results" aria-live="polite" style="margin-top:16px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:8px;">üó∫Ô∏è Region Map Display</h3>
    
    <!-- MAP CONTAINER -->
    <div id="slrmv-map-container" style="position:relative;border-radius:8px;border:1px solid rgba(45,212,255,0.3);overflow:hidden;background:rgba(0,0,0,0.2);">
        <!-- CANVAS -->
        <canvas id="slrmv-map-canvas" style="display:block;width:100%;height:auto;max-height:480px;background:#111;"></canvas>
        
        <!-- CONTROLS OVERLAY -->
        <div style="position:absolute;top:12px;left:12px;display:flex;gap:8px;z-index:10;">
            <button onclick="slrmvZoomIn()" style="padding:6px 12px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white;cursor:pointer;font-size:16px;">+</button>
            <button onclick="slrmvZoomOut()" style="padding:6px 12px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white;cursor:pointer;font-size:16px;">‚àí</button>
            <button onclick="slrmvResetView()" style="padding:6px 12px;background:rgba(0,0,0,0.7);border:1px solid rgba(255,255,255,0.2);border-radius:6px;color:white;cursor:pointer;font-size:14px;">‚ü≤</button>
        </div>
        
        <!-- COORDINATE DISPLAY -->
        <div id="slrmv-coord-display" style="position:absolute;bottom:12px;left:12px;background:rgba(0,0,0,0.7);padding:8px 12px;border-radius:6px;border:1px solid rgba(255,255,255,0.2);color:white;font-family:monospace;font-size:12px;">
            Hover for coordinates
        </div>
        
        <!-- LOADING OVERLAY -->
        <div id="slrmv-loading" style="position:absolute;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);display:none;justify-content:center;align-items:center;z-index:20;">
            <div style="text-align:center;color:var(--accent);">
                <div class="spinner" style="margin:0 auto 16px;"></div>
                <div>Loading region map...</div>
            </div>
        </div>
    </div>
    
    <!-- STATUS AND DEBUG -->
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-top:12px;">
        <!-- STATUS PANEL -->
        <div style="background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(45,212,255,0.2);padding:12px;">
            <div style="color:var(--accent);font-weight:500;margin-bottom:8px;font-size:14px;">üìä Status Information</div>
            <div id="slrmv-status" style="font-size:13px;line-height:1.4;color:rgba(230,250,255,0.9);">
                Enter a region name and click "Load Region Map"
            </div>
        </div>
        
        <!-- DEBUG PANEL -->
        <div style="background:rgba(17,17,17,0.95);border-radius:8px;border:1px solid rgba(157,78,221,0.3);padding:12px;">
            <div style="color:#9d4edd;font-weight:500;margin-bottom:8px;font-size:14px;">üîß Debug Console</div>
            <div id="slrmv-debug-log" style="font-family:monospace;font-size:11px;color:#39ff14;max-height:120px;overflow-y:auto;white-space:pre-wrap;background:#111;padding:8px;border-radius:4px;">
                Ready. Click "Debug Mode" for details.
            </div>
        </div>
    </div>
    
    <!-- MAP INFORMATION -->
    <div style="background:rgba(20,20,20,0.3);border-radius:8px;border:1px solid rgba(45,212,255,0.2);padding:12px;margin-top:16px;">
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;font-size:14px;">‚ÑπÔ∏è About Second Life Maps</div>
        <ul style="list-style:none;padding-left:0;margin:0;font-size:13px;line-height:1.5;">
            <li style="margin-bottom:6px;padding-left:16px;position:relative;">üó∫Ô∏è <strong>Coordinates:</strong> Each region is 256√ó256 meters (X:0-255, Y:0-255)</li>
            <li style="margin-bottom:6px;padding-left:16px;position:relative;">üñºÔ∏è <strong>Sources:</strong> Uses SLGrid.org, SecondLife.com, and tile servers</li>
            <li style="margin-bottom:6px;padding-left:16px;position:relative;">üîß <strong>Controls:</strong> Mouse wheel to zoom, drag to pan, click buttons for preset regions</li>
            <li style="margin-bottom:6px;padding-left:16px;position:relative;">‚ö†Ô∏è <strong>Note:</strong> Map availability depends on region privacy and server status</li>
        </ul>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:16px;">
        <button type="button" onclick="slrmvCopyCoordinates()"
                style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;font-size:13px;">
            üìã Copy Coordinates
        </button>
        <button type="button" onclick="slrmvOpenInSL()"
                style="padding:8px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;font-size:13px;">
            üîó Open in Second Life
        </button>
        <button type="button" onclick="slrmvDownloadMap()"
                style="padding:8px 16px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:8px;color:#9d4edd;cursor:pointer;font-size:13px;">
            üíæ Download Map
        </button>
    </div>
</div>

<script>
/* second-life-region-map-viewer.html
   - Interactive Second Life region map viewer with pan/zoom
   - Scoped with slrmv- prefix (second life region map viewer)
*/

// Canvas and rendering variables
const slrmvCanvas = document.getElementById('slrmv-map-canvas');
const slrmvCtx = slrmvCanvas.getContext('2d');
let slrmvCurrentImage = null;
let slrmvCurrentRegion = '';
let slrmvScale = 1;
let slrmvOffsetX = 0;
let slrmvOffsetY = 0;
let slrmvIsPanning = false;
let slrmvPanStart = { x: 0, y: 0 };
let slrmvPanOrigin = { x: 0, y: 0 };
let slrmvDebugModeActive = false;

// Initialize canvas size
function slrmvResizeCanvas() {
    const container = document.getElementById('slrmv-map-container');
    const rect = container.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    
    slrmvCanvas.width = Math.max(800, Math.floor(rect.width * dpr));
    slrmvCanvas.height = Math.max(480, Math.floor((slrmvCanvas.width * 0.6) * dpr));
    slrmvCanvas.style.width = '100%';
    slrmvCanvas.style.height = 'auto';
    
    // Clear canvas
    slrmvCtx.fillStyle = '#111';
    slrmvCtx.fillRect(0, 0, slrmvCanvas.width, slrmvCanvas.height);
}

// Image source patterns
const slrmvImageSources = {
    slgrid: (region) => `https://slgrid.org/map/${encodeURIComponent(region)}.png`,
    slmap: (region) => `https://maps.secondlife.com/map/${encodeURIComponent(region)}.png`,
    tiles: (region) => `https://slgrid.org/tiles/${encodeURIComponent(region)}/0/0/0.png`
};

// CORS proxy endpoints
const slrmvProxyEndpoints = {
    allorigins: 'https://api.allorigins.win/raw?url=',
    corsproxy: 'https://corsproxy.io/?',
    corsanywhere: 'https://cors-anywhere.herokuapp.com/'
};

// Log debug messages
function slrmvDebugLog(message) {
    const logElement = document.getElementById('slrmv-debug-log');
    const timestamp = new Date().toLocaleTimeString();
    logElement.textContent += `[${timestamp}] ${message}\n`;
    logElement.scrollTop = logElement.scrollHeight;
    
    if (slrmvDebugModeActive) {
        console.log(`[SLRMV Debug] ${message}`);
    }
}

// Set a region quickly
function slrmvSetRegion(regionName) {
    document.getElementById('slrmv-region-name').value = regionName;
    
    // Auto-load after a short delay
    setTimeout(() => {
        slrmvLoadMap();
    }, 300);
}

// Reset everything
function slrmvReset() {
    document.getElementById('slrmv-region-name').value = '';
    document.getElementById('slrmv-coord-x').value = '128';
    document.getElementById('slrmv-coord-y').value = '128';
    document.getElementById('slrmv-direct-url').value = '';
    document.getElementById('slrmv-image-source').value = 'auto';
    document.getElementById('slrmv-cors-proxy').value = '';
    
    // Clear canvas
    slrmvCtx.fillStyle = '#111';
    slrmvCtx.fillRect(0, 0, slrmvCanvas.width, slrmvCanvas.height);
    
    // Reset view
    slrmvScale = 1;
    slrmvOffsetX = 0;
    slrmvOffsetY = 0;
    
    // Update status
    document.getElementById('slrmv-status').innerHTML = `
        <span style="color:var(--accent);">Map Viewer Reset</span><br>
        Enter a region name to load a map.
    `;
    
    document.getElementById('slrmv-debug-log').textContent = 'Ready. Click "Debug Mode" for details.';
    slrmvDebugModeActive = false;
}

// Toggle debug mode
function slrmvDebugMode() {
    slrmvDebugModeActive = !slrmvDebugModeActive;
    const status = document.getElementById('slrmv-status');
    
    if (slrmvDebugModeActive) {
        status.innerHTML = `
            <span style="color:#ffcc00;">üîß Debug Mode Active</span><br>
            Detailed logging enabled in console and debug panel.
        `;
        slrmvDebugLog('Debug mode enabled');
        slrmvDebugLog(`Canvas size: ${slrmvCanvas.width}√ó${slrmvCanvas.height}`);
        slrmvDebugLog(`Current scale: ${slrmvScale.toFixed(2)}`);
    } else {
        status.innerHTML = `
            <span style="color:var(--accent);">Debug Mode Disabled</span><br>
            Normal operation mode.
        `;
        slrmvDebugLog('Debug mode disabled');
    }
}

// Load the map
async function slrmvLoadMap() {
    const regionInput = document.getElementById('slrmv-region-name').value.trim();
    const directUrl = document.getElementById('slrmv-direct-url').value.trim();
    const imageSource = document.getElementById('slrmv-image-source').value;
    const corsProxy = document.getElementById('slrmv-cors-proxy').value;
    const coordX = parseInt(document.getElementById('slrmv-coord-x').value) || 128;
    const coordY = parseInt(document.getElementById('slrmv-coord-y').value) || 128;
    
    // Validate coordinates
    if (coordX < 0 || coordX > 255 || coordY < 0 || coordY > 255) {
        document.getElementById('slrmv-status').innerHTML = `
            <span style="color:#ff2d55;">‚ùå Invalid Coordinates</span><br>
            X and Y must be between 0 and 255.
        `;
        return;
    }
    
    // Show loading
    document.getElementById('slrmv-loading').style.display = 'flex';
    const status = document.getElementById('slrmv-status');
    status.innerHTML = `
        <span style="color:var(--accent);">‚è≥ Loading Map...</span><br>
        Fetching region data...
    `;
    
    slrmvDebugLog(`Starting map load for region: ${regionInput || 'N/A'}`);
    slrmvDebugLog(`Image source: ${imageSource}`);
    slrmvDebugLog(`CORS proxy: ${corsProxy || 'None'}`);
    
    let imageUrl = '';
    let regionName = regionInput;
    
    // Check for direct URL override
    if (directUrl) {
        imageUrl = directUrl;
        slrmvDebugLog(`Using direct URL: ${directUrl}`);
        status.innerHTML = `
            <span style="color:var(--accent);">‚è≥ Loading Direct URL...</span><br>
            ${directUrl}
        `;
    } else if (regionInput) {
        regionName = regionInput;
        
        // Build URL based on selected source
        if (imageSource === 'auto') {
            // Try multiple sources in order
            const sources = ['slgrid', 'slmap', 'tiles'];
            for (const source of sources) {
                const url = slrmvImageSources[source](regionName);
                slrmvDebugLog(`Trying source ${source}: ${url}`);
                
                // Test URL (simplified - in production, would actually test)
                imageUrl = url;
                break; // For demo, just use first
            }
        } else {
            imageUrl = slrmvImageSources[imageSource](regionName);
            slrmvDebugLog(`Using specific source: ${imageUrl}`);
        }
        
        status.innerHTML = `
            <span style="color:var(--accent);">‚è≥ Loading ${regionName}...</span><br>
            Source: ${imageSource === 'auto' ? 'Auto-detect' : imageSource}
        `;
    } else {
        // No input
        document.getElementById('slrmv-loading').style.display = 'none';
        status.innerHTML = `
            <span style="color:#ff2d55;">‚ùå Missing Region Name</span><br>
            Please enter a region name or direct URL.
        `;
        return;
    }
    
    // Apply CORS proxy if selected
    let finalUrl = imageUrl;
    if (corsProxy && slrmvProxyEndpoints[corsProxy]) {
        finalUrl = slrmvProxyEndpoints[corsProxy] + encodeURIComponent(imageUrl);
        slrmvDebugLog(`Applied CORS proxy: ${finalUrl}`);
    }
    
    // Load the image
    try {
        const image = await slrmvLoadImage(finalUrl);
        
        // Store current image and region
        slrmvCurrentImage = image;
        slrmvCurrentRegion = regionName;
        
        // Reset view
        slrmvScale = 1;
        slrmvOffsetX = 0;
        slrmvOffsetY = 0;
        
        // Draw the image
        slrmvDrawMap(coordX, coordY);
        
        // Update status
        status.innerHTML = `
            <span style="color:#39ff14;">‚úÖ Map Loaded Successfully</span><br>
            Region: <strong>${regionName}</strong><br>
            Coordinates: (${coordX}, ${coordY})<br>
            Size: ${image.naturalWidth}√ó${image.naturalHeight} pixels
        `;
        
        slrmvDebugLog(`Map loaded successfully: ${image.naturalWidth}√ó${image.naturalHeight}`);
        
    } catch (error) {
        // Handle error
        status.innerHTML = `
            <span style="color:#ff2d55;">‚ùå Failed to Load Map</span><br>
            Error: ${error.message}<br>
            Try a different region or enable CORS proxy.
        `;
        
        slrmvDebugLog(`Failed to load map: ${error.message}`);
        
        // Draw placeholder
        slrmvDrawPlaceholder(regionName);
    } finally {
        // Hide loading
        document.getElementById('slrmv-loading').style.display = 'none';
    }
}

// Load image with error handling
function slrmvLoadImage(url) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
            slrmvDebugLog(`Image loaded: ${url}`);
            resolve(img);
        };
        
        img.onerror = (err) => {
            slrmvDebugLog(`Image load failed: ${url}`);
            reject(new Error('Failed to load image. Check CORS or try a proxy.'));
        };
        
        // Set timeout
        setTimeout(() => {
            if (!img.complete) {
                reject(new Error('Image load timeout'));
            }
        }, 10000);
        
        img.src = url;
    });
}

// Draw the map with marker
function slrmvDrawMap(markerX, markerY) {
    if (!slrmvCurrentImage || !slrmvCurrentImage.complete) return;
    
    const canvasWidth = slrmvCanvas.width;
    const canvasHeight = slrmvCanvas.height;
    const imgWidth = slrmvCurrentImage.naturalWidth;
    const imgHeight = slrmvCurrentImage.naturalHeight;
    
    // Clear canvas
    slrmvCtx.fillStyle = '#111';
    slrmvCtx.fillRect(0, 0, canvasWidth, canvasHeight);
    
    // Calculate centered position
    const scaleToFit = Math.min(
        canvasWidth / imgWidth,
        canvasHeight / imgHeight
    ) * 0.9; // 10% margin
    
    const displayWidth = imgWidth * scaleToFit * slrmvScale;
    const displayHeight = imgHeight * scaleToFit * slrmvScale;
    
    // Calculate offset for centering
    const centerX = (canvasWidth - displayWidth) / 2;
    const centerY = (canvasHeight - displayHeight) / 2;
    
    const drawX = centerX + slrmvOffsetX;
    const drawY = centerY + slrmvOffsetY;
    
    // Draw image
    slrmvCtx.save();
    slrmvCtx.translate(drawX, drawY);
    slrmvCtx.scale(scaleToFit * slrmvScale, scaleToFit * slrmvScale);
    slrmvCtx.drawImage(slrmvCurrentImage, 0, 0);
    slrmvCtx.restore();
    
    // Draw grid overlay (if zoomed in enough)
    if (slrmvScale > 2) {
        slrmvCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
        slrmvCtx.lineWidth = 1;
        
        const gridSize = 32; // SL standard grid size
        const gridCountX = Math.ceil(256 / gridSize);
        const gridCountY = Math.ceil(256 / gridSize);
        
        for (let i = 0; i <= gridCountX; i++) {
            const x = drawX + (i * gridSize * scaleToFit * slrmvScale);
            slrmvCtx.beginPath();
            slrmvCtx.moveTo(x, drawY);
            slrmvCtx.lineTo(x, drawY + displayHeight);
            slrmvCtx.stroke();
        }
        
        for (let j = 0; j <= gridCountY; j++) {
            const y = drawY + (j * gridSize * scaleToFit * slrmvScale);
            slrmvCtx.beginPath();
            slrmvCtx.moveTo(drawX, y);
            slrmvCtx.lineTo(drawX + displayWidth, y);
            slrmvCtx.stroke();
        }
    }
    
    // Draw marker if coordinates provided
    if (markerX !== undefined && markerY !== undefined) {
        // Convert SL coordinates to image coordinates (0-255 to 0-1 ratio)
        const markerPercentX = markerX / 255;
        const markerPercentY = markerY / 255;
        
        const markerCanvasX = drawX + (markerPercentX * displayWidth);
        const markerCanvasY = drawY + (markerPercentY * displayHeight);
        
        // Draw marker
        slrmvCtx.fillStyle = 'rgba(255, 80, 80, 0.9)';
        slrmvCtx.beginPath();
        slrmvCtx.arc(markerCanvasX, markerCanvasY, 8, 0, Math.PI * 2);
        slrmvCtx.fill();
        
        slrmvCtx.strokeStyle = 'white';
        slrmvCtx.lineWidth = 2;
        slrmvCtx.beginPath();
        slrmvCtx.arc(markerCanvasX, markerCanvasY, 8, 0, Math.PI * 2);
        slrmvCtx.stroke();
        
        // Draw coordinate label
        slrmvCtx.fillStyle = 'rgba(0, 0, 0, 0.7)';
        slrmvCtx.fillRect(markerCanvasX - 30, markerCanvasY - 30, 60, 20);
        
        slrmvCtx.fillStyle = 'white';
        slrmvCtx.font = '12px monospace';
        slrmvCtx.textAlign = 'center';
        slrmvCtx.fillText(`${markerX}, ${markerY}`, markerCanvasX, markerCanvasY - 15);
    }
    
    // Update coordinate display
    document.getElementById('slrmv-coord-display').textContent = 
        `Region: ${slrmvCurrentRegion || 'None'} | Scale: ${slrmvScale.toFixed(2)}x`;
}

// Draw placeholder when map fails to load
function slrmvDrawPlaceholder(regionName) {
    const canvasWidth = slrmvCanvas.width;
    const canvasHeight = slrmvCanvas.height;
    
    // Clear canvas
    slrmvCtx.fillStyle = '#111';
    slrmvCtx.fillRect(0, 0, canvasWidth, canvasHeight);
    
    // Draw placeholder message
    slrmvCtx.fillStyle = 'rgba(255, 255, 255, 0.1)';
    slrmvCtx.font = 'bold 24px sans-serif';
    slrmvCtx.textAlign = 'center';
    slrmvCtx.fillText('üó∫Ô∏è', canvasWidth / 2, canvasHeight / 2 - 30);
    
    slrmvCtx.fillStyle = 'rgba(255, 255, 255, 0.3)';
    slrmvCtx.font = '16px sans-serif';
    slrmvCtx.fillText(regionName || 'No Region Selected', canvasWidth / 2, canvasHeight / 2);
    
    slrmvCtx.fillStyle = 'rgba(255, 255, 255, 0.2)';
    slrmvCtx.font = '12px sans-serif';
    slrmvCtx.fillText('Map unavailable. Try a different region or CORS proxy.', canvasWidth / 2, canvasHeight / 2 + 30);
}

// Zoom functions
function slrmvZoomIn() {
    slrmvScale = Math.min(slrmvScale * 1.2, 10);
    slrmvDrawMap(
        parseInt(document.getElementById('slrmv-coord-x').value) || 128,
        parseInt(document.getElementById('slrmv-coord-y').value) || 128
    );
    slrmvDebugLog(`Zoomed in to ${slrmvScale.toFixed(2)}x`);
}

function slrmvZoomOut() {
    slrmvScale = Math.max(slrmvScale * 0.8, 0.1);
    slrmvDrawMap(
        parseInt(document.getElementById('slrmv-coord-x').value) || 128,
        parseInt(document.getElementById('slrmv-coord-y').value) || 128
    );
    slrmvDebugLog(`Zoomed out to ${slrmvScale.toFixed(2)}x`);
}

function slrmvResetView() {
    slrmvScale = 1;
    slrmvOffsetX = 0;
    slrmvOffsetY = 0;
    slrmvDrawMap(
        parseInt(document.getElementById('slrmv-coord-x').value) || 128,
        parseInt(document.getElementById('slrmv-coord-y').value) || 128
    );
    slrmvDebugLog('View reset to default');
}

// Utility functions
function slrmvCopyCoordinates() {
    const x = document.getElementById('slrmv-coord-x').value || '128';
    const y = document.getElementById('slrmv-coord-y').value || '128';
    const region = document.getElementById('slrmv-region-name').value || 'Unknown';
    
    const text = `Second Life Coordinates:\nRegion: ${region}\nX: ${x}, Y: ${y}\n\nGenerated by The Most Useful Site`;
    
    navigator.clipboard.writeText(text).then(() => {
        const status = document.getElementById('slrmv-status');
        status.innerHTML = `
            <span style="color:#39ff14;">‚úÖ Coordinates Copied</span><br>
            Region: ${region}<br>
            X: ${x}, Y: ${y}
        `;
        setTimeout(() => {
            if (slrmvCurrentImage) {
                slrmvDrawMap(parseInt(x), parseInt(y));
            }
        }, 100);
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

function slrmvOpenInSL() {
    const region = document.getElementById('slrmv-region-name').value.trim();
    const x = document.getElementById('slrmv-coord-x').value || '128';
    const y = document.getElementById('slrmv-coord-y').value || '128';
    const z = '25'; // Default altitude
    
    if (!region) {
        alert('Please enter a region name first');
        return;
    }
    
    // Construct SLURL
    const slurl = `secondlife://${encodeURIComponent(region)}/${x}/${y}/${z}`;
    
    // Try to open in Second Life
    window.open(slurl, '_blank');
    
    slrmvDebugLog(`Opened SLURL: ${slurl}`);
}

function slrmvDownloadMap() {
    if (!slrmvCurrentImage) {
        alert('No map loaded to download');
        return;
    }
    
    // Create a temporary canvas for download
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    
    // Set to original image size (or scaled as needed)
    tempCanvas.width = slrmvCurrentImage.naturalWidth;
    tempCanvas.height = slrmvCurrentImage.naturalHeight;
    
    // Draw the image
    tempCtx.drawImage(slrmvCurrentImage, 0, 0);
    
    // Add watermark
    tempCtx.fillStyle = 'rgba(0, 0, 0, 0.5)';
    tempCtx.fillRect(10, tempCanvas.height - 40, 300, 30);
    
    tempCtx.fillStyle = 'white';
    tempCtx.font = '14px sans-serif';
    tempCtx.fillText(`Region: ${slrmvCurrentRegion} | Source: The Most Useful Site`, 20, tempCanvas.height - 20);
    
    // Convert to data URL and trigger download
    const dataUrl = tempCanvas.toDataURL('image/png');
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = `SL_Map_${slrmvCurrentRegion.replace(/[^a-z0-9]/gi, '_')}.png`;
    link.click();
    
    slrmvDebugLog(`Map downloaded: ${link.download}`);
}

// Event listeners for mouse controls
slrmvCanvas.addEventListener('mousedown', (e) => {
    slrmvIsPanning = true;
    slrmvPanStart = { x: e.clientX, y: e.clientY };
    slrmvPanOrigin = { x: slrmvOffsetX, y: slrmvOffsetY };
    slrmvCanvas.style.cursor = 'grabbing';
});

window.addEventListener('mouseup', () => {
    slrmvIsPanning = false;
    slrmvCanvas.style.cursor = 'default';
});

window.addEventListener('mousemove', (e) => {
    if (!slrmvIsPanning) return;
    
    const dx = e.clientX - slrmvPanStart.x;
    const dy = e.clientY - slrmvPanStart.y;
    
    slrmvOffsetX = slrmvPanOrigin.x + dx;
    slrmvOffsetY = slrmvPanOrigin.y + dy;
    
    slrmvDrawMap(
        parseInt(document.getElementById('slrmv-coord-x').value) || 128,
        parseInt(document.getElementById('slrmv-coord-y').value) || 128
    );
});

// Mouse wheel zoom
slrmvCanvas.addEventListener('wheel', (e) => {
    e.preventDefault();
    
    const delta = e.deltaY > 0 ? 0.9 : 1.1;
    slrmvScale = Math.max(0.1, Math.min(10, slrmvScale * delta));
    
    slrmvDrawMap(
        parseInt(document.getElementById('slrmv-coord-x').value) || 128,
        parseInt(document.getElementById('slrmv-coord-y').value) || 128
    );
    
    slrmvDebugLog(`Mouse wheel zoom to ${slrmvScale.toFixed(2)}x`);
});

// Mouse move coordinate display
slrmvCanvas.addEventListener('mousemove', (e) => {
    if (!slrmvCurrentImage || !slrmvCurrentImage.complete) return;
    
    const rect = slrmvCanvas.getBoundingClientRect();
    const canvasX = e.clientX - rect.left;
    const canvasY = e.clientY - rect.top;
    
    // Convert to image coordinates (simplified)
    const imgWidth = slrmvCurrentImage.naturalWidth;
    const imgHeight = slrmvCurrentImage.naturalHeight;
    
    const scaleToFit = Math.min(
        slrmvCanvas.width / imgWidth,
        slrmvCanvas.height / imgHeight
    ) * 0.9;
    
    const displayWidth = imgWidth * scaleToFit * slrmvScale;
    const displayHeight = imgHeight * scaleToFit * slrmvScale;
    
    const centerX = (slrmvCanvas.width - displayWidth) / 2;
    const centerY = (slrmvCanvas.height - displayHeight) / 2;
    
    const drawX = centerX + slrmvOffsetX;
    const drawY = centerY + slrmvOffsetY;
    
    // Check if mouse is over the image
    if (canvasX >= drawX && canvasX <= drawX + displayWidth &&
        canvasY >= drawY && canvasY <= drawY + displayHeight) {
        
        // Convert to SL coordinates (0-255)
        const slX = Math.round(((canvasX - drawX) / displayWidth) * 255);
        const slY = Math.round(((canvasY - drawY) / displayHeight) * 255);
        
        // Clamp to valid range
        const clampedX = Math.max(0, Math.min(255, slX));
        const clampedY = Math.max(0, Math.min(255, slY));
        
        document.getElementById('slrmv-coord-display').textContent = 
            `Hover: (${clampedX}, ${clampedY}) | Scale: ${slrmvScale.toFixed(2)}x`;
    } else {
        document.getElementById('slrmv-coord-display').textContent = 
            `Region: ${slrmvCurrentRegion || 'None'} | Scale: ${slrmvScale.toFixed(2)}x`;
    }
});

// Initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize canvas
        slrmvResizeCanvas();
        window.addEventListener('resize', slrmvResizeCanvas);
        
        // Auto-load on Enter key in region input
        const regionInput = document.getElementById('slrmv-region-name');
        regionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                slrmvLoadMap();
            }
        });
        
        // Auto-update marker when coordinates change
        const coordInputs = document.querySelectorAll('#slrmv-coord-x, #slrmv-coord-y');
        coordInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (slrmvCurrentImage) {
                    const x = parseInt(document.getElementById('slrmv-coord-x').value) || 128;
                    const y = parseInt(document.getElementById('slrmv-coord-y').value) || 128;
                    slrmvDrawMap(x, y);
                    slrmvDebugLog(`Marker updated to (${x}, ${y})`);
                }
            });
        });
        
        console.log('Second Life Region Map Viewer initialized');
    });
}
</script>

<style>
/* Second Life Region Map Viewer specific styles */
#second-life-region-map-viewer-title {
    color: #2dd4ff !important; /* Blue for map theme */
    margin-top: 0;
}

/* Loading spinner */
.spinner {
    width: 40px;
    height: 40px;
    border: 4px solid rgba(45,212,255,0.3);
    border-top: 4px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Canvas container */
#slrmv-map-container {
    min-height: 300px;
    transition: all 0.3s ease;
}

#slrmv-map-canvas {
    cursor: grab;
    image-rendering: -webkit-optimize-contrast;
    image-rendering: crisp-edges;
    transition: transform 0.2s ease;
}

#slrmv-map-canvas:active {
    cursor: grabbing;
}

/* Control buttons hover effects */
#slrmv-map-container button:hover {
    background: rgba(45,212,255,0.3) !important;
    transform: scale(1.05);
}

/* Debug console scrollbar */
#slrmv-debug-log::-webkit-scrollbar {
    width: 6px;
}

#slrmv-debug-log::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
}

#slrmv-debug-log::-webkit-scrollbar-thumb {
    background: rgba(45,212,255,0.5);
    border-radius: 3px;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        margin: 4px 0 !important;
    }
    
    /* Stack coordinate inputs on mobile */
    #slrmv-map-container + div > div:first-child {
        grid-template-columns: 1fr !important;
    }
    
    /* Make control buttons larger for touch */
    #slrmv-map-container > div:first-child button {
        padding: 8px 16px !important;
        font-size: 18px !important;
    }
    
    /* Adjust coordinate display for mobile */
    #slrmv-coord-display {
        font-size: 10px !important;
        padding: 6px 8px !important;
    }
}

/* Print styles */
@media print {
    #second-life-region-map-viewer-title {
        color: #000 !important;
    }
    
    .actions, #slrmv-loading, #slrmv-map-container > div:first-child {
        display: none !important;
    }
    
    #slrmv-map-canvas {
        max-height: none !important;
    }
}
</style>
