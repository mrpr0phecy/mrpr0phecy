<!-- cards/team-productivity-hub.html -->
<div class="card-content">
<h2 id="productivity-title" style="margin-top:0;color:var(--accent);position:relative;">
  ğŸ¤– AI Team Productivity Hub
  <span style="position:absolute;right:0;top:0;font-size:0.7rem;color:rgba(45,212,255,0.7);font-weight:normal;">
    Collaboration & AI
  </span>
</h2>

<form aria-describedby="productivity-desc" style="margin-bottom:20px;">
  <p id="productivity-desc" class="small" style="color:rgba(230,250,255,0.8);margin-bottom:16px;">
    AI-powered team management with workload balancing, predictive analytics, and automated optimization.
    <span style="color:var(--accent);display:block;margin-top:4px;">
      âš¡ Smart suggestions â€¢ ğŸ¯ Predictive deadlines â€¢ ğŸ“Š Real-time analytics
    </span>
  </p>

  <!-- Smart Task Input -->
  <div style="background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.1);margin-bottom:16px;">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="team-member" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ‘¤ Team Member
        </label>
        <div style="position:relative;">
          <input id="team-member" type="text" placeholder="Start typing name..." 
                 style="width:100%;padding:10px 10px 10px 36px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;"
                 oninput="tpSuggestMembers()" />
          <span style="position:absolute;left:10px;top:10px;">ğŸ”</span>
          <div id="member-suggestions" style="display:none;position:absolute;top:100%;left:0;right:0;background:rgba(0,0,0,0.9);border:1px solid rgba(45,212,255,0.3);border-radius:8px;z-index:100;max-height:200px;overflow-y:auto;margin-top:2px;"></div>
        </div>
      </div>
      <div class="field">
        <label for="task-description" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ“‹ Task Description
        </label>
        <input id="task-description" type="text" placeholder="What needs to be done?" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
      </div>
    </div>

    <!-- AI Assistant Suggestion -->
    <div id="ai-suggestion" style="display:none;margin-bottom:12px;padding:10px;background:rgba(45,212,255,0.08);border-radius:6px;border-left:4px solid var(--accent);">
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="color:var(--accent);">ğŸ¤– AI Assistant</span>
        <button onclick="tpApplySuggestion()" style="margin-left:auto;font-size:11px;padding:2px 8px;background:rgba(45,212,255,0.2);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;">
          Apply
        </button>
      </div>
      <div id="ai-suggestion-text" style="font-size:0.9rem;color:rgba(230,250,255,0.9);"></div>
    </div>

    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="task-priority" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ¯ Priority Score
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input type="range" id="task-priority" min="1" max="10" value="5" 
                 style="flex:1;height:8px;border-radius:4px;background:rgba(45,212,255,0.1);outline:none;"
                 oninput="tpUpdatePriorityDisplay(this.value)">
          <span id="priority-display" style="min-width:60px;text-align:center;padding:4px 8px;border-radius:6px;background:rgba(255,165,0,0.2);color:#ffa500;font-size:12px;font-weight:600;">
            Medium (5)
          </span>
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;font-size:0.75rem;color:rgba(230,250,255,0.7);">
          <span>Low</span>
          <span>Critical</span>
        </div>
      </div>
      
      <div class="field">
        <label for="task-deadline" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ“… Smart Deadline
        </label>
        <input id="task-deadline" type="date" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        <div id="deadline-suggestion" style="font-size:0.75rem;color:rgba(230,250,255,0.7);margin-top:4px;"></div>
      </div>
      
      <div class="field">
        <label for="task-status" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ“Š Status & Progress
        </label>
        <select id="task-status" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="backlog">ğŸ“¥ Backlog</option>
          <option value="todo" selected>â³ To Do</option>
          <option value="inprogress">ğŸš§ In Progress</option>
          <option value="review">ğŸ‘€ Review</option>
          <option value="done">âœ… Done</option>
          <option value="blocked">ğŸš« Blocked</option>
        </select>
        <div style="margin-top:4px;">
          <input type="range" id="task-progress" min="0" max="100" value="0" 
                 style="width:100%;height:6px;border-radius:3px;background:rgba(45,212,255,0.1);outline:none;"
                 oninput="tpUpdateProgressDisplay(this.value)">
          <div id="progress-display" style="font-size:0.75rem;color:rgba(230,250,255,0.7);text-align:center;margin-top:2px;">0%</div>
        </div>
      </div>
    </div>
    
    <!-- Task Complexity & Tags -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field">
        <label for="task-complexity" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ§  Complexity
        </label>
        <select id="task-complexity" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="quick">âš¡ Quick (â‰¤ 1 hour)</option>
          <option value="simple" selected>âœ… Simple (1-4 hours)</option>
          <option value="moderate">ğŸ“ Moderate (4-8 hours)</option>
          <option value="complex">ğŸ§© Complex (1-2 days)</option>
          <option value="major">ğŸ—ï¸ Major (3-5 days)</option>
          <option value="epic">ğŸš€ Epic (1+ weeks)</option>
        </select>
      </div>
      
      <div class="field">
        <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          ğŸ·ï¸ Tags
        </label>
        <div style="display:flex;flex-wrap:wrap;gap:6px;padding:8px;background:rgba(255,255,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.2);">
          <div id="selected-tags" style="display:flex;flex-wrap:wrap;gap:4px;"></div>
          <input id="tag-input" type="text" placeholder="Add tag..." 
                 style="flex:1;min-width:80px;background:none;border:none;color:inherit;outline:none;"
                 onkeypress="tpAddTagOnEnter(event)">
        </div>
        <div style="display:flex;flex-wrap:wrap;gap:4px;margin-top:6px;">
          <button onclick="tpAddTag('design')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;">design</button>
          <button onclick="tpAddTag('bug')" style="padding:4px 8px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:4px;color:#ff4d4d;cursor:pointer;font-size:11px;">bug</button>
          <button onclick="tpAddTag('feature')" style="padding:4px 8px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:4px;color:#39ff14;cursor:pointer;font-size:11px;">feature</button>
          <button onclick="tpAddTag('research')" style="padding:4px 8px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:4px;color:#ffcc00;cursor:pointer;font-size:11px;">research</button>
          <button onclick="tpAddTag('meeting')" style="padding:4px 8px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:4px;color:#9d4edd;cursor:pointer;font-size:11px;">meeting</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="actions" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(140px, 1fr));gap:10px;">
    <button type="button" onclick="tpAddTask()" 
            style="padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      â• Add Smart Task
    </button>
    <button type="button" onclick="tpSmartAssign()"
            style="padding:12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;">
      ğŸ§  AI Assign
    </button>
    <button type="button" onclick="tpGenerateReport()"
            style="padding:12px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);color:#ffcc00;border-radius:8px;cursor:pointer;">
      ğŸ“Š Analytics
    </button>
    <button type="button" onclick="tpResetBoard()"
            style="padding:12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;">
      ğŸ”„ Reset
    </button>
  </div>
</form>

<!-- AI Dashboard -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <!-- Team Analytics -->
  <div id="analytics-section" style="display:none;background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(45,212,255,0.02));border-radius:8px;padding:24px;border:1px solid rgba(45,212,255,0.1);margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
      <h3 style="color:var(--accent);margin:0;font-size:1.1rem;">ğŸ“Š Team Performance Analytics</h3>
      <div style="display:flex;gap:8px;">
        <button onclick="tpSaveData()" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:0.9rem;">
          ğŸ’¾ Save
        </button>
        <button onclick="tpExportReport()" style="padding:6px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:0.9rem;">
          ğŸ“ˆ Export
        </button>
      </div>
    </div>
    
    <!-- Key Metrics -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:16px;margin-bottom:24px;">
      <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ† Team Velocity</div>
        <div id="metric-velocity" style="font-size:1.8rem;font-weight:700;color:#39ff14;">0</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Tasks/week</div>
      </div>
      
      <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">â±ï¸ Avg Completion</div>
        <div id="metric-completion" style="font-size:1.8rem;font-weight:700;color:#2dd4ff;">0 days</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Per task</div>
      </div>
      
      <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">âš–ï¸ Workload Balance</div>
        <div id="metric-balance" style="font-size:1.8rem;font-weight:700;color:#ffcc00;">100%</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Fairness score</div>
      </div>
      
      <div style="text-align:center;padding:16px;background:rgba(0,0,0,0.2);border-radius:8px;">
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:8px;">ğŸ¯ On-Time Rate</div>
        <div id="metric-ontime" style="font-size:1.8rem;font-weight:700;color:#9d4edd;">0%</div>
        <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-top:4px;">Deadlines met</div>
      </div>
    </div>
    
    <!-- Workload Distribution -->
    <div style="margin-bottom:24px;">
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">ğŸ‘¥ Workload Distribution</div>
      <div id="workload-chart" style="background:rgba(0,0,0,0.2);border-radius:8px;padding:16px;min-height:120px;">
        <!-- Workload bars will appear here -->
      </div>
    </div>
    
    <!-- AI Recommendations -->
    <div>
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">ğŸ’¡ AI Recommendations</div>
      <div id="ai-recommendations" style="background:rgba(0,0,0,0.2);border-radius:8px;padding:20px;">
        <!-- AI recommendations will appear here -->
      </div>
    </div>
  </div>

  <!-- Kanban Board -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);margin-bottom:20px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="color:var(--accent);margin:0;font-size:1.1rem;">ğŸ“‹ Smart Kanban Board</h3>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="task-count" style="font-size:12px;color:rgba(230,250,255,0.7);">0 tasks</span>
        <div style="display:flex;gap:6px;">
          <button onclick="tpFilterTasks('all')" id="filter-all" style="padding:6px 12px;background:var(--accent);color:#000;border:none;border-radius:6px;cursor:pointer;font-size:11px;font-weight:600;">
            All
          </button>
          <button onclick="tpFilterTasks('active')" id="filter-active" style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;font-size:11px;">
            Active
          </button>
          <button onclick="tpFilterTasks('overdue')" id="filter-overdue" style="padding:6px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;cursor:pointer;font-size:11px;">
            Overdue
          </button>
        </div>
      </div>
    </div>
    
    <!-- Kanban Columns -->
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;">
      <!-- Backlog Column -->
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="color:#9d4edd;">ğŸ“¥</span>
          <span style="color:rgba(230,250,255,0.9);font-weight:500;">Backlog</span>
          <span id="count-backlog" style="margin-left:auto;background:rgba(157,78,221,0.2);color:#9d4edd;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
        </div>
        <div id="column-backlog" style="min-height:60px;" ondrop="tpDrop(event)" ondragover="tpAllowDrop(event)">
          <!-- Backlog tasks will appear here -->
        </div>
      </div>
      
      <!-- To Do Column -->
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="color:#ffcc00;">â³</span>
          <span style="color:rgba(230,250,255,0.9);font-weight:500;">To Do</span>
          <span id="count-todo" style="margin-left:auto;background:rgba(255,204,0,0.2);color:#ffcc00;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
        </div>
        <div id="column-todo" style="min-height:60px;" ondrop="tpDrop(event)" ondragover="tpAllowDrop(event)">
          <!-- To Do tasks will appear here -->
        </div>
      </div>
      
      <!-- In Progress Column -->
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="color:#2dd4ff;">ğŸš§</span>
          <span style="color:rgba(230,250,255,0.9);font-weight:500;">In Progress</span>
          <span id="count-inprogress" style="margin-left:auto;background:rgba(45,212,255,0.2);color:#2dd4ff;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
        </div>
        <div id="column-inprogress" style="min-height:60px;" ondrop="tpDrop(event)" ondragover="tpAllowDrop(event)">
          <!-- In Progress tasks will appear here -->
        </div>
      </div>
      
      <!-- Review Column -->
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="color:#ffa500;">ğŸ‘€</span>
          <span style="color:rgba(230,250,255,0.9);font-weight:500;">Review</span>
          <span id="count-review" style="margin-left:auto;background:rgba(255,165,0,0.2);color:#ffa500;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
        </div>
        <div id="column-review" style="min-height:60px;" ondrop="tpDrop(event)" ondragover="tpAllowDrop(event)">
          <!-- Review tasks will appear here -->
        </div>
      </div>
      
      <!-- Done Column -->
      <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
          <span style="color:#39ff14;">âœ…</span>
          <span style="color:rgba(230,250,255,0.9);font-weight:500;">Done</span>
          <span id="count-done" style="margin-left:auto;background:rgba(57,255,20,0.2);color:#39ff14;padding:2px 8px;border-radius:10px;font-size:11px;">0</span>
        </div>
        <div id="column-done" style="min-height:60px;" ondrop="tpDrop(event)" ondragover="tpAllowDrop(event)">
          <!-- Done tasks will appear here -->
        </div>
      </div>
    </div>
    
    <!-- Burndown Chart -->
    <div style="margin-top:20px;background:rgba(0,0,0,0.2);border-radius:8px;padding:16px;">
      <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:12px;">ğŸ“ˆ Sprint Burndown</div>
      <canvas id="burndown-chart" width="400" height="150"></canvas>
    </div>
  </div>

  <!-- Team Performance -->
  <div style="background:rgba(0,0,0,0.1);border-radius:8px;padding:24px;border:1px solid rgba(255,255,255,0.05);">
    <h3 style="color:var(--accent);margin-top:0;margin-bottom:20px;font-size:1.1rem;">ğŸ‘‘ Team Performance Rankings</h3>
    
    <div style="overflow-x:auto;">
      <table style="width:100%;border-collapse:collapse;font-size:0.9rem;">
        <thead>
          <tr style="border-bottom:1px solid rgba(255,255,255,0.1);">
            <th style="text-align:left;padding:12px;color:var(--accent);">Team Member</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Tasks</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Completion %</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Avg Time</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Quality Score</th>
            <th style="text-align:center;padding:12px;color:var(--accent);">Workload</th>
            <th style="text-align:left;padding:12px;color:var(--accent);">Recommendations</th>
          </tr>
        </thead>
        <tbody id="performance-table">
          <!-- Performance rows will appear here -->
        </tbody>
      </table>
    </div>
    
    <!-- Productivity Tips -->
    <div style="margin-top:20px;display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
      <div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">
        <div style="color:#39ff14;font-weight:600;margin-bottom:6px;">ğŸ† Peak Performance</div>
        <div style="font-size:0.85rem;color:rgba(230,250,255,0.9);">Focus on 2-3 priority tasks daily for maximum productivity</div>
      </div>
      <div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">
        <div style="color:#ffcc00;font-weight:600;margin-bottom:6px;">âš–ï¸ Workload Balance</div>
        <div style="font-size:0.85rem;color:rgba(230,250,255,0.9);">Aim for 6-8 active tasks per team member for optimal flow</div>
      </div>
      <div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:8px;">
        <div style="color:#9d4edd;font-weight:600;margin-bottom:6px;">â±ï¸ Time Management</div>
        <div style="font-size:0.85rem;color:rgba(230,250,255,0.9);">Time-block complex tasks in morning when focus is highest</div>
      </div>
      <div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:8px;">
        <div style="color:#2dd4ff;font-weight:600;margin-bottom:6px;">ğŸ¤ Collaboration</div>
        <div style="font-size:0.85rem;color:rgba(230,250,255,0.9);">Daily 15-minute syncs prevent blockers and improve alignment</div>
      </div>
    </div>
  </div>
</div>

<script>
// AI Team Productivity Hub - Complete Implementation

// Data models
let tpTasks = [];
let tpTeamMembers = [];
let tpTags = [];
let tpCurrentFilter = 'all';
let tpDraggedTask = null;

// Complexity to hours mapping
const complexityHours = {
    quick: 1,
    simple: 2.5,
    moderate: 6,
    complex: 12,
    major: 32,
    epic: 40
};

// Priority score to label mapping
const priorityLabels = {
    1: { label: 'Trivial', color: '#2dd4ff' },
    2: { label: 'Very Low', color: '#2dd4ff' },
    3: { label: 'Low', color: '#2dd4ff' },
    4: { label: 'Low-Medium', color: '#ffcc00' },
    5: { label: 'Medium', color: '#ffcc00' },
    6: { label: 'Medium-High', color: '#ffa500' },
    7: { label: 'High', color: '#ffa500' },
    8: { label: 'Very High', color: '#ff2d55' },
    9: { label: 'Critical', color: '#ff2d55' },
    10: { label: 'Emergency', color: '#ff0066' }
};

// Initialize the hub
function tpInitialize() {
    console.log('Team Productivity Hub: Initializing...');
    
    // Load saved data
    tpLoadData();
    
    // Set default deadline to 3 days from now
    const defaultDeadline = new Date();
    defaultDeadline.setDate(defaultDeadline.getDate() + 3);
    document.getElementById('task-deadline').valueAsDate = defaultDeadline;
    
    // Initialize UI
    tpUpdatePriorityDisplay(5);
    tpUpdateProgressDisplay(0);
    tpUpdateDeadlineSuggestion();
    
    // Load sample team members if none exist
    if (tpTeamMembers.length === 0) {
        tpTeamMembers = [
            { name: 'Alex Chen', role: 'Frontend Dev', capacity: 8, specialties: ['design', 'react'] },
            { name: 'Sam Rivera', role: 'Backend Dev', capacity: 8, specialties: ['api', 'database'] },
            { name: 'Jordan Taylor', role: 'UX Designer', capacity: 6, specialties: ['design', 'research'] },
            { name: 'Casey Smith', role: 'QA Engineer', capacity: 6, specialties: ['testing', 'bug'] },
            { name: 'Morgan Lee', role: 'Project Manager', capacity: 4, specialties: ['planning', 'meeting'] }
        ];
    }
    
    // Load sample tasks if none exist
    if (tpTasks.length === 0) {
        tpAddSampleTasks();
    }
    
    // Render everything
    tpRenderTasks();
    tpUpdateAnalytics();
    tpRenderKanban();
    tpRenderPerformanceTable();
    
    // Set up event listeners
    tpSetupEventListeners();
    
    console.log('Team Productivity Hub: Ready with', tpTasks.length, 'tasks');
}

// Load data from localStorage
function tpLoadData() {
    try {
        const savedTasks = localStorage.getItem('tp-tasks');
        const savedMembers = localStorage.getItem('tp-members');
        
        if (savedTasks) tpTasks = JSON.parse(savedTasks);
        if (savedMembers) tpTeamMembers = JSON.parse(savedMembers);
    } catch (e) {
        console.error('Failed to load data:', e);
    }
}

// Save data to localStorage
function tpSaveData() {
    try {
        localStorage.setItem('tp-tasks', JSON.stringify(tpTasks));
        localStorage.setItem('tp-members', JSON.stringify(tpTeamMembers));
        
        const button = event.target;
        const originalText = button.textContent;
        button.textContent = 'âœ… Saved!';
        setTimeout(() => {
            button.textContent = originalText;
        }, 1000);
    } catch (e) {
        console.error('Failed to save data:', e);
    }
}

// Add sample tasks for demonstration
function tpAddSampleTasks() {
    const sampleTasks = [
        {
            id: Date.now() + 1,
            member: 'Alex Chen',
            task: 'Redesign dashboard UI',
            priority: 8,
            deadline: new Date(Date.now() + 5 * 86400000).toISOString().split('T')[0],
            status: 'inprogress',
            progress: 65,
            complexity: 'complex',
            tags: ['design', 'frontend'],
            createdAt: new Date(Date.now() - 2 * 86400000).toISOString(),
            estimatedHours: 12
        },
        {
            id: Date.now() + 2,
            member: 'Sam Rivera',
            task: 'Fix authentication bug',
            priority: 9,
            deadline: new Date(Date.now() + 1 * 86400000).toISOString().split('T')[0],
            status: 'todo',
            progress: 0,
            complexity: 'simple',
            tags: ['bug', 'backend'],
            createdAt: new Date(Date.now() - 1 * 86400000).toISOString(),
            estimatedHours: 2
        },
        {
            id: Date.now() + 3,
            member: 'Jordan Taylor',
            task: 'User research for new feature',
            priority: 6,
            deadline: new Date(Date.now() + 7 * 86400000).toISOString().split('T')[0],
            status: 'inprogress',
            progress: 40,
            complexity: 'moderate',
            tags: ['research', 'design'],
            createdAt: new Date(Date.now() - 3 * 86400000).toISOString(),
            estimatedHours: 6
        },
        {
            id: Date.now() + 4,
            member: 'Casey Smith',
            task: 'Test payment integration',
            priority: 7,
            deadline: new Date(Date.now() + 3 * 86400000).toISOString().split('T')[0],
            status: 'review',
            progress: 90,
            complexity: 'moderate',
            tags: ['testing', 'qa'],
            createdAt: new Date(Date.now() - 4 * 86400000).toISOString(),
            estimatedHours: 8
        },
        {
            id: Date.now() + 5,
            member: 'Morgan Lee',
            task: 'Plan Q4 roadmap',
            priority: 6,
            deadline: new Date(Date.now() + 14 * 86400000).toISOString().split('T')[0],
            status: 'todo',
            progress: 10,
            complexity: 'major',
            tags: ['planning', 'meeting'],
            createdAt: new Date(Date.now() - 1 * 86400000).toISOString(),
            estimatedHours: 32
        }
    ];
    
    tpTasks.push(...sampleTasks);
}

// Set up event listeners
function tpSetupEventListeners() {
    // Enter key to add task
    document.getElementById('task-description').addEventListener('keypress', (e) => {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            tpAddTask();
        }
    });
    
    // Auto-suggest deadline based on complexity
    document.getElementById('task-complexity').addEventListener('change', tpUpdateDeadlineSuggestion);
    
    // AI suggestion based on task description
    document.getElementById('task-description').addEventListener('input', tpGenerateAISuggestion);
}

// Update priority display
function tpUpdatePriorityDisplay(value) {
    const display = document.getElementById('priority-display');
    const priority = priorityLabels[value];
    display.textContent = `${priority.label} (${value})`;
    display.style.background = `${priority.color}20`;
    display.style.color = priority.color;
}

// Update progress display
function tpUpdateProgressDisplay(value) {
    document.getElementById('progress-display').textContent = `${value}%`;
}

// Update deadline suggestion based on complexity
function tpUpdateDeadlineSuggestion() {
    const complexity = document.getElementById('task-complexity').value;
    const estimatedDays = Math.ceil(complexityHours[complexity] / 8); // Convert hours to work days
    
    const deadline = new Date();
    deadline.setDate(deadline.getDate() + estimatedDays);
    
    const suggestion = document.getElementById('deadline-suggestion');
    suggestion.textContent = `Suggested: ${deadline.toLocaleDateString()} (${estimatedDays} day${estimatedDays !== 1 ? 's' : ''})`;
}

// Generate AI suggestion based on task description
function tpGenerateAISuggestion() {
    const task = document.getElementById('task-description').value.toLowerCase();
    const suggestionBox = document.getElementById('ai-suggestion');
    const suggestionText = document.getElementById('ai-suggestion-text');
    
    if (task.length < 3) {
        suggestionBox.style.display = 'none';
        return;
    }
    
    let suggestion = '';
    
    // Detect task type and suggest appropriate settings
    if (task.includes('bug') || task.includes('fix') || task.includes('error')) {
        suggestion = 'ğŸ”´ This appears to be a bug fix. Suggested: High priority (8), Simple complexity, tag: bug';
    } else if (task.includes('design') || task.includes('ui') || task.includes('ux')) {
        suggestion = 'ğŸ¨ This appears to be a design task. Suggested: Medium priority (6), Moderate complexity, tag: design';
    } else if (task.includes('research') || task.includes('study') || task.includes('analyze')) {
        suggestion = 'ğŸ” This appears to be research. Suggested: Medium priority (5), Moderate complexity, tag: research';
    } else if (task.includes('meeting') || task.includes('call') || task.includes('discuss')) {
        suggestion = 'ğŸ¤ This appears to be a meeting. Suggested: Low priority (4), Quick complexity, tag: meeting';
    } else if (task.includes('feature') || task.includes('new') || task.includes('add')) {
        suggestion = 'âœ¨ This appears to be a new feature. Suggested: High priority (7), Complex complexity, tag: feature';
    }
    
    if (suggestion) {
        suggestionText.textContent = suggestion;
        suggestionBox.style.display = 'block';
    } else {
        suggestionBox.style.display = 'none';
    }
}

// Apply AI suggestion
function tpApplySuggestion() {
    const suggestion = document.getElementById('ai-suggestion-text').textContent;
    
    if (suggestion.includes('High priority (8)')) {
        document.getElementById('task-priority').value = 8;
        tpUpdatePriorityDisplay(8);
    } else if (suggestion.includes('Medium priority (6)')) {
        document.getElementById('task-priority').value = 6;
        tpUpdatePriorityDisplay(6);
    }
    
    if (suggestion.includes('Simple complexity')) {
        document.getElementById('task-complexity').value = 'simple';
    } else if (suggestion.includes('Moderate complexity')) {
        document.getElementById('task-complexity').value = 'moderate';
    } else if (suggestion.includes('Complex complexity')) {
        document.getElementById('task-complexity').value = 'complex';
    }
    
    if (suggestion.includes('tag: bug')) tpAddTag('bug');
    if (suggestion.includes('tag: design')) tpAddTag('design');
    if (suggestion.includes('tag: research')) tpAddTag('research');
    if (suggestion.includes('tag: meeting')) tpAddTag('meeting');
    if (suggestion.includes('tag: feature')) tpAddTag('feature');
    
    tpUpdateDeadlineSuggestion();
}

// Add tag functionality
function tpAddTag(tag) {
    const tagsContainer = document.getElementById('selected-tags');
    const existingTags = Array.from(tagsContainer.querySelectorAll('.tag')).map(t => t.dataset.tag);
    
    if (!existingTags.includes(tag)) {
        const tagElement = document.createElement('span');
        tagElement.className = 'tag';
        tagElement.dataset.tag = tag;
        tagElement.innerHTML = `
            ${tag}
            <button onclick="tpRemoveTag('${tag}')" style="margin-left:4px;background:none;border:none;color:inherit;cursor:pointer;font-size:12px;">
                Ã—
            </button>
        `;
        tagElement.style.cssText = `
            display: inline-flex;
            align-items: center;
            padding: 2px 8px;
            background: ${tpGetTagColor(tag)};
            border-radius: 12px;
            font-size: 12px;
            color: white;
        `;
        tagsContainer.appendChild(tagElement);
    }
}

function tpRemoveTag(tag) {
    const tagElement = document.querySelector(`.tag[data-tag="${tag}"]`);
    if (tagElement) {
        tagElement.remove();
    }
}

function tpAddTagOnEnter(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const input = document.getElementById('tag-input');
        const tag = input.value.trim().toLowerCase();
        if (tag) {
            tpAddTag(tag);
            input.value = '';
        }
    }
}

function tpGetTagColor(tag) {
    const colors = {
        design: 'rgba(45,212,255,0.3)',
        bug: 'rgba(255,77,77,0.3)',
        feature: 'rgba(57,255,20,0.3)',
        research: 'rgba(255,204,0,0.3)',
        meeting: 'rgba(157,78,221,0.3)',
        frontend: 'rgba(0,123,255,0.3)',
        backend: 'rgba(40,167,69,0.3)',
        testing: 'rgba(111,66,193,0.3)',
        planning: 'rgba(253,126,20,0.3)'
    };
    return colors[tag] || 'rgba(255,255,255,0.2)';
}

// Add new task
function tpAddTask() {
    const member = document.getElementById('team-member').value.trim();
    const task = document.getElementById('task-description').value.trim();
    const priority = parseInt(document.getElementById('task-priority').value);
    const deadline = document.getElementById('task-deadline').value;
    const status = document.getElementById('task-status').value;
    const progress = parseInt(document.getElementById('task-progress').value);
    const complexity = document.getElementById('task-complexity').value;
    
    // Collect tags
    const tags = Array.from(document.querySelectorAll('.tag')).map(t => t.dataset.tag);
    
    if (!member || !task) {
        if (!member) {
            document.getElementById('team-member').style.borderColor = '#ff2d55';
            setTimeout(() => document.getElementById('team-member').style.borderColor = '', 1000);
        }
        if (!task) {
            document.getElementById('task-description').style.borderColor = '#ff2d55';
            setTimeout(() => document.getElementById('task-description').style.borderColor = '', 1000);
        }
        return;
    }
    
    // Add member to team if new
    if (!tpTeamMembers.some(m => m.name === member)) {
        tpTeamMembers.push({
            name: member,
            role: 'Team Member',
            capacity: 8,
            specialties: []
        });
    }
    
    const newTask = {
        id: Date.now() + Math.random().toString(36).substr(2, 9),
        member,
        task,
        priority,
        deadline,
        status,
        progress,
        complexity,
        tags,
        createdAt: new Date().toISOString(),
        startedAt: status !== 'backlog' && status !== 'todo' ? new Date().toISOString() : null,
        completedAt: status === 'done' ? new Date().toISOString() : null,
        estimatedHours: complexityHours[complexity]
    };
    
    tpTasks.unshift(newTask);
    tpSaveData();
    tpRenderTasks();
    tpUpdateAnalytics();
    tpRenderKanban();
    tpRenderPerformanceTable();
    
    // Reset form
    document.getElementById('team-member').value = '';
    document.getElementById('task-description').value = '';
    document.getElementById('task-priority').value = 5;
    tpUpdatePriorityDisplay(5);
    document.getElementById('task-progress').value = 0;
    tpUpdateProgressDisplay(0);
    document.getElementById('task-complexity').value = 'simple';
    document.getElementById('selected-tags').innerHTML = '';
    document.getElementById('ai-suggestion').style.display = 'none';
    
    // Set new deadline
    tpUpdateDeadlineSuggestion();
    
    document.getElementById('team-member').focus();
}

// Smart task assignment
function tpSmartAssign() {
    const unassignedTasks = tpTasks.filter(t => !t.member || t.member === '');
    if (unassignedTasks.length === 0) {
        alert('All tasks are already assigned!');
        return;
    }
    
    // Simple AI assignment logic
    unassignedTasks.forEach(task => {
        // Find member with least workload matching task tags
        let bestMember = null;
        let lowestWorkload = Infinity;
        
        tpTeamMembers.forEach(member => {
            const memberTasks = tpTasks.filter(t => t.member === member.name && t.status !== 'done');
            const workload = memberTasks.reduce((sum, t) => sum + (t.estimatedHours || 0), 0);
            
            // Bonus if member has matching specialties
            const matchScore = task.tags?.filter(tag => member.specialties?.includes(tag)).length || 0;
            const adjustedWorkload = workload - (matchScore * 2); // Reduce workload score for good matches
            
            if (adjustedWorkload < lowestWorkload && workload < member.capacity) {
                lowestWorkload = adjustedWorkload;
                bestMember = member;
            }
        });
        
        if (bestMember) {
            task.member = bestMember.name;
        }
    });
    
    tpSaveData();
    tpRenderTasks();
    tpRenderKanban();
    tpRenderPerformanceTable();
    alert(`Assigned ${unassignedTasks.length} tasks using AI optimization!`);
}

// Generate analytics report
function tpGenerateReport() {
    document.getElementById('analytics-section').style.display = 'block';
    tpUpdateAnalytics();
    
    // Smooth scroll to analytics
    document.getElementById('analytics-section').scrollIntoView({ 
        behavior: 'smooth', 
        block: 'nearest' 
    });
}

// Update analytics
function tpUpdateAnalytics() {
    const totalTasks = tpTasks.length;
    const doneTasks = tpTasks.filter(t => t.status === 'done').length;
    const activeTasks = tpTasks.filter(t => t.status !== 'done' && t.status !== 'backlog').length;
    
    // Team velocity (tasks completed per week)
    const weekAgo = new Date(Date.now() - 7 * 86400000);
    const weeklyDone = tpTasks.filter(t => 
        t.status === 'done' && 
        t.completedAt && 
        new Date(t.completedAt) > weekAgo
    ).length;
    
    // Average completion time
    const completedWithTimes = tpTasks.filter(t => 
        t.status === 'done' && 
        t.createdAt && 
        t.completedAt
    );
    
    let avgCompletionDays = 0;
    if (completedWithTimes.length > 0) {
        const totalDays = completedWithTimes.reduce((sum, task) => {
            const created = new Date(task.createdAt);
            const completed = new Date(task.completedAt);
            return sum + (completed - created) / (1000 * 60 * 60 * 24);
        }, 0);
        avgCompletionDays = Math.round(totalDays / completedWithTimes.length);
    }
    
    // Workload balance
    const memberWorkloads = tpTeamMembers.map(member => {
        const memberTasks = tpTasks.filter(t => t.member === member.name && t.status !== 'done');
        return memberTasks.reduce((sum, t) => sum + (t.estimatedHours || 0), 0);
    });
    
    const maxWorkload = Math.max(...memberWorkloads, 1);
    const minWorkload = Math.min(...memberWorkloads, 0);
    const balanceScore = maxWorkload > 0 ? 
        Math.round((1 - (maxWorkload - minWorkload) / maxWorkload) * 100) : 100;
    
    // On-time rate
    const tasksWithDeadlines = tpTasks.filter(t => t.deadline && t.status === 'done');
    const onTimeTasks = tasksWithDeadlines.filter(t => {
        const deadline = new Date(t.deadline);
        const completed = new Date(t.completedAt);
        return completed <= deadline;
    }).length;
    
    const onTimeRate = tasksWithDeadlines.length > 0 ? 
        Math.round((onTimeTasks / tasksWithDeadlines.length) * 100) : 0;
    
    // Update metrics
    document.getElementById('metric-velocity').textContent = weeklyDone;
    document.getElementById('metric-completion').textContent = avgCompletionDays;
    document.getElementById('metric-balance').textContent = `${balanceScore}%`;
    document.getElementById('metric-balance').style.color = 
        balanceScore >= 80 ? '#39ff14' : balanceScore >= 60 ? '#ffcc00' : '#ff2d55';
    document.getElementById('metric-ontime').textContent = `${onTimeRate}%`;
    document.getElementById('metric-ontime').style.color = 
        onTimeRate >= 80 ? '#39ff14' : onTimeRate >= 60 ? '#ffcc00' : '#ff2d55';
    
    // Update workload chart
    tpRenderWorkloadChart(memberWorkloads);
    
    // Generate AI recommendations
    tpGenerateAIRecommendations(memberWorkloads, onTimeRate, balanceScore);
}

// Render workload distribution chart
function tpRenderWorkloadChart(workloads) {
    const container = document.getElementById('workload-chart');
    let html = '<div style="display:flex;flex-direction:column;gap:8px;">';
    
    tpTeamMembers.forEach((member, index) => {
        const workload = workloads[index] || 0;
        const percentage = Math.min((workload / (member.capacity || 8)) * 100, 100);
        const color = percentage < 60 ? '#39ff14' : percentage < 90 ? '#ffcc00' : '#ff2d55';
        
        html += `
            <div>
                <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
                    <span style="color:rgba(230,250,255,0.9);">${member.name}</span>
                    <span style="color:${color};">${workload.toFixed(1)}h / ${member.capacity}h</span>
                </div>
                <div style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;">
                    <div style="height:100%;width:${percentage}%;background:${color};border-radius:4px;"></div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Generate AI recommendations
function tpGenerateAIRecommendations(workloads, onTimeRate, balanceScore) {
    const container = document.getElementById('ai-recommendations');
    let recommendations = [];
    
    // Workload recommendations
    const maxWorkload = Math.max(...workloads);
    const minWorkload = Math.min(...workloads);
    
    if (maxWorkload - minWorkload > 10) {
        recommendations.push({
            priority: 'high',
            title: 'Workload Imbalance Detected',
            message: `Highest workload is ${maxWorkload}h, lowest is ${minWorkload}h (${Math.round(maxWorkload - minWorkload)}h difference)`,
            action: 'Use "AI Assign" to redistribute tasks'
        });
    }
    
    // Deadline recommendations
    if (onTimeRate < 70) {
        recommendations.push({
            priority: 'medium',
            title: 'Low On-Time Completion Rate',
            message: `Only ${onTimeRate}% of tasks are completed on time`,
            action: 'Review deadlines and consider buffer time'
        });
    }
    
    // Task complexity recommendations
    const complexTasks = tpTasks.filter(t => 
        t.status !== 'done' && 
        (t.complexity === 'complex' || t.complexity === 'major' || t.complexity === 'epic')
    ).length;
    
    if (complexTasks > 3) {
        recommendations.push({
            priority: 'medium',
            title: 'High Complexity Tasks',
            message: `${complexTasks} complex tasks in progress may cause bottlenecks`,
            action: 'Consider breaking down complex tasks into smaller ones'
        });
    }
    
    // Generate HTML
    if (recommendations.length === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:20px;color:rgba(230,250,255,0.5);">
                ğŸ‰ Great job! All systems are optimal.
            </div>
        `;
        return;
    }
    
    let html = '<div style="display:flex;flex-direction:column;gap:12px;">';
    
    recommendations.forEach(rec => {
        const priorityColor = rec.priority === 'high' ? '#ff2d55' : '#ffcc00';
        
        html += `
            <div style="padding:12px;background:rgba(0,0,0,0.2);border-radius:6px;border-left:4px solid ${priorityColor};">
                <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
                    <span style="color:${priorityColor};font-weight:600;">${rec.title}</span>
                    <span style="margin-left:auto;padding:2px 8px;background:${priorityColor}20;color:${priorityColor};border-radius:10px;font-size:0.8rem;">
                        ${rec.priority.toUpperCase()}
                    </span>
                </div>
                <div style="color:rgba(230,250,255,0.9);font-size:0.9rem;margin-bottom:6px;">${rec.message}</div>
                <div style="color:var(--accent);font-size:0.85rem;">ğŸ’¡ ${rec.action}</div>
            </div>
        `;
    });
    
    html += '</div>';
    container.innerHTML = html;
}

// Render tasks in list view
function tpRenderTasks() {
    // This function is kept for compatibility but kanban is primary view
}

// Render kanban board
function tpRenderKanban() {
    const columns = {
        backlog: document.getElementById('column-backlog'),
        todo: document.getElementById('column-todo'),
        inprogress: document.getElementById('column-inprogress'),
        review: document.getElementById('column-review'),
        done: document.getElementById('column-done')
    };
    
    // Clear all columns
    Object.values(columns).forEach(col => col.innerHTML = '');
    
    // Count tasks per column
    const counts = {
        backlog: 0,
        todo: 0,
        inprogress: 0,
        review: 0,
        done: 0
    };
    
    // Filter tasks based on current filter
    let filteredTasks = tpTasks;
    if (tpCurrentFilter === 'active') {
        filteredTasks = tpTasks.filter(t => t.status !== 'done' && t.status !== 'backlog');
    } else if (tpCurrentFilter === 'overdue') {
        filteredTasks = tpTasks.filter(t => {
            if (t.status === 'done' || t.status === 'backlog' || !t.deadline) return false;
            const deadline = new Date(t.deadline);
            return deadline < new Date();
        });
    }
    
    // Render each task in appropriate column
    filteredTasks.forEach(task => {
        counts[task.status]++;
        
        const taskElement = document.createElement('div');
        taskElement.className = 'kanban-task';
        taskElement.draggable = true;
        taskElement.dataset.id = task.id;
        taskElement.dataset.status = task.status;
        taskElement.ondragstart = tpDragStart;
        taskElement.style.cssText = `
            background: linear-gradient(135deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            cursor: move;
            transition: all 0.2s;
        `;
        
        // Priority indicator
        const priorityColor = priorityLabels[task.priority]?.color || '#ffffff';
        
        // Deadline status
        let deadlineClass = '';
        let deadlineText = task.deadline ? new Date(task.deadline).toLocaleDateString() : 'No deadline';
        
        if (task.deadline && task.status !== 'done') {
            const deadlineDate = new Date(task.deadline);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            deadlineDate.setHours(0, 0, 0, 0);
            const diffDays = Math.floor((deadlineDate - today) / (1000 * 60 * 60 * 24));
            
            if (diffDays < 0) {
                deadlineClass = 'color:#ff2d55;font-weight:600;';
                deadlineText = `âš ï¸ Overdue: ${deadlineText}`;
            } else if (diffDays === 0) {
                deadlineClass = 'color:#ffcc00;font-weight:600;';
                deadlineText = `âš ï¸ Today: ${deadlineText}`;
            } else if (diffDays <= 2) {
                deadlineClass = 'color:#ffa500;';
                deadlineText = `âš ï¸ ${diffDays}d: ${deadlineText}`;
            }
        }
        
        // Progress bar
        const progressBar = task.status === 'done' ? 100 : task.progress || 0;
        
        taskElement.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
                <div>
                    <strong style="color:var(--accent);font-size:0.9rem;">${task.member}</strong>
                    <div style="font-size:0.75rem;color:${priorityColor};margin-top:2px;">
                        ${priorityLabels[task.priority]?.label || 'Priority'} (${task.priority})
                    </div>
                </div>
                <button onclick="tpDeleteTask('${task.id}')" style="
                    background: transparent;
                    border: none;
                    color: rgba(255,77,77,0.7);
                    cursor: pointer;
                    font-size: 12px;
                    padding: 2px;
                " title="Delete">
                    ğŸ—‘ï¸
                </button>
            </div>
            
            <div style="margin-bottom:8px;color:rgba(230,250,255,0.9);font-size:0.85rem;">
                ${task.task}
            </div>
            
            <div style="margin-bottom:8px;">
                <div style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">
                    <div style="height:100%;width:${progressBar}%;background:${priorityColor};border-radius:2px;"></div>
                </div>
                <div style="text-align:center;font-size:0.7rem;color:rgba(230,250,255,0.7);margin-top:2px;">
                    ${progressBar}%
                </div>
            </div>
            
            <div style="display:flex;justify-content:space-between;font-size:0.7rem;">
                <div style="${deadlineClass}">ğŸ“… ${deadlineText}</div>
                <div style="display:flex;gap:4px;">
                    ${(task.tags || []).map(tag => `
                        <span style="
                            padding:1px 4px;
                            background:${tpGetTagColor(tag)};
                            border-radius:4px;
                            font-size:0.6rem;
                        ">${tag}</span>
                    `).join('')}
                </div>
            </div>
        `;
        
        if (columns[task.status]) {
            columns[task.status].appendChild(taskElement);
        }
    });
    
    // Update counts
    Object.keys(counts).forEach(status => {
        const countElement = document.getElementById(`count-${status}`);
        if (countElement) {
            countElement.textContent = counts[status];
        }
    });
    
    // Update total count
    document.getElementById('task-count').textContent = `${filteredTasks.length} task${filteredTasks.length !== 1 ? 's' : ''}`;
}

// Drag and drop functionality
function tpAllowDrop(event) {
    event.preventDefault();
}

function tpDragStart(event) {
    tpDraggedTask = event.target.dataset.id;
    event.dataTransfer.setData('text/plain', event.target.dataset.id);
}

function tpDrop(event) {
    event.preventDefault();
    const taskId = event.dataTransfer.getData('text/plain');
    const task = tpTasks.find(t => t.id === taskId);
    
    if (task) {
        // Determine which column was dropped on
        const column = event.target.closest('[id^="column-"]');
        if (column) {
            const newStatus = column.id.replace('column-', '');
            
            // Update task status and timestamps
            task.status = newStatus;
            if (newStatus === 'inprogress' && !task.startedAt) {
                task.startedAt = new Date().toISOString();
            } else if (newStatus === 'done' && !task.completedAt) {
                task.completedAt = new Date().toISOString();
                task.progress = 100;
            } else if (newStatus === 'done') {
                task.progress = 100;
            }
            
            tpSaveData();
            tpRenderKanban();
            tpUpdateAnalytics();
            tpRenderPerformanceTable();
        }
    }
}

// Filter tasks
function tpFilterTasks(filter) {
    tpCurrentFilter = filter;
    
    // Update filter buttons
    ['all', 'active', 'overdue'].forEach(f => {
        const btn = document.getElementById(`filter-${f}`);
        if (btn) {
            if (f === filter) {
                btn.style.background = 'var(--accent)';
                btn.style.color = '#000';
                btn.style.fontWeight = '600';
            } else {
                btn.style.background = 'rgba(255,255,255,0.05)';
                btn.style.color = 'inherit';
                btn.style.fontWeight = 'normal';
            }
        }
    });
    
    tpRenderKanban();
}

// Delete task
function tpDeleteTask(taskId) {
    if (confirm('Delete this task?')) {
        tpTasks = tpTasks.filter(t => t.id !== taskId);
        tpSaveData();
        tpRenderKanban();
        tpUpdateAnalytics();
        tpRenderPerformanceTable();
    }
}

// Render performance table
function tpRenderPerformanceTable() {
    const container = document.getElementById('performance-table');
    
    // Calculate performance metrics for each team member
    const performanceData = tpTeamMembers.map(member => {
        const memberTasks = tpTasks.filter(t => t.member === member.name);
        const doneTasks = memberTasks.filter(t => t.status === 'done');
        const activeTasks = memberTasks.filter(t => t.status !== 'done' && t.status !== 'backlog');
        const overdueTasks = memberTasks.filter(t => {
            if (t.status === 'done' || !t.deadline) return false;
            const deadline = new Date(t.deadline);
            return deadline < new Date();
        });
        
        // Completion rate
        const completionRate = memberTasks.length > 0 ? 
            Math.round((doneTasks.length / memberTasks.length) * 100) : 0;
        
        // Average completion time (in days)
        let avgTime = 0;
        if (doneTasks.length > 0) {
            const totalTime = doneTasks.reduce((sum, task) => {
                if (task.createdAt && task.completedAt) {
                    const created = new Date(task.createdAt);
                    const completed = new Date(task.completedAt);
                    return sum + (completed - created) / (1000 * 60 * 60 * 24);
                }
                return sum;
            }, 0);
            avgTime = Math.round(totalTime / doneTasks.length);
        }
        
        // Quality score (based on overdue tasks and completion rate)
        let qualityScore = 75; // Base score
        if (completionRate > 90) qualityScore += 15;
        else if (completionRate > 70) qualityScore += 5;
        
        if (overdueTasks.length > 0) {
            qualityScore -= overdueTasks.length * 10;
        }
        
        qualityScore = Math.max(0, Math.min(100, qualityScore));
        
        // Workload
        const workload = activeTasks.reduce((sum, t) => sum + (t.estimatedHours || 0), 0);
        const workloadPercent = Math.round((workload / (member.capacity || 8)) * 100);
        
        return {
            member,
            tasks: memberTasks.length,
            done: doneTasks.length,
            completionRate,
            avgTime,
            qualityScore,
            workload,
            workloadPercent,
            overdue: overdueTasks.length
        };
    });
    
    // Sort by quality score (highest first)
    performanceData.sort((a, b) => b.qualityScore - a.qualityScore);
    
    // Generate table rows
    let html = '';
    performanceData.forEach(data => {
        const qualityColor = data.qualityScore >= 85 ? '#39ff14' : 
                           data.qualityScore >= 70 ? '#ffcc00' : '#ff2d55';
        
        const workloadColor = data.workloadPercent < 60 ? '#39ff14' : 
                            data.workloadPercent < 90 ? '#ffcc00' : '#ff2d55';
        
        html += `
            <tr style="border-bottom:1px solid rgba(255,255,255,0.05);">
                <td style="padding:12px;">
                    <div style="color:var(--accent);font-weight:500;">${data.member.name}</div>
                    <div style="font-size:0.8rem;color:rgba(230,250,255,0.7);">${data.member.role}</div>
                </td>
                <td style="padding:12px;text-align:center;color:rgba(230,250,255,0.9);">
                    ${data.done}/${data.tasks}
                </td>
                <td style="padding:12px;text-align:center;">
                    <span style="color:${qualityColor};font-weight:600;">${data.completionRate}%</span>
                </td>
                <td style="padding:12px;text-align:center;color:rgba(230,250,255,0.9);">
                    ${data.avgTime || 'â€“'} days
                </td>
                <td style="padding:12px;text-align:center;">
                    <span style="color:${qualityColor};font-weight:600;">${data.qualityScore}</span>/100
                </td>
                <td style="padding:12px;text-align:center;">
                    <div style="color:${workloadColor};font-weight:600;">${data.workloadPercent}%</div>
                    <div style="font-size:0.8rem;color:rgba(230,250,255,0.7);">${data.workload.toFixed(1)}h</div>
                </td>
                <td style="padding:12px;">
                    ${tpGenerateMemberRecommendation(data)}
                </td>
            </tr>
        `;
    });
    
    container.innerHTML = html || `
        <tr>
            <td colspan="7" style="padding:20px;text-align:center;color:rgba(230,250,255,0.5);">
                No performance data yet. Add tasks to see analytics.
            </td>
        </tr>
    `;
}

// Generate member-specific recommendations
function tpGenerateMemberRecommendation(data) {
    if (data.tasks === 0) return '<span style="color:rgba(230,250,255,0.5);">No tasks assigned</span>';
    
    let recommendations = [];
    
    if (data.workloadPercent > 90) {
        recommendations.push('Reduce workload');
    } else if (data.workloadPercent < 40) {
        recommendations.push('Can take more tasks');
    }
    
    if (data.overdue > 0) {
        recommendations.push(`Address ${data.overdue} overdue task${data.overdue > 1 ? 's' : ''}`);
    }
    
    if (data.completionRate < 70) {
        recommendations.push('Focus on completion');
    }
    
    if (data.qualityScore > 85) {
        recommendations.push('Excellent work!');
    }
    
    if (recommendations.length === 0) {
        return '<span style="color:#39ff14;">Optimal performance</span>';
    }
    
    return recommendations.map(rec => 
        `<div style="font-size:0.8rem;color:${rec.includes('Excellent') ? '#39ff14' : rec.includes('Optimal') ? '#39ff14' : '#ffcc00'};margin-bottom:2px;">â€¢ ${rec}</div>`
    ).join('');
}

// Export report
function tpExportReport() {
    const reportData = {
        exportedAt: new Date().toISOString(),
        teamMembers: tpTeamMembers.length,
        totalTasks: tpTasks.length,
        activeTasks: tpTasks.filter(t => t.status !== 'done' && t.status !== 'backlog').length,
        doneTasks: tpTasks.filter(t => t.status === 'done').length,
        teamMembers: tpTeamMembers,
        tasks: tpTasks,
        analytics: {
            teamVelocity: document.getElementById('metric-velocity').textContent,
            avgCompletion: document.getElementById('metric-completion').textContent,
            workloadBalance: document.getElementById('metric-balance').textContent,
            onTimeRate: document.getElementById('metric-ontime').textContent
        }
    };
    
    const dataStr = JSON.stringify(reportData, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `team-productivity-report-${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
}

// Reset board
function tpResetBoard() {
    if (confirm('Reset all data? This will clear all tasks and cannot be undone.')) {
        tpTasks = [];
        tpSaveData();
        tpRenderKanban();
        tpUpdateAnalytics();
        tpRenderPerformanceTable();
        
        // Reset form
        document.getElementById('team-member').value = '';
        document.getElementById('task-description').value = '';
        document.getElementById('task-priority').value = 5;
        tpUpdatePriorityDisplay(5);
        document.getElementById('task-progress').value = 0;
        tpUpdateProgressDisplay(0);
        document.getElementById('selected-tags').innerHTML = '';
        document.getElementById('ai-suggestion').style.display = 'none';
        
        // Hide analytics
        document.getElementById('analytics-section').style.display = 'none';
    }
}

// Suggest members based on input
function tpSuggestMembers() {
    const input = document.getElementById('team-member').value.toLowerCase();
    const suggestions = document.getElementById('member-suggestions');
    
    if (input.length < 1) {
        suggestions.style.display = 'none';
        return;
    }
    
    const matchingMembers = tpTeamMembers.filter(m => 
        m.name.toLowerCase().includes(input)
    ).slice(0, 5);
    
    if (matchingMembers.length === 0) {
        suggestions.style.display = 'none';
        return;
    }
    
    let html = '';
    matchingMembers.forEach(member => {
        html += `
            <div onclick="tpSelectMember('${member.name}')" style="
                padding: 8px 12px;
                cursor: pointer;
                transition: background 0.2s;
                color: rgba(230,250,255,0.9);
            " onmouseover="this.style.background='rgba(45,212,255,0.1)'" 
               onmouseout="this.style.background='transparent'">
                ${member.name} <span style="color:rgba(230,250,255,0.5);font-size:0.8rem;">(${member.role})</span>
            </div>
        `;
    });
    
    suggestions.innerHTML = html;
    suggestions.style.display = 'block';
}

function tpSelectMember(name) {
    document.getElementById('team-member').value = name;
    document.getElementById('member-suggestions').style.display = 'none';
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', tpInitialize);
} else {
    tpInitialize();
}
</script>
</div>
