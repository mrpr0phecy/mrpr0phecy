<!-- FILE: cards/oscilloscope-visualizer.html -->
<!-- MISSION: Visualize waveforms and signals instantly -->

<!-- ===== 1. TITLE & PURPOSE ===== -->
<h2 id="osc-title">üì° Oscilloscope Visualizer</h2>
<p id="osc-desc" class="small">
    Visualize and analyze waveforms in real-time. Generate signals, adjust parameters, and explore waveforms.
    <em>For professional signal analysis, try 
        <a href="https://www.siglent.com/oscilloscopes" 
           data-affiliate="siglent-scopes" 
           target="_blank" 
           rel="sponsored nofollow"
           onclick="oscTrackAffiliate('siglent-scopes')">
           Siglent Digital Oscilloscopes
        </a>.
    </em>
</p>

<!-- ===== 2. ZERO-FRICTION CONTROLS ===== -->
<div class="osc-control-section">
    <!-- Waveform Type Selection -->
    <div class="osc-waveform-selector">
        <div class="osc-selector-title">Waveform Type:</div>
        <div class="osc-waveform-buttons">
            <button type="button" 
                    class="osc-wave-btn active" 
                    data-wave="sine"
                    onclick="oscSetWaveform('sine')">
                <span class="osc-wave-icon">~</span>
                Sine
            </button>
            <button type="button" 
                    class="osc-wave-btn" 
                    data-wave="square"
                    onclick="oscSetWaveform('square')">
                <span class="osc-wave-icon">‚éç‚éç‚éç</span>
                Square
            </button>
            <button type="button" 
                    class="osc-wave-btn" 
                    data-wave="triangle"
                    onclick="oscSetWaveform('triangle')">
                <span class="osc-wave-icon">‚ñ≥‚ñ≥‚ñ≥</span>
                Triangle
            </button>
            <button type="button" 
                    class="osc-wave-btn" 
                    data-wave="sawtooth"
                    onclick="oscSetWaveform('sawtooth')">
                <span class="osc-wave-icon">‚Üó‚Üó‚Üó</span>
                Sawtooth
            </button>
            <button type="button" 
                    class="osc-wave-btn" 
                    data-wave="noise"
                    onclick="oscSetWaveform('noise')">
                <span class="osc-wave-icon">‚§®‚§®‚§®</span>
                Noise
            </button>
        </div>
    </div>
    
    <!-- Real-time Controls -->
    <div class="osc-control-grid">
        <div class="osc-control-group">
            <label for="osc-frequency" class="osc-control-label">
                <span class="osc-control-icon">üìà</span>
                Frequency
            </label>
            <div class="osc-control-input">
                <input id="osc-frequency" 
                       type="range" 
                       min="1" 
                       max="100" 
                       value="10"
                       step="1"
                       oninput="oscUpdateFrequency(this.value)">
                <div class="osc-control-value" id="osc-frequency-value">10 Hz</div>
            </div>
        </div>
        
        <div class="osc-control-group">
            <label for="osc-amplitude" class="osc-control-label">
                <span class="osc-control-icon">üìè</span>
                Amplitude
            </label>
            <div class="osc-control-input">
                <input id="osc-amplitude" 
                       type="range" 
                       min="1" 
                       max="100" 
                       value="50"
                       step="1"
                       oninput="oscUpdateAmplitude(this.value)">
                <div class="osc-control-value" id="osc-amplitude-value">50 V</div>
            </div>
        </div>
        
        <div class="osc-control-group">
            <label for="osc-timebase" class="osc-control-label">
                <span class="osc-control-icon">‚è±Ô∏è</span>
                Timebase
            </label>
            <div class="osc-control-input">
                <input id="osc-timebase" 
                       type="range" 
                       min="1" 
                       max="20" 
                       value="5"
                       step="1"
                       oninput="oscUpdateTimebase(this.value)">
                <div class="osc-control-value" id="osc-timebase-value">5 ms/div</div>
            </div>
        </div>
        
        <div class="osc-control-group">
            <label for="osc-volts-per-div" class="osc-control-label">
                <span class="osc-control-icon">‚ö°</span>
                Voltage Scale
            </label>
            <div class="osc-control-input">
                <input id="osc-volts-per-div" 
                       type="range" 
                       min="1" 
                       max="20" 
                       value="10"
                       step="1"
                       oninput="oscUpdateVoltsPerDiv(this.value)">
                <div class="osc-control-value" id="osc-volts-per-div-value">10 V/div</div>
            </div>
        </div>
    </div>
    
    <!-- Trigger Controls -->
    <div class="osc-trigger-section">
        <div class="osc-trigger-title">Trigger Settings:</div>
        <div class="osc-trigger-controls">
            <button type="button" 
                    class="osc-trigger-btn active"
                    onclick="oscSetTrigger('auto')">
                <span class="osc-trigger-icon">‚≠Ø</span>
                Auto
            </button>
            <button type="button" 
                    class="osc-trigger-btn"
                    onclick="oscSetTrigger('rising')">
                <span class="osc-trigger-icon">‚Üó</span>
                Rising Edge
            </button>
            <button type="button" 
                    class="osc-trigger-btn"
                    onclick="oscSetTrigger('falling')">
                <span class="osc-trigger-icon">‚Üò</span>
                Falling Edge
            </button>
            <button type="button" 
                    class="osc-trigger-btn"
                    onclick="oscSetTrigger('single')">
                <span class="osc-trigger-icon">1Ô∏è‚É£</span>
                Single
            </button>
        </div>
        
        <div class="osc-trigger-level">
            <label for="osc-trigger-level">Trigger Level:</label>
            <input id="osc-trigger-level" 
                   type="range" 
                   min="-50" 
                   max="50" 
                   value="0"
                   step="1"
                   oninput="oscUpdateTriggerLevel(this.value)">
            <span id="osc-trigger-level-value">0 V</span>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="osc-actions">
        <button type="button" 
                class="osc-btn osc-btn-secondary"
                onclick="oscFreeze()"
                title="Freeze display">
            <span class="osc-btn-icon">‚è∏Ô∏è</span>
            Freeze
        </button>
        <button type="button" 
                class="osc-btn osc-btn-primary"
                onclick="oscRun()"
                title="Start/Resume">
            <span class="osc-btn-icon">‚ñ∂Ô∏è</span>
            Run
        </button>
        <button type="button" 
                class="osc-btn osc-btn-secondary"
                onclick="oscReset()"
                title="Reset to defaults">
            <span class="osc-btn-icon">üîÑ</span>
            Reset
        </button>
    </div>
</div>

<!-- ===== 3. OSCILLOSCOPE DISPLAY ===== -->
<div class="osc-display-section">
    <div class="osc-display-header">
        <div class="osc-display-title">
            <span class="osc-display-icon">üì∫</span>
            Oscilloscope Display
        </div>
        <div class="osc-display-status" id="osc-status">
            <span class="osc-status-indicator active"></span>
            Running
        </div>
    </div>
    
    <!-- Main Display Canvas -->
    <div class="osc-display-container">
        <canvas id="osc-canvas" width="800" height="400"></canvas>
        
        <!-- Grid Overlay -->
        <div class="osc-grid-overlay">
            <div class="osc-grid-horizontal">
                <div></div><div></div><div></div><div></div><div></div>
                <div></div><div></div><div></div><div></div><div></div>
            </div>
            <div class="osc-grid-vertical">
                <div></div><div></div><div></div><div></div><div></div>
                <div></div><div></div><div></div><div></div><div></div>
            </div>
        </div>
        
        <!-- Display Measurements -->
        <div class="osc-measurements">
            <div class="osc-measurement">
                <div class="osc-measure-label">V<sub>pp</sub></div>
                <div class="osc-measure-value" id="osc-vpp">0.00 V</div>
            </div>
            <div class="osc-measurement">
                <div class="osc-measure-label">V<sub>rms</sub></div>
                <div class="osc-measure-value" id="osc-vrms">0.00 V</div>
            </div>
            <div class="osc-measurement">
                <div class="osc-measure-label">Freq</div>
                <div class="osc-measure-value" id="osc-freq-display">0.00 Hz</div>
            </div>
            <div class="osc-measurement">
                <div class="osc-measure-label">Period</div>
                <div class="osc-measure-value" id="osc-period">0.00 ms</div>
            </div>
            <div class="osc-measurement">
                <div class="osc-measure-label">Duty Cycle</div>
                <div class="osc-measure-value" id="osc-duty">0.00 %</div>
            </div>
        </div>
    </div>
</div>

<!-- ===== 4. SIGNAL GENERATOR PANEL ===== -->
<div class="osc-generator-section">
    <div class="osc-generator-header">
        <h3 class="osc-section-title">
            <span class="osc-section-icon">üéõÔ∏è</span>
            Signal Generator
        </h3>
        <button type="button" 
                class="osc-btn osc-btn-minimal"
                onclick="oscToggleGenerator()"
                id="osc-generator-toggle">
            Show Controls
        </button>
    </div>
    
    <div class="osc-generator-controls" id="osc-generator-controls" style="display:none;">
        <div class="osc-gen-grid">
            <div class="osc-gen-control">
                <label for="osc-dc-offset">DC Offset:</label>
                <input id="osc-dc-offset" 
                       type="range" 
                       min="-50" 
                       max="50" 
                       value="0"
                       step="1"
                       oninput="oscUpdateDCOffset(this.value)">
                <span id="osc-dc-offset-value">0 V</span>
            </div>
            
            <div class="osc-gen-control">
                <label for="osc-phase">Phase:</label>
                <input id="osc-phase" 
                       type="range" 
                       min="0" 
                       max="360" 
                       value="0"
                       step="1"
                       oninput="oscUpdatePhase(this.value)">
                <span id="osc-phase-value">0¬∞</span>
            </div>
            
            <div class="osc-gen-control">
                <label for="osc-damping">Damping:</label>
                <input id="osc-damping" 
                       type="range" 
                       min="0" 
                       max="100" 
                       value="0"
                       step="1"
                       oninput="oscUpdateDamping(this.value)">
                <span id="osc-damping-value">0%</span>
            </div>
            
            <div class="osc-gen-control">
                <label for="osc-harmonics">Harmonics:</label>
                <input id="osc-harmonics" 
                       type="range" 
                       min="0" 
                       max="10" 
                       value="0"
                       step="1"
                       oninput="oscUpdateHarmonics(this.value)">
                <span id="osc-harmonics-value">0</span>
            </div>
        </div>
        
        <div class="osc-preset-signals">
            <div class="osc-preset-title">Preset Signals:</div>
            <div class="osc-preset-buttons">
                <button type="button" 
                        class="osc-preset-btn"
                        onclick="oscLoadPreset('audio')">
                    üéµ Audio (1 kHz)
                </button>
                <button type="button" 
                        class="osc-preset-btn"
                        onclick="oscLoadPreset('power')">
                    ‚ö° Power (60 Hz)
                </button>
                <button type="button" 
                        class="osc-preset-btn"
                        onclick="oscLoadPreset("radio")">
                    üìª Radio (1 MHz)
                </button>
                <button type="button" 
                        class="osc-preset-btn"
                        onclick="oscLoadPreset('heartbeat')">
                    üíì Heartbeat
                </button>
                <button type="button" 
                        class="osc-preset-btn"
                        onclick="oscLoadPreset('ecg')">
                    ü´Ä ECG Simulated
                </button>
            </div>
        </div>
    </div>
</div>

<!-- ===== 5. CONTEXTUAL AFFILIATE ===== -->
<div class="osc-affiliate-disclosure" id="osc-affiliate" style="display:none;">
    <strong>üî¨ Professional Equipment:</strong> For accurate signal measurement and analysis, consider 
    <a href="https://www.siglent.com/oscilloscopes" 
       data-affiliate="siglent-scopes" 
       target="_blank" 
       rel="sponsored nofollow"
       onclick="oscTrackAffiliate('siglent-scopes')">
       Siglent Digital Oscilloscopes
    </a> with advanced triggering and measurement capabilities.
    <small>We may earn a commission. Supports free tools.</small>
</div>

<!-- ===== 6. MEASUREMENT TOOLS ===== -->
<div class="osc-tools-section">
    <div class="osc-tools-header">
        <h3 class="osc-section-title">
            <span class="osc-section-icon">üìê</span>
            Measurement Tools
        </h3>
        <div class="osc-tools-controls">
            <button type="button" 
                    class="osc-tool-btn"
                    onclick="oscEnableCursor('vertical')"
                    id="osc-cursor-vertical">
                ‚áÖ Vertical Cursors
            </button>
            <button type="button" 
                    class="osc-tool-btn"
                    onclick="oscEnableCursor('horizontal')"
                    id="osc-cursor-horizontal">
                ‚áÜ Horizontal Cursors
            </button>
            <button type="button" 
                    class="osc-tool-btn"
                    onclick="oscEnableFFT()"
                    id="osc-fft-toggle">
                üìä FFT View
            </button>
        </div>
    </div>
    
    <div class="osc-tools-display" id="osc-tools-display">
        <!-- Cursor measurements will appear here -->
        <div class="osc-cursor-info" id="osc-cursor-info" style="display:none;">
            <div class="osc-cursor-measurements">
                <div>ŒîV: <span id="osc-delta-v">0.00 V</span></div>
                <div>Œît: <span id="osc-delta-t">0.00 ms</span></div>
                <div>1/Œît: <span id="osc-delta-f">0.00 Hz</span></div>
            </div>
        </div>
    </div>
</div>

<!-- ===== 7. SHARING & EXPORT ===== -->
<div class="osc-export-section">
    <div class="osc-export-buttons">
        <button type="button" 
                class="osc-btn osc-btn-secondary"
                onclick="oscCaptureScreenshot()"
                title="Capture oscilloscope display">
            <span class="osc-btn-icon">üì∏</span>
            Capture
        </button>
        <button type="button" 
                class="osc-btn osc-btn-secondary"
                onclick="oscExportData()"
                title="Export waveform data">
            <span class="osc-btn-icon">üì•</span>
            Export Data
        </button>
        <button type="button" 
                class="osc-btn osc-btn-primary"
                onclick="oscEmbedTool()"
                title="Embed this tool in your website">
            <span class="osc-btn-icon">üîó</span>
            Embed Tool
        </button>
    </div>
</div>

<!-- ===== 8. SELF-CONTAINED JAVASCRIPT ===== -->
<script>
// ===== OSCILLOSCOPE VISUALIZER - REAL-TIME VERSION =====
const oscState = {
    waveform: 'sine',
    frequency: 10,      // Hz
    amplitude: 50,      // volts
    timebase: 5,        // ms per division
    voltsPerDiv: 10,    // volts per division
    trigger: 'auto',
    triggerLevel: 0,
    dcOffset: 0,
    phase: 0,
    damping: 0,
    harmonics: 0,
    running: true,
    frozen: false,
    cursorMode: null,
    fftEnabled: false,
    calculations: 0
};

// Canvas and rendering
let canvas, ctx;
let animationId = null;
let startTime = 0;

// Initialize oscilloscope
function oscInit() {
    canvas = document.getElementById('osc-canvas');
    ctx = canvas.getContext('2d');
    
    // Set canvas size for high DPI displays
    const dpr = window.devicePixelRatio || 1;
    canvas.width = canvas.clientWidth * dpr;
    canvas.height = canvas.clientHeight * dpr;
    ctx.scale(dpr, dpr);
    
    // Start animation loop
    startTime = Date.now();
    oscAnimate();
    
    console.log('üì° Oscilloscope initialized');
}

// Animation loop
function oscAnimate() {
    if (!oscState.frozen && oscState.running) {
        oscDrawWaveform();
    }
    
    animationId = requestAnimationFrame(oscAnimate);
}

// Draw waveform
function oscDrawWaveform() {
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    
    // Clear canvas
    ctx.clearRect(0, 0, width, height);
    
    // Draw grid
    oscDrawGrid();
    
    // Draw center lines
    ctx.strokeStyle = 'rgba(45, 212, 255, 0.3)';
    ctx.lineWidth = 1;
    ctx.setLineDash([2, 2]);
    
    // Vertical center line
    ctx.beginPath();
    ctx.moveTo(width / 2, 0);
    ctx.lineTo(width / 2, height);
    ctx.stroke();
    
    // Horizontal center line
    ctx.beginPath();
    ctx.moveTo(0, height / 2);
    ctx.lineTo(width, height / 2);
    ctx.stroke();
    
    ctx.setLineDash([]);
    
    // Draw waveform
    ctx.strokeStyle = '#39ff14';
    ctx.lineWidth = 2;
    ctx.beginPath();
    
    const time = Date.now() - startTime;
    const samples = 800;
    const timeScale = oscState.timebase * 10; // Convert ms/div to pixels
    
    for (let i = 0; i <= samples; i++) {
        const x = (i / samples) * width;
        
        // Calculate time value
        const t = (time / 1000) + (i / samples) * (timeScale / 1000);
        
        // Calculate y based on waveform type
        let y = oscCalculateWaveform(t);
        
        // Apply DC offset
        y += oscState.dcOffset;
        
        // Apply damping (envelope)
        if (oscState.damping > 0) {
            const dampingFactor = Math.exp(-t * (oscState.damping / 100));
            y *= dampingFactor;
        }
        
        // Convert to pixel coordinates
        const pixelY = height / 2 - (y / oscState.voltsPerDiv) * (height / 8);
        
        if (i === 0) {
            ctx.moveTo(x, pixelY);
        } else {
            ctx.lineTo(x, pixelY);
        }
    }
    
    ctx.stroke();
    
    // Update measurements
    oscUpdateMeasurements();
}

// Calculate waveform value
function oscCalculateWaveform(t) {
    const angularFreq = 2 * Math.PI * oscState.frequency;
    let value = 0;
    
    switch (oscState.waveform) {
        case 'sine':
            value = Math.sin(angularFreq * t + (oscState.phase * Math.PI / 180));
            break;
            
        case 'square':
            value = Math.sign(Math.sin(angularFreq * t + (oscState.phase * Math.PI / 180)));
            break;
            
        case 'triangle':
            value = 2 * Math.asin(Math.sin(angularFreq * t + (oscState.phase * Math.PI / 180))) / Math.PI;
            break;
            
        case 'sawtooth':
            value = 2 * (t * oscState.frequency - Math.floor(t * oscState.frequency + 0.5));
            break;
            
        case 'noise':
            value = (Math.random() * 2 - 1);
            break;
    }
    
    // Apply amplitude
    value *= oscState.amplitude;
    
    // Add harmonics if specified
    if (oscState.harmonics > 0) {
        for (let n = 2; n <= oscState.harmonics + 1; n++) {
            switch (oscState.waveform) {
                case 'sine':
                    value += (oscState.amplitude / n) * Math.sin(n * angularFreq * t);
                    break;
                case 'square':
                    // Square wave harmonics
                    if (n % 2 === 1) {
                        value += (oscState.amplitude / n) * Math.sin(n * angularFreq * t);
                    }
                    break;
            }
        }
    }
    
    return value;
}

// Draw grid
function oscDrawGrid() {
    const width = canvas.clientWidth;
    const height = canvas.clientHeight;
    const divs = 8; // 8 divisions
    
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    ctx.lineWidth = 1;
    
    // Draw vertical grid lines
    for (let i = 0; i <= divs; i++) {
        const x = (i * width) / divs;
        
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, height);
        ctx.stroke();
    }
    
    // Draw horizontal grid lines
    for (let i = 0; i <= divs; i++) {
        const y = (i * height) / divs;
        
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(width, y);
        ctx.stroke();
    }
}

// Update measurements
function oscUpdateMeasurements() {
    // Calculate measurements
    const vpp = oscState.amplitude * 2;
    const vrms = oscState.waveform === 'sine' ? oscState.amplitude / Math.sqrt(2) : oscState.amplitude;
    const period = 1000 / oscState.frequency; // ms
    
    // Update display
    document.getElementById('osc-vpp').textContent = vpp.toFixed(2) + ' V';
    document.getElementById('osc-vrms').textContent = vrms.toFixed(2) + ' V';
    document.getElementById('osc-freq-display').textContent = oscState.frequency.toFixed(2) + ' Hz';
    document.getElementById('osc-period').textContent = period.toFixed(2) + ' ms';
    
    // Calculate duty cycle for square wave
    let dutyCycle = 50;
    if (oscState.waveform === 'square') {
        dutyCycle = 50; // Default square wave
    }
    document.getElementById('osc-duty').textContent = dutyCycle.toFixed(2) + ' %';
    
    // Update calculations count
    oscState.calculations++;
    
    // Show affiliate after 10 calculations
    if (oscState.calculations >= 10 && !document.getElementById('osc-affiliate').classList.contains('osc-visible')) {
        oscShowAffiliate();
    }
}

// ===== CONTROL FUNCTIONS =====
function oscSetWaveform(type) {
    oscState.waveform = type;
    
    // Update button states
    document.querySelectorAll('.osc-wave-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.wave === type);
    });
    
    // Update state display
    document.getElementById('osc-status').innerHTML = 
        `<span class="osc-status-indicator active"></span> ${type.charAt(0).toUpperCase() + type.slice(1)} Wave`;
}

function oscUpdateFrequency(value) {
    oscState.frequency = parseInt(value);
    document.getElementById('osc-frequency-value').textContent = value + ' Hz';
}

function oscUpdateAmplitude(value) {
    oscState.amplitude = parseInt(value);
    document.getElementById('osc-amplitude-value').textContent = value + ' V';
}

function oscUpdateTimebase(value) {
    oscState.timebase = parseInt(value);
    document.getElementById('osc-timebase-value').textContent = value + ' ms/div';
}

function oscUpdateVoltsPerDiv(value) {
    oscState.voltsPerDiv = parseInt(value);
    document.getElementById('osc-volts-per-div-value').textContent = value + ' V/div';
}

function oscSetTrigger(type) {
    oscState.trigger = type;
    
    // Update button states
    document.querySelectorAll('.osc-trigger-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes(type.charAt(0).toUpperCase()));
    });
}

function oscUpdateTriggerLevel(value) {
    oscState.triggerLevel = parseInt(value);
    document.getElementById('osc-trigger-level-value').textContent = value + ' V';
}

function oscUpdateDCOffset(value) {
    oscState.dcOffset = parseInt(value);
    document.getElementById('osc-dc-offset-value').textContent = value + ' V';
}

function oscUpdatePhase(value) {
    oscState.phase = parseInt(value);
    document.getElementById('osc-phase-value').textContent = value + '¬∞';
}

function oscUpdateDamping(value) {
    oscState.damping = parseInt(value);
    document.getElementById('osc-damping-value').textContent = value + '%';
}

function oscUpdateHarmonics(value) {
    oscState.harmonics = parseInt(value);
    document.getElementById('osc-harmonics-value').textContent = value;
}

function oscFreeze() {
    oscState.frozen = true;
    document.getElementById('osc-status').innerHTML = 
        `<span class="osc-status-indicator frozen"></span> Frozen`;
}

function oscRun() {
    oscState.frozen = false;
    oscState.running = true;
    document.getElementById('osc-status').innerHTML = 
        `<span class="osc-status-indicator active"></span> Running`;
}

function oscReset() {
    // Reset all controls to defaults
    oscState.waveform = 'sine';
    oscState.frequency = 10;
    oscState.amplitude = 50;
    oscState.timebase = 5;
    oscState.voltsPerDiv = 10;
    oscState.trigger = 'auto';
    oscState.triggerLevel = 0;
    oscState.dcOffset = 0;
    oscState.phase = 0;
    oscState.damping = 0;
    oscState.harmonics = 0;
    oscState.frozen = false;
    oscState.running = true;
    
    // Update UI
    document.getElementById('osc-frequency').value = 10;
    document.getElementById('osc-frequency-value').textContent = '10 Hz';
    document.getElementById('osc-amplitude').value = 50;
    document.getElementById('osc-amplitude-value').textContent = '50 V';
    document.getElementById('osc-timebase').value = 5;
    document.getElementById('osc-timebase-value').textContent = '5 ms/div';
    document.getElementById('osc-volts-per-div').value = 10;
    document.getElementById('osc-volts-per-div-value').textContent = '10 V/div';
    document.getElementById('osc-trigger-level').value = 0;
    document.getElementById('osc-trigger-level-value').textContent = '0 V';
    document.getElementById('osc-dc-offset').value = 0;
    document.getElementById('osc-dc-offset-value').textContent = '0 V';
    document.getElementById('osc-phase').value = 0;
    document.getElementById('osc-phase-value').textContent = '0¬∞';
    document.getElementById('osc-damping').value = 0;
    document.getElementById('osc-damping-value').textContent = '0%';
    document.getElementById('osc-harmonics').value = 0;
    document.getElementById('osc-harmonics-value').textContent = '0';
    
    // Reset waveform buttons
    document.querySelectorAll('.osc-wave-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.wave === 'sine');
    });
    
    // Reset trigger buttons
    document.querySelectorAll('.osc-trigger-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.includes('Auto'));
    });
    
    // Update status
    document.getElementById('osc-status').innerHTML = 
        `<span class="osc-status-indicator active"></span> Running`;
}

function oscToggleGenerator() {
    const controls = document.getElementById('osc-generator-controls');
    const btn = document.getElementById('osc-generator-toggle');
    
    if (controls.style.display === 'none') {
        controls.style.display = 'block';
        btn.textContent = 'Hide Controls';
    } else {
        controls.style.display = 'none';
        btn.textContent = 'Show Controls';
    }
}

function oscLoadPreset(type) {
    switch(type) {
        case 'audio':
            oscState.frequency = 1000;
            oscState.amplitude = 2;
            oscState.timebase = 1;
            break;
        case 'power':
            oscState.frequency = 60;
            oscState.amplitude = 170;
            oscState.timebase = 5;
            break;
        case 'radio':
            oscState.frequency = 1000000;
            oscState.amplitude = 0.1;
            oscState.timebase = 0.01;
            break;
        case 'heartbeat':
            oscSetWaveform('sine');
            oscState.frequency = 1.2;
            oscState.amplitude = 2;
            oscState.timebase = 500;
            oscState.damping = 30;
            break;
        case 'ecg':
            // Simulated ECG with multiple sine waves
            oscSetWaveform('sine');
            oscState.frequency = 1.2;
            oscState.amplitude = 1;
            oscState.timebase = 500;
            oscState.harmonics = 3;
            break;
    }
    
    // Update UI sliders
    document.getElementById('osc-frequency').value = oscState.frequency;
    document.getElementById('osc-frequency-value').textContent = oscState.frequency + ' Hz';
    document.getElementById('osc-amplitude').value = oscState.amplitude;
    document.getElementById('osc-amplitude-value').textContent = oscState.amplitude + ' V';
    document.getElementById('osc-timebase').value = oscState.timebase;
    document.getElementById('osc-timebase-value').textContent = oscState.timebase + ' ms/div';
    
    if (type === 'heartbeat' || type === 'ecg') {
        document.getElementById('osc-damping').value = oscState.damping;
        document.getElementById('osc-damping-value').textContent = oscState.damping + '%';
        document.getElementById('osc-harmonics').value = oscState.harmonics;
        document.getElementById('osc-harmonics-value').textContent = oscState.harmonics;
    }
}

function oscEnableCursor(type) {
    oscState.cursorMode = type;
    const info = document.getElementById('osc-cursor-info');
    
    document.querySelectorAll('.osc-tool-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    
    if (type === 'vertical') {
        document.getElementById('osc-cursor-vertical').classList.add('active');
        info.style.display = 'block';
    } else if (type === 'horizontal') {
        document.getElementById('osc-cursor-horizontal').classList.add('active');
        info.style.display = 'block';
    } else {
        info.style.display = 'none';
    }
}

function oscEnableFFT() {
    oscState.fftEnabled = !oscState.fftEnabled;
    const btn = document.getElementById('osc-fft-toggle');
    
    if (oscState.fftEnabled) {
        btn.classList.add('active');
        // In a real implementation, this would switch to FFT view
        console.log('FFT enabled - switching to frequency domain');
    } else {
        btn.classList.remove('active');
        console.log('FFT disabled - back to time domain');
    }
}

function oscCaptureScreenshot() {
    // Create a new canvas with white background for capture
    const captureCanvas = document.createElement('canvas');
    const captureCtx = captureCanvas.getContext('2d');
    
    captureCanvas.width = canvas.width;
    captureCanvas.height = canvas.height;
    
    // Fill with white background
    captureCtx.fillStyle = '#ffffff';
    captureCtx.fillRect(0, 0, captureCanvas.width, captureCanvas.height);
    
    // Draw the current oscilloscope display
    captureCtx.drawImage(canvas, 0, 0);
    
    // Convert to data URL
    const dataURL = captureCanvas.toDataURL('image/png');
    
    // Create download link
    const link = document.createElement('a');
    link.download = `oscilloscope-${Date.now()}.png`;
    link.href = dataURL;
    link.click();
    
    console.log('üì∏ Screenshot captured');
}

function oscExportData() {
    // Generate sample waveform data
    const samples = 1000;
    const data = [];
    const timeScale = oscState.timebase * 10 / 1000; // Convert to seconds
    
    for (let i = 0; i < samples; i++) {
        const t = i * timeScale / samples;
        const y = oscCalculateWaveform(t);
        data.push(`${t.toFixed(6)},${y.toFixed(6)}`);
    }
    
    const csv = 'Time(s),Voltage(V)\n' + data.join('\n');
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    
    const link = document.createElement('a');
    link.download = `waveform-data-${Date.now()}.csv`;
    link.href = url;
    link.click();
    
    URL.revokeObjectURL(url);
    console.log('üì• Data exported');
}

function oscEmbedTool() {
    const embedCode = `<iframe src="${window.location.origin}/cards/oscilloscope-visualizer.html" width="100%" height="700" style="border:none;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);" title="Oscilloscope Visualizer - The Most Useful Site"></iframe>`;
    
    navigator.clipboard.writeText(embedCode).then(() => {
        alert('Embed code copied to clipboard!');
    });
}

// ===== AFFILIATE SYSTEM =====
function oscShowAffiliate() {
    const affiliate = document.getElementById('osc-affiliate');
    affiliate.style.display = 'block';
    setTimeout(() => affiliate.classList.add('osc-visible'), 10);
}

function oscTrackAffiliate(product) {
    console.log(`Affiliate click: ${product}`);
    // Add your analytics tracking here
}

// ===== INITIALIZATION =====
document.addEventListener('DOMContentLoaded', () => {
    console.log('üì° Oscilloscope Visualizer - Initializing');
    
    // Initialize oscilloscope
    oscInit();
    
    // Calculate initial measurements
    setTimeout(() => oscUpdateMeasurements(), 100);
    
    // Handle window resize
    window.addEventListener('resize', () => {
        cancelAnimationFrame(animationId);
        oscInit();
    });
    
    // Keyboard shortcuts
    document.addEventListener
