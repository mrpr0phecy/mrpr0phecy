<h2 id="history-timeline-title" style="margin-top:0;color:var(--accent);">ğŸ“œ Advanced History Timeline Builder</h2>

<form aria-describedby="history-timeline-desc">
  <p id="history-timeline-desc" class="small" style="color:var(--muted);margin-bottom:20px;">
    Create interactive timelines, explore historical databases, and visualize events across civilizations.
    <span style="color:var(--accent);font-weight:500;">Perfect for students, educators, and history enthusiasts!</span>
  </p>

  <!-- Event Creation Section -->
  <div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
    <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">â• Add Historical Event</h3>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:12px;">
      <div>
        <label for="ht-event" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Event Title *
        </label>
        <input id="ht-event" type="text" placeholder="Fall of the Berlin Wall" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
      </div>
      
      <div>
        <label for="ht-year" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Year *
        </label>
        <input id="ht-year" type="number" placeholder="1989" min="-3500" max="2100" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
      </div>
      
      <div>
        <label for="ht-month" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Month (Optional)
        </label>
        <select id="ht-month" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="">-- Select Month --</option>
          <option value="01">January</option>
          <option value="02">February</option>
          <option value="03">March</option>
          <option value="04">April</option>
          <option value="05">May</option>
          <option value="06">June</option>
          <option value="07">July</option>
          <option value="08">August</option>
          <option value="09">September</option>
          <option value="10">October</option>
          <option value="11">November</option>
          <option value="12">December</option>
        </select>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:12px;">
      <div>
        <label for="ht-category" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Category
        </label>
        <select id="ht-category" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="politics">ğŸ›ï¸ Politics & Government</option>
          <option value="war">âš”ï¸ War & Conflict</option>
          <option value="science">ğŸ”¬ Science & Technology</option>
          <option value="culture">ğŸ­ Culture & Arts</option>
          <option value="religion">â›ª Religion & Philosophy</option>
          <option value="economics">ğŸ’° Economics & Trade</option>
          <option value="exploration">ğŸ—ºï¸ Exploration & Discovery</option>
          <option value="social">ğŸ‘¥ Social Movements</option>
          <option value="sports">âš½ Sports</option>
          <option value="other">ğŸ“‹ Other</option>
        </select>
      </div>
      
      <div>
        <label for="ht-region" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Region
        </label>
        <select id="ht-region" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="global">ğŸŒ Global</option>
          <option value="europe">ğŸ‡ªğŸ‡º Europe</option>
          <option value="asia">ğŸ‡¨ğŸ‡³ Asia</option>
          <option value="africa">ğŸ‡³ğŸ‡¬ Africa</option>
          <option value="americas">ğŸ‡ºğŸ‡¸ Americas</option>
          <option value="middle-east">ğŸ‡¸ğŸ‡¦ Middle East</option>
          <option value="oceania">ğŸ‡¦ğŸ‡º Oceania</option>
        </select>
      </div>
      
      <div>
        <label for="ht-significance" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Significance
        </label>
        <select id="ht-significance" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
          <option value="1">ğŸŒŸ Minor</option>
          <option value="2">ğŸŒŸğŸŒŸ Notable</option>
          <option value="3" selected>ğŸŒŸğŸŒŸğŸŒŸ Important</option>
          <option value="4">ğŸŒŸğŸŒŸğŸŒŸğŸŒŸ Major</option>
          <option value="5">ğŸŒŸğŸŒŸğŸŒŸğŸŒŸğŸŒŸ World-Changing</option>
        </select>
      </div>
    </div>
    
    <div style="margin-bottom:12px;">
      <label for="ht-description" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Description
      </label>
      <textarea id="ht-description" rows="3" placeholder="Describe the event, its causes, consequences, and historical significance..."
                style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-family:inherit;resize:vertical;"></textarea>
    </div>
    
    <div style="margin-bottom:12px;">
      <label for="ht-sources" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Sources (Optional)
      </label>
      <input id="ht-sources" type="text" placeholder="Wikipedia, Britannica, etc."
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    </div>
    
    <div style="display:flex;gap:10px;margin-top:16px;">
      <button type="button" onclick="htAddEvent()" 
              style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
        ğŸ“ Add Event to Timeline
      </button>
      <button type="button" onclick="htClearForm()"
              style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
        Clear Form
      </button>
    </div>
  </div>
</form>

<!-- Historical Database -->
<div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
  <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">ğŸ—„ï¸ Historical Database</h3>
  
  <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
    <button type="button" onclick="htLoadPredefined('ancient')"
            style="padding:10px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">
      ğŸº Ancient History
    </button>
    <button type="button" onclick="htLoadPredefined('medieval')"
            style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸ° Medieval
    </button>
    <button type="button" onclick="htLoadPredefined('renaissance')"
            style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸ¨ Renaissance
    </button>
    <button type="button" onclick="htLoadPredefined('modern')"
            style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸ­ Modern Era
    </button>
    <button type="button" onclick="htLoadPredefined('ww2')"
            style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      âš”ï¸ WWII
    </button>
    <button type="button" onclick="htLoadPredefined('space')"
            style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸš€ Space Age
    </button>
  </div>
  
  <!-- Quick Search -->
  <div style="display:grid;grid-template-columns:1fr auto;gap:10px;margin-bottom:16px;">
    <input type="text" id="ht-search" placeholder="Search events... (e.g., 'revolution', 'discovery')" 
           style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    <button type="button" onclick="htSearchEvents()"
            style="padding:10px 20px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;">
      Search
    </button>
  </div>
</div>

<!-- Timeline Visualization -->
<div id="ht-timeline-container" style="display:none;margin-bottom:20px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">ğŸ“… Interactive Timeline</h3>
    <div style="display:flex;gap:8px;">
      <button type="button" onclick="htChangeView('list')" id="ht-view-list"
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        List View
      </button>
      <button type="button" onclick="htChangeView('timeline')" id="ht-view-timeline"
              style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:12px;">
        Timeline View
      </button>
      <button type="button" onclick="htChangeView('grid')" id="ht-view-grid"
              style="padding:6px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:12px;">
        Grid View
      </button>
    </div>
  </div>
  
  <!-- Timeline Controls -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:12px;margin-bottom:16px;border:1px solid rgba(255,255,255,0.1);">
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:center;">
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">Filter by:</label>
        <select id="ht-filter-category" style="padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;font-size:12px;">
          <option value="all">All Categories</option>
          <option value="politics">Politics</option>
          <option value="war">War</option>
          <option value="science">Science</option>
          <option value="culture">Culture</option>
          <option value="religion">Religion</option>
        </select>
      </div>
      
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">Sort by:</label>
        <select id="ht-sort-by" style="padding:6px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;font-size:12px;">
          <option value="year">Year (Ascending)</option>
          <option value="year-desc">Year (Descending)</option>
          <option value="significance">Significance</option>
          <option value="category">Category</option>
        </select>
      </div>
      
      <div>
        <label style="font-size:12px;color:var(--muted);display:block;margin-bottom:4px;">Time Range:</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input type="number" id="ht-range-start" placeholder="Start year" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
          <span style="color:var(--muted);">to</span>
          <input type="number" id="ht-range-end" placeholder="End year" style="width:80px;padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.05);color:inherit;text-align:center;" />
          <button type="button" onclick="htApplyFilters()" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);border-radius:6px;cursor:pointer;font-size:12px;">Apply</button>
        </div>
      </div>
      
      <div style="margin-left:auto;">
        <button type="button" onclick="htExportTimeline()" style="padding:8px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:6px;cursor:pointer;font-size:12px;">
          Export Timeline
        </button>
      </div>
    </div>
  </div>
  
  <!-- Timeline Display -->
  <div id="ht-timeline-display">
    <!-- Content will be populated by JavaScript -->
    <div style="text-align:center;padding:40px;color:var(--muted);font-style:italic;">
      No events added yet. Add your first historical event above!
    </div>
  </div>
</div>

<!-- Statistics & Analysis -->
<div id="ht-statistics-container" style="display:none;margin-bottom:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:12px;">ğŸ“Š Timeline Statistics</h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:16px;">
    <div style="background:rgba(45,212,255,0.05);border-radius:8px;padding:12px;border:1px solid rgba(45,212,255,0.2);">
      <div style="font-size:12px;color:var(--accent);margin-bottom:4px;">Total Events</div>
      <div id="ht-total-events" style="font-size:24px;font-weight:600;color:var(--accent);">0</div>
    </div>
    <div style="background:rgba(57,255,20,0.05);border-radius:8px;padding:12px;border:1px solid rgba(57,255,20,0.2);">
      <div style="font-size:12px;color:#39ff14;margin-bottom:4px;">Time Span</div>
      <div id="ht-time-span" style="font-size:24px;font-weight:600;color:#39ff14;">0 years</div>
    </div>
    <div style="background:rgba(255,204,0,0.05);border-radius:8px;padding:12px;border:1px solid rgba(255,204,0,0.2);">
      <div style="font-size:12px;color:#ffcc00;margin-bottom:4px;">Avg. Events/Year</div>
      <div id="ht-events-per-year" style="font-size:24px;font-weight:600;color:#ffcc00;">0.0</div>
    </div>
    <div style="background:rgba(255,77,77,0.05);border-radius:8px;padding:12px;border:1px solid rgba(255,77,77,0.2);">
      <div style="font-size:12px;color:#ff4d4d;margin-bottom:4px;">Most Active Year</div>
      <div id="ht-most-active-year" style="font-size:24px;font-weight:600;color:#ff4d4d;">--</div>
    </div>
  </div>
  
  <!-- Category Distribution -->
  <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
    <div style="font-size:12px;color:var(--accent);margin-bottom:8px;">Category Distribution</div>
    <div id="ht-category-chart" style="display:flex;height:24px;border-radius:4px;overflow:hidden;margin-bottom:8px;background:rgba(255,255,255,0.05);">
      <!-- Chart bars will be generated by JavaScript -->
    </div>
    <div id="ht-category-legend" style="display:flex;gap:12px;flex-wrap:wrap;font-size:11px;color:var(--muted);">
      <!-- Legend will be generated by JavaScript -->
    </div>
  </div>
</div>

<!-- Study Tools -->
<div style="background:rgba(255,255,255,0.03);border-radius:12px;padding:20px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
  <h3 class="small" style="color:var(--accent);margin-top:0;margin-bottom:16px;">ğŸ“ Study Tools</h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;">
    <div>
      <h4 style="color:var(--accent);font-size:14px;margin-bottom:8px;">ğŸ“ Quiz Generator</h4>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Generate quizzes based on your timeline.</p>
      <button type="button" onclick="htGenerateQuiz()" 
              style="width:100%;padding:10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">
        Generate Quiz
      </button>
    </div>
    
    <div>
      <h4 style="color:var(--accent);font-size:14px;margin-bottom:8px;">ğŸ“„ Timeline Summary</h4>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Create a summary of your timeline events.</p>
      <button type="button" onclick="htGenerateSummary()"
              style="width:100%;padding:10px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
        Generate Summary
      </button>
    </div>
    
    <div>
      <h4 style="color:var(--accent);font-size:14px;margin-bottom:8px;">ğŸ”— Relationship Map</h4>
      <p style="font-size:13px;color:var(--muted);margin-bottom:12px;">Visualize connections between events.</p>
      <button type="button" onclick="htGenerateRelationships()"
              style="width:100%;padding:10px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:8px;color:#ffcc00;cursor:pointer;">
        Show Relationships
      </button>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div style="display:flex;gap:10px;margin-top:20px;">
  <button type="button" onclick="htResetAll()" 
          style="flex:1;padding:12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;">
    ğŸ”„ Reset All Data
  </button>
  <button type="button" onclick="htImportData()"
          style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);color:#39ff14;border-radius:8px;cursor:pointer;">
    ğŸ“¥ Import Data
  </button>
  <button type="button" onclick="htSaveTimeline()"
          style="padding:12px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);color:var(--accent);border-radius:8px;cursor:pointer;">
    ğŸ’¾ Save Timeline
  </button>
</div>

<!-- Information Panel -->
<details style="margin-top:20px;background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;border:1px solid rgba(255,255,255,0.06);">
  <summary style="color:var(--accent);font-weight:500;cursor:pointer;outline:none;">
    ğŸ“š Timeline Creation Tips
  </summary>
  <div style="margin-top:12px;font-size:13px;color:var(--muted);">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
      <div>
        <strong style="color:var(--accent);">Category Colors:</strong>
        <ul style="margin:6px 0;padding-left:20px;">
          <li><span style="color:#FF6B6B;">Politics:</span> Red</li>
          <li><span style="color:#4ECDC4;">Science:</span> Teal</li>
          <li><span style="color:#FFD166;">Culture:</span> Yellow</li>
          <li><span style="color:#06D6A0;">Religion:</span> Green</li>
          <li><span style="color:#118AB2;">War:</span> Blue</li>
          <li><span style="color:#9D4EDD;">Other:</span> Purple</li>
        </ul>
      </div>
      <div>
        <strong style="color:var(--accent);">Teaching Ideas:</strong>
        <ul style="margin:6px 0;padding-left:20px;">
          <li>Create comparative timelines</li>
          <li>Track cause-and-effect relationships</li>
          <li>Visualize historical periods</li>
          <li>Create study guides for exams</li>
        </ul>
      </div>
    </div>
    <div style="margin-top:12px;">
      <strong style="color:var(--accent);">Historical Periods:</strong>
      <div style="font-size:12px;color:var(--muted);margin-top:4px;">
        Ancient (before 500 CE) | Medieval (500-1500) | Early Modern (1500-1800) | Modern (1800-Present)
      </div>
    </div>
  </div>
</details>

<script>
/* history-timeline.html
   - World-class history timeline builder with advanced features
   - Scoped with ht- prefix (history timeline)
*/

// Global state
let htEvents = [];
let htCurrentView = 'list';
let htPredefinedEvents = {
  ancient: [
    { event: "Pyramids of Giza Built", year: -2560, category: "culture", region: "africa", significance: 5, description: "Construction of the Great Pyramid of Giza, one of the Seven Wonders of the Ancient World.", sources: "Wikipedia" },
    { event: "Code of Hammurabi", year: -1754, category: "politics", region: "middle-east", significance: 4, description: "One of the oldest deciphered writings of significant length in the world.", sources: "Britannica" },
    { event: "Founding of Rome", year: -753, category: "politics", region: "europe", significance: 5, description: "Traditional date for the founding of Rome by Romulus and Remus.", sources: "Historical records" }
  ],
  medieval: [
    { event: "Fall of Western Roman Empire", year: 476, category: "politics", region: "europe", significance: 5, description: "Traditional date marking the end of ancient history and beginning of the Middle Ages.", sources: "Gibbon's Decline and Fall" },
    { event: "Battle of Hastings", year: 1066, category: "war", region: "europe", significance: 4, description: "Norman conquest of England, led by William the Conqueror.", sources: "Bayeux Tapestry" },
    { event: "Magna Carta", year: 1215, category: "politics", region: "europe", significance: 5, description: "Charter of rights agreed to by King John of England, foundation of modern democracy.", sources: "British Library" }
  ],
  renaissance: [
    { event: "Gutenberg Printing Press", year: 1440, category: "science", region: "europe", significance: 5, description: "Invention of movable type printing, revolutionizing information distribution.", sources: "History of printing" },
    { event: "Columbus Reaches America", year: 1492, category: "exploration", region: "global", significance: 5, description: "First European contact with the Americas since the Vikings.", sources: "Columbus journals" },
    { event: "Martin Luther's 95 Theses", year: 1517, category: "religion", region: "europe", significance: 5, description: "Beginning of the Protestant Reformation.", sources: "Luther's writings" }
  ],
  ww2: [
    { event: "World War II Begins", year: 1939, category: "war", region: "global", significance: 5, description: "Germany invades Poland, beginning the deadliest conflict in human history.", sources: "Historical records" },
    { event: "D-Day", year: 1944, category: "war", region: "europe", significance: 5, description: "Allied invasion of Normandy, turning point in WWII.", sources: "Military archives" },
    { event: "Atomic Bombs Dropped", year: 1945, category: "war", region: "asia", significance: 5, description: "Atomic bombings of Hiroshima and Nagasaki, leading to Japan's surrender.", sources: "Historical documents" }
  ],
  space: [
    { event: "Sputnik 1", year: 1957, category: "science", region: "global", significance: 5, description: "First artificial Earth satellite, beginning the Space Age.", sources: "NASA archives" },
    { event: "Apollo 11 Moon Landing", year: 1969, category: "science", region: "global", significance: 5, description: "First humans to land on the Moon.", sources: "NASA, Apollo mission records" },
    { event: "Hubble Space Telescope Launch", year: 1990, category: "science", region: "global", significance: 4, description: "Revolutionized astronomy with unprecedented deep space images.", sources: "NASA, ESA" }
  ]
};

// Initialize when script loads
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    htLoadTimeline();
    console.log('Advanced History Timeline ready');
  });
} else {
  htLoadTimeline();
}

// Load timeline from localStorage
function htLoadTimeline() {
  const saved = localStorage.getItem('ht-timeline');
  if (saved) {
    try {
      htEvents = JSON.parse(saved);
      if (htEvents.length > 0) {
        htRenderTimeline();
        htShowTimelineContainer();
        htUpdateStatistics();
      }
    } catch (e) {
      console.error('Failed to load timeline:', e);
      htEvents = [];
    }
  }
}

// Save timeline to localStorage
function htSaveTimeline() {
  localStorage.setItem('ht-timeline', JSON.stringify(htEvents));
  htShowMessage('Timeline saved successfully!', 'success');
}

// Add new event
function htAddEvent() {
  const eventInput = document.getElementById('ht-event');
  const yearInput = document.getElementById('ht-year');
  const monthInput = document.getElementById('ht-month');
  const categoryInput = document.getElementById('ht-category');
  const regionInput = document.getElementById('ht-region');
  const significanceInput = document.getElementById('ht-significance');
  const descriptionInput = document.getElementById('ht-description');
  const sourcesInput = document.getElementById('ht-sources');
  
  const event = eventInput.value.trim();
  const year = parseInt(yearInput.value);
  
  if (!event || isNaN(year)) {
    htShowMessage('Please enter both event title and year', 'error');
    return;
  }
  
  // Create event object
  const newEvent = {
    id: Date.now() + Math.random().toString(36).substr(2, 9),
    event: event,
    year: year,
    month: monthInput.value || null,
    category: categoryInput.value,
    region: regionInput.value,
    significance: parseInt(significanceInput.value),
    description: descriptionInput.value.trim() || null,
    sources: sourcesInput.value.trim() || null,
    createdAt: new Date().toISOString()
  };
  
  htEvents.push(newEvent);
  htSaveTimeline();
  htRenderTimeline();
  htClearForm();
  
  if (!document.getElementById('ht-timeline-container').style.display || 
      document.getElementById('ht-timeline-container').style.display === 'none') {
    htShowTimelineContainer();
  }
  
  htUpdateStatistics();
  htShowMessage(`"${event}" added to timeline`, 'success');
}

// Clear form
function htClearForm() {
  document.getElementById('ht-event').value = '';
  document.getElementById('ht-year').value = '';
  document.getElementById('ht-month').value = '';
  document.getElementById('ht-description').value = '';
  document.getElementById('ht-sources').value = '';
  document.getElementById('ht-event').focus();
}

// Show timeline container
function htShowTimelineContainer() {
  document.getElementById('ht-timeline-container').style.display = 'block';
  document.getElementById('ht-statistics-container').style.display = 'block';
}

// Render timeline based on current view
function htRenderTimeline() {
  if (htEvents.length === 0) {
    document.getElementById('ht-timeline-display').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted);font-style:italic;">
        No events added yet. Add your first historical event above!
      </div>
    `;
    return;
  }
  
  // Apply filters
  let filteredEvents = [...htEvents];
  const categoryFilter = document.getElementById('ht-filter-category').value;
  const sortBy = document.getElementById('ht-sort-by').value;
  const rangeStart = parseInt(document.getElementById('ht-range-start').value);
  const rangeEnd = parseInt(document.getElementById('ht-range-end').value);
  
  // Apply category filter
  if (categoryFilter !== 'all') {
    filteredEvents = filteredEvents.filter(e => e.category === categoryFilter);
  }
  
  // Apply year range filter
  if (!isNaN(rangeStart)) {
    filteredEvents = filteredEvents.filter(e => e.year >= rangeStart);
  }
  if (!isNaN(rangeEnd)) {
    filteredEvents = filteredEvents.filter(e => e.year <= rangeEnd);
  }
  
  // Apply sorting
  filteredEvents.sort((a, b) => {
    switch(sortBy) {
      case 'year-desc':
        return b.year - a.year;
      case 'significance':
        return b.significance - a.significance;
      case 'category':
        return a.category.localeCompare(b.category);
      default: // 'year'
        return a.year - b.year;
    }
  });
  
  // Render based on view
  switch(htCurrentView) {
    case 'timeline':
      htRenderTimelineView(filteredEvents);
      break;
    case 'grid':
      htRenderGridView(filteredEvents);
      break;
    default: // 'list'
      htRenderListView(filteredEvents);
  }
}

// Render list view
function htRenderListView(events) {
  let html = '';
  
  events.forEach(event => {
    const categoryIcon = htGetCategoryIcon(event.category);
    const significanceStars = 'â˜…'.repeat(event.significance);
    const monthText = event.month ? htGetMonthName(event.month) + ' ' : '';
    const yearPrefix = event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`;
    
    html += `
      <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:4px solid ${htGetCategoryColor(event.category)};">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
          <div>
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span style="font-size:18px;">${categoryIcon}</span>
              <div style="font-weight:600;color:var(--accent);">${event.event}</div>
            </div>
            <div style="font-size:12px;color:${htGetCategoryColor(event.category)};">
              ${htGetCategoryName(event.category)} â€¢ ${htGetRegionName(event.region)}
            </div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:20px;font-weight:600;color:var(--accent);">${monthText}${yearPrefix}</div>
            <div style="font-size:12px;color:#ffcc00;">${significanceStars}</div>
          </div>
        </div>
        
        ${event.description ? `<div style="font-size:13px;color:var(--muted);margin-top:8px;">${event.description}</div>` : ''}
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
          <div style="font-size:11px;color:var(--muted);">
            ${event.sources ? `Sources: ${event.sources}` : ''}
          </div>
          <div>
            <button onclick="htEditEvent('${event.id}')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;">Edit</button>
            <button onclick="htDeleteEvent('${event.id}')" style="padding:4px 8px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:4px;color:#ff4d4d;cursor:pointer;font-size:11px;">Delete</button>
          </div>
        </div>
      </div>
    `;
  });
  
  document.getElementById('ht-timeline-display').innerHTML = html;
}

// Render timeline view
function htRenderTimelineView(events) {
  if (events.length === 0) {
    document.getElementById('ht-timeline-display').innerHTML = `
      <div style="text-align:center;padding:40px;color:var(--muted);font-style:italic;">
        No events match the current filters.
      </div>
    `;
    return;
  }
  
  // Find date range for scaling
  const years = events.map(e => e.year);
  const minYear = Math.min(...years);
  const maxYear = Math.max(...years);
  const yearRange = maxYear - minYear;
  
  // Create timeline
  let html = `
    <div style="position:relative;padding:20px 0;">
      <!-- Timeline line -->
      <div style="position:absolute;left:0;right:0;top:50px;height:2px;background:linear-gradient(90deg, var(--accent), rgba(45,212,255,0.3));"></div>
      
      <!-- Year markers -->
      <div style="display:flex;justify-content:space-between;position:relative;z-index:1;">
        ${Array.from({length: 6}, (_, i) => {
          const year = minYear + Math.floor((yearRange / 5) * i);
          const yearText = year < 0 ? `${Math.abs(year)} BCE` : `${year} CE`;
          return `<div style="text-align:center;font-size:11px;color:var(--muted);">${yearText}</div>`;
        }).join('')}
      </div>
      
      <!-- Events -->
      <div style="position:relative;height:200px;margin-top:30px;">
  `;
  
  events.forEach((event, index) => {
    const position = ((event.year - minYear) / yearRange) * 100;
    const categoryColor = htGetCategoryColor(event.category);
    const significanceSize = 20 + (event.significance * 6);
    const leftPos = Math.max(0, Math.min(98, position));
    
    html += `
      <div style="position:absolute;left:${leftPos}%;top:${(index % 3) * 60 + 20}px;transform:translateX(-50%);">
        <div style="width:${significanceSize}px;height:${significanceSize}px;border-radius:50%;background:${categoryColor};border:2px solid white;box-shadow:0 4px 12px rgba(0,0,0,0.3);cursor:pointer;"
             onclick="htShowEventDetails('${event.id}')">
        </div>
        <div style="position:absolute;top:${significanceSize + 5}px;left:50%;transform:translateX(-50%);white-space:nowrap;font-size:12px;color:var(--accent);font-weight:500;background:rgba(0,0,0,0.7);padding:2px 6px;border-radius:4px;">
          ${event.event}
        </div>
        <div style="position:absolute;top:-25px;left:50%;transform:translateX(-50%);font-size:11px;color:var(--muted);">
          ${event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`}
        </div>
      </div>
    `;
  });
  
  html += `
      </div>
    </div>
  `;
  
  document.getElementById('ht-timeline-display').innerHTML = html;
}

// Render grid view
function htRenderGridView(events) {
  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));gap:16px;">';
  
  events.forEach(event => {
    const categoryColor = htGetCategoryColor(event.category);
    const significanceStars = 'â˜…'.repeat(event.significance);
    const yearText = event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`;
    
    html += `
      <div style="background:rgba(255,255,255,0.02);border-radius:8px;padding:16px;border:1px solid ${categoryColor}40;box-shadow:0 4px 12px rgba(0,0,0,0.2);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
          <div style="font-size:24px;color:${categoryColor};">${htGetCategoryIcon(event.category)}</div>
          <div style="font-size:18px;font-weight:600;color:var(--accent);">${yearText}</div>
        </div>
        
        <div style="font-weight:600;color:white;margin-bottom:8px;font-size:15px;">${event.event}</div>
        
        <div style="display:flex;gap:8px;margin-bottom:12px;">
          <div style="font-size:11px;padding:2px 8px;background:${categoryColor}20;color:${categoryColor};border-radius:4px;">
            ${htGetCategoryName(event.category)}
          </div>
          <div style="font-size:11px;padding:2px 8px;background:rgba(255,255,255,0.1);color:var(--muted);border-radius:4px;">
            ${htGetRegionName(event.region)}
          </div>
        </div>
        
        ${event.description ? `
          <div style="font-size:13px;color:var(--muted);margin-bottom:12px;line-height:1.4;max-height:60px;overflow:hidden;text-overflow:ellipsis;">
            ${event.description}
          </div>
        ` : ''}
        
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:16px;">
          <div style="color:#ffcc00;font-size:14px;">${significanceStars}</div>
          <div>
            <button onclick="htShowEventDetails('${event.id}')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;">
              Details
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  document.getElementById('ht-timeline-display').innerHTML = html;
}

// Change view type
function htChangeView(viewType) {
  htCurrentView = viewType;
  
  // Update button styles
  ['list', 'timeline', 'grid'].forEach(view => {
    const btn = document.getElementById(`ht-view-${view}`);
    if (btn) {
      btn.style.background = view === viewType ? 'rgba(45,212,255,0.1)' : 'rgba(255,255,255,0.05)';
      btn.style.borderColor = view === viewType ? 'rgba(45,212,255,0.3)' : 'rgba(255,255,255,0.1)';
      btn.style.color = view === viewType ? 'var(--accent)' : 'inherit';
    }
  });
  
  htRenderTimeline();
}

// Apply filters
function htApplyFilters() {
  htRenderTimeline();
  htUpdateStatistics();
}

// Search events
function htSearchEvents() {
  const searchTerm = document.getElementById('ht-search').value.toLowerCase().trim();
  if (!searchTerm) return;
  
  const results = htEvents.filter(event => 
    event.event.toLowerCase().includes(searchTerm) ||
    (event.description && event.description.toLowerCase().includes(searchTerm)) ||
    event.category.includes(searchTerm) ||
    event.region.includes(searchTerm)
  );
  
  if (results.length === 0) {
    htShowMessage(`No events found for "${searchTerm}"`, 'info');
    return;
  }
  
  // Create a modal to show search results
  let modalHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:var(--panel);border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="font-weight:600;color:var(--accent);font-size:18px;">Search Results: "${searchTerm}"</div>
          <button onclick="document.querySelector('.ht-search-modal').remove()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px;">Ã—</button>
        </div>
        
        <div style="margin-bottom:20px;color:var(--muted);">
          Found ${results.length} event${results.length !== 1 ? 's' : ''}
        </div>
  `;
  
  results.forEach(event => {
    modalHtml += `
      <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:4px solid ${htGetCategoryColor(event.category)};">
        <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">${event.event}</div>
        <div style="font-size:12px;color:var(--muted);">
          ${event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`} â€¢ ${htGetCategoryName(event.category)}
        </div>
      </div>
    `;
  });
  
  modalHtml += `
        <div style="margin-top:20px;text-align:right;">
          <button onclick="document.querySelector('.ht-search-modal').remove()" style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'ht-search-modal';
  modal.innerHTML = modalHtml;
  document.body.appendChild(modal);
}

// Load predefined events
function htLoadPredefined(category) {
  if (!htPredefinedEvents[category]) return;
  
  // Check if events already exist
  const existingTitles = new Set(htEvents.map(e => e.event.toLowerCase()));
  const newEvents = htPredefinedEvents[category].filter(e => 
    !existingTitles.has(e.event.toLowerCase())
  );
  
  if (newEvents.length === 0) {
    htShowMessage('All events from this category are already in your timeline', 'info');
    return;
  }
  
  // Add new events
  newEvents.forEach(event => {
    const newEvent = {
      ...event,
      id: Date.now() + Math.random().toString(36).substr(2, 9),
      createdAt: new Date().toISOString()
    };
    htEvents.push(newEvent);
  });
  
  htSaveTimeline();
  htRenderTimeline();
  htUpdateStatistics();
  
  if (!document.getElementById('ht-timeline-container').style.display || 
      document.getElementById('ht-timeline-container').style.display === 'none') {
    htShowTimelineContainer();
  }
  
  htShowMessage(`Added ${newEvents.length} historical events from ${category}`, 'success');
}

// Update statistics
function htUpdateStatistics() {
  if (htEvents.length === 0) {
    document.getElementById('ht-total-events').textContent = '0';
    document.getElementById('ht-time-span').textContent = '0 years';
    document.getElementById('ht-events-per-year').textContent = '0.0';
    document.getElementById('ht-most-active-year').textContent = '--';
    return;
  }
  
  // Total events
  document.getElementById('ht-total-events').textContent = htEvents.length;
  
  // Time span
  const years = htEvents.map(e => e.year);
  const minYear = Math.min(...years);
  const maxYear = Math.max(...years);
  const timeSpan = maxYear - minYear;
  document.getElementById('ht-time-span').textContent = `${timeSpan} years`;
  
  // Events per year
  const eventsPerYear = (htEvents.length / timeSpan).toFixed(2);
  document.getElementById('ht-events-per-year').textContent = eventsPerYear;
  
  // Most active year
  const yearCounts = {};
  htEvents.forEach(e => {
    yearCounts[e.year] = (yearCounts[e.year] || 0) + 1;
  });
  
  let mostActiveYear = null;
  let maxCount = 0;
  for (const [year, count] of Object.entries(yearCounts)) {
    if (count > maxCount) {
      maxCount = count;
      mostActiveYear = year;
    }
  }
  
  if (mostActiveYear) {
    const yearText = mostActiveYear < 0 ? `${Math.abs(mostActiveYear)} BCE` : `${mostActiveYear} CE`;
    document.getElementById('ht-most-active-year').textContent = yearText;
  }
  
  // Category distribution chart
  htUpdateCategoryChart();
}

// Update category distribution chart
function htUpdateCategoryChart() {
  const categoryCounts = {};
  htEvents.forEach(e => {
    categoryCounts[e.category] = (categoryCounts[e.category] || 0) + 1;
  });
  
  const totalEvents = htEvents.length;
  const chartContainer = document.getElementById('ht-category-chart');
  const legendContainer = document.getElementById('ht-category-legend');
  
  if (totalEvents === 0) {
    chartContainer.innerHTML = '';
    legendContainer.innerHTML = '';
    return;
  }
  
  // Create chart bars
  let chartHtml = '';
  let legendHtml = '';
  
  Object.entries(categoryCounts).forEach(([category, count]) => {
    const percentage = (count / totalEvents) * 100;
    const color = htGetCategoryColor(category);
    
    chartHtml += `
      <div style="flex:${percentage}%;background:${color};" title="${htGetCategoryName(category)}: ${count} events (${percentage.toFixed(1)}%)"></div>
    `;
    
    legendHtml += `
      <div style="display:flex;align-items:center;gap:4px;">
        <div style="width:12px;height:12px;background:${color};border-radius:2px;"></div>
        <span>${htGetCategoryName(category)} (${count})</span>
      </div>
    `;
  });
  
  chartContainer.innerHTML = chartHtml;
  legendContainer.innerHTML = legendHtml;
}

// Show event details modal
function htShowEventDetails(eventId) {
  const event = htEvents.find(e => e.id === eventId);
  if (!event) return;
  
  const categoryColor = htGetCategoryColor(event.category);
  const yearText = event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`;
  const significanceStars = 'â˜…'.repeat(event.significance);
  
  let modalHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:var(--panel);border-radius:12px;padding:24px;max-width:500px;width:90%;max-height:80vh;overflow-y:auto;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
          <div style="font-weight:600;color:var(--accent);font-size:18px;">Event Details</div>
          <button onclick="document.querySelector('.ht-event-modal').remove()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px;">Ã—</button>
        </div>
        
        <div style="margin-bottom:20px;">
          <div style="font-size:24px;font-weight:600;color:white;margin-bottom:8px;">${event.event}</div>
          <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
            <div style="font-size:20px;font-weight:600;color:${categoryColor};">${yearText}</div>
            <div style="color:#ffcc00;font-size:16px;">${significanceStars}</div>
          </div>
          
          <div style="display:flex;gap:8px;margin-bottom:16px;">
            <div style="font-size:12px;padding:4px 10px;background:${categoryColor}20;color:${categoryColor};border-radius:6px;">
              ${htGetCategoryName(event.category)}
            </div>
            <div style="font-size:12px;padding:4px 10px;background:rgba(255,255,255,0.1);color:var(--muted);border-radius:6px;">
              ${htGetRegionName(event.region)}
            </div>
          </div>
          
          ${event.description ? `
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;color:var(--accent);margin-bottom:8px;">Description</div>
              <div style="color:var(--muted);line-height:1.5;background:rgba(255,255,255,0.02);padding:12px;border-radius:8px;">${event.description}</div>
            </div>
          ` : ''}
          
          ${event.sources ? `
            <div style="margin-bottom:20px;">
              <div style="font-size:12px;color:var(--accent);margin-bottom:8px;">Sources</div>
              <div style="color:var(--muted);font-size:13px;">${event.sources}</div>
            </div>
          ` : ''}
          
          <div style="font-size:11px;color:var(--muted);margin-top:20px;">
            Added: ${new Date(event.createdAt).toLocaleDateString()}
          </div>
        </div>
        
        <div style="display:flex;gap:10px;margin-top:20px;">
          <button onclick="htEditEvent('${event.id}')" style="flex:1;padding:10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            Edit
          </button>
          <button onclick="htDeleteEvent('${event.id}')" style="flex:1;padding:10px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">
            Delete
          </button>
          <button onclick="document.querySelector('.ht-event-modal').remove()" style="padding:10px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'ht-event-modal';
  modal.innerHTML = modalHtml;
  document.body.appendChild(modal);
}

// Edit event
function htEditEvent(eventId) {
  const event = htEvents.find(e => e.id === eventId);
  if (!event) return;
  
  // Populate form with event data
  document.getElementById('ht-event').value = event.event;
  document.getElementById('ht-year').value = event.year;
  document.getElementById('ht-month').value = event.month || '';
  document.getElementById('ht-category').value = event.category;
  document.getElementById('ht-region').value = event.region;
  document.getElementById('ht-significance').value = event.significance;
  document.getElementById('ht-description').value = event.description || '';
  document.getElementById('ht-sources').value = event.sources || '';
  
  // Remove event from array
  htEvents = htEvents.filter(e => e.id !== eventId);
  
  // Close modal if open
  const modal = document.querySelector('.ht-event-modal');
  if (modal) modal.remove();
  
  htShowMessage(`Editing "${event.event}"`, 'info');
}

// Delete event
function htDeleteEvent(eventId) {
  if (!confirm('Are you sure you want to delete this event?')) return;
  
  const event = htEvents.find(e => e.id === eventId);
  htEvents = htEvents.filter(e => e.id !== eventId);
  
  htSaveTimeline();
  htRenderTimeline();
  htUpdateStatistics();
  
  // Close modal if open
  const modal = document.querySelector('.ht-event-modal');
  if (modal) modal.remove();
  
  if (event) {
    htShowMessage(`"${event.event}" deleted from timeline`, 'success');
  }
}

// Generate quiz
function htGenerateQuiz() {
  if (htEvents.length < 3) {
    htShowMessage('Add at least 3 events to generate a quiz', 'error');
    return;
  }
  
  // Select random events for quiz
  const quizEvents = [...htEvents]
    .sort(() => Math.random() - 0.5)
    .slice(0, Math.min(10, htEvents.length));
  
  let quizHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:var(--panel);border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="font-weight:600;color:var(--accent);font-size:18px;">History Quiz</div>
          <button onclick="document.querySelector('.ht-quiz-modal').remove()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px;">Ã—</button>
        </div>
        
        <div style="margin-bottom:20px;color:var(--muted);">
          Test your knowledge! ${quizEvents.length} questions based on your timeline.
        </div>
        
        <div style="counter-reset: quiz-question;">
  `;
  
  quizEvents.forEach((event, index) => {
    // Get 3 random wrong answers (different years)
    const wrongAnswers = [...htEvents]
      .filter(e => e.id !== event.id && e.year !== event.year)
      .sort(() => Math.random() - 0.5)
      .slice(0, 3)
      .map(e => e.year);
    
    // Combine with correct answer and shuffle
    const allAnswers = [...wrongAnswers, event.year]
      .sort(() => Math.random() - 0.5)
      .map(year => ({
        year,
        isCorrect: year === event.year,
        display: year < 0 ? `${Math.abs(year)} BCE` : `${year} CE`
      }));
    
    quizHtml += `
      <div style="margin-bottom:24px;padding-bottom:24px;border-bottom:1px solid rgba(255,255,255,0.1);">
        <div style="font-weight:600;color:white;margin-bottom:12px;display:flex;align-items:flex-start;gap:8px;">
          <span style="color:var(--accent);">${index + 1}.</span>
          <span>${event.event}</span>
        </div>
        
        <div style="color:var(--muted);font-size:13px;margin-bottom:16px;">
          ${event.description ? event.description.substring(0, 150) + '...' : 'No description available.'}
        </div>
        
        <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;">
    `;
    
    allAnswers.forEach((answer, i) => {
      quizHtml += `
        <button onclick="htCheckQuizAnswer(this, ${answer.isCorrect})" 
                style="padding:10px;text-align:left;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;transition:all 0.2s;">
          ${String.fromCharCode(65 + i)}) ${answer.display}
        </button>
      `;
    });
    
    quizHtml += `
        </div>
      </div>
    `;
  });
  
  quizHtml += `
        </div>
        
        <div style="margin-top:20px;text-align:center;">
          <div style="font-size:14px;color:var(--muted);margin-bottom:12px;">Score: <span id="ht-quiz-score">0/${quizEvents.length}</span></div>
          <button onclick="document.querySelector('.ht-quiz-modal').remove()" style="padding:10px 20px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            Close Quiz
          </button>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'ht-quiz-modal';
  modal.innerHTML = quizHtml;
  document.body.appendChild(modal);
}

function htCheckQuizAnswer(button, isCorrect) {
  const scoreElement = document.getElementById('ht-quiz-score');
  const [current, total] = scoreElement.textContent.split('/').map(Number);
  
  if (isCorrect) {
    button.style.background = 'rgba(57,255,20,0.2)';
    button.style.borderColor = 'rgba(57,255,20,0.4)';
    button.style.color = '#39ff14';
    scoreElement.textContent = `${current + 1}/${total}`;
  } else {
    button.style.background = 'rgba(255,77,77,0.2)';
    button.style.borderColor = 'rgba(255,77,77,0.4)';
    button.style.color = '#ff4d4d';
  }
  
  button.disabled = true;
}

// Generate summary
function htGenerateSummary() {
  if (htEvents.length === 0) {
    htShowMessage('No events to summarize', 'error');
    return;
  }
  
  const sortedEvents = [...htEvents].sort((a, b) => a.year - b.year);
  const minYear = sortedEvents[0].year;
  const maxYear = sortedEvents[sortedEvents.length - 1].year;
  
  let summaryHtml = `
    <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
      <div style="background:var(--panel);border-radius:12px;padding:24px;max-width:600px;width:90%;max-height:80vh;overflow-y:auto;border:1px solid var(--border);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
          <div style="font-weight:600;color:var(--accent);font-size:18px;">Timeline Summary</div>
          <button onclick="document.querySelector('.ht-summary-modal').remove()" style="background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:20px;">Ã—</button>
        </div>
        
        <div style="margin-bottom:20px;color:var(--muted);">
          Summary of your timeline (${htEvents.length} events from ${minYear < 0 ? `${Math.abs(minYear)} BCE` : `${minYear} CE`} to ${maxYear < 0 ? `${Math.abs(maxYear)} BCE` : `${maxYear} CE`})
        </div>
        
        <div style="margin-bottom:24px;">
          <div style="font-size:14px;color:var(--accent);margin-bottom:12px;">Key Events:</div>
  `;
  
  // Show top 5 most significant events
  const topEvents = [...htEvents]
    .sort((a, b) => b.significance - a.significance)
    .slice(0, 5);
  
  topEvents.forEach((event, index) => {
    const yearText = event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`;
    summaryHtml += `
      <div style="margin-bottom:12px;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:4px solid ${htGetCategoryColor(event.category)};">
        <div style="font-weight:600;color:white;margin-bottom:4px;">${yearText}: ${event.event}</div>
        <div style="font-size:12px;color:var(--muted);">${htGetCategoryName(event.category)} â€¢ ${'â˜…'.repeat(event.significance)}</div>
      </div>
    `;
  });
  
  // Category breakdown
  const categoryCounts = {};
  htEvents.forEach(e => {
    categoryCounts[e.category] = (categoryCounts[e.category] || 0) + 1;
  });
  
  summaryHtml += `
        </div>
        
        <div>
          <div style="font-size:14px;color:var(--accent);margin-bottom:12px;">Category Breakdown:</div>
          <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:8px;">
  `;
  
  Object.entries(categoryCounts).forEach(([category, count]) => {
    const percentage = ((count / htEvents.length) * 100).toFixed(1);
    summaryHtml += `
      <div style="text-align:center;padding:8px;background:rgba(255,255,255,0.02);border-radius:6px;">
        <div style="font-size:20px;color:${htGetCategoryColor(category)};">${htGetCategoryIcon(category)}</div>
        <div style="font-size:12px;color:white;">${htGetCategoryName(category)}</div>
        <div style="font-size:11px;color:var(--muted);">${count} (${percentage}%)</div>
      </div>
    `;
  });
  
  summaryHtml += `
          </div>
        </div>
        
        <div style="margin-top:20px;text-align:right;">
          <button onclick="htExportSummary()" style="padding:8px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;margin-right:8px;">
            Export Summary
          </button>
          <button onclick="document.querySelector('.ht-summary-modal').remove()" style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
            Close
          </button>
        </div>
      </div>
    </div>
  `;
  
  const modal = document.createElement('div');
  modal.className = 'ht-summary-modal';
  modal.innerHTML = summaryHtml;
  document.body.appendChild(modal);
}

function htExportSummary() {
  if (htEvents.length === 0) {
    htShowMessage('No events to export', 'error');
    return;
  }
  
  const sortedEvents = [...htEvents].sort((a, b) => a.year - b.year);
  let summaryText = `HISTORY TIMELINE SUMMARY\n`;
  summaryText += `Generated: ${new Date().toLocaleDateString()}\n`;
  summaryText += `Total Events: ${htEvents.length}\n\n`;
  summaryText += `TIMELINE EVENTS:\n`;
  summaryText += `================\n\n`;
  
  sortedEvents.forEach(event => {
    const yearText = event.year < 0 ? `${Math.abs(event.year)} BCE` : `${event.year} CE`;
    const significanceStars = 'â˜…'.repeat(event.significance);
    summaryText += `${yearText}: ${event.event}\n`;
    summaryText += `  Category: ${htGetCategoryName(event.category)}\n`;
    summaryText += `  Significance: ${significanceStars}\n`;
    if (event.description) {
      summaryText += `  Description: ${event.description}\n`;
    }
    summaryText += '\n';
  });
  
  const dataStr = 'data:text/plain;charset=utf-8,' + encodeURIComponent(summaryText);
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute('href', dataStr);
  downloadAnchorNode.setAttribute('download', `timeline-summary-${new Date().toISOString().split('T')[0]}.txt`);
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
  
  htShowMessage('Summary exported successfully', 'success');
}

// Export timeline
function htExportTimeline() {
  if (htEvents.length === 0) {
    htShowMessage('No events to export', 'error');
    return;
  }
  
  const data = {
    timeline: htEvents,
    metadata: {
      exported: new Date().toISOString(),
      totalEvents: htEvents.length,
      version: '1.0'
    }
  };
  
  const dataStr = 'data:application/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(data, null, 2));
  const downloadAnchorNode = document.createElement('a');
  downloadAnchorNode.setAttribute('href', dataStr);
  downloadAnchorNode.setAttribute('download', `history-timeline-${new Date().toISOString().split('T')[0]}.json`);
  document.body.appendChild(downloadAnchorNode);
  downloadAnchorNode.click();
  downloadAnchorNode.remove();
  
  htShowMessage('Timeline exported successfully', 'success');
}

// Import data
function htImportData() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
      try {
        const data = JSON.parse(e.target.result);
        if (!data.timeline || !Array.isArray(data.timeline)) {
          throw new Error('Invalid timeline file format');
        }
        
        // Merge events (avoid duplicates by ID)
        const existingIds = new Set(htEvents.map(e => e.id));
        const newEvents = data.timeline.filter(e => !existingIds.has(e.id));
        
        if (newEvents.length === 0) {
          htShowMessage('All events in the file already exist in your timeline', 'info');
          return;
        }
        
        htEvents.push(...newEvents);
        htSaveTimeline();
        htRenderTimeline();
        htUpdateStatistics();
        
        if (!document.getElementById('ht-timeline-container').style.display || 
            document.getElementById('ht-timeline-container').style.display === 'none') {
          htShowTimelineContainer();
        }
        
        htShowMessage(`Imported ${newEvents.length} new events from file`, 'success');
      } catch (error) {
        htShowMessage('Error importing file: ' + error.message, 'error');
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
}

// Reset all data
function htResetAll() {
  if (!confirm('Are you sure you want to reset all timeline data? This cannot be undone.')) return;
  
  htEvents = [];
  localStorage.removeItem('ht-timeline');
  
  document.getElementById('ht-timeline-container').style.display = 'none';
  document.getElementById('ht-statistics-container').style.display = 'none';
  document.getElementById('ht-timeline-display').innerHTML = `
    <div style="text-align:center;padding:40px;color:var(--muted);font-style:italic;">
      No events added yet. Add your first historical event above!
    </div>
  `;
  
  htUpdateStatistics();
  htClearForm();
  
  htShowMessage('All timeline data has been reset', 'info');
}

// Helper functions
function htGetCategoryColor(category) {
  const colors = {
    'politics': '#FF6B6B',
    'war': '#118AB2',
    'science': '#4ECDC4',
    'culture': '#FFD166',
    'religion': '#06D6A0',
    'economics': '#9D4EDD',
    'exploration': '#FF9E6D',
    'social': '#A663CC',
    'sports': '#EF476F',
    'other': '#6A994E'
  };
  return colors[category] || '#666666';
}

function htGetCategoryIcon(category) {
  const icons = {
    'politics': 'ğŸ›ï¸',
    'war': 'âš”ï¸',
    'science': 'ğŸ”¬',
    'culture': 'ğŸ­',
    'religion': 'â›ª',
    'economics': 'ğŸ’°',
    'exploration': 'ğŸ—ºï¸',
    'social': 'ğŸ‘¥',
    'sports': 'âš½',
    'other': 'ğŸ“‹'
  };
  return icons[category] || 'ğŸ“‹';
}

function htGetCategoryName(category) {
  const names = {
    'politics': 'Politics',
    'war': 'War & Conflict',
    'science': 'Science & Tech',
    'culture': 'Culture & Arts',
    'religion': 'Religion',
    'economics': 'Economics',
    'exploration': 'Exploration',
    'social': 'Social',
    'sports': 'Sports',
    'other': 'Other'
  };
  return names[category] || 'Other';
}

function htGetRegionName(region) {
  const names = {
    'global': 'Global',
    'europe': 'Europe',
    'asia': 'Asia',
    'africa': 'Africa',
    'americas': 'Americas',
    'middle-east': 'Middle East',
    'oceania': 'Oceania'
  };
  return names[region] || region;
}

function htGetMonthName(monthNum) {
  const months = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];
  const monthIndex = parseInt(monthNum) - 1;
  return months[monthIndex] || '';
}

function htShowMessage(message, type = 'info') {
  const card = document.currentScript?.closest('.card') || document;
  
  // Remove existing message
  const existingMsg = card.querySelector('.ht-message');
  if (existingMsg) existingMsg.remove();
  
  // Create message element
  const messageEl = document.createElement('div');
  messageEl.className = 'ht-message';
  messageEl.style.cssText = `
    position:fixed;
    top:20px;
    right:20px;
    padding:12px 16px;
    border-radius:8px;
    background:${type === 'error' ? 'rgba(255,77,77,0.9)' : 
               type === 'success' ? 'rgba(57,255,20,0.9)' : 
               'rgba(45,212,255,0.9)'};
    color:#ffffff;
    z-index:10000;
    backdrop-filter:blur(4px);
    animation:htSlideIn 0.3s ease;
  `;
  
  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes htSlideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes htFadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  messageEl.textContent = message;
  document.body.appendChild(messageEl);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    messageEl.style.animation = 'htFadeOut 0.3s ease';
    setTimeout(() => messageEl.remove(), 300);
  }, 3000);
}
</script>

<style>
#history-timeline-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.3rem;
  display: flex;
  align-items: center;
  gap: 10px;
}

@media (max-width: 768px) {
  .ht-form-grid {
    grid-template-columns: 1fr !important;
  }
  
  #ht-timeline-display .timeline-event {
    width: 100% !important;
    margin-left: 0 !important;
  }
  
  .ht-controls {
    flex-direction: column;
  }
  
  .ht-controls select, .ht-controls input {
    width: 100% !important;
  }
}
</style>
