<h2 id="interval-trainer-title" style="margin-top:0;color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:8px;">
  üéµ Interval Ear Trainer
  <span style="font-size:14px;color:var(--muted);display:block;margin-top:4px;">
    Train your musical ear to recognize intervals instantly!
  </span>
</h2>

<form aria-describedby="interval-trainer-desc">
  <p id="interval-trainer-desc" class="small" style="color:var(--muted);margin-bottom:20px;">
    <strong style="color:var(--accent)">Essential for musicians:</strong> Learn to identify intervals by ear. Perfect for singers, composers, and anyone learning music theory!
  </p>

  <!-- INTERACTIVE INTERVAL SELECTOR -->
  <div style="margin-bottom:24px;">
    <div style="color:var(--accent);font-weight:500;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      üéØ Select Interval to Practice
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:8px;margin-bottom:16px;">
      <!-- Perfect Intervals -->
      <button type="button" onclick="selectInterval('perfect4')" class="interval-btn" data-interval="perfect4" style="background:rgba(45,212,255,0.15);border:2px solid rgba(45,212,255,0.3);">
        <div style="font-size:18px;font-weight:600;">P4</div>
        <div style="font-size:12px;color:var(--muted);">Perfect 4th</div>
        <div style="font-size:10px;color:var(--accent);">5 semitones</div>
      </button>
      
      <button type="button" onclick="selectInterval('perfect5')" class="interval-btn active" data-interval="perfect5" style="background:rgba(57,255,20,0.15);border:2px solid rgba(57,255,20,0.3);">
        <div style="font-size:18px;font-weight:600;">P5</div>
        <div style="font-size:12px;color:var(--muted);">Perfect 5th</div>
        <div style="font-size:10px;color:#39ff14;">7 semitones</div>
      </button>
      
      <!-- Thirds -->
      <button type="button" onclick="selectInterval('major3')" class="interval-btn" data-interval="major3" style="background:rgba(255,165,0,0.15);border:2px solid rgba(255,165,0,0.3);">
        <div style="font-size:18px;font-weight:600;">M3</div>
        <div style="font-size:12px;color:var(--muted);">Major 3rd</div>
        <div style="font-size:10px;color:#ffa500;">4 semitones</div>
      </button>
      
      <button type="button" onclick="selectInterval('minor3')" class="interval-btn" data-interval="minor3" style="background:rgba(157,78,221,0.15);border:2px solid rgba(157,78,221,0.3);">
        <div style="font-size:18px;font-weight:600;">m3</div>
        <div style="font-size:12px;color:var(--muted);">Minor 3rd</div>
        <div style="font-size:10px;color:#9d4edd;">3 semitones</div>
      </button>
      
      <!-- Sixths -->
      <button type="button" onclick="selectInterval('major6')" class="interval-btn" data-interval="major6">
        <div style="font-size:18px;font-weight:600;">M6</div>
        <div style="font-size:12px;color:var(--muted);">Major 6th</div>
        <div style="font-size:10px;color:var(--muted);">9 semitones</div>
      </button>
      
      <button type="button" onclick="selectInterval('minor6')" class="interval-btn" data-interval="minor6">
        <div style="font-size:18px;font-weight:600;">m6</div>
        <div style="font-size:12px;color:var(--muted);">Minor 6th</div>
        <div style="font-size:10px;color:var(--muted);">8 semitones</div>
      </button>
      
      <!-- Others -->
      <button type="button" onclick="selectInterval('octave')" class="interval-btn" data-interval="octave">
        <div style="font-size:18px;font-weight:600;">P8</div>
        <div style="font-size:12px;color:var(--muted);">Octave</div>
        <div style="font-size:10px;color:var(--muted);">12 semitones</div>
      </button>
      
      <button type="button" onclick="selectInterval('tritone')" class="interval-btn" data-interval="tritone">
        <div style="font-size:18px;font-weight:600;">TT</div>
        <div style="font-size:12px;color:var(--muted);">Tritone</div>
        <div style="font-size:10px;color:var(--muted);">6 semitones</div>
      </button>
    </div>
    
    <!-- DIFFICULTY SELECTOR -->
    <div style="margin-bottom:20px;">
      <div style="color:var(--accent);font-weight:500;margin-bottom:8px;display:flex;align-items:center;gap:8px;">
        üéöÔ∏è Difficulty Level
      </div>
      <div style="display:flex;background:rgba(255,255,255,0.05);border-radius:10px;padding:4px;">
        <button id="easy-btn" type="button" onclick="setDifficulty('easy')" 
                style="flex:1;padding:8px;border:none;background:rgba(57,255,20,0.2);color:#39ff14;border-radius:6px;cursor:pointer;font-weight:500;">
          Easy (C Major)
        </button>
        <button id="medium-btn" type="button" onclick="setDifficulty('medium')" 
                style="flex:1;padding:8px;border:none;background:rgba(255,165,0,0.2);color:#ffa500;border-radius:6px;cursor:pointer;font-weight:500;">
          Medium (All Keys)
        </button>
        <button id="hard-btn" type="button" onclick="setDifficulty('hard')" 
                style="flex:1;padding:8px;border:none;background:rgba(255,45,85,0.2);color:#ff2d55;border-radius:6px;cursor:pointer;font-weight:500;">
          Hard (Chromatic)
        </button>
      </div>
    </div>
  </div>

  <!-- MUSICAL KEYBOARD VISUALIZATION -->
  <div style="margin-bottom:24px;background:rgba(20,20,20,0.6);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
    <div style="color:var(--accent);font-weight:500;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      üéπ Visual Interval
    </div>
    
    <div id="keyboard-visual" style="position:relative;height:80px;background:rgba(0,0,0,0.3);border-radius:8px;overflow:hidden;margin-bottom:12px;">
      <!-- Keyboard will be generated by JavaScript -->
    </div>
    
    <div id="interval-info" style="text-align:center;">
      <div style="font-size:24px;font-weight:700;color:var(--accent);margin:4px 0;">
        <span id="current-interval">Perfect 5th</span>
      </div>
      <div style="color:var(--muted);font-size:14px;">
        <span id="semitones">7 semitones</span> ‚Ä¢ 
        <span id="interval-example">"Twinkle Twinkle" opening</span>
    </div>
    </div>
  </div>

  <!-- PRACTICE MODE -->
  <div style="margin-bottom:24px;">
    <div style="color:var(--accent);font-weight:500;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      üéÆ Practice Mode
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <button type="button" onclick="generateRandomInterval()" 
              style="padding:14px;background:linear-gradient(135deg, var(--accent), rgba(57,255,20,0.8));border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;">
        üé≤ Random Interval
      </button>
      
      <button type="button" onclick="playInterval()" id="play-btn"
              style="padding:14px;background:linear-gradient(135deg, #9d4edd, rgba(255,45,85,0.8));border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600;display:flex;align-items:center;justify-content:center;gap:8px;">
        üîä Play Sound
      </button>
    </div>
    
    <!-- GUESS THE INTERVAL GAME -->
    <div id="game-section" style="margin-top:16px;display:none;">
      <div style="text-align:center;color:var(--muted);margin-bottom:8px;">Guess the interval:</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;justify-content:center;">
        <button type="button" onclick="guessInterval('perfect4')" class="guess-btn">P4</button>
        <button type="button" onclick="guessInterval('perfect5')" class="guess-btn">P5</button>
        <button type="button" onclick="guessInterval('major3')" class="guess-btn">M3</button>
        <button type="button" onclick="guessInterval('minor3')" class="guess-btn">m3</button>
        <button type="button" onclick="guessInterval('octave')" class="guess-btn">P8</button>
      </div>
      <div id="game-feedback" style="text-align:center;margin-top:8px;min-height:24px;"></div>
    </div>
  </div>

  <!-- RESULTS & PROGRESS -->
  <div class="results" aria-live="polite" style="background:linear-gradient(135deg, rgba(45,212,255,0.05), rgba(57,255,20,0.05));border-radius:12px;padding:20px;border:1px solid rgba(45,212,255,0.2);margin-bottom:20px;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      <div style="text-align:center;padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;">
        <div style="color:var(--muted);font-size:12px;">Today's Score</div>
        <div id="score-today" style="color:var(--accent);font-size:24px;font-weight:700;">0</div>
      </div>
      <div style="text-align:center;padding:12px;background:rgba(57,255,20,0.1);border-radius:8px;">
        <div style="color:var(--muted);font-size:12px;">Best Streak</div>
        <div id="best-streak" style="color:#39ff14;font-size:24px;font-weight:700;">0</div>
      </div>
      <div style="text-align:center;padding:12px;background:rgba(255,165,0,0.1);border-radius:8px;">
        <div style="color:var(--muted);font-size:12px;">Accuracy</div>
        <div id="accuracy" style="color:#ffa500;font-size:24px;font-weight:700;">0%</div>
      </div>
    </div>
    
    <textarea id="interval-output" rows="4" style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.08);background:rgba(0,0,0,0.3);color:inherit;font-family:monospace;"></textarea>
  </div>

  <!-- INTERVAL FACTS & EXAMPLES -->
  <details style="margin-bottom:16px;">
    <summary style="color:var(--accent);font-weight:500;cursor:pointer;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;display:flex;align-items:center;gap:8px;">
      üìö Interval Facts & Famous Examples
    </summary>
    <div id="interval-facts-container" style="margin-top:12px;padding:16px;background:rgba(20,20,20,0.6);border-radius:8px;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
        <div>
          <h4 style="color:var(--accent);margin-top:0;margin-bottom:8px;">üéµ Perfect Intervals</h4>
          <ul style="list-style:none;padding:0;margin:0;">
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:#39ff14;font-weight:600;">P4 (5 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"Here Comes the Bride" opening</div>
            </li>
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:#39ff14;font-weight:600;">P5 (7 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"Twinkle Twinkle Little Star"</div>
            </li>
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:#39ff14;font-weight:600;">P8 (12 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"Somewhere Over the Rainbow"</div>
            </li>
          </ul>
        </div>
        
        <div>
          <h4 style="color:var(--accent);margin-top:0;margin-bottom:8px;">üéµ Thirds & Sixths</h4>
          <ul style="list-style:none;padding:0;margin:0;">
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:#ffa500;font-weight:600;">M3 (4 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"When the Saints Go Marching In"</div>
            </li>
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:#9d4edd;font-weight:600;">m3 (3 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"Greensleeves" opening</div>
            </li>
            <li style="margin-bottom:6px;padding-left:12px;position:relative;">
              <span style="color:var(--accent);font-weight:600;">M6 (9 semitones):</span>
              <div style="color:var(--muted);font-size:13px;">"My Bonnie Lies Over the Ocean"</div>
            </li>
          </ul>
        </div>
      </div>
      
      <div style="margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
        <h4 style="color:var(--accent);margin-top:0;margin-bottom:8px;">üí° Pro Tips</h4>
        <ul style="list-style:disc;padding-left:20px;font-size:0.9rem;line-height:1.5;color:var(--muted);">
          <li>Practice 10 minutes daily for best results</li>
          <li>Sing intervals to internalize them</li>
          <li>Associate each interval with a familiar song</li>
          <li>Perfect pitch isn't necessary - relative pitch is learnable!</li>
        </ul>
      </div>
    </div>
  </details>

  <!-- ACTION BUTTONS -->
  <div style="display:flex;gap:10px;margin-top:20px;">
    <button type="button" onclick="startPracticeSession()" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, var(--accent), rgba(57,255,20,0.8));border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;">
      üéØ Start Practice Session
    </button>
    <button type="button" onclick="shareProgress()" 
            style="padding:14px 20px;background:linear-gradient(135deg, #9d4edd, rgba(255,45,85,0.8));border:none;border-radius:10px;color:white;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;">
      üì§ Share Progress
    </button>
  </div>
</form>

<!-- PROGRESS CHART -->
<div style="margin-top:24px;background:rgba(20,20,20,0.6);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
  <h3 style="color:var(--accent);margin-top:0;margin-bottom:12px;font-size:16px;display:flex;align-items:center;gap:8px;">
    üìà Your Progress
  </h3>
  
  <div id="progress-chart" style="height:60px;display:flex;align-items:flex-end;gap:4px;margin-bottom:12px;">
    <!-- Progress bars will be generated by JavaScript -->
  </div>
  
  <div style="display:flex;justify-content:space-between;color:var(--muted);font-size:12px;">
    <span>Mon</span>
    <span>Tue</span>
    <span>Wed</span>
    <span>Thu</span>
    <span>Fri</span>
    <span>Sat</span>
    <span>Sun</span>
  </div>
</div>

<script>
// Scoped functions with 'it' prefix (Interval Trainer)
let itCurrentInterval = 'perfect5';
let itCurrentDifficulty = 'medium';
let itScore = 0;
let itStreak = 0;
let itBestStreak = 0;
let itAttempts = 0;
let itCorrect = 0;
let itAudioContext = null;
let itPracticeActive = false;

// Interval definitions
const intervalDefinitions = {
  perfect4: { name: 'Perfect 4th', semitones: 5, color: '#2dd4ff', example: '"Here Comes the Bride" opening' },
  perfect5: { name: 'Perfect 5th', semitones: 7, color: '#39ff14', example: '"Twinkle Twinkle Little Star"' },
  major3: { name: 'Major 3rd', semitones: 4, color: '#ffa500', example: '"When the Saints Go Marching In"' },
  minor3: { name: 'Minor 3rd', semitones: 3, color: '#9d4edd', example: '"Greensleeves" opening' },
  major6: { name: 'Major 6th', semitones: 9, color: '#2dd4ff', example: '"My Bonnie Lies Over the Ocean"' },
  minor6: { name: 'Minor 6th', semitones: 8, color: '#ff2d55', example: '"The Entertainer" opening' },
  octave: { name: 'Octave', semitones: 12, color: '#39ff14', example: '"Somewhere Over the Rainbow"' },
  tritone: { name: 'Tritone', semitones: 6, color: '#ff2d55', example: '"The Simpsons" theme' }
};

// Notes for different difficulties
const notes = {
  easy: ['C', 'D', 'E', 'F', 'G', 'A', 'B'],
  medium: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'],
  hard: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B', 'C2', 'C#2', 'D2']
};

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', itInitialize);
} else {
  itInitialize();
}

function itInitialize() {
  console.log('Interval Trainer loaded');
  
  const card = document.currentScript?.closest('.card') || document;
  
  // Load saved progress
  loadProgress();
  
  // Initialize audio context (lazy load)
  if (typeof AudioContext !== 'undefined' || typeof webkitAudioContext !== 'undefined') {
    itAudioContext = new (AudioContext || webkitAudioContext)();
  }
  
  // Draw initial keyboard
  drawKeyboard();
  
  // Set initial interval
  selectInterval('perfect5');
  setDifficulty('medium');
  
  // Initialize progress chart
  drawProgressChart();
}

function loadProgress() {
  const saved = localStorage.getItem('interval-trainer-progress');
  if (saved) {
    try {
      const data = JSON.parse(saved);
      itScore = data.score || 0;
      itBestStreak = data.bestStreak || 0;
      itAttempts = data.attempts || 0;
      itCorrect = data.correct || 0;
      
      updateScoreDisplay();
    } catch (e) {
      console.error('Failed to load progress:', e);
    }
  }
}

function saveProgress() {
  const data = {
    score: itScore,
    bestStreak: itBestStreak,
    attempts: itAttempts,
    correct: itCorrect,
    lastPractice: new Date().toISOString()
  };
  localStorage.setItem('interval-trainer-progress', JSON.stringify(data));
}

function selectInterval(intervalId) {
  const card = document.currentScript?.closest('.card') || document;
  const buttons = card.querySelectorAll('.interval-btn');
  
  buttons.forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.borderColor = 'rgba(255,255,255,0.1)';
    btn.querySelector('div:first-child').style.color = 'var(--text)';
    btn.querySelector('div:nth-child(3)').style.color = 'var(--muted)';
  });
  
  const activeBtn = card.querySelector(`.interval-btn[data-interval="${intervalId}"]`);
  const interval = intervalDefinitions[intervalId];
  
  if (activeBtn && interval) {
    activeBtn.style.background = `${interval.color}20`;
    activeBtn.style.borderColor = `${interval.color}50`;
    activeBtn.querySelector('div:first-child').style.color = interval.color;
    activeBtn.querySelector('div:nth-child(3)').style.color = interval.color;
  }
  
  itCurrentInterval = intervalId;
  
  // Update display
  card.querySelector('#current-interval').textContent = interval.name;
  card.querySelector('#semitones').textContent = `${interval.semitones} semitones`;
  card.querySelector('#interval-example').textContent = interval.example;
  
  // Update keyboard
  drawKeyboard();
  
  // Update text output
  updateOutput();
}

function setDifficulty(level) {
  const card = document.currentScript?.closest('.card') || document;
  const easyBtn = card.querySelector('#easy-btn');
  const mediumBtn = card.querySelector('#medium-btn');
  const hardBtn = card.querySelector('#hard-btn');
  
  // Reset all buttons
  easyBtn.style.background = 'transparent';
  easyBtn.style.color = 'var(--muted)';
  mediumBtn.style.background = 'transparent';
  mediumBtn.style.color = 'var(--muted)';
  hardBtn.style.background = 'transparent';
  hardBtn.style.color = 'var(--muted)';
  
  // Activate selected button
  switch(level) {
    case 'easy':
      easyBtn.style.background = 'rgba(57,255,20,0.2)';
      easyBtn.style.color = '#39ff14';
      break;
    case 'medium':
      mediumBtn.style.background = 'rgba(255,165,0,0.2)';
      mediumBtn.style.color = '#ffa500';
      break;
    case 'hard':
      hardBtn.style.background = 'rgba(255,45,85,0.2)';
      hardBtn.style.color = '#ff2d55';
      break;
  }
  
  itCurrentDifficulty = level;
  drawKeyboard();
}

function drawKeyboard() {
  const card = document.currentScript?.closest('.card') || document;
  const keyboard = card.querySelector('#keyboard-visual');
  if (!keyboard) return;
  
  keyboard.innerHTML = '';
  
  const interval = intervalDefinitions[itCurrentInterval];
  const availableNotes = notes[itCurrentDifficulty];
  
  // Pick a random starting note
  const startIndex = Math.floor(Math.random() * Math.max(1, availableNotes.length - interval.semitones - 1));
  const startNote = availableNotes[startIndex];
  let endNote = availableNotes[startIndex + interval.semitones];
  
  if (!endNote) {
    endNote = availableNotes[interval.semitones];
  }
  
  // Create piano visual (simplified)
  const whiteKeys = 14;
  const keyWidth = keyboard.offsetWidth / whiteKeys;
  
  for (let i = 0; i < whiteKeys; i++) {
    const key = document.createElement('div');
    key.style.position = 'absolute';
    key.style.left = `${i * keyWidth}px`;
    key.style.width = `${keyWidth}px`;
    key.style.height = '100%';
    key.style.background = i % 7 === 2 || i % 7 === 6 ? 'rgba(255,255,255,0.9)' : 'rgba(255,255,255,0.95)';
    key.style.border = '1px solid rgba(0,0,0,0.2)';
    keyboard.appendChild(key);
    
    // Add black keys
    if (i % 7 !== 2 && i % 7 !== 6 && i < whiteKeys - 1) {
      const blackKey = document.createElement('div');
      blackKey.style.position = 'absolute';
      blackKey.style.left = `${(i + 0.7) * keyWidth}px`;
      blackKey.style.width = `${keyWidth * 0.6}px`;
      blackKey.style.height = '60%';
      blackKey.style.background = 'rgba(0,0,0,0.8)';
      keyboard.appendChild(blackKey);
    }
  }
  
  // Highlight interval
  const startKey = document.createElement('div');
  startKey.style.position = 'absolute';
  startKey.style.left = `${startIndex * keyWidth}px`;
  startKey.style.width = `${keyWidth}px`;
  startKey.style.height = '100%';
  startKey.style.background = `${interval.color}40`;
  startKey.style.border = `2px solid ${interval.color}`;
  startKey.style.display = 'flex';
  startKey.style.alignItems = 'center';
  startKey.style.justifyContent = 'center';
  startKey.style.color = interval.color;
  startKey.style.fontWeight = 'bold';
  startKey.textContent = startNote.replace('2', "'");
  keyboard.appendChild(startKey);
  
  const endKey = document.createElement('div');
  endKey.style.position = 'absolute';
  endKey.style.left = `${(startIndex + interval.semitones) * keyWidth}px`;
  endKey.style.width = `${keyWidth}px`;
  endKey.style.height = '100%';
  endKey.style.background = `${interval.color}40`;
  endKey.style.border = `2px solid ${interval.color}`;
  endKey.style.display = 'flex';
  endKey.style.alignItems = 'center';
  endKey.style.justifyContent = 'center';
  endKey.style.color = interval.color;
  endKey.style.fontWeight = 'bold';
  endKey.textContent = endNote.replace('2', "'");
  keyboard.appendChild(endKey);
  
  // Draw line connecting them
  const line = document.createElement('div');
  line.style.position = 'absolute';
  line.style.left = `${startIndex * keyWidth + keyWidth / 2}px`;
  line.style.top = '20px';
  line.style.width = `${interval.semitones * keyWidth}px`;
  line.style.height = '2px';
  line.style.background = interval.color;
  line.style.transformOrigin = '0 0';
  keyboard.appendChild(line);
}

function updateOutput() {
  const card = document.currentScript?.closest('.card') || document;
  const interval = intervalDefinitions[itCurrentInterval];
  
  const output = `üéµ Interval: ${interval.name}
üéº Semitones: ${interval.semitones}
üéπ Example: ${interval.example}
üìà Your Score: ${itScore}
üî• Best Streak: ${itBestStreak}

üí° Practice tip: Sing this interval daily!`;

  card.querySelector('#interval-output').value = output;
}

function generateRandomInterval() {
  const intervals = Object.keys(intervalDefinitions);
  const randomInterval = intervals[Math.floor(Math.random() * intervals.length)];
  selectInterval(randomInterval);
  
  // Show game section
  const card = document.currentScript?.closest('.card') || document;
  card.querySelector('#game-section').style.display = 'block';
  card.querySelector('#game-feedback').innerHTML = '';
  
  // Update output
  updateOutput();
  
  // Play the interval
  setTimeout(playInterval, 500);
}

function playInterval() {
  if (!itAudioContext) {
    alert('Audio not supported in this browser');
    return;
  }
  
  const interval = intervalDefinitions[itCurrentInterval];
  const frequency1 = 440; // A4
  const frequency2 = frequency1 * Math.pow(2, interval.semitones / 12);
  
  playNote(frequency1);
  setTimeout(() => playNote(frequency2), 800);
}

function playNote(frequency) {
  const oscillator = itAudioContext.createOscillator();
  const gainNode = itAudioContext.createGain();
  
  oscillator.connect(gainNode);
  gainNode.connect(itAudioContext.destination);
  
  oscillator.frequency.value = frequency;
  oscillator.type = 'sine';
  
  // Fade in/out
  gainNode.gain.setValueAtTime(0, itAudioContext.currentTime);
  gainNode.gain.linearRampToValueAtTime(0.3, itAudioContext.currentTime + 0.1);
  gainNode.gain.linearRampToValueAtTime(0, itAudioContext.currentTime + 0.7);
  
  oscillator.start(itAudioContext.currentTime);
  oscillator.stop(itAudioContext.currentTime + 0.7);
}

function guessInterval(guess) {
  const card = document.currentScript?.closest('.card') || document;
  const feedback = card.querySelector('#game-feedback');
  
  itAttempts++;
  
  if (guess === itCurrentInterval) {
    itCorrect++;
    itScore += 10;
    itStreak++;
    
    if (itStreak > itBestStreak) {
      itBestStreak = itStreak;
    }
    
    feedback.innerHTML = `<span style="color:#39ff14;font-weight:600;">‚úÖ Correct! +10 points</span>`;
    feedback.style.animation = 'pulse 0.5s';
    
    // Update score display
    updateScoreDisplay();
    saveProgress();
    
    // Generate new interval after delay
    setTimeout(generateRandomInterval, 1500);
  } else {
    itStreak = 0;
    feedback.innerHTML = `<span style="color:#ff2d55;font-weight:600;">‚ùå Try again! It was ${intervalDefinitions[itCurrentInterval].name}</span>`;
    
    // Update score display
    updateScoreDisplay();
    saveProgress();
  }
  
  setTimeout(() => {
    feedback.style.animation = '';
  }, 500);
}

function updateScoreDisplay() {
  const card = document.currentScript?.closest('.card') || document;
  
  card.querySelector('#score-today').textContent = itScore;
  card.querySelector('#best-streak').textContent = itBestStreak;
  
  const accuracy = itAttempts > 0 ? Math.round((itCorrect / itAttempts) * 100) : 0;
  card.querySelector('#accuracy').textContent = `${accuracy}%`;
}

function startPracticeSession() {
  const card = document.currentScript?.closest('.card') || document;
  const playBtn = card.querySelector('#play-btn');
  
  itPracticeActive = !itPracticeActive;
  
  if (itPracticeActive) {
    playBtn.innerHTML = '‚è∏Ô∏è Stop Practice';
    playBtn.style.background = 'linear-gradient(135deg, #ff2d55, rgba(255,165,0,0.8))';
    
    // Start practice loop
    generateRandomInterval();
  } else {
    playBtn.innerHTML = 'üéØ Start Practice Session';
    playBtn.style.background = 'linear-gradient(135deg, var(--accent), rgba(57,255,20,0.8))';
    card.querySelector('#game-section').style.display = 'none';
  }
}

function drawProgressChart() {
  const card = document.currentScript?.closest('.card') || document;
  const chart = card.querySelector('#progress-chart');
  if (!chart) return;
  
  chart.innerHTML = '';
  
  // Generate random progress for demo (in real app, load from localStorage)
  const days = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'];
  const maxHeight = 60;
  
  days.forEach(day => {
    const height = Math.floor(Math.random() * 50) + 10;
    const bar = document.createElement('div');
    bar.style.flex = '1';
    bar.style.height = `${height}px`;
    bar.style.background = `linear-gradient(to top, ${itCurrentDifficulty === 'easy' ? '#39ff14' : itCurrentDifficulty === 'medium' ? '#ffa500' : '#ff2d55'}, rgba(255,255,255,0.1))`;
    bar.style.borderRadius = '2px 2px 0 0';
    chart.appendChild(bar);
 
