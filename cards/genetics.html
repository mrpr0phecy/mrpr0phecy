<!-- cards/genetics-tools.html -->
<h2 id="genetics-tools-title" style="margin-top:0;color:var(--accent);">üß¨ Genetics Laboratory</h2>

<form aria-describedby="genetics-tools-desc">
  <p id="genetics-tools-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.8);">
    Explore genetics through interactive simulations, DNA analysis tools, and educational content.
    <span style="color:var(--accent);font-weight:500;">Perfect for students and enthusiasts!</span>
  </p>

  <!-- Tool Selection -->
  <div class="field" style="margin-bottom:16px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <label for="gen-tool" style="color:var(--accent);font-weight:500;">Genetics Tool</label>
      <span id="gen-tool-description" class="small" style="color:rgba(45,212,255,0.7);font-size:12px;">DNA sequence analysis</span>
    </div>
    <select id="gen-tool" 
            style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:15px;"
            onchange="genUpdateTool()">
      <option value="dna-analyzer" selected>DNA Sequence Analyzer</option>
      <option value="punnett-square">Punnett Square Generator</option>
      <option value="gc-content">GC Content Calculator</option>
      <option value="molecular-weight">Molecular Weight Calculator</option>
      <option value="codon-table">Codon Table & Translation</option>
      <option value="pedigree">Pedigree Chart Builder</option>
      <option value="mutation-simulator">Mutation Simulator</option>
      <option value="genetic-distance">Genetic Distance Calculator</option>
      <option value="restriction-sites">Restriction Enzyme Finder</option>
      <option value="pcr-primer">PCR Primer Designer</option>
    </select>
  </div>

  <!-- Tool-Specific Input Area -->
  <div id="gen-input-container">
    <!-- DNA Analyzer Inputs -->
    <div id="gen-dna-inputs" style="display:block;">
      <div class="field" style="margin-bottom:12px;">
        <label for="gen-dna-sequence" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          DNA Sequence
          <button type="button" onclick="genLoadExample('human')" class="small-btn" style="float:right;font-size:11px;">Human Example</button>
        </label>
        <textarea id="gen-dna-sequence" rows="3" placeholder="Enter DNA sequence (A, T, C, G only)..." 
                  style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-family:'Consolas','Monaco','Courier New',monospace;font-size:14px;resize:vertical;"></textarea>
        <div class="small" style="color:rgba(230,250,255,0.6);margin-top:4px;">Enter sequence in 5'‚Üí3' direction, uppercase letters only</div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field">
          <label for="gen-analysis-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Analysis Type</label>
          <select id="gen-analysis-type" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="full">Full Analysis</option>
            <option value="composition">Base Composition</option>
            <option value="orfs">Open Reading Frames</option>
            <option value="palindromes">Palindromic Sequences</option>
          </select>
        </div>
        
        <div class="field">
          <label for="gen-output-format" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Output Format</label>
          <select id="gen-output-format" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="text" selected>Text Report</option>
            <option value="json">JSON Data</option>
            <option value="fasta">FASTA Format</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- Punnett Square Inputs -->
    <div id="gen-punnett-inputs" style="display:none;">
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
        <div class="field">
          <label for="gen-parent1-genotype" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Parent 1 Genotype</label>
          <input id="gen-parent1-genotype" type="text" placeholder="e.g., AaBb" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <div class="small" style="color:rgba(230,250,255,0.6);margin-top:4px;">Use letters like A/a, B/b, etc.</div>
        </div>
        
        <div class="field">
          <label for="gen-parent2-genotype" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Parent 2 Genotype</label>
          <input id="gen-parent2-genotype" type="text" placeholder="e.g., AaBb" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
        </div>
      </div>
      
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field">
          <label for="gen-cross-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Cross Type</label>
          <select id="gen-cross-type" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="monohybrid">Monohybrid (1 gene)</option>
            <option value="dihybrid" selected>Dihybrid (2 genes)</option>
            <option value="trihybrid">Trihybrid (3 genes)</option>
          </select>
        </div>
        
        <div class="field">
          <label for="gen-inheritance" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Inheritance Pattern</label>
          <select id="gen-inheritance" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="mendelian">Mendelian</option>
            <option value="incomplete">Incomplete Dominance</option>
            <option value="codominance">Codominance</option>
            <option value="sex-linked">Sex-Linked</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Examples -->
  <div style="margin-bottom:20px;">
    <div class="small" style="color:var(--accent);margin-bottom:8px;">üß¨ Quick Examples:</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="genLoadExample('human')" class="small-btn">Human DNA</button>
      <button type="button" onclick="genLoadExample('punnett')" class="small-btn">Punnett Square</button>
      <button type="button" onclick="genLoadExample('gc')" class="small-btn">GC Content</button>
      <button type="button" onclick="genLoadExample('codon')" class="small-btn">Codon Translation</button>
      <button type="button" onclick="genLoadExample('mutation')" class="small-btn">Mutation Sim</button>
    </div>
  </div>

  <div style="display:flex;gap:12px;align-items:center;margin-bottom:16px;">
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
      <input type="checkbox" id="gen-show-steps" checked style="width:18px;height:18px;cursor:pointer;" />
      <span style="color:var(--accent);font-weight:500;">Show step-by-step explanation</span>
    </label>
    
    <label style="display:flex;align-items:center;gap:8px;cursor:pointer;margin-left:auto;">
      <input type="checkbox" id="gen-show-visual" checked style="width:18px;height:18px;cursor:pointer;" />
      <span style="color:var(--accent);font-weight:500;">Show visual representation</span>
    </label>
  </div>

  <div class="actions" style="display:flex;gap:10px;">
    <button type="button" onclick="genCalculate(this)" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(57,255,20,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);font-weight:600;cursor:pointer;font-size:16px;">
      üß¨ Analyze
    </button>
    <button type="button" onclick="genReset(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset
    </button>
    <button type="button" onclick="genGenerateRandom()"
            style="padding:12px 16px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:8px;color:#ffa500;cursor:pointer;">
      Random
    </button>
  </div>
</form>

<div id="gen-results" aria-live="polite" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">üß™ Genetics Analysis</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="gen-analysis-time" class="small" style="color:rgba(230,250,255,0.6);"></div>
    </div>
  </div>

  <!-- Main Results -->
  <div id="gen-output-container" style="min-height:200px;">
    <!-- Results will be inserted here -->
  </div>

  <!-- Visual Representation -->
  <div id="gen-visual-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìä Visual Representation</h4>
    <div id="gen-visual-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">
      <!-- Visualizations will be inserted here -->
    </div>
  </div>

  <!-- Step-by-Step Explanation -->
  <div id="gen-steps-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìù Step-by-Step Explanation</h4>
    <div id="gen-steps-content" style="background:rgba(0,0,255,0.05);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);font-family:'Consolas','Monaco','Courier New',monospace;font-size:13px;line-height:1.6;">
      <!-- Steps will be inserted here -->
    </div>
  </div>

  <!-- Genetics Facts -->
  <div id="gen-facts-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:#39ff14;margin-bottom:12px;">üî¨ Interesting Genetics Facts</h4>
    <div id="gen-facts-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(57,255,20,0.2);">
      <!-- Facts will be inserted here -->
    </div>
  </div>

  <!-- Educational Content -->
  <div id="gen-education-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:#ffa500;margin-bottom:12px;">üéì Educational Content</h4>
    <div id="gen-education-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(255,165,0,0.2);">
      <!-- Educational content will be inserted here -->
    </div>
  </div>

  <div style="margin-top:20px;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      <button onclick="genCopyResults()" 
              style="padding:10px;background:rgba(45,212,255,0.05);border:1px solid rgba(45,212,255,0.2);border-radius:8px;color:var(--accent);cursor:pointer;font-size:12px;">
        üìã Copy Results
      </button>
      <button onclick="genDownloadData()" 
              style="padding:10px;background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.2);border-radius:8px;color:#39ff14;cursor:pointer;font-size:12px;">
        üíæ Download Data
      </button>
      <button onclick="genShareAnalysis()" 
              style="padding:10px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;cursor:pointer;font-size:12px;">
        üì± Share
      </button>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
      <div id="gen-hint" class="small" style="color:#39ff14;"></div>
      <button onclick="genShowMoreTools()" 
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        üîß More Tools
      </button>
    </div>
  </div>
</div>

<script>
/* genetics-tools.html
   - Comprehensive genetics analysis and educational tool
   - Scoped with gen- prefix
*/

// Tool descriptions
const genToolDescriptions = {
  'dna-analyzer': 'Analyzes DNA sequences for composition, ORFs, and patterns',
  'punnett-square': 'Generates Punnett squares for genetic crosses',
  'gc-content': 'Calculates GC content and melting temperature',
  'molecular-weight': 'Computes molecular weight of DNA/RNA/proteins',
  'codon-table': 'Translates DNA/RNA to amino acids',
  'pedigree': 'Builds and analyzes pedigree charts',
  'mutation-simulator': 'Simulates genetic mutations and their effects',
  'genetic-distance': 'Calculates genetic distance between sequences',
  'restriction-sites': 'Finds restriction enzyme cutting sites',
  'pcr-primer': 'Designs PCR primers for DNA amplification'
};

// Example sequences and data
const genExamples = {
  'human': {
    sequence: 'ATGGCCATTGTAATGGGCCGCTGAAAGGGTGCCCGATAG',
    tool: 'dna-analyzer',
    description: 'Human Œ≤-globin gene fragment'
  },
  'punnett': {
    parent1: 'AaBb',
    parent2: 'AaBb',
    tool: 'punnett-square',
    description: 'Dihybrid cross example'
  },
  'gc': {
    sequence: 'GGCGCGCCGGGCGCGCCGGGCGCGCCG',
    tool: 'gc-content',
    description: 'High GC content sequence'
  },
  'codon': {
    sequence: 'AUGGCUUAUUGCUACUUGA',
    tool: 'codon-table',
    description: 'mRNA translation example'
  },
  'mutation': {
    sequence: 'ATGCAATACGTAATGCGTA',
    tool: 'mutation-simulator',
    description: 'Mutation simulation template'
  }
};

// Standard genetic code (DNA ‚Üí amino acid)
const genGeneticCode = {
  'ATA':'I', 'ATC':'I', 'ATT':'I', 'ATG':'M',
  'ACA':'T', 'ACC':'T', 'ACG':'T', 'ACT':'T',
  'AAC':'N', 'AAT':'N', 'AAA':'K', 'AAG':'K',
  'AGC':'S', 'AGT':'S', 'AGA':'R', 'AGG':'R',
  'CTA':'L', 'CTC':'L', 'CTG':'L', 'CTT':'L',
  'CCA':'P', 'CCC':'P', 'CCG':'P', 'CCT':'P',
  'CAC':'H', 'CAT':'H', 'CAA':'Q', 'CAG':'Q',
  'CGA':'R', 'CGC':'R', 'CGG':'R', 'CGT':'R',
  'GTA':'V', 'GTC':'V', 'GTG':'V', 'GTT':'V',
  'GCA':'A', 'GCC':'A', 'GCG':'A', 'GCT':'A',
  'GAC':'D', 'GAT':'D', 'GAA':'E', 'GAG':'E',
  'GGA':'G', 'GGC':'G', 'GGG':'G', 'GGT':'G',
  'TCA':'S', 'TCC':'S', 'TCG':'S', 'TCT':'S',
  'TTC':'F', 'TTT':'F', 'TTA':'L', 'TTG':'L',
  'TAC':'Y', 'TAT':'Y', 'TAA':'*', 'TAG':'*',
  'TGC':'C', 'TGT':'C', 'TGA':'*', 'TGG':'W'
};

// Genetics facts database
const genFacts = [
  "üß¨ If stretched end-to-end, the DNA in one human cell would be about 2 meters long",
  "üß† Humans share about 98.8% of their DNA with chimpanzees",
  "ü¶† Some bacteria can swap genes horizontally through conjugation, transformation, or transduction",
  "üß´ Only ~2% of human DNA codes for proteins; the rest is regulatory or non-coding",
  "üî¨ The human genome contains approximately 3.2 billion base pairs",
  "üëµ Telomeres protect chromosome ends but shorten with each cell division, contributing to aging",
  "üß™ CRISPR-Cas9 technology allows precise editing of genetic sequences",
  "üë∂ Mitochondrial DNA is inherited almost exclusively from the mother",
  "üß© There are approximately 20,000‚Äì25,000 protein-coding genes in the human genome",
  "‚ö° DNA polymerase adds nucleotides at about 50 bases per second during replication",
  "üéØ Restriction enzymes cut DNA at specific recognition sequences",
  "üß¨ Identical twins share 100% of their DNA, while fraternal twins share about 50%",
  "üåç All humans share 99.9% of their DNA with each other",
  "üß™ PCR (Polymerase Chain Reaction) can amplify DNA billions of times in hours",
  "üîç Genetic sequencing costs have dropped from $100 million to under $1000 per genome"
];

// Initialize the tool
function genInit() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set up event listeners
  const toolSelect = card.querySelector('#gen-tool');
  if (toolSelect) {
    toolSelect.addEventListener('change', genUpdateTool);
  }
  
  // Initialize tool display
  genUpdateTool();
  
  console.log('Genetics Laboratory initialized');
}

// Update tool interface based on selection
function genUpdateTool() {
  const card = document.currentScript?.closest('.card') || document;
  const tool = card.querySelector('#gen-tool').value;
  const description = card.querySelector('#gen-tool-description');
  const inputContainer = card.querySelector('#gen-input-container');
  
  // Update description
  if (description && genToolDescriptions[tool]) {
    description.textContent = genToolDescriptions[tool];
  }
  
  // Hide all input sections
  const inputSections = card.querySelectorAll('#gen-input-container > div');
  inputSections.forEach(section => {
    section.style.display = 'none';
  });
  
  // Show appropriate input section
  let inputSectionId = '';
  switch (tool) {
    case 'dna-analyzer':
      inputSectionId = 'gen-dna-inputs';
      break;
    case 'punnett-square':
      inputSectionId = 'gen-punnett-inputs';
      break;
    case 'gc-content':
      inputSectionId = 'gen-dna-inputs';
      break;
    case 'codon-table':
      inputSectionId = 'gen-dna-inputs';
      break;
    case 'mutation-simulator':
      inputSectionId = 'gen-dna-inputs';
      break;
    default:
      inputSectionId = 'gen-dna-inputs';
  }
  
  const activeSection = card.querySelector(`#${inputSectionId}`);
  if (activeSection) {
    activeSection.style.display = 'block';
  }
}

// Load example data
function genLoadExample(exampleKey) {
  const card = document.currentScript?.closest('.card') || document;
  const example = genExamples[exampleKey];
  
  if (!example) return;
  
  // Set tool
  card.querySelector('#gen-tool').value = example.tool;
  genUpdateTool();
  
  // Set example data
  switch (example.tool) {
    case 'dna-analyzer':
    case 'gc-content':
    case 'codon-table':
    case 'mutation-simulator':
      card.querySelector('#gen-dna-sequence').value = example.sequence;
      break;
    case 'punnett-square':
      card.querySelector('#gen-parent1-genotype').value = example.parent1;
      card.querySelector('#gen-parent2-genotype').value = example.parent2;
      break;
  }
  
  const hint = card.querySelector('#gen-hint');
  hint.textContent = `Loaded ${example.description} example`;
  hint.style.color = '#39ff14';
  setTimeout(() => {
    if (hint.textContent.includes('Loaded')) hint.textContent = '';
  }, 2000);
}

// Generate random DNA sequence
function genGenerateRandom() {
  const card = document.currentScript?.closest('.card') || document;
  const tool = card.querySelector('#gen-tool').value;
  
  let sequence = '';
  const bases = ['A', 'T', 'C', 'G'];
  const length = Math.floor(Math.random() * 50) + 30; // 30-80 bases
  
  for (let i = 0; i < length; i++) {
    sequence += bases[Math.floor(Math.random() * 4)];
  }
  
  if (tool === 'dna-analyzer' || tool === 'gc-content' || tool === 'codon-table' || tool === 'mutation-simulator') {
    card.querySelector('#gen-dna-sequence').value = sequence;
  } else if (tool === 'punnett-square') {
    // Generate random genotypes
    const genotypes = ['AA', 'Aa', 'aa'];
    const parent1 = genotypes[Math.floor(Math.random() * 3)];
    const parent2 = genotypes[Math.floor(Math.random() * 3)];
    card.querySelector('#gen-parent1-genotype').value = parent1;
    card.querySelector('#gen-parent2-genotype').value = parent2;
  }
  
  const hint = card.querySelector('#gen-hint');
  hint.textContent = 'Generated random data for analysis';
  hint.style.color = '#ffa500';
  setTimeout(() => {
    if (hint.textContent.includes('random')) hint.textContent = '';
  }, 2000);
}

// Main calculation function
function genCalculate(btn) {
  const startTime = performance.now();
  const card = btn.closest('.card') || document;
  
  // Get tool and options
  const tool = card.querySelector('#gen-tool').value;
  const showSteps = card.querySelector('#gen-show-steps').checked;
  const showVisual = card.querySelector('#gen-show-visual').checked;
  
  // Perform analysis based on tool
  let result = null;
  let visualization = '';
  let steps = '';
  let facts = '';
  let education = '';
  
  switch (tool) {
    case 'dna-analyzer':
      result = genAnalyzeDNA(card);
      visualization = genVisualizeDNA(result);
      steps = genExplainDNAAnalysis(result);
      facts = genGetRandomFacts(3);
      education = genGetEducationContent('dna-analysis');
      break;
      
    case 'punnett-square':
      result = genGeneratePunnett(card);
      visualization = genVisualizePunnett(result);
      steps = genExplainPunnett(result);
      facts = genGetRandomFacts(3);
      education = genGetEducationContent('genetics');
      break;
      
    case 'gc-content':
      result = genCalculateGC(card);
      visualization = genVisualizeGC(result);
      steps = genExplainGC(result);
      facts = genGetRandomFacts(3);
      education = genGetEducationContent('molecular-biology');
      break;
      
    case 'codon-table':
      result = genTranslateSequence(card);
      visualization = genVisualizeTranslation(result);
      steps = genExplainTranslation(result);
      facts = genGetRandomFacts(3);
      education = genGetEducationContent('translation');
      break;
      
    default:
      result = { error: 'Tool not yet implemented' };
  }
  
  // Display results
  genDisplayResults(card, result, visualization, steps, facts, education, showSteps, showVisual);
  
  // Calculate and show execution time
  const endTime = performance.now();
  const timeTaken = (endTime - startTime).toFixed(2);
  card.querySelector('#gen-analysis-time').textContent = `Analyzed in ${timeTaken}ms`;
  
  // Show results section
  const resultsDiv = card.querySelector('#gen-results');
  resultsDiv.style.display = 'block';
  resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Update hint
  const hint = card.querySelector('#gen-hint');
  hint.textContent = 'Analysis complete!';
  hint.style.color = '#39ff14';
}

// Analyze DNA sequence
function genAnalyzeDNA(card) {
  const sequence = card.querySelector('#gen-dna-sequence').value.toUpperCase().replace(/[^ATCG]/g, '');
  const analysisType = card.querySelector('#gen-analysis-type').value;
  const outputFormat = card.querySelector('#gen-output-format').value;
  
  if (!sequence) {
    return { error: 'Please enter a DNA sequence' };
  }
  
  const result = {
    sequence: sequence,
    length: sequence.length,
    baseComposition: {},
    gcContent: 0,
    orfs: [],
    palindromes: [],
    analysisType: analysisType,
    timestamp: new Date().toISOString()
  };
  
  // Calculate base composition
  const bases = ['A', 'T', 'C', 'G'];
  bases.forEach(base => {
    const count = (sequence.match(new RegExp(base, 'g')) || []).length;
    result.baseComposition[base] = {
      count: count,
      percentage: (count / sequence.length * 100).toFixed(2)
    };
  });
  
  // Calculate GC content
  const gcCount = result.baseComposition.G.count + result.baseComposition.C.count;
  result.gcContent = (gcCount / sequence.length * 100).toFixed(2);
  
  // Find ORFs (simplified)
  if (analysisType === 'full' || analysisType === 'orfs') {
    result.orfs = genFindORFs(sequence);
  }
  
  // Find palindromic sequences
  if (analysisType === 'full' || analysisType === 'palindromes') {
    result.palindromes = genFindPalindromes(sequence);
  }
  
  return result;
}

// Generate Punnett square
function genGeneratePunnett(card) {
  const parent1 = card.querySelector('#gen-parent1-genotype').value.toUpperCase();
  const parent2 = card.querySelector('#gen-parent2-genotype').value.toUpperCase();
  const crossType = card.querySelector('#gen-cross-type').value;
  const inheritance = card.querySelector('#gen-inheritance').value;
  
  if (!parent1 || !parent2) {
    return { error: 'Please enter both parent genotypes' };
  }
  
  const result = {
    parent1: parent1,
    parent2: parent2,
    crossType: crossType,
    inheritance: inheritance,
    gametes1: [],
    gametes2: [],
    square: [],
    phenotypes: [],
    genotypes: [],
    ratios: {},
    timestamp: new Date().toISOString()
  };
  
  // Generate gametes based on cross type
  if (crossType === 'monohybrid') {
    result.gametes1 = genGetGametesMonohybrid(parent1);
    result.gametes2 = genGetGametesMonohybrid(parent2);
  } else if (crossType === 'dihybrid') {
    result.gametes1 = genGetGametesDihybrid(parent1);
    result.gametes2 = genGetGametesDihybrid(parent2);
  }
  
  // Generate Punnett square
  result.square = genCreatePunnettSquare(result.gametes1, result.gametes2, inheritance);
  
  // Calculate ratios
  result.ratios = genCalculateRatios(result.square, inheritance);
  
  return result;
}

// Calculate GC content
function genCalculateGC(card) {
  const sequence = card.querySelector('#gen-dna-sequence').value.toUpperCase().replace(/[^ATCG]/g, '');
  
  if (!sequence) {
    return { error: 'Please enter a DNA sequence' };
  }
  
  const gcCount = (sequence.match(/[GC]/g) || []).length;
  const atCount = (sequence.match(/[AT]/g) || []).length;
  const gcPercent = (gcCount / sequence.length * 100).toFixed(2);
  
  // Calculate melting temperature (simplified)
  const tm = sequence.length <= 14 
    ? 2 * (sequence.match(/[AT]/g) || []).length + 4 * (sequence.match(/[GC]/g) || []).length
    : 64.9 + 41 * (gcCount - 16.4) / sequence.length;
  
  return {
    sequence: sequence,
    length: sequence.length,
    gcCount: gcCount,
    atCount: atCount,
    gcPercent: gcPercent,
    meltingTemp: tm.toFixed(1),
    classification: gcPercent > 60 ? 'High GC' : gcPercent < 40 ? 'Low GC' : 'Moderate GC',
    timestamp: new Date().toISOString()
  };
}

// Translate DNA sequence
function genTranslateSequence(card) {
  const sequence = card.querySelector('#gen-dna-sequence').value.toUpperCase().replace(/[^ATCGU]/g, '');
  
  if (!sequence) {
    return { error: 'Please enter a DNA/RNA sequence' };
  }
  
  // Check if it's RNA (contains U)
  const isRNA = sequence.includes('U');
  const workingSequence = isRNA ? sequence.replace(/U/g, 'T') : sequence;
  
  const codons = [];
  const aminoAcids = [];
  let proteinSequence = '';
  
  // Process in groups of 3
  for (let i = 0; i < workingSequence.length; i += 3) {
    const codon = workingSequence.substr(i, 3);
    if (codon.length === 3) {
      const aminoAcid = genGeneticCode[codon] || '?';
      codons.push(codon);
      aminoAcids.push(aminoAcid);
      proteinSequence += aminoAcid;
    }
  }
  
  return {
    originalSequence: sequence,
    isRNA: isRNA,
    codons: codons,
    aminoAcids: aminoAcids,
    proteinSequence: proteinSequence,
    codonCount: codons.length,
    startCodon: codons[0] === 'ATG' ? 'Yes' : 'No',
    stopCodon: aminoAcids.includes('*') ? 'Yes' : 'No',
    timestamp: new Date().toISOString()
  };
}

// Display results
function genDisplayResults(card, result, visualization, steps, facts, education, showSteps, showVisual) {
  const container = card.querySelector('#gen-output-container');
  const visualContainer = card.querySelector('#gen-visual-container');
  const stepsContainer = card.querySelector('#gen-steps-container');
  const factsContainer = card.querySelector('#gen-facts-container');
  const educationContainer = card.querySelector('#gen-education-container');
  
  // Clear containers
  container.innerHTML = '';
  visualContainer.innerHTML = '';
  stepsContainer.innerHTML = '';
  factsContainer.innerHTML = '';
  educationContainer.innerHTML = '';
  
  // Show/hide containers
  visualContainer.style.display = showVisual ? 'block' : 'none';
  stepsContainer.style.display = showSteps ? 'block' : 'none';
  factsContainer.style.display = 'block';
  educationContainer.style.display = 'block';
  
  // Display main results
  if (result.error) {
    container.innerHTML = `<div style="color:#ff2d55;text-align:center;padding:20px;">${result.error}</div>`;
    return;
  }
  
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  // Tool-specific display
  if (result.sequence) {
    html += genDisplayDNAAnalysis(result);
  } else if (result.parent1) {
    html += genDisplayPunnett(result);
  } else if (result.gcPercent) {
    html += genDisplayGC(result);
  } else if (result.proteinSequence) {
    html += genDisplayTranslation(result);
  }
  
  html += `</div>`;
  container.innerHTML = html;
  
  // Display visualizations
  if (showVisual && visualization) {
    visualContainer.innerHTML = visualization;
  }
  
  // Display steps
  if (showSteps && steps) {
    stepsContainer.innerHTML = steps;
  }
  
  // Display facts
  if (facts) {
    factsContainer.innerHTML = facts;
  }
  
  // Display education
  if (education) {
    educationContainer.innerHTML = education;
  }
  
  // Store result for copying
  container.dataset.genResult = JSON.stringify(result);
}

// Display DNA analysis results
function genDisplayDNAAnalysis(result) {
  let html = `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:24px;font-weight:600;color:var(--accent);">DNA Sequence Analysis</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">${result.timestamp.split('T')[0]}</div>`;
  html += `</div>`;
  
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Sequence Length</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.length} bp</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#39ff14;">GC Content</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.gcContent}%</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Base composition
  html += `<div style="margin-bottom:16px;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Base Composition:</div>`;
  html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;">`;
  
  ['A', 'T', 'C', 'G'].forEach(base => {
    const comp = result.baseComposition[base];
    html += `<div style="text-align:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;">`;
    html += `<div style="color:var(--accent);font-weight:600;">${base}</div>`;
    html += `<div>${comp.count} (${comp.percentage}%)</div>`;
    html += `</div>`;
  });
  
  html += `</div>`;
  html += `</div>`;
  
  // ORFs if found
  if (result.orfs && result.orfs.length > 0) {
    html += `<div style="margin-bottom:12px;padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;">`;
    html += `<div class="small" style="color:#ffa500;">Found ${result.orfs.length} potential Open Reading Frame(s)</div>`;
    html += `</div>`;
  }
  
  return html;
}

// Display Punnett square results
function genDisplayPunnett(result) {
  let html = `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:24px;font-weight:600;color:var(--accent);">Punnett Square Analysis</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">${result.crossType} cross (${result.inheritance})</div>`;
  html += `</div>`;
  
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Parent 1</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.parent1}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Parent 2</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.parent2}</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Genotype ratios
  if (result.ratios.genotypic) {
    html += `<div style="margin-bottom:16px;">`;
    html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Genotypic Ratios:</div>`;
    html += `<div style="display:grid;gap:6px;">`;
    
    Object.entries(result.ratios.genotypic).forEach(([genotype, ratio]) => {
      html += `<div style="display:flex;justify-content:space-between;padding:8px;background:rgba(255,255,255,0.03);border-radius:4px;">`;
      html += `<span>${genotype}</span>`;
      html += `<span style="color:#39ff14;">${ratio}</span>`;
      html += `</div>`;
    });
    
    html += `</div>`;
    html += `</div>`;
  }
  
  return html;
}

// Display GC content results
function genDisplayGC(result) {
  let html = `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:24px;font-weight:600;color:var(--accent);">GC Content Analysis</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">${result.classification}</div>`;
  html += `</div>`;
  
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
  html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#39ff14;">GC Content</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.gcPercent}%</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Melting Temperature</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.meltingTemp}¬∞C</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Base counts
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">`;
  html += `<div style="padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#ffa500;">GC Bases</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.gcCount}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#ffa500;">AT Bases</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.atCount}</div>`;
  html += `</div>`;
  html += `</div>`;
  
  return html;
}

// Display translation results
function genDisplayTranslation(result) {
  let html = `<div style="text-align:center;margin-bottom:20px;">`;
  html += `<div style="font-size:24px;font-weight:600;color:var(--accent);">Genetic Code Translation</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">${result.isRNA ? 'RNA ‚Üí Protein' : 'DNA ‚Üí Protein'}</div>`;
  html += `</div>`;
  
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
  html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#39ff14;">Codons</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.codonCount}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">Protein Length</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${result.proteinSequence.replace(/\*/g, '').length} aa</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Protein sequence preview
  html += `<div style="margin-bottom:12px;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Protein Sequence:</div>`;
  html += `<div style="padding:10px;background:rgba(0,0,0,0.3);border-radius:6px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:12px;word-break:break-all;">`;
  html += result.proteinSequence;
  html += `</div>`;
  html += `</div>`;
  
  return html;
}

// Helper functions for genetic calculations
function genFindORFs(sequence) {
  const orfs = [];
  // Simplified ORF finding - just look for start and stop codons
  for (let frame = 0; frame < 3; frame++) {
    for (let i = frame; i < sequence.length - 2; i += 3) {
      const codon = sequence.substr(i, 3);
      if (codon === 'ATG') {
        // Found start codon, look for stop codon
        for (let j = i + 3; j < sequence.length - 2; j += 3) {
          const stopCodon = sequence.substr(j, 3);
          if (['TAA', 'TAG', 'TGA'].includes(stopCodon)) {
            const length = j - i + 3;
            if (length >= 30) { // Minimum ORF length
              orfs.push({
                start: i + 1,
                end: j + 3,
                length: length,
                frame: frame + 1
              });
            }
            break;
          }
        }
      }
    }
  }
  return orfs.slice(0, 3); // Return max 3 ORFs
}

function genFindPalindromes(sequence) {
  const palindromes = [];
  // Look for palindromic sequences (simplified)
  for (let i = 0; i < sequence.length - 5; i++) {
    for (let len = 6; len <= 12; len += 2) {
      if (i + len <= sequence.length) {
        const subseq = sequence.substr(i, len);
        const reverse = subseq.split('').reverse().join('')
          .replace(/A/g, 't').replace(/T/g, 'a')
          .replace(/C/g, 'g').replace(/G/g, 'c').toUpperCase();
        
        if (subseq === reverse) {
          palindromes.push({
            sequence: subseq,
            position: i + 1,
            length: len
          });
        }
      }
    }
  }
  return palindromes.slice(0, 5); // Return max 5 palindromes
}

function genGetGametesMonohybrid(genotype) {
  const alleles = genotype.split('');
  return alleles.filter((allele, index, self) => self.indexOf(allele) === index);
}

function genGetGametesDihybrid(genotype) {
  // Simplified for 2-letter genotypes like AaBb
  const gametes = [];
  const pairs = genotype.match(/.{2}/g) || [];
  
  if (pairs.length === 2) {
    const [pair1, pair2] = pairs;
    for (let i = 0; i < 2; i++) {
      for (let j = 0; j < 2; j++) {
        gametes.push(pair1[i] + pair2[j]);
      }
    }
  }
  
  return gametes;
}

function genCreatePunnettSquare(gametes1, gametes2, inheritance) {
  const square = [];
  
  for (let i = 0; i < gametes1.length; i++) {
    square[i] = [];
    for (let j = 0; j < gametes2.length; j++) {
      // Combine gametes based on inheritance pattern
      let genotype = '';
      if (inheritance === 'mendelian' || inheritance === 'sex-linked') {
        genotype = gametes1[i] + gametes2[j];
      } else if (inheritance === 'incomplete') {
        genotype = gametes1[i] + gametes2[j];
      } else if (inheritance === 'codominance') {
        genotype = gametes1[i] + gametes2[j];
      }
      square[i][j] = genotype;
    }
  }
  
  return square;
}

function genCalculateRatios(square, inheritance) {
  const ratios = {
    genotypic: {},
    phenotypic: {}
  };
  
  // Flatten square and count genotypes
  const flatSquare = square.flat();
  flatSquare.forEach(genotype => {
    ratios.genotypic[genotype] = (ratios.genotypic[genotype] || 0) + 1;
  });
  
  // Convert counts to ratios
  Object.keys(ratios.genotypic).forEach(genotype => {
    ratios.genotypic[genotype] = `${ratios.genotypic[genotype]}/${flatSquare.length}`;
  });
  
  return ratios;
}

// Visualization functions
function genVisualizeDNA(result) {
  if (!result.sequence) return '';
  
  let html = `<div style="text-align:center;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">DNA Sequence Visualization</div>`;
  
  // Create color-coded sequence
  const colors = { A: '#ff2d55', T: '#2dd4ff', C: '#39ff14', G: '#ffcc00' };
  let coloredSequence = '';
  
  for (let i = 0; i < Math.min(result.sequence.length, 50); i++) {
    const base = result.sequence[i];
    coloredSequence += `<span style="color:${colors[base] || '#ffffff'};font-weight:600;">${base}</span>`;
    if ((i + 1) % 10 === 0) coloredSequence += ' ';
  }
  
  html += `<div style="padding:12px;background:rgba(0,0,0,0.3);border-radius:6px;font-family:'Consolas','Monaco','Courier New',monospace;font-size:14px;letter-spacing:1px;">`;
  html += coloredSequence;
  if (result.sequence.length > 50) {
    html += `<div style="color:rgba(230,250,255,0.6);margin-top:8px;">... ${result.sequence.length - 50} more bases</div>`;
  }
  html += `</div>`;
  
  // GC content bar
  html += `<div style="margin-top:16px;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">GC Content: ${result.gcContent}%</div>`;
  html += `<div style="height:10px;background:rgba(255,255,255,0.1);border-radius:5px;overflow:hidden;">`;
  html += `<div style="height:100%;background:linear-gradient(90deg, #2dd4ff, #39ff14);width:${result.gcContent}%;"></div>`;
  html += `</div>`;
  html += `</div>`;
  
  html += `</div>`;
  return html;
}

function genVisualizePunnett(result) {
  let html = `<div style="text-align:center;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Punnett Square</div>`;
  
  // Simple Punnett square visualization
  html += `<div style="display:inline-grid;grid-template-columns:repeat(${result.gametes2.length + 1}, 1fr);gap:4px;background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;">`;
  
  // Top row (gametes2)
  html += `<div style="padding:8px;color:rgba(230,250,255,0.6);"></div>`;
  result.gametes2.forEach(gamete => {
    html += `<div style="padding:8px;color:#39ff14;font-weight:600;">${gamete}</div>`;
  });
  
  // Rows
  for (let i = 0; i < result.gametes1.length; i++) {
    html += `<div style="padding:8px;color:#2dd4ff;font-weight:600;">${result.gametes1[i]}</div>`;
    for (let j = 0; j < result.gametes2.length; j++) {
      html += `<div style="padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;font-weight:600;">${result.square[i][j]}</div>`;
    }
  }
  
  html += `</div>`;
  html += `</div>`;
  
  return html;
}

function genVisualizeGC(result) {
  let html = `<div style="text-align:center;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Base Composition</div>`;
  
  // Pie chart visualization (simulated)
  html += `<div style="display:flex;justify-content:center;align-items:center;height:120px;margin-bottom:16px;">`;
  html += `<div style="position:relative;width:120px;height:120px;border-radius:50%;background:conic-gradient(#ff2d55 0% ${result.gcPercent/4}%, #2dd4ff ${result.gcPercent/4}% ${result.gcPercent/2}%, #39ff14 ${result.gcPercent/2}% ${result.gcPercent*0.75}%, #ffcc00 ${result.gcPercent*0.75}% 100%);"></div>`;
  html += `</div>`;
  
  // Legend
  html += `<div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;">`;
  html += `<div style="display:flex;align-items:center;gap:4px;"><div style="width:12px;height:12px;background:#ff2d55;border-radius:2px;"></div><span class="small">A</span></div>`;
  html += `<div style="display:flex;align-items:center;gap:4px;"><div style="width:12px;height:12px;background:#2dd4ff;border-radius:2px;"></div><span class="small">T</span></div>`;
  html += `<div style="display:flex;align-items:center;gap:4px;"><div style="width:12px;height:12px;background:#39ff14;border-radius:2px;"></div><span class="small">C</span></div>`;
  html += `<div style="display:flex;align-items:center;gap:4px;"><div style="width:12px;height:12px;background:#ffcc00;border-radius:2px;"></div><span class="small">G</span></div>`;
  html += `</div>`;
  
  html += `</div>`;
  return html;
}

function genVisualizeTranslation(result) {
  let html = `<div style="text-align:center;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Codon Translation</div>`;
  
  // Show first few codons and their translations
  const maxDisplay = Math.min(result.codons.length, 6);
  html += `<div style="display:grid;grid-template-columns:repeat(${maxDisplay}, 1fr);gap:4px;margin-bottom:12px;">`;
  
  for (let i = 0; i < maxDisplay; i++) {
    html += `<div style="padding:8px;background:rgba(255,255,255,0.05);border-radius:4px;">`;
    html += `<div style="font-size:11px;color:rgba(230,250,255,0.6);">Codon ${i + 1}</div>`;
    html += `<div style="font-weight:600;color:#2dd4ff;">${result.codons[i]}</div>`;
    html += `<div style="font-size:12px;color:#39ff14;">‚Üí ${result.aminoAcids[i]}</div>`;
    html += `</div>`;
  }
  
  html += `</div>`;
  
  if (result.codons.length > maxDisplay) {
    html += `<div class="small" style="color:rgba(230,250,255,0.6);">... ${result.codons.length - maxDisplay} more codons</div>`;
  }
  
  html += `</div>`;
  return html;
}

// Explanation functions
function genExplainDNAAnalysis(result) {
  let steps = `Step 1: DNA sequence input validation\n`;
  steps += `  ‚Ä¢ Removed non-ATCG characters\n`;
  steps += `  ‚Ä¢ Sequence length: ${result.length} base pairs\n\n`;
  
  steps += `Step 2: Base composition analysis\n`;
  steps += `  ‚Ä¢ Counted occurrences of each nucleotide\n`;
  steps += `  ‚Ä¢ Calculated percentages\n\n`;
  
  steps += `Step 3: GC content calculation\n`;
  steps += `  ‚Ä¢ GC bases = G + C = ${result.baseComposition.G.count + result.baseComposition.C.count}\n`;
  steps += `  ‚Ä¢ GC% = (GC bases / total length) √ó 100 = ${result.gcContent}%\n\n`;
  
  steps += `Step 4: Additional analyses\n`;
  if (result.analysisType === 'full' || result.analysisType === 'orfs') {
    steps += `  ‚Ä¢ Found ${result.orfs.length} potential Open Reading Frame(s)\n`;
  }
  if (result.analysisType === 'full' || result.analysisType === 'palindromes') {
    steps += `  ‚Ä¢ Found ${result.palindromes.length} palindromic sequence(s)\n`;
  }
  
  return steps;
}

function genExplainPunnett(result) {
  let steps = `Step 1: Parent genotype analysis\n`;
  steps += `  ‚Ä¢ Parent 1: ${result.parent1}\n`;
  steps += `  ‚Ä¢ Parent 2: ${result.parent2}\n`;
  steps += `  ‚Ä¢ Cross type: ${result.crossType}\n`;
  steps += `  ‚Ä¢ Inheritance pattern: ${result.inheritance}\n\n`;
  
  steps += `Step 2: Gamete formation\n`;
  steps += `  ‚Ä¢ Parent 1 gametes: ${result.gametes1.join(', ')}\n`;
  steps += `  ‚Ä¢ Parent 2 gametes: ${result.gametes2.join(', ')}\n\n`;
  
  steps += `Step 3: Punnett square construction\n`;
  steps += `  ‚Ä¢ ${result.gametes1.length} √ó ${result.gametes2.length} = ${result.gametes1.length * result.gametes2.length} possible combinations\n\n`;
  
  steps += `Step 4: Genotypic ratio calculation\n`;
  Object.entries(result.ratios.genotypic).forEach(([genotype, ratio]) => {
    steps += `  ‚Ä¢ ${genotype}: ${ratio}\n`;
  });
  
  return steps;
}

function genExplainGC(result) {
  let steps = `Step 1: DNA sequence analysis\n`;
  steps += `  ‚Ä¢ Sequence length: ${result.length} base pairs\n`;
  steps += `  ‚Ä¢ GC bases: ${result.gcCount}\n`;
  steps += `  ‚Ä¢ AT bases: ${result.atCount}\n\n`;
  
  steps += `Step 2: GC content calculation\n`;
  steps += `  ‚Ä¢ Formula: GC% = (GC bases / total bases) √ó 100\n`;
  steps += `  ‚Ä¢ Calculation: (${result.gcCount} / ${result.length}) √ó 100 = ${result.gcPercent}%\n\n`;
  
  steps += `Step 3: Classification\n`;
  steps += `  ‚Ä¢ ${result.gcPercent}% GC content ‚Üí ${result.classification}\n\n`;
  
  steps += `Step 4: Melting temperature estimation\n`;
  steps += `  ‚Ä¢ Approximate Tm = ${result.meltingTemp}¬∞C\n`;
  steps += `  ‚Ä¢ Higher GC content increases DNA stability and melting temperature\n`;
  
  return steps;
}

function genExplainTranslation(result) {
  let steps = `Step 1: Sequence preparation\n`;
  steps += `  ‚Ä¢ Input sequence: ${result.isRNA ? 'RNA' : 'DNA'}\n`;
  steps += `  ‚Ä¢ Length: ${result.originalSequence.length} bases\n`;
  steps += `  ‚Ä¢ Codons: ${result.codonCount} (${result.codonCount * 3} bases)\n\n`;
  
  steps += `Step 2: Codon identification\n`;
  steps += `  ‚Ä¢ Split sequence into triplets (codons)\n`;
  steps += `  ‚Ä¢ First codon: ${result.codons[0] || 'N/A'}\n`;
  steps += `  ‚Ä¢ Last codon: ${result.codons[result.codons.length - 1] || 'N/A'}\n\n`;
  
  steps += `Step 3: Translation using genetic code\n`;
  steps += `  ‚Ä¢ Standard genetic code mapping\n`;
  steps += `  ‚Ä¢ Example: ${result.codons[0] || '---'} ‚Üí ${result.aminoAcids[0] || '-'}\n\n`;
  
  steps += `Step 4: Protein sequence assembly\n`;
  steps += `  ‚Ä¢ ${result.codonCount} codons ‚Üí ${result.proteinSequence.replace(/\*/g, '').length} amino acids\n`;
  steps += `  ‚Ä¢ Start codon present: ${result.startCodon}\n`;
  steps += `  ‚Ä¢ Stop codon present: ${result.stopCodon}\n`;
  
  return steps;
}

// Get random genetics facts
function genGetRandomFacts(count) {
  const shuffled = [...genFacts].sort(() => 0.5 - Math.random());
  const selected = shuffled.slice(0, count);
  
  let html = `<div style="display:grid;gap:8px;">`;
  selected.forEach(fact => {
    html += `<div style="display:flex;align-items:start;gap:8px;">`;
    html += `<span style="color:#39ff14;">‚Ä¢</span>`;
    html += `<span style="flex:1;">${fact}</span>`;
    html += `</div>`;
  });
  html += `</div>`;
  
  return html;
}

// Get educational content
function genGetEducationContent(topic) {
  const content = {
    'dna-analysis': `
      <div style="display:grid;gap:8px;">
        <div><strong>DNA Analysis Basics:</strong></div>
        <div>‚Ä¢ <strong>Base Composition:</strong> The proportion of A, T, C, and G bases in a DNA sequence</div>
        <div>‚Ä¢ <strong>GC Content:</strong> Percentage of G and C bases; affects DNA stability and melting temperature</div>
        <div>‚Ä¢ <strong>Open Reading Frames (ORFs):</strong> Sequences that could potentially encode proteins</div>
        <div>‚Ä¢ <strong>Palindromic Sequences:</strong> DNA sequences that read the same forward and backward on complementary strands</div>
      </div>
    `,
    'genetics': `
      <div style="display:grid;gap:8px;">
        <div><strong>Mendelian Genetics:</strong></div>
        <div>‚Ä¢ <strong>Alleles:</strong> Different versions of a gene</div>
        <div>‚Ä¢ <strong>Genotype:</strong> Genetic makeup (e.g., AA, Aa, aa)</div>
        <div>‚Ä¢ <strong>Phenotype:</strong> Observable traits</div>
        <div>‚Ä¢ <strong>Dominant:</strong> Allele expressed in heterozygous state</div>
        <div>‚Ä¢ <strong>Recessive:</strong> Allele only expressed in homozygous state</div>
      </div>
    `,
    'molecular-biology': `
      <div style="display:grid;gap:8px;">
        <div><strong>Molecular Biology Concepts:</strong></div>
        <div>‚Ä¢ <strong>DNA Melting:</strong> Separation of double-stranded DNA into single strands by heat</div>
        <div>‚Ä¢ <strong>GC Pairs:</strong> Form three hydrogen bonds (vs. AT pairs with two)</div>
        <div>‚Ä¢ <strong>DNA Stability:</strong> Higher GC content = more stable DNA = higher melting temperature</div>
        <div>‚Ä¢ <strong>Applications:</strong> PCR primer design, gene identification, evolutionary studies</div>
      </div>
    `,
    'translation': `
      <div style="display:grid;gap:8px;">
        <div><strong>Genetic Code & Translation:</strong></div>
        <div>‚Ä¢ <strong>Codon:</strong> Three-nucleotide sequence that specifies an amino acid</div>
        <div>‚Ä¢ <strong>Start Codon:</strong> AUG (codes for methionine, signals translation start)</div>
        <div>‚Ä¢ <strong>Stop Codons:</strong> UAA, UAG, UGA (signal translation termination)</div>
        <div>‚Ä¢ <strong>Degeneracy:</strong> Multiple codons can code for the same amino acid</div>
        <div>‚Ä¢ <strong>Universal:</strong> Genetic code is nearly universal across all organisms</div>
      </div>
    `
  };
  
  return content[topic] || content['dna-analysis'];
}

// Copy results
function genCopyResults() {
  const card = document.currentScript?.closest('.card') || document;
  const resultData = card.querySelector('#gen-output-container').dataset.genResult;
  
  if (!resultData) {
    genShowMessage('No results to copy', '#ff2d55');
    return;
  }
  
  const result = JSON.parse(resultData);
  let text = 'GENETICS ANALYSIS RESULTS\n\n';
  
  if (result.sequence) {
    text += `DNA Sequence Analysis\n`;
    text += `Length: ${result.length} bp\n`;
    text += `GC Content: ${result.gcContent}%\n`;
    Object.entries(result.baseComposition).forEach(([base, data]) => {
      text += `${base}: ${data.count} (${data.percentage}%)\n`;
    });
  } else if (result.parent1) {
    text += `Punnett Square Analysis\n`;
    text += `Parent 1: ${result.parent1}\n`;
    text += `Parent 2: ${result.parent2}\n`;
    text += `Cross Type: ${result.crossType}\n`;
    Object.entries(result.ratios.genotypic).forEach(([genotype, ratio]) => {
      text += `${genotype}: ${ratio}\n`;
    });
  } else if (result.gcPercent) {
    text += `GC Content Analysis\n`;
    text += `GC Content: ${result.gcPercent}%\n`;
    text += `Melting Temperature: ${result.meltingTemp}¬∞C\n`;
    text += `Classification: ${result.classification}\n`;
  } else if (result.proteinSequence) {
    text += `Genetic Translation\n`;
    text += `Codons: ${result.codonCount}\n`;
    text += `Protein Sequence: ${result.proteinSequence}\n`;
  }
  
  text += `\nGenerated by Genetics Laboratory\nThe Most Useful Site in the World`;
  
  navigator.clipboard.writeText(text).then(() => {
    genShowMessage('‚úÖ Results copied to clipboard!', '#39ff14');
  }).catch(err => {
    console.error('Copy failed:', err);
    genShowMessage('‚ùå Copy failed', '#ff2d55');
  });
}

// Download data
function genDownloadData() {
  const card = document.currentScript?.closest('.card') || document;
  const resultData = card.querySelector('#gen-output-container').dataset.genResult;
  
  if (!resultData) {
    genShowMessage('No data to download', '#ff2d55');
    return;
  }
  
  const result = JSON.parse(resultData);
  const dataStr = JSON.stringify(result, null, 2);
  const blob = new Blob([dataStr], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'genetics-analysis.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  genShowMessage('‚úÖ Data downloaded as JSON!', '#39ff14');
}

// Share analysis
function genShareAnalysis() {
  const card = document.currentScript?.closest('.card') || document;
  const resultData = card.querySelector('#gen-output-container').dataset.genResult;
  
  if (!resultData) {
    genShowMessage('No analysis to share', '#ff2d55');
    return;
  }
  
  const result = JSON.parse(resultData);
  let shareText = 'üß¨ Genetics Analysis Results\n';
  
  if (result.sequence) {
    shareText += `DNA Analysis: ${result.length} bp, ${result.gcContent}% GC content`;
  } else if (result.parent1) {
    shareText += `Punnett Square: ${result.parent1} √ó ${result.parent2}`;
  } else if (result.gcPercent) {
    shareText += `GC Analysis: ${result.gcPercent}% GC, Tm=${result.meltingTemp}¬∞C`;
  } else if (result.proteinSequence) {
   
