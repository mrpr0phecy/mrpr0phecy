<h2 id="plant-encyclopedia" style="margin-top:0;">Plant Encyclopedia (Live)</h2>

<!--
  Manifest metadata
  id: plant-encyclopedia
  title: Plant Encyclopedia
  path: cards/plant-encyclopedia.html
  category: Gardening Tools
  version: 1.3
-->

<form aria-describedby="pe-desc">
  <p id="pe-desc" class="small">
    Search plants by name. Results are fetched live from open sources (Wikidata, USDA, OpenFarm).
  </p>

  <label for="pe-query">Plant name</label>
  <input id="pe-query" type="text" placeholder="e.g. Tomato, Basil, Rose" style="width:100%;" />

  <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
    <button type="button" onclick="peSearch()">Search</button>
    <button type="button" class="secondary" onclick="peReset()">Reset</button>
  </div>
</form>

<div style="margin-top:14px;">
  <h3 class="small">Result</h3>
  <div id="pe-output" class="small" style="background:#fafafa;padding:10px;border-radius:8px;min-height:64px;"></div>
</div>

<script>
async function peSearch(){
  const q=document.getElementById('pe-query').value.trim();
  const out=document.getElementById('pe-output');
  out.textContent='Searching live sourcesâ€¦';
  if(!q){out.textContent='Please enter a plant name.';return;}

  try {
    // Wikidata search
    const wd=await fetch(`https://www.wikidata.org/w/api.php?action=wbsearchentities&language=en&format=json&search=${encodeURIComponent(q)}&origin=*`);
    const wdJson=await wd.json();
    const entity=wdJson.search?.[0];

    // OpenFarm search
    const of=await fetch(`https://openfarm.cc/api/v1/crops/?filter=${encodeURIComponent(q)}`);
    const ofJson=await of.json();
    const crop=ofJson.data?.[0];

    // USDA PLANTS (example endpoint)
    const usda=await fetch(`https://plantsdb.xyz/search?name=${encodeURIComponent(q)}`);
    const usdaJson=await usda.json();
    const usdaPlant=usdaJson?.[0];

    // Merge results
    const merged={
      common_name: crop?.attributes?.name || entity?.label || usdaPlant?.common_name || q,
      scientific_name: crop?.attributes?.binomial_name || usdaPlant?.scientific_name || '',
      family: usdaPlant?.family || '',
      sunlight: crop?.attributes?.sun_requirements || '',
      watering: crop?.attributes?.watering || '',
      soil: crop?.attributes?.soil || '',
      hardiness: usdaPlant?.duration || '',
      image_url: crop?.attributes?.main_image_path || ''
    };

    renderPlant(merged);
  } catch(e){
    out.textContent='Lookup failed.';
  }
}

function renderPlant(p){
  const out=document.getElementById('pe-output');
  out.innerHTML='';
  out.innerHTML = `
    <div style="font-weight:700;">${p.common_name||'Unknown plant'}</div>
    <div style="opacity:.8;">${p.scientific_name||''}</div>
    <ul style="margin:8px 0;padding-left:18px;">
      <li>Family: ${p.family||''}</li>
      <li>Sunlight: ${p.sunlight||''}</li>
      <li>Watering: ${p.watering||''}</li>
      <li>Soil: ${p.soil||''}</li>
      <li>Hardiness: ${p.hardiness||''}</li>
    </ul>
    ${p.image_url?`<img src="${p.image_url}" alt="Plant image" style="max-width:100%;border-radius:8px;">`:''}
  `;
}

function peReset(){
  document.getElementById('pe-query').value='';
  document.getElementById('pe-output').textContent='';
}
</script>
