<h2 id="second-life-marketplace-search-title">ğŸ›’ Second Life Marketplace Search</h2>

<form aria-describedby="second-life-marketplace-search-desc">
    <p id="second-life-marketplace-search-desc" class="small">
        Search and browse Second Life Marketplace items. 
        <span style="color:var(--accent)">Demo data shown â€” in production, connect to actual Marketplace API.</span>
    </p>
    
    <!-- SEARCH INPUT -->
    <div class="field" style="margin-bottom:16px;">
        <label for="slms-query" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
            ğŸ” Search Marketplace
        </label>
        <input id="slms-query" type="text" placeholder="e.g. mesh furniture, avatar clothing, animation, building" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
        <div class="small" style="margin-top:4px;color:rgba(230,250,255,0.7);">
            Try: furniture, clothing, animations, vehicles, buildings, accessories
        </div>
    </div>
    
    <!-- CATEGORY FILTERS -->
    <div style="margin-bottom:16px;">
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;font-size:14px;">ğŸ“ Categories</div>
        <div style="display:flex;flex-wrap:wrap;gap:8px;">
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="furniture" checked />
                <span style="font-size:13px;">ğŸ›‹ï¸ Furniture</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="clothing" checked />
                <span style="font-size:13px;">ğŸ‘— Clothing</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="animations" />
                <span style="font-size:13px;">ğŸ’ƒ Animations</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="vehicles" />
                <span style="font-size:13px;">ğŸš— Vehicles</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="buildings" />
                <span style="font-size:13px;">ğŸ  Buildings</span>
            </label>
            <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
                <input type="checkbox" class="slms-category" value="accessories" />
                <span style="font-size:13px;">ğŸ‘“ Accessories</span>
            </label>
        </div>
    </div>
    
    <!-- PRICE RANGE -->
    <div style="margin-bottom:20px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.08);padding:12px;">
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;font-size:14px;">ğŸ’° Price Range (L$)</div>
        <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;">
            <input id="slms-min-price" type="number" placeholder="Min" min="0" max="10000" value="0" 
                   style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;text-align:center;" />
            <div style="color:rgba(230,250,255,0.7);text-align:center;">â†’</div>
            <input id="slms-max-price" type="number" placeholder="Max" min="0" max="10000" value="1000" 
                   style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;text-align:center;" />
        </div>
        <div class="small" style="text-align:center;color:rgba(230,250,255,0.7);margin-top:8px;">
            Filter results by price: L$0 - L$<span id="slms-max-price-value">1000</span>
        </div>
    </div>
    
    <!-- SORT OPTIONS -->
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:20px;">
        <div>
            <label for="slms-sort-by" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Sort By
            </label>
            <select id="slms-sort-by" 
                    style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="relevance" selected>ğŸ” Relevance</option>
                <option value="price-low">ğŸ’° Price: Low to High</option>
                <option value="price-high">ğŸ’° Price: High to Low</option>
                <option value="rating">â­ Customer Rating</option>
                <option value="newest">ğŸ†• Newest First</option>
            </select>
        </div>
        
        <div>
            <label for="slms-results-count" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Results Count
            </label>
            <select id="slms-results-count" 
                    style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
                <option value="5">5 items</option>
                <option value="10" selected>10 items</option>
                <option value="15">15 items</option>
                <option value="20">20 items</option>
            </select>
        </div>
    </div>
    
    <!-- QUICK SEARCH BUTTONS -->
    <div style="margin-bottom:20px;">
        <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">Popular Searches:</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" onclick="slmsSetSearch('mesh sofa')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">ğŸ›‹ï¸ Mesh Sofa</button>
            <button type="button" onclick="slmsSetSearch('gothic outfit')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">ğŸ‘— Gothic Outfit</button>
            <button type="button" onclick="slmsSetSearch('female avatar')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">ğŸ‘© Female Avatar</button>
            <button type="button" onclick="slmsSetSearch('dance animation')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">ğŸ’ƒ Dance Animation</button>
            <button type="button" onclick="slmsSetSearch('modern house')" style="padding:6px 10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:#e6faff;cursor:pointer;font-size:12px;">ğŸ  Modern House</button>
        </div>
    </div>
    
    <!-- ACTIONS -->
    <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
        <button type="button" onclick="slmsSearch(this)" 
                style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
            ğŸ” Search Marketplace
        </button>
        <button type="button" onclick="slmsReset(this)"
                style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
            Reset
        </button>
    </div>
</form>

<!-- RESULTS -->
<div class="results" aria-live="polite" style="margin-top:16px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:8px;">ğŸ“¦ Marketplace Search Results</h3>
    
    <!-- RESULTS DISPLAY -->
    <div id="slms-results" style="display:none;">
        <!-- RESULTS HEADER -->
        <div style="background:rgba(0,0,0,0.2);border-radius:8px 8px 0 0;border:1px solid rgba(45,212,255,0.2);border-bottom:none;padding:12px 16px;">
            <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                    <div style="font-weight:600;color:var(--accent);">Search Results</div>
                    <div id="slms-results-summary" class="small" style="color:rgba(230,250,255,0.7);"></div>
                </div>
                <div id="slms-loading" style="display:none;">
                    <div style="display:flex;align-items:center;gap:8px;color:var(--accent);">
                        <div class="spinner"></div>
                        <span>Searching...</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- RESULTS LIST -->
        <div id="slms-results-list" style="background:rgba(0,0,0,0.2);border-radius:0 0 8px 8px;border:1px solid rgba(45,212,255,0.2);border-top:none;padding:16px;max-height:400px;overflow-y:auto;">
            <!-- Items will be inserted here -->
        </div>
        
        <!-- NO RESULTS MESSAGE -->
        <div id="slms-no-results" style="display:none;text-align:center;padding:32px;color:rgba(230,250,255,0.6);">
            <div style="font-size:48px;margin-bottom:16px;">ğŸ”</div>
            <div style="font-weight:500;margin-bottom:8px;color:var(--accent);">No Results Found</div>
            <div>Try a different search term or adjust your filters.</div>
        </div>
        
        <!-- MARKETPLACE INFO -->
        <div style="background:rgba(20,20,20,0.3);border-radius:8px;border:1px solid rgba(157,78,221,0.2);padding:12px;margin-top:16px;margin-bottom:16px;">
            <div style="color:#9d4edd;font-weight:500;margin-bottom:8px;font-size:14px;">â„¹ï¸ About Second Life Marketplace</div>
            <ul style="list-style:none;padding-left:0;margin:0;font-size:13px;line-height:1.5;">
                <li style="margin-bottom:6px;padding-left:16px;position:relative;">ğŸ›’ <strong>Official Marketplace:</strong> shop.secondlife.com</li>
                <li style="margin-bottom:6px;padding-left:16px;position:relative;">ğŸ’° <strong>Currency:</strong> All prices in Linden Dollars (L$)</li>
                <li style="margin-bottom:6px;padding-left:16px;position:relative;">â­ <strong>Ratings:</strong> Customer ratings help identify quality items</li>
                <li style="margin-bottom:6px;padding-left:16px;position:relative;">âš ï¸ <strong>Disclaimer:</strong> This tool shows demo data only</li>
            </ul>
        </div>
        
        <!-- ACTION BUTTONS -->
        <div style="display:flex;gap:8px;justify-content:flex-end;">
            <button type="button" onclick="slmsCopyResults()"
                    style="padding:8px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;font-size:13px;">
                ğŸ“‹ Copy Results
            </button>
            <button type="button" onclick="slmsOpenMarketplace()"
                    style="padding:8px 16px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:8px;color:#9d4edd;cursor:pointer;font-size:13px;">
                ğŸŒ Open Marketplace
            </button>
        </div>
    </div>
    
    <!-- INITIAL STATE -->
    <div id="slms-initial-state" style="text-align:center;padding:32px;color:rgba(230,250,255,0.6);">
        <div style="font-size:48px;margin-bottom:16px;">ğŸ›’</div>
        <div style="font-weight:500;margin-bottom:8px;color:var(--accent);">Second Life Marketplace Search</div>
        <div>Enter search terms and filters to find Marketplace items.</div>
    </div>
</div>

<script>
/* second-life-marketplace-search.html
   - Second Life Marketplace search tool
   - Scoped with slms- prefix (second life marketplace search)
*/

// Extended demo data
const slmsDemoData = {
    // Furniture
    "mesh sofa": [
        { name: "Modern Mesh Sofa Deluxe", price: 500, rating: 4.5, category: "furniture", seller: "MeshDesigns" },
        { name: "Contemporary Sectional Sofa", price: 750, rating: 4.7, category: "furniture", seller: "FurnitureCo" },
        { name: "Compact Apartment Sofa", price: 350, rating: 4.2, category: "furniture", seller: "SpaceSavers" },
        { name: "Leather Luxury Sofa Set", price: 1200, rating: 4.8, category: "furniture", seller: "LuxuryLiving" },
        { name: "Bohemian Style Sofa", price: 450, rating: 4.3, category: "furniture", seller: "BohemianDesign" }
    ],
    "mesh furniture": [
        { name: "Mesh Dining Table Set", price: 800, rating: 4.6, category: "furniture", seller: "MeshDesigns" },
        { name: "Modern Bedroom Suite", price: 1500, rating: 4.8, category: "furniture", seller: "BedroomExperts" },
        { name: "Kitchen Cabinet Set", price: 650, rating: 4.4, category: "furniture", seller: "KitchenPro" }
    ],
    
    // Clothing
    "gothic outfit": [
        { name: "Gothic Lace Dress Black", price: 250, rating: 4.6, category: "clothing", seller: "DarkFashion" },
        { name: "Victorian Gothic Ensemble", price: 400, rating: 4.8, category: "clothing", seller: "VictorianEra" },
        { name: "Vampire Lord Outfit", price: 600, rating: 4.7, category: "clothing", seller: "NocturnalStyle" },
        { name: "Gothic Corset & Skirt Set", price: 320, rating: 4.5, category: "clothing", seller: "CorsetCouture" }
    ],
    "female avatar": [
        { name: "Realistic Female Avatar", price: 1500, rating: 4.9, category: "clothing", seller: "AvatarArtists" },
        { name: "Anime Style Avatar", price: 800, rating: 4.7, category: "clothing", seller: "AnimeWorld" },
        { name: "Fantasy Elf Avatar", price: 1200, rating: 4.8, category: "clothing", seller: "FantasyRealms" }
    ],
    
    // Animations
    "dance animation": [
        { name: "Hip Hop Dance Pack", price: 150, rating: 4.5, category: "animations", seller: "DanceMasters" },
        { name: "Ballet Animation Set", price: 200, rating: 4.7, category: "animations", seller: "GracefulMoves" },
        { name: "Club Dance Animations", price: 120, rating: 4.4, category: "animations", seller: "ClubVibes" }
    ],
    
    // Buildings
    "modern house": [
        { name: "Modern Beach House", price: 2500, rating: 4.8, category: "buildings", seller: "ArchitecturePro" },
        { name: "Contemporary Urban Loft", price: 1800, rating: 4.6, category: "buildings", seller: "UrbanDesigns" },
        { name: "Minimalist Modern Home", price: 1500, rating: 4.7, category: "buildings", seller: "SimpleLiving" }
    ],
    
    // Vehicles
    "sports car": [
        { name: "Sports Car - Red Edition", price: 800, rating: 4.8, category: "vehicles", seller: "AutoExperts" },
        { name: "Luxury Sports Convertible", price: 1200, rating: 4.9, category: "vehicles", seller: "LuxuryMotors" }
    ],
    
    // Accessories
    "jewelry": [
        { name: "Diamond Necklace Set", price: 300, rating: 4.6, category: "accessories", seller: "JewelCraft" },
        { name: "Gothic Cross Earrings", price: 150, rating: 4.5, category: "accessories", seller: "DarkAccessories" }
    ]
};

function slmsSearch(btn) {
    const card = btn.closest('.card') || document;
    
    // Get search parameters
    const query = (card.querySelector('#slms-query').value || "").toLowerCase().trim();
    const minPrice = parseInt(card.querySelector('#slms-min-price').value) || 0;
    const maxPrice = parseInt(card.querySelector('#slms-max-price').value) || 10000;
    const sortBy = card.querySelector('#slms-sort-by').value;
    const resultsCount = parseInt(card.querySelector('#slms-results-count').value);
    
    // Get selected categories
    const selectedCategories = [];
    card.querySelectorAll('.slms-category:checked').forEach(cb => {
        selectedCategories.push(cb.value);
    });
    
    // Validate
    if (!query) {
        showError(card, 'Please enter a search term');
        return;
    }
    
    if (selectedCategories.length === 0) {
        showError(card, 'Please select at least one category');
        return;
    }
    
    if (minPrice > maxPrice) {
        showError(card, 'Minimum price cannot exceed maximum price');
        return;
    }
    
    // Show loading state
    const loading = card.querySelector('#slms-loading');
    const results = card.querySelector('#slms-results');
    const initial = card.querySelector('#slms-initial-state');
    
    loading.style.display = 'flex';
    results.style.display = 'block';
    initial.style.display = 'none';
    
    // Simulate API delay
    setTimeout(() => {
        // Find matching items
        let items = [];
        
        // Search in demo data (simple keyword matching)
        Object.keys(slmsDemoData).forEach(keyword => {
            if (query.includes(keyword) || keyword.includes(query)) {
                items = items.concat(slmsDemoData[keyword]);
            }
        });
        
        // If no exact matches, use some generic results
        if (items.length === 0) {
            // Combine results from all categories that include the query
            Object.keys(slmsDemoData).forEach(keyword => {
                const keywordParts = keyword.split(' ');
                const queryParts = query.split(' ');
                
                // Check if any word matches
                const hasMatch = keywordParts.some(kp => 
                    queryParts.some(qp => kp.includes(qp) || qp.includes(kp))
                );
                
                if (hasMatch) {
                    items = items.concat(slmsDemoData[keyword]);
                }
            });
        }
        
        // Filter by category
        if (selectedCategories.length > 0) {
            items = items.filter(item => selectedCategories.includes(item.category));
        }
        
        // Filter by price
        items = items.filter(item => item.price >= minPrice && item.price <= maxPrice);
        
        // Sort items
        switch (sortBy) {
            case 'price-low':
                items.sort((a, b) => a.price - b.price);
                break;
            case 'price-high':
                items.sort((a, b) => b.price - a.price);
                break;
            case 'rating':
                items.sort((a, b) => b.rating - a.rating);
                break;
            case 'newest':
                // For demo, just shuffle
                items = shuffleArray(items);
                break;
            default: // relevance
                // Already sorted by relevance (matching keywords first)
                break;
        }
        
        // Limit results count
        items = items.slice(0, resultsCount);
        
        // Display results
        displayResults(card, items, query, minPrice, maxPrice);
        loading.style.display = 'none';
    }, 800); // Simulate network delay
}

function slmsSetSearch(term) {
    const card = document.currentScript?.closest('.card') || document;
    card.querySelector('#slms-query').value = term;
    
    // Auto-search after a short delay
    setTimeout(() => {
        const searchBtn = card.querySelector('button[onclick*="slmsSearch"]');
        if (searchBtn) {
            slmsSearch(searchBtn);
        }
    }, 300);
}

function slmsReset(btn) {
    const card = btn.closest('.card') || document;
    
    // Reset form
    card.querySelector('#slms-query').value = '';
    card.querySelector('#slms-min-price').value = 0;
    card.querySelector('#slms-max-price').value = 1000;
    card.querySelector('#slms-max-price-value').textContent = '1000';
    card.querySelector('#slms-sort-by').value = 'relevance';
    card.querySelector('#slms-results-count').value = '10';
    
    // Reset checkboxes (all except furniture and clothing)
    card.querySelectorAll('.slms-category').forEach(cb => {
        cb.checked = (cb.value === 'furniture' || cb.value === 'clothing');
    });
    
    // Hide results, show initial state
    card.querySelector('#slms-results').style.display = 'none';
    card.querySelector('#slms-initial-state').style.display = 'block';
    card.querySelector('#slms-loading').style.display = 'none';
}

function slmsCopyResults() {
    const card = document.currentScript?.closest('.card') || document;
    const items = getDisplayedResults(card);
    
    if (items.length === 0) return;
    
    let copyText = `ğŸ›’ Second Life Marketplace Search Results\n\n`;
    items.forEach(item => {
        copyText += `â€¢ ${item.name} â€” L$${item.price} â­${item.rating}\n`;
    });
    copyText += `\nTotal: ${items.length} items found`;
    
    navigator.clipboard.writeText(copyText).then(() => {
        // Visual feedback
        const btn = card.querySelector('button[onclick="slmsCopyResults()"]');
        if (btn) {
            const original = btn.textContent;
            btn.textContent = 'âœ… Copied!';
            btn.style.background = 'rgba(57,255,20,0.1)';
            btn.style.borderColor = 'rgba(57,255,20,0.3)';
            btn.style.color = '#39ff14';
            
            setTimeout(() => {
                btn.textContent = original;
                btn.style.background = 'rgba(45,212,255,0.1)';
                btn.style.borderColor = 'rgba(45,212,255,0.3)';
                btn.style.color = 'var(--accent)';
            }, 2000);
        }
    }).catch(err => {
        console.error('Copy failed:', err);
    });
}

function slmsOpenMarketplace() {
    const card = document.currentScript?.closest('.card') || document;
    const query = card.querySelector('#slms-query').value;
    
    // Construct actual Marketplace URL
    const encodedQuery = encodeURIComponent(query);
    const url = `https://marketplace.secondlife.com/products/search?search[category_id]=&search[maturity_level]=G&search[keywords]=${encodedQuery}`;
    
    // Open in new tab
    window.open(url, '_blank');
}

function displayResults(card, items, query, minPrice, maxPrice) {
    const resultsList = card.querySelector('#slms-results-list');
    const noResults = card.querySelector('#slms-no-results');
    const resultsSummary = card.querySelector('#slms-results-summary');
    
    // Clear previous results
    resultsList.innerHTML = '';
    
    if (items.length === 0) {
        resultsList.style.display = 'none';
        noResults.style.display = 'block';
        resultsSummary.textContent = `No results for "${query}"`;
        return;
    }
    
    resultsList.style.display = 'block';
    noResults.style.display = 'none';
    
    // Update summary
    const categories = Array.from(card.querySelectorAll('.slms-category:checked'))
        .map(cb => cb.value).join(', ');
    
    resultsSummary.textContent = `${items.length} results for "${query}" â€¢ Price: L$${minPrice}-${maxPrice} â€¢ Categories: ${categories}`;
    
    // Add items to list
    items.forEach((item, index) => {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'slms-item';
        itemDiv.style.padding = '12px';
        itemDiv.style.borderBottom = '1px solid rgba(255,255,255,0.06)';
        itemDiv.style.marginBottom = '8px';
        
        // Create rating stars
        const stars = 'â˜…'.repeat(Math.floor(item.rating)) + 'â˜†'.repeat(5 - Math.floor(item.rating));
        
        itemDiv.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:flex-start;">
                <div style="flex:1;">
                    <div style="font-weight:600;color:#e6faff;margin-bottom:4px;">${item.name}</div>
                    <div style="display:flex;align-items:center;gap:12px;font-size:13px;">
                        <span style="color:#ffa500;font-weight:600;">L$${item.price}</span>
                        <span style="color:#ffcc00;">${stars} ${item.rating.toFixed(1)}</span>
                        <span style="color:rgba(230,250,255,0.7);">${item.category}</span>
                        <span style="color:rgba(230,250,255,0.7);">by ${item.seller}</span>
                    </div>
                </div>
                <div style="display:flex;gap:8px;">
                    <button onclick="slmsViewDetails('${item.name.replace(/'/g, "\\'")}')" style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:var(--accent);cursor:pointer;font-size:11px;">View</button>
                </div>
            </div>
        `;
        
        resultsList.appendChild(itemDiv);
    });
}

function slmsViewDetails(itemName) {
    // In a real implementation, this would show detailed item view
    alert(`Details for: ${itemName}\n\nIn a real implementation, this would show:\nâ€¢ Full description\nâ€¢ More images\nâ€¢ Customer reviews\nâ€¢ Seller information\nâ€¢ Purchase options`);
}

function getDisplayedResults(card) {
    // Extract data from displayed results
    const items = [];
    card.querySelectorAll('.slms-item').forEach(itemDiv => {
        const name = itemDiv.querySelector('div > div:first-child').textContent.trim();
        const priceMatch = itemDiv.textContent.match(/L\$(\d+)/);
        const ratingMatch = itemDiv.textContent.match(/([\d.]+)(?=\s*â­)/);
        
        if (name && priceMatch) {
            items.push({
                name: name,
                price: parseInt(priceMatch[1]),
                rating: ratingMatch ? parseFloat(ratingMatch[1]) : 4.0
            });
        }
    });
    
    return items;
}

function showError(card, message) {
    // Simple error display
    const results = card.querySelector('#slms-results');
    results.style.display = 'block';
    card.querySelector('#slms-initial-state').style.display = 'none';
    card.querySelector('#slms-loading').style.display = 'none';
    
    card.querySelector('#slms-results-list').innerHTML = `
        <div style="text-align:center;padding:24px;color:#ff2d55;">
            <div style="font-size:32px;margin-bottom:12px;">âŒ</div>
            <div style="font-weight:500;margin-bottom:8px;">Error</div>
            <div>${message}</div>
        </div>
    `;
}

// Helper function to shuffle array
function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

// Initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        const card = document.currentScript?.closest('.card') || document;
        
        // Update max price display
        const maxPriceInput = card.querySelector('#slms-max-price');
        const maxPriceValue = card.querySelector('#slms-max-price-value');
        
        maxPriceInput.addEventListener('input', function() {
            maxPriceValue.textContent = this.value;
        });
        
        // Auto-search on Enter key
        const searchInput = card.querySelector('#slms-query');
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const searchBtn = card.querySelector('button[onclick*="slmsSearch"]');
                if (searchBtn) {
                    slmsSearch(searchBtn);
                }
            }
        });
        
        // Save last search to localStorage
        try {
            const savedQuery = localStorage.getItem('slms-last-query');
            if (savedQuery) {
                searchInput.value = savedQuery;
            }
            
            searchInput.addEventListener('change', function() {
                if (this.value) {
                    localStorage.setItem('slms-last-query', this.value);
                }
            });
        } catch (e) {
            console.log('LocalStorage not available');
        }
        
        console.log('Second Life Marketplace Search initialized');
    });
}
</script>

<style>
/* Second Life Marketplace Search specific styles */
#second-life-marketplace-search-title {
    color: #9d4edd !important; /* Purple for marketplace theme */
    margin-top: 0;
}

/* Category checkbox styling */
.slms-category {
    accent-color: var(--accent);
}

.slms-category:checked + span {
    color: var(--accent);
    font-weight: 500;
}

/* Loading spinner */
.spinner {
    width: 16px;
    height: 16px;
    border: 2px solid rgba(45,212,255,0.3);
    border-top: 2px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* Results list scrollbar */
#slms-results-list::-webkit-scrollbar {
    width: 8px;
}

#slms-results-list::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.2);
    border-radius: 4px;
}

#slms-results-list::-webkit-scrollbar-thumb {
    background: rgba(45,212,255,0.3);
    border-radius: 4px;
}

#slms-results-list::-webkit-scrollbar-thumb:hover {
    background: rgba(45,212,255,0.5);
}

/* Item hover effect */
.slms-item:hover {
    background: rgba(45,212,255,0.05);
    border-radius: 6px;
    margin-left: -4px;
    margin-right: -4px;
    padding-left: 16px !important;
    padding-right: 16px !important;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        margin: 4px 0 !important;
    }
    
    /* Stack price inputs */
    #slms-min-price, #slms-max-price {
        width: 100% !important;
    }
    
    /* Make category checkboxes more touch-friendly */
    .slms-category + span {
        padding: 4px 8px;
        background: rgba(255,255,255,0.05);
        border-radius: 4px;
    }
}

/* Print styles */
@media print {
    #second-life-marketplace-search-title {
        color: #000 !important;
    }
    
    .actions, #slms-loading {
        display: none !important;
    }
}
</style>
