<h2 id="percentages-title" style="margin-top:0;color:var(--accent);">üìä Advanced Percentages Explorer</h2>

<form aria-describedby="percentages-desc">
  <p id="percentages-desc" class="small" style="color:rgba(230,250,255,0.8);margin-bottom:20px;">
    Master percentages with advanced calculations, visualizations, and real-world applications.
    <span style="color:var(--accent);font-weight:500;">From basic math to financial analysis!</span>
  </p>

  <!-- CALCULATION MODE SELECTOR -->
  <div style="background:rgba(45,212,255,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(45,212,255,0.2);">
    <h4 class="small" style="color:var(--accent);margin-bottom:16px;">üî¢ Calculation Mode</h4>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:10px;margin-bottom:12px;">
      <button onclick="percentSetMode('basic')" class="mode-btn active">üìê Basic</button>
      <button onclick="percentSetMode('increase')" class="mode-btn">üìà Increase/Decrease</button>
      <button onclick="percentSetMode('percentage')" class="mode-btn">üî¢ Percentage Of</button>
      <button onclick="percentSetMode('change')" class="mode-btn">üîÑ Percentage Change</button>
      <button onclick="percentSetMode('reverse')" class="mode-btn">‚Ü©Ô∏è Reverse %</button>
      <button onclick="percentSetMode('compound')" class="mode-btn">üìä Compound</button>
      <button onclick="percentSetMode('markup')" class="mode-btn">üí∞ Markup/Margin</button>
      <button onclick="percentSetMode('probability')" class="mode-btn">üé≤ Probability</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="percent-precision" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Precision</label>
        <select id="percent-precision" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="0">0 decimals</option>
          <option value="1">1 decimal</option>
          <option value="2" selected>2 decimals</option>
          <option value="3">3 decimals</option>
          <option value="4">4 decimals</option>
        </select>
      </div>
      
      <div>
        <label for="percent-format" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Format</label>
        <select id="percent-format" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="decimal">0.25</option>
          <option value="percentage" selected>25%</option>
          <option value="fraction">1/4</option>
          <option value="both">25% (0.25)</option>
        </select>
      </div>
    </div>
  </div>

  <!-- DYNAMIC INPUT FIELDS -->
  <div id="percent-inputs-container" style="background:rgba(57,255,20,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(57,255,20,0.2);">
    <h4 class="small" style="color:#39ff14;margin-bottom:16px;">üìù Input Values</h4>
    <!-- Dynamic inputs will be inserted here -->
  </div>

  <!-- QUICK CALCULATIONS -->
  <div style="background:rgba(255,165,0,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,165,0,0.2);">
    <h4 class="small" style="color:#ffa500;margin-bottom:12px;">‚ö° Quick Calculations</h4>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));gap:8px;margin-bottom:12px;">
      <button onclick="percentQuickCalc('tip15')" class="quick-btn">üçΩÔ∏è 15% Tip</button>
      <button onclick="percentQuickCalc('discount20')" class="quick-btn">üè∑Ô∏è 20% Off</button>
      <button onclick="percentQuickCalc('vat20')" class="quick-btn">üè¢ 20% VAT</button>
      <button onclick="percentQuickCalc('increase10')" class="quick-btn">üìà +10%</button>
      <button onclick="percentQuickCalc('decrease25')" class="quick-btn">üìâ -25%</button>
      <button onclick="percentQuickCalc('half')" class="quick-btn">¬Ω 50%</button>
      <button onclick="percentQuickCalc('double')" class="quick-btn">2√ó 100%</button>
      <button onclick="percentQuickCalc('quarter')" class="quick-btn">¬º 25%</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div>
        <label for="percent-base-value" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Base Value</label>
        <input id="percent-base-value" type="number" placeholder="e.g., 100" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
      </div>
      
      <div>
        <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Quick %</label>
        <div style="display:flex;gap:6px;">
          <input id="percent-quick-value" type="number" placeholder="%" value="10"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
          <button onclick="percentQuickApply()" style="padding:10px 16px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:8px;color:var(--accent);cursor:pointer;">Apply</button>
        </div>
      </div>
    </div>
  </div>

  <!-- REAL-WORLD EXAMPLES -->
  <div style="margin-bottom:20px;">
    <details>
      <summary style="color:var(--accent);font-weight:500;cursor:pointer;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;">üåç Real-World Examples</summary>
      <div style="margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:10px;">
        <button onclick="percentLoadExample('sales_tax')" class="example-btn">üè™ Sales Tax (8.5%)</button>
        <button onclick="percentLoadExample('salary_increase')" class="example-btn">üíº Salary +5%</button>
        <button onclick="percentLoadExample('investment_growth')" class="example-btn">üìà Investment +7%</button>
        <button onclick="percentLoadExample('population_growth')" class="example-btn">üë• Population +1.2%</button>
        <button onclick="percentLoadExample('recipe_adjust')" class="example-btn">üç∞ Recipe Scale 150%</button>
        <button onclick="percentLoadExample('test_score')" class="example-btn">üìù Test Score 85%</button>
        <button onclick="percentLoadExample('discount_series')" class="example-btn">üõí 30% + 20% Off</button>
        <button onclick="percentLoadExample('probability')" class="example-btn">üé≤ 75% Chance</button>
      </div>
    </details>
  </div>

  <div class="actions" style="display:flex;gap:10px;">
    <button type="button" onclick="percentCalculate()" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(57,255,20,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);font-weight:600;cursor:pointer;font-size:16px;">
      üßÆ Calculate Percentage
    </button>
    <button type="button" onclick="percentReset()"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      üîÑ Reset
    </button>
    <button type="button" onclick="percentVisualize()"
            style="padding:12px 16px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:8px;color:#9d4edd;cursor:pointer;">
      üìä Visualize
    </button>
  </div>
</form>

<div id="percent-results" aria-live="polite" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h3 class="small" style="color:var(--accent);margin:0;">üìà Calculation Results</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="percent-calculation-time" class="small" style="color:rgba(230,250,255,0.6);"></div>
      <button onclick="percentCopyResults()" class="small-btn" style="font-size:11px;">üìã Copy</button>
    </div>
  </div>

  <!-- MAIN RESULTS -->
  <div id="percent-output-container" style="min-height:120px;">
    <!-- Results will be inserted here -->
  </div>

  <!-- DETAILED BREAKDOWN -->
  <div id="percent-breakdown-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìù Detailed Breakdown</h4>
    <div id="percent-breakdown-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">
      <!-- Breakdown will be inserted here -->
    </div>
  </div>

  <!-- VISUALIZATION -->
  <div id="percent-visualization-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìä Visualization</h4>
    <div id="percent-visualization-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);min-height:200px;">
      <!-- Visualization will be inserted here -->
    </div>
  </div>

  <!-- FRACTION EQUIVALENTS -->
  <div id="percent-fractions-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üî¢ Equivalent Fractions</h4>
    <div id="percent-fractions-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">
      <!-- Fractions will be inserted here -->
    </div>
  </div>

  <!-- COMPARISON TABLE -->
  <div id="percent-comparison-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìã Percentage Comparison</h4>
    <div id="percent-comparison-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);max-height:300px;overflow-y:auto;">
      <!-- Comparison table will be inserted here -->
    </div>
  </div>

  <!-- ACTIONS -->
  <div style="margin-top:20px;">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:10px;margin-bottom:16px;">
      <button onclick="percentShowFormula()" 
              style="padding:10px;background:rgba(45,212,255,0.05);border:1px solid rgba(45,212,255,0.2);border-radius:8px;color:var(--accent);cursor:pointer;font-size:12px;">
        üìê Show Formula
      </button>
      <button onclick="percentGenerateTable()" 
              style="padding:10px;background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.2);border-radius:8px;color:#39ff14;cursor:pointer;font-size:12px;">
        üìä Generate Table
      </button>
      <button onclick="percentExportData()" 
              style="padding:10px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;cursor:pointer;font-size:12px;">
        üíæ Export Data
      </button>
      <button onclick="percentShareResults()" 
              style="padding:10px;background:rgba(157,78,221,0.05);border:1px solid rgba(157,78,221,0.2);border-radius:8px;color:#9d4edd;cursor:pointer;font-size:12px;">
        üì± Share
      </button>
      <button onclick="percentToggleAdvanced()" 
              style="padding:10px;background:rgba(255,77,77,0.05);border:1px solid rgba(255,77,77,0.2);border-radius:8px;color:#ff4d4d;cursor:pointer;font-size:12px;">
        üî¨ Advanced
      </button>
      <button onclick="percentPrintResults()" 
              style="padding:10px;background:rgba(255,204,0,0.05);border:1px solid rgba(255,204,0,0.2);border-radius:8px;color:#ffcc00;cursor:pointer;font-size:12px;">
        üñ®Ô∏è Print
      </button>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
      <div id="percent-hint" class="small" style="color:#39ff14;"></div>
      <button onclick="percentShowHistory()" 
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        üìú Show History
      </button>
    </div>
  </div>
</div>

<!-- HISTORY PANEL -->
<div id="percent-history" style="margin-top:20px;display:none;background:rgba(20,20,20,0.5);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h4 class="small" style="color:var(--accent);margin:0;">üìú Calculation History</h4>
    <button onclick="document.getElementById('percent-history').style.display='none'" 
            style="background:transparent;border:none;color:rgba(230,250,255,0.6);cursor:pointer;">‚úï</button>
  </div>
  <div id="percent-history-content" style="max-height:200px;overflow-y:auto;"></div>
</div>

<!-- ADVANCED PANEL -->
<div id="percent-advanced" style="margin-top:20px;display:none;background:rgba(20,20,20,0.5);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h4 class="small" style="color:var(--accent);margin:0;">üî¨ Advanced Calculations</h4>
    <button onclick="document.getElementById('percent-advanced').style.display='none'" 
            style="background:transparent;border:none;color:rgba(230,250,255,0.6);cursor:pointer;">‚úï</button>
  </div>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
    <div>
      <div class="small" style="color:var(--accent);margin-bottom:8px;">üìà Exponential Growth</div>
      <div style="display:grid;gap:8px;">
        <input id="percent-growth-initial" type="number" placeholder="Initial value" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <input id="percent-growth-rate" type="number" placeholder="Growth rate %" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <input id="percent-growth-periods" type="number" placeholder="Periods" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <button onclick="percentCalculateGrowth()" style="padding:8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">Calculate</button>
      </div>
    </div>
    
    <div>
      <div class="small" style="color:var(--accent);margin-bottom:8px;">üìâ Depreciation</div>
      <div style="display:grid;gap:8px;">
        <input id="percent-depreciation-initial" type="number" placeholder="Initial value" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <input id="percent-depreciation-rate" type="number" placeholder="Depreciation %" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <input id="percent-depreciation-periods" type="number" placeholder="Years" 
               style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <button onclick="percentCalculateDepreciation()" style="padding:8px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;">Calculate</button>
      </div>
    </div>
  </div>
</div>

<script>
/* percentages-explorer.html
   - Advanced Percentages Calculator with visualizations and real-world applications
   - Scoped with percent- prefix
*/

// Current calculation mode and data
let percentMode = 'basic';
let percentHistory = [];
let currentCalculation = null;

// Calculation mode configurations
const percentModes = {
  'basic': {
    name: 'Basic Percentage',
    description: 'Find X% of Y',
    inputs: [
      { id: 'value', label: 'Value (Y)', placeholder: 'e.g., 100' },
      { id: 'percentage', label: 'Percentage (X%)', placeholder: 'e.g., 15' }
    ],
    calculate: (data) => {
      const value = parseFloat(data.value) || 0;
      const percentage = parseFloat(data.percentage) || 0;
      const result = (value * percentage) / 100;
      return {
        value: value,
        percentage: percentage,
        result: result,
        formula: `${percentage}% of ${value} = (${percentage} √ó ${value}) √∑ 100 = ${result}`,
        explanation: `To find ${percentage}% of ${value}, multiply ${value} by ${percentage} and divide by 100.`
      };
    }
  },
  'increase': {
    name: 'Percentage Increase/Decrease',
    description: 'Increase or decrease a value by X%',
    inputs: [
      { id: 'value', label: 'Original Value', placeholder: 'e.g., 100' },
      { id: 'percentage', label: 'Percentage Change', placeholder: 'e.g., +15 or -20' }
    ],
    calculate: (data) => {
      const value = parseFloat(data.value) || 0;
      const percentage = parseFloat(data.percentage) || 0;
      const change = (value * Math.abs(percentage)) / 100;
      const newValue = percentage >= 0 ? value + change : value - change;
      const changeType = percentage >= 0 ? 'increase' : 'decrease';
      
      return {
        value: value,
        percentage: Math.abs(percentage),
        change: change,
        newValue: newValue,
        formula: `${value} ${percentage >= 0 ? '+' : '-'} ${Math.abs(percentage)}% = ${value} ${percentage >= 0 ? '+' : '-'} (${value} √ó ${Math.abs(percentage)} √∑ 100) = ${newValue}`,
        explanation: `A ${Math.abs(percentage)}% ${changeType} of ${value} is ${change}. The new value is ${newValue}.`
      };
    }
  },
  'percentage': {
    name: 'What Percentage is X of Y?',
    description: 'Find what percentage X is of Y',
    inputs: [
      { id: 'part', label: 'Part (X)', placeholder: 'e.g., 25' },
      { id: 'whole', label: 'Whole (Y)', placeholder: 'e.g., 200' }
    ],
    calculate: (data) => {
      const part = parseFloat(data.part) || 0;
      const whole = parseFloat(data.whole) || 1;
      const percentage = (part / whole) * 100;
      
      return {
        part: part,
        whole: whole,
        percentage: percentage,
        formula: `${part} √∑ ${whole} √ó 100 = ${percentage}%`,
        explanation: `${part} is ${percentage}% of ${whole}.`
      };
    }
  },
  'change': {
    name: 'Percentage Change',
    description: 'Find percentage change from old to new value',
    inputs: [
      { id: 'old', label: 'Old Value', placeholder: 'e.g., 100' },
      { id: 'new', label: 'New Value', placeholder: 'e.g., 120' }
    ],
    calculate: (data) => {
      const oldVal = parseFloat(data.old) || 0;
      const newVal = parseFloat(data.new) || 0;
      const change = newVal - oldVal;
      const percentage = oldVal !== 0 ? (change / oldVal) * 100 : 0;
      const changeType = percentage >= 0 ? 'increase' : 'decrease';
      
      return {
        old: oldVal,
        new: newVal,
        change: change,
        percentage: Math.abs(percentage),
        formula: `((${newVal} - ${oldVal}) √∑ ${oldVal}) √ó 100 = ${percentage}%`,
        explanation: `Change from ${oldVal} to ${newVal} is a ${Math.abs(percentage)}% ${changeType}.`
      };
    }
  },
  'reverse': {
    name: 'Reverse Percentage',
    description: 'Find original value before X% increase/decrease',
    inputs: [
      { id: 'value', label: 'Final Value', placeholder: 'e.g., 115' },
      { id: 'percentage', label: 'Percentage Change', placeholder: 'e.g., +15' }
    ],
    calculate: (data) => {
      const value = parseFloat(data.value) || 0;
      const percentage = parseFloat(data.percentage) || 0;
      const original = percentage >= 0 
        ? value / (1 + percentage/100)
        : value / (1 - Math.abs(percentage)/100);
      const changeType = percentage >= 0 ? 'increase' : 'decrease';
      
      return {
        value: value,
        percentage: Math.abs(percentage),
        original: original,
        formula: percentage >= 0 
          ? `${value} √∑ (1 + ${percentage} √∑ 100) = ${original}`
          : `${value} √∑ (1 - ${Math.abs(percentage)} √∑ 100) = ${original}`,
        explanation: `If ${value} is after a ${Math.abs(percentage)}% ${changeType}, the original value was ${original}.`
      };
    }
  },
  'compound': {
    name: 'Compound Percentage',
    description: 'Apply multiple percentage changes',
    inputs: [
      { id: 'value', label: 'Initial Value', placeholder: 'e.g., 100' },
      { id: 'percentages', label: 'Percentages', placeholder: 'e.g., +10, -5, +15' }
    ],
    calculate: (data) => {
      const value = parseFloat(data.value) || 0;
      const percentages = data.percentages.split(',').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
      let current = value;
      let steps = [];
      
      percentages.forEach((p, i) => {
        const change = (current * Math.abs(p)) / 100;
        current = p >= 0 ? current + change : current - change;
        steps.push({
          step: i + 1,
          percentage: p,
          valueBefore: i === 0 ? value : steps[i-1].valueAfter,
          valueAfter: current,
          change: p >= 0 ? change : -change
        });
      });
      
      const totalChange = current - value;
      const totalPercentage = value !== 0 ? (totalChange / value) * 100 : 0;
      
      return {
        value: value,
        percentages: percentages,
        finalValue: current,
        totalChange: totalChange,
        totalPercentage: totalPercentage,
        steps: steps,
        formula: `Multiple percentage changes applied sequentially`,
        explanation: `After applying ${percentages.length} percentage changes, the final value is ${current} (${totalPercentage >= 0 ? '+' : ''}${totalPercentage}% overall change).`
      };
    }
  },
  'markup': {
    name: 'Markup & Margin',
    description: 'Calculate markup and profit margin percentages',
    inputs: [
      { id: 'cost', label: 'Cost Price', placeholder: 'e.g., 80' },
      { id: 'price', label: 'Selling Price', placeholder: 'e.g., 100' }
    ],
    calculate: (data) => {
      const cost = parseFloat(data.cost) || 0;
      const price = parseFloat(data.price) || 0;
      const profit = price - cost;
      const markup = cost !== 0 ? (profit / cost) * 100 : 0;
      const margin = price !== 0 ? (profit / price) * 100 : 0;
      
      return {
        cost: cost,
        price: price,
        profit: profit,
        markup: markup,
        margin: margin,
        formula: `Markup: ((${price} - ${cost}) √∑ ${cost}) √ó 100 = ${markup}%<br>Margin: ((${price} - ${cost}) √∑ ${price}) √ó 100 = ${margin}%`,
        explanation: `Markup is ${markup}% on cost, margin is ${margin}% on selling price.`
      };
    }
  },
  'probability': {
    name: 'Probability & Odds',
    description: 'Convert between probability and odds',
    inputs: [
      { id: 'probability', label: 'Probability (%)', placeholder: 'e.g., 25' }
    ],
    calculate: (data) => {
      const probability = parseFloat(data.probability) || 0;
      const decimal = probability / 100;
      const oddsFor = decimal !== 0 ? (1/decimal) - 1 : Infinity;
      const oddsAgainst = decimal !== 1 ? (1/(1-decimal)) - 1 : Infinity;
      
      return {
        probability: probability,
        decimal: decimal,
        oddsFor: oddsFor,
        oddsAgainst: oddsAgainst,
        fraction: `${probability/100}`,
        formula: `Probability: ${probability}%<br>Decimal: ${decimal}<br>Odds for: ${oddsFor.toFixed(2)}:1<br>Odds against: ${oddsAgainst.toFixed(2)}:1`,
        explanation: `${probability}% chance means ${decimal} probability, ${oddsFor.toFixed(2)}:1 odds for, ${oddsAgainst.toFixed(2)}:1 odds against.`
      };
    }
  }
};

// Initialize the percentages explorer
function percentInit() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set up mode buttons
  const modeButtons = card.querySelectorAll('.mode-btn');
  modeButtons.forEach(btn => {
    btn.addEventListener('click', function() {
      modeButtons.forEach(b => b.classList.remove('active'));
      this.classList.add('active');
    });
  });
  
  // Set up precision and format listeners
  const precisionSelect = card.querySelector('#percent-precision');
  const formatSelect = card.querySelector('#percent-format');
  
  precisionSelect.addEventListener('change', percentUpdateDisplay);
  formatSelect.addEventListener('change', percentUpdateDisplay);
  
  // Load history
  percentLoadHistory();
  
  // Initialize first mode
  percentSetMode('basic');
  
  console.log('Percentages Explorer initialized');
}

// Set calculation mode
function percentSetMode(mode) {
  percentMode = mode;
  const card = document.currentScript?.closest('.card') || document;
  
  // Update mode buttons
  const modeButtons = card.querySelectorAll('.mode-btn');
  modeButtons.forEach(btn => btn.classList.remove('active'));
  card.querySelector(`.mode-btn[onclick*="${mode}"]`).classList.add('active');
  
  // Update inputs
  const inputsContainer = card.querySelector('#percent-inputs-container');
  const modeConfig = percentModes[mode];
  
  let inputsHtml = `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">`;
  
  modeConfig.inputs.forEach(input => {
    inputsHtml += `
      <div>
        <label for="percent-input-${input.id}" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">${input.label}</label>
        <input id="percent-input-${input.id}" type="number" placeholder="${input.placeholder}"
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
      </div>
    `;
  });
  
  inputsHtml += `</div>`;
  inputsContainer.innerHTML = inputsHtml;
  
  // Update description
  const descriptionEl = inputsContainer.querySelector('h4');
  descriptionEl.innerHTML = `${modeConfig.emoji || 'üìù'} ${modeConfig.name}<br><small style="color:rgba(230,250,255,0.6);font-weight:normal;">${modeConfig.description}</small>`;
  
  // Clear results
  card.querySelector('#percent-results').style.display = 'none';
}

// Format number based on user preferences
function percentFormatNumber(value) {
  const card = document.currentScript?.closest('.card') || document;
  const precision = parseInt(card.querySelector('#percent-precision').value);
  const format = card.querySelector('#percent-format').value;
  
  // Handle special cases
  if (value === Infinity || value === -Infinity) return value.toString();
  if (isNaN(value)) return 'NaN';
  
  // Apply precision
  const formatted = Math.abs(value) >= 1000000 || Math.abs(value) < 0.0001 && value !== 0
    ? value.toExponential(Math.min(4, precision))
    : value.toFixed(precision);
  
  // Apply format
  switch(format) {
    case 'decimal':
      return formatted;
    case 'percentage':
      return `${formatted}%`;
    case 'fraction':
      return percentToFraction(value);
    case 'both':
      return `${(value * 100).toFixed(precision)}% (${formatted})`;
    default:
      return formatted;
  }
}

// Convert decimal to fraction
function percentToFraction(decimal) {
  const tolerance = 1.0E-6;
  let numerator = 1;
  let denominator = 1;
  
  // Try to find simple fractions
  const commonFractions = [
    [0.25, '1/4'], [0.3333, '1/3'], [0.5, '1/2'], [0.6667, '2/3'], [0.75, '3/4'],
    [0.2, '1/5'], [0.4, '2/5'], [0.6, '3/5'], [0.8, '4/5'],
    [0.1667, '1/6'], [0.8333, '5/6'],
    [0.125, '1/8'], [0.375, '3/8'], [0.625, '5/8'], [0.875, '7/8'],
    [0.1, '1/10'], [0.3, '3/10'], [0.7, '7/10'], [0.9, '9/10']
  ];
  
  for (const [value, fraction] of commonFractions) {
    if (Math.abs(decimal - value) < tolerance) {
      return fraction;
    }
  }
  
  // If no simple fraction found, return decimal
  return decimal.toString();
}

// Main calculation function
function percentCalculate() {
  const startTime = performance.now();
  const card = document.currentScript?.closest('.card') || document;
  const modeConfig = percentModes[percentMode];
  
  // Collect input values
  const data = {};
  modeConfig.inputs.forEach(input => {
    const inputEl = card.querySelector(`#percent-input-${input.id}`);
    data[input.id] = inputEl ? inputEl.value : '';
  });
  
  // Validate inputs
  for (const input of modeConfig.inputs) {
    if (!data[input.id] && data[input.id] !== '0') {
      percentShowMessage(`Please enter ${input.label.toLowerCase()}`, '#ff2d55');
      return;
    }
  }
  
  // Perform calculation
  try {
    currentCalculation = modeConfig.calculate(data);
    currentCalculation.mode = percentMode;
    currentCalculation.timestamp = new Date().toISOString();
    
    // Display results
    percentDisplayResults(currentCalculation);
    
    // Add to history
    percentAddToHistory(currentCalculation);
    
    // Calculate and show execution time
    const endTime = performance.now();
    const timeTaken = (endTime - startTime).toFixed(2);
    card.querySelector('#percent-calculation-time').textContent = `Calculated in ${timeTaken}ms`;
    
    // Show results section
    card.querySelector('#percent-results').style.display = 'block';
    card.querySelector('#percent-results').scrollIntoView({ behavior: 'smooth', block: 'start' });
    
    percentShowMessage('Calculation complete!', '#39ff14');
    
  } catch (error) {
    console.error('Calculation error:', error);
    percentShowMessage('Calculation failed. Please check your inputs.', '#ff2d55');
  }
}

// Display calculation results
function percentDisplayResults(calc) {
  const card = document.currentScript?.closest('.card') || document;
  const outputContainer = card.querySelector('#percent-output-container');
  
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  // Main result display
  html += `<div style="text-align:center;margin-bottom:20px;">`;
  
  switch(percentMode) {
    case 'basic':
      html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${percentFormatNumber(calc.result)}</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">${calc.percentage}% of ${calc.value}</div>`;
      break;
      
    case 'increase':
      const changeType = calc.percentage >= 0 ? 'increase' : 'decrease';
      html += `<div style="font-size:48px;font-weight:600;color:${changeType === 'increase' ? '#39ff14' : '#ff2d55'};">${percentFormatNumber(calc.newValue)}</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">${calc.value} ${changeType}d by ${calc.percentage}%</div>`;
      break;
      
    case 'percentage':
      html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${percentFormatNumber(calc.percentage)}</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">${calc.part} is what % of ${calc.whole}</div>`;
      break;
      
    case 'change':
      const changeType2 = calc.percentage >= 0 ? 'increase' : 'decrease';
      html += `<div style="font-size:48px;font-weight:600;color:${changeType2 === 'increase' ? '#39ff14' : '#ff2d55'};">${percentFormatNumber(calc.percentage)}%</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">Change from ${calc.old} to ${calc.new}</div>`;
      break;
      
    case 'reverse':
      html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${percentFormatNumber(calc.original)}</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">Original value before ${calc.percentage}% change</div>`;
      break;
      
    case 'compound':
      html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${percentFormatNumber(calc.finalValue)}</div>`;
      html += `<div class="small" style="color:rgba(230,250,255,0.7);">Final value after ${calc.percentages.length} changes</div>`;
      break;
      
    case 'markup':
      html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;">`;
      html += `<div><div style="font-size:24px;color:#ffa500;">${calc.markup.toFixed(2)}%</div><small>Markup</small></div>`;
      html += `<div><div style="font-size:24px;color:#39ff14;">${calc.margin.toFixed(2)}%</div><small>Margin</small></div>`;
      html += `</div>`;
      break;
      
    case 'probability':
      html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-top:10px;">`;
      html += `<div><div style="font-size:24px;color:var(--accent);">${calc.decimal.toFixed(3)}</div><small>Decimal</small></div>`;
      html += `<div><div style="font-size:24px;color:#ffa500;">${calc.oddsFor.toFixed(2)}:1</div><small>Odds for</small></div>`;
      html += `</div>`;
      break;
  }
  
  html += `</div>`;
  
  // Key metrics grid
  html += `<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:16px;">`;
  
  Object.keys(calc).forEach(key => {
    if (typeof calc[key] === 'number' && !['timestamp', 'mode'].includes(key)) {
      let label = key.charAt(0).toUpperCase() + key.slice(1);
      let color = '#2dd4ff';
      
      if (['result', 'newValue', 'finalValue', 'margin', 'profit'].includes(key)) color = '#39ff14';
      if (['change', 'decrease', 'loss'].includes(key)) color = '#ff2d55';
      if (['percentage', 'markup', 'probability'].includes(key)) color = '#ffa500';
      
      html += `<div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;">`;
      html += `<div class="small" style="color:${color};">${label}</div>`;
      html += `<div style="font-size:18px;font-weight:600;">${percentFormatNumber(calc[key])}</div>`;
      html += `</div>`;
    }
  });
  
  html += `</div>`;
  
  // Show breakdown container
  const breakdownContainer = card.querySelector('#percent-breakdown-container');
  const breakdownContent = card.querySelector('#percent-breakdown-content');
  breakdownContainer.style.display = 'block';
  breakdownContent.innerHTML = `
    <div style="color:rgba(230,250,255,0.9);line-height:1.6;">
      <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">Formula:</div>
      <div style="font-family:monospace;background:rgba(0,0,0,0.3);padding:10px;border-radius:6px;margin-bottom:12px;">${calc.formula}</div>
      <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">Explanation:</div>
      <div>${calc.explanation}</div>
    </div>
  `;
  
  html += `</div>`;
  outputContainer.innerHTML = html;
  
  // Store for copying
  outputContainer.dataset.calculation = JSON.stringify(calc);
}

// Quick calculations
function percentQuickCalc(type) {
  const card = document.currentScript?.closest('.card') || document;
  const baseValue = parseFloat(card.querySelector('#percent-base-value').value) || 100;
  
  const quickCalcs = {
    'tip15': { value: baseValue, percentage: 15 },
    'discount20': { value: baseValue, percentage: -20 },
    'vat20': { value: baseValue, percentage: 20 },
    'increase10': { value: baseValue, percentage: 10 },
    'decrease25': { value: baseValue, percentage: -25 },
    'half': { value: baseValue, percentage: 50 },
    'double': { value: baseValue, percentage: 100 },
    'quarter': { value: baseValue, percentage: 25 }
  };
  
  if (quickCalcs[type]) {
    const calc = quickCalcs[type];
    
    // Set mode to increase/decrease
    percentSetMode('increase');
    
    // Fill inputs
    card.querySelector('#percent-input-value').value = calc.value;
    card.querySelector('#percent-input-percentage').value = calc.percentage;
    
    // Calculate
    percentCalculate();
    
    percentShowMessage(`Applied ${Math.abs(calc.percentage)}% ${calc.percentage >= 0 ? 'increase' : 'decrease'}`, '#2dd4ff');
  }
}

// Apply quick percentage
function percentQuickApply() {
  const card = document.currentScript?.closest('.card') || document;
  const baseValue = parseFloat(card.querySelector('#percent-base-value').value) || 0;
  const quickValue = parseFloat(card.querySelector('#percent-quick-value').value) || 0;
  
  if (!baseValue) {
    percentShowMessage('Please enter a base value', '#ff2d55');
    return;
  }
  
  // Set mode to increase/decrease
  percentSetMode('increase');
  
  // Fill inputs
  card.querySelector('#percent-input-value').value = baseValue;
  card.querySelector('#percent-input-percentage').value = quickValue;
  
  // Calculate
  percentCalculate();
}

// Load example scenarios
function percentLoadExample(type) {
  const card = document.currentScript?.closest('.card') || document;
  
  const examples = {
    'sales_tax': { mode: 'increase', inputs: { value: 100, percentage: 8.5 } },
    'salary_increase': { mode: 'increase', inputs: { value: 50000, percentage: 5 } },
    'investment_growth': { mode: 'compound', inputs: { value: 1000, percentages: '7,7,7' } },
    'population_growth': { mode: 'increase', inputs: { value: 1000000, percentage: 1.2 } },
    'recipe_adjust': { mode: 'increase', inputs: { value: 4, percentage: 150 } },
    'test_score': { mode: 'percentage', inputs: { part: 85, whole: 100 } },
    'discount_series': { mode: 'compound', inputs: { value: 100, percentages: '-30,-20' } },
    'probability': { mode: 'probability', inputs: { probability: 75 } }
  };
  
  if (examples[type]) {
    const example = examples[type];
    
    // Set mode
    percentSetMode(example.mode);
    
    // Fill inputs
    Object.keys(example.inputs).forEach(key => {
      const inputEl = card.querySelector(`#percent-input-${key}`);
      if (inputEl) {
        inputEl.value = example.inputs[key];
      }
    });
    
    percentShowMessage('Example loaded. Click Calculate to see results.', '#ffa500');
  }
}

// Visualize percentage
function percentVisualize() {
  if (!currentCalculation) {
    percentShowMessage('No calculation to visualize', '#ff2d55');
    return;
  }
  
  const card = document.currentScript?.closest('.card') || document;
  const container = card.querySelector('#percent-visualization-content');
  const vizContainer = card.querySelector('#percent-visualization-container');
  
  let html = `<div style="display:grid;gap:16px;">`;
  
  switch(percentMode) {
    case 'basic':
      const total = currentCalculation.value;
      const part = currentCalculation.result;
      const percentage = currentCalculation.percentage;
      
      html += `<div style="text-align:center;color:var(--accent);font-weight:500;margin-bottom:8px;">${percentage}% of ${total} = ${part}</div>`;
      html += `<div style="height:40px;background:rgba(255,255,255,0.1);border-radius:8px;overflow:hidden;position:relative;">`;
      html += `<div style="position:absolute;top:0;left:0;height:100%;width:100%;background:linear-gradient(90deg, #2dd4ff, transparent);"></div>`;
      html += `<div style="position:absolute;top:0;left:0;height:100%;width:${percentage}%;background:linear-gradient(90deg, #39ff14, #2dd4ff);"></div>`;
      html += `<div style="position:absolute;top:50%;left:${percentage}%;transform:translate(-50%,-50%);background:#fff;color:#000;padding:2px 6px;border-radius:4px;font-size:12px;font-weight:600;">${percentage}%</div>`;
      html += `</div>`;
      html += `<div style="display:flex;justify-content:space-between;font-size:12px;color:rgba(230,250,255,0.7);">`;
      html += `<div>0% (0)</div>`;
      html += `<div>${percentage}% (${part})</div>`;
      html += `<div>100% (${total})</div>`;
      html += `</div>`;
      break;
      
    case 'increase':
    case 'decrease':
      const oldVal = currentCalculation.value;
      const newVal = currentCalculation.newValue;
      const changePct = currentCalculation.percentage;
      const changeVal = currentCalculation.change;
      
      html += `<div style="display:grid;grid-template-columns:1fr auto 1fr;gap:20px;align-items:center;">`;
      html += `<div style="text-align:center;">`;
      html += `<div style="font-size:24px;color:#2dd4ff;">${oldVal}</div>`;
      html += `<div style="font-size:12px;color:rgba(230,250,255,0.7);">Original</div>`;
      html += `</div>`;
      
      html += `<div style="text-align:center;">`;
      html += `<div style="font-size:32px;color:${changePct >= 0 ? '#39ff14' : '#ff2d55'};">${changePct >= 0 ? '‚Üí' : '‚Üê'}</div>`;
      html += `<div style="font-size:12px;color:${changePct >= 0 ? '#39ff14' : '#ff2d55'};">${changePct}% (${Math.abs(changeVal)})</div>`;
      html += `</div>`;
      
      html += `<div style="text-align:center;">`;
      html += `<div style="font-size:24px;color:${changePct >= 0 ? '#39ff14' : '#ff2d55'};">${newVal}</div>`;
      html += `<div style="font-size:12px;color:rgba(230,250,255,0.7);">New Value</div>`;
      html += `</div>`;
      html += `</div>`;
      break;
      
    case 'percentage':
      const part2 = currentCalculation.part;
      const whole2 = currentCalculation.whole;
      const pct2 = currentCalculation.percentage;
      
      html += `<div style="height:60px;position:relative;">`;
      html += `<div style="position:absolute;top:0;left:0;right:0;height:30px;background:rgba(45,212,255,0.2);border-radius:6px;overflow:hidden;">`;
      html += `<div style="height:100%;width:${pct2}%;background:linear-gradient(90deg, #2dd4ff, #39ff14);"></div>`;
      html += `</div>`;
      html += `<div style="position:absolute;top:40px;left:0;right:0;text-align:center;font-size:12px;color:rgba(230,250,255,0.7);">`;
      html += `${part2} / ${whole2} = ${pct2.toFixed(2)}%`;
      html += `</div>`;
      html += `</div>`;
      break;
      
    case 'markup':
      const cost = currentCalculation.cost;
      const price = currentCalculation.price;
      const markup = currentCalculation.markup;
      const margin = currentCalculation.margin;
      
      html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;">`;
      
      // Cost breakdown
      html += `<div style="padding:12px;background:rgba(45,212,255,0.1);border-radius:8px;">`;
      html += `<div style="color:#2dd4ff;font-weight:500;margin-bottom:8px;">Cost Breakdown</div>`;
      html += `<div style="height:20px;background:#2dd4ff;border-radius:4px;margin-bottom:4px;" title="Cost: ${cost}"></div>`;
      html += `<div style="height:20px;background:#39ff14;border-radius:4px;" title="Profit: ${currentCalculation.profit}"></div>`;
      html += `<div style="font-size:11px;color:rgba(230,250,255,0.6);margin-top:4px;">Cost: ${cost} | Profit: ${currentCalculation.profit}</div>`;
      html += `</div>`;
      
      // Percentage breakdown
      html += `<div style="padding:12px;background:rgba(255,165,0,0.1);border-radius:8px;">`;
      html += `<div style="color:#ffa500;font-weight:500;margin-bottom:8px;">Percentages</div>`;
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">`;
      html += `<div style="flex:1;height:12px;background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;">`;
      html += `<div style="height:100%;width:${markup}%;background:#ffa500;"></div>`;
      html += `</div>`;
      html += `<div style="font-size:12px;color:#ffa500;">${markup.toFixed(1)}% Markup</div>`;
      html += `</div>`;
      html += `<div style="display:flex;align-items:center;gap:8px;">`;
      html += `<div style="flex:1;height:12px;background:rgba(255,255,255,0.2);border-radius:6px;overflow:hidden;">`;
      html += `<div style="height:100%;width:${margin}%;background:#39ff14;"></div>`;
      html += `</div>`;
      html += `<div style="font-size:12px;color:#39ff14;">${margin.toFixed(1)}% Margin</div>`;
      html += `</div>`;
      html += `</div>`;
      
      html += `</div>`;
      break;
  }
  
  html += `</div>`;
  container.innerHTML = html;
  vizContainer.style.display = 'block';
  vizContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Show fraction equivalents
function percentShowFractions() {
  if (!currentCalculation) {
    percentShowMessage('No calculation to convert', '#ff2d55');
    return;
  }
  
  const card = document.currentScript?.closest('.card') || document;
  const container = card.querySelector('#percent-fractions-content');
  const fracContainer = card.querySelector('#percent-fractions-container');
  
  let percentage;
  
  // Extract percentage value based on mode
  switch(percentMode) {
    case 'basic':
    case 'increase':
    case 'reverse':
      percentage = currentCalculation.percentage;
      break;
    case 'percentage':
    case 'change':
      percentage = Math.abs(currentCalculation.percentage);
      break;
    case 'probability':
      percentage = currentCalculation.probability;
      break;
    case 'markup':
      percentage = currentCalculation.markup;
      break;
    default:
      percentage = 0;
  }
  
  const decimal = percentage / 100;
  
  // Common fractions
  const commonFractions = [
    { decimal: 0.01, fraction: '1/100' },
    { decimal: 0.05, fraction: '1/20' },
    { decimal: 0.1, fraction: '1/10' },
    { decimal: 0.111, fraction: '1/9' },
    { decimal: 0.125, fraction: '1/8' },
    { decimal: 0.1667, fraction: '1/6' },
    { decimal: 0.2, fraction: '1/5' },
    { decimal: 0.25, fraction: '1/4' },
    { decimal: 0.3333, fraction: '1/3' },
    { decimal: 0.375, fraction: '3/8' },
    { decimal: 0.4, fraction: '2/5' },
    { decimal: 0.5, fraction: '1/2' },
    { decimal: 0.6, fraction: '3/5' },
    { decimal: 0.625, fraction: '5/8' },
    { decimal: 0.6667, fraction: '2/3' },
    { decimal: 0.75, fraction: '3/4' },
    { decimal: 0.8, fraction: '4/5' },
    { decimal: 0.8333, fraction: '5/6' },
    { decimal: 0.875, fraction: '7/8' },
    { decimal: 0.9, fraction: '9/10' },
    { decimal: 0.95, fraction: '19/20' },
    { decimal: 0.99, fraction: '99/100' }
  ];
  
  // Find closest fractions
  const closestFractions = commonFractions
    .map(f => ({
      fraction: f.fraction,
      decimal: f.decimal,
      difference: Math.abs(f.decimal - decimal)
    }))
    .sort((a, b) => a.difference - b.difference)
    .slice(0, 5);
  
  let html = `<div style="display:grid;gap:12px;">`;
  html += `<div style="text-align:center;color:var(--accent);font-weight:500;margin-bottom:8px;">${percentage}% = ${decimal.toFixed(4)}</div>`;
  html += `<div style="display:grid;gap:8px;">`;
  
  closestFractions.forEach(f => {
    const fractionPct = (f.decimal * 100).toFixed(2);
    const diffPct = Math.abs(percentage - fractionPct).toFixed(2);
    
    html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;">`;
    html += `<div style="font-family:monospace;color:#fff;">${f.fraction}</div>`;
    html += `<div style="color:var(--accent);">${fractionPct}%</div>`;
    html += `<div style="font-size:12px;color:${diffPct <= 1 ? '#39ff14' : diffPct <= 5 ? '#ffa500' : '#ff2d55'};">${diffPct <= 0.1 ? '‚âà' : '~'} ${diffPct}%</div>`;
    html += `</div>`;
  });
  
  html += `</div>`;
  html += `<div style="font-size:12px;color:rgba(230,250,255,0.6);text-align:center;margin-top:8px;">`;
  html += `Closest fraction equivalents (difference shown)`;
  html += `</div>`;
  html += `</div>`;
  
  container.innerHTML = html;
  fracContainer.style.display = 'block';
}

// Generate percentage comparison table
function percentGenerateTable() {
  const card = document.currentScript?.closest('.card') || document;
  const container = card.querySelector('#percent-comparison-content');
  const compContainer = card.querySelector('#percent-comparison-container');
  
  let baseValue = 100;
  if (currentCalculation && currentCalculation.value) {
    baseValue = currentCalculation.value;
  }
  
  let html = `<div style="display:grid;gap:8px;">`;
  html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;background:rgba(45,212,255,0.1);border-radius:6px;font-weight:500;color:var(--accent);">`;
  html += `<div>Percentage</div><div>Value of ${baseValue}</div><div>Change</div>`;
  html += `</div>`;
  
  const percentages = [1, 5, 10, 15, 20, 25, 30, 40, 50, 75, 100, 150, 200];
  
  percentages.forEach(p => {
    const value = (baseValue * p) / 100;
    const change = value - baseValue;
    const changeSign = change >= 0 ? '+' : '';
    
    html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;border-left:3px solid ${p < 100 ? '#ff2d55' : p === 100 ? '#2dd4ff' : '#39ff14'};">`;
    html += `<div style="color:${p < 100 ? '#ff2d55' : p === 100 ? '#2dd4ff' : '#39ff14'};">${p}%</div>`;
    html += `<div>${value.toFixed(2)}</div>`;
    html += `<div style="color:${change >= 0 ? '#39ff14' : '#ff2d55'};">${changeSign}${change.toFixed(2)}</div>`;
    html += `</div>`;
  });
  
  html += `</div>`;
  container.innerHTML = html;
  compContainer.style.display = 'block';
  compContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Show formula
function percentShowFormula() {
  if (!currentCalculation) {
    percentShowMessage('No calculation to show formula for', '#ff2d55');
    return;
  }
  
  const card = document.currentScript?.closest('.card') || document;
  const formulaHtml = currentCalculation.formula.replace(/\n/g, '<br>');
  
  percentShowMessage(`Formula: ${formulaHtml}`, '#2dd4ff', 5000);
}

// Export data
function percentExportData() {
  if (!currentCalculation) {
    percentShowMessage('No data to export', '#ff2d55');
    return;
  }
  
  let csv = 'Calculation Type,Timestamp\n';
  csv += `${percentModes[percentMode].name},${new Date().toLocaleString()}\n\n`;
  csv += 'Metric,Value\n';
  
  Object.keys(currentCalculation).forEach(key => {
    if (typeof currentCalculation[key] === 'number' && !['timestamp', 'mode'].includes(key)) {
      csv += `${key},${currentCalculation[key]}\n`;
    }
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `percentage-calculation-${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  percentShowMessage('‚úÖ Data exported as CSV', '#39ff14');
}

// Share results
function percentShareResults() {
  if (!currentCalculation) {
    percentShowMessage('No results to share', '#ff2d55');
    return;
  }
  
  let shareText = `üìä Percentage Calculation: `;
  
  switch(percentMode) {
    case 'basic':
      shareText += `${currentCalculation.percentage}% of ${currentCalculation.value} = ${currentCalculation.result}`;
      break;
    case 'increase':
      shareText += `${currentCalculation.value} increased by ${currentCalculation.percentage}% = ${currentCalculation.newValue}`;
      break;
    case 'percentage':
      shareText += `${currentCalculation.part} is ${currentCalculation.percentage.toFixed(2)}% of ${currentCalculation.whole}`;
      break;
    case 'change':
      shareText += `${currentCalculation.old} to ${currentCalculation.new} = ${currentCalculation.percentage.toFixed(2)}% change`;
      break;
    default:
      shareText += `Calculated with The Most Useful Site's Percentage Explorer`;
  }
  
  if (navigator.share) {
    navigator.share({
      title: 'Percentage Calculation',
      text: shareText,
      url: window.location.href
    }).catch(console.error);
  } else {
    navigator.clipboard.writeText(shareText).then(() => {
      percentShowMessage('‚úÖ Results copied to share!', '#39ff14');
    });
  }
}

// Toggle advanced panel
function percentToggleAdvanced() {
  const advancedPanel = document.getElementById('percent-advanced');
  advancedPanel.style.display = advancedPanel.style.display === 'none' ? 'block' : 'none';
}

// Calculate exponential growth
function percentCalculateGrowth() {
  const initial = parseFloat(document.getElementById('percent-growth-initial').value) || 0;
  const rate = parseFloat(document.getElementById('percent-growth-rate').value) || 0;
  const periods = parseFloat(document.getElementById('percent-growth-periods').value) || 1;
  
  if (!initial || !rate) {
    percentShowMessage('Please enter initial value and growth rate', '#ff2d55');
    return;
  }
  
  const final = initial * Math.pow(1 + rate/100, periods);
  const totalGrowth = final - initial;
  const totalPercentage = (totalGrowth / initial) * 100;
  
  const result = `Initial: ${initial}<br>Growth Rate: ${rate}% per period<br>Periods: ${periods}<br>Final Value: ${final.toFixed(2)}<br>Total Growth: ${totalGrowth.toFixed(2)} (${totalPercentage.toFixed(2)}%)`;
  
  percentShowMessage(result, '#2dd4ff', 6000);
}

// Calculate depreciation
function percentCalculateDepreciation() {
  const initial = parseFloat(document.getElementById('percent-depreciation-initial').value) || 0;
  const rate = parseFloat(document.getElementById('percent-depreciation-rate').value) || 0;
  const years = parseFloat(document.getElementById('percent-depreciation-periods').value) || 1;
  
  if (!initial || !rate) {
    percentShowMessage('Please enter initial value and depreciation rate', '#ff2d55');
    return;
  }
  
  const final = initial * Math.pow(1 - rate/100, years);
  const totalDepreciation = initial - final;
  const totalPercentage = (totalDepreciation / initial) * 100;
  
  const result = `Initial: ${initial}<br>Depreciation Rate: ${rate}% per year<br>Years: ${years}<br>Final Value: ${final.toFixed(2)}<br>Total Depreciation: ${totalDepreciation.toFixed(2)} (${totalPercentage.toFixed(2)}%)`;
  
  percentShowMessage(result, '#ff2d55', 6000);
}

// Show history
function percentShowHistory() {
  const card = document.currentScript?.closest('.card') || document;
  const historyPanel = card.querySelector('#percent-history');
  const historyContent = card.querySelector('#percent-history-content');
  
  if (percentHistory.length === 0) {
    historyContent.innerHTML = `<div style="text-align:center;padding:20px;color:rgba(230,250,255,0.7);">No calculation history yet</div>`;
  } else {
    let html = `<div style="display:grid;gap:8px;">`;
    
    percentHistory.slice(0, 10).forEach((calc, index) => {
      const modeName = percentModes[calc.mode]?.name || calc.mode;
      const time = new Date(calc.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      
      html += `<div style="padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;border-left:3px solid var(--accent);">`;
      html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">`;
      html += `<div style="font-weight:500;color:var(--accent);">${modeName}</div>`;
      html += `<div style="font-size:11px;color:rgba(230,250,255,0.5);">${time}</div>`;
      html += `</div>`;
      
      // Show key result
      let resultText = '';
      if (calc.result !== undefined) resultText = `Result: ${calc.result}`;
      else if (calc.newValue !== undefined) resultText = `New Value: ${calc.newValue}`;
      else if (calc.percentage !== undefined) resultText = `Percentage: ${calc.percentage}%`;
      
      html += `<div style="font-size:12px;color:rgba(230,250,255,0.8);">${resultText}</div>`;
      html += `</div>`;
    });
    
    html += `</div>`;
    historyContent.innerHTML = html;
  }
  
  historyPanel.style.display = 'block';
  historyPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Add to history
function percentAddToHistory(calc) {
  percentHistory.unshift(calc);
  if (percentHistory.length > 20) {
    percentHistory.pop();
  }
  
  // Save to localStorage
  try {
    localStorage.setItem('percent_history', JSON.stringify(percentHistory.slice(0, 10)));
  } catch (e) {
    console.log('Could not save history');
  }
}

// Load history from localStorage
function percentLoadHistory() {
  try {
    const saved = localStorage.getItem('percent_history');
    if (saved) {
      percentHistory = JSON.parse(saved) || [];
    }
  } catch (e) {
    console.log('No saved history found');
  }
}

// Copy results
function percentCopyResults() {
  if (!currentCalculation) {
    percentShowMessage('No results to copy', '#ff2d55');
    return;
  }
  
  let text = `üìä Percentage Calculation Results\n`;
  text += `Mode: ${percentModes[percentMode].name}\n`;
  text += `Timestamp: ${new Date().toLocaleString()}\n\n`;
  
  Object.keys(currentCalculation).forEach(key => {
    if (typeof currentCalculation[key] === 'number' && !['timestamp', 'mode'].includes(key)) {
      text += `${key.charAt(0).toUpperCase() + key.slice(1)}: ${currentCalculation[key]}\n`;
    }
  });
  
  navigator.clipboard.writeText(text).then(() => {
    percentShowMessage('‚úÖ Results copied to clipboard!', '#39ff14');
  }).catch(err => {
    console.error('Copy failed:', err);
    percentShowMessage('‚ùå Copy failed', '#ff2d55');
  });
}

// Print results
function percentPrintResults() {
  window.print();
}

// Reset calculator
function percentReset() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Clear inputs
  const inputs = card.querySelectorAll('#percent-inputs-container input');
  inputs.forEach(input => input.value = '');
  
  // Clear base value
  card.querySelector('#percent-base-value').value = '';
  
  // Hide results
  card.querySelector('#percent-results').style.display = 'none';
  card.querySelector('#percent-breakdown-container').style.display = 'none';
  card.querySelector('#percent-visualization-container').style.display = 'none';
  card.querySelector('#percent-fractions-container').style.display = 'none';
  card.querySelector('#percent-comparison-container').style.display = 'none';
  
  // Hide advanced panels
  document.getElementById('percent-advanced').style.display = 'none';
  document.getElementById('percent-history').style.display = 'none';
  
  percentShowMessage('Calculator reset', '#ffa500');
}

// Update display based on preferences
function percentUpdateDisplay() {
  if (currentCalculation) {
    percentDisplayResults(currentCalculation);
  }
}

// Helper function to show messages
function percentShowMessage(message, color, duration = 3000) {
  const card = document.currentScript?.closest('.card') || document;
  const hint = card.querySelector('#percent-hint');
  hint.innerHTML = message;
  hint.style.color = color;
  setTimeout(() => {
    if (hint.innerHTML === message) hint.innerHTML = '';
  }, duration);
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', percentInit);
} else {
  percentInit();
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    percentCalculate();
  }
  if (e.key === 'Escape') {
    percentReset();
  }
  if (e.key === 'v' && (e.ctrlKey || e.metaKey)) {
    percentVisualize();
  }
});
</script>

<style>
#percentages-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.3rem;
  margin-bottom: 4px;
}

.mode-btn {
  padding: 10px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  color: rgba(230,250,255,0.7);
  cursor: pointer;
  font-size: 13px;
  transition: all 0.2s;
  text-align: center;
}

.mode-btn.active {
  background: rgba(45,212,255,0.15);
  border-color: rgba(45,212,255,0.4);
  color: var(--accent);
  font-weight: 500;
}

.mode-btn:hover:not(.active) {
  background: rgba(255,255,255,0.05);
  border-color: rgba(255,255,255,0.15);
  transform: translateY(-1px);
}

.quick-btn {
  padding: 8px;
  background: rgba(45,212,255,0.05);
  border: 1px solid rgba(45,212,255,0.2);
  border-radius: 6px;
  color: var(--accent);
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.quick-btn:hover {
  background: rgba(45,212,255,0.1);
  border-color: rgba(45,212,255,0.3);
  transform: translateY(-1px);
}

.example-btn {
  padding: 8px;
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  color: rgba(230,250,255,0.8);
  cursor: pointer;
  font-size: 12px;
  transition: all 0.2s;
}

.example-btn:hover {
  background: rgba(255,165,0,0.1);
  border-color: rgba(255,165,0,0.3);
  color: #ffa500;
  transform: translateY(-1px);
}

details summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
}

details summary::-webkit-details-marker {
  display: none;
}

details summary::after {
  content: '‚ñ∂';
  float: right;
  transition: transform 0.2s;
  color: var(--accent);
}

details[open] summary::after {
  transform: rotate(90deg);
}

/* Scrollbar styling */
#percent-comparison-content,
#percent-history-content {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) rgba(255,255,255,0.05);
}

#percent-comparison-content::-webkit-scrollbar,
#percent-history-content::-webkit-scrollbar {
  width: 6px;
}

#percent-comparison-content::-webkit-scrollbar-track,
#percent-history-content::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 3px;
}

#percent-comparison-content::-webkit-scrollbar-thumb,
#percent-history-content::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 3px;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .mode-btn {
    padding: 12px 8px;
    font-size: 11px;
  }
  
  .actions {
    flex-direction: column;
    gap: 8px !important;
  }
  
  .actions button {
    width: 100%;
    margin: 0 !important;
  }
  
  #percent-results > div > div {
    grid-template-columns: 1fr !important;
  }
  
  .quick-btn, .example-btn {
    padding: 10px;
    font-size: 13px;
  }
}

@media (max-width: 480px) {
  .percent-section > div {
    grid-template-columns: 1fr !important;
  }
  
  #percent-inputs-container > div {
    grid-template-columns: 1fr !important;
  }
  
  .mode-btn-grid {
    grid-template-columns: repeat(2, 1fr) !important;
  }
}

/* Print styles */
@media print {
  #percent-results {
    display: block !important;
  }
  
  button, .actions, .mode-btn, .quick-btn, .example-btn {
    display: none !important;
  }
  
  #percent-output-container > div {
    break-inside: avoid;
  }
}
</style>
