<h2 id="sp-title">üñºÔ∏è Social Preview Generator</h2>
<p id="sp-desc" class="small">
    Create perfectly sized Open Graph and Twitter preview images with custom branding, 
    layouts, and auto-generated HTML meta tags.
    <em>For enterprise social media management with scheduling and analytics, try 
        <a href="https://affiliate.example.com/social-pro" 
           data-affiliate="social-pro" 
           target="_blank" 
           rel="sponsored nofollow"
           onclick="trackAffiliateClick('social-pro')">
           Social Media Pro
        </a>.
    </em>
</p>

<!-- ===== 2. INTERFACE ===== -->
<div class="sp-interface">
    
    <!-- Quick Presets -->
    <div class="sp-presets">
        <button class="sp-preset active" data-size="1200x630" data-platform="facebook">Facebook</button>
        <button class="sp-preset" data-size="1200x675" data-platform="twitter">Twitter/X</button>
        <button class="sp-preset" data-size="1080x1080" data-platform="instagram">Instagram</button>
        <button class="sp-preset" data-size="1280x720" data-platform="youtube">YouTube</button>
        <button class="sp-preset" data-size="1200x627" data-platform="linkedin">LinkedIn</button>
    </div>

    <!-- Content Section -->
    <div class="sp-content">
        <div class="sp-field-group">
            <div class="sp-field">
                <label for="sp-title-input">Headline</label>
                <input type="text" id="sp-title-input" placeholder="Catchy headline here..." 
                       value="Introducing Our New Product">
                <div class="sp-counter">
                    <span id="sp-title-count">0</span>/60 characters
                </div>
            </div>
            
            <div class="sp-field">
                <label for="sp-subtitle-input">Description</label>
                <textarea id="sp-subtitle-input" placeholder="Supporting description...">Revolutionizing the way you work with cutting-edge technology</textarea>
                <div class="sp-counter">
                    <span id="sp-subtitle-count">0</span>/120 characters
                </div>
            </div>
        </div>

        <!-- Design Controls -->
        <div class="sp-design">
            <h4>üé® Design</h4>
            
            <div class="sp-color-grid">
                <div class="sp-color-picker">
                    <label for="sp-primary-color">Primary Color</label>
                    <div class="color-input">
                        <input type="color" id="sp-primary-color" value="#2dd4ff">
                        <input type="text" id="sp-primary-hex" value="#2DD4FF">
                    </div>
                </div>
                
                <div class="sp-color-picker">
                    <label for="sp-secondary-color">Secondary Color</label>
                    <div class="color-input">
                        <input type="color" id="sp-secondary-color" value="#6366f1">
                        <input type="text" id="sp-secondary-hex" value="#6366F1">
                    </div>
                </div>
                
                <div class="sp-selector">
                    <label for="sp-layout">Layout</label>
                    <select id="sp-layout">
                        <option value="gradient">Gradient</option>
                        <option value="solid">Solid Color</option>
                        <option value="split">Split Layout</option>
                        <option value="pattern">Pattern</option>
                        <option value="image">Background Image</option>
                    </select>
                </div>
                
                <div class="sp-selector">
                    <label for="sp-font">Font Family</label>
                    <select id="sp-font">
                        <option value="inter">Inter</option>
                        <option value="roboto">Roboto</option>
                        <option value="poppins">Poppins</option>
                        <option value="montserrat">Montserrat</option>
                        <option value="opensans">Open Sans</option>
                    </select>
                </div>
            </div>

            <!-- Logo Upload -->
            <div class="sp-upload-section">
                <div class="sp-upload">
                    <label for="sp-logo-input">Logo (Optional)</label>
                    <div class="upload-area" id="logo-upload">
                        <div class="upload-icon">üìÅ</div>
                        <div class="upload-text">Click or drop logo</div>
                        <input type="file" id="sp-logo-input" accept="image/*" hidden>
                    </div>
                    <div id="logo-preview" class="preview-container" style="display: none;">
                        <img id="logo-preview-img">
                        <button id="remove-logo">‚úï</button>
                    </div>
                </div>
                
                <div class="sp-upload">
                    <label for="sp-bg-input">Background Image (Optional)</label>
                    <div class="upload-area" id="bg-upload">
                        <div class="upload-icon">üåÖ</div>
                        <div class="upload-text">Click or drop background</div>
                        <input type="file" id="sp-bg-input" accept="image/*" hidden>
                    </div>
                    <div id="bg-preview" class="preview-container" style="display: none;">
                        <img id="bg-preview-img">
                        <button id="remove-bg">‚úï</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Generate Button -->
    <button id="sp-generate" class="generate-btn">
        ‚ö° Generate Preview
    </button>
</div>

<!-- ===== 3. RESULTS ===== -->
<div class="sp-results" id="sp-results" style="display: none;">
    
    <!-- Preview Container -->
    <div class="sp-preview-container">
        <div class="sp-preview">
            <canvas id="sp-canvas"></canvas>
            <div class="sp-loading" id="sp-loading">
                <div class="spinner"></div>
                <p>Generating preview...</p>
            </div>
        </div>
        
        <!-- Preview Stats -->
        <div class="sp-preview-stats">
            <div class="sp-stat">
                <span class="stat-label">Size:</span>
                <span class="stat-value" id="sp-size-display">1200√ó630</span>
            </div>
            <div class="sp-stat">
                <span class="stat-label">Platform:</span>
                <span class="stat-value" id="sp-platform-display">Facebook/Open Graph</span>
            </div>
            <div class="sp-stat">
                <span class="stat-label">Ratio:</span>
                <span class="stat-value" id="sp-ratio-display">1.91:1</span>
            </div>
            <div class="sp-stat">
                <span class="stat-label">File Size:</span>
                <span class="stat-value" id="sp-filesize">~150 KB</span>
            </div>
        </div>
    </div>

    <!-- Download Options -->
    <div class="sp-download">
        <h4>üì• Download</h4>
        <div class="download-buttons">
            <button class="download-btn" data-format="png">
                <span>üñºÔ∏è</span> PNG
            </button>
            <button class="download-btn" data-format="jpg">
                <span>üñºÔ∏è</span> JPG
            </button>
            <button class="download-btn" data-format="webp">
                <span>üñºÔ∏è</span> WebP
            </button>
            <button class="download-btn" data-format="svg">
                <span>üìê</span> SVG
            </button>
        </div>
    </div>

    <!-- HTML Meta Tags -->
    <div class="sp-meta-tags">
        <h4>üîó HTML Meta Tags</h4>
        <div class="meta-tabs">
            <button class="meta-tab active" data-type="opengraph">Open Graph</button>
            <button class="meta-tab" data-type="twitter">Twitter</button>
            <button class="meta-tab" data-type="linkedin">LinkedIn</button>
            <button class="meta-tab" data-type="whatsapp">WhatsApp</button>
        </div>
        
        <div class="meta-code-container">
            <textarea id="sp-meta-code" readonly></textarea>
            <button id="copy-meta" class="copy-btn">Copy</button>
        </div>
    </div>

    <!-- Batch Export -->
    <div class="sp-batch">
        <h4>üîÑ Generate All Sizes</h4>
        <p>Generate for all platforms at once:</p>
        <div class="platform-grid" id="platform-grid">
            <!-- Platform checkboxes will go here -->
        </div>
        <button id="generate-all" class="secondary-btn">
            üöÄ Generate All
        </button>
        <div id="batch-results" style="display: none;">
            <div class="batch-grid" id="batch-preview-grid"></div>
            <button id="download-batch" class="primary-btn">
                üì¶ Download All as ZIP
            </button>
        </div>
    </div>
</div>

<!-- ===== 4. SHARING ===== -->
<div class="share-temple" style="margin-top: var(--space-xl);">
    <div class="share-options">
        <button onclick="spShare()" class="share-btn">
            <span>üì§</span>
            <span>Share this tool</span>
        </button>
        <button onclick="spEmbed()" class="share-btn">
            <span>üîó</span>
            <span>Embed in your site</span>
        </button>
        <button onclick="spApi()" class="share-btn">
            <span>‚ö°</span>
            <span>API Access</span>
        </button>
    </div>
</div>

<!-- ===== 5. AFFILIATE DISCLOSURE ===== -->
<div class="affiliate-disclosure" id="sp-affiliate" style="display: none;">
    <strong>üì± Need Professional Social Media Tools?</strong> For scheduling, analytics, team collaboration, and AI-powered content generation, check out 
    <a href="https://affiliate.example.com/social-pro" 
       data-affiliate="social-pro" 
       target="_blank" 
       rel="sponsored nofollow"
       onclick="trackAffiliateClick('social-pro')">
       Social Media Pro
    </a>.
    <small>We may earn a commission. Supports free tools.</small>
</div>

<!-- ===== 6. JAVASCRIPT ===== -->
<script>
// ==================== CONFIGURATION ====================
const SP_CONFIG = {
    name: 'Social Preview Generator',
    version: '2.0.0',
    prefix: 'sp_',
    maxTitleLength: 60,
    maxSubtitleLength: 120,
    platforms: {
        'facebook': { 
            name: 'Facebook/Open Graph', 
            size: { w: 1200, h: 630 },
            ratio: '1.91:1',
            meta: ['og:image']
        },
        'twitter': { 
            name: 'Twitter/X', 
            size: { w: 1200, h: 675 },
            ratio: '16:9',
            meta: ['twitter:image']
        },
        'instagram': { 
            name: 'Instagram', 
            size: { w: 1080, h: 1080 },
            ratio: '1:1',
            meta: []
        },
        'youtube': { 
            name: 'YouTube', 
            size: { w: 1280, h: 720 },
            ratio: '16:9',
            meta: []
        },
        'linkedin': { 
            name: 'LinkedIn', 
            size: { w: 1200, h: 627 },
            ratio: '1.91:1',
            meta: ['og:image']
        }
    }
};

// ==================== STATE ====================
let spState = {
    currentPlatform: 'facebook',
    logoImage: null,
    bgImage: null,
    generatedImage: null,
    settings: {
        primaryColor: '#2dd4ff',
        secondaryColor: '#6366f1',
        layout: 'gradient',
        font: 'inter'
    }
};

// ==================== INITIALIZATION ====================
function initSocialPreview() {
    // Load saved state
    loadState();
    
    // Setup platform presets
    document.querySelectorAll('.sp-preset').forEach(btn => {
        btn.addEventListener('click', () => {
            const platform = btn.dataset.platform;
            selectPlatform(platform, btn);
        });
    });
    
    // Setup character counters
    setupCharacterCounters();
    
    // Setup color pickers
    setupColorPickers();
    
    // Setup file uploads
    setupFileUploads();
    
    // Setup generate button
    document.getElementById('sp-generate').addEventListener('click', generatePreview);
    
    // Setup download buttons
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const format = e.currentTarget.dataset.format;
            downloadImage(format);
        });
    });
    
    // Setup meta tabs
    document.querySelectorAll('.meta-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const type = tab.dataset.type;
            updateMetaCode(type);
        });
    });
    
    // Setup copy button
    document.getElementById('copy-meta').addEventListener('click', copyMetaCode);
    
    // Setup batch generation
    document.getElementById('generate-all').addEventListener('click', generateAllPlatforms);
    document.getElementById('download-batch').addEventListener('click', downloadBatchZip);
    
    // Initialize platform grid
    initPlatformGrid();
    
    // Generate initial preview
    setTimeout(() => generatePreview(), 500);
    
    console.log('üñºÔ∏è Social Preview Generator initialized');
}

function selectPlatform(platform, button) {
    // Update UI
    document.querySelectorAll('.sp-preset').forEach(btn => btn.classList.remove('active'));
    button.classList.add('active');
    
    spState.currentPlatform = platform;
    
    // Update platform info display
    updatePlatformInfo(platform);
    
    // Auto-generate if we have content
    if (document.getElementById('sp-title-input').value) {
        setTimeout(() => generatePreview(), 100);
    }
}

function updatePlatformInfo(platform) {
    const info = SP_CONFIG.platforms[platform];
    if (!info) return;
    
    document.getElementById('sp-platform-display').textContent = info.name;
    document.getElementById('sp-size-display').textContent = `${info.size.w}√ó${info.size.h}`;
    document.getElementById('sp-ratio-display').textContent = info.ratio;
}

function setupCharacterCounters() {
    const titleInput = document.getElementById('sp-title-input');
    const subtitleInput = document.getElementById('sp-subtitle-input');
    
    titleInput.addEventListener('input', function() {
        const length = this.value.length;
        document.getElementById('sp-title-count').textContent = length;
        document.getElementById('sp-title-count').className = 
            length > SP_CONFIG.maxTitleLength * 0.9 ? 'warning' : 
            length > SP_CONFIG.maxTitleLength ? 'error' : '';
    });
    
    subtitleInput.addEventListener('input', function() {
        const length = this.value.length;
        document.getElementById('sp-subtitle-count').textContent = length;
        document.getElementById('sp-subtitle-count').className = 
            length > SP_CONFIG.maxSubtitleLength * 0.9 ? 'warning' : 
            length > SP_CONFIG.maxSubtitleLength ? 'error' : '';
    });
    
    // Initialize counts
    titleInput.dispatchEvent(new Event('input'));
    subtitleInput.dispatchEvent(new Event('input'));
}

function setupColorPickers() {
    // Primary color picker
    const primaryColor = document.getElementById('sp-primary-color');
    const primaryHex = document.getElementById('sp-primary-hex');
    
    primaryColor.addEventListener('input', function() {
        primaryHex.value = this.value.toUpperCase();
        spState.settings.primaryColor = this.value;
        if (document.getElementById('sp-title-input').value) {
            generatePreview();
        }
    });
    
    primaryHex.addEventListener('input', function() {
        let value = this.value;
        if (!value.startsWith('#')) value = '#' + value;
        if (/^#[0-9A-F]{6}$/i.test(value)) {
            primaryColor.value = value.toUpperCase();
            spState.settings.primaryColor = value.toUpperCase();
            if (document.getElementById('sp-title-input').value) {
                generatePreview();
            }
        }
    });
    
    // Secondary color picker
    const secondaryColor = document.getElementById('sp-secondary-color');
    const secondaryHex = document.getElementById('sp-secondary-hex');
    
    secondaryColor.addEventListener('input', function() {
        secondaryHex.value = this.value.toUpperCase();
        spState.settings.secondaryColor = this.value;
        if (document.getElementById('sp-title-input').value) {
            generatePreview();
        }
    });
    
    secondaryHex.addEventListener('input', function() {
        let value = this.value;
        if (!value.startsWith('#')) value = '#' + value;
        if (/^#[0-9A-F]{6}$/i.test(value)) {
            secondaryColor.value = value.toUpperCase();
            spState.settings.secondaryColor = value.toUpperCase();
            if (document.getElementById('sp-title-input').value) {
                generatePreview();
            }
        }
    });
}

function setupFileUploads() {
    // Logo upload
    const logoUpload = document.getElementById('logo-upload');
    const logoInput = document.getElementById('sp-logo-input');
    
    logoUpload.addEventListener('click', () => logoInput.click());
    logoUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        logoUpload.style.borderColor = 'var(--accent)';
    });
    logoUpload.addEventListener('dragleave', () => {
        logoUpload.style.borderColor = 'var(--border-light)';
    });
    logoUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        logoUpload.style.borderColor = 'var(--border-light)';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file, 'logo');
        }
    });
    
    logoInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            loadImage(file, 'logo');
        }
    });
    
    // Background upload
    const bgUpload = document.getElementById('bg-upload');
    const bgInput = document.getElementById('sp-bg-input');
    
    bgUpload.addEventListener('click', () => bgInput.click());
    bgUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        bgUpload.style.borderColor = 'var(--accent)';
    });
    bgUpload.addEventListener('dragleave', () => {
        bgUpload.style.borderColor = 'var(--border-light)';
    });
    bgUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        bgUpload.style.borderColor = 'var(--border-light)';
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            loadImage(file, 'bg');
        }
    });
    
    bgInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            loadImage(file, 'bg');
        }
    });
    
    // Remove buttons
    document.getElementById('remove-logo').addEventListener('click', () => {
        spState.logoImage = null;
        document.getElementById('logo-preview').style.display = 'none';
        logoInput.value = '';
        generatePreview();
    });
    
    document.getElementById('remove-bg').addEventListener('click', () => {
        spState.bgImage = null;
        document.getElementById('bg-preview').style.display = 'none';
        bgInput.value = '';
        generatePreview();
    });
}

function loadImage(file, type) {
    if (file.size > 5 * 1024 * 1024) { // 5MB limit
        showError('Image file size must be less than 5MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            if (type === 'logo') {
                spState.logoImage = img;
                const preview = document.getElementById('logo-preview-img');
                preview.src = e.target.result;
                document.getElementById('logo-preview').style.display = 'flex';
            } else {
                spState.bgImage = img;
                const preview = document.getElementById('bg-preview-img');
                preview.src = e.target.result;
                document.getElementById('bg-preview').style.display = 'flex';
            }
            generatePreview();
        };
        img.onerror = () => showError('Failed to load image');
        img.src = e.target.result;
    };
    reader.onerror = () => showError('Failed to read file');
    reader.readAsDataURL(file);
}

// ==================== GENERATION ====================
async function generatePreview() {
    try {
        // Show loading
        document.getElementById('sp-loading').style.display = 'flex';
        
        // Get values
        const title = document.getElementById('sp-title-input').value.trim();
        const subtitle = document.getElementById('sp-subtitle-input').value.trim();
        const layout = document.getElementById('sp-layout').value;
        const font = document.getElementById('sp-font').value;
        
        if (!title) {
            showError('Please enter a title');
            document.getElementById('sp-loading').style.display = 'none';
            return;
        }
        
        // Update settings
        spState.settings.layout = layout;
        spState.settings.font = font;
        
        // Get platform size
        const platform = SP_CONFIG.platforms[spState.currentPlatform];
        const size = platform.size;
        
        // Create canvas
        const canvas = document.getElementById('sp-canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = size.w;
        canvas.height = size.h;
        
        // Draw background
        drawBackground(ctx, size);
        
        // Draw logo if exists
        if (spState.logoImage) {
            drawLogo(ctx, size);
        }
        
        // Draw text
        drawText(ctx, size, title, subtitle);
        
        // Draw overlay elements
        drawOverlay(ctx, size);
        
        // Hide loading
        document.getElementById('sp-loading').style.display = 'none';
        
        // Show results
        document.getElementById('sp-results').style.display = 'block';
        
        // Update file size estimate
        updateFileSize(canvas);
        
        // Generate meta tags
        updateMetaCode('opengraph');
        
        // Save state
        saveState();
        
        // Show affiliate for large/complex images
        if (title.length > 50 || spState.logoImage || spState.bgImage) {
            document.getElementById('sp-affiliate').style.display = 'block';
        }
        
        // Track generation
        trackEvent('Preview Generated', { 
            platform: spState.currentPlatform,
            hasLogo: !!spState.logoImage,
            hasBg: !!spState.bgImage
        });
        
    } catch (error) {
        console.error('Preview generation error:', error);
        showError('Failed to generate preview: ' + error.message);
        document.getElementById('sp-loading').style.display = 'none';
    }
}

function drawBackground(ctx, size) {
    const { w, h } = size;
    const { primaryColor, secondaryColor, layout } = spState.settings;
    
    switch(layout) {
        case 'gradient':
            const gradient = ctx.createLinearGradient(0, 0, w, h);
            gradient.addColorStop(0, primaryColor);
            gradient.addColorStop(1, secondaryColor);
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, w, h);
            break;
            
        case 'solid':
            ctx.fillStyle = primaryColor;
            ctx.fillRect(0, 0, w, h);
            break;
            
        case 'split':
            ctx.fillStyle = primaryColor;
            ctx.fillRect(0, 0, w / 2, h);
            ctx.fillStyle = secondaryColor;
            ctx.fillRect(w / 2, 0, w / 2, h);
            break;
            
        case 'pattern':
            drawPattern(ctx, w, h, primaryColor);
            break;
            
        case 'image':
            if (spState.bgImage) {
                // Draw background image with cover fit
                const imgRatio = spState.bgImage.width / spState.bgImage.height;
                const canvasRatio = w / h;
                
                let drawWidth, drawHeight, offsetX, offsetY;
                
                if (imgRatio > canvasRatio) {
                    drawHeight = h;
                    drawWidth = h * imgRatio;
                    offsetX = (w - drawWidth) / 2;
                    offsetY = 0;
                } else {
                    drawWidth = w;
                    drawHeight = w / imgRatio;
                    offsetX = 0;
                    offsetY = (h - drawHeight) / 2;
                }
                
                ctx.drawImage(spState.bgImage, offsetX, offsetY, drawWidth, drawHeight);
                
                // Add dark overlay for readability
                ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
                ctx.fillRect(0, 0, w, h);
            } else {
                // Fallback to gradient
                const gradient = ctx.createLinearGradient(0, 0, w, h);
                gradient.addColorStop(0, primaryColor);
                gradient.addColorStop(1, secondaryColor);
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, w, h);
            }
            break;
    }
}

function drawPattern(ctx, w, h, color) {
    // Create geometric pattern
    const patternSize = 50;
    const patternCanvas = document.createElement('canvas');
    patternCanvas.width = patternSize;
    patternCanvas.height = patternSize;
    const patternCtx = patternCanvas.getContext('2d');
    
    patternCtx.fillStyle = color;
    patternCtx.fillRect(0, 0, patternSize, patternSize);
    
    patternCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
    patternCtx.lineWidth = 2;
    
    // Draw lines
    for (let i = -patternSize; i < patternSize * 2; i += 10) {
        patternCtx.beginPath();
        patternCtx.moveTo(i, 0);
        patternCtx.lineTo(i + patternSize, patternSize);
        patternCtx.stroke();
    }
    
    const pattern = ctx.createPattern(patternCanvas, 'repeat');
    ctx.fillStyle = pattern;
    ctx.fillRect(0, 0, w, h);
}

function drawLogo(ctx, size) {
    const { w, h } = size;
    const logo = spState.logoImage;
    const logoSize = Math.min(w * 0.15, 120);
    const margin = w * 0.05;
    
    // Calculate dimensions maintaining aspect ratio
    const ratio = logo.width / logo.height;
    let logoWidth, logoHeight;
    
    if (ratio > 1) {
        logoWidth = logoSize;
        logoHeight = logoSize / ratio;
    } else {
        logoHeight = logoSize;
        logoWidth = logoSize * ratio;
    }
    
    // Draw logo at top-left
    ctx.drawImage(logo, margin, margin, logoWidth, logoHeight);
}

function drawText(ctx, size, title, subtitle) {
    const { w, h } = size;
    const { font } = spState.settings;
    
    // Setup text area
    const paddingX = w * 0.1;
    const paddingY = h * 0.15;
    const textWidth = w - (paddingX * 2);
    
    // Text color (auto-contrast)
    const textColor = getContrastColor(spState.settings.primaryColor);
    
    // Draw title
    ctx.fillStyle = textColor;
    ctx.textBaseline = 'top';
    ctx.textAlign = 'left';
    
    // Calculate title size
    const titleSize = Math.min(h * 0.12, 72);
    ctx.font = `bold ${titleSize}px ${font}, -apple-system, BlinkMacSystemFont, sans-serif`;
    
    // Wrap title
    const titleLines = wrapText(ctx, title, textWidth, titleSize);
    let currentY = paddingY;
    
    titleLines.forEach(line => {
        ctx.fillText(line, paddingX, currentY);
        currentY += titleSize * 1.2;
    });
    
    // Draw subtitle if exists
    if (subtitle) {
        const subtitleSize = Math.max(titleSize * 0.6, 24);
        ctx.font = `600 ${subtitleSize}px ${font}, -apple-system, BlinkMacSystemFont, sans-serif`;
        ctx.fillStyle = textColor + 'CC'; // 80% opacity
        
        const subtitleLines = wrapText(ctx, subtitle, textWidth, subtitleSize);
        
        subtitleLines.forEach(line => {
            ctx.fillText(line, paddingX, currentY);
            currentY += subtitleSize * 1.2;
        });
    }
}

function wrapText(ctx, text, maxWidth, fontSize) {
    const words = text.split(' ');
    const lines = [];
    let currentLine = words[0];
    
    for (let i = 1; i < words.length; i++) {
        const word = words[i];
        const width = ctx.measureText(currentLine + ' ' + word).width;
        if (width < maxWidth) {
            currentLine += ' ' + word;
        } else {
            lines.push(currentLine);
            currentLine = word;
        }
    }
    lines.push(currentLine);
    return lines;
}

function drawOverlay(ctx, size) {
    const { w, h } = size;
    
    // Draw accent bar at bottom
    ctx.fillStyle = spState.settings.secondaryColor;
    ctx.fillRect(0, h - 10, w, 10);
    
    // Draw subtle grid overlay
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.05)';
    ctx.lineWidth = 1;
    
    // Draw vertical lines
    for (let x = 0; x < w; x += 50) {
        ctx.beginPath();
        ctx.moveTo(x, 0);
        ctx.lineTo(x, h);
        ctx.stroke();
    }
    
    // Draw horizontal lines
    for (let y = 0; y < h; y += 50) {
        ctx.beginPath();
        ctx.moveTo(0, y);
        ctx.lineTo(w, y);
        ctx.stroke();
    }
}

function getContrastColor(hexColor) {
    // Convert hex to RGB
    const r = parseInt(hexColor.slice(1, 3), 16);
    const g = parseInt(hexColor.slice(3, 5), 16);
    const b = parseInt(hexColor.slice(5, 7), 16);
    
    // Calculate luminance
    const luminance = (0.299 * r + 0.587 * g + 0.114 * b) / 255;
    
    // Return white or black based on luminance
    return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

// ==================== DOWNLOAD & EXPORT ====================
function downloadImage(format) {
    const canvas = document.getElementById('sp-canvas');
    if (!canvas.width || !canvas.height) {
        showError('Please generate a preview first');
        return;
    }
    
    const platform = SP_CONFIG.platforms[spState.currentPlatform];
    const filename = `social-preview-${spState.currentPlatform}-${platform.size.w}x${platform.size.h}`;
    
    let mimeType, extension;
    switch(format) {
        case 'png':
            mimeType = 'image/png';
            extension = 'png';
            break;
        case 'jpg':
            mimeType = 'image/jpeg';
            extension = 'jpg';
            break;
        case 'webp':
            mimeType = 'image/webp';
            extension = 'webp';
            break;
        case 'svg':
            // SVG would need separate generation
            showError('SVG export not yet implemented');
            return;
        default:
            mimeType = 'image/png';
            extension = 'png';
    }
    
    const link = document.createElement('a');
    link.download = `${filename}.${extension}`;
    link.href = canvas.toDataURL(mimeType);
    link.click();
    
    trackEvent('Image Downloaded', { format: format, platform: spState.currentPlatform });
}

function updateFileSize(canvas) {
    const dataUrl = canvas.toDataURL('image/png');
    const sizeKB = Math.round(dataUrl.length * 3 / 4 / 1024);
    document.getElementById('sp-filesize').textContent = `~${sizeKB} KB`;
}

function updateMetaCode(type) {
    const title = document.getElementById('sp-title-input').value.trim();
    const subtitle = document.getElementById('sp-subtitle-input').value.trim();
    const canvas = document.getElementById('sp-canvas');
    
    if (!canvas.width) return;
    
    const imageUrl = canvas.toDataURL('image/png');
    
    let metaCode = '';
    switch(type) {
        case 'opengraph':
            metaCode = `<!-- Open Graph Meta Tags -->
<meta property="og:title" content="${title}" />
<meta property="og:description" content="${subtitle || title}" />
<meta property="og:image" content="${imageUrl}" />
<meta property="og:image:width" content="${canvas.width}" />
<meta property="og:image:height" content="${canvas.height}" />
<meta property="og:type" content="website" />`;
            break;
            
        case 'twitter':
            metaCode = `<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="${title}" />
<meta name="twitter:description" content="${subtitle || title}" />
<meta name="twitter:image" content="${imageUrl}" />`;
            break;
            
        case 'linkedin':
            metaCode = `<!-- LinkedIn Meta Tags -->
<meta property="og:title" content="${title}" />
<meta property="og:description" content="${subtitle || title}" />
<meta property="og:image" content="${imageUrl}" />
<meta property="og:image:width" content="${canvas.width}" />
<meta property="og:image:height" content="${canvas.height}" />`;
            break;
            
        case 'whatsapp':
            metaCode = `<!-- WhatsApp Meta Tags -->
<meta property="og:title" content="${title}" />
<meta property="og:description" content="${subtitle || title}" />
<meta property="og:image" content="${imageUrl}" />
<meta property="og:image:width" content="300" />
<meta property="og:image:height" content="300" />`;
            break;
    }
    
    document.getElementById('sp-meta-code').value = metaCode;
}

function copyMetaCode() {
    const metaCode = document.getElementById('sp-meta-code');
    metaCode.select();
    metaCode.setSelectionRange(0, 99999);
    
    navigator.clipboard.writeText(metaCode.value).then(() => {
        const btn = document.getElementById('copy-meta');
        const original = btn.innerHTML;
        btn.innerHTML = '‚úÖ Copied!';
        btn.style.background = 'rgba(57, 255, 20, 0.2)';
        
        setTimeout(() => {
            btn.innerHTML = original;
            btn.style.background = '';
        }, 2000);
    });
}

// ==================== BATCH GENERATION ====================
function initPlatformGrid() {
    const grid = document.getElementById('platform-grid');
    grid.innerHTML = '';
    
    Object.entries(SP_CONFIG.platforms).forEach(([key, platform]) => {
        const label = document.createElement('label');
        label.className = 'platform-option';
        label.innerHTML = `
            <input type="checkbox" value="${key}" checked>
            <span>${platform.name} (${platform.size.w}√ó${platform.size.h})</span>
        `;
        grid.appendChild(label);
    });
}

async function generateAllPlatforms() {
    const checked = Array.from(document.querySelectorAll('#platform-grid input:checked'))
        .map(input => input.value);
    
    if (checked.length === 0) {
        showError('Please select at least one platform');
        return;
    }
    
    document.getElementById('generate-all').disabled = true;
    document.getElementById('generate-all').textContent = 'Generating...';
    
    const grid = document.getElementById('batch-preview-grid');
    grid.innerHTML = '';
    
    for (const platform of checked) {
        const info = SP_CONFIG.platforms[platform];
        
        // Create preview container
        const preview = document.createElement('div');
        preview.className = 'batch-preview';
        preview.innerHTML = `
            <div class="batch-canvas" id="batch-${platform}"></div>
            <div class="batch-label">${info.name}</div>
        `;
        grid.appendChild(preview);
        
        // Generate preview for this platform
        await generatePlatformPreview(platform);
        
        // Small delay
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    document.getElementById('batch-results').style.display = 'block';
    document.getElementById('generate-all').disabled = false;
    document.getElementById('generate-all').textContent = 'üöÄ Generate All';
    
    trackEvent('Batch Generated', { count: checked.length });
}

async function generatePlatformPreview(platform) {
    const info = SP_CONFIG.platforms[platform];
    const canvas = document.createElement('canvas');
    canvas.width = info.size.w;
    canvas.height = info.size.h;
    const ctx = canvas.getContext('2d');
    
    // Get current content
    const title = document.getElementById('sp-title-input').value.trim();
    const subtitle = document.getElementById('sp-subtitle-input').value.trim();
    
    // Draw background (simplified)
    const gradient = ctx.createLinearGradient(0, 0, info.size.w, info.size.h);
    gradient.addColorStop(0, spState.settings.primaryColor);
    gradient.addColorStop(1, spState.settings.secondaryColor);
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, info.size.w, info.size.h);
    
    // Draw text (simplified)
    ctx.fillStyle = getContrastColor(spState.settings.primaryColor);
    ctx.font = `bold 48px ${spState.settings.font}`;
    ctx.fillText(title.substring(0, 20) + '...', 50, 100);
    
    // Insert into grid
    const container = document.querySelector(`#batch-${platform}`);
    if (container) {
        container.innerHTML = '';
        container.appendChild(canvas);
    }
}

async function downloadBatchZip() {
    // Note: This would require JSZip library
    showMessage('Batch ZIP download requires additional libraries. Right-click each preview to save individually.');
}

// ==================== UTILITY FUNCTIONS ====================
function loadState() {
    try {
        const saved = localStorage.getItem('social_preview_state');
        if (saved) {
            const state = JSON.parse(saved);
            Object.assign(spState, state);
            
            // Restore form values
            if (state.settings) {
                document.getElementById('sp-primary-color').value = state.settings.primaryColor;
                document.getElementById('sp-primary-hex').value = state.settings.primaryColor.toUpperCase();
                document.getElementById('sp-secondary-color').value = state.settings.secondaryColor;
                document.getElementById('sp-secondary-hex').value = state.settings.secondaryColor.toUpperCase();
                document.getElementById('sp-layout').value = state.settings.layout;
                document.getElementById('sp-font').value = state.settings.font;
            }
        }
    } catch (e) {
        console.warn('Failed to load saved state:', e);
    }
}

function saveState() {
    try {
        localStorage.setItem('social_preview_state', JSON.stringify(spState));
    } catch (e) {
        console.warn('Failed to save state:', e);
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    
    // Remove existing errors
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    
    // Add new error
    document.querySelector('.sp-interface').prepend(errorDiv);
    
    setTimeout(() => errorDiv.remove(), 5000);
}

function showMessage(message) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'success-message';
    msgDiv.textContent = message;
    
    document.querySelector('.sp-interface').prepend(msgDiv);
    
    setTimeout(() => msgDiv.remove(), 3000);
}

function trackEvent(event, props = {}) {
    if (window.plausible) {
        window.plausible(event, { props: { tool: 'social-preview', ...props } });
    }
}

function trackAffiliateClick(product) {
    trackEvent('Affiliate Click', { product: product });
}

// ==================== SHARING FUNCTIONS ====================
function spShare() {
    const shareData = {
        title: 'Social Preview Generator - The Most Useful Site',
        text: 'Create perfect social media preview images!',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showMessage('Link copied to clipboard!');
        });
    }
    
    trackEvent('Shared');
}

function spEmbed() {
    const embedCode = `<iframe src="${window.location.origin}/cards/social-preview-generator.html" width="100%" height="800" style="border:none;border-radius:12px;" title="Social Preview Generator"></iframe>`;
    
    navigator.clipboard.writeText(embedCode).then(() => {
        showMessage('Embed code copied to clipboard!');
    });
    
    trackEvent('Embed Generated');
}

function spApi() {
    showMessage('API documentation coming soon!');
    trackEvent('API Requested');
}

// Initialize when ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initSocialPreview);
} else {
    initSocialPreview();
}
</script>

<!-- ===== 7. CARD-SCOPED STYLES ===== -->
<style>
/* Social Preview Generator Styles */
.sp-presets {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
}

.sp-preset {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--text-sm);
    flex: 1;
    min-width: 100px;
    text-align: center;
}

.sp-preset:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
    color: var(--accent);
}

.sp-preset.active {
    background: rgba(45, 212, 255, 0.15);
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 600;
}

.sp-field-group {
    display: grid;
    gap: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.sp-field {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.sp-field label {
    color: var(--text-secondary);
    font-size: var(--text-sm);
    font-weight: 500;
}

.sp-field input,
.sp-field textarea {
    padding: var(--space-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: var(--text-base);
    font-family: inherit;
}

.sp-field textarea {
    min-height: 100px;
    resize: vertical;
}

.sp-counter {
    text-align: right;
    font-size: var(--text-xs);
    color: var(--text-tertiary);
}

.sp-counter.warning {
    color: var(--warning);
}

.sp-counter.error {
    color: var(--error);
}

.sp-design {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.sp-design h4 {
    color: var(--accent);
    margin-bottom: var(--space-md);
    font-size: var(--text-base);
}

.sp-color-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.sp-color-picker,
.sp-selector {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.color-input {
    display: flex;
    gap: var(--space-sm);
    align-items: center;
}

.color-input input[type="color"] {
    width: 50px;
    height: 50px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    background: transparent;
}

.color-input input[type="text"] {
    flex: 1;
    padding: var(--space-sm);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'SF Mono', monospace;
    font-size: var(--text-sm);
}

.sp-upload-section {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--space-lg);
}

.sp-upload {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
}

.upload-area {
    border: 2px dashed var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.upload-area:hover {
    border-color: var(--accent);
    background: rgba(45, 212, 255, 0.05);
}

.upload-icon {
    font-size: 32px;
    margin-bottom: var(--space-sm);
    opacity: 0.7;
}

.upload-text {
    color: var(--text-secondary);
    font-size: var(--text-sm);
}

.preview-container {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
}

.preview-container img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-light);
}

.preview-container button {
    padding: var(--space-xs) var(--space-sm);
    background: rgba(255, 77, 77, 0.1);
    border: 1px solid rgba(255, 77, 77, 0.3);
    color: #ff4d4d;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--text-sm);
}

/* Preview Area */
.sp-preview-container {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.sp-preview {
    position: relative;
    display: inline-block;
    margin-bottom: var(--space-lg);
}

.sp-preview canvas {
    max-width: 100%;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    background: #f0f0f0;
    box-shadow: var(--shadow-md);
}

.sp-loading {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border-radius: var(--radius-md);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--space-md);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.sp-preview-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
    padding: var(--space-md);
}

.sp-stat {
    text-align: center;
}

.sp-stat .stat-label {
    display: block;
    color: var(--text-secondary);
    font-size: var(--text-sm);
    margin-bottom: 2px;
}

.sp-stat .stat-value {
    display: block;
    color: var(--accent);
    font-weight: 600;
    font-size: var(--text-base);
}

/* Download Buttons */
.download-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-sm);
    margin-top: var(--space-md);
}

/* Meta Tags Section */
.meta-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-md);
}

.meta-tab {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--text-sm);
}

.meta-tab:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
    color: var(--accent);
}

.meta-tab.active {
    background: rgba(45, 212, 255, 0.15);
    border-color: var(--accent);
    color: var(--accent);
}

.meta-code-container {
    display: flex;
    gap: var(--space-sm);
}

.meta-code-container textarea {
    flex: 1;
    min-height: 150px;
    padding: var(--space-md);
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'SF Mono', monospace;
    font-size: var(--text-sm);
    resize: vertical;
}

.copy-btn {
    padding: var(--space-sm) var(--space-md);
    background: rgba(45, 212, 255, 0.1);
    border: 1px solid var(--border-accent);
    color: var(--accent);
    border-radius: var(--radius-sm);
    cursor: pointer;
    white-space: nowrap;
    align-self: flex-start;
}

/* Batch Section */
.platform-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: var(--space-sm);
    margin: var(--space-md) 0;
}

.platform-option {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-sm);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
}

.platform-option:hover {
    background: rgba(45, 212, 255, 0.05);
}

.platform-option input[type="checkbox"] {
    margin: 0;
}

.batch-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: var(--space-md);
    max-height: 400px;
    overflow-y: auto;
    padding: var(--space-sm);
    margin-top: var(--space-md);
}

.batch-preview {
    text-align: center;
}

.batch-canvas {
    width: 150px;
    height: 150px;
    background: white;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 1px solid var(--border-light);
    overflow: hidden;
}

.batch-canvas canvas {
    max-width: 140px;
    max-height: 140px;
}

.batch-label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-xs);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Responsive Design */
@media (max-width: 768px) {
    .sp-presets {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .sp-preset {
        min-width: 80px;
        padding: var(--space-sm);
        font-size: var(--text-xs);
    }
    
    .sp-color-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .sp-upload-section {
        grid-template-columns: 1fr;
    }
    
    .meta-tabs {
        flex-wrap: wrap;
    }
    
    .meta-tab {
        flex: 1;
        min-width: 100px;
        text-align: center;
    }
    
    .batch-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .sp-presets {
        grid-template-columns: 1fr;
    }
    
    .sp-color-grid {
        grid-template-columns: 1fr;
    }
    
    .download-buttons {
        grid-template-columns: 1fr;
    }
    
    .meta-code-container {
        flex-direction: column;
    }
    
    .copy-btn {
        align-self: stretch;
        text-align: center;
    }
    
    .batch-grid {
        grid-template-columns: 1fr;
    }
}
</style>
