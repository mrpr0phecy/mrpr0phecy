<div class="card" id="social-preview-card">
  <h2 id="social-preview-title" style="margin-top:0;">Social Preview Image Generator</h2>

  <form aria-describedby="social-preview-desc">
    <p id="social-preview-desc" class="small">
      Create perfectly sized Open Graph and Twitter preview images with title, subtitle, brand color, and optional logo.
      <br>
      <em style="color:#ff9800;">Note: Generated images are for preview. For production, use server-side generation.</em>
    </p>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
      <div class="field">
        <label for="sp-title">Title</label>
        <input id="sp-title" type="text" placeholder="Your compelling headline…" value="Introducing Our New Product" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          <span id="title-length">0</span>/60 characters
        </div>
      </div>
      
      <div class="field">
        <label for="sp-subtitle">Subtitle (optional)</label>
        <input id="sp-subtitle" type="text" placeholder="Short supporting line" value="Revolutionizing the way you work" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          <span id="subtitle-length">0</span>/120 characters
        </div>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="sp-size">Preset size</label>
        <select id="sp-size" style="width:100%;">
          <option value="1200x630">Open Graph (1200×630)</option>
          <option value="1200x675">Twitter/X Large (1200×675)</option>
          <option value="1024x512">Twitter/X Small (1024×512)</option>
          <option value="1080x1080">Instagram Square (1080×1080)</option>
          <option value="1080x1350">Instagram Portrait (1080×1350)</option>
          <option value="1200x627">LinkedIn (1200×627)</option>
          <option value="800x418">Facebook Link (800×418)</option>
          <option value="1280x720">YouTube Thumbnail (1280×720)</option>
          <option value="1500x500">Twitter Header (1500×500)</option>
        </select>
      </div>
      
      <div class="field">
        <label for="sp-theme">Theme</label>
        <select id="sp-theme" style="width:100%;">
          <option value="dark">Dark</option>
          <option value="light">Light</option>
          <option value="gradient">Gradient</option>
          <option value="image">Background image</option>
          <option value="pattern">Pattern</option>
          <option value="split">Split layout</option>
        </select>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="sp-brand">Brand color</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="sp-brand" type="color" value="#00D1FF" style="width:60px;height:40px;padding:0;" />
          <input id="sp-brand-hex" type="text" placeholder="#00D1FF" value="#00D1FF" style="width:100%;" />
        </div>
      </div>
      
      <div class="field">
        <label for="sp-text-color">Text color</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="sp-text-color" type="color" value="#FFFFFF" style="width:60px;height:40px;padding:0;" />
          <select id="sp-text-theme" style="width:100%;">
            <option value="auto">Auto (based on background)</option>
            <option value="white">White</option>
            <option value="black">Black</option>
            <option value="brand">Brand color</option>
          </select>
        </div>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="sp-logo">Logo (optional)</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="sp-logo" type="file" accept="image/*" style="width:100%;" />
          <button type="button" onclick="clearLogo()" class="small" style="white-space:nowrap;padding:4px 8px;">Clear</button>
        </div>
        <div class="small" style="margin-top:4px;color:#aaa;">
          PNG with transparency recommended
        </div>
      </div>
      
      <div class="field">
        <label for="sp-bg">Background image (optional)</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="sp-bg" type="file" accept="image/*" style="width:100%;" />
          <button type="button" onclick="clearBg()" class="small" style="white-space:nowrap;padding:4px 8px;">Clear</button>
        </div>
        <div class="small" style="margin-top:4px;color:#aaa;">
          Used if Theme = "image"
        </div>
      </div>
    </div>

    <div class="field" style="margin-top:12px;">
      <label for="sp-font">Font family</label>
      <select id="sp-font" style="width:100%;">
        <option value="inter">Inter (Modern)</option>
        <option value="roboto">Roboto (Clean)</option>
        <option value="poppins">Poppins (Bold)</option>
        <option value="montserrat">Montserrat (Elegant)</option>
        <option value="opensans">Open Sans (Readable)</option>
        <option value="lato">Lato (Friendly)</option>
      </select>
    </div>

    <div class="field" style="margin-top:12px;">
      <label for="sp-overlay">Text overlay opacity</label>
      <input id="sp-overlay" type="range" min="0" max="100" value="60" style="width:100%;" />
      <div class="small" style="margin-top:4px;color:#aaa;">
        <span id="overlay-value">60%</span> - Darkens background for better readability
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="spGenerate(this)" class="primary">Generate Preview</button>
      <button type="button" onclick="spDownload(this)" class="secondary">Download PNG</button>
      <button type="button" onclick="spDownloadJPG(this)" class="secondary">Download JPG</button>
      <button type="button" onclick="spReset(this)" class="secondary">Reset</button>
      <button type="button" onclick="spCopyHTML(this)" class="secondary">Copy HTML Meta</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <h3 class="small">Preview</h3>
    <div style="position:relative;">
      <canvas id="sp-canvas" style="max-width:100%;border:1px solid rgba(255,255,255,0.08);border-radius:8px;background:#f0f0f0;"></canvas>
      <div id="sp-loading" style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:none;background:rgba(0,0,0,0.8);color:white;padding:12px 20px;border-radius:8px;">
        Generating preview...
      </div>
    </div>
    <div id="sp-hint" class="small" style="margin-top:8px;opacity:0.9;"></div>
    <div id="sp-meta-preview" style="margin-top:12px;display:none;">
      <div class="small" style="color:#aaa;margin-bottom:4px;">HTML Meta Tags:</div>
      <textarea id="sp-meta-code" style="width:100%;height:120px;font-family:monospace;font-size:0.8rem;padding:8px;border-radius:6px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.1);color:#fff;resize:none;"></textarea>
    </div>
  </div>

  <details class="small" style="margin-top:12px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
    <summary style="cursor:pointer;font-weight:500;padding:4px;">Platform Specifications</summary>
    <div style="margin-top:8px;padding:4px;border-top:1px solid rgba(255,255,255,0.08);">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
        <div>
          <strong>Open Graph (Facebook/LinkedIn):</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Recommended: 1200×630px</li>
            <li>Minimum: 600×315px</li>
            <li>Ratio: 1.91:1</li>
          </ul>
        </div>
        <div>
          <strong>Twitter/X:</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Large: 1200×675px (2:1)</li>
            <li>Small: 1024×512px (2:1)</li>
            <li>Header: 1500×500px (3:1)</li>
          </ul>
        </div>
        <div>
          <strong>Instagram:</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Square: 1080×1080px</li>
            <li>Portrait: 1080×1350px (4:5)</li>
            <li>Landscape: 1080×566px (1.91:1)</li>
          </ul>
        </div>
      </div>
      <p style="margin-top:8px;color:#4caf50;"><strong>Best practices:</strong> Use high contrast, keep text within safe zones, and include branding.</p>
    </div>
  </details>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #e91e63;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input,
    .field select {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input[type="color"] {
      padding: 2px;
      cursor: pointer;
    }
    
    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #e91e63;
      box-shadow: 0 0 0 2px rgba(233, 30, 99, 0.2);
    }
    
    .field input[type="range"] {
      height: 6px;
      padding: 0;
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #e91e63;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #c2185b;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .results h3 {
      color: #e91e63;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    canvas {
      display: block;
    }
    
    details summary::-webkit-details-marker {
      display: none;
    }
    
    details summary:after {
      content: '▼';
      float: right;
      font-size: 0.75em;
      transition: transform 0.2s ease;
    }
    
    details[open] summary:after {
      transform: rotate(180deg);
    }
    
    #sp-meta-code {
      font-family: 'Courier New', monospace;
    }
    
    .character-count {
      text-align: right;
      font-size: 0.8em;
    }
    
    .character-count.warning {
      color: #ff9800;
    }
    
    .character-count.error {
      color: #f44336;
    }
  </style>
</div>

<script>
// Global variables
let generatedImageData = null;
let logoImage = null;
let bgImage = null;
let fontsLoaded = false;

// Font mapping
const FONTS = {
  'inter': 'Inter, system-ui, -apple-system, BlinkMacSystemFont, sans-serif',
  'roboto': 'Roboto, "Helvetica Neue", Arial, sans-serif',
  'poppins': 'Poppins, "Segoe UI", Tahoma, Geneva, sans-serif',
  'montserrat': 'Montserrat, "Arial Rounded MT Bold", sans-serif',
  'opensans': '"Open Sans", "Segoe UI", Tahoma, sans-serif',
  'lato': 'Lato, "Lucida Grande", sans-serif'
};

// Platform specifications
const PLATFORM_SPECS = {
  '1200x630': { name: 'Open Graph', ratio: '1.91:1', platforms: ['Facebook', 'LinkedIn'] },
  '1200x675': { name: 'Twitter/X Large', ratio: '16:9', platforms: ['Twitter/X'] },
  '1024x512': { name: 'Twitter/X Small', ratio: '2:1', platforms: ['Twitter/X'] },
  '1080x1080': { name: 'Instagram Square', ratio: '1:1', platforms: ['Instagram'] },
  '1080x1350': { name: 'Instagram Portrait', ratio: '4:5', platforms: ['Instagram'] },
  '1200x627': { name: 'LinkedIn', ratio: '1.91:1', platforms: ['LinkedIn'] },
  '800x418': { name: 'Facebook Link', ratio: '1.91:1', platforms: ['Facebook'] },
  '1280x720': { name: 'YouTube Thumbnail', ratio: '16:9', platforms: ['YouTube'] },
  '1500x500': { name: 'Twitter Header', ratio: '3:1', platforms: ['Twitter/X'] }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('social-preview-card');
  
  // Update character counts
  updateCharacterCounts();
  
  // Initialize canvas
  const canvas = card.querySelector('#sp-canvas');
  canvas.width = 800;
  canvas.height = 418;
  drawInitialCanvas(canvas);
  
  // Set up event listeners
  setupEventListeners(card);
  
  // Load fonts
  loadFonts();
});

function setupEventListeners(card) {
  // Character count updates
  card.querySelector('#sp-title').addEventListener('input', function() {
    updateCharacterCount('title-length', this.value.length, 60);
  });
  
  card.querySelector('#sp-subtitle').addEventListener('input', function() {
    updateCharacterCount('subtitle-length', this.value.length, 120);
  });
  
  // Color picker sync
  card.querySelector('#sp-brand').addEventListener('input', function() {
    card.querySelector('#sp-brand-hex').value = this.value.toUpperCase();
  });
  
  card.querySelector('#sp-brand-hex').addEventListener('input', function() {
    let value = this.value;
    if (!value.startsWith('#')) value = '#' + value;
    if (/^#[0-9A-F]{6}$/i.test(value)) {
      card.querySelector('#sp-brand').value = value.toUpperCase();
    }
  });
  
  // Text color picker sync
  card.querySelector('#sp-text-color').addEventListener('input', function() {
    if (card.querySelector('#sp-text-theme').value === 'custom') {
      card.querySelector('#sp-text-theme').value = 'custom';
    }
  });
  
  // Range value display
  card.querySelector('#sp-overlay').addEventListener('input', function() {
    card.querySelector('#overlay-value').textContent = this.value + '%';
  });
  
  // File upload previews
  card.querySelector('#sp-logo').addEventListener('change', function(e) {
    if (e.target.files[0]) {
      loadImage(e.target.files[0], 'logo').then(img => {
        logoImage = img;
        spGenerate(document.querySelector('button.primary'));
      });
    }
  });
  
  card.querySelector('#sp-bg').addEventListener('change', function(e) {
    if (e.target.files[0]) {
      loadImage(e.target.files[0], 'bg').then(img => {
        bgImage = img;
        spGenerate(document.querySelector('button.primary'));
      });
    }
  });
  
  // Auto-generate on certain changes
  ['#sp-size', '#sp-theme', '#sp-font', '#sp-text-theme', '#sp-overlay'].forEach(selector => {
    card.querySelector(selector).addEventListener('change', function() {
      setTimeout(() => spGenerate(card.querySelector('button.primary')), 100);
    });
  });
}

function updateCharacterCount(elementId, length, max) {
  const element = document.getElementById(elementId);
  element.textContent = length;
  element.className = 'character-count';
  if (length > max * 0.8) element.className += ' warning';
  if (length > max) element.className += ' error';
}

function updateCharacterCounts() {
  const card = document.getElementById('social-preview-card');
  updateCharacterCount('title-length', card.querySelector('#sp-title').value.length, 60);
  updateCharacterCount('subtitle-length', card.querySelector('#sp-subtitle').value.length, 120);
}

function loadImage(file, type) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    reader.onload = function(e) {
      const img = new Image();
      img.onload = function() {
        resolve(img);
      };
      img.onerror = reject;
      img.src = e.target.result;
    };
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

function clearLogo() {
  const card = document.getElementById('social-preview-card');
  card.querySelector('#sp-logo').value = '';
  logoImage = null;
  spGenerate(card.querySelector('button.primary'));
}

function clearBg() {
  const card = document.getElementById('social-preview-card');
  card.querySelector('#sp-bg').value = '';
  bgImage = null;
  spGenerate(card.querySelector('button.primary'));
}

function loadFonts() {
  // In a real implementation, you would load web fonts here
  // For demo purposes, we'll just mark them as loaded
  fontsLoaded = true;
}

function drawInitialCanvas(canvas) {
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#f0f0f0';
  ctx.fillRect(0, 0, canvas.width, canvas.height);
  ctx.fillStyle = '#666';
  ctx.font = '16px sans-serif';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'middle';
  ctx.fillText('Enter details and click Generate Preview', canvas.width / 2, canvas.height / 2);
}

function parseSize(val) {
  const [w, h] = val.split('x').map(n => parseInt(n, 10));
  return { w, h };
}

function hexToRgb(hex) {
  const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
  return result ? {
    r: parseInt(result[1], 16),
    g: parseInt(result[2], 16),
    b: parseInt(result[3], 16)
  } : null;
}

function getContrastColor(backgroundColor) {
  const rgb = hexToRgb(backgroundColor);
  if (!rgb) return '#FFFFFF';
  
  // Calculate relative luminance
  const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
  return luminance > 0.5 ? '#000000' : '#FFFFFF';
}

function getTextColor(theme, backgroundColor, brandColor) {
  const card = document.getElementById('social-preview-card');
  const textTheme = card.querySelector('#sp-text-theme').value;
  
  if (textTheme === 'white') return '#FFFFFF';
  if (textTheme === 'black') return '#000000';
  if (textTheme === 'brand') return brandColor;
  
  // Auto mode
  return getContrastColor(backgroundColor);
}

function fitText(ctx, text, maxWidth, baseSize, maxLines, fontFamily) {
  let size = baseSize;
  const words = (text || "").trim().split(/\s+/);
  
  function measureLines() {
    ctx.font = `bold ${size}px ${fontFamily}`;
    const lines = [];
    let line = "";
    
    words.forEach(word => {
      const test = line ? line + " " + word : word;
      if (ctx.measureText(test).width <= maxWidth) {
        line = test;
      } else {
        if (line) lines.push(line);
        line = word;
      }
    });
    
    if (line) lines.push(line);
    return lines;
  }
  
  let lines = measureLines();
  
  // Reduce font size if too many lines
  while (lines.length > maxLines && size > 20) {
    size -= 2;
    lines = measureLines();
  }
  
  // Reduce font size if text is too wide
  while (lines.some(line => ctx.measureText(line).width > maxWidth) && size > 20) {
    size -= 1;
    lines = measureLines();
  }
  
  return { lines, size };
}

function createGradient(ctx, w, h, color) {
  const gradient = ctx.createLinearGradient(0, 0, w, h);
  const rgb = hexToRgb(color);
  
  if (rgb) {
    // Create gradient from brand color to darker version
    gradient.addColorStop(0, color);
    gradient.addColorStop(1, `rgb(${Math.max(0, rgb.r - 40)}, ${Math.max(0, rgb.g - 40)}, ${Math.max(0, rgb.b - 40)})`);
  } else {
    gradient.addColorStop(0, '#6C5CE7');
    gradient.addColorStop(1, '#4834D4');
  }
  
  return gradient;
}

function createPattern(ctx, w, h, color) {
  // Create canvas for pattern
  const patternCanvas = document.createElement('canvas');
  patternCanvas.width = 100;
  patternCanvas.height = 100;
  const patternCtx = patternCanvas.getContext('2d');
  
  // Draw geometric pattern
  patternCtx.fillStyle = color;
  patternCtx.fillRect(0, 0, 100, 100);
  
  patternCtx.strokeStyle = 'rgba(255, 255, 255, 0.1)';
  patternCtx.lineWidth = 2;
  
  // Draw diagonal lines
  for (let i = -100; i < 200; i += 20) {
    patternCtx.beginPath();
    patternCtx.moveTo(i, 0);
    patternCtx.lineTo(i + 100, 100);
    patternCtx.stroke();
  }
  
  return ctx.createPattern(patternCanvas, 'repeat');
}

function spGenerate(btn) {
  const card = btn.closest('.card');
  const loading = card.querySelector('#sp-loading');
  const canvas = card.querySelector('#sp-canvas');
  const ctx = canvas.getContext('2d');
  
  // Show loading
  loading.style.display = 'block';
  
  // Get values
  const title = card.querySelector('#sp-title').value.trim();
  const subtitle = card.querySelector('#sp-subtitle').value.trim();
  const size = parseSize(card.querySelector('#sp-size').value);
  const theme = card.querySelector('#sp-theme').value;
  const brandColor = card.querySelector('#sp-brand').value;
  const fontFamily = FONTS[card.querySelector('#sp-font').value];
  const overlayOpacity = parseInt(card.querySelector('#sp-overlay').value) / 100;
  
  if (!title) {
    loading.style.display = 'none';
    card.querySelector('#sp-hint').textContent = "Please enter a title.";
    return;
  }
  
  // Set canvas size
  canvas.width = size.w;
  canvas.height = size.h;
  
  // Clear canvas
  ctx.clearRect(0, 0, size.w, size.h);
  
  // Draw background based on theme
  drawBackground(ctx, size, theme, brandColor);
  
  // Draw logo if exists
  if (logoImage) {
    drawLogo(ctx, size, logoImage);
  }
  
  // Draw text content
  drawTextContent(ctx, size, title, subtitle, fontFamily, brandColor, overlayOpacity);
  
  // Draw safe zone guides
  drawSafeZone(ctx, size);
  
  // Hide loading
  loading.style.display = 'none';
  
  // Update hint
  const spec = PLATFORM_SPECS[`${size.w}x${size.h}`] || { name: 'Custom' };
  card.querySelector('#sp-hint').innerHTML = `
    <span style="color:#4caf50;">✓</span> Generated ${size.w}×${size.h} ${spec.name} preview
  `;
  
  // Generate HTML meta tags
  generateMetaTags(title, subtitle, canvas.toDataURL('image/png'));
}

function drawBackground(ctx, size, theme, brandColor) {
  const { w, h } = size;
  
  switch (theme) {
    case 'dark':
      ctx.fillStyle = '#0D0F14';
      ctx.fillRect(0, 0, w, h);
      break;
      
    case 'light':
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, w, h);
      break;
      
    case 'gradient':
      ctx.fillStyle = createGradient(ctx, w, h, brandColor);
      ctx.fillRect(0, 0, w, h);
      break;
      
    case 'pattern':
      ctx.fillStyle = createPattern(ctx, w, h, brandColor);
      ctx.fillRect(0, 0, w, h);
      break;
      
    case 'image':
      if (bgImage) {
        // Draw background image with cover fit
        const imgRatio = bgImage.width / bgImage.height;
        const canvasRatio = w / h;
        
        let drawWidth, drawHeight, offsetX, offsetY;
        
        if (imgRatio > canvasRatio) {
          drawHeight = h;
          drawWidth = h * imgRatio;
          offsetX = (w - drawWidth) / 2;
          offsetY = 0;
        } else {
          drawWidth = w;
          drawHeight = w / imgRatio;
          offsetX = 0;
          offsetY = (h - drawHeight) / 2;
        }
        
        ctx.drawImage(bgImage, offsetX, offsetY, drawWidth, drawHeight);
        
        // Add dark overlay for better text readability
        ctx.fillStyle = `rgba(0, 0, 0, 0.4)`;
        ctx.fillRect(0, 0, w, h);
      } else {
        // Fallback to gradient
        ctx.fillStyle = createGradient(ctx, w, h, brandColor);
        ctx.fillRect(0, 0, w, h);
      }
      break;
      
    case 'split':
      // Split layout with brand color on left, dark on right
      ctx.fillStyle = brandColor;
      ctx.fillRect(0, 0, w / 2, h);
      ctx.fillStyle = '#0D0F14';
      ctx.fillRect(w / 2, 0, w / 2, h);
      break;
  }
}

function drawLogo(ctx, size, logo) {
  const { w, h } = size;
  const logoSize = Math.min(w * 0.15, 120);
  const margin = w * 0.05;
  
  // Calculate logo dimensions maintaining aspect ratio
  const ratio = logo.width / logo.height;
  let logoWidth, logoHeight;
  
  if (ratio > 1) {
    logoWidth = logoSize;
    logoHeight = logoSize / ratio;
  } else {
    logoHeight = logoSize;
    logoWidth = logoSize * ratio;
  }
  
  // Draw logo at top-left
  ctx.drawImage(logo, margin, margin, logoWidth, logoHeight);
}

function drawTextContent(ctx, size, title, subtitle, fontFamily, brandColor, overlayOpacity) {
  const { w, h } = size;
  const card = document.getElementById('social-preview-card');
  const textTheme = card.querySelector('#sp-text-theme').value;
  
  // Calculate text area (safe zone)
  const paddingX = w * 0.1;
  const paddingY = h * 0.15;
  const textWidth = w - (paddingX * 2);
  
  // Determine text color
  let textColor;
  if (textTheme === 'custom') {
    textColor = card.querySelector('#sp-text-color').value;
  } else {
    // Determine background color for contrast calculation
    let backgroundColor;
    if (card.querySelector('#sp-theme').value === 'dark') {
      backgroundColor = '#0D0F14';
    } else if (card.querySelector('#sp-theme').value === 'light') {
      backgroundColor = '#FFFFFF';
    } else {
      backgroundColor = brandColor;
    }
    textColor = getTextColor(card.querySelector('#sp-theme').value, backgroundColor, brandColor);
  }
  
  // Draw text background overlay for readability
  if (overlayOpacity > 0) {
    const overlayHeight = h * 0.5;
    const overlayY = (h - overlayHeight) / 2;
    ctx.fillStyle = `rgba(0, 0, 0, ${overlayOpacity})`;
    ctx.fillRect(paddingX, overlayY, textWidth, overlayHeight);
  }
  
  // Draw title
  ctx.fillStyle = textColor;
  ctx.textBaseline = 'top';
  
  // Calculate title size and lines
  const baseTitleSize = Math.min(h * 0.12, 72);
  const titleResult = fitText(ctx, title, textWidth, baseTitleSize, 3, fontFamily);
  
  ctx.font = `bold ${titleResult.size}px ${fontFamily}`;
  let currentY = paddingY + (h * 0.1);
  
  titleResult.lines.forEach(line => {
    ctx.fillText(line, paddingX, currentY);
    currentY += titleResult.size * 1.2;
  });
  
  // Draw subtitle if exists
  if (subtitle) {
    const subtitleSize = Math.max(titleResult.size * 0.6, 24);
    const subtitleResult = fitText(ctx, subtitle, textWidth, subtitleSize, 2, fontFamily);
    
    ctx.font = `600 ${subtitleResult.size}px ${fontFamily}`;
    ctx.fillStyle = textColor + 'CC'; // 80% opacity
    
    subtitleResult.lines.forEach(line => {
      ctx.fillText(line, paddingX, currentY);
      currentY += subtitleResult.size * 1.2;
    });
  }
  
  // Draw brand accent at bottom
  const accentHeight = h * 0.02;
  ctx.fillStyle = brandColor;
  ctx.fillRect(0, h - accentHeight, w, accentHeight);
}

function drawSafeZone(ctx, size) {
  const { w, h } = size;
  const paddingX = w * 0.1;
  const paddingY = h * 0.15;
  
  // Draw safe zone guide
  ctx.strokeStyle = 'rgba(255, 255, 255, 0.2)';
  ctx.lineWidth = 1;
  ctx.setLineDash([5, 5]);
  ctx.strokeRect(paddingX, paddingY, w - (paddingX * 2), h - (paddingY * 2));
  ctx.setLineDash([]);
}

function generateMetaTags(title, subtitle, imageUrl) {
  const card = document.getElementById('social-preview-card');
  const metaPreview = card.querySelector('#sp-meta-preview');
  const metaCode = card.querySelector('#sp-meta-code');
  
  if (!imageUrl) return;
  
  const html = `<!-- Open Graph Meta Tags -->
<meta property="og:title" content="${title}" />
<meta property="og:description" content="${subtitle || title}" />
<meta property="og:image" content="${imageUrl}" />
<meta property="og:image:width" content="1200" />
<meta property="og:image:height" content="630" />
<meta property="og:type" content="website" />

<!-- Twitter Card Meta Tags -->
<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="${title}" />
<meta name="twitter:description" content="${subtitle || title}" />
<meta name="twitter:image" content="${imageUrl}" />`;
  
  metaCode.value = html;
  metaPreview.style.display = 'block';
}

function spDownload(btn) {
  const card = btn.closest('.card');
  const canvas = card.querySelector('#sp-canvas');
  
  if (!canvas.width || !canvas.height) {
    card.querySelector('#sp-hint').textContent = "Please generate an image first.";
    return;
  }
  
  const size = parseSize(card.querySelector('#sp-size').value);
  const spec = PLATFORM_SPECS[`${size.w}x${size.h}`] || { name: 'social-preview' };
  const filename = `${spec.name.toLowerCase().replace(/\s+/g, '-')}-${size.w}x${size.h}.png`;
  
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  card.querySelector('#sp-hint').innerHTML = `
    <span style="color:#4caf50;">✓</span> Downloaded ${filename}
  `;
}

function spDownloadJPG(btn) {
  const card = btn.closest('.card');
  const canvas = card.querySelector('#sp-canvas');
  
  if (!canvas.width || !canvas.height) {
    card.querySelector('#sp-hint').textContent = "Please generate an image first.";
    return;
  }
  
  const size = parseSize(card.querySelector('#sp-size').value);
  const spec = PLATFORM_SPECS[`${size.w}x${size.h}`] || { name: 'social-preview' };
  const filename = `${spec.name.toLowerCase().replace(/\s+/g, '-')}-${size.w}x${size.h}.jpg`;
  
  const link = document.createElement('a');
  link.download = filename;
  link.href = canvas.toDataURL('image/jpeg', 0.92);
  link.click();
  
  card.querySelector('#sp-hint').innerHTML = `
    <span style="color:#4caf50;">✓</span> Downloaded ${filename} (JPG)
  `;
}

function spCopyHTML(btn) {
  const card = btn.closest('.card');
  const metaCode = card.querySelector('#sp-meta-code');
  
  if (!metaCode.value) {
    card.querySelector('#sp-hint').textContent = "Generate an image first to get HTML meta tags.";
    return;
  }
  
  metaCode.select();
  metaCode.setSelectionRange(0, 99999);
  
  try {
    navigator.clipboard.writeText(metaCode.value).then(() => {
      card.querySelector('#sp-hint').innerHTML = `
        <span style="color:#4caf50;">✓</span> HTML meta tags copied to clipboard!
      `;
    });
  } catch (err) {
    // Fallback for older browsers
    document.execCommand('copy');
    card.querySelector('#sp-hint').innerHTML = `
      <span style="color:#4caf50;">✓</span> HTML meta tags copied to clipboard!
    `;
  }
}

function spReset(btn) {
  const card = btn.closest('.card');
  
  // Reset form
  card.querySelector('#sp-title').value = 'Introducing Our New Product';
  card.querySelector('#sp-subtitle').value = 'Revolutionizing the way you work';
  card.querySelector('#sp-size').value = '1200x630';
  card.querySelector('#sp-theme').value = 'dark';
  card.querySelector('#sp-brand').value = '#00D1FF';
  card.querySelector('#sp-brand-hex').value = '#00D1FF';
  card.querySelector('#sp-text-color').value = '#FFFFFF';
  card.querySelector('#sp-text-theme').value = 'auto';
  card.querySelector('#sp-font').value = 'inter';
  card.querySelector('#sp-overlay').value = '60';
  card.querySelector('#overlay-value').textContent = '60%';
  card.querySelector('#sp-logo').value = '';
  card.querySelector('#sp-bg').value = '';
  
  // Clear images
  logoImage = null;
  bgImage = null;
  
  // Update character counts
  updateCharacterCounts();
  
  // Reset canvas
  const canvas = card.querySelector('#sp-canvas');
  canvas.width = 800;
  canvas.height = 418;
  drawInitialCanvas(canvas);
  
  // Hide meta preview
  card.querySelector('#sp-meta-preview').style.display = 'none';
  
  // Clear hint
  card.querySelector('#sp-hint').textContent = '';
}
</script>
