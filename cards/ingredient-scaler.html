<h2 id="ingredient-scaler" style="margin-top:0;color:var(--accent);text-align:center;position:relative;">
  ğŸ§® <span style="color:#ffa500">Smart</span> Recipe Scaler
  <div style="font-size:14px;color:rgba(230,250,255,0.7);font-weight:400;margin-top:4px;">
    Scale recipes perfectly with smart unit conversions
  </div>
</h2>

<!-- Kitchen Dashboard -->
<div style="background:linear-gradient(135deg, rgba(255,165,0,0.08), rgba(57,255,20,0.05));border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,165,0,0.2);box-shadow:0 4px 20px rgba(0,0,0,0.2);">
  <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;text-align:center;">
    <div style="padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;">
      <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Scaling Factor</div>
      <div id="is-factor-value" style="font-size:24px;font-weight:700;color:#ffa500;">2.0x</div>
    </div>
    <div style="padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;">
      <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Total Ingredients</div>
      <div id="is-total-ingredients" style="font-size:24px;font-weight:700;color:#39ff14;">0</div>
    </div>
    <div style="padding:8px;background:rgba(255,255,255,0.03);border-radius:8px;">
      <div style="font-size:11px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Converted Units</div>
      <div id="is-converted-units" style="font-size:18px;font-weight:700;color:#2dd4ff;">0</div>
    </div>
  </div>
</div>

<form aria-describedby="ingredient-scaler-desc" style="margin-top:16px;">
  <p id="ingredient-scaler-desc" class="small" style="text-align:center;color:rgba(230,250,255,0.9);line-height:1.5;">
    Perfectly scale any recipe with <span style="color:#ffa500;font-weight:600">smart parsing</span>, 
    automatic unit conversions, and kitchen-tested measurements.
  </p>

  <!-- RECIPE SCALING SECTION -->
  <div style="background:rgba(255,165,0,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,165,0,0.15);">
    <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:18px">âš–ï¸</span> Recipe Scaling
    </h4>
    
    <!-- Servings Control -->
    <div class="row" style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center;margin-bottom:16px;">
      <!-- Original Servings -->
      <div>
        <label for="is-original" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Original Servings
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="is-original" type="number" min="1" max="1000" value="4" 
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.05);color:inherit;text-align:center;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.8);white-space:nowrap;">servings</div>
        </div>
        <div style="display:flex;gap:4px;margin-top:6px;">
          <button type="button" onclick="isSetServings('original', 2)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">2</button>
          <button type="button" onclick="isSetServings('original', 4)" style="flex:1;padding:4px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:4px;color:#ffa500;cursor:pointer;font-size:11px;">4</button>
          <button type="button" onclick="isSetServings('original', 6)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">6</button>
          <button type="button" onclick="isSetServings('original', 8)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">8</button>
        </div>
      </div>
      
      <!-- Scaling Arrow -->
      <div style="text-align:center;padding:0 8px;">
        <div style="font-size:24px;color:rgba(255,165,0,0.5);">â†’</div>
        <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">scale to</div>
      </div>
      
      <!-- Desired Servings -->
      <div>
        <label for="is-desired" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Desired Servings
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="is-desired" type="number" min="1" max="1000" value="8" 
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.05);color:inherit;text-align:center;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.8);white-space:nowrap;">servings</div>
        </div>
        <div style="display:flex;gap:4px;margin-top:6px;">
          <button type="button" onclick="isSetServings('desired', 1)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">1</button>
          <button type="button" onclick="isSetServings('desired', 2)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">2</button>
          <button type="button" onclick="isSetServings('desired', 4)" style="flex:1;padding:4px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:4px;color:inherit;cursor:pointer;font-size:11px;">4</button>
          <button type="button" onclick="isSetServings('desired', 8)" style="flex:1;padding:4px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:4px;color:#ffa500;cursor:pointer;font-size:11px;">8</button>
        </div>
      </div>
    </div>
    
    <!-- Quick Scaling Presets -->
    <div style="margin-bottom:16px;">
      <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:6px;">Quick Scaling:</div>
      <div style="display:flex;gap:6px;flex-wrap:wrap;">
        <button type="button" onclick="isSetScaleFactor(0.5)" 
                style="padding:6px 10px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:11px;white-space:nowrap;">
          ğŸ”½ Halve Recipe (0.5x)
        </button>
        <button type="button" onclick="isSetScaleFactor(2)" 
                style="padding:6px 10px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:11px;white-space:nowrap;">
          ğŸ”¼ Double Recipe (2x)
        </button>
        <button type="button" onclick="isSetScaleFactor(3)" 
                style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;white-space:nowrap;">
          â¬†ï¸ Triple Recipe (3x)
        </button>
        <button type="button" onclick="isSetScaleFactor(0.25)" 
                style="padding:6px 10px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;color:#ffa500;cursor:pointer;font-size:11px;white-space:nowrap;">
          ğŸ¥„ Quarter Recipe (0.25x)
        </button>
      </div>
    </div>
    
    <!-- Measurement System -->
    <div style="margin-bottom:16px;">
      <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Measurement System
      </label>
      <div style="display:flex;gap:8px;">
        <button type="button" onclick="isSetMeasurementSystem('metric')" id="is-metric" 
                style="flex:1;padding:10px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:2px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
          ğŸ“ Metric (g, ml)
        </button>
        <button type="button" onclick="isSetMeasurementSystem('imperial')" id="is-imperial"
                style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;font-weight:500;">
          ğŸ¥„ Imperial (oz, cups)
        </button>
        <button type="button" onclick="isSetMeasurementSystem('both')" id="is-both"
                style="flex:1;padding:10px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;font-weight:500;">
          ğŸ”„ Show Both
        </button>
      </div>
    </div>
    
    <!-- Rounding Options -->
    <div>
      <label for="is-rounding" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Rounding Precision
      </label>
      <select id="is-rounding" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.05);color:inherit;cursor:pointer;">
        <option value="none">No rounding (exact values)</option>
        <option value="kitchen" selected>Kitchen-friendly (Â¼, Â½, Â¾)</option>
        <option value="decimal1">1 decimal place (e.g., 12.5)</option>
        <option value="decimal2">2 decimal places (e.g., 12.50)</option>
        <option value="whole">Whole numbers only</option>
      </select>
    </div>
  </div>

  <!-- INGREDIENTS INPUT -->
  <div style="background:rgba(57,255,20,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(57,255,20,0.15);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <h4 style="color:var(--accent);margin:0;display:flex;align-items:center;gap:8px;">
        <span style="font-size:18px">ğŸ¥•</span> Recipe Ingredients
      </h4>
      <div style="display:flex;gap:6px;">
        <button type="button" onclick="isClearIngredients()" 
                style="padding:4px 8px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:11px;">
          Clear All
        </button>
        <button type="button" onclick="isLoadExample()" 
                style="padding:4px 8px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:11px;">
          Load Example
        </button>
      </div>
    </div>
    
    <div style="margin-bottom:12px;">
      <label for="is-ingredients" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Ingredients (one per line)
        <span style="font-size:11px;color:rgba(230,250,255,0.6);font-weight:400;margin-left:8px;">
          Format: "200 g flour" or "1 cup milk"
        </span>
      </label>
      <textarea id="is-ingredients" rows="10" 
                style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(0,0,0,0.2);color:inherit;font-family:monospace;font-size:14px;resize:vertical;"
                placeholder="Enter ingredients here, one per line:
200 g all-purpose flour
2 large eggs
1 cup milk
1 tsp salt
..."></textarea>
    </div>
    
    <!-- Smart Input Tips -->
    <div style="background:rgba(0,0,0,0.2);border-radius:6px;padding:10px;border-left:3px solid var(--accent);">
      <div style="font-size:12px;color:var(--accent);font-weight:500;margin-bottom:4px;">ğŸ’¡ Smart Parsing Tips:</div>
      <div style="font-size:11px;color:rgba(230,250,255,0.7);line-height:1.4;">
        â€¢ Supports: "200g flour", "1/2 cup sugar", "3 large eggs", "1.5 tsp vanilla"<br>
        â€¢ Fractions: Â¼, Â½, Â¾, â…“, â…” are automatically converted<br>
        â€¢ Common units: g, kg, ml, L, tsp, tbsp, cup, oz, lb, pinch, dash<br>
        â€¢ Special handling for eggs, bananas, lemons (whole items)
      </div>
    </div>
  </div>

  <!-- ACTIONS -->
  <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
    <button type="button" onclick="scaleIngredients()" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(255,165,0,0.2), rgba(255,165,0,0.1));border:1px solid rgba(255,165,0,0.4);border-radius:10px;color:#ffa500;cursor:pointer;font-weight:600;font-size:16px;display:flex;align-items:center;justify-content:center;gap:8px;">
      <span>ğŸ§®</span> Scale Recipe
    </button>
    <button type="button" onclick="isCopyResults()"
            style="padding:14px 20px;background:linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1));border:1px solid rgba(57,255,20,0.4);border-radius:10px;color:#39ff14;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;">
      ğŸ“‹ Copy
    </button>
    <button type="button" onclick="isShareRecipe()"
            style="padding:14px 20px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:10px;color:var(--accent);cursor:pointer;font-weight:600;display:flex;align-items:center;gap:6px;">
      ğŸ“¤ Share
    </button>
  </div>
</form>

<!-- RESULTS SECTION -->
<div class="results" aria-live="polite" style="margin-top:20px;">
  <div style="background:linear-gradient(135deg, rgba(20,20,20,0.8), rgba(10,15,20,0.9));border-radius:12px;padding:20px;border:1px solid rgba(255,165,0,0.2);box-shadow:0 8px 32px rgba(0,0,0,0.3);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h3 style="color:var(--accent);margin:0;font-size:18px;display:flex;align-items:center;gap:8px;">
        <span>ğŸ“</span> Scaled Recipe
      </h3>
      <div style="display:flex;gap:6px;align-items:center;">
        <div style="font-size:12px;color:rgba(230,250,255,0.7);">
          <span id="is-original-display">4</span> â†’ <span id="is-desired-display">8</span> servings
        </div>
        <div id="is-factor-display" style="font-size:11px;padding:2px 6px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:4px;color:#ffa500;">
          2.0x
        </div>
      </div>
    </div>
    
    <!-- Scaled Ingredients -->
    <div id="is-output" 
         style="background:rgba(0,0,0,0.3);border-radius:8px;padding:16px;border:1px solid rgba(255,255,255,0.1);min-height:100px;max-height:400px;overflow-y:auto;font-family:monospace;font-size:14px;line-height:1.6;white-space:pre-wrap;">
      <div style="text-align:center;padding:40px;color:rgba(230,250,255,0.5);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ³</div>
        <div>Enter ingredients above and click "Scale Recipe"</div>
        <div style="font-size:12px;margin-top:6px;">Your scaled recipe will appear here</div>
      </div>
    </div>
    
    <!-- Conversion Notes -->
    <div id="is-conversion-notes" style="margin-top:16px;display:none;">
      <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ“‹ Conversion Notes:</div>
      <div id="is-notes-content" style="font-size:11px;color:rgba(230,250,255,0.8);line-height:1.4;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;border-left:3px solid #39ff14;"></div>
    </div>
  </div>
</div>

<!-- KITCHEN CONVERSIONS -->
<details class="small" style="margin-top:20px;background:rgba(20,20,20,0.6);border-radius:10px;border:1px solid rgba(255,255,255,0.1);padding:8px;">
  <summary style="color:var(--accent);font-weight:600;cursor:pointer;padding:8px;font-size:14px;">
    ğŸ“š Kitchen Measurement Conversions
  </summary>
  <div style="padding:12px 8px 8px;border-top:1px solid rgba(255,255,255,0.1);">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div>
        <h5 style="color:var(--accent);margin-top:0;margin-bottom:6px;font-size:13px;">Volume Conversions</h5>
        <ul style="font-size:12px;color:rgba(230,250,255,0.8);padding-left:16px;margin:0;">
          <li>1 cup = 240 ml = 16 tbsp</li>
          <li>1 tablespoon = 15 ml = 3 tsp</li>
          <li>1 teaspoon = 5 ml</li>
          <li>1 fluid ounce = 30 ml</li>
          <li>1 pint = 2 cups = 480 ml</li>
          <li>1 quart = 4 cups = 960 ml</li>
        </ul>
      </div>
      <div>
        <h5 style="color:var(--accent);margin-top:0;margin-bottom:6px;font-size:13px;">Weight Conversions</h5>
        <ul style="font-size:12px;color:rgba(230,250,255,0.8);padding-left:16px;margin:0;">
          <li>1 ounce = 28.35 grams</li>
          <li>1 pound = 16 oz = 454 grams</li>
          <li>1 kilogram = 1000 grams = 2.2 lbs</li>
          <li>1 stick butter = Â½ cup = 113g</li>
          <li>Common: Flour â‰ˆ 120g/cup</li>
          <li>Sugar â‰ˆ 200g/cup, Brown â‰ˆ 220g/cup</li>
        </ul>
      </div>
    </div>
    
    <!-- Ingredient-Specific Conversions -->
    <div style="background:rgba(255,165,0,0.05);border-radius:8px;padding:10px;margin-top:10px;border:1px solid rgba(255,165,0,0.1);">
      <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">ğŸ¥š Ingredient-Specific Notes</div>
      <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:11px;">
        <div style="padding:6px;background:rgba(255,255,255,0.03);border-radius:4px;">
          <div style="color:var(--accent);font-weight:500;">Eggs</div>
          <div style="color:rgba(230,250,255,0.8);">Scale by count (rounded up)</div>
        </div>
        <div style="padding:6px;background:rgba(255,255,255,0.03);border-radius:4px;">
          <div style="color:#ffa500;font-weight:500;">Baking Powder</div>
          <div style="color:rgba(230,250,255,0.8);">Scale carefully, affects rise</div>
        </div>
        <div style="padding:6px;background:rgba(255,255,255,0.03);border-radius:4px;">
          <div style="color:#39ff14;font-weight:500;">Seasonings</div>
          <div style="color:rgba(230,250,255,0.8);">Taste and adjust as needed</div>
        </div>
      </div>
    </div>
    
    <div style="display:flex;justify-content:space-between;align-items:center;margin-top:12px;">
      <div style="font-size:11px;color:rgba(230,250,255,0.6);">
        Note: Baking recipes may need adjustment beyond simple scaling
      </div>
      <button type="button" onclick="isSaveRecipe()"
              style="padding:6px 12px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:6px;color:#ffa500;cursor:pointer;font-size:11px;">
        ğŸ’¾ Save Recipe
      </button>
    </div>
  </div>
</details>

<!-- BAKING CALCULATOR -->
<div style="margin-top:20px;background:rgba(20,20,20,0.6);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
  <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;text-align:center;font-size:16px;">
    ğŸ° Baker's Percentage Calculator
  </h4>
  
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
    <div style="text-align:center;padding:12px;background:rgba(57,255,20,0.08);border-radius:8px;">
      <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Total Flour Weight</div>
      <input id="is-baker-flour" type="number" min="0" step="10" value="500" 
             style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:#39ff14;text-align:center;font-size:16px;font-weight:600;" />
    </div>
    <div style="text-align:center;padding:12px;background:rgba(45,212,255,0.08);border-radius:8px;">
      <div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:4px;">Hydration %</div>
      <div id="is-hydration-percent" style="font-size:16px;font-weight:600;color:var(--accent);">70%</div>
      <div style="font-size:10px;color:rgba(230,250,255,0.6);margin-top:4px;">(Water Ã· Flour Ã— 100)</div>
    </div>
  </div>
  
  <div style="text-align:center;">
    <button type="button" onclick="isCalculateBakersPercent()"
            style="padding:10px 20px;background:linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1));border:1px solid rgba(57,255,20,0.4);border-radius:8px;color:#39ff14;cursor:pointer;font-weight:600;display:inline-flex;align-items:center;gap:6px;">
      ğŸ§ Calculate Baker's Percentages
    </button>
  </div>
  
  <!-- Baker's Result -->
  <div id="is-bakers-result" style="margin-top:16px;padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;border:1px solid rgba(255,165,0,0.2);display:none;">
    <div style="font-size:13px;color:rgba(230,250,255,0.9);">
      <div style="color:#ffa500;font-weight:600;margin-bottom:6px;">ğŸ§‘â€ğŸ³ Baker's Percentages:</div>
      <div style="font-family:monospace;font-size:12px;line-height:1.5;">
        <div>Flour: 100% (500g)</div>
        <div>Water: 70% (350g)</div>
        <div>Salt: 2% (10g)</div>
        <div>Yeast: 1% (5g)</div>
      </div>
    </div>
  </div>
</div>

<script>
/* ingredient-scaler.html - VIRAL KITCHEN EDITION
   - Smart recipe scaling with unit conversions
   - Baker's percentage calculator
   - Kitchen-tested rounding
   - Multiple measurement systems
   - Ingredient-specific handling
*/

// Configuration
let isConfig = {
  measurementSystem: 'metric',
  roundingPrecision: 'kitchen',
  lastCalculation: null,
  conversionFactors: {
    // Volume conversions
    'tsp': { to: 'ml', factor: 5 },
    'tbsp': { to: 'ml', factor: 15 },
    'cup': { to: 'ml', factor: 240 },
    'fl oz': { to: 'ml', factor: 30 },
    'pint': { to: 'ml', factor: 480 },
    'quart': { to: 'ml', factor: 960 },
    'liter': { to: 'ml', factor: 1000 },
    'ml': { to: 'ml', factor: 1 },
    
    // Weight conversions
    'oz': { to: 'g', factor: 28.35 },
    'lb': { to: 'g', factor: 453.59 },
    'g': { to: 'g', factor: 1 },
    'kg': { to: 'g', factor: 1000 }
  },
  
  // Common ingredient densities (g per cup)
  ingredientDensities: {
    'flour': 120,
    'sugar': 200,
    'brown sugar': 220,
    'butter': 227,
    'milk': 240,
    'water': 240,
    'honey': 340,
    'oil': 220,
    'cocoa': 100,
    'oat': 90,
    'rice': 200
  }
};

// Fractions to decimal mapping
const fractionMap = {
  'Â¼': 0.25, 'Â½': 0.5, 'Â¾': 0.75,
  'â…“': 0.333, 'â…”': 0.667,
  'â…•': 0.2, 'â…–': 0.4, 'â…—': 0.6, 'â…˜': 0.8,
  'â…™': 0.167, 'â…š': 0.833,
  'â…›': 0.125, 'â…œ': 0.375, 'â…': 0.625, 'â…': 0.875
};

// Initialize
function isInit() {
  console.log("Ingredient Scaler initialized");
  
  // Load saved recipe
  const savedRecipe = localStorage.getItem('isRecipe');
  if (savedRecipe) {
    try {
      const recipe = JSON.parse(savedRecipe);
      
      // Apply saved values
      document.getElementById('is-original').value = recipe.original || 4;
      document.getElementById('is-desired').value = recipe.desired || 8;
      document.getElementById('is-ingredients').value = recipe.ingredients || '';
      document.getElementById('is-rounding').value = recipe.rounding || 'kitchen';
      
      if (recipe.measurementSystem) {
        isSetMeasurementSystem(recipe.measurementSystem);
      }
      
    } catch (e) {
      console.log("Failed to load recipe:", e);
    }
  }
  
  // Set up event listeners for real-time updates
  document.querySelectorAll('#is-original, #is-desired').forEach(input => {
    input.addEventListener('input', function() {
      isUpdateScalingFactor();
    });
  });
  
  // Initial update
  isUpdateScalingFactor();
}

// Set servings
function isSetServings(type, servings) {
  if (type === 'original') {
    document.getElementById('is-original').value = servings;
  } else {
    document.getElementById('is-desired').value = servings;
  }
  isUpdateScalingFactor();
}

// Set scale factor directly
function isSetScaleFactor(factor) {
  const original = parseFloat(document.getElementById('is-original').value) || 4;
  const desired = Math.round(original * factor);
  document.getElementById('is-desired').value = desired;
  isUpdateScalingFactor();
}

// Set measurement system
function isSetMeasurementSystem(system) {
  isConfig.measurementSystem = system;
  
  // Update button styles
  ['metric', 'imperial', 'both'].forEach(sys => {
    const btn = document.getElementById(`is-${sys}`);
    if (sys === system) {
      btn.style.background = 'linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1))';
      btn.style.border = '2px solid rgba(45,212,255,0.4)';
      btn.style.color = 'var(--accent)';
      btn.style.fontWeight = '600';
    } else {
      btn.style.background = 'rgba(255,255,255,0.05)';
      btn.style.border = '1px solid rgba(255,255,255,0.1)';
      btn.style.color = 'inherit';
      btn.style.fontWeight = '500';
    }
  });
  
  // If we have a calculation, update it
  if (isConfig.lastCalculation) {
    scaleIngredients();
  }
}

// Update scaling factor display
function isUpdateScalingFactor() {
  const original = parseFloat(document.getElementById('is-original').value) || 1;
  const desired = parseFloat(document.getElementById('is-desired').value) || 1;
  const factor = desired / original;
  
  document.getElementById('is-factor-value').textContent = factor.toFixed(1) + 'x';
  document.getElementById('is-factor-display').textContent = factor.toFixed(1) + 'x';
  document.getElementById('is-original-display').textContent = original;
  document.getElementById('is-desired-display').textContent = desired;
}

// Load example recipe
function isLoadExample() {
  const example = `200 g all-purpose flour
1/2 tsp salt
1 tsp baking powder
100 g sugar
2 large eggs
1 cup milk
2 tbsp vegetable oil
1 tsp vanilla extract
1/2 cup chocolate chips
1 medium banana, mashed
1 tbsp lemon juice`;
  
  document.getElementById('is-ingredients').value = example;
  
  // Visual feedback
  const exampleBtn = document.querySelector('[onclick="isLoadExample()"]');
  const originalText = exampleBtn.textContent;
  exampleBtn.textContent = 'âœ… Loaded!';
  exampleBtn.style.background = 'rgba(57,255,20,0.2)';
  
  setTimeout(() => {
    exampleBtn.textContent = originalText;
    exampleBtn.style.background = '';
  }, 1500);
}

// Clear all ingredients
function isClearIngredients() {
  if (confirm("Clear all ingredients?")) {
    document.getElementById('is-ingredients').value = '';
    document.getElementById('is-output').innerHTML = `
      <div style="text-align:center;padding:40px;color:rgba(230,250,255,0.5);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ³</div>
        <div>Enter ingredients above and click "Scale Recipe"</div>
        <div style="font-size:12px;margin-top:6px;">Your scaled recipe will appear here</div>
      </div>
    `;
    document.getElementById('is-conversion-notes').style.display = 'none';
  }
}

// Main scaling function
function scaleIngredients() {
  const original = parseFloat(document.getElementById('is-original').value) || 1;
  const desired = parseFloat(document.getElementById('is-desired').value) || 1;
  const factor = desired / original;
  const rounding = document.getElementById('is-rounding').value;
  
  const input = document.getElementById('is-ingredients').value;
  const lines = input.split('\n').filter(line => line.trim());
  
  if (lines.length === 0) {
    isShowError("Please enter some ingredients to scale.");
    return;
  }
  
  let scaledLines = [];
  let notes = [];
  let totalIngredients = 0;
  let convertedUnits = 0;
  
  // Parse and scale each line
  lines.forEach(line => {
    const trimmed = line.trim();
    if (!trimmed) return;
    
    totalIngredients++;
    
    // Try to parse the ingredient line
    const parsed = isParseIngredientLine(trimmed);
    
    if (parsed) {
      let { amount, unit, ingredient, originalText } = parsed;
      
      // Scale the amount
      let scaledAmount = amount * factor;
      
      // Special handling for whole items (eggs, bananas, etc.)
      const wholeItemKeywords = ['egg', 'banana', 'lemon', 'lime', 'apple', 'orange', 'potato', 'onion', 'garlic', 'pepper'];
      const isWholeItem = wholeItemKeywords.some(keyword => 
        ingredient.toLowerCase().includes(keyword)
      );
      
      if (isWholeItem && unit === '') {
        // For whole items, round to nearest whole number
        scaledAmount = Math.round(scaledAmount);
        if (scaledAmount === 0) scaledAmount = 1; // Minimum 1
        
        // Add note if needed
        if (Math.abs(scaledAmount - amount * factor) > 0.1) {
          notes.push(`â€¢ ${ingredient}: rounded to nearest whole number`);
        }
      }
      
      // Apply rounding
      scaledAmount = isApplyRounding(scaledAmount, rounding, unit);
      
      // Convert units if needed
      let displayAmount = scaledAmount;
      let displayUnit = unit;
      let converted = false;
      
      if (isConfig.measurementSystem === 'metric' && ['cup', 'tbsp', 'tsp', 'fl oz', 'pint', 'quart', 'oz', 'lb'].includes(unit)) {
        // Convert to metric
        const conversion = isConvertToMetric(scaledAmount, unit, ingredient);
        if (conversion) {
          displayAmount = conversion.amount;
          displayUnit = conversion.unit;
          converted = true;
          convertedUnits++;
        }
      } else if (isConfig.measurementSystem === 'imperial' && ['g', 'kg', 'ml', 'liter', 'l'].includes(unit)) {
        // Convert to imperial
        const conversion = isConvertToImperial(scaledAmount, unit, ingredient);
        if (conversion) {
          displayAmount = conversion.amount;
          displayUnit = conversion.unit;
          converted = true;
          convertedUnits++;
        }
      } else if (isConfig.measurementSystem === 'both') {
        // Show both systems
        const metricConversion = isConvertToMetric(scaledAmount, unit, ingredient);
        const imperialConversion = isConvertToImperial(scaledAmount, unit, ingredient);
        
        if (metricConversion && imperialConversion && unit !== metricConversion.unit) {
          scaledLines.push(`â€¢ ${isFormatAmount(displayAmount, rounding)} ${displayUnit} ${ingredient} (${metricConversion.amount} ${metricConversion.unit})`);
          convertedUnits++;
          return;
        }
      }
      
      // Format the line
      const formattedAmount = isFormatAmount(displayAmount, rounding);
      scaledLines.push(`â€¢ ${formattedAmount} ${displayUnit} ${ingredient}${converted ? ' (converted)' : ''}`);
      
    } else {
      // If we can't parse it, just pass it through
      scaledLines.push(`â€¢ ${trimmed}`);
    }
  });
  
  // Update output
  const outputDiv = document.getElementById('is-output');
  outputDiv.innerHTML = scaledLines.join('\n');
  
  // Update dashboard
  document.getElementById('is-total-ingredients').textContent = totalIngredients;
  document.getElementById('is-converted-units').textContent = convertedUnits;
  
  // Show conversion notes if any
  const notesDiv = document.getElementById('is-conversion-notes');
  const notesContent = document.getElementById('is-notes-content');
  
  if (notes.length > 0) {
    notesContent.innerHTML = notes.join('<br>');
    notesDiv.style.display = 'block';
  } else {
    notesDiv.style.display = 'none';
  }
  
  // Save calculation
  isConfig.lastCalculation = {
    original: original,
    desired: desired,
    factor: factor,
    ingredients: lines,
    timestamp: new Date().toISOString()
  };
  
  // Save recipe
  isSaveRecipe();
}

// Parse ingredient line
function isParseIngredientLine(line) {
  // Match patterns like "200 g flour", "1/2 cup sugar", "3 large eggs"
  const patterns = [
    // Decimal or fraction + unit + ingredient
    /^([0-9Â¼Â½Â¾â…“â…”â…•â…–â…—â…˜â…™â…šâ…›â…œâ…â…\.\/]+)\s*([a-zA-Z]*)\s+(.+)$/,
    // Decimal or fraction + ingredient (no unit)
    /^([0-9Â¼Â½Â¾â…“â…”â…•â…–â…—â…˜â…™â…šâ…›â…œâ…â…\.\/]+)\s+(.+)$/,
    // Just ingredient
    /^(.+)$/
  ];
  
  for (const pattern of patterns) {
    const match = line.match(pattern);
    if (match) {
      let amountStr = match[1] || '';
      let unit = match[2] || '';
      let ingredient = match[3] || match[2] || match[1] || '';
      
      // Clean up
      unit = unit.toLowerCase().trim();
      ingredient = ingredient.trim();
      
      // Convert fraction to decimal
      let amount = 0;
      if (amountStr in fractionMap) {
        amount = fractionMap[amountStr];
      } else if (amountStr.includes('/')) {
        // Handle fractions like "1/2"
        const [numerator, denominator] = amountStr.split('/').map(Number);
        amount = numerator / denominator;
      } else if (amountStr.includes(' ')) {
        // Handle mixed numbers like "1 1/2"
        const parts = amountStr.split(' ');
        if (parts.length === 2) {
          const whole = parseFloat(parts[0]) || 0;
          const fraction = parts[1];
          if (fraction in fractionMap) {
            amount = whole + fractionMap[fraction];
          } else if (fraction.includes('/')) {
            const [num, den] = fraction.split('/').map(Number);
            amount = whole + (num / den);
          }
        }
      } else {
        amount = parseFloat(amountStr) || 0;
      }
      
      // If amount is 0 but we have an ingredient, assume it's 1
      if (amount === 0 && ingredient) {
        amount = 1;
      }
      
      // Standardize units
      const unitMap = {
        't': 'tsp', 'tsp': 'tsp', 'teaspoon': 'tsp', 'teaspoons': 'tsp',
        'T': 'tbsp', 'tbsp': 'tbsp', 'tablespoon': 'tbsp', 'tablespoons': 'tbsp',
        'c': 'cup', 'cup': 'cup', 'cups': 'cup',
        'ml': 'ml', 'milliliter': 'ml', 'milliliters': 'ml',
        'l': 'liter', 'liter': 'liter', 'liters': 'liter', 'litre': 'liter', 'litres': 'liter',
        'oz': 'oz', 'ounce': 'oz', 'ounces': 'oz',
        'lb': 'lb', 'pound': 'lb', 'pounds': 'lb',
        'g': 'g', 'gram': 'g', 'grams': 'g',
        'kg': 'kg', 'kilogram': 'kg', 'kilograms': 'kg',
        'floz': 'fl oz', 'fluid ounce': 'fl oz', 'fluid ounces': 'fl oz',
        'pt': 'pint', 'pint': 'pint', 'pints': 'pint',
        'qt': 'quart', 'quart': 'quart', 'quarts': 'quart'
      };
      
      if (unit in unitMap) {
        unit = unitMap[unit];
      }
      
      return { amount, unit, ingredient, originalText: line };
    }
  }
  
  return null;
}

// Apply rounding
function isApplyRounding(amount, rounding, unit) {
  switch (rounding) {
    case 'kitchen':
      // Round to common kitchen fractions
      const fractions = [0, 0.125, 0.25, 0.333, 0.375, 0.5, 0.625, 0.667, 0.75, 0.875, 1];
      const whole = Math.floor(amount);
      const decimal = amount - whole;
      
      // Find closest fraction
      let closestFraction = 0;
      let minDiff = Infinity;
      
      for (const fraction of fractions) {
        const diff = Math.abs(decimal - fraction);
        if (diff < minDiff) {
          minDiff = diff;
          closestFraction = fraction;
        }
      }
      
      return whole + closestFraction;
      
    case 'decimal1':
      return Math.round(amount * 10) / 10;
      
    case 'decimal2':
      return Math.round(amount * 100) / 100;
      
    case 'whole':
      return Math.round(amount);
      
    default:
      return amount;
  }
}

// Format amount for display
function isFormatAmount(amount, rounding) {
  if (rounding === 'kitchen') {
    const whole = Math.floor(amount);
    const decimal = amount - whole;
    
    // Map decimal to fraction symbol
    const fractionSymbols = {
      0: '', 0.125: 'â…›', 0.25: 'Â¼', 0.333: 'â…“', 0.375: 'â…œ',
      0.5: 'Â½', 0.625: 'â…', 0.667: 'â…”', 0.75: 'Â¾', 0.875: 'â…', 1: ''
    };
    
    if (decimal in fractionSymbols) {
      const fraction = fractionSymbols[decimal];
      if (whole === 0 && fraction) {
        return fraction;
      } else if (whole > 0 && fraction) {
        return `${whole} ${fraction}`;
      } else {
        return whole.toString();
      }
    }
  }
  
  // For other rounding types or if no fraction match
  if (amount % 1 === 0) {
    return amount.toString();
  } else if (rounding === 'decimal1') {
    return amount.toFixed(1);
  } else if (rounding === 'decimal2') {
    return amount.toFixed(2);
  } else {
    return amount.toString();
  }
}

// Convert to metric
function isConvertToMetric(amount, unit, ingredient) {
  // Check if we have a conversion factor
  if (unit in isConfig.conversionFactors) {
    const conversion = isConfig.conversionFactors[unit];
    const convertedAmount = amount * conversion.factor;
    
    // For volume to weight conversions (common ingredients)
    const ingredientLower = ingredient.toLowerCase();
    for (const [key, density] of Object.entries(isConfig.ingredientDensities)) {
      if (ingredientLower.includes(key)) {
        if (conversion.to === 'ml' && ['cup', 'tbsp', 'tsp', 'fl oz'].includes(unit)) {
          // Convert volume to weight for common ingredients
          const weight = convertedAmount * (density / 240); // 240ml per cup
          return { amount: Math.round(weight), unit: 'g' };
        }
      }
    }
    
    // Standard conversion
    let displayUnit = conversion.to;
    let displayAmount = convertedAmount;
    
    // Adjust unit for readability
    if (conversion.to === 'g' && displayAmount >= 1000) {
      displayAmount = displayAmount / 1000;
      displayUnit = 'kg';
    } else if (conversion.to === 'ml' && displayAmount >= 1000) {
      displayAmount = displayAmount / 1000;
      displayUnit = 'liter';
    }
    
    return { amount: Math.round(displayAmount * 100) / 100, unit: displayUnit };
  }
  
  return null;
}

// Convert to imperial
function isConvertToImperial(amount, unit, ingredient) {
  // Reverse conversions
  const reverseConversions = {
    'g': { from: 'oz', factor: 1/28.35 },
    'kg': { from: 'lb', factor: 2.20462 },
    'ml': { from: 'fl oz', factor: 0.033814 },
    'liter': { from: 'cup', factor: 4.22675 }
  };
  
  if (unit in reverseConversions) {
    const conversion = reverseConversions[unit];
    const convertedAmount = amount * conversion.factor;
    
    // For weight to volume conversions (common ingredients)
    const ingredientLower = ingredient.toLowerCase();
    for (const [key, density] of Object.entries(isConfig.ingredientDensities)) {
      if (ingredientLower.includes(key)) {
        if (unit === 'g' || unit === 'kg') {
          // Convert weight to volume for common ingredients
          const weightInG = unit === 'kg' ? amount * 1000 : amount;
          const volumeInCups = weightInG / density;
          return { amount: Math.round(volumeInCups * 100) / 100, unit: 'cup' };
        }
      }
    }
    
    // Standard conversion
    return { amount: Math.round(convertedAmount * 100) / 100, unit: conversion.from };
  }
  
  return null;
}

// Copy results to clipboard
function isCopyResults() {
  const output = document.getElementById('is-output').textContent;
  if (!output.trim() || output.includes('Enter ingredients above')) {
    return;
  }
  
  const original = document.getElementById('is-original').value;
  const desired = document.getElementById('is-desired').value;
  const factor = (desired / original).toFixed(1);
  
  const header = `ğŸ“ Scaled Recipe (${original} â†’ ${desired} servings, ${factor}x)\n\n`;
  const fullText = header + output;
  
  navigator.clipboard.writeText(fullText).then(() => {
    // Visual feedback
    const copyBtn = document.querySelector('[onclick="isCopyResults()"]');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = 'âœ… Copied!';
    copyBtn.style.background = 'rgba(57,255,20,0.2)';
    
    setTimeout(() => {
      copyBtn.textContent = originalText;
      copyBtn.style.background = '';
    }, 1500);
  });
}

// Share recipe
function isShareRecipe() {
  const original = document.getElementById('is-original').value;
  const desired = document.getElementById('is-desired').value;
  const factor = (desired / original).toFixed(1);
  
  const shareText = `ğŸ§® I scaled a recipe from ${original} to ${desired} servings (${factor}x) using the Smart Recipe Scaler! Try it at The Most Useful Site in the World!`;
  
  // Try Web Share API first
  if (navigator.share) {
    navigator.share({
      title: 'My Scaled Recipe',
      text: shareText,
      url: window.location.href
    }).catch(err => {
      console.log('Share cancelled:', err);
      // Fallback to clipboard
      navigator.clipboard.writeText(shareText).then(() => {
        alert('Recipe link copied to clipboard! ğŸ“‹');
      });
    });
  } else {
    // Fallback to clipboard
    navigator.clipboard.writeText(shareText).then(() => {
      alert('Recipe link copied to clipboard! ğŸ“‹ Share with fellow cooks!');
    });
  }
}

// Save recipe
function isSaveRecipe() {
  const recipe = {
    original: document.getElementById('is-original').value,
    desired: document.getElementById('is-desired').value,
    ingredients: document.getElementById('is-ingredients').value,
    rounding: document.getElementById('is-rounding').value,
    measurementSystem: isConfig.measurementSystem,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('isRecipe', JSON.stringify(recipe));
}

// Calculate baker's percentages
function isCalculateBakersPercent() {
  const flour = parseFloat(document.getElementById('is-baker-flour').value) || 500;
  
  // Example calculations (in a real app, these would come from user input)
  const water = flour * 0.70; // 70% hydration
  const salt = flour * 0.02; // 2% salt
  const yeast = flour * 0.01; // 1% yeast
  
  const resultDiv = document.getElementById('is-bakers-result');
  const hydrationDiv = document.getElementById('is-hydration-percent');
  
  resultDiv.innerHTML = `
    <div style="color:#ffa500;font-weight:600;margin-bottom:6px;">ğŸ§‘â€ğŸ³ Baker's Percentages:</div>
    <div style="font-family:monospace;font-size:12px;line-height:1.5;">
      <div>Flour: 100% (${flour}g)</div>
      <div>Water: 70% (${Math.round(water)}g)</div>
      <div>Salt: 2% (${Math.round(salt)}g)</div>
      <div>Yeast: 1% (${Math.round(yeast)}g)</div>
    </div>
  `;
  
  hydrationDiv.textContent = '70%';
  resultDiv.style.display = 'block';
}

// Show error message
function isShowError(message) {
  const outputDiv = document.getElementById('is-output');
  outputDiv.innerHTML = `
    <div style="text-align:center;padding:20px;color:#ff2d55;">
      <div style="font-size:24px;margin-bottom:8px;">âš ï¸</div>
      <div>${message}</div>
    </div>
  `;
}

// Reset ingredients
function resetIngredients() {
  if (confirm("Reset all inputs to defaults?")) {
    document.getElementById('is-original').value = 4;
    document.getElementById('is-desired').value = 8;
    document.getElementById('is-ingredients').value = '';
    document.getElementById('is-rounding').value = 'kitchen';
    isSetMeasurementSystem('metric');
    
    const outputDiv = document.getElementById('is-output');
    outputDiv.innerHTML = `
      <div style="text-align:center;padding:40px;color:rgba(230,250,255,0.5);">
        <div style="font-size:48px;margin-bottom:12px;">ğŸ³</div>
        <div>Enter ingredients above and click "Scale Recipe"</div>
        <div style="font-size:12px;margin-top:6px;">Your scaled recipe will appear here</div>
      </div>
    `;
    
    document.getElementById('is-conversion-notes').style.display = 'none';
    isUpdateScalingFactor();
  }
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', isInit);
} else {
  isInit();
}
</script>

<style>
@keyframes ingredientScale {
  0% { transform: scale(0.9); opacity: 0.5; }
  100% { transform: scale(1); opacity: 1; }
}

#ingredient-scaler {
  position: relative;
  overflow: hidden;
}

#ingredient-scaler::after {
  content: '';
  position: absolute;
  bottom: -4px;
  left: 25%;
  width: 50%;
  height: 2px;
  background: linear-gradient(90deg, transparent, var(--accent), transparent);
  border-radius: 2px;
}

/* Scaling animation for results */
#is-output {
  animation: ingredientScale 0.3s ease-out;
}

/* Button hover effects */
button {
  transition: all 0.2s ease;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

/* Input focus effects */
input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px rgba(45,212,255,0.2);
}

/* Custom scrollbar for ingredient list */
#is-output::-webkit-scrollbar {
  width: 6px;
}

#is-output::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 3px;
}

#is-output::-webkit-scrollbar-thumb {
  background: rgba(255,165,0,0.3);
  border-radius: 3px;
}

#is-output::-webkit-scrollbar-thumb:hover {
  background: rgba(255,165,0,0.5);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .row {
    grid-template-columns: 1fr !important;
    gap: 12px !important;
  }
  
  .servings-control {
    grid-template-columns: 1fr !important;
  }
  
  .actions {
    flex-direction: column;
  }
  
  .actions button {
    width: 100%;
    margin: 4px 0 !important;
  }
  
  .measurement-buttons {
    flex-direction: column;
  }
  
  .measurement-buttons button {
    width: 100%;
    margin-bottom: 8px;
  }
  
  /* Adjust textareas for mobile */
  textarea {
    font-size: 16px !important; /* Prevent zoom on iOS */
  }
  
  /* Adjust ingredient parsing tips */
  .parsing-tips {
    font-size: 10px !important;
    line-height: 1.3 !important;
  }
}

/* Print styles for recipe cards */
@media print {
  .actions, button, details {
    display: none !important;
  }
  
  #is-output {
    background: white !important;
    color: black !important;
    border: 1px solid #ccc !important;
    max-height: none !important;
  }
}
</style>
