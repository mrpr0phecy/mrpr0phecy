<h2 id="matrices-title">Matrices Calculator</h2>

<form aria-describedby="matrices-desc">
  <p id="matrices-desc" class="small">
    Perform matrix operations: addition, multiplication, determinant, inverse, transpose, and more.
    <span style="color:var(--accent)">Supports up to 4x4 matrices with visual formatting.</span>
  </p>

  <!-- MATRIX INPUTS - VISUAL LAYOUT -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:16px;">
    <!-- MATRIX A -->
    <div style="background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(45,212,255,0.15);padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <label for="mat-a" style="color:var(--accent);font-weight:500;">Matrix A</label>
        <select id="mat-a-size" style="padding:4px 8px;border-radius:6px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:12px;">
          <option value="2x2">2√ó2</option>
          <option value="2x3">2√ó3</option>
          <option value="3x2">3√ó2</option>
          <option value="3x3" selected>3√ó3</option>
          <option value="3x4">3√ó4</option>
          <option value="4x4">4√ó4</option>
        </select>
      </div>
      <div id="mat-a-container" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:6px;">
        <!-- Matrix cells will be generated here -->
      </div>
      <div style="margin-top:8px;font-size:11px;color:rgba(230,250,255,0.6);">
        Format: rows separated by ;, values by ,
      </div>
      <input id="mat-a" type="hidden" />
    </div>

    <!-- MATRIX B -->
    <div style="background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(255,165,0,0.15);padding:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <label for="mat-b" style="color:#ffa500;font-weight:500;">Matrix B</label>
        <div style="display:flex;gap:4px;align-items:center;">
          <select id="mat-b-size" style="padding:4px 8px;border-radius:6px;border:1px solid rgba(255,165,0,0.3);background:rgba(255,165,0,0.05);color:inherit;font-size:12px;">
            <option value="2x2">2√ó2</option>
            <option value="2x3">2√ó3</option>
            <option value="3x2">3√ó2</option>
            <option value="3x3" selected>3√ó3</option>
            <option value="3x4">3√ó4</option>
            <option value="4x4">4√ó4</option>
          </select>
          <label style="display:flex;align-items:center;gap:2px;font-size:11px;">
            <input type="checkbox" id="mat-b-enabled" checked style="cursor:pointer;">
            Use
          </label>
        </div>
      </div>
      <div id="mat-b-container" style="display:grid;grid-template-columns:repeat(3, 1fr);gap:6px;">
        <!-- Matrix cells will be generated here -->
      </div>
      <div style="margin-top:8px;font-size:11px;color:rgba(230,250,255,0.6);">
        Required for addition/multiplication
      </div>
      <input id="mat-b" type="hidden" />
    </div>
  </div>

  <!-- OPERATIONS AND OPTIONS -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
    <div>
      <label for="mat-operation" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Operation
      </label>
      <select id="mat-operation" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
        <option value="add" selected>Addition (A + B)</option>
        <option value="subtract">Subtraction (A - B)</option>
        <option value="multiply">Multiplication (A √ó B)</option>
        <option value="scalar">Scalar Multiplication (kA)</option>
        <option value="det">Determinant (det(A))</option>
        <option value="transpose">Transpose (A·µÄ)</option>
        <option value="inverse">Inverse (A‚Åª¬π)</option>
        <option value="trace">Trace (tr(A))</option>
        <option value="identity">Identity Matrix</option>
        <option value="zero">Zero Matrix</option>
      </select>
    </div>

    <div>
      <label for="mat-scalar" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Scalar Value (for kA)
      </label>
      <input id="mat-scalar" type="number" step="any" value="2" placeholder="Enter scalar" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    </div>
  </div>

  <!-- QUICK MATRICES -->
  <div style="margin-bottom:20px;">
    <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">Quick Matrices:</div>
    <div style="display:flex;gap:8px;flex-wrap:wrap;">
      <button type="button" onclick="matQuick('identity')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Identity</button>
      <button type="button" onclick="matQuick('zero')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Zero</button>
      <button type="button" onclick="matQuick('rotation')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Rotation 90¬∞</button>
      <button type="button" onclick="matQuick('example1')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Example A</button>
      <button type="button" onclick="matQuick('example2')" style="padding:6px 10px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">Example B</button>
    </div>
  </div>

  <!-- ACTIONS - USING THEME COLORS -->
  <div class="actions" style="margin-top:20px;display:flex;gap:10px;">
    <button type="button" onclick="matCalculate(this)" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      üßÆ Calculate
    </button>
    <button type="button" onclick="matReset(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset
    </button>
    <button type="button" onclick="matCopy(this)"
            style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      Copy Result
    </button>
  </div>

  <!-- DISPLAY OPTIONS -->
  <div style="margin-top:12px;display:flex;flex-wrap:wrap;gap:16px;align-items:center;">
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input type="checkbox" id="mat-show-steps" checked style="cursor:pointer;">
      <span style="color:rgba(230,250,255,0.9);font-size:14px;">Show calculation steps</span>
    </label>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input type="checkbox" id="mat-show-visual" checked style="cursor:pointer;">
      <span style="color:rgba(230,250,255,0.9);font-size:14px;">Show visual matrix</span>
    </label>
    <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
      <input type="checkbox" id="mat-fraction-mode" style="cursor:pointer;">
      <span style="color:rgba(230,250,255,0.9);font-size:14px;">Show fractions instead of decimals</span>
    </label>
  </div>
</form>

<!-- RESULTS AREA -->
<div class="results" aria-live="polite" style="margin-top:16px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">üìä Matrix Results</h3>
    <div id="mat-status" style="color:rgba(230,250,255,0.7);font-size:13px;"></div>
  </div>

  <!-- VISUAL MATRIX DISPLAY -->
  <div id="mat-visual-container" style="display:none;margin-bottom:12px;padding:12px;background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
    <div style="color:rgba(230,250,255,0.9);font-size:14px;margin-bottom:6px;">Matrix visualization:</div>
    <div id="mat-visual-content" style="display:inline-block;font-family:monospace;"></div>
  </div>

  <!-- TEXT OUTPUT -->
  <textarea id="mat-output" rows="14" 
            style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(0,0,0,0.2);color:inherit;font-family:monospace;font-size:14px;line-height:1.4;"
            readonly></textarea>

  <!-- CALCULATION STEPS -->
  <div id="mat-steps-container" style="display:none;margin-top:16px;padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
    <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:15px;">üìù Calculation Steps:</h4>
    <div id="mat-steps-content" style="font-family:monospace;font-size:14px;line-height:1.6;color:rgba(230,250,255,0.9);"></div>
  </div>

  <!-- MATRIX PROPERTIES -->
  <div id="mat-props-container" style="display:none;margin-top:16px;padding:16px;background:rgba(0,0,0,0.15);border-radius:8px;border:1px solid rgba(45,212,255,0.1);">
    <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:15px;">‚ÑπÔ∏è Matrix Properties:</h4>
    <div id="mat-props-content" style="font-size:14px;line-height:1.5;color:rgba(230,250,255,0.9);"></div>
  </div>

  <!-- HINT AND STATUS -->
  <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
    <div id="mat-hint" class="small" style="color:#39ff14;font-size:13px;flex:1;"></div>
    <div id="mat-dimensions" style="color:rgba(230,250,255,0.7);font-size:13px;font-family:monospace;"></div>
  </div>
</div>

<script>
/* matrices.html
   - Advanced matrix operations calculator
   - Scoped with mat- prefix (matrices)
   - Supports up to 4x4 matrices with visual interface
*/

// MATRIX UTILITY FUNCTIONS
class MatrixCalculator {
  // Parse matrix from string (rows;columns format)
  static parseMatrix(str) {
    if (!str.trim()) return null;
    const rows = str.split(';').filter(row => row.trim());
    return rows.map(row => 
      row.split(',').map(cell => {
        const val = parseFloat(cell.trim());
        return isNaN(val) ? 0 : val;
      })
    );
  }

  // Format matrix as string
  static formatMatrix(matrix, fractionMode = false) {
    if (!matrix) return '';
    return matrix.map(row => 
      row.map(val => {
        if (fractionMode && !Number.isInteger(val)) {
          const fraction = this.toFraction(val);
          return fraction.includes('/') ? fraction : val;
        }
        return Number.isInteger(val) ? val : parseFloat(val.toFixed(4));
      }).join(', ')
    ).join(';\n');
  }

  // Convert decimal to simple fraction
  static toFraction(decimal) {
    if (Number.isInteger(decimal)) return decimal.toString();
    
    const tolerance = 1.0E-4;
    let numerator = 1, denominator = 1;
    
    for (let d = 1; d <= 100; d++) {
      const n = Math.round(decimal * d);
      if (Math.abs(decimal - n / d) < tolerance) {
        numerator = n;
        denominator = d;
        break;
      }
    }
    
    const gcd = this.gcd(Math.abs(numerator), denominator);
    numerator /= gcd;
    denominator /= gcd;
    
    if (denominator === 1) return numerator.toString();
    return `${numerator}/${denominator}`;
  }

  // Greatest common divisor
  static gcd(a, b) {
    return b ? this.gcd(b, a % b) : a;
  }

  // Matrix operations
  static add(A, B) {
    if (A.length !== B.length || A[0].length !== B[0].length) {
      throw new Error('Matrices must have same dimensions for addition');
    }
    return A.map((row, i) => row.map((val, j) => val + B[i][j]));
  }

  static subtract(A, B) {
    if (A.length !== B.length || A[0].length !== B[0].length) {
      throw new Error('Matrices must have same dimensions for subtraction');
    }
    return A.map((row, i) => row.map((val, j) => val - B[i][j]));
  }

  static multiply(A, B) {
    if (A[0].length !== B.length) {
      throw new Error('Number of columns in A must equal number of rows in B');
    }
    return A.map((row, i) =>
      B[0].map((_, j) =>
        row.reduce((sum, val, k) => sum + val * B[k][j], 0)
      )
    );
  }

  static scalarMultiply(matrix, scalar) {
    return matrix.map(row => row.map(val => val * scalar));
  }

  static transpose(matrix) {
    return matrix[0].map((_, j) => matrix.map(row => row[j]));
  }

  static determinant(matrix) {
    const size = matrix.length;
    if (size === 1) return matrix[0][0];
    if (size === 2) {
      return matrix[0][0] * matrix[1][1] - matrix[0][1] * matrix[1][0];
    }
    if (size === 3) {
      const [[a, b, c], [d, e, f], [g, h, i]] = matrix;
      return a*e*i + b*f*g + c*d*h - c*e*g - b*d*i - a*f*h;
    }
    throw new Error('Determinant only supported for 1x1, 2x2, and 3x3 matrices');
  }

  static inverse(matrix) {
    const det = this.determinant(matrix);
    if (Math.abs(det) < 1e-10) throw new Error('Matrix is singular (determinant = 0)');
    
    const size = matrix.length;
    if (size === 2) {
      const [[a, b], [c, d]] = matrix;
      return [
        [d/det, -b/det],
        [-c/det, a/det]
      ];
    }
    if (size === 3) {
      const [[a, b, c], [d, e, f], [g, h, i]] = matrix;
      const invDet = 1 / det;
      return [
        [
          (e*i - f*h) * invDet,
          (c*h - b*i) * invDet,
          (b*f - c*e) * invDet
        ],
        [
          (f*g - d*i) * invDet,
          (a*i - c*g) * invDet,
          (c*d - a*f) * invDet
        ],
        [
          (d*h - e*g) * invDet,
          (b*g - a*h) * invDet,
          (a*e - b*d) * invDet
        ]
      ];
    }
    throw new Error('Inverse only supported for 2x2 and 3x3 matrices');
  }

  static trace(matrix) {
    if (matrix.length !== matrix[0].length) {
      throw new Error('Matrix must be square for trace calculation');
    }
    return matrix.reduce((sum, row, i) => sum + row[i], 0);
  }

  static createIdentity(size) {
    return Array.from({length: size}, (_, i) =>
      Array.from({length: size}, (_, j) => i === j ? 1 : 0)
    );
  }

  static createZero(rows, cols) {
    return Array.from({length: rows}, () => Array(cols).fill(0));
  }

  // Visual representation of matrix
  static visualizeMatrix(matrix, label = '') {
    const maxLen = Math.max(...matrix.flat().map(v => v.toString().length));
    const rows = matrix.map(row =>
      '‚îÇ ' + row.map(v => v.toString().padStart(maxLen)).join('  ') + ' ‚îÇ'
    );
    
    const width = rows[0].length;
    const top = '‚îå' + '‚îÄ'.repeat(width - 2) + '‚îê';
    const bottom = '‚îî' + '‚îÄ'.repeat(width - 2) + '‚îò';
    
    return (label ? label + ' = \n' : '') + [top, ...rows, bottom].join('\n');
  }

  // Get matrix properties
  static getProperties(matrix) {
    const rows = matrix.length;
    const cols = matrix[0].length;
    const isSquare = rows === cols;
    const isSymmetric = isSquare && matrix.every((row, i) =>
      row.every((val, j) => Math.abs(val - matrix[j][i]) < 1e-10)
    );
    
    let properties = [];
    properties.push(`Dimensions: ${rows} √ó ${cols}`);
    properties.push(`Square matrix: ${isSquare ? 'Yes' : 'No'}`);
    if (isSquare) {
      properties.push(`Symmetric: ${isSymmetric ? 'Yes' : 'No'}`);
      try {
        const det = this.determinant(matrix);
        properties.push(`Determinant: ${det}`);
        properties.push(`Invertible: ${Math.abs(det) > 1e-10 ? 'Yes' : 'No'}`);
      } catch (e) {}
    }
    
    return properties;
  }
}

// UI MANAGEMENT FUNCTIONS
function matInitializeMatrixInputs() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Generate initial matrix inputs (3x3)
  matUpdateMatrixSize('a', '3x3');
  matUpdateMatrixSize('b', '3x3');
  
  // Add event listeners for size changes
  card.querySelector('#mat-a-size').addEventListener('change', (e) => {
    matUpdateMatrixSize('a', e.target.value);
  });
  
  card.querySelector('#mat-b-size').addEventListener('change', (e) => {
    matUpdateMatrixSize('b', e.target.value);
  });
  
  // Update hidden inputs when cells change
  ['a', 'b'].forEach(matrix => {
    const container = card.querySelector(`#mat-${matrix}-container`);
    container.addEventListener('input', () => {
      matUpdateHiddenInput(matrix);
    });
  });
  
  // Toggle Matrix B
  card.querySelector('#mat-b-enabled').addEventListener('change', (e) => {
    const container = card.querySelector('#mat-b-container');
    container.style.opacity = e.target.checked ? '1' : '0.5';
    container.querySelectorAll('input').forEach(input => {
      input.disabled = !e.target.checked;
    });
  });
}

function matUpdateMatrixSize(matrixId, size) {
  const [rows, cols] = size.split('x').map(Number);
  const container = document.getElementById(`mat-${matrixId}-container`);
  
  // Update grid layout
  container.style.gridTemplateColumns = `repeat(${cols}, 1fr)`;
  
  // Generate cells
  container.innerHTML = '';
  for (let i = 0; i < rows; i++) {
    for (let j = 0; j < cols; j++) {
      const input = document.createElement('input');
      input.type = 'number';
      input.step = 'any';
      input.placeholder = `${i+1},${j+1}`;
      input.style.cssText = `
        width: 100%;
        padding: 8px;
        border-radius: 4px;
        border: 1px solid ${matrixId === 'a' ? 'rgba(45,212,255,0.3)' : 'rgba(255,165,0,0.3)'};
        background: ${matrixId === 'a' ? 'rgba(45,212,255,0.05)' : 'rgba(255,165,0,0.05)'};
        color: inherit;
        text-align: center;
        font-size: 14px;
      `;
      container.appendChild(input);
    }
  }
  
  // Update hidden input
  matUpdateHiddenInput(matrixId);
}

function matUpdateHiddenInput(matrixId) {
  const container = document.getElementById(`mat-${matrixId}-container`);
  const inputs = container.querySelectorAll('input');
  const rows = Math.sqrt(inputs.length); // Simplified - would need proper calculation
  const cols = rows; // Simplified
  
  const values = [];
  for (let i = 0; i < rows; i++) {
    const row = [];
    for (let j = 0; j < cols; j++) {
      const index = i * cols + j;
      row.push(inputs[index]?.value || '0');
    }
    values.push(row.join(','));
  }
  
  document.getElementById(`mat-${matrixId}`).value = values.join(';');
}

function matGetMatrix(matrixId) {
  const input = document.getElementById(`mat-${matrixId}`).value;
  return MatrixCalculator.parseMatrix(input);
}

// MAIN CALCULATION FUNCTION
function matCalculate(btn) {
  const card = btn.closest('.card') || document;
  const operation = card.querySelector('#mat-operation').value;
  const showSteps = card.querySelector('#mat-show-steps').checked;
  const showVisual = card.querySelector('#mat-show-visual').checked;
  const fractionMode = card.querySelector('#mat-fraction-mode').checked;
  const useMatrixB = card.querySelector('#mat-b-enabled').checked;
  
  // Get matrices
  const A = matGetMatrix('a');
  if (!A) {
    matShowError('Please enter Matrix A');
    return;
  }
  
  let B = null;
  if (useMatrixB && ['add', 'subtract', 'multiply'].includes(operation)) {
    B = matGetMatrix('b');
    if (!B) {
      matShowError('Matrix B required for this operation');
      return;
    }
  }
  
  let result, steps = [], properties = [];
  
  try {
    switch(operation) {
      case 'add':
        if (!B) throw new Error('Matrix B required');
        result = MatrixCalculator.add(A, B);
        steps.push(`Add corresponding entries: A[i][j] + B[i][j]`);
        break;
        
      case 'subtract':
        if (!B) throw new Error('Matrix B required');
        result = MatrixCalculator.subtract(A, B);
        steps.push(`Subtract corresponding entries: A[i][j] - B[i][j]`);
        break;
        
      case 'multiply':
        if (!B) throw new Error('Matrix B required');
        result = MatrixCalculator.multiply(A, B);
        steps.push(`Multiply rows of A by columns of B`);
        steps.push(`C[i][j] = Œ£(A[i][k] √ó B[k][j]) for k = 1 to ${A[0].length}`);
        break;
        
      case 'scalar':
        const scalar = parseFloat(card.querySelector('#mat-scalar').value) || 1;
        result = MatrixCalculator.scalarMultiply(A, scalar);
        steps.push(`Multiply each entry by ${scalar}: ${scalar} √ó A[i][j]`);
        break;
        
      case 'det':
        result = MatrixCalculator.determinant(A);
        if (A.length === 2) {
          steps.push(`For 2√ó2 matrix: det = ad - bc`);
          steps.push(`det = (${A[0][0]} √ó ${A[1][1]}) - (${A[0][1]} √ó ${A[1][0]})`);
          steps.push(`det = ${A[0][0] * A[1][1]} - ${A[0][1] * A[1][0]}`);
        } else if (A.length === 3) {
          steps.push(`For 3√ó3 matrix: det = a(ei - fh) - b(di - fg) + c(dh - eg)`);
        }
        steps.push(`Result: ${result}`);
        break;
        
      case 'transpose':
        result = MatrixCalculator.transpose(A);
        steps.push(`Swap rows and columns: A·µÄ[i][j] = A[j][i]`);
        break;
        
      case 'inverse':
        result = MatrixCalculator.inverse(A);
        steps.push(`Calculate inverse using formula`);
        steps.push(`For ${A.length}√ó${A.length} matrix: A‚Åª¬π = (1/det(A)) √ó adj(A)`);
        break;
        
      case 'trace':
        result = MatrixCalculator.trace(A);
        steps.push(`Sum of diagonal elements: tr(A) = Œ£ A[i][i]`);
        steps.push(`tr(A) = ${A.map((row, i) => row[i]).join(' + ')}`);
        break;
        
      case 'identity':
        const size = A.length;
        result = MatrixCalculator.createIdentity(size);
        steps.push(`Created ${size}√ó${size} identity matrix`);
        break;
        
      case 'zero':
        const rows = A.length;
        const cols = A[0].length;
        result = MatrixCalculator.createZero(rows, cols);
        steps.push(`Created ${rows}√ó${cols} zero matrix`);
        break;
    }
    
    // Get matrix properties
    properties = MatrixCalculator.getProperties(A);
    if (B && ['add', 'subtract', 'multiply'].includes(operation)) {
      properties.push('\nMatrix B properties:');
      properties.push(...MatrixCalculator.getProperties(B));
    }
    
    // Format output
    let output = `Operation: ${operation.toUpperCase()}\n`;
    output += `Matrix A (${A.length}√ó${A[0].length}):\n`;
    output += MatrixCalculator.formatMatrix(A, fractionMode) + '\n\n';
    
    if (B && ['add', 'subtract', 'multiply'].includes(operation)) {
      output += `Matrix B (${B.length}√ó${B[0].length}):\n`;
      output += MatrixCalculator.formatMatrix(B, fractionMode) + '\n\n';
    }
    
    if (operation === 'scalar') {
      const scalar = parseFloat(card.querySelector('#mat-scalar').value) || 1;
      output += `Scalar: ${scalar}\n\n`;
    }
    
    output += `Result:\n`;
    if (typeof result === 'number') {
      output += result;
    } else {
      output += MatrixCalculator.formatMatrix(result, fractionMode);
    }
    
    // Update output
    card.querySelector('#mat-output').value = output;
    
    // Update visual display
    const visualContainer = card.querySelector('#mat-visual-container');
    if (showVisual && Array.isArray(result)) {
      const visualContent = card.querySelector('#mat-visual-content');
      visualContent.innerHTML = MatrixCalculator.visualizeMatrix(result, 'Result');
      visualContainer.style.display = 'block';
    } else {
      visualContainer.style.display = 'none';
    }
    
    // Update steps
    const stepsContainer = card.querySelector('#mat-steps-container');
    const stepsContent = card.querySelector('#mat-steps-content');
    if (showSteps && steps.length > 0) {
      stepsContent.innerHTML = steps.map(step => 
        `<div style="margin-bottom:8px;padding-left:12px;border-left:2px solid rgba(45,212,255,0.5);">${step}</div>`
      ).join('');
      stepsContainer.style.display = 'block';
    } else {
      stepsContainer.style.display = 'none';
    }
    
    // Update properties
    const propsContainer = card.querySelector('#mat-props-container');
    const propsContent = card.querySelector('#mat-props-content');
    propsContent.innerHTML = properties.map(prop => 
      `<div style="margin-bottom:4px;">‚Ä¢ ${prop}</div>`
    ).join('');
    propsContainer.style.display = 'block';
    
    // Update status
    card.querySelector('#mat-status').textContent = '‚úì Success';
    card.querySelector('#mat-status').style.color = '#39ff14';
    card.querySelector('#mat-hint').textContent = 'Calculation completed successfully.';
    card.querySelector('#mat-hint').style.color = '#39ff14';
    card.querySelector('#mat-dimensions').textContent = 
      `A: ${A.length}√ó${A[0].length}` + 
      (B ? `, B: ${B.length}√ó${B[0].length}` : '');
    
  } catch (error) {
    matShowError(error.message);
  }
}

function matShowError(message) {
  const card = document.currentScript?.closest('.card') || document;
  card.querySelector('#mat-output').value = `Error: ${message}`;
  card.querySelector('#mat-status').textContent = '‚úó Error';
  card.querySelector('#mat-status').style.color = '#ff4d4d';
  card.querySelector('#mat-hint').textContent = message;
  card.querySelector('#mat-hint').style.color = '#ff4d4d';
  card.querySelector('#mat-visual-container').style.display = 'none';
  card.querySelector('#mat-steps-container').style.display = 'none';
  card.querySelector('#mat-props-container').style.display = 'none';
}

// QUICK MATRICES
function matQuick(type) {
  const card = document.currentScript?.closest('.card') || document;
  const aContainer = card.querySelector('#mat-a-container');
  const bContainer = card.querySelector('#mat-b-container');
  
  const matrices = {
    'identity': [[1, 0, 0], [0, 1, 0], [0, 0, 1]],
    'zero': [[0, 0, 0], [0, 0, 0], [0, 0, 0]],
    'rotation': [[0, -1, 0], [1, 0, 0], [0, 0, 1]],
    'example1': [[1, 2, 3], [4, 5, 6], [7, 8, 9]],
    'example2': [[9, 8, 7], [6, 5, 4], [3, 2, 1]]
  };
  
  const matrix = matrices[type] || matrices.example1;
  
  // Fill Matrix A
  const aInputs = aContainer.querySelectorAll('input');
  aInputs.forEach((input, index) => {
    const row = Math.floor(index / 3);
    const col = index % 3;
    input.value = matrix[row]?.[col] || 0;
  });
  
  // Update hidden input
  matUpdateHiddenInput('a');
  
  // Update hint
  card.querySelector('#mat-hint').textContent = `Loaded ${type} matrix`;
  card.querySelector('#mat-hint').style.color = 'var(--accent)';
  
  // Auto-calculate if B is also filled
  setTimeout(() => {
    const bEnabled = card.querySelector('#mat-b-enabled').checked;
    const bInput = card.querySelector('#mat-b').value;
    if (bEnabled && bInput.trim()) {
      matCalculate(card.querySelector('[onclick="matCalculate(this)"]'));
    }
  }, 300);
}

function matReset(btn) {
  const card = btn.closest('.card') || document;
  
  // Reset all inputs
  card.querySelectorAll('#mat-a-container input, #mat-b-container input').forEach(input => {
    input.value = '';
  });
  
  // Reset hidden inputs
  card.querySelector('#mat-a').value = '';
  card.querySelector('#mat-b').value = '';
  
  // Reset other elements
  card.querySelector('#mat-output').value = '';
  card.querySelector('#mat-hint').textContent = '';
  card.querySelector('#mat-status').textContent = '';
  card.querySelector('#mat-dimensions').textContent = '';
  card.querySelector('#mat-visual-container').style.display = 'none';
  card.querySelector('#mat-steps-container').style.display = 'none';
  card.querySelector('#mat-props-container').style.display = 'none';
  card.querySelector('#mat-operation').selectedIndex = 0;
  card.querySelector('#mat-scalar').value = '2';
  card.querySelector('#mat-show-steps').checked = true;
  card.querySelector('#mat-show-visual').checked = true;
  card.querySelector('#mat-fraction-mode').checked = false;
  card.querySelector('#mat-b-enabled').checked = true;
  
  // Reset matrix sizes
  matUpdateMatrixSize('a', '3x3');
  matUpdateMatrixSize('b', '3x3');
}

function matCopy(btn) {
  const card = btn.closest('.card') || document;
  const output = card.querySelector('#mat-output').value;
  
  if (!output.trim()) {
    card.querySelector('#mat-hint').textContent = 'Nothing to copy.';
    card.querySelector('#mat-hint').style.color = '#ff4d4d';
    return;
  }
  
  navigator.clipboard.writeText(output).then(() => {
    const hint = card.querySelector('#mat-hint');
    hint.textContent = '‚úÖ Result copied to clipboard!';
    hint.style.color = '#39ff14';
    setTimeout(() => {
      if (hint.textContent === '‚úÖ Result copied to clipboard!') {
        hint.textContent = '';
      }
    }, 2000);
  }).catch(() => {
    // Fallback
    const textArea = document.createElement('textarea');
    textArea.value = output;
    document.body.appendChild(textArea);
    textArea.select();
    try {
      document.execCommand('copy');
      const hint = card.querySelector('#mat-hint');
      hint.textContent = '‚úÖ Copied!';
      setTimeout(() => { hint.textContent = ''; }, 2000);
    } catch (err) {
      alert('Copy failed. Please select and copy manually.');
    }
    document.body.removeChild(textArea);
  });
}

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    matInitializeMatrixInputs();
    console.log('Matrices Calculator initialized');
  });
}
</script>

<!-- CARD-SPECIFIC STYLES -->
<style>
#matrices-title {
  color: var(--accent);
  margin-top: 0;
}

/* Matrix cell styling */
#mat-a-container input:focus,
#mat-b-container input:focus {
  outline: none;
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px rgba(45,212,255,0.2);
}

/* Visual matrix display */
#mat-visual-content {
  font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
  line-height: 1.8;
  white-space: pre;
  background: rgba(0,0,0,0.3);
  padding: 12px;
  border-radius: 6px;
  overflow-x: auto;
}

/* Mobile adjustments */
@media (max-width: 768px) {
  .row {
    grid-template-columns: 1fr !important;
  }
  
  #mat-a-container,
  #mat-b-container {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  .actions {
    flex-direction: column !important;
  }
  
  .actions button {
    width: 100% !important;
    margin: 4px 0 !important;
  }
  
  #mat-visual-content {
    font-size: 11px !important;
    overflow-x: auto !important;
  }
}

/* Dark mode enhancements */
@media (prefers-color-scheme: dark) {
  #mat-output {
    background: rgba(0, 0, 0, 0.3) !important;
  }
  
  #mat-visual-container,
  #mat-steps-container,
  #mat-props-container {
    background: rgba(0, 0, 0, 0.25) !important;
  }
}

/* Print styles for matrices */
@media print {
  #mat-visual-content {
    background: white !important;
    color: black !important;
    border: 1px solid #000 !important;
  }
  
  #mat-a-container input,
  #mat-b-container input {
    background: white !important;
    color: black !important;
    border: 1px solid #000 !important;
  }
}

/* Matrix border animation */
@keyframes matrixGlow {
  0% { box-shadow: 0 0 5px rgba(45,212,255,0.3); }
  50% { box-shadow: 0 0 15px rgba(45,212,255,0.5); }
  100% { box-shadow: 0 0 5px rgba(45,212,255,0.3); }
}

#mat-a-container,
#mat-b-container {
  animation: matrixGlow 3s ease-in-out infinite;
}
</style>
