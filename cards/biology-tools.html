<!-- cards/biology-tools.html -->
<h2 id="biology-tools-title">Biology Tools</h2>

<div class="description">
  Calculate and explore basic biology values. Choose a tool, enter values, and get results with formulas.
  <span class="disclaimer">Educational tool for understanding biological calculations.</span>
</div>

<div class="tool-body">
  <!-- TOOL SELECTION -->
  <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; margin-bottom: 25px;">
    <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 15px;">
      <span style="color: #2dd4ff;">üî¨</span> Select Biology Calculator
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
      <div>
        <label for="bt-tool" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #2dd4ff;">Tool</span>
        </label>
        <select id="bt-tool" 
                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(45,212,255,0.3); background: rgba(45,212,255,0.05); color: #e6faff; cursor: pointer;">
          <option value="bmi" selected>BMI (Body Mass Index)</option>
          <option value="heart-rate">Target Heart Rate</option>
          <option value="population-growth">Population Growth</option>
          <option value="dilution">Dilution (C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ)</option>
          <option value="cell-count">Cell Count & Dilution</option>
          <option value="punnett-square">Punnett Square</option>
        </select>
        <div id="bt-tool-desc" style="margin-top: 6px; color: rgba(45,212,255,0.7); font-size: 13px;">
          Calculates body mass index from weight and height
        </div>
      </div>

      <div>
        <label for="bt-values" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #39ff14;">Input Values</span>
          <span id="bt-value-format" style="color: rgba(57,255,20,0.7); font-size: 12px; margin-left: 8px;">(weight=70,height=1.75)</span>
        </label>
        <input id="bt-values" type="text" placeholder="weight=70,height=1.75"
               style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(57,255,20,0.3); background: rgba(57,255,20,0.05); color: #e6faff;">
        <div id="bt-value-hint" style="margin-top: 6px; color: rgba(57,255,20,0.7); font-size: 13px;">
          Separate values with commas. Example: weight=70,height=1.75
        </div>
      </div>
    </div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
      <div>
        <label for="bt-show-steps" style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #9d4edd;">Show Steps</span>
        </label>
        <select id="bt-show-steps" 
                style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid rgba(157,78,221,0.3); background: rgba(157,78,221,0.05); color: #e6faff; cursor: pointer;">
          <option value="yes" selected>Yes - Show detailed steps</option>
          <option value="no">No - Show result only</option>
        </select>
      </div>
      
      <div>
        <div style="display: block; margin-bottom: 6px; color: rgba(230,250,255,0.8); font-size: 14px;">
          <span style="color: #ffa500;">Quick Guide</span>
        </div>
        <div id="bt-quick-guide" style="background: rgba(255,165,0,0.05); padding: 10px; border-radius: 8px; border: 1px solid rgba(255,165,0,0.2); color: rgba(255,165,0,0.8); font-size: 13px; height: 42px; overflow-y: auto;">
          For BMI: Enter weight in kg, height in meters (e.g., weight=70,height=1.75)
        </div>
      </div>
    </div>
  </div>
  
  <!-- QUICK EXAMPLES -->
  <div style="margin-bottom: 25px;">
    <div style="color: rgba(230,250,255,0.8); margin-bottom: 10px; font-size: 14px;">Quick Examples:</div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
      <button class="bt-example-btn" data-values="weight=70,height=1.75" data-tool="bmi"
              style="padding: 8px 12px; background: rgba(45,212,255,0.1); border: 1px solid rgba(45,212,255,0.3); border-radius: 6px; cursor: pointer; color: #2dd4ff; font-size: 13px;">
        üìè BMI Example
      </button>
      <button class="bt-example-btn" data-values="age=30,intensity=70" data-tool="heart-rate"
              style="padding: 8px 12px; background: rgba(255,77,77,0.1); border: 1px solid rgba(255,77,77,0.3); border-radius: 6px; cursor: pointer; color: #ff4d4d; font-size: 13px;">
        ‚ù§Ô∏è Heart Rate Example
      </button>
      <button class="bt-example-btn" data-values="initial=1000,rate=0.05,time=10" data-tool="population-growth"
              style="padding: 8px 12px; background: rgba(57,255,20,0.1); border: 1px solid rgba(57,255,20,0.3); border-radius: 6px; cursor: pointer; color: #39ff14; font-size: 13px;">
        üìà Population Growth
      </button>
      <button class="bt-example-btn" data-values="c1=100,v1=10,c2=20" data-tool="dilution"
              style="padding: 8px 12px; background: rgba(157,78,221,0.1); border: 1px solid rgba(157,78,221,0.3); border-radius: 6px; cursor: pointer; color: #9d4edd; font-size: 13px;">
        üß™ Dilution Example
      </button>
    </div>
  </div>
  
  <!-- üöÄ CALCULATE BUTTONS -->
  <div style="text-align: center; margin: 25px 0;">
    <button id="bt-calculate-btn" 
            style="background: #2dd4ff; color: #000; border: none; padding: 14px 32px; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; box-shadow: 0 4px 15px rgba(45,212,255,0.3);">
      üß¨ CALCULATE
    </button>
    
    <button id="bt-reset-btn" 
            style="background: rgba(255,255,255,0.08); color: #e6faff; border: 1px solid rgba(255,255,255,0.2); padding: 14px 24px; border-radius: 10px; cursor: pointer; font-size: 16px; margin-left: 12px;">
      Reset
    </button>
  </div>
  
  <!-- üìä RESULTS DISPLAY -->
  <div id="bt-results" style="display: none;">
    <div style="background: rgba(20,20,20,0.7); border-radius: 10px; padding: 25px; border: 1px solid rgba(57,255,20,0.2); margin-bottom: 25px;">
      <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px;">
        <div style="color: #39ff14; font-size: 18px; font-weight: 600;">üß™ Calculation Results</div>
        <button id="bt-copy-btn" 
                style="background: rgba(57,255,20,0.1); color: #39ff14; border: 1px solid rgba(57,255,20,0.3); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px;">
          Copy Results
        </button>
      </div>
      
      <div id="bt-result-display" style="font-size: 20px; color: #39ff14; text-align: center; margin-bottom: 20px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px;">
        <!-- Results appear here -->
      </div>
      
      <div id="bt-formula-section" style="background: rgba(45,212,255,0.1); padding: 15px; border-radius: 8px; border-left: 3px solid #2dd4ff; margin-bottom: 15px;">
        <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 8px;">Formula:</div>
        <div id="bt-formula-display" style="font-family: monospace; color: #e6faff; font-size: 15px;">
          BMI = weight(kg) / height(m)¬≤
        </div>
      </div>
      
      <div id="bt-steps-section" style="background: rgba(30,30,30,0.5); padding: 15px; border-radius: 8px; border: 1px solid rgba(255,165,0,0.2);">
        <div style="color: #ffa500; font-weight: 600; margin-bottom: 10px;">Calculation Steps:</div>
        <div id="bt-steps-list" style="color: #e6faff; font-size: 14px; line-height: 1.6;">
          <!-- Steps will be inserted here -->
        </div>
      </div>
    </div>
  </div>
  
  <!-- üìö BIOLOGY FACTS -->
  <div id="bt-facts" style="margin-top: 20px; display: block;">
    <div style="background: rgba(30,30,30,0.5); border-radius: 10px; padding: 20px; border: 1px solid rgba(45,212,255,0.2);">
      <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 15px; font-size: 16px;">
        üìö Biology Facts & Formulas
      </div>
      
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
        <div style="background: rgba(45,212,255,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #2dd4ff;">
          <div style="color: #2dd4ff; font-weight: 600; margin-bottom: 5px;">BMI Formula</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">BMI = weight(kg) √∑ height(m)¬≤<br>Categories: Underweight (<18.5), Normal (18.5-25), Overweight (25-30), Obese (>30)</div>
        </div>
        
        <div style="background: rgba(255,77,77,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #ff4d4d;">
          <div style="color: #ff4d4d; font-weight: 600; margin-bottom: 5px;">Heart Rate Zones</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Max HR = 220 - age<br>Target zone = Max HR √ó intensity%<br>Light: 50-60%, Moderate: 60-70%, Hard: 70-85%</div>
        </div>
        
        <div style="background: rgba(57,255,20,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #39ff14;">
          <div style="color: #39ff14; font-weight: 600; margin-bottom: 5px;">Population Growth</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">Exponential: P = P‚ÇÄ √ó (1 + r)^t<br>Logistic: P = K √∑ (1 + (K-P‚ÇÄ)/P‚ÇÄ √ó e^(-rt))<br>r = growth rate, K = carrying capacity</div>
        </div>
        
        <div style="background: rgba(157,78,221,0.05); padding: 12px; border-radius: 8px; border-left: 3px solid #9d4edd;">
          <div style="color: #9d4edd; font-weight: 600; margin-bottom: 5px;">Dilution Formula</div>
          <div style="color: rgba(230,250,255,0.8); font-size: 14px;">C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ<br>Where C = concentration, V = volume<br>Used in labs for preparing solutions</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- üö® ERROR MESSAGE -->
  <div id="bt-error" style="margin-top: 20px; padding: 15px; background: rgba(255,77,77,0.1); border-radius: 8px; border: 1px solid rgba(255,77,77,0.3); display: none;">
    <div style="color: #ff4d4d; font-weight: 600; margin-bottom: 5px;">‚ö†Ô∏è Please check your inputs</div>
    <div id="bt-error-text" style="color: rgba(255,77,77,0.9);"></div>
  </div>
</div>

<style>
#biology-tools-title { 
  color: #2dd4ff; 
  margin-top: 0;
  margin-bottom: 10px;
}

.description {
  color: rgba(230,250,255,0.8);
  margin-bottom: 20px;
  font-size: 14px;
}

.disclaimer {
  display: block;
  color: rgba(255,165,0,0.8);
  font-size: 12px;
  margin-top: 5px;
  font-style: italic;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .tool-body > div > div {
    grid-template-columns: 1fr !important;
  }
  
  .bt-example-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
  
  #bt-calculate-btn, #bt-reset-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
}

/* Step list styling */
#bt-steps-list div {
  margin-bottom: 8px;
  padding-left: 10px;
  border-left: 2px solid #2dd4ff;
}
</style>

<script>
// ============================================
// BIOLOGY TOOLS CALCULATOR - PROPERLY SCOPED
// All functions prefixed with "bt" (biology tools)
// ============================================

// Tool information database
const btToolInfo = {
  'bmi': {
    desc: 'Calculates Body Mass Index (BMI) - a measure of body fat based on height and weight.',
    format: 'weight=70,height=1.75',
    hint: 'Enter weight in kg and height in meters',
    guide: 'For BMI: Enter weight in kg, height in meters. Example: weight=70,height=1.75'
  },
  'heart-rate': {
    desc: 'Calculates target heart rate zones for exercise based on age and intensity.',
    format: 'age=30,intensity=70',
    hint: 'Enter age in years and intensity as percentage',
    guide: 'For Heart Rate: Enter age and intensity %. Example: age=30,intensity=70'
  },
  'population-growth': {
    desc: 'Calculates population growth using exponential growth models.',
    format: 'initial=1000,rate=0.05,time=10',
    hint: 'Enter initial population, growth rate (decimal), and time period',
    guide: 'For Population: Enter initial pop, growth rate (0.05=5%), and time. Example: initial=1000,rate=0.05,time=10'
  },
  'dilution': {
    desc: 'Solves dilution problems using the formula C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ.',
    format: 'c1=100,v1=10,c2=20',
    hint: 'Enter concentrations and volumes to find unknown',
    guide: 'For Dilution: Enter any three of c1,v1,c2,v2 to find the fourth. Example: c1=100,v1=10,c2=20'
  },
  'cell-count': {
    desc: 'Calculates original cell concentration from diluted counts.',
    format: 'cells=50,dilution=100,volume=0.1',
    hint: 'Enter cells counted, dilution factor, and volume counted (ml)',
    guide: 'For Cell Count: Enter cells counted, dilution factor, volume. Example: cells=50,dilution=100,volume=0.1'
  },
  'punnett-square': {
    desc: 'Calculates genotype and phenotype probabilities for genetic crosses.',
    format: 'parent1=AA,parent2=aa',
    hint: 'Enter genotypes for two parents (e.g., AA, Aa, aa)',
    guide: 'For Punnett Square: Enter genotypes for both parents. Example: parent1=AA,parent2=aa'
  }
};

// Initialize the tool
function btInit() {
  console.log("Biology Tools: Initializing...");
  
  // Tool selector change
  document.getElementById('bt-tool').addEventListener('change', btUpdateToolInfo);
  
  // Example buttons
  const exampleBtns = document.querySelectorAll('.bt-example-btn');
  exampleBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      const values = this.dataset.values;
      const tool = this.dataset.tool;
      
      document.getElementById('bt-values').value = values;
      document.getElementById('bt-tool').value = tool;
      
      btUpdateToolInfo();
      
      // Visual feedback
      exampleBtns.forEach(b => {
        b.style.background = '';
        b.style.border = '1px solid rgba(255,255,255,0.1)';
      });
      this.style.background = 'rgba(45,212,255,0.2)';
      this.style.border = '1px solid #2dd4ff';
    });
  });
  
  // Calculate button
  document.getElementById('bt-calculate-btn').addEventListener('click', btCalculate);
  
  // Reset button
  document.getElementById('bt-reset-btn').addEventListener('click', btReset);
  
  // Copy button
  document.getElementById('bt-copy-btn').addEventListener('click', btCopyResult);
  
  // Input validation
  document.getElementById('bt-values').addEventListener('input', btValidateInput);
  
  // Enter key support
  document.getElementById('bt-values').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      btCalculate();
    }
  });
  
  // Initial setup
  btUpdateToolInfo();
  
  console.log("‚úÖ Biology Tools ready!");
}

// Update tool information
function btUpdateToolInfo() {
  const tool = document.getElementById('bt-tool').value;
  const info = btToolInfo[tool];
  
  document.getElementById('bt-tool-desc').textContent = info.desc;
  document.getElementById('bt-value-format').textContent = `(${info.format})`;
  document.getElementById('bt-value-hint').textContent = info.hint;
  document.getElementById('bt-quick-guide').textContent = info.guide;
  document.getElementById('bt-values').placeholder = info.format;
}

// Validate input format
function btValidateInput() {
  const input = document.getElementById('bt-values');
  const value = input.value.trim();
  
  // Reset styling
  input.style.borderColor = 'rgba(57,255,20,0.3)';
  document.getElementById('bt-value-hint').style.color = 'rgba(57,255,20,0.7)';
  
  if (value === '') return;
  
  const pairs = value.split(',');
  let isValid = true;
  
  for (let pair of pairs) {
    if (!pair.includes('=')) {
      isValid = false;
      break;
    }
  }
  
  if (!isValid) {
    input.style.borderColor = '#ff4d4d';
    document.getElementById('bt-value-hint').style.color = '#ff4d4d';
    document.getElementById('bt-value-hint').textContent = 'Invalid format. Use: key=value,key=value';
  } else {
    document.getElementById('bt-value-hint').textContent = btToolInfo[document.getElementById('bt-tool').value].hint;
  }
}

// Parse input values
function btParseInputValues(inputStr) {
  const pairs = inputStr.split(',');
  const values = {};
  
  pairs.forEach(pair => {
    const [key, value] = pair.split('=');
    if (key && value) {
      const trimmedKey = key.trim();
      const trimmedValue = value.trim();
      
      // Try to parse as number, but keep as string if it looks like a genotype
      if (trimmedKey.includes('parent') || isNaN(trimmedValue)) {
        values[trimmedKey] = trimmedValue;
      } else {
        values[trimmedKey] = parseFloat(trimmedValue);
      }
    }
  });
  
  return values;
}

// Main calculation function
function btCalculate() {
  console.log("Calculating biology value...");
  
  // Hide previous results/errors
  document.getElementById('bt-results').style.display = 'none';
  document.getElementById('bt-error').style.display = 'none';
  
  // Get inputs
  const inputStr = document.getElementById('bt-values').value.trim();
  const values = btParseInputValues(inputStr);
  const tool = document.getElementById('bt-tool').value;
  const showSteps = document.getElementById('bt-show-steps').value === 'yes';
  
  // Validate inputs
  if (!inputStr || Object.keys(values).length === 0) {
    btShowError('Please enter values in format: key=value,key=value');
    return;
  }
  
  // Perform calculation
  let result, interpretation, formula, steps;
  
  try {
    switch(tool) {
      case 'bmi':
        ({result, interpretation, formula, steps} = btCalculateBMI(values));
        break;
      case 'heart-rate':
        ({result, interpretation, formula, steps} = btCalculateHeartRate(values));
        break;
      case 'population-growth':
        ({result, interpretation, formula, steps} = btCalculatePopulationGrowth(values));
        break;
      case 'dilution':
        ({result, interpretation, formula, steps} = btCalculateDilution(values));
        break;
      case 'cell-count':
        ({result, interpretation, formula, steps} = btCalculateCellCount(values));
        break;
      case 'punnett-square':
        ({result, interpretation, formula, steps} = btCalculatePunnettSquare(values));
        break;
      default:
        btShowError('Invalid tool selected');
        return;
    }
    
    // Display results
    document.getElementById('bt-result-display').textContent = result;
    document.getElementById('bt-formula-display').textContent = formula;
    
    // Build steps
    const stepsList = document.getElementById('bt-steps-list');
    stepsList.innerHTML = '';
    
    if (showSteps && steps && steps.length > 0) {
      steps.forEach(step => {
        const stepElement = document.createElement('div');
        stepElement.textContent = step;
        stepsList.appendChild(stepElement);
      });
      document.getElementById('bt-steps-section').style.display = 'block';
    } else {
      document.getElementById('bt-steps-section').style.display = 'none';
    }
    
    document.getElementById('bt-results').style.display = 'block';
    
  } catch (error) {
    console.error('Calculation error:', error);
    btShowError('Unable to calculate. Please check your inputs.');
  }
}

// BMI calculation
function btCalculateBMI(values) {
  const weight = values.weight || 0;
  const height = values.height || 1;
  
  if (weight <= 0 || height <= 0) {
    throw new Error('Invalid weight or height values');
  }
  
  const bmi = weight / (height * height);
  
  let interpretation;
  if (bmi < 18.5) interpretation = 'Underweight';
  else if (bmi < 25) interpretation = 'Normal weight';
  else if (bmi < 30) interpretation = 'Overweight';
  else interpretation = 'Obese';
  
  const formula = `BMI = weight / height¬≤ = ${weight} / (${height})¬≤`;
  
  const steps = [
    `Weight: ${weight} kg`,
    `Height: ${height} m`,
    `Calculate height¬≤: ${height} √ó ${height} = ${(height*height).toFixed(2)} m¬≤`,
    `Apply formula: BMI = ${weight} / ${(height*height).toFixed(2)}`,
    `Result: ${bmi.toFixed(2)} (${interpretation})`
  ];
  
  const result = `BMI: ${bmi.toFixed(2)} (${interpretation})`;
  
  return {result, interpretation, formula, steps};
}

// Heart rate calculation
function btCalculateHeartRate(values) {
  const age = values.age || 30;
  const intensity = values.intensity || 70;
  
  if (age <= 0 || intensity < 0 || intensity > 100) {
    throw new Error('Invalid age or intensity values');
  }
  
  const maxHR = 220 - age;
  const targetHR = (intensity / 100) * maxHR;
  
  const interpretation = `Target zone: ${(targetHR * 0.9).toFixed(0)}-${(targetHR * 1.1).toFixed(0)} bpm`;
  const formula = `Target HR = (${intensity}% √∑ 100) √ó (220 - ${age})`;
  
  const steps = [
    `Maximum Heart Rate: 220 - ${age} = ${maxHR} bpm`,
    `Intensity: ${intensity}%`,
    `Target HR = ${intensity}% of ${maxHR}`,
    `Calculation: (${intensity}/100) √ó ${maxHR} = ${targetHR.toFixed(2)} bpm`,
    `Recommended range: ¬±10% = ${(targetHR * 0.9).toFixed(0)}-${(targetHR * 1.1).toFixed(0)} bpm`
  ];
  
  const result = `Target Heart Rate: ${targetHR.toFixed(0)} bpm`;
  
  return {result, interpretation, formula, steps};
}

// Population growth calculation
function btCalculatePopulationGrowth(values) {
  const initial = values.initial || 1000;
  const rate = values.rate || 0.05;
  const time = values.time || 10;
  
  if (initial < 0 || rate < 0 || time < 0) {
    throw new Error('Invalid population growth values');
  }
  
  const final = initial * Math.pow(1 + rate, time);
  const growth = final - initial;
  const growthPercent = ((final - initial) / initial * 100).toFixed(1);
  
  const interpretation = `Growth: ${growth.toFixed(0)} individuals (${growthPercent}%)`;
  const formula = `P = P‚ÇÄ √ó (1 + r)^t = ${initial} √ó (1 + ${rate})^{${time}}`;
  
  const steps = [
    `Initial population (P‚ÇÄ): ${initial}`,
    `Growth rate (r): ${rate} (${(rate*100).toFixed(1)}%)`,
    `Time period (t): ${time} years`,
    `Growth factor per year: 1 + ${rate} = ${(1+rate).toFixed(3)}`,
    `Apply exponential growth formula: P = ${initial} √ó ${(1+rate).toFixed(3)}^${time}`,
    `Final population: ${final.toFixed(0)}`,
    `Total growth: ${growth.toFixed(0)} individuals (${growthPercent}%)`
  ];
  
  const result = `Final Population: ${final.toFixed(0)} (${growthPercent}% growth)`;
  
  return {result, interpretation, formula, steps};
}

// Dilution calculation
function btCalculateDilution(values) {
  const c1 = values.c1;
  const v1 = values.v1;
  const c2 = values.c2;
  const v2 = values.v2;
  
  let result, formula, steps;
  
  // Count how many values we have
  const provided = [c1, v1, c2, v2].filter(v => v !== undefined).length;
  
  if (provided < 3) {
    throw new Error('Need at least three values for dilution calculation');
  }
  
  if (c1 !== undefined && v1 !== undefined && c2 !== undefined) {
    // Calculate v2
    const calculatedV2 = (c1 * v1) / c2;
    formula = `V‚ÇÇ = (C‚ÇÅ √ó V‚ÇÅ) √∑ C‚ÇÇ = (${c1} √ó ${v1}) √∑ ${c2}`;
    steps = [
      `Initial concentration (C‚ÇÅ): ${c1}`,
      `Initial volume (V‚ÇÅ): ${v1}`,
      `Final concentration (C‚ÇÇ): ${c2}`,
      `Apply formula: V‚ÇÇ = (${c1} √ó ${v1}) √∑ ${c2}`,
      `Final volume needed: ${calculatedV2.toFixed(2)}`
    ];
    result = `Final Volume (V‚ÇÇ): ${calculatedV2.toFixed(2)}`;
    
  } else if (v1 !== undefined && c2 !== undefined && v2 !== undefined) {
    // Calculate c1
    const calculatedC1 = (c2 * v2) / v1;
    formula = `C‚ÇÅ = (C‚ÇÇ √ó V‚ÇÇ) √∑ V‚ÇÅ = (${c2} √ó ${v2}) √∑ ${v1}`;
    steps = [
      `Initial volume (V‚ÇÅ): ${v1}`,
      `Final concentration (C‚ÇÇ): ${c2}`,
      `Final volume (V‚ÇÇ): ${v2}`,
      `Apply formula: C‚ÇÅ = (${c2} √ó ${v2}) √∑ ${v1}`,
      `Initial concentration: ${calculatedC1.toFixed(2)}`
    ];
    result = `Initial Concentration (C‚ÇÅ): ${calculatedC1.toFixed(2)}`;
    
  } else if (c1 !== undefined && c2 !== undefined && v2 !== undefined) {
    // Calculate v1
    const calculatedV1 = (c2 * v2) / c1;
    formula = `V‚ÇÅ = (C‚ÇÇ √ó V‚ÇÇ) √∑ C‚ÇÅ = (${c2} √ó ${v2}) √∑ ${c1}`;
    steps = [
      `Initial concentration (C‚ÇÅ): ${c1}`,
      `Final concentration (C‚ÇÇ): ${c2}`,
      `Final volume (V‚ÇÇ): ${v2}`,
      `Apply formula: V‚ÇÅ = (${c2} √ó ${v2}) √∑ ${c1}`,
      `Initial volume needed: ${calculatedV1.toFixed(2)}`
    ];
    result = `Initial Volume (V‚ÇÅ): ${calculatedV1.toFixed(2)}`;
    
  } else if (c1 !== undefined && v1 !== undefined && v2 !== undefined) {
    // Calculate c2
    const calculatedC2 = (c1 * v1) / v2;
    formula = `C‚ÇÇ = (C‚ÇÅ √ó V‚ÇÅ) √∑ V‚ÇÇ = (${c1} √ó ${v1}) √∑ ${v2}`;
    steps = [
      `Initial concentration (C‚ÇÅ): ${c1}`,
      `Initial volume (V‚ÇÅ): ${v1}`,
      `Final volume (V‚ÇÇ): ${v2}`,
      `Apply formula: C‚ÇÇ = (${c1} √ó ${v1}) √∑ ${v2}`,
      `Final concentration: ${calculatedC2.toFixed(2)}`
    ];
    result = `Final Concentration (C‚ÇÇ): ${calculatedC2.toFixed(2)}`;
  }
  
  const interpretation = `Based on dilution formula C‚ÇÅV‚ÇÅ = C‚ÇÇV‚ÇÇ`;
  
  return {result, interpretation, formula, steps};
}

// Cell count calculation
function btCalculateCellCount(values) {
  const cells = values.cells || 0;
  const dilution = values.dilution || 1;
  const volume = values.volume || 0.1;
  
  if (cells <= 0 || dilution <= 0 || volume <= 0) {
    throw new Error('Invalid cell count values');
  }
  
  const concentration = (cells * dilution) / volume;
  
  const interpretation = `Cells per milliliter`;
  const formula = `Concentration = (cells counted √ó dilution factor) √∑ volume counted`;
  
  const steps = [
    `Cells counted: ${cells}`,
    `Dilution factor: 1:${dilution}`,
    `Volume counted: ${volume} ml`,
    `Calculate: (${cells} √ó ${dilution}) √∑ ${volume}`,
    `Result: ${concentration.toFixed(0)} cells/ml`
  ];
  
  const result = `Cell Concentration: ${concentration.toFixed(0)} cells/ml`;
  
  return {result, interpretation, formula, steps};
}

// Punnett square calculation (simplified)
function btCalculatePunnettSquare(values) {
  const parent1 = (values.parent1 || 'AA').toUpperCase();
  const parent2 = (values.parent2 || 'aa').toUpperCase();
  
  // Simple genotype probability calculation
  // For simplicity, assuming single gene with two alleles
  const genotypes = [];
  
  // Generate possible gametes
  const gametes1 = parent1.split('');
  const gametes2 = parent2.split('');
  
  // Create Punnett square combinations
  for (let g1 of gametes1) {
    for (let g2 of gametes2) {
      // Sort alleles alphabetically for consistent genotype representation
      const genotype = [g1, g2].sort().join('');
      genotypes.push(genotype);
    }
  }
  
  // Calculate genotype frequencies
  const genotypeCounts = {};
  genotypes.forEach(g => {
    genotypeCounts[g] = (genotypeCounts[g] || 0) + 1;
  });
  
  // Build result string
  let result = 'Genotype Probabilities: ';
  const parts = [];
  for (const [genotype, count] of Object.entries(genotypeCounts)) {
    const probability = (count / genotypes.length * 100).toFixed(0);
    parts.push(`${genotype}: ${probability}%`);
  }
  result += parts.join(', ');
  
  const interpretation = `Based on cross: ${parent1} √ó ${parent2}`;
  const formula = `Punnett Square analysis`;
  
  const steps = [
    `Parent 1 genotype: ${parent1}`,
    `Parent 2 genotype: ${parent2}`,
    `Possible gametes from Parent 1: ${parent1.split('').join(', ')}`,
    `Possible gametes from Parent 2: ${parent2.split('').join(', ')}`,
    `Offspring genotypes: ${genotypes.join(', ')}`,
    `Genotype frequencies: ${Object.entries(genotypeCounts).map(([g, c]) => `${g}: ${c}/${genotypes.length}`).join(', ')}`
  ];
  
  return {result, interpretation, formula, steps};
}

// Reset function
function btReset() {
  document.getElementById('bt-values').value = '';
  document.getElementById('bt-results').style.display = 'none';
  document.getElementById('bt-error').style.display = 'none';
  
  // Reset example buttons
  document.querySelectorAll('.bt-example-btn').forEach(btn => {
    btn.style.background = '';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
  });
  
  btUpdateToolInfo();
  
  console.log("Biology tools reset");
}

// Copy result
function btCopyResult() {
  const result = document.getElementById('bt-result-display').textContent;
  const formula = document.getElementById('bt-formula-display').textContent;
  const tool = document.getElementById('bt-tool').options[document.getElementById('bt-tool').selectedIndex].text;
  
  const textToCopy = `${tool}\nResult: ${result}\nFormula: ${formula}`;
  
  navigator.clipboard.writeText(textToCopy).then(() => {
    const copyBtn = document.getElementById('bt-copy-btn');
    const originalText = copyBtn.textContent;
    copyBtn.textContent = '‚úÖ Copied!';
    copyBtn.style.background = 'rgba(57,255,20,0.2)';
    
    setTimeout(() => {
      copyBtn.textContent = originalText;
      copyBtn.style.background = '';
    }, 2000);
  }).catch(err => {
    console.error('Copy failed:', err);
    alert('Failed to copy. Please select and copy manually.');
  });
}

// Show error
function btShowError(message) {
  document.getElementById('bt-error-text').textContent = message;
  document.getElementById('bt-error').style.display = 'block';
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', btInit);
} else {
  setTimeout(btInit, 100);
}
</script>
