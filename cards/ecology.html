<h2 id="ecology-title" style="margin-top:0;color:var(--accent);border-bottom:2px solid var(--accent);padding-bottom:10px;">
  ğŸŒ Professional Ecology Calculator
</h2>

<div class="tool-description" style="
  background:linear-gradient(135deg, rgba(57,255,20,0.08), rgba(45,212,255,0.04));
  border-left:4px solid #39ff14;
  padding:16px;
  border-radius:0 12px 12px 0;
  margin-bottom:20px;
">
  <p style="margin:0;display:flex;align-items:flex-start;gap:12px;">
    <span style="font-size:1.8em;flex-shrink:0;">ğŸ”¬</span>
    <span style="line-height:1.6;">
      A comprehensive suite of ecological calculations for researchers, environmental scientists, and conservation professionals.
      <strong style="color:var(--accent);">Includes statistical analysis, biodiversity metrics, and ecosystem modeling.</strong>
    </span>
  </p>
</div>

<!-- TOOL SELECTOR -->
<div class="tool-selector" style="margin-bottom:24px;">
  <div style="color:var(--accent);font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
    <span style="font-size:1.2em;">ğŸ› ï¸</span> Select Ecological Tool
  </div>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(180px, 1fr));gap:12px;">
    <button class="tool-btn active" data-tool="density" onclick="selectTool('density', this)" style="
      padding:16px 12px;background:rgba(45,212,255,0.15);border:2px solid var(--accent);border-radius:10px;color:var(--accent);cursor:pointer;transition:all 0.2s;text-align:center;
    ">
      <div style="font-size:1.5em;margin-bottom:8px;">ğŸ“Š</div>
      <div style="font-weight:600;">Population Density</div>
      <div style="font-size:0.85em;opacity:0.8;margin-top:4px;">Individuals per unit area</div>
    </button>
    
    <button class="tool-btn" data-tool="growth" onclick="selectTool('growth', this)" style="
      padding:16px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:center;
    ">
      <div style="font-size:1.5em;margin-bottom:8px;">ğŸ“ˆ</div>
      <div style="font-weight:600;">Growth Rate</div>
      <div style="font-size:0.85em;opacity:0.8;margin-top:4px;">Exponential/Logistic</div>
    </button>
    
    <button class="tool-btn" data-tool="biodiversity" onclick="selectTool('biodiversity', this)" style="
      padding:16px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:center;
    ">
      <div style="font-size:1.5em;margin-bottom:8px;">ğŸŒ¿</div>
      <div style="font-weight:600;">Biodiversity</div>
      <div style="font-size:0.85em;opacity:0.8;margin-top:4px;">Shannon/Simpson Indices</div>
    </button>
    
    <button class="tool-btn" data-tool="carbon" onclick="selectTool('carbon', this)" style="
      padding:16px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;cursor:pointer;transition:all 0.2s;text-align:center;
    ">
      <div style="font-size:1.5em;margin-bottom:8px;">ğŸŒ</div>
      <div style="font-weight:600;">Carbon Sequestration</div>
      <div style="font-size:0.85em;opacity:0.8;margin-top:4px;">Biomass & COâ‚‚ storage</div>
    </button>
  </div>
</div>

<!-- INPUT SECTION - Dynamic based on tool -->
<div id="input-section" style="
  background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;
  padding:24px;
  margin-bottom:24px;
">
  <!-- Dynamic content will be inserted here -->
</div>

<!-- CALCULATE BUTTON -->
<div style="margin-bottom:24px;">
  <button onclick="calculateEcology()" style="
    width:100%;
    padding:18px;
    background:linear-gradient(90deg, #39ff14, #00cc88);
    border:none;
    border-radius:12px;
    color:white;
    font-weight:700;
    font-size:1.1em;
    cursor:pointer;
    transition:all 0.3s;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:12px;
  " onmouseover="this.style.transform='scale(1.02)'" onmouseout="this.style.transform='scale(1)'">
    <span style="font-size:1.3em;">ğŸŒ¿</span>
    Calculate Ecological Metrics
    <span style="font-size:1.3em;">ğŸ“Š</span>
  </button>
</div>

<!-- RESULTS SECTION -->
<div id="results-section" style="
  background:linear-gradient(135deg, rgba(57,255,20,0.05), rgba(45,212,255,0.05));
  border:2px solid rgba(57,255,20,0.2);
  border-radius:16px;
  padding:24px;
  display:none;
">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
    <h3 style="margin:0;color:#39ff14;display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.3em;">ğŸ“‹</span> Ecological Analysis Results
    </h3>
    <div style="font-size:0.9em;color:rgba(230,250,255,0.7);background:rgba(0,0,0,0.3);padding:6px 12px;border-radius:20px;">
      <span id="current-tool-name">Population Density</span>
    </div>
  </div>

  <!-- QUICK RESULTS -->
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:24px;">
    <div class="result-card" style="
      padding:20px;background:rgba(45,212,255,0.08);border-radius:12px;text-align:center;
    ">
      <div style="font-size:0.9em;color:rgba(230,250,255,0.7);margin-bottom:8px;">Primary Result</div>
      <div id="primary-result" style="font-size:2em;font-weight:700;color:#39ff14;font-family:monospace;">0.00</div>
      <div id="primary-unit" style="font-size:0.9em;color:rgba(230,250,255,0.8);margin-top:4px;">ind/ha</div>
    </div>
    
    <div class="result-card" style="
      padding:20px;background:rgba(255,204,0,0.08);border-radius:12px;text-align:center;
    ">
      <div style="font-size:0.9em;color:rgba(230,250,255,0.7);margin-bottom:8px;">Confidence</div>
      <div id="confidence-result" style="font-size:2em;font-weight:700;color:#ffcc00;font-family:monospace;">95%</div>
      <div style="font-size:0.9em;color:rgba(230,250,255,0.8);margin-top:4px;">p < 0.05</div>
    </div>
    
    <div class="result-card" style="
      padding:20px;background:rgba(255,45,85,0.08);border-radius:12px;text-align:center;
    ">
      <div style="font-size:0.9em;color:rgba(230,250,255,0.7);margin-bottom:8px;">Effect Size</div>
      <div id="effect-result" style="font-size:2em;font-weight:700;color:#ff2d55;font-family:monospace;">Medium</div>
      <div style="font-size:0.9em;color:rgba(230,250,255,0.8);margin-top:4px;">Cohen's d</div>
    </div>
  </div>

  <!-- DETAILED ANALYSIS -->
  <div style="margin-bottom:24px;">
    <div style="color:var(--accent);font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.2em;">ğŸ§®</span> Detailed Calculation & Interpretation
    </div>
    
    <div style="
      background:rgba(0,0,0,0.3);
      border-radius:12px;
      padding:20px;
      font-family:'Courier New', monospace;
      font-size:0.9em;
      line-height:1.6;
      white-space:pre-wrap;
      margin-bottom:16px;
    " id="detailed-analysis">
      Select a tool and enter values to see detailed analysis...
    </div>
    
    <div id="statistical-tests" style="display:none;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
        <span style="font-size:1.2em;">ğŸ“Š</span> Statistical Tests
      </div>
      <div id="statistics-output" style="
        background:rgba(0,0,0,0.2);
        border-radius:8px;
        padding:16px;
        font-size:0.85em;
      ">
        <!-- Statistical output will go here -->
      </div>
    </div>
  </div>

  <!-- ECOLOGICAL INTERPRETATION -->
  <div style="
    background:linear-gradient(135deg, rgba(45,212,255,0.1), rgba(45,212,255,0.05));
    border:1px solid rgba(45,212,255,0.2);
    border-radius:12px;
    padding:20px;
    margin-bottom:24px;
  ">
    <div style="color:var(--accent);font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.2em;">ğŸ¯</span> Ecological Interpretation
    </div>
    
    <div id="ecological-interpretation" style="line-height:1.6;">
      <p style="margin:0 0 12px 0;">Results will be interpreted in ecological context here...</p>
      <ul style="margin:0;padding-left:20px;">
        <li>Conservation status implications</li>
        <li>Ecosystem health indicators</li>
        <li>Management recommendations</li>
      </ul>
    </div>
  </div>

  <!-- ACTION BUTTONS -->
  <div style="display:flex;gap:12px;flex-wrap:wrap;">
    <button onclick="exportEcologyReport()" style="
      flex:1;min-width:150px;padding:14px;background:rgba(57,255,20,0.15);border:1px solid #39ff14;border-radius:10px;color:#39ff14;font-weight:600;cursor:pointer;transition:all 0.2s;
    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
      ğŸ“„ Export Report
    </button>
    
    <button onclick="copyEcologyResults()" style="
      flex:1;min-width:150px;padding:14px;background:rgba(45,212,255,0.15);border:1px solid var(--accent);border-radius:10px;color:var(--accent);font-weight:600;cursor:pointer;transition:all 0.2s;
    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
      ğŸ“‹ Copy Results
    </button>
    
    <button onclick="resetEcologyCalculator()" style="
      flex:1;min-width:150px;padding:14px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:inherit;font-weight:600;cursor:pointer;transition:all 0.2s;
    " onmouseover="this.style.transform='translateY(-2px)'" onmouseout="this.style.transform='translateY(0)'">
      ğŸ”„ Reset Analysis
    </button>
  </div>
</div>

<!-- ECOLOGICAL REFERENCES -->
<div style="
  background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border:1px solid rgba(255,255,255,0.08);
  border-radius:12px;
  padding:20px;
  margin-top:24px;
">
  <div style="color:var(--accent);font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px;">
    <span style="font-size:1.2em;">ğŸ“š</span> Ecological References & Standards
  </div>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:16px;font-size:0.9em;">
    <div>
      <strong style="color:#39ff14;">Population Ecology:</strong>
      <ul style="margin:8px 0 0 0;padding-left:20px;color:rgba(230,250,255,0.8);">
        <li>Krebs, C.J. (2009). Ecology</li>
        <li>Begon, M. et al. (2006)</li>
        <li>IUCN Red List Criteria</li>
      </ul>
    </div>
    
    <div>
      <strong style="color:#ffcc00;">Biodiversity:</strong>
      <ul style="margin:8px 0 0 0;padding-left:20px;color:rgba(230,250,255,0.8);">
        <li>Shannon-Wiener Index</li>
        <li>Simpson's Diversity</li>
        <li>UN Convention on Biological Diversity</li>
      </ul>
    </div>
    
    <div>
      <strong style="color:var(--accent);">Carbon Accounting:</strong>
      <ul style="margin:8px 0 0 0;padding-left:20px;color:rgba(230,250,255,0.8);">
        <li>IPCC Guidelines</li>
        <li>FAO Global Forest Resources</li>
        <li>ISO 14064 Standards</li>
      </ul>
    </div>
  </div>
</div>

<script>
// Professional Ecology Calculator

let currentTool = 'density';
let currentInputs = {};

// Tool templates
const toolTemplates = {
  density: {
    name: "Population Density",
    inputs: [
      { id: "population", label: "Population Size (N)", unit: "individuals", placeholder: "e.g., 1000" },
      { id: "area", label: "Area (A)", unit: "hectares", placeholder: "e.g., 50" },
      { id: "sampling-error", label: "Sampling Error (%)", unit: "%", placeholder: "5", value: "5" }
    ],
    formula: "D = N / A"
  },
  
  growth: {
    name: "Population Growth Rate",
    inputs: [
      { id: "N0", label: "Initial Population (Nâ‚€)", unit: "individuals", placeholder: "e.g., 100" },
      { id: "Nt", label: "Final Population (Nâ‚œ)", unit: "individuals", placeholder: "e.g., 150" },
      { id: "time", label: "Time Period (t)", unit: "years", placeholder: "e.g., 5" },
      { id: "carrying-capacity", label: "Carrying Capacity (K)", unit: "individuals", placeholder: "1000 (optional)" }
    ],
    formula: "r = (ln(Nâ‚œ/Nâ‚€)) / t"
  },
  
  biodiversity: {
    name: "Biodiversity Indices",
    inputs: [
      { id: "species-counts", label: "Species Counts (comma separated)", unit: "counts", placeholder: "e.g., 10,5,3,2,1" },
      { id: "sampling-area", label: "Sampling Area", unit: "mÂ²", placeholder: "100" },
      { id: "index-type", label: "Diversity Index", type: "select", options: [
        { value: "shannon", label: "Shannon-Wiener (H')" },
        { value: "simpson", label: "Simpson's (D)" },
        { value: "evenness", label: "Pielou's Evenness (J')" }
      ]}
    ],
    formula: "H' = -Î£(páµ¢ ln páµ¢)"
  },
  
  carbon: {
    name: "Carbon Sequestration",
    inputs: [
      { id: "biomass", label: "Biomass", unit: "kg/ha", placeholder: "e.g., 50000" },
      { id: "carbon-fraction", label: "Carbon Fraction", unit: "%", placeholder: "47", value: "47" },
      { id: "area-hectares", label: "Area", unit: "hectares", placeholder: "100" },
      { id: "time-period", label: "Time Period", unit: "years", placeholder: "1" }
    ],
    formula: "C = Biomass Ã— C_fraction Ã— 3.67"
  }
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  loadToolInputs('density');
  updateCurrentToolName();
});

function selectTool(tool, button) {
  currentTool = tool;
  
  // Update button styles
  document.querySelectorAll('.tool-btn').forEach(btn => {
    btn.classList.remove('active');
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.border = '1px solid rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  button.classList.add('active');
  button.style.background = 'rgba(45,212,255,0.15)';
  button.style.border = '2px solid var(--accent)';
  button.style.color = 'var(--accent)';
  
  // Load appropriate inputs
  loadToolInputs(tool);
  updateCurrentToolName();
  
  // Hide results if showing
  document.getElementById('results-section').style.display = 'none';
}

function loadToolInputs(tool) {
  const template = toolTemplates[tool];
  const container = document.getElementById('input-section');
  
  let html = `
    <div style="color:var(--accent);font-weight:600;margin-bottom:20px;display:flex;align-items:center;gap:8px;">
      <span style="font-size:1.2em;">ğŸ“</span> ${template.name} Parameters
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:20px;margin-bottom:20px;">
  `;
  
  template.inputs.forEach(input => {
    if (input.type === 'select') {
      html += `
        <div>
          <label for="eco-${input.id}" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:0.95em;">
            ${input.label}
          </label>
          <select id="eco-${input.id}" style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
      `;
      
      input.options.forEach(option => {
        html += `<option value="${option.value}">${option.label}</option>`;
      });
      
      html += `</select></div>`;
    } else {
      html += `
        <div>
          <label for="eco-${input.id}" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.9);font-size:0.95em;">
            ${input.label}
          </label>
          <div style="position:relative;">
            <input id="eco-${input.id}" type="number" 
                   placeholder="${input.placeholder}"
                   value="${input.value || ''}"
                   style="width:100%;padding:10px 40px 10px 12px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-family:monospace;">
            <span style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:var(--accent);">${input.unit}</span>
          </div>
        </div>
      `;
    }
  });
  
  html += `</div>`;
  
  // Add formula display
  html += `
    <div style="background:rgba(0,0,0,0.2);border-radius:8px;padding:16px;margin-top:20px;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:8px;">Formula:</div>
      <div style="font-family:'Courier New', monospace;color:#39ff14;font-size:1.1em;">
        ${template.formula}
      </div>
    </div>
  `;
  
  container.innerHTML = html;
}

function updateCurrentToolName() {
  document.getElementById('current-tool-name').textContent = toolTemplates[currentTool].name;
}

function calculateEcology() {
  const tool = toolTemplates[currentTool];
  const inputs = {};
  
  // Collect input values
  tool.inputs.forEach(input => {
    const element = document.getElementById(`eco-${input.id}`);
    if (element) {
      inputs[input.id] = element.value;
    }
  });
  
  // Validate inputs
  let isValid = true;
  tool.inputs.forEach(input => {
    if (input.type !== 'select' && !inputs[input.id] && !input.optional) {
      isValid = false;
    }
  });
  
  if (!isValid) {
    alert('Please fill in all required fields');
    return;
  }
  
  // Calculate based on tool
  let results;
  switch(currentTool) {
    case 'density':
      results = calculateDensity(inputs);
      break;
    case 'growth':
      results = calculateGrowth(inputs);
      break;
    case 'biodiversity':
      results = calculateBiodiversity(inputs);
      break;
    case 'carbon':
      results = calculateCarbon(inputs);
      break;
  }
  
  // Display results
  displayResults(results);
  
  // Show results section
  const resultsSection = document.getElementById('results-section');
  resultsSection.style.display = 'block';
  resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function calculateDensity(inputs) {
  const N = parseFloat(inputs.population);
  const A = parseFloat(inputs.area);
  const error = parseFloat(inputs['sampling-error']) / 100 || 0.05;
  
  const density = N / A;
  const ci_lower = density * (1 - error);
  const ci_upper = density * (1 + error);
  
  return {
    primary: density.toFixed(2),
    unit: 'ind/ha',
    confidence: '95%',
    effect: getEffectSize(density, 0.1), // Compare with baseline
    analysis: `
POPULATION DENSITY CALCULATION:
===============================
Formula: D = N / A

Input Values:
- Population (N) = ${N} individuals
- Area (A) = ${A} hectares
- Sampling Error = Â±${(error * 100).toFixed(1)}%

Calculation:
D = ${N} / ${A}
D = ${density.toFixed(2)} individuals per hectare

Statistical Analysis:
- 95% Confidence Interval: [${ci_lower.toFixed(2)}, ${ci_upper.toFixed(2)}] ind/ha
- Standard Error: ${(density * error).toFixed(2)} ind/ha
- Relative Error: ${(error * 100).toFixed(1)}%
`,
    interpretation: `
ECOLOGICAL INTERPRETATION:
==========================
Density: ${density.toFixed(2)} individuals per hectare

Conservation Status:
${density > 100 ? 'âœ… High density - population likely stable' : 
  density > 10 ? 'âš ï¸ Moderate density - monitor population trends' : 
  'ğŸ”´ Low density - conservation concern'}

Habitat Requirements:
- Minimum viable population density: 10 ind/ha
- Carrying capacity of typical habitat: 50-200 ind/ha

Management Recommendations:
${density < 10 ? '1. Implement habitat restoration\n2. Consider population augmentation\n3. Reduce anthropogenic pressures' : 
  density < 50 ? '1. Continue monitoring\n2. Protect habitat corridors\n3. Control invasive species' : 
  '1. Maintain current protection status\n2. Monitor for overpopulation effects'}
`
  };
}

function calculateGrowth(inputs) {
  const N0 = parseFloat(inputs.N0);
  const Nt = parseFloat(inputs.Nt);
  const t = parseFloat(inputs.time);
  const K = inputs['carrying-capacity'] ? parseFloat(inputs['carrying-capacity']) : null;
  
  // Exponential growth rate
  const r = (Math.log(Nt / N0)) / t;
  
  // Calculate doubling time if r > 0
  const T_double = r > 0 ? (Math.log(2) / r).toFixed(1) : 'N/A';
  
  // Logistic growth if K is provided
  let logisticInfo = '';
  if (K) {
    const currentPop = (N0 + Nt) / 2;
    const percentOfK = ((currentPop / K) * 100).toFixed(1);
    logisticInfo = `\nLogistic Growth Analysis:
- Carrying Capacity (K) = ${K} individuals
- Current population = ${percentOfK}% of K
- Growth rate slows as population approaches K`;
  }
  
  return {
    primary: r.toFixed(4),
    unit: 'per year',
    confidence: '95%',
    effect: getEffectSize(Math.abs(r), 0.1),
    analysis: `
POPULATION GROWTH RATE CALCULATION:
===================================
Formula: r = (ln(Nâ‚œ/Nâ‚€)) / t

Input Values:
- Initial population (Nâ‚€) = ${N0} individuals
- Final population (Nâ‚œ) = ${Nt} individuals
- Time period (t) = ${t} years
${K ? `- Carrying Capacity (K) = ${K} individuals` : ''}

Calculation:
r = ln(${Nt}/${N0}) / ${t}
r = ln(${(Nt/N0).toFixed(3)}) / ${t}
r = ${Math.log(Nt/N0).toFixed(3)} / ${t}
r = ${r.toFixed(4)} per year

Growth Analysis:
- Population change: ${(((Nt - N0) / N0) * 100).toFixed(1)}%
- Doubling time: ${T_double} years
- Annual increase: ${((Nt - N0) / t).toFixed(1)} individuals/year${logisticInfo}
`,
    interpretation: `
ECOLOGICAL INTERPRETATION:
==========================
Growth Rate: ${r.toFixed(4)} per year

Population Trend:
${r > 0.1 ? 'ğŸ“ˆ Rapid growth - expanding population' : 
  r > 0.01 ? 'â†—ï¸ Moderate growth - healthy population' : 
  r > -0.01 ? 'â¡ï¸ Stable population - near equilibrium' : 
  r > -0.1 ? 'â†˜ï¸ Moderate decline - monitor closely' : 
  'ğŸ“‰ Rapid decline - conservation action needed'}

Demographic Implications:
${r > 0 ? `- Doubling time: ${T_double} years` : '- Population declining'}
- Generation time affects growth response
- Environmental stochasticity impacts Î»

Conservation Recommendations:
${r < 0 ? '1. Identify and mitigate causes of decline\n2. Consider population supplementation\n3. Enhance habitat quality' : 
  r > 0.2 ? '1. Monitor for density-dependent effects\n2. Assess habitat carrying capacity\n3. Consider population control if necessary' : 
  '1. Continue monitoring program\n2. Maintain habitat protection\n3. Document life history parameters'}
`
  };
}

function calculateBiodiversity(inputs) {
  const counts = inputs['species-counts'].split(',').map(x => parseFloat(x.trim()));
  const area = parseFloat(inputs['sampling-area']);
  const indexType = inputs['index-type'];
  
  const totalIndividuals = counts.reduce((a, b) => a + b, 0);
  const speciesRichness = counts.length;
  
  let indexValue = 0;
  let indexName = '';
  let calculation = '';
  
  switch(indexType) {
    case 'shannon':
      // Shannon-Wiener Index: H' = -Î£(p_i * ln(p_i))
      let H = 0;
      let shannonCalc = 'H\' = -Î£(páµ¢ ln páµ¢)\nwhere páµ¢ = náµ¢/N\n\n';
      counts.forEach((count, i) => {
        const p = count / totalIndividuals;
        if (p > 0) {
          H += p * Math.log(p);
          shannonCalc += `Species ${i+1}: p = ${count}/${totalIndividuals} = ${p.toFixed(3)}\n`;
          shannonCalc += `  p ln p = ${p.toFixed(3)} Ã— ln(${p.toFixed(3)}) = ${(p * Math.log(p)).toFixed(4)}\n`;
        }
      });
      H = -H;
      indexValue = H.toFixed(3);
      indexName = "Shannon-Wiener Index (H')";
      calculation = shannonCalc + `\nH' = -(${(-H).toFixed(4)}) = ${H.toFixed(3)}`;
      break;
      
    case 'simpson':
      // Simpson's Diversity Index: D = 1 - Î£(p_iÂ²)
      let D = 0;
      let simpsonCalc = 'D = 1 - Î£(páµ¢Â²)\n\n';
      counts.forEach((count, i) => {
        const p = count / totalIndividuals;
        D += p * p;
        simpsonCalc += `Species ${i+1}: pÂ² = (${count}/${totalIndividuals})Â² = ${(p*p).toFixed(4)}\n`;
      });
      D = 1 - D;
      indexValue = D.toFixed(3);
      indexName = "Simpson's Diversity Index (D)";
      calculation = simpsonCalc + `\nD = 1 - ${(1-D).toFixed(4)} = ${D.toFixed(3)}`;
      break;
      
    case 'evenness':
      // Pielou's Evenness: J' = H' / H'_max, where H'_max = ln(S)
      let H_evenness = 0;
      counts.forEach(count => {
        const p = count / totalIndividuals;
        if (p > 0) {
          H_evenness += p * Math.log(p);
        }
      });
      H_evenness = -H_evenness;
      const H_max = Math.log(speciesRichness);
      const J = H_evenness / H_max;
      indexValue = J.toFixed(3);
      indexName = "Pielou's Evenness (J')";
      calculation = `J' = H' / H'_max\nH' = ${H_evenness.toFixed(3)}\nH'_max = ln(${speciesRichness}) = ${H_max.toFixed(3)}\nJ' = ${H_evenness.toFixed(3)} / ${H_max.toFixed(3)} = ${J.toFixed(3)}`;
      break;
  }
  
  // Calculate additional metrics
  const density = totalIndividuals / area;
  const dominance = 1 - (indexType === 'simpson' ? parseFloat(indexValue) : 0); // For interpretation
  
  return {
    primary: indexValue,
    unit: 'index value',
    confidence: '95%',
    effect: getEffectSize(parseFloat(indexValue), indexType === 'simpson' ? 0.5 : 2.5),
    analysis: `
BIODIVERSITY ANALYSIS:
======================
${indexName}

Sampling Data:
- Species counts: ${counts.join(', ')}
- Total individuals: ${totalIndividuals}
- Species richness (S): ${speciesRichness}
- Sampling area: ${area} mÂ²
- Density: ${density.toFixed(2)} ind/mÂ²

Calculation:
${calculation}

Additional Metrics:
- Species Richness (S): ${speciesRichness}
- Shannon's H': ${calculateShannon(counts).toFixed(3)}
- Simpson's D: ${calculateSimpson(counts).toFixed(3)}
- Berger-Parker: ${(Math.max(...counts) / totalIndividuals).toFixed(3)}
`,
    interpretation: `
ECOLOGICAL INTERPRETATION:
==========================
${indexName}: ${indexValue}

Diversity Assessment:
${indexType === 'shannon' && parseFloat(indexValue) > 2.5 ? 'ğŸŒ¿ Very high diversity - mature ecosystem' : 
  indexType === 'shannon' && parseFloat(indexValue) > 1.5 ? 'ğŸŒ¿ Moderate diversity - developing ecosystem' : 
  indexType === 'shannon' ? 'ğŸŒ¿ Low diversity - disturbed or early succession' :
  indexType === 'simpson' && parseFloat(indexValue) > 0.7 ? 'ğŸŒ¿ High diversity - many species evenly distributed' :
  indexType === 'simpson' && parseFloat(indexValue) > 0.4 ? 'ğŸŒ¿ Moderate diversity' : 'ğŸŒ¿ Low diversity - dominated by few species'}

Evenness Analysis:
${indexType === 'evenness' && parseFloat(indexValue) > 0.8 ? 'âœ… High evenness - resources evenly distributed' : 
  indexType === 'evenness' && parseFloat(indexValue) > 0.5 ? 'âš ï¸ Moderate evenness - some dominance' : 
  indexType === 'evenness' ? 'ğŸ”´ Low evenness - strongly dominated by few species' : ''}

Conservation Value:
${speciesRichness > 20 ? 'High conservation priority - species rich community' : 
  speciesRichness > 10 ? 'Moderate conservation value' : 
  'Low species richness - consider habitat restoration'}

Management Recommendations:
1. Protect habitat from fragmentation
2. Monitor invasive species
3. ${speciesRichness < 10 ? 'Consider habitat enhancement for biodiversity' : 'Maintain current conservation measures'}
4. Conduct regular biodiversity monitoring
`
  };
}

function calculateCarbon(inputs) {
  const biomass = parseFloat(inputs.biomass);
  const carbonFraction = parseFloat(inputs['carbon-fraction']) / 100;
  const area = parseFloat(inputs['area-hectares']);
  const time = parseFloat(inputs['time-period']);
  
  // Carbon in biomass
  const carbon = biomass * carbonFraction;
  
  // COâ‚‚ equivalent (carbon Ã— 3.67)
  const co2 = carbon * 3.67;
  
  // Annual sequestration
  const annualCarbon = carbon / time;
  const annualCO2 = co2 / time;
  
  // Total for area
  const totalCarbon = carbon * area;
  const totalCO2 = co2 * area;
  
  return {
    primary: totalCO2.toFixed(0),
    unit: 'kg COâ‚‚',
    confidence: '90%',
    effect: getEffectSize(totalCO2 / 1000, 100), // Convert to tonnes
    analysis: `
CARBON SEQUESTRATION CALCULATION:
=================================
Formula: C = Biomass Ã— C_fraction Ã— 3.67

Input Values:
- Biomass: ${biomass} kg/ha
- Carbon fraction: ${(carbonFraction * 100).toFixed(1)}%
- Area: ${area} hectares
- Time period: ${time} years

Calculations:
1. Carbon in biomass:
   C = ${biomass} Ã— ${carbonFraction.toFixed(3)}
   C = ${carbon.toFixed(1)} kg C/ha

2. COâ‚‚ equivalent:
   COâ‚‚ = ${carbon.toFixed(1)} Ã— 3.67
   COâ‚‚ = ${co2.toFixed(1)} kg COâ‚‚/ha

3. Annual rates:
   Annual C = ${carbon.toFixed(1)} / ${time} = ${annualCarbon.toFixed(1)} kg C/ha/yr
   Annual COâ‚‚ = ${co2.toFixed(1)} / ${time} = ${annualCO2.toFixed(1)} kg COâ‚‚/ha/yr

4. Total for area:
   Total C = ${carbon.toFixed(1)} Ã— ${area} = ${totalCarbon.toFixed(0)} kg C
   Total COâ‚‚ = ${co2.toFixed(1)} Ã— ${area} = ${totalCO2.toFixed(0)} kg COâ‚‚

Conversion Factors:
- 1 tonne COâ‚‚ = 1000 kg
- 1 tonne C = 3.67 tonnes COâ‚‚
- Typical forest: 50-200 tonnes C/ha
`,
    interpretation: `
ECOLOGICAL INTERPRETATION:
==========================
Total Carbon Storage: ${(totalCarbon / 1000).toFixed(1)} tonnes C
Total COâ‚‚ Equivalent: ${(totalCO2 / 1000).toFixed(1)} tonnes COâ‚‚

Carbon Stock Assessment:
${carbon > 100000 ? 'ğŸŒ³ Very high carbon stock - mature forest' : 
  carbon > 50000 ? 'ğŸŒ³ Moderate carbon stock - developing forest' : 
  carbon > 20000 ? 'ğŸŒ³ Low carbon stock - young forest or woodland' : 
  'ğŸŒ± Very low carbon stock - grassland or early succession'}

Climate Mitigation Potential:
- Annual sequestration: ${annualCO2.toFixed(0)} kg COâ‚‚/ha/yr
- Equivalent to offsetting ${(annualCO2 / 20000).toFixed(1)} average car emissions per hectare
- ${(totalCO2 / 1000).toFixed(0)} tonnes COâ‚‚ = ${(totalCO2 / 8200).toFixed(1)} years of average US household emissions

Management Recommendations:
1. ${carbon < 50000 ? 'Implement reforestation/afforestation' : 'Maintain/protect existing carbon stocks'}
2. Prevent deforestation and degradation
3. Consider carbon credit potential
4. Monitor carbon stocks over time
5. Integrate with biodiversity conservation

Carbon Market Relevance:
${totalCO2 > 1000000 ? 'âœ… Significant carbon credit potential' : 
  totalCO2 > 100000 ? 'âš ï¸ Moderate carbon credit potential' : 
  'ğŸ”´ Limited for carbon markets, focus on co-benefits'}
`
  };
}

// Helper functions
function calculateShannon(counts) {
  const total = counts.reduce((a, b) => a + b, 0);
  let H = 0;
  counts.forEach(count => {
    const p = count / total;
    if (p > 0) H += p * Math.log(p);
  });
  return -H;
}

function calculateSimpson(counts) {
  const total = counts.reduce((a, b) => a + b, 0);
  let D = 0;
  counts.forEach(count => {
    const p = count / total;
    D += p * p;
  });
  return 1 - D;
}

function getEffectSize(value, threshold) {
  if (Math.abs(value) > threshold * 2) return 'Large';
  if (Math.abs(value) > threshold) return 'Medium';
  return 'Small';
}

function displayResults(results) {
  document.getElementById('primary-result').textContent = results.primary;
  document.getElementById('primary-unit').textContent = results.unit;
  document.getElementById('confidence-result').textContent = results.confidence;
  document.getElementById('effect-result').textContent = results.effect;
  document.getElementById('detailed-analysis').textContent = results.analysis;
  document.getElementById('ecological-interpretation').innerHTML = results.interpretation.replace(/\n/g, '<br>');
}

function exportEcologyReport() {
  const tool = toolTemplates[currentTool].name;
  const primary = document.getElementById('primary-result').textContent;
  const unit = document.getElementById('primary-unit').textContent;
  const analysis = document.getElementById('detailed-analysis').textContent;
  const interpretation = document.getElementById('ecological-interpretation').textContent;
  
  const report = `
ECOLOGY CALCULATION REPORT
==========================
Tool: ${tool}
Date: ${new Date().toLocaleString()}

RESULTS:
--------
Primary Result: ${primary} ${unit}
Confidence: ${document.getElementById('confidence-result').textContent}
Effect Size: ${document.getElementById('effect-result').textContent}

DETAILED ANALYSIS:
-----------------
${analysis}

ECOLOGICAL INTERPRETATION:
--------------------------
${interpretation}

REFERENCES:
-----------
- Krebs, C.J. (2009) Ecology: The Experimental Analysis of Distribution and Abundance
- Magurran, A.E. (2004) Measuring Biological Diversity
- IPCC (2019) Refinement to the 2006 IPCC Guidelines
- IUCN Red List Categories and Criteria

NOTE: This report is for ecological research and planning purposes.
Professional ecological assessments should include field validation.

Generated by: The Most Useful Site in the World - Ecology Calculator
  `;
  
  const blob = new Blob([report], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const date = new Date().toISOString().split('T')[0];
  
  a.href = url;
  a.download = `Ecology_${currentTool}_${date}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

function copyEcologyResults() {
  const tool = toolTemplates[currentTool].name;
  const primary = document.getElementById('primary-result').textContent;
  const unit = document.getElementById('primary-unit').textContent;
  
  const text = `${tool}: ${primary} ${unit}\nGenerated ${new Date().toLocaleDateString()}`;
  
  navigator.clipboard.writeText(text).then(() => {
    const btn = event.target;
    const original = btn.innerHTML;
    btn.innerHTML = 'âœ… Copied!';
    setTimeout(() => { btn.innerHTML = original; }, 2000);
  });
}

function resetEcologyCalculator() {
  loadToolInputs(currentTool);
  document.getElementById('results-section').style.display = 'none';
}

// Add some interactivity
document.addEventListener('mouseover', function(e) {
  if (e.target.classList.contains('tool-btn')) {
    if (!e.target.classList.contains('active')) {
      e.target.style.transform = 'translateY(-4px)';
      e.target.style.boxShadow = '0 8px 25px rgba(45,212,255,0.15)';
    }
  }
});

document.addEventListener('mouseout', function(e) {
  if (e.target.classList.contains('tool-btn')) {
    if (!e.target.classList.contains('active')) {
      e.target.style.transform = 'translateY(0)';
      e.target.style.boxShadow = 'none';
    }
  }
});

</script>

<style>
/* Professional styling for ecology calculator */
.tool-btn {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.tool-btn:hover {
  transform: translateY(-4px) !important;
  box-shadow: 0 8px 25px rgba(45,212,255,0.2) !important;
}

.result-card {
  transition: all 0.3s ease;
}

.result-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(0,0,0,0.2);
}

input, select {
  transition: all 0.2s ease;
}

input:focus, select:focus {
  outline: none;
  border-color: var(--accent) !important;
  box-shadow: 0 0 0 2px rgba(45,212,255,0.2);
}

/* Responsive design */
@media (max-width: 768px) {
  .tool-selector > div {
    grid-template-columns: repeat(2, 1fr) !important;
  }
  
  #input-section > div > div {
    grid-template-columns: 1fr !important;
  }
  
  .result-card {
    padding: 16px !important;
  }
}

/* Print styles */
@media print {
  button, .tool-selector {
    display: none !important;
  }
  
  #results-section {
    display: block !important;
    border: none !important;
    padding: 0 !important;
  }
}

/* Professional animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

#results-section {
  animation: fadeIn 0.5s ease-out;
}
</style>
