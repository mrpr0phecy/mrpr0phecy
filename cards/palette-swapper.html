<h2 id="palette-swapper-title" style="margin-top:0;color:var(--accent);">ğŸ¨ Advanced Palette Swapper</h2>

<form aria-describedby="palette-swapper-desc">
  <p id="palette-swapper-desc" class="small" style="color:rgba(230,250,255,0.8);margin-bottom:20px;">
    Advanced color manipulation with multiple effects, palette extraction, and real-time preview.
    <span style="color:var(--accent);font-weight:500;">Transform images with professional color tools!</span>
  </p>

  <!-- IMAGE UPLOAD SECTION -->
  <div style="background:rgba(45,212,255,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(45,212,255,0.2);">
    <h4 class="small" style="color:var(--accent);margin-bottom:16px;">ğŸ“ Image Upload</h4>
    
    <div style="display:grid;grid-template-columns:2fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="palette-file" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Upload Image</label>
        <input id="palette-file" type="file" accept="image/*" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
      </div>
      
      <div class="field">
        <label for="palette-resize" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Resize</label>
        <select id="palette-resize" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="original">Original Size</option>
          <option value="800" selected>Max 800px</option>
          <option value="1200">Max 1200px</option>
          <option value="1600">Max 1600px</option>
          <option value="custom">Custom</option>
        </select>
      </div>
    </div>
    
    <div style="display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
      <button onclick="paletteLoadExample()" 
              style="padding:8px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:12px;">
        ğŸ¨ Load Example
      </button>
      <button onclick="paletteExtractColors()" 
              style="padding:8px 12px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:6px;color:#9d4edd;cursor:pointer;font-size:12px;">
        ğŸ” Extract Colors
      </button>
      <div id="palette-file-info" style="color:rgba(230,250,255,0.6);font-size:12px;margin-left:auto;"></div>
    </div>
  </div>

  <!-- COLOR SELECTION SECTION -->
  <div style="background:rgba(57,255,20,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(57,255,20,0.2);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h4 class="small" style="color:#39ff14;margin:0;">ğŸ¯ Color Selection</h4>
      <div style="display:flex;gap:8px;">
        <button onclick="palettePickFromImage()" class="small-btn">ğŸ‘† Pick Color</button>
        <button onclick="paletteSwapColors()" class="small-btn">ğŸ”„ Swap</button>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:12px;">
      <div>
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">From Color</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
          <input id="palette-from" type="text" placeholder="#ff0000" value="#ff0000"
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-family:monospace;" />
          <input id="palette-from-color" type="color" value="#ff0000"
                 style="width:60px;height:44px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);cursor:pointer;" />
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <div id="palette-from-rgb" style="font-size:11px;color:rgba(230,250,255,0.6);">RGB: 255, 0, 0</div>
          <div id="palette-from-hsl" style="font-size:11px;color:rgba(230,250,255,0.6);">HSL: 0Â°, 100%, 50%</div>
        </div>
      </div>
      
      <div>
        <div style="color:var(--accent);font-weight:500;margin-bottom:8px;">To Color</div>
        <div style="display:grid;grid-template-columns:1fr auto;gap:8px;">
          <input id="palette-to" type="text" placeholder="#00ff00" value="#00ff00"
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-family:monospace;" />
          <input id="palette-to-color" type="color" value="#00ff00"
                 style="width:60px;height:44px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);cursor:pointer;" />
        </div>
        <div style="display:flex;justify-content:space-between;margin-top:6px;">
          <div id="palette-to-rgb" style="font-size:11px;color:rgba(230,250,255,0.6);">RGB: 0, 255, 0</div>
          <div id="palette-to-hsl" style="font-size:11px;color:rgba(230,250,255,0.6);">HSL: 120Â°, 100%, 50%</div>
        </div>
      </div>
    </div>
    
    <!-- COLOR TOLERANCE -->
    <div style="margin-top:12px;">
      <div style="color:var(--accent);font-weight:500;margin-bottom:6px;">ğŸ›ï¸ Color Tolerance</div>
      <div style="display:flex;align-items:center;gap:12px;">
        <input id="palette-tolerance" type="range" min="0" max="100" value="0" step="1"
               style="flex:1;height:6px;border-radius:3px;" />
        <div id="palette-tolerance-value" style="color:var(--accent);font-weight:500;min-width:40px;text-align:center;">0%</div>
      </div>
      <div style="font-size:11px;color:rgba(230,250,255,0.6);margin-top:4px;">
        Adjust tolerance to match similar colors
      </div>
    </div>
  </div>

  <!-- EFFECTS & TRANSFORMATIONS -->
  <div style="background:rgba(255,165,0,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,165,0,0.2);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h4 class="small" style="color:#ffa500;margin:0;">âœ¨ Effects & Transformations</h4>
      <div style="display:flex;gap:6px;">
        <button onclick="palettePreviewEffect()" class="small-btn">ğŸ‘ï¸ Preview</button>
        <button onclick="paletteResetEffect()" class="small-btn">â†©ï¸ Reset</button>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:10px;margin-bottom:12px;">
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-grayscale" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">âš« Grayscale</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-sepia" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">ğŸŸ¤ Sepia</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-invert" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">ğŸ”„ Invert</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-hue" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">ğŸŒˆ Hue Shift</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-brightness" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">â˜€ï¸ Brightness</span>
      </label>
      <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
        <input type="checkbox" id="palette-effect-contrast" style="width:16px;height:16px;cursor:pointer;" />
        <span style="color:rgba(230,250,255,0.9);">âš«âšª Contrast</span>
      </label>
    </div>
    
    <!-- EFFECT CONTROLS -->
    <div id="palette-effect-controls" style="display:none;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:12px;margin-top:12px;">
      <div>
        <div style="color:var(--accent);font-size:12px;margin-bottom:4px;">Hue Shift</div>
        <input id="palette-hue-shift" type="range" min="-180" max="180" value="0" step="1"
               style="width:100%;height:6px;border-radius:3px;" />
      </div>
      <div>
        <div style="color:var(--accent);font-size:12px;margin-bottom:4px;">Brightness</div>
        <input id="palette-brightness" type="range" min="-100" max="100" value="0" step="1"
               style="width:100%;height:6px;border-radius:3px;" />
      </div>
      <div>
        <div style="color:var(--accent);font-size:12px;margin-bottom:4px;">Contrast</div>
        <input id="palette-contrast" type="range" min="-100" max="100" value="0" step="1"
               style="width:100%;height:6px;border-radius:3px;" />
      </div>
      <div>
        <div style="color:var(--accent);font-size:12px;margin-bottom:4px;">Saturation</div>
        <input id="palette-saturation" type="range" min="-100" max="100" value="0" step="1"
               style="width:100%;height:6px;border-radius:3px;" />
      </div>
    </div>
    
    <!-- QUICK PRESETS -->
    <div style="margin-top:12px;">
      <div style="color:rgba(230,250,255,0.8);font-size:13px;margin-bottom:6px;">âš¡ Quick Presets:</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button onclick="paletteApplyPreset('warm')" class="preset-btn">ğŸ”¥ Warm Filter</button>
        <button onclick="paletteApplyPreset('cool')" class="preset-btn">â„ï¸ Cool Filter</button>
        <button onclick="paletteApplyPreset('vintage')" class="preset-btn">ğŸ“œ Vintage</button>
        <button onclick="paletteApplyPreset('cyberpunk')" class="preset-btn">ğŸ¤– Cyberpunk</button>
        <button onclick="paletteApplyPreset('pastel')" class="preset-btn">ğŸŒ¸ Pastel</button>
        <button onclick="paletteApplyPreset('darkmode')" class="preset-btn">ğŸŒ™ Dark Mode</button>
      </div>
    </div>
  </div>

  <!-- MULTIPLE COLOR REPLACEMENT -->
  <div style="margin-bottom:20px;">
    <details>
      <summary style="color:var(--accent);font-weight:500;cursor:pointer;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;">ğŸ¨ Multiple Color Replacement</summary>
      <div style="margin-top:12px;">
        <div id="palette-color-pairs">
          <!-- Color pairs will be added here -->
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button onclick="paletteAddColorPair()" 
                  style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
            â• Add Another Color
          </button>
          <button onclick="paletteApplyAllColors()" 
                  style="padding:8px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:12px;">
            ğŸ¯ Apply All
          </button>
        </div>
      </div>
    </details>
  </div>

  <div class="actions" style="display:flex;gap:10px;">
    <button type="button" onclick="paletteProcessImage()" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(157,78,221,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);font-weight:600;cursor:pointer;font-size:16px;">
      ğŸ¨ Process Image
    </button>
    <button type="button" onclick="paletteResetAll()"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      ğŸ”„ Reset All
    </button>
    <button type="button" onclick="paletteDownload()"
            style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      ğŸ’¾ Download
    </button>
  </div>
</form>

<div id="palette-results" aria-live="polite" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
    <h3 class="small" style="color:var(--accent);margin:0;">ğŸ“Š Results & Comparison</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="palette-process-time" class="small" style="color:rgba(230,250,255,0.6);"></div>
      <button onclick="paletteToggleOriginal()" class="small-btn" style="font-size:11px;">ğŸ‘ï¸ Toggle Original</button>
    </div>
  </div>

  <!-- IMAGE COMPARISON -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:20px;">
    <div>
      <div style="color:#2dd4ff;font-weight:500;margin-bottom:8px;text-align:center;">Original</div>
      <canvas id="palette-original" 
              style="width:100%;max-height:400px;border:1px solid rgba(45,212,255,0.2);border-radius:8px;background:rgba(0,0,0,0.2);"></canvas>
    </div>
    
    <div>
      <div style="color:#39ff14;font-weight:500;margin-bottom:8px;text-align:center;">Processed</div>
      <canvas id="palette-output" 
              style="width:100%;max-height:400px;border:1px solid rgba(57,255,20,0.2);border-radius:8px;background:rgba(0,0,0,0.2);"></canvas>
    </div>
  </div>

  <!-- COLOR STATISTICS -->
  <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:16px;border:1px solid rgba(45,212,255,0.2);margin-bottom:20px;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">ğŸ“ˆ Color Statistics</h4>
    
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;margin-bottom:16px;">
      <div style="text-align:center;padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">
        <div class="small" style="color:var(--accent);">Colors Changed</div>
        <div id="palette-changed-count" style="font-size:24px;font-weight:600;color:#fff;">0</div>
        <div class="small" style="color:rgba(230,250,255,0.6);">pixels</div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">
        <div class="small" style="color:#39ff14;">Change Percentage</div>
        <div id="palette-change-percent" style="font-size:24px;font-weight:600;color:#fff;">0%</div>
        <div class="small" style="color:rgba(230,250,255,0.6);">of image</div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;">
        <div class="small" style="color:#ffa500;">Processing Time</div>
        <div id="palette-time-taken" style="font-size:24px;font-weight:600;color:#fff;">0ms</div>
        <div class="small" style="color:rgba(230,250,255,0.6);">total</div>
      </div>
      
      <div style="text-align:center;padding:12px;background:rgba(157,78,221,0.05);border-radius:8px;">
        <div class="small" style="color:#9d4edd;">Image Size</div>
        <div id="palette-image-size" style="font-size:24px;font-weight:600;color:#fff;">0Ã—0</div>
        <div class="small" style="color:rgba(230,250,255,0.6);">pixels</div>
      </div>
    </div>
    
    <div id="palette-color-chart" style="height:60px;display:none;position:relative;margin-top:12px;">
      <!-- Color distribution chart will be rendered here -->
    </div>
  </div>

  <!-- EXTRACTED COLORS -->
  <div id="palette-extracted-colors" style="display:none;background:rgba(0,0,0,0.2);border-radius:10px;padding:16px;border:1px solid rgba(45,212,255,0.2);margin-bottom:20px;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">ğŸ” Dominant Colors</h4>
    <div id="palette-color-grid" style="display:grid;grid-template-columns:repeat(auto-fill, minmax(80px, 1fr));gap:12px;">
      <!-- Extracted colors will be displayed here -->
    </div>
  </div>

  <!-- ACTIONS -->
  <div style="background:rgba(20,20,20,0.5);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.1);">
    <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(120px, 1fr));gap:10px;margin-bottom:16px;">
      <button onclick="paletteCopyImage()" 
              style="padding:10px;background:rgba(45,212,255,0.05);border:1px solid rgba(45,212,255,0.2);border-radius:8px;color:var(--accent);cursor:pointer;font-size:12px;">
        ğŸ“‹ Copy Image
      </button>
      <button onclick="paletteShareImage()" 
              style="padding:10px;background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.2);border-radius:8px;color:#39ff14;cursor:pointer;font-size:12px;">
        ğŸ“± Share
      </button>
      <button onclick="paletteSavePreset()" 
              style="padding:10px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;cursor:pointer;font-size:12px;">
        ğŸ’¾ Save Preset
      </button>
      <button onclick="paletteUndo()" 
              style="padding:10px;background:rgba(157,78,221,0.05);border:1px solid rgba(157,78,221,0.2);border-radius:8px;color:#9d4edd;cursor:pointer;font-size:12px;">
        â†©ï¸ Undo
      </button>
      <button onclick="paletteRedo()" 
              style="padding:10px;background:rgba(255,77,77,0.05);border:1px solid rgba(255,77,77,0.2);border-radius:8px;color:#ff4d4d;cursor:pointer;font-size:12px;">
        â†ªï¸ Redo
      </button>
      <button onclick="paletteBatchProcess()" 
              style="padding:10px;background:rgba(255,204,0,0.05);border:1px solid rgba(255,204,0,0.2);border-radius:8px;color:#ffcc00;cursor:pointer;font-size:12px;">
        ğŸ”„ Batch Process
      </button>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
      <div id="palette-hint" class="small" style="color:#39ff14;"></div>
      <button onclick="paletteAdvancedOptions()" 
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        âš™ï¸ Advanced
      </button>
    </div>
  </div>
</div>

<!-- COLOR PICKER MODAL -->
<div id="palette-picker-modal" style="display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.8);z-index:10000;align-items:center;justify-content:center;">
  <div style="background:var(--panel);border-radius:12px;padding:20px;max-width:90vw;max-height:90vh;overflow:auto;border:1px solid var(--border);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h4 class="small" style="color:var(--accent);margin:0;">ğŸ‘† Click on the image to pick a color</h4>
      <button onclick="document.getElementById('palette-picker-modal').style.display='none'" 
              style="background:transparent;border:none;color:rgba(230,250,255,0.6);cursor:pointer;font-size:20px;">âœ•</button>
    </div>
    <canvas id="palette-picker-canvas" style="max-width:100%;max-height:60vh;border:1px solid rgba(255,255,255,0.1);border-radius:8px;cursor:crosshair;"></canvas>
    <div style="margin-top:16px;text-align:center;">
      <div id="palette-picked-color" style="display:inline-block;width:40px;height:40px;border-radius:8px;border:2px solid #fff;vertical-align:middle;margin-right:12px;"></div>
      <div style="display:inline-block;vertical-align:middle;">
        <div id="palette-picked-hex" style="color:var(--accent);font-weight:500;font-family:monospace;"></div>
        <div id="palette-picked-rgb" style="font-size:12px;color:rgba(230,250,255,0.7);"></div>
      </div>
      <button onclick="paletteUsePickedColor()" 
              style="margin-left:20px;padding:8px 16px;background:rgba(45,212,255,0.2);border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;">
        Use This Color
      </button>
    </div>
  </div>
</div>

<script>
/* palette-swapper.html
   - Advanced image color manipulation with multiple effects
   - Scoped with palette- prefix
*/

// Global variables
let originalImage = null;
let processedImage = null;
let imageHistory = [];
let historyIndex = -1;
let extractedColors = [];
let colorPairs = [];

// Initialize the palette swapper
function paletteInit() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Setup color pickers
  const fromHex = card.querySelector('#palette-from');
  const fromColor = card.querySelector('#palette-from-color');
  const toHex = card.querySelector('#palette-to');
  const toColor = card.querySelector('#palette-to-color');
  
  // Sync color pickers with hex inputs
  fromHex.addEventListener('input', function() {
    if (this.value.match(/^#[0-9A-F]{6}$/i)) {
      fromColor.value = this.value;
      paletteUpdateColorInfo('from', this.value);
    }
  });
  
  fromColor.addEventListener('input', function() {
    fromHex.value = this.value;
    paletteUpdateColorInfo('from', this.value);
  });
  
  toHex.addEventListener('input', function() {
    if (this.value.match(/^#[0-9A-F]{6}$/i)) {
      toColor.value = this.value;
      paletteUpdateColorInfo('to', this.value);
    }
  });
  
  toColor.addEventListener('input', function() {
    toHex.value = this.value;
    paletteUpdateColorInfo('to', this.value);
  });
  
  // Tolerance slider
  const toleranceSlider = card.querySelector('#palette-tolerance');
  const toleranceValue = card.querySelector('#palette-tolerance-value');
  
  toleranceSlider.addEventListener('input', function() {
    toleranceValue.textContent = this.value + '%';
  });
  
  // Effect controls visibility
  const effectCheckboxes = card.querySelectorAll('input[type="checkbox"][id^="palette-effect-"]');
  effectCheckboxes.forEach(checkbox => {
    checkbox.addEventListener('change', function() {
      const controls = card.querySelector('#palette-effect-controls');
      const anyChecked = Array.from(effectCheckboxes).some(cb => cb.checked);
      controls.style.display = anyChecked ? 'grid' : 'none';
    });
  });
  
  // File upload handler
  const fileInput = card.querySelector('#palette-file');
  fileInput.addEventListener('change', function() {
    if (this.files && this.files[0]) {
      paletteLoadImage(this.files[0]);
    }
  });
  
  // Add initial color pair
  paletteAddColorPair();
  
  console.log('Advanced Palette Swapper initialized');
}

// Update color information display
function paletteUpdateColorInfo(type, hex) {
  const card = document.currentScript?.closest('.card') || document;
  const rgb = paletteHexToRgb(hex);
  const hsl = paletteRgbToHsl(rgb.r, rgb.g, rgb.b);
  
  card.querySelector(`#palette-${type}-rgb`).textContent = 
    `RGB: ${rgb.r}, ${rgb.g}, ${rgb.b}`;
  card.querySelector(`#palette-${type}-hsl`).textContent = 
    `HSL: ${Math.round(hsl.h)}Â°, ${Math.round(hsl.s)}%, ${Math.round(hsl.l)}%`;
}

// Convert hex to RGB
function paletteHexToRgb(hex) {
  const bigint = parseInt(hex.replace('#', ''), 16);
  return {
    r: (bigint >> 16) & 255,
    g: (bigint >> 8) & 255,
    b: bigint & 255
  };
}

// Convert RGB to HSL
function paletteRgbToHsl(r, g, b) {
  r /= 255;
  g /= 255;
  b /= 255;
  
  const max = Math.max(r, g, b);
  const min = Math.min(r, g, b);
  let h, s, l = (max + min) / 2;
  
  if (max === min) {
    h = s = 0; // achromatic
  } else {
    const d = max - min;
    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
    
    switch (max) {
      case r: h = (g - b) / d + (g < b ? 6 : 0); break;
      case g: h = (b - r) / d + 2; break;
      case b: h = (r - g) / d + 4; break;
    }
    
    h /= 6;
  }
  
  return {
    h: h * 360,
    s: s * 100,
    l: l * 100
  };
}

// Load image from file
function paletteLoadImage(file) {
  const card = document.currentScript?.closest('.card') || document;
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const img = new Image();
    img.onload = function() {
      originalImage = img;
      
      // Resize if needed
      const resizeOption = card.querySelector('#palette-resize').value;
      let maxSize = parseInt(resizeOption) || 0;
      
      if (maxSize > 0 && (img.width > maxSize || img.height > maxSize)) {
        const ratio = Math.min(maxSize / img.width, maxSize / img.height);
        const canvas = document.createElement('canvas');
        canvas.width = img.width * ratio;
        canvas.height = img.height * ratio;
        const ctx = canvas.getContext('2d');
        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        
        const resizedImg = new Image();
        resizedImg.onload = function() {
          originalImage = resizedImg;
          paletteDisplayOriginal();
          paletteUpdateFileInfo(file, resizedImg);
        };
        resizedImg.src = canvas.toDataURL();
      } else {
        paletteDisplayOriginal();
        paletteUpdateFileInfo(file, img);
      }
      
      // Clear history for new image
      imageHistory = [];
      historyIndex = -1;
      
      // Show results section
      card.querySelector('#palette-results').style.display = 'block';
      paletteShowMessage('Image loaded successfully', '#39ff14');
    };
    img.src = e.target.result;
  };
  
  reader.readAsDataURL(file);
}

// Display original image
function paletteDisplayOriginal() {
  if (!originalImage) return;
  
  const card = document.currentScript?.closest('.card') || document;
  const canvas = card.querySelector('#palette-original');
  const ctx = canvas.getContext('2d');
  
  canvas.width = originalImage.width;
  canvas.height = originalImage.height;
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.drawImage(originalImage, 0, 0);
}

// Update file information
function paletteUpdateFileInfo(file, img) {
  const card = document.currentScript?.closest('.card') || document;
  const infoDiv =
