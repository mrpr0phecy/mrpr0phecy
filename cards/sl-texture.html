<div class="card" id="texture-card">
  <h2 id="texture-title" style="margin-top:0;">SL Texture Alignment Tool</h2>

  <form aria-describedby="texture-desc">
    <p id="texture-desc" class="small">
      Calculate repeats, offsets, and rotations to align textures across prim faces in Second Life.
      <br>
      <em style="color:#ff9800;">Disclaimer: Results are educational estimates. Always validate in‑world.</em>
    </p>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <div class="field">
        <label for="texWidth">Texture Width (px)</label>
        <input id="texWidth" type="number" min="1" max="4096" value="512" style="width:100%;" />
      </div>
      
      <div class="field">
        <label for="texHeight">Texture Height (px)</label>
        <input id="texHeight" type="number" min="1" max="4096" value="512" style="width:100%;" />
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="primWidth">Prim Face Width (m)</label>
        <input id="primWidth" type="number" min="0.01" max="100" step="0.01" value="1.0" style="width:100%;" />
      </div>
      
      <div class="field">
        <label for="primHeight">Prim Face Height (m)</label>
        <input id="primHeight" type="number" min="0.01" max="100" step="0.01" value="1.0" style="width:100%;" />
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="field">
        <label for="rotation">Desired Rotation (°)</label>
        <input id="rotation" type="number" min="-180" max="180" value="0" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          Use negative values for counter-clockwise rotation
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" onclick="textureCalc(this)" class="primary">Calculate Alignment</button>
      <button type="button" class="secondary" onclick="textureReset(this)">Reset</button>
      <button type="button" onclick="textureCopy(this)">Copy Values</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <h3 class="small">Alignment Values</h3>
    <div id="texResults" style="padding:16px;background:rgba(123, 183, 255, 0.05);border-radius:8px;border:1px solid rgba(123, 183, 255, 0.1);">
      <p style="color:#aaa;text-align:center;margin:20px 0;">Enter values and click Calculate</p>
    </div>
    
    <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
      <div id="texture-hint" class="small" style="opacity:0.9;"></div>
    </div>
  </div>

  <details class="small" style="margin-top:12px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
    <summary style="cursor:pointer;font-weight:500;padding:4px;">How It Works & Formulas</summary>
    <div style="margin-top:8px;padding:4px;border-top:1px solid rgba(255,255,255,0.08);">
      <p style="margin:8px 0;"><strong>Repeat Calculation:</strong></p>
      <ul style="margin:8px 0;padding-left:20px;">
        <li>Repeat X = Prim Width ÷ (Texture Width ÷ 256)</li>
        <li>Repeat Y = Prim Height ÷ (Texture Height ÷ 256)</li>
      </ul>
      <p style="margin:8px 0;"><strong>Texture Scale in SL:</strong> Each 256 pixels = 1 meter in-world</p>
      <p style="margin:8px 0;"><strong>Use in SL:</strong> Enter these values in the Texture tab of the build window</p>
    </div>
  </details>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #7bb7ff;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input:focus {
      outline: none;
      border-color: #7bb7ff;
      box-shadow: 0 0 0 2px rgba(123, 183, 255, 0.2);
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      height: 24px;
      cursor: pointer;
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #4a86e8;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #3a76d8;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .actions button:last-of-type {
      background: #2d5a27;
      color: white;
    }
    
    .actions button:last-of-type:hover {
      background: #3d6a37;
    }
    
    .results h3 {
      color: #7bb7ff;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    #texResults {
      min-height: 150px;
      font-family: monospace;
      font-size: 0.95rem;
      line-height: 1.6;
    }
    
    #texResults h5 {
      color: #ffb74d;
      margin: 0 0 12px 0;
      font-size: 1.1rem;
    }
    
    #texResults p {
      margin: 6px 0;
      padding: 4px 0;
    }
    
    #texResults p strong {
      color: #ddd;
      min-width: 80px;
      display: inline-block;
    }
    
    .note {
      font-size: 0.85rem;
      color: #8bc34a;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid rgba(139, 195, 74, 0.2);
    }
    
    details summary::-webkit-details-marker {
      display: none;
    }
    
    details summary:after {
      content: '▼';
      float: right;
      font-size: 0.75em;
      transition: transform 0.2s ease;
    }
    
    details[open] summary:after {
      transform: rotate(180deg);
    }
    
    .value-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .value-row:last-child {
      border-bottom: none;
    }
  </style>
</div>

<script>
function textureCalc(btn) {
  const card = btn.closest('.card');
  const tw = parseFloat(card.querySelector('#texWidth').value);
  const th = parseFloat(card.querySelector('#texHeight').value);
  const pw = parseFloat(card.querySelector('#primWidth').value);
  const ph = parseFloat(card.querySelector('#primHeight').value);
  const rot = parseFloat(card.querySelector('#rotation').value);

  // Validate inputs
  if (!tw || !th || !pw || !ph || 
      tw < 1 || th < 1 || pw <= 0 || ph <= 0 ||
      tw > 4096 || th > 4096 || pw > 100 || ph > 100) {
    card.querySelector('#texResults').innerHTML = `
      <p style="color:#ff6b6b;text-align:center;">
        ⚠️ Please enter valid values:<br>
        Texture: 1-4096 pixels<br>
        Prim: 0.01-100 meters
      </p>
    `;
    card.querySelector('#texture-hint').textContent = "Invalid input values detected";
    return;
  }

  // Calculate repeats (scale factors)
  const repeatX = (pw / (tw / 256)).toFixed(3);
  const repeatY = (ph / (th / 256)).toFixed(3);
  
  // Offsets (centered by default)
  const offsetX = (0).toFixed(3);
  const offsetY = (0).toFixed(3);
  
  // Calculate texture scale factor
  const textureScale = (tw / 256).toFixed(1);
  
  // Normalized rotation (0-360)
  const normalizedRot = ((rot % 360) + 360) % 360;
  
  // Calculate actual coverage
  const coverageX = (pw / (tw / 256)).toFixed(2);
  const coverageY = (ph / (th / 256)).toFixed(2);

  card.querySelector('#texResults').innerHTML = `
    <h5>Texture Alignment Values</h5>
    <div class="value-row">
      <span><strong>Repeat X:</strong></span>
      <span style="color:#ffb74d;font-weight:600;">${repeatX}</span>
    </div>
    <div class="value-row">
      <span><strong>Repeat Y:</strong></span>
      <span style="color:#ffb74d;font-weight:600;">${repeatY}</span>
    </div>
    <div class="value-row">
      <span><strong>Offset X:</strong></span>
      <span>${offsetX}</span>
    </div>
    <div class="value-row">
      <span><strong>Offset Y:</strong></span>
      <span>${offsetY}</span>
    </div>
    <div class="value-row">
      <span><strong>Rotation:</strong></span>
      <span>${rot}° (${normalizedRot}° normalized)</span>
    </div>
    <div style="margin-top:12px;padding:10px;background:rgba(0,0,0,0.2);border-radius:6px;">
      <p style="margin:4px 0;font-size:0.9em;"><strong>Texture Scale:</strong> ${textureScale} meters per 256px</p>
      <p style="margin:4px 0;font-size:0.9em;"><strong>Coverage:</strong> ${coverageX}× horizontally, ${coverageY}× vertically</p>
    </div>
    <p class="note">Copy these values into the SL build window (Texture tab).</p>
  `;
  
  card.querySelector('#texture-hint').textContent = `Calculated for ${tw}×${th}px texture on ${pw}×${ph}m face`;
}

function textureReset(btn) {
  const card = btn.closest('.card');
  card.querySelector('#texWidth').value = "512";
  card.querySelector('#texHeight').value = "512";
  card.querySelector('#primWidth').value = "1.0";
  card.querySelector('#primHeight').value = "1.0";
  card.querySelector('#rotation').value = "0";
  card.querySelector('#texResults').innerHTML = '<p style="color:#aaa;text-align:center;margin:20px 0;">Enter values and click Calculate</p>';
  card.querySelector('#texture-hint').textContent = "";
}

function textureCopy(btn) {
  const card = btn.closest('.card');
  const results = card.querySelector('#texResults');
  
  if (!results.textContent.includes("Repeat X:")) {
    card.querySelector('#texture-hint').textContent = "Calculate values first";
    return;
  }
  
  // Extract values from results
  const repeatX = results.querySelector('.value-row:nth-child(2) span:nth-child(2)').textContent.trim();
  const repeatY = results.querySelector('.value-row:nth-child(3) span:nth-child(2)').textContent.trim();
  const offsetX = results.querySelector('.value-row:nth-child(4) span:nth-child(2)').textContent.trim();
  const offsetY = results.querySelector('.value-row:nth-child(5) span:nth-child(2)').textContent.trim();
  const rotation = results.querySelector('.value-row:nth-child(6) span:nth-child(2)').textContent.split('°')[0].trim();
  
  const copyText = `Repeat X: ${repeatX}\nRepeat Y: ${repeatY}\nOffset X: ${offsetX}\nOffset Y: ${offsetY}\nRotation: ${rotation}°`;
  
  navigator.clipboard.writeText(copyText).then(() => {
    const hint = card.querySelector('#texture-hint');
    hint.textContent = "Values copied to clipboard!";
    hint.style.color = "#8bc34a";
    setTimeout(() => {
      if (hint.textContent === "Values copied to clipboard!") {
        hint.textContent = "";
      }
    }, 2000);
  }).catch(() => {
    // Fallback
    alert("Copy failed. Please select and copy the values manually.");
  });
}

// Auto-calculate on page load
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('texture-card');
  if (card) {
    setTimeout(() => {
      textureCalc(card.querySelector('button.primary'));
    }, 100);
  }
});

// Auto-calculate on input change
document.addEventListener('input', function(e) {
  if (e.target.closest('.card') && e.target.closest('.card').id === 'texture-card') {
    const card = e.target.closest('.card');
    const calculateBtn = card.querySelector('button.primary');
    // Small delay to avoid too many calculations during typing
    clearTimeout(window.textureCalcTimeout);
    window.textureCalcTimeout = setTimeout(() => {
      textureCalc(calculateBtn);
    }, 300);
  }
});
</script>
