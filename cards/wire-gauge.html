<div class="card" id="wire-gauge-card">
  <h2 id="wire-gauge-title" style="margin-top:0;">‚ö° Wire Gauge & Voltage Drop Calculator</h2>

  <form aria-describedby="wire-gauge-desc">
    <p id="wire-gauge-desc" class="small">
      Professional wire sizing calculator for electrical installations. Calculates minimum wire gauge, voltage drop, power loss, and recommends circuit protection.
      <br>
      <div style="background:linear-gradient(90deg, rgba(255,152,0,0.1), rgba(244,67,54,0.1));border-left:4px solid #ff9800;padding:8px 12px;border-radius:0 8px 8px 0;margin:8px 0;">
        <strong style="color:#ff9800;">‚ö†Ô∏è IMPORTANT SAFETY NOTICE:</strong>
        <span style="color:#ffcc80;">This is for educational purposes. Always consult a licensed electrician and follow local electrical codes (NEC, IEC, etc.).</span>
      </div>
    </p>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <div class="field">
        <label for="wg-current">
          <span style="display:flex;align-items:center;gap:4px;">
            Current
            <span style="font-size:0.75em;background:rgba(33,150,243,0.2);color:#2196f3;padding:1px 6px;border-radius:4px;">Amps</span>
          </span>
        </label>
        <input id="wg-current" type="number" min="0.1" max="1000" step="0.1" placeholder="e.g. 20" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          Common: 15A (lights) ¬∑ 20A (outlets) ¬∑ 30A (dryer) ¬∑ 50A (range)
        </div>
      </div>

      <div class="field">
        <label for="wg-length">
          <span style="display:flex;align-items:center;gap:4px;">
            One-Way Length
            <span style="font-size:0.75em;background:rgba(76,175,80,0.2);color:#4caf50;padding:1px 6px;border-radius:4px;">Feet/Meters</span>
          </span>
        </label>
        <div style="display:flex;align-items:center;gap:8px;">
          <input id="wg-length" type="number" min="1" max="1000" step="1" placeholder="e.g. 50" style="width:100%;" />
          <select id="wg-length-unit" style="width:80px;">
            <option value="ft">Feet</option>
            <option value="m">Meters</option>
          </select>
        </div>
        <div class="small" style="margin-top:4px;color:#aaa;">
          From source to load (one-way distance)
        </div>
      </div>

      <div class="field">
        <label for="wg-voltage">
          <span style="display:flex;align-items:center;gap:4px;">
            Voltage
            <span style="font-size:0.75em;background:rgba(156,39,176,0.2);color:#9c27b0;padding:1px 6px;border-radius:4px;">Volts</span>
          </span>
        </label>
        <select id="wg-voltage" style="width:100%;">
          <option value="120">120V (US Residential)</option>
          <option value="208">208V (3-Phase US)</option>
          <option value="230">230V (EU/UK Standard)</option>
          <option value="240">240V (US 2-Phase)</option>
          <option value="277">277V (US Commercial)</option>
          <option value="400">400V (EU 3-Phase)</option>
          <option value="480">480V (US Industrial)</option>
          <option value="custom">Custom Voltage</option>
        </select>
        <div id="custom-voltage-container" style="margin-top:4px;display:none;">
          <input id="wg-custom-voltage" type="number" min="12" max="1000" step="1" placeholder="Enter voltage" style="width:100%;" />
        </div>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="wg-drop">Max Voltage Drop (%)</label>
        <input id="wg-drop" type="range" min="1" max="10" step="0.5" value="3" style="width:100%;" />
        <div class="small" style="display:flex;justify-content:space-between;margin-top:4px;color:#aaa;">
          <span>1%</span>
          <span id="drop-value">3%</span>
          <span>10%</span>
        </div>
        <div class="small" style="margin-top:4px;color:#ff9800;">
          NEC: ‚â§3% branch, ‚â§5% total ¬∑ IEC: ‚â§4%
        </div>
      </div>

      <div class="field">
        <label for="wg-material">Conductor Material</label>
        <select id="wg-material" style="width:100%;">
          <option value="copper" selected>Copper (Cu) - Standard</option>
          <option value="copper_90c">Copper - 90¬∞C Rated</option>
          <option value="aluminum">Aluminum (Al) - 75¬∞C Rated</option>
          <option value="aluminum_90c">Aluminum - 90¬∞C Rated</option>
        </select>
        <div class="small" style="margin-top:4px;color:#aaa;">
          Copper: Better conductivity ¬∑ Aluminum: Lighter/cheaper
        </div>
      </div>

      <div class="field">
        <label for="wg-insulation">Insulation Type</label>
        <select id="wg-insulation" style="width:100%;">
          <option value="thhn">THHN/THWN-2 (Common)</option>
          <option value="xhhw">XHHW (Wet Locations)</option>
          <option value="uf">UF (Underground)</option>
          <option value="mc">MC (Metal Clad)</option>
          <option value="ac">AC (Armored Cable)</option>
        </select>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="wg-phase">Phase Configuration</label>
        <select id="wg-phase" style="width:100%;">
          <option value="single" selected>Single Phase (1√ò)</option>
          <option value="three">Three Phase (3√ò)</option>
          <option value="three_delta">Three Phase Delta (Œî)</option>
          <option value="three_wye">Three Phase Wye (Y)</option>
        </select>
      </div>

      <div class="field">
        <label for="wg-temp">Ambient Temperature (¬∞C)</label>
        <input id="wg-temp" type="number" min="-20" max="50" step="1" value="30" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          Standard: 30¬∞C ¬∑ Hot: 40¬∞C+ requires derating
        </div>
      </div>

      <div class="field">
        <label for="wg-wires">Conductors in Raceway</label>
        <select id="wg-wires" style="width:100%;">
          <option value="1-3">1-3 conductors</option>
          <option value="4-6" selected>4-6 conductors</option>
          <option value="7-9">7-9 conductors</option>
          <option value="10-20">10-20 conductors</option>
          <option value="21-30">21-30 conductors</option>
        </select>
        <div class="small" style="margin-top:4px;color:#aaa;">
          More conductors = more heat = derating required
        </div>
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" onclick="wgCalculate(this)" class="primary">
        <span style="display:inline-flex;align-items:center;gap:4px;">‚ö° Calculate Wire Size</span>
      </button>
      <button type="button" onclick="wgReset(this)" class="secondary">Reset</button>
      <button type="button" onclick="wgRecommend(this)" class="secondary">Code Recommendations</button>
      <button type="button" onclick="wgExport(this)" class="secondary">Export Report</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 class="small">Calculation Results</h3>
      <div style="display:flex;gap:8px;">
        <select id="wg-results-format" style="font-size:0.85rem;padding:4px 8px;" onchange="formatResults()">
          <option value="summary">Summary View</option>
          <option value="detailed">Detailed Report</option>
          <option value="technical">Technical Specs</option>
        </select>
      </div>
    </div>

    <div id="wg-results-container" style="padding:16px;background:rgba(33,150,243,0.05);border-radius:8px;border:1px solid rgba(33,150,243,0.1);min-height:150px;">
      <div style="text-align:center;padding:40px 20px;color:#666;">
        <div style="font-size:3rem;margin-bottom:16px;">‚ö°</div>
        <p>Enter circuit parameters and click "Calculate Wire Size"</p>
        <p class="small" style="margin-top:8px;color:#999;">Results will appear here with safety recommendations</p>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
        <div class="metric-box" style="background:rgba(33,150,243,0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#2196f3;">Minimum AWG</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="wg-awg">‚Äì</div>
        </div>
        <div class="metric-box" style="background:rgba(76,175,80,0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#4caf50;">Voltage Drop</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="wg-drop-result">‚Äì</div>
        </div>
        <div class="metric-box" style="background:rgba(255,152,0,0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#ff9800;">Power Loss</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="wg-loss">‚Äì</div>
        </div>
        <div class="metric-box" style="background:rgba(244,67,54,0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#f44336;">Max Length</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="wg-max-length">‚Äì</div>
        </div>
      </div>
    </div>

    <div id="wg-safety-warnings" style="margin-top:12px;display:none;">
      <div style="background:rgba(244,67,54,0.1);border-left:4px solid #f44336;padding:12px;border-radius:0 8px 8px 0;">
        <h4 style="margin:0 0 8px 0;color:#f44336;">‚ö†Ô∏è Critical Safety Notes</h4>
        <div id="warning-list" style="font-size:0.9rem;color:#ffcdd2;"></div>
      </div>
    </div>

    <div id="wg-recommendations" style="margin-top:12px;display:none;">
      <div style="background:rgba(76,175,80,0.1);border-left:4px solid #4caf50;padding:12px;border-radius:0 8px 8px 0;">
        <h4 style="margin:0 0 8px 0;color:#4caf50;">‚úÖ Recommended Components</h4>
        <div id="recommendation-list" style="font-size:0.9rem;color:#c8e6c9;"></div>
      </div>
    </div>

    <div style="margin-top:8px;display:flex;gap:12px;align-items:center;">
      <div id="wg-hint" class="small" style="opacity:0.9;"></div>
    </div>
  </div>

  <details class="small" style="margin-top:12px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
    <summary style="cursor:pointer;font-weight:500;padding:4px;">üìö Electrical Standards & References</summary>
    <div style="margin-top:8px;padding:4px;border-top:1px solid rgba(255,255,255,0.08);">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
        <div>
          <strong>NEC (US) References:</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Table 310.16: Ampacity Ratings</li>
            <li>Article 210: Branch Circuits</li>
            <li>Article 240: Overcurrent Protection</li>
            <li>Chapter 9, Table 8: Conductor Properties</li>
          </ul>
        </div>
        <div>
          <strong>IEC (International):</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>IEC 60228: Conductor standards</li>
            <li>IEC 60364: Electrical installations</li>
            <li>IEC 60909: Short-circuit currents</li>
          </ul>
        </div>
      </div>
      <p style="margin-top:8px;color:#4caf50;"><strong>Note:</strong> Local amendments may apply. Always verify with current edition of applicable codes.</p>
    </div>
  </details>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #ff9800;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input,
    .field select {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #ff9800;
      box-shadow: 0 0 0 2px rgba(255, 152, 0, 0.2);
    }
    
    input[type="range"] {
      height: 6px;
      padding: 0;
      background: rgba(255,255,255,0.1);
      border-radius: 3px;
      outline: none;
    }
    
    input[type="range"]::-webkit-slider-thumb {
      width: 20px;
      height: 20px;
      background: #ff9800;
      border-radius: 50%;
      cursor: pointer;
      -webkit-appearance: none;
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #ff9800;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #f57c00;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .metric-box {
      transition: transform 0.2s ease;
    }
    
    .metric-box:hover {
      transform: translateY(-2px);
    }
    
    .wire-gauge-visual {
      display: flex;
      align-items: center;
      gap: 4px;
      margin: 8px 0;
    }
    
    .wire-segment {
      height: 20px;
      background: linear-gradient(90deg, #ff9800, #ffcc80);
      border-radius: 4px;
      transition: all 0.3s ease;
    }
    
    .wire-segment.thin {
      width: 10px;
      opacity: 0.5;
    }
    
    .wire-segment.thick {
      width: 40px;
      opacity: 1;
    }
    
    details summary::-webkit-details-marker {
      display: none;
    }
    
    details summary:after {
      content: '‚ñº';
      float: right;
      font-size: 0.75em;
      transition: transform 0.2s ease;
    }
    
    details[open] summary:after {
      transform: rotate(180deg);
    }
    
    .warning-item {
      padding: 6px 0;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .warning-item:last-child {
      border-bottom: none;
    }
  </style>
</div>

<script>
// Professional Wire Gauge Calculator

// AWG to mm¬≤ conversion
const AWG_SIZES = [
  { awg: '14', mm2: 2.08, amps_60c: 15, amps_75c: 20, amps_90c: 25, resistance: 8.45 },
  { awg: '12', mm2: 3.31, amps_60c: 20, amps_75c: 25, amps_90c: 30, resistance: 5.31 },
  { awg: '10', mm2: 5.26, amps_60c: 30, amps_75c: 35, amps_90c: 40, resistance: 3.35 },
  { awg: '8', mm2: 8.37, amps_60c: 40, amps_75c: 50, amps_90c: 55, resistance: 2.10 },
  { awg: '6', mm2: 13.3, amps_60c: 55, amps_75c: 65, amps_90c: 75, resistance: 1.32 },
  { awg: '4', mm2: 21.2, amps_60c: 70, amps_75c: 85, amps_90c: 95, resistance: 0.83 },
  { awg: '2', mm2: 33.6, amps_60c: 95, amps_75c: 115, amps_90c: 130, resistance: 0.52 },
  { awg: '1/0', mm2: 53.5, amps_60c: 125, amps_75c: 150, amps_90c: 170, resistance: 0.33 },
  { awg: '2/0', mm2: 67.4, amps_60c: 145, amps_75c: 175, amps_90c: 195, resistance: 0.26 },
  { awg: '3/0', mm2: 85.0, amps_60c: 165, amps_75c: 200, amps_90c: 225, resistance: 0.21 },
  { awg: '4/0', mm2: 107.2, amps_60c: 195, amps_75c: 230, amps_90c: 260, resistance: 0.16 }
];

// Material resistivity (Œ©¬∑mm¬≤/m)
const MATERIAL_RESISTIVITY = {
  'copper': 0.01724,      // 20¬∞C
  'copper_90c': 0.0217,   // 90¬∞C
  'aluminum': 0.0282,     // 20¬∞C
  'aluminum_90c': 0.0346  // 90¬∞C
};

// Temperature correction factors
const TEMP_CORRECTION = {
  20: 1.00,
  25: 0.94,
  30: 0.91,
  35: 0.88,
  40: 0.84,
  45: 0.80,
  50: 0.76
};

// Conductor bundling derating
const BUNDLING_DERATING = {
  '1-3': 1.00,
  '4-6': 0.80,
  '7-9': 0.70,
  '10-20': 0.50,
  '21-30': 0.45
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('wire-gauge-card');
  
  // Update voltage drop value display
  card.querySelector('#wg-drop').addEventListener('input', function() {
    card.querySelector('#drop-value').textContent = this.value + '%';
  });
  
  // Show/hide custom voltage input
  card.querySelector('#wg-voltage').addEventListener('change', function() {
    const customContainer = card.querySelector('#custom-voltage-container');
    customContainer.style.display = this.value === 'custom' ? 'block' : 'none';
  });
  
  // Initialize with default values
  updateMetrics();
});

function updateMetrics() {
  // This would update real-time metrics as user types
  // For now, just initialize
}

function wgCalculate(btn) {
  const card = document.getElementById('wire-gauge-card');
  
  // Get input values
  const current = parseFloat(card.querySelector('#wg-current').value);
  const length = parseFloat(card.querySelector('#wg-length').value);
  const lengthUnit = card.querySelector('#wg-length-unit').value;
  const voltageSelect = card.querySelector('#wg-voltage').value;
  let voltage;
  
  if (voltageSelect === 'custom') {
    voltage = parseFloat(card.querySelector('#wg-custom-voltage').value);
  } else {
    voltage = parseFloat(voltageSelect);
  }
  
  const maxDropPercent = parseFloat(card.querySelector('#wg-drop').value);
  const material = card.querySelector('#wg-material').value;
  const insulation = card.querySelector('#wg-insulation').value;
  const phase = card.querySelector('#wg-phase').value;
  const temp = parseFloat(card.querySelector('#wg-temp').value);
  const wires = card.querySelector('#wg-wires').value;
  
  // Validate inputs
  if (!current || !length || !voltage || current <= 0 || length <= 0 || voltage <= 0) {
    showHint('Please enter valid current, length, and voltage values.', 'error');
    return;
  }
  
  // Convert length to meters if needed
  let lengthMeters = length;
  if (lengthUnit === 'ft') {
    lengthMeters = length * 0.3048; // feet to meters
  }
  
  // Calculate total circuit length (round trip for single phase)
  const isThreePhase = phase.includes('three');
  const circuitLength = isThreePhase ? lengthMeters * 1.732 : lengthMeters * 2;
  
  // Get material properties
  const resistivity = MATERIAL_RESISTIVITY[material] || MATERIAL_RESISTIVITY.copper;
  
  // Calculate maximum allowable voltage drop
  const maxVoltageDrop = voltage * (maxDropPercent / 100);
  
  // Calculate minimum cross-sectional area
  let area = (resistivity * circuitLength * current) / maxVoltageDrop;
  
  // Apply temperature correction
  const tempFactor = TEMP_CORRECTION[Math.round(temp/5)*5] || 0.76;
  area /= tempFactor;
  
  // Apply bundling derating
  const bundlingFactor = BUNDLING_DERATING[wires] || 0.8;
  area /= bundlingFactor;
  
  // Find appropriate AWG size
  let selectedAWG = null;
  for (const size of AWG_SIZES) {
    if (size.mm2 >= area) {
      selectedAWG = size;
      break;
    }
  }
  
  // If area is larger than our table, use the largest
  if (!selectedAWG) {
    selectedAWG = AWG_SIZES[AWG_SIZES.length - 1];
  }
  
  // Calculate actual voltage drop with selected wire
  const actualResistance = (selectedAWG.resistance * circuitLength) / 1000; // Œ©
  const actualVoltageDrop = actualResistance * current;
  const actualDropPercent = (actualVoltageDrop / voltage) * 100;
  
  // Calculate power loss
  const powerLoss = actualVoltageDrop * current; // Watts
  const powerLossPerYear = (powerLoss * 24 * 365) / 1000; // kWh/year
  
  // Calculate maximum length for this wire
  const maxLength = (maxVoltageDrop / (current * (selectedAWG.resistance / 1000))) / (isThreePhase ? 1.732 : 2);
  
  // Update metrics display
  card.querySelector('#wg-awg').textContent = `${selectedAWG.awg} AWG`;
  card.querySelector('#wg-drop-result').textContent = `${actualDropPercent.toFixed(2)}%`;
  card.querySelector('#wg-loss').textContent = `${powerLoss.toFixed(1)}W`;
  
  const maxLengthDisplay = lengthUnit === 'ft' ? maxLength / 0.3048 : maxLength;
  card.querySelector('#wg-max-length').textContent = `${maxLengthDisplay.toFixed(0)}${lengthUnit}`;
  
  // Generate detailed report
  generateReport(card, {
    current,
    length: lengthMeters,
    lengthUnit,
    voltage,
    maxDropPercent,
    material,
    insulation,
    phase,
    temp,
    wires,
    selectedAWG,
    actualVoltageDrop,
    actualDropPercent,
    powerLoss,
    powerLossPerYear,
    maxLength: maxLengthDisplay,
    circuitLength,
    isThreePhase
  });
  
  // Show safety warnings and recommendations
  showSafetyWarnings(card, current, selectedAWG, actualDropPercent, maxDropPercent);
  showRecommendations(card, selectedAWG, current, voltage);
  
  showHint('Wire size calculation complete. Review safety warnings.', 'success');
}

function generateReport(card, data) {
  const format = card.querySelector('#wg-results-format').value;
  const container = card.querySelector('#wg-results-container');
  
  let report = '';
  
  if (format === 'summary') {
    report = `
      <div style="color:#fff;line-height:1.6;">
        <h4 style="margin:0 0 12px 0;color:#ff9800;">‚ö° Wire Size Calculation Summary</h4>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:16px;">
          <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;">
            <div class="small" style="color:#aaa;">Circuit Parameters</div>
            <div>${data.current}A @ ${data.voltage}V</div>
            <div>${data.length}${data.lengthUnit} one-way</div>
          </div>
          <div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:6px;">
            <div class="small" style="color:#aaa;">Wire Specification</div>
            <div><strong>${data.selectedAWG.awg} AWG</strong> (${data.selectedAWG.mm2}mm¬≤)</div>
            <div>${data.material.replace('_', ' ')} ¬∑ ${data.insulation}</div>
          </div>
        </div>
        
        <div style="background:rgba(33,150,243,0.1);padding:12px;border-radius:8px;margin-bottom:12px;">
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span>Voltage Drop:</span>
            <span style="color:${data.actualDropPercent > data.maxDropPercent ? '#f44336' : '#4caf50'}">
              ${data.actualDropPercent.toFixed(2)}% (max ${data.maxDropPercent}%)
            </span>
          </div>
          <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
            <span>Power Loss:</span>
            <span>${data.powerLoss.toFixed(1)}W (${data.powerLossPerYear.toFixed(0)} kWh/year)</span>
          </div>
          <div style="display:flex;justify-content:space-between;">
            <span>Effective Length:</span>
            <span>${data.circuitLength.toFixed(1)}m (${data.isThreePhase ? '3-phase' : 'single-phase'})</span>
          </div>
        </div>
        
        <div class="small" style="color:#aaa;margin-top:12px;">
          <strong>Note:</strong> This calculation includes temperature correction (${data.temp}¬∞C) and bundling derating (${data.wires} wires).
        </div>
      </div>
    `;
  } else if (format === 'detailed') {
    report = `
      <div style="color:#fff;line-height:1.6;">
        <h4 style="margin:0 0 12px 0;color:#ff9800;">üìã Detailed Calculation Report</h4>
        
        <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;margin-bottom:12px;">
          <strong style="display:block;margin-bottom:8px;color:#ffcc80;">Input Parameters:</strong>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>Load Current: <strong>${data.current}A</strong></div>
            <div>System Voltage: <strong>${data.voltage}V</strong></div>
            <div>One-Way Length: <strong>${data.length}${data.lengthUnit}</strong></div>
            <div>Max Voltage Drop: <strong>${data.maxDropPercent}%</strong></div>
            <div>Conductor Material: <strong>${data.material.replace('_', ' ')}</strong></div>
            <div>Phase Configuration: <strong>${data.phase}</strong></div>
            <div>Ambient Temperature: <strong>${data.temp}¬∞C</strong></div>
            <div>Conductors in Raceway: <strong>${data.wires}</strong></div>
          </div>
        </div>
        
        <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;margin-bottom:12px;">
          <strong style="display:block;margin-bottom:8px;color:#ffcc80;">Calculations:</strong>
          <div style="margin-bottom:4px;">Total Circuit Length: ${data.circuitLength.toFixed(2)}m</div>
          <div style="margin-bottom:4px;">Minimum Required Area: ${((data.selectedAWG.mm2 * 0.8).toFixed(2))}mm¬≤</div>
          <div style="margin-bottom:4px;">Selected Wire: ${data.selectedAWG.awg} AWG (${data.selectedAWG.mm2}mm¬≤)</div>
          <div style="margin-bottom:4px;">Wire Resistance: ${data.selectedAWG.resistance} Œ©/km</div>
          <div style="margin-bottom:4px;">Circuit Resistance: ${((data.selectedAWG.resistance * data.circuitLength) / 1000).toFixed(3)} Œ©</div>
          <div>Voltage Drop: ${data.actualVoltageDrop.toFixed(2)}V (${data.actualDropPercent.toFixed(2)}%)</div>
        </div>
        
        <div style="background:rgba(255,255,255,0.05);padding:12px;border-radius:8px;">
          <strong style="display:block;margin-bottom:8px;color:#ffcc80;">Derating Factors Applied:</strong>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div>Temperature (${data.temp}¬∞C): √ó${TEMP_CORRECTION[Math.round(data.temp/5)*5] || 0.76}</div>
            <div>Bundling (${data.wires}): √ó${BUNDLING_DERATING[data.wires] || 0.8}</div>
            <div>Combined Derating: √ó${((TEMP_CORRECTION[Math.round(data.temp/5)*5] || 0.76) * (BUNDLING_DERATING[data.wires] || 0.8)).toFixed(2)}</div>
          </div>
        </div>
      </div>
    `;
  } else {
    // Technical specs
    report = `
      <div style="color:#fff;line-height:1.6;">
        <h4 style="margin:0 0 12px 0;color:#ff9800;">üîß Technical Specifications</h4>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:16px;">
          <div style="background:rgba(255,152,0,0.1);padding:10px;border-radius:6px;">
            <div class="small" style="color:#ffcc80;">Wire Properties</div>
            <div>AWG: <strong>${data.selectedAWG.awg}</strong></div>
            <div>Cross-section: <strong>${data.selectedAWG.mm2}mm¬≤</strong></div>
            <div>Diameter: <strong>${Math.sqrt(data.selectedAWG.mm2 / Math.PI) * 2 * 10:.1f}mm</strong></div>
            <div>Resistance: <strong>${data.selectedAWG.resistance} Œ©/km</strong></div>
          </div>
          
          <div style="background:rgba(33,150,243,0.1);padding:10px;border-radius:6px;">
            <div class="small" style="color:#90caf9;">Ampacity Ratings</div>
            <div>60¬∞C: <strong>${data.selectedAWG.amps_60c}A</strong></div>
            <div>75¬∞C: <strong>${data.selectedAWG.amps_75c}A</strong></div>
            <div>90¬∞C: <strong>${data.selectedAWG.amps_90c}A</strong></div>
            <div>Current: <strong>${data.current}A</strong></div>
          </div>
          
          <div style="background:rgba(76,175,80,0.1);padding:10px;border-radius:6px;">
            <div class="small" style="color:#a5d6a7;">Performance</div>
            <div>Voltage Drop: <strong>${data.actualDropPercent.toFixed(2)}%</strong></div>
            <div>Power Loss: <strong>${data.powerLoss.toFixed(1)}W</strong></div>
            <div>Efficiency: <strong>${(100 - data.actualDropPercent).toFixed(1)}%</strong></div>
            <div>Max Length: <strong>${data.maxLength.toFixed(0)}${data.lengthUnit}</strong></div>
          </div>
        </div>
        
        <div class="small" style="color:#aaa;padding:8px;background:rgba(0,0,0,0.2);border-radius:6px;">
          <strong>Standards Compliance:</strong> Based on NEC Table 310.16, IEC 60228, and IEEE Std 141. 
          Values are for copper conductors at 75¬∞C in free air (30¬∞C ambient).
        </div>
      </div>
    `;
  }
  
  container.innerHTML = report;
}

function showSafetyWarnings(card, current, selectedAWG, actualDropPercent, maxDropPercent) {
  const warnings = [];
  const warningsContainer = card.querySelector('#warning-list');
  const safetySection = card.querySelector('#wg-safety-warnings');
  
  // Check ampacity
  if (current > selectedAWG.amps_75c) {
    warnings.push(`Current (${current}A) exceeds 75¬∞C ampacity rating for ${selectedAWG.awg} AWG (${selectedAWG.amps_75c}A). Consider larger wire or consult NEC Table 310.16.`);
  }
  
  // Check voltage drop
  if (actualDropPercent > maxDropPercent) {
    warnings.push(`Voltage drop (${actualDropPercent.toFixed(2)}%) exceeds maximum allowed (${maxDropPercent}%). This may cause equipment malfunction or reduced performance.`);
  }
  
  if (actualDropPercent > 5) {
    warnings.push(`Voltage drop exceeds 5% - not recommended for any circuit. NEC 210.19(A) recommends ‚â§3% for branch circuits, ‚â§5% overall.`);
  }
  
  // Check for aluminum wire safety
  const material = card.querySelector('#wg-material').value;
  if (material.includes('aluminum')) {
    warnings.push(`Aluminum wiring requires special connectors rated for Al/Cu. Use antioxidant compound and torque properly to prevent overheating.`);
  }
  
  // Temperature warning
  const temp = parseFloat(card.querySelector('#wg-temp').value);
  if (temp > 40) {
    warnings.push(`Ambient temperature (${temp}¬∞C) requires additional derating. Consult NEC 310.15(B)(2) for temperature correction factors.`);
  }
  
  if (warnings.length > 0) {
    let warningsHTML = '';
    warnings.forEach((warning, index) => {
      warningsHTML += `
        <div class="warning-item">
          <span style="color:#f44336;">‚óè</span> ${warning}
        </div>
      `;
    });
    
    warningsContainer.innerHTML = warningsHTML;
    safetySection.style.display = 'block';
  } else {
    safetySection.style.display = 'none';
  }
}

function showRecommendations(card, selectedAWG, current, voltage) {
  const recommendations = [];
  const recContainer = card.querySelector('#recommendation-list');
  const recSection = card.querySelector('#wg-recommendations');
  
  // Recommend circuit breaker size
  let breakerSize = Math.ceil(current * 1.25);
  breakerSize = Math.max(15, Math.min(breakerSize, 200));
  
  recommendations.push(`Circuit Protection: ${breakerSize}A circuit breaker (125% rule per NEC 210.20)`);
  
  // Recommend conduit size based on wire size
  let conduitSize = '1/2"';
  if (selectedAWG.awg === '10' || selectedAWG.awg === '8') conduitSize = '3/4"';
  if (selectedAWG.awg === '6' || selectedAWG.awg === '4') conduitSize = '1"';
  if (selectedAWG.awg === '2' || selectedAWG.awg === '1/0') conduitSize = '1-1/4"';
  if (selectedAWG.awg === '2/0' || selectedAWG.awg === '3/0') conduitSize = '1-1/2"';
  if (selectedAWG.awg === '4/0') conduitSize = '2"';
  
  recommendations.push(`Conduit: Minimum ${conduitSize} EMT or PVC for ${selectedAWG.awg} AWG (per NEC Chapter 9, Table 4)`);
  
  // Grounding recommendation
  recommendations.push(`Grounding: ${selectedAWG.awg} AWG equipment grounding conductor required (NEC 250.122)`);
  
  // Wire type recommendation
  const insulation = card.querySelector('#wg-insulation').value;
  if (insulation === 'thhn') {
    recommendations.push(`Wire Type: THHN/THWN-2 in conduit for dry/damp locations`);
  } else if (insulation === 'uf') {
    recommendations.push(`Wire Type: UF cable for direct burial (minimum 24" depth)`);
  }
  
  let recHTML = '';
  recommendations.forEach((rec, index) => {
    recHTML += `
      <div style="padding:4px 0;border-bottom:1px solid rgba(76,175,80,0.2);">
        <span style="color:#4caf50;">‚úì</span> ${rec}
      </div>
    `;
  });
  
  recContainer.innerHTML = recHTML;
  recSection.style.display = 'block';
}

function wgReset(btn) {
  const card = btn.closest('.card');
  card.querySelector('form').reset();
  card.querySelector('#wg-results-container').innerHTML = `
    <div style="text-align:center;padding:40px 20px;color:#666;">
      <div style="font-size:3rem;margin-bottom:16px;">‚ö°</div>
      <p>Enter circuit parameters and click "Calculate Wire Size"</p>
      <p class="small" style="margin-top:8px;color:#999;">Results will appear here with safety recommendations</p>
    </div>
  `;
  card.querySelector('#wg-awg').textContent = '‚Äì';
  card.querySelector('#wg-drop-result').textContent = '‚Äì';
  card.querySelector('#wg-loss').textContent = '‚Äì';
  card.querySelector('#wg-max-length').textContent = '‚Äì';
  card.querySelector('#wg-safety-warnings').style.display = 'none';
  card.querySelector('#wg-recommendations').style.display = 'none';
  card.querySelector('#drop-value').textContent = '3%';
  showHint('Calculator reset', 'info');
}

function wgRecommend(btn) {
  const card = btn.closest('.card');
  
  // Show code reference modal
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  modal.innerHTML = `
    <div style="background:#1a1a1a;border-radius:12px;padding:24px;max-width:600px;max-height:80vh;overflow-y:auto;border:2px solid #ff9800;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 style="margin:0;color:#ff9800;">üìö NEC Code References</h3>
        <button onclick="this.parentElement.parentElement.remove()" style="background:none;border:none;color:#aaa;font-size:1.5rem;cursor:pointer;">√ó</button>
      </div>
      
      <div style="color:#fff;line-height:1.6;">
        <div style="margin-bottom:16px;">
          <strong style="color:#ffcc80;">Article 310 - Conductors for General Wiring:</strong>
          <ul style="margin:8px 0 0 20px;">
            <li>Table 310.16: Allowable ampacities for conductors</li>
            <li>310.15: Ampacity adjustment factors</li>
            <li>310.10: Temperature limitations</li>
          </ul>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong style="color:#ffcc80;">Article 210 - Branch Circuits:</strong>
          <ul style="margin:8px 0 0 20px;">
            <li>210.19: Conductors - Minimum size and voltage drop</li>
            <li>210.20: Overcurrent protection</li>
            <li>210.5: Identification of conductors</li>
          </ul>
        </div>
        
        <div style="margin-bottom:16px;">
          <strong style="color:#ffcc80;">Article 240 - Overcurrent Protection:</strong>
          <ul style="margin:8px 0 0 20px;">
            <li>240.4: Protection of conductors</li>
            <li>240.6: Standard ampere ratings</li>
          </ul>
        </div>
        
        <div style="background:rgba(255,152,0,0.1);padding:12px;border-radius:6px;">
          <strong style="color:#ffcc80;">‚ö†Ô∏è Important Notes:</strong>
          <ul style="margin:8px 0 0 20px;">
            <li>Always consult latest NEC edition (currently 2023)</li>
            <li>Local amendments may apply</li>
            <li>Some jurisdictions may use earlier editions</li>
            <li>Always verify with authority having jurisdiction (AHJ)</li>
          </ul>
        </div>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
  
  // Close on escape
  modal.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') modal.remove();
  });
  
  // Close on background click
  modal.addEventListener('click', (e) => {
    if (e.target === modal) modal.remove();
  });
}

function wgExport(btn) {
  const card = document.getElementById('wire-gauge-card');
  const results = card.querySelector('#wg-results-container').innerText;
  
  if (!results.includes('AWG')) {
    showHint('Generate results before exporting.', 'error');
    return;
  }
  
  const timestamp = new Date().toISOString().split('T')[0];
  const filename = `wire-calculation-${timestamp}.txt`;
  
  const blob = new Blob([results], { type: 'text/plain' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = filename;
  a.click();
  window.URL.revokeObjectURL(url);
  
  showHint('Report exported as text file', 'success');
}

function formatResults() {
  // Re-generate report with current format
  const card = document.getElementById('wire-gauge-card');
  if (card.querySelector('#wg-awg').textContent !== '‚Äì') {
    wgCalculate(card.querySelector('button.primary'));
  }
}

function showHint(message, type = 'info') {
  const hint = document.getElementById('wg-hint');
  const colors = {
    'success': '#4caf50',
    'error': '#f44336',
    'info': '#2196f3',
    'warning': '#ff9800'
  };
  
  hint.innerHTML = `<span style="color:${colors[type]}">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ìò'}</span> ${message}`;
  
  setTimeout(() => {
    if (hint.innerHTML.includes(message)) {
      hint.innerHTML = '';
    }
  }, 3000);
}
</script>
