<div class="card" id="subscription-card">
  <h2 id="subscription-title" style="margin-top:0;">Subscription Tracker</h2>

  <form aria-describedby="subscription-desc">
    <p id="subscription-desc" class="small">
      Track all your subscriptions, manage renewal dates, analyze costs, and optimize spending.
      <br>
      <em style="color:#ff9800;">Data is saved locally in your browser.</em>
    </p>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
      <div class="field">
        <label for="subscription-name">Service Name</label>
        <input id="subscription-name" type="text" placeholder="e.g., Netflix, Spotify" style="width:100%;" />
      </div>

      <div class="field">
        <label for="subscription-cost">Cost</label>
        <div style="display:flex;align-items:center;gap:8px;">
          <select id="subscription-currency" style="width:60px;">
            <option value="GBP">¬£</option>
            <option value="USD">$</option>
            <option value="EUR">‚Ç¨</option>
            <option value="CAD">C$</option>
            <option value="AUD">A$</option>
          </select>
          <input id="subscription-cost" type="number" min="0" max="1000" step="0.01" style="width:100%;" />
          <select id="subscription-cycle" style="width:90px;">
            <option value="monthly">/month</option>
            <option value="yearly">/year</option>
            <option value="quarterly">/quarter</option>
            <option value="weekly">/week</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label for="subscription-date">Next Renewal</label>
        <input id="subscription-date" type="date" style="width:100%;" />
        <div class="small" style="margin-top:4px;color:#aaa;">
          <span id="days-until">0</span> days until renewal
        </div>
      </div>
    </div>

    <div class="row" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-top:12px;">
      <div class="field">
        <label for="subscription-category">Category</label>
        <select id="subscription-category" style="width:100%;">
          <option value="entertainment">üé¨ Entertainment</option>
          <option value="productivity">üíº Productivity</option>
          <option value="cloud">‚òÅÔ∏è Cloud Storage</option>
          <option value="software">üíª Software</option>
          <option value="fitness">üèãÔ∏è Fitness</option>
          <option value="news">üì∞ News/Magazines</option>
          <option value="food">üçï Food Delivery</option>
          <option value="other">üîß Other</option>
        </select>
      </div>

      <div class="field">
        <label for="subscription-status">Status</label>
        <select id="subscription-status" style="width:100%;">
          <option value="active" selected>‚úÖ Active</option>
          <option value="pending">‚è∞ Pending Cancellation</option>
          <option value="cancelled">‚ùå Cancelled</option>
          <option value="trial">üÜì Free Trial</option>
        </select>
      </div>

      <div class="field">
        <label for="subscription-notes">Notes (Optional)</label>
        <input id="subscription-notes" type="text" placeholder="e.g., Annual plan, Family sharing" style="width:100%;" />
      </div>
    </div>

    <div class="actions" style="margin-top:12px;display:flex;gap:8px;">
      <button type="button" onclick="subscriptionAdd(this)" class="primary">Add Subscription</button>
      <button type="button" onclick="subscriptionQuickAdd(this)" class="secondary">Quick Add</button>
      <button type="button" onclick="subscriptionReset(this)" class="secondary">Clear Form</button>
      <button type="button" onclick="subscriptionExport(this)" class="secondary">Export Data</button>
    </div>
  </form>

  <div class="results" aria-live="polite" style="margin-top:12px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <h3 class="small">Your Subscriptions</h3>
      <div style="display:flex;gap:8px;">
        <select id="subscription-filter" style="font-size:0.85rem;padding:4px 8px;" onchange="filterSubscriptions()">
          <option value="all">All Subscriptions</option>
          <option value="active">Active Only</option>
          <option value="upcoming">Upcoming Renewals</option>
          <option value="expensive">Most Expensive</option>
          <option value="category">By Category</option>
        </select>
        <button type="button" onclick="sortSubscriptions()" class="small" style="padding:4px 8px;">Sort by Cost</button>
      </div>
    </div>

    <div id="subscription-list" style="max-height:300px;overflow-y:auto;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
      <p style="text-align:center;color:#aaa;padding:20px;">No subscriptions added yet.</p>
    </div>

    <div style="margin-top:12px;">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
        <div class="metric-box" style="background:rgba(33, 150, 243, 0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#2196f3;">Monthly Total</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="subscription-monthly">¬£0.00</div>
        </div>
        <div class="metric-box" style="background:rgba(244, 67, 54, 0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#f44336;">Yearly Total</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="subscription-yearly">¬£0.00</div>
        </div>
        <div class="metric-box" style="background:rgba(76, 175, 80, 0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#4caf50;">Active Subs</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="subscription-count">0</div>
        </div>
        <div class="metric-box" style="background:rgba(255, 152, 0, 0.1);border-radius:8px;padding:12px;text-align:center;">
          <div class="small" style="margin-bottom:4px;color:#ff9800;">Next Renewal</div>
          <div class="value" style="font-size:1.5rem;font-weight:600;" id="subscription-next">‚Äì</div>
        </div>
      </div>
    </div>

    <div style="margin-top:12px;">
      <div class="progress-container" style="margin-bottom:4px;">
        <div class="progress-label" style="display:flex;justify-content:space-between;font-size:0.85rem;margin-bottom:4px;">
          <span>Monthly Spending Breakdown</span>
          <span id="breakdown-text">¬£0.00 total</span>
        </div>
        <div id="category-breakdown" style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;display:flex;">
          <!-- Categories will be added here -->
        </div>
        <div id="category-labels" style="display:flex;justify-content:space-between;margin-top:4px;font-size:0.75rem;color:#aaa;">
          <!-- Category labels will be added here -->
        </div>
      </div>
    </div>

    <div id="subscription-hint" class="small" style="margin-top:8px;opacity:0.9;"></div>
  </div>

  <details class="small" style="margin-top:12px;border:1px solid rgba(255,255,255,0.08);border-radius:8px;padding:8px;">
    <summary style="cursor:pointer;font-weight:500;padding:4px;">Cost-Saving Tips & Alternatives</summary>
    <div style="margin-top:8px;padding:4px;border-top:1px solid rgba(255,255,255,0.08);">
      <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;">
        <div>
          <strong>Ways to Save:</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Switch to annual plans (often 10-20% cheaper)</li>
            <li>Share family plans with trusted friends/family</li>
            <li>Rotate services instead of having all at once</li>
            <li>Use student/military discounts if eligible</li>
          </ul>
        </div>
        <div>
          <strong>Free Alternatives:</strong>
          <ul style="margin:4px 0;padding-left:20px;">
            <li>Library memberships for free digital content</li>
            <li>Free tiers (Spotify, YouTube, Canva)</li>
            <li>Open-source software alternatives</li>
            <li>Public domain content</li>
          </ul>
        </div>
      </div>
      <p style="margin-top:8px;color:#4caf50;"><strong>Tip:</strong> Review subscriptions quarterly and cancel what you don't use regularly.</p>
    </div>
  </details>

  <style>
    .card {
      background: #1a1a1a;
      border-radius: 12px;
      padding: 20px;
      border: 1px solid #333;
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
      margin-bottom: 20px;
    }
    
    .card h2 {
      color: #9c27b0;
      font-size: 1.5rem;
      margin-bottom: 8px;
    }
    
    .card .small {
      font-size: 0.875rem;
      color: #aaa;
      margin-bottom: 16px;
      line-height: 1.5;
    }
    
    .field {
      margin-bottom: 16px;
    }
    
    .field label {
      display: block;
      margin-bottom: 6px;
      color: #ddd;
      font-weight: 500;
    }
    
    .field input,
    .field select {
      padding: 10px 12px;
      border: 1px solid #444;
      border-radius: 8px;
      background: #252525;
      color: #fff;
      font-size: 0.95rem;
    }
    
    .field input:focus,
    .field select:focus {
      outline: none;
      border-color: #9c27b0;
      box-shadow: 0 0 0 2px rgba(156, 39, 176, 0.2);
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      opacity: 1;
      height: 24px;
      cursor: pointer;
    }
    
    .actions button {
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.95rem;
    }
    
    .actions button.primary {
      background: #9c27b0;
      color: white;
    }
    
    .actions button.primary:hover {
      background: #7b1fa2;
    }
    
    .actions button.secondary {
      background: #555;
      color: white;
    }
    
    .actions button.secondary:hover {
      background: #666;
    }
    
    .results h3 {
      color: #9c27b0;
      margin-bottom: 8px;
      font-size: 1rem;
    }
    
    .metric-box {
      transition: transform 0.2s ease;
    }
    
    .metric-box:hover {
      transform: translateY(-2px);
    }
    
    .subscription-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
      border-radius: 6px;
      margin-bottom: 6px;
      border-left: 4px solid #9c27b0;
    }
    
    .subscription-item.entertainment { border-left-color: #2196f3; }
    .subscription-item.productivity { border-left-color: #4caf50; }
    .subscription-item.cloud { border-left-color: #00bcd4; }
    .subscription-item.software { border-left-color: #ff9800; }
    .subscription-item.fitness { border-left-color: #e91e63; }
    .subscription-item.news { border-left-color: #795548; }
    .subscription-item.food { border-left-color: #ff5722; }
    .subscription-item.other { border-left-color: #9e9e9e; }
    
    .subscription-item.cancelled {
      opacity: 0.6;
      text-decoration: line-through;
    }
    
    .subscription-item:hover {
      background: rgba(255,255,255,0.05);
    }
    
    .subscription-info {
      flex: 1;
    }
    
    .subscription-actions {
      display: flex;
      gap: 6px;
    }
    
    .subscription-actions button {
      padding: 4px 8px;
      font-size: 0.8rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      background: rgba(255,255,255,0.1);
      color: white;
    }
    
    .subscription-actions button:hover {
      background: rgba(255,255,255,0.2);
    }
    
    .category-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: 500;
      margin-left: 8px;
      background: rgba(255,255,255,0.1);
    }
    
    .status-badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      margin-left: 8px;
    }
    
    .status-active { background: rgba(76, 175, 80, 0.2); color: #4caf50; }
    .status-pending { background: rgba(255, 152, 0, 0.2); color: #ff9800; }
    .status-cancelled { background: rgba(158, 158, 158, 0.2); color: #9e9e9e; }
    .status-trial { background: rgba(33, 150, 243, 0.2); color: #2196f3; }
    
    .upcoming-warning {
      color: #ff9800;
      font-weight: 500;
    }
    
    .upcoming-danger {
      color: #f44336;
      font-weight: 500;
    }
    
    .empty-state {
      text-align: center;
      padding: 20px;
      color: #666;
    }
    
    details summary::-webkit-details-marker {
      display: none;
    }
    
    details summary:after {
      content: '‚ñº';
      float: right;
      font-size: 0.75em;
      transition: transform 0.2s ease;
    }
    
    details[open] summary:after {
      transform: rotate(180deg);
    }
  </style>
</div>

<script>
// Subscription Tracker Application
let subscriptions = JSON.parse(localStorage.getItem('subscriptions')) || [];

// Category colors
const CATEGORY_COLORS = {
  'entertainment': '#2196f3',
  'productivity': '#4caf50',
  'cloud': '#00bcd4',
  'software': '#ff9800',
  'fitness': '#e91e63',
  'news': '#795548',
  'food': '#ff5722',
  'other': '#9e9e9e'
};

// Currency symbols
const CURRENCY_SYMBOLS = {
  'GBP': '¬£',
  'USD': '$',
  'EUR': '‚Ç¨',
  'CAD': 'C$',
  'AUD': 'A$'
};

// Initialize
document.addEventListener('DOMContentLoaded', function() {
  const card = document.getElementById('subscription-card');
  
  // Set default date to today
  const today = new Date().toISOString().split('T')[0];
  card.querySelector('#subscription-date').value = today;
  
  // Load saved subscriptions
  renderSubscriptions();
  updateStats();
  
  // Update days until renewal
  updateDaysUntil();
  
  // Set up date change event
  card.querySelector('#subscription-date').addEventListener('change', updateDaysUntil);
});

function updateDaysUntil() {
  const card = document.getElementById('subscription-card');
  const date = card.querySelector('#subscription-date').value;
  if (!date) return;
  
  const today = new Date();
  const renewalDate = new Date(date);
  const diffTime = renewalDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  
  const daysElement = card.querySelector('#days-until');
  daysElement.textContent = diffDays;
  
  // Color code based on days
  if (diffDays < 0) {
    daysElement.className = 'upcoming-danger';
  } else if (diffDays <= 7) {
    daysElement.className = 'upcoming-warning';
  } else {
    daysElement.className = '';
  }
}

function subscriptionAdd(btn) {
  const card = document.getElementById('subscription-card');
  const name = card.querySelector('#subscription-name').value.trim();
  const cost = parseFloat(card.querySelector('#subscription-cost').value) || 0;
  const date = card.querySelector('#subscription-date').value;
  const category = card.querySelector('#subscription-category').value;
  const status = card.querySelector('#subscription-status').value;
  const cycle = card.querySelector('#subscription-cycle').value;
  const currency = card.querySelector('#subscription-currency').value;
  const notes = card.querySelector('#subscription-notes').value.trim();
  
  // Validate inputs
  if (!name) {
    showHint('Please enter a service name.', 'error');
    return;
  }
  
  if (cost <= 0) {
    showHint('Please enter a valid cost.', 'error');
    return;
  }
  
  if (!date) {
    showHint('Please select a renewal date.', 'error');
    return;
  }
  
  // Calculate monthly equivalent cost
  let monthlyCost = cost;
  if (cycle === 'yearly') {
    monthlyCost = cost / 12;
  } else if (cycle === 'quarterly') {
    monthlyCost = cost / 3;
  } else if (cycle === 'weekly') {
    monthlyCost = cost * 4.33; // Average weeks in a month
  }
  
  // Create subscription object
  const subscription = {
    id: Date.now(),
    name,
    cost,
    monthlyCost: parseFloat(monthlyCost.toFixed(2)),
    date,
    category,
    status,
    cycle,
    currency,
    notes,
    createdAt: new Date().toISOString()
  };
  
  // Add to subscriptions
  subscriptions.push(subscription);
  
  // Save to localStorage
  localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
  
  // Update UI
  renderSubscriptions();
  updateStats();
  updateDaysUntil();
  
  // Clear form
  card.querySelector('#subscription-name').value = '';
  card.querySelector('#subscription-cost').value = '';
  card.querySelector('#subscription-notes').value = '';
  
  // Show success message
  const symbol = CURRENCY_SYMBOLS[currency];
  showHint(`Added ${name} at ${symbol}${cost} ${cycle}`, 'success');
}

function subscriptionQuickAdd(btn) {
  const card = document.getElementById('subscription-card');
  
  // Common subscription presets
  const presets = [
    { name: 'Netflix', cost: 10.99, category: 'entertainment', cycle: 'monthly' },
    { name: 'Spotify', cost: 9.99, category: 'entertainment', cycle: 'monthly' },
    { name: 'Amazon Prime', cost: 8.99, category: 'entertainment', cycle: 'monthly' },
    { name: 'YouTube Premium', cost: 11.99, category: 'entertainment', cycle: 'monthly' },
    { name: 'Microsoft 365', cost: 69.99, category: 'software', cycle: 'yearly' },
    { name: 'Adobe Creative Cloud', cost: 52.99, category: 'software', cycle: 'monthly' },
    { name: 'Dropbox', cost: 9.99, category: 'cloud', cycle: 'monthly' },
    { name: 'Google One', cost: 1.99, category: 'cloud', cycle: 'monthly' },
    { name: 'Headspace', cost: 12.99, category: 'fitness', cycle: 'monthly' },
    { name: 'New York Times', cost: 17.00, category: 'news', cycle: 'monthly' }
  ];
  
  // Create quick add buttons
  let html = '<div style="margin-bottom:12px;font-size:0.9rem;">Quick Add Presets:</div>';
  html += '<div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;">';
  
  presets.forEach(preset => {
    const symbol = CURRENCY_SYMBOLS[document.getElementById('subscription-currency').value];
    html += `
      <button type="button" onclick="addPreset('${preset.name}', ${preset.cost}, '${preset.category}', '${preset.cycle}')" 
              style="padding:6px 12px;background:rgba(156, 39, 176, 0.2);border:1px solid rgba(156, 39, 176, 0.3);border-radius:6px;color:#9c27b0;cursor:pointer;font-size:0.85rem;">
        ${preset.name} (${symbol}${preset.cost}/${preset.cycle})
      </button>
    `;
  });
  
  html += '</div>';
  
  // Show in hint area
  const hint = document.getElementById('subscription-hint');
  hint.innerHTML = html;
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    if (hint.innerHTML.includes('Quick Add Presets')) {
      hint.innerHTML = '';
    }
  }, 10000);
}

function addPreset(name, cost, category, cycle) {
  const card = document.getElementById('subscription-card');
  
  // Set form values
  card.querySelector('#subscription-name').value = name;
  card.querySelector('#subscription-cost').value = cost;
  card.querySelector('#subscription-category').value = category;
  card.querySelector('#subscription-cycle').value = cycle;
  card.querySelector('#subscription-status').value = 'active';
  
  // Set date to today + 30 days
  const futureDate = new Date();
  futureDate.setDate(futureDate.getDate() + 30);
  card.querySelector('#subscription-date').value = futureDate.toISOString().split('T')[0];
  
  // Clear hint
  document.getElementById('subscription-hint').innerHTML = '';
  
  // Show confirmation
  const symbol = CURRENCY_SYMBOLS[document.getElementById('subscription-currency').value];
  showHint(`Preset loaded: ${name}. Click "Add Subscription" to save.`, 'info');
}

function renderSubscriptions() {
  const listContainer = document.getElementById('subscription-list');
  
  if (subscriptions.length === 0) {
    listContainer.innerHTML = '<p class="empty-state">No subscriptions added yet.</p>';
    return;
  }
  
  // Sort by date (closest first)
  const sortedSubs = [...subscriptions].sort((a, b) => new Date(a.date) - new Date(b.date));
  
  let html = '';
  const today = new Date();
  
  sortedSubs.forEach(sub => {
    const symbol = CURRENCY_SYMBOLS[sub.currency];
    const renewalDate = new Date(sub.date);
    const daysUntil = Math.ceil((renewalDate - today) / (1000 * 60 * 60 * 24));
    
    // Determine warning level
    let warningClass = '';
    let warningText = '';
    
    if (daysUntil < 0) {
      warningClass = 'upcoming-danger';
      warningText = ' (OVERDUE!)';
    } else if (daysUntil <= 3) {
      warningClass = 'upcoming-danger';
      warningText = ` (in ${daysUntil} days)`;
    } else if (daysUntil <= 7) {
      warningClass = 'upcoming-warning';
      warningText = ` (in ${daysUntil} days)`;
    }
    
    html += `
      <div class="subscription-item ${sub.category} ${sub.status === 'cancelled' ? 'cancelled' : ''}" data-id="${sub.id}">
        <div class="subscription-info">
          <div style="display:flex;align-items:center;margin-bottom:4px;">
            <strong>${sub.name}</strong>
            <span class="category-badge">${sub.category}</span>
            <span class="status-badge status-${sub.status}">${sub.status}</span>
          </div>
          <div class="small" style="color:#aaa;">
            ${symbol}${sub.cost.toFixed(2)} ${sub.cycle} 
            (${symbol}${sub.monthlyCost.toFixed(2)}/mo)
            ‚Ä¢ Renews: ${formatDate(sub.date)}${warningText}
            ${sub.notes ? `<br>${sub.notes}` : ''}
          </div>
        </div>
        <div class="subscription-actions">
          <button onclick="toggleSubscriptionStatus(${sub.id})" title="Toggle Status">
            ${sub.status === 'active' ? '‚è∏' : '‚ñ∂'}
          </button>
          <button onclick="editSubscription(${sub.id})" title="Edit">‚úé</button>
          <button onclick="deleteSubscription(${sub.id})" title="Delete">‚úï</button>
        </div>
      </div>
    `;
  });
  
  listContainer.innerHTML = html;
}

function updateStats() {
  // Filter active subscriptions only
  const activeSubs = subscriptions.filter(sub => sub.status === 'active');
  
  // Calculate totals
  const monthlyTotal = activeSubs.reduce((sum, sub) => sum + sub.monthlyCost, 0);
  const yearlyTotal = monthlyTotal * 12;
  
  // Find next renewal
  const nextRenewal = activeSubs.length > 0 
    ? activeSubs.reduce((closest, sub) => {
        const subDate = new Date(sub.date);
        return subDate < closest ? subDate : closest;
      }, new Date('9999-12-31'))
    : null;
  
  // Get currency symbol (use first subscription's currency or default)
  const currency = activeSubs.length > 0 ? activeSubs[0].currency : 'GBP';
  const symbol = CURRENCY_SYMBOLS[currency];
  
  // Update metrics
  document.getElementById('subscription-monthly').textContent = `${symbol}${monthlyTotal.toFixed(2)}`;
  document.getElementById('subscription-yearly').textContent = `${symbol}${yearlyTotal.toFixed(2)}`;
  document.getElementById('subscription-count').textContent = activeSubs.length;
  document.getElementById('subscription-next').textContent = nextRenewal 
    ? formatDate(nextRenewal.toISOString().split('T')[0])
    : '‚Äì';
  
  // Update breakdown text
  document.getElementById('breakdown-text').textContent = 
    `${symbol}${monthlyTotal.toFixed(2)} total ‚Ä¢ ${activeSubs.length} active subscriptions`;
  
  // Update category breakdown
  updateCategoryBreakdown(activeSubs, monthlyTotal, symbol);
}

function updateCategoryBreakdown(activeSubs, monthlyTotal, symbol) {
  const breakdownContainer = document.getElementById('category-breakdown');
  const labelsContainer = document.getElementById('category-labels');
  
  // Calculate category totals
  const categoryTotals = {};
  activeSubs.forEach(sub => {
    categoryTotals[sub.category] = (categoryTotals[sub.category] || 0) + sub.monthlyCost;
  });
  
  // Clear containers
  breakdownContainer.innerHTML = '';
  labelsContainer.innerHTML = '';
  
  // Create breakdown bars
  Object.entries(categoryTotals).forEach(([category, total]) => {
    const percentage = (total / monthlyTotal) * 100;
    const color = CATEGORY_COLORS[category];
    
    // Add bar segment
    const bar = document.createElement('div');
    bar.style.width = `${percentage}%`;
    bar.style.height = '100%';
    bar.style.backgroundColor = color;
    bar.style.transition = 'width 0.5s ease';
    bar.title = `${category}: ${symbol}${total.toFixed(2)} (${percentage.toFixed(1)}%)`;
    breakdownContainer.appendChild(bar);
    
    // Add label if percentage is significant
    if (percentage > 10) {
      const label = document.createElement('span');
      label.textContent = `${category} (${percentage.toFixed(0)}%)`;
      label.style.color = color;
      label.title = `${symbol}${total.toFixed(2)}`;
      labelsContainer.appendChild(label);
    }
  });
}

function toggleSubscriptionStatus(subscriptionId) {
  const subscription = subscriptions.find(s => s.id === subscriptionId);
  if (subscription) {
    // Cycle through statuses
    const statuses = ['active', 'pending', 'cancelled', 'trial'];
    const currentIndex = statuses.indexOf(subscription.status);
    const nextIndex = (currentIndex + 1) % statuses.length;
    
    subscription.status = statuses[nextIndex];
    localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
    renderSubscriptions();
    updateStats();
    
    showHint(
      `${subscription.name} status changed to ${subscription.status}`,
      'info'
    );
  }
}

function editSubscription(subscriptionId) {
  const subscription = subscriptions.find(s => s.id === subscriptionId);
  if (!subscription) return;
  
  const card = document.getElementById('subscription-card');
  
  // Set form values
  card.querySelector('#subscription-name').value = subscription.name;
  card.querySelector('#subscription-cost').value = subscription.cost;
  card.querySelector('#subscription-date').value = subscription.date;
  card.querySelector('#subscription-category').value = subscription.category;
  card.querySelector('#subscription-status').value = subscription.status;
  card.querySelector('#subscription-cycle').value = subscription.cycle;
  card.querySelector('#subscription-currency').value = subscription.currency;
  card.querySelector('#subscription-notes').value = subscription.notes;
  
  // Remove the subscription being edited
  deleteSubscription(subscriptionId);
  
  showHint(`Editing subscription: ${subscription.name}`, 'info');
}

function deleteSubscription(subscriptionId) {
  subscriptions = subscriptions.filter(s => s.id !== subscriptionId);
  localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
  renderSubscriptions();
  updateStats();
  updateDaysUntil();
  
  showHint('Subscription deleted', 'info');
}

function filterSubscriptions() {
  const filter = document.getElementById('subscription-filter').value;
  const today = new Date();
  const oneWeekLater = new Date();
  oneWeekLater.setDate(oneWeekLater.getDate() + 7);
  
  let filteredSubs = [...subscriptions];
  
  switch(filter) {
    case 'active':
      filteredSubs = subscriptions.filter(sub => sub.status === 'active');
      break;
    case 'upcoming':
      filteredSubs = subscriptions.filter(sub => {
        const subDate = new Date(sub.date);
        return subDate >= today && subDate <= oneWeekLater && sub.status === 'active';
      });
      break;
    case 'expensive':
      filteredSubs = [...subscriptions]
        .filter(sub => sub.status === 'active')
        .sort((a, b) => b.monthlyCost - a.monthlyCost)
        .slice(0, 5);
      break;
    case 'category':
      const categories = [...new Set(subscriptions.map(s => s.category))];
      const category = prompt('Enter category to filter by:', categories[0]);
      if (category) {
        filteredSubs = subscriptions.filter(s => s.category === category);
      }
      break;
  }
  
  // Temporary display of filtered subscriptions
  const listContainer = document.getElementById('subscription-list');
  
  if (filteredSubs.length === 0) {
    listContainer.innerHTML = '<p class="empty-state">No subscriptions match the filter.</p>';
    return;
  }
  
  let html = '';
  filteredSubs.forEach(sub => {
    const symbol = CURRENCY_SYMBOLS[sub.currency];
    html += `
      <div class="subscription-item ${sub.category}">
        <div class="subscription-info">
          <div style="display:flex;align-items:center;margin-bottom:4px;">
            <strong>${sub.name}</strong>
            <span class="category-badge">${sub.category}</span>
          </div>
          <div class="small" style="color:#aaa;">
            ${symbol}${sub.cost.toFixed(2)} ${sub.cycle} 
            ‚Ä¢ Renews: ${formatDate(sub.date)}
          </div>
        </div>
      </div>
    `;
  });
  
  listContainer.innerHTML = html;
  
  // Reset filter after 5 seconds
  setTimeout(() => {
    document.getElementById('subscription-filter').value = 'all';
    renderSubscriptions();
  }, 5000);
}

function sortSubscriptions() {
  // Toggle between cost ascending and descending
  const currentSort = document.getElementById('subscription-list').dataset.sort || 'desc';
  const newSort = currentSort === 'desc' ? 'asc' : 'desc';
  
  subscriptions.sort((a, b) => {
    return newSort === 'desc' ? b.monthlyCost - a.monthlyCost : a.monthlyCost - b.monthlyCost;
  });
  
  localStorage.setItem('subscriptions', JSON.stringify(subscriptions));
  renderSubscriptions();
  
  showHint(`Sorted by cost (${newSort === 'desc' ? 'highest first' : 'lowest first'})`, 'info');
}

function subscriptionReset(btn) {
  const card = document.getElementById('subscription-card');
  card.querySelector('#subscription-name').value = '';
  card.querySelector('#subscription-cost').value = '';
  card.querySelector('#subscription-notes').value = '';
  
  // Set default date to today + 30 days
  const futureDate = new Date();
  futureDate.setDate(futureDate.getDate() + 30);
  card.querySelector('#subscription-date').value = futureDate.toISOString().split('T')[0];
  
  showHint('Form cleared', 'info');
}

function subscriptionExport(btn) {
  if (subscriptions.length === 0) {
    showHint('No subscriptions to export.', 'error');
    return;
  }
  
  // Create CSV content
  let csv = 'Name,Category,Status,Cost,Cycle,Monthly Cost,Currency,Renewal Date,Notes\n';
  
  subscriptions.forEach(sub => {
    csv += `"${sub.name}","${sub.category}","${sub.status}",${sub.cost},"${sub.cycle}",${sub.monthlyCost},"${sub.currency}","${sub.date}","${sub.notes || ''}"\n`;
  });
  
  // Create download link
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `subscriptions-${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  showHint('Subscriptions exported as CSV', 'success');
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  const today = new Date();
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  
  if (dateStr === today.toISOString().split('T')[0]) {
    return 'Today';
  } else if (dateStr === tomorrow.toISOString().split('T')[0]) {
    return 'Tomorrow';
  } else {
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
  }
}

function showHint(message, type = 'info') {
  const hint = document.getElementById('subscription-hint');
  const colors = {
    'success': '#4caf50',
    'error': '#f44336',
    'info': '#2196f3',
    'warning': '#ff9800'
  };
  
  hint.innerHTML = `<span style="color:${colors[type]}">${type === 'success' ? '‚úì' : type === 'error' ? '‚úï' : '‚ìò'}</span> ${message}`;
  
  // Clear after 3 seconds
  setTimeout(() => {
    if (hint.innerHTML.includes(message)) {
      hint.innerHTML = '';
    }
  }, 3000);
}
</script>
