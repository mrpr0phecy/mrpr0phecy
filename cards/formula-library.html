
<h2 id="formula-library-title">üìö Scientific Formula Library</h2>

<form aria-describedby="formula-description">
    <p id="formula-description" class="small" style="color:rgba(230,250,255,0.9);margin-bottom:20px;">
        Interactive scientific formula calculator with detailed explanations, 3D visualizations, and step-by-step solutions.
        <span style="color:var(--accent);font-weight:500;">Perfect for students and professionals in STEM fields.</span>
    </p>
    
    <!-- Formula Selection -->
    <div style="margin-bottom:24px;">
        <h3 style="color:var(--accent);margin:0 0 12px 0;font-size:1rem;">üî¨ Select Formula Category</h3>
        
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
            <button type="button" onclick="flSelectCategory('physics')" id="fl-cat-physics"
                    style="padding:12px 20px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:2px solid var(--accent);border-radius:10px;color:var(--accent);cursor:pointer;font-weight:600;">
                ‚öõÔ∏è Physics
            </button>
            <button type="button" onclick="flSelectCategory('chemistry')" id="fl-cat-chemistry"
                    style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(230,250,255,0.8);cursor:pointer;">
                üß™ Chemistry
            </button>
            <button type="button" onclick="flSelectCategory('math')" id="fl-cat-math"
                    style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(230,250,255,0.8);cursor:pointer;">
                üìê Mathematics
            </button>
            <button type="button" onclick="flSelectCategory('engineering')" id="fl-cat-engineering"
                    style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(230,250,255,0.8);cursor:pointer;">
                ‚öôÔ∏è Engineering
            </button>
            <button type="button" onclick="flSelectCategory('biology')" id="fl-cat-biology"
                    style="padding:12px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:rgba(230,250,255,0.8);cursor:pointer;">
                üß¨ Biology
            </button>
        </div>
        
        <!-- Formula Selection -->
        <div style="margin-bottom:20px;">
            <label for="fl-formula" style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;">
                üìù Select Formula
            </label>
            <select id="fl-formula" 
                    style="width:100%;padding:14px;border-radius:10px;border:2px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:1.05rem;cursor:pointer;"
                    onchange="flLoadFormula(this.value)">
                <!-- Options populated by JavaScript -->
            </select>
        </div>
        
        <!-- Formula Display -->
        <div id="fl-formula-display" style="
            padding:20px;
            background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));
            border:2px solid rgba(45,212,255,0.15);
            border-radius:12px;
            margin-bottom:20px;
            text-align:center;
            font-size:1.3rem;
            color:#fff;
            font-family:'Cambria Math',serif;
            min-height:60px;
            display:flex;
            align-items:center;
            justify-content:center;
        ">
            <div id="fl-formula-text">Select a formula to begin</div>
        </div>
        
        <!-- Variables Input -->
        <div style="margin-bottom:20px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
                <label style="color:var(--accent);font-weight:500;">üìä Enter Variable Values</label>
                <button type="button" onclick="flClearInputs()" style="padding:6px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:0.8rem;">
                    Clear All
                </button>
            </div>
            
            <div id="fl-inputs-container" style="
                display:grid;
                grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));
                gap:12px;
            ">
                <!-- Dynamic inputs will be added here -->
            </div>
        </div>
        
        <!-- Options -->
        <div style="display:flex;gap:24px;margin-bottom:20px;">
            <label style="display:flex;align-items:center;gap:10px;color:rgba(230,250,255,0.9);cursor:pointer;">
                <input type="checkbox" id="fl-show-steps" checked style="width:18px;height:18px;accent-color:var(--accent);">
                <span style="font-weight:500;">Show Step-by-Step Solution</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;color:rgba(230,250,255,0.9);cursor:pointer;">
                <input type="checkbox" id="fl-show-units" checked style="width:18px;height:18px;accent-color:var(--accent);">
                <span style="font-weight:500;">Show Units</span>
            </label>
            <label style="display:flex;align-items:center;gap:10px;color:rgba(230,250,255,0.9);cursor:pointer;">
                <input type="checkbox" id="fl-show-visualization" style="width:18px;height:18px;accent-color:var(--accent);">
                <span style="font-weight:500;">Show Visualization</span>
            </label>
        </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="actions" style="display:flex;gap:12px;">
        <button type="button" onclick="flCalculate()" 
                style="flex:1;padding:16px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(157,78,221,0.2));border:2px solid rgba(45,212,255,0.4);border-radius:12px;color:var(--accent);cursor:pointer;font-weight:600;font-size:1.1rem;display:flex;align-items:center;justify-content:center;gap:10px;">
            ‚ö° Calculate
        </button>
        <button type="button" onclick="flExample()"
                style="padding:16px 24px;background:rgba(255,204,0,0.1);border:2px solid rgba(255,204,0,0.3);border-radius:12px;color:#ffcc00;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;">
            üìö Example
        </button>
        <button type="button" onclick="flReset()"
                style="padding:16px 24px;background:rgba(255,77,77,0.1);border:2px solid rgba(255,77,77,0.3);border-radius:12px;color:#ff4d4d;cursor:pointer;font-weight:600;display:flex;align-items:center;gap:8px;">
            üîÑ Reset
        </button>
    </div>
</form>

<!-- Results Display -->
<div class="results" aria-live="polite" style="margin-top:24px;">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h3 class="small" style="color:var(--accent);margin:0;font-size:1.1rem;">üìä Calculation Results</h3>
        <div style="display:flex;gap:8px;">
            <button onclick="flCopyResult()" style="padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:rgba(230,250,255,0.8);cursor:pointer;display:flex;align-items:center;gap:6px;">
                üìã Copy
            </button>
            <button onclick="flSaveCalculation()" style="padding:8px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:rgba(230,250,255,0.8);cursor:pointer;display:flex;align-items:center;gap:6px;">
                üíæ Save
            </button>
        </div>
    </div>
    
    <!-- Main Result -->
    <div id="fl-main-result" style="
        padding:24px;
        background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));
        border:2px solid rgba(45,212,255,0.15);
        border-radius:12px;
        margin-bottom:20px;
        min-height:80px;
        display:flex;
        align-items:center;
        justify-content:center;
    ">
        <div style="text-align:center;color:rgba(230,250,255,0.5);">
            <div style="font-size:2rem;margin-bottom:8px;">üìê</div>
            <div>Enter values and click "Calculate" to see results</div>
        </div>
    </div>
    
    <!-- Formula Info -->
    <div id="fl-formula-info" style="display:none;margin-bottom:20px;">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1rem;">üìù Formula Information</h4>
        <div id="fl-formula-description" style="
            padding:16px;
            background:rgba(0,0,0,0.2);
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.05);
            line-height:1.6;
        "></div>
    </div>
    
    <!-- Step-by-Step Solution -->
    <div id="fl-steps-container" style="display:none;margin-bottom:20px;">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1rem;">üìà Step-by-Step Solution</h4>
        <div id="fl-steps" style="
            padding:20px;
            background:rgba(0,0,0,0.2);
            border-radius:10px;
            border:1px solid rgba(255,255,255,0.05);
            counter-reset: step-counter;
        "></div>
    </div>
    
    <!-- Visualization -->
    <div id="fl-visualization-container" style="display:none;margin-bottom:20px;">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1rem;">üìä Visualization</h4>
        <div id="fl-visualization" style="
            padding:20px;
            background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));
            border:2px solid rgba(45,212,255,0.15);
            border-radius:12px;
            min-height:200px;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
        ">
            <canvas id="fl-chart-canvas"></canvas>
        </div>
    </div>
    
    <!-- Related Formulas -->
    <div id="fl-related-container" style="display:none;">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:1rem;">üîó Related Formulas</h4>
        <div id="fl-related-formulas" style="
            display:grid;
            grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
            gap:12px;
        "></div>
    </div>
</div>

<script>
/* formula-library.html
   - Advanced scientific formula calculator with visualization
   - Prefix: fl
*/

// Formula database
const flFormulas = {
    physics: [
        {
            id: 'newton2',
            name: "Newton's Second Law",
            formula: "F = m √ó a",
            display: "F = m ¬∑ a",
            description: "Describes the relationship between an object's mass, acceleration, and the net force acting upon it.",
            variables: [
                { symbol: 'F', name: 'Force', unit: 'N (Newtons)', default: '', placeholder: 'e.g. 100' },
                { symbol: 'm', name: 'Mass', unit: 'kg', default: '10', placeholder: 'e.g. 10' },
                { symbol: 'a', name: 'Acceleration', unit: 'm/s¬≤', default: '9.8', placeholder: 'e.g. 9.8' }
            ],
            calculate: (values) => {
                if (values.m && values.a) {
                    return { F: values.m * values.a };
                } else if (values.F && values.m) {
                    return { a: values.F / values.m };
                } else if (values.F && values.a) {
                    return { m: values.F / values.a };
                }
                return null;
            },
            steps: (values, result) => {
                const steps = [];
                if (values.m && values.a) {
                    steps.push(`Given: m = ${values.m} kg, a = ${values.a} m/s¬≤`);
                    steps.push(`Using Newton's Second Law: F = m √ó a`);
                    steps.push(`Calculation: F = ${values.m} √ó ${values.a}`);
                    steps.push(`Result: F = ${result.F} N`);
                }
                return steps;
            }
        },
        {
            id: 'ohm',
            name: "Ohm's Law",
            formula: "V = I √ó R",
            display: "V = I ¬∑ R",
            description: "Relates voltage, current, and resistance in an electrical circuit.",
            variables: [
                { symbol: 'V', name: 'Voltage', unit: 'V (Volts)', default: '', placeholder: 'e.g. 12' },
                { symbol: 'I', name: 'Current', unit: 'A (Amps)', default: '2', placeholder: 'e.g. 2' },
                { symbol: 'R', name: 'Resistance', unit: 'Œ© (Ohms)', default: '6', placeholder: 'e.g. 6' }
            ]
        },
        {
            id: 'wave-speed',
            name: "Wave Speed Formula",
            formula: "v = f √ó Œª",
            display: "v = f ¬∑ Œª",
            description: "Relates wave speed, frequency, and wavelength.",
            variables: [
                { symbol: 'v', name: 'Wave Speed', unit: 'm/s', default: '', placeholder: 'e.g. 340' },
                { symbol: 'f', name: 'Frequency', unit: 'Hz', default: '440', placeholder: 'e.g. 440' },
                { symbol: 'Œª', name: 'Wavelength', unit: 'm', default: '', placeholder: 'e.g. 0.75' }
            ]
        },
        {
            id: 'kinetic-energy',
            name: "Kinetic Energy",
            formula: "KE = ¬Ω √ó m √ó v¬≤",
            display: "KE = ¬Ω ¬∑ m ¬∑ v¬≤",
            description: "Energy possessed by an object due to its motion.",
            variables: [
                { symbol: 'KE', name: 'Kinetic Energy', unit: 'J (Joules)', default: '', placeholder: 'e.g. 500' },
                { symbol: 'm', name: 'Mass', unit: 'kg', default: '5', placeholder: 'e.g. 5' },
                { symbol: 'v', name: 'Velocity', unit: 'm/s', default: '10', placeholder: 'e.g. 10' }
            ]
        },
        {
            id: 'gravitational-force',
            name: "Newton's Law of Gravitation",
            formula: "F = G √ó (m‚ÇÅ √ó m‚ÇÇ) / r¬≤",
            display: "F = G ¬∑ (m‚ÇÅ¬∑m‚ÇÇ) / r¬≤",
            description: "Describes the gravitational force between two masses.",
            variables: [
                { symbol: 'F', name: 'Force', unit: 'N', default: '', placeholder: '' },
                { symbol: 'm1', name: 'Mass 1', unit: 'kg', default: '1000', placeholder: 'e.g. 1000' },
                { symbol: 'm2', name: 'Mass 2', unit: 'kg', default: '1000', placeholder: 'e.g. 1000' },
                { symbol: 'r', name: 'Distance', unit: 'm', default: '1', placeholder: 'e.g. 1' }
            ]
        }
    ],
    chemistry: [
        {
            id: 'ideal-gas',
            name: "Ideal Gas Law",
            formula: "P √ó V = n √ó R √ó T",
            display: "P ¬∑ V = n ¬∑ R ¬∑ T",
            description: "Relates pressure, volume, amount, and temperature of an ideal gas.",
            variables: [
                { symbol: 'P', name: 'Pressure', unit: 'Pa', default: '101325', placeholder: 'e.g. 101325' },
                { symbol: 'V', name: 'Volume', unit: 'm¬≥', default: '0.0224', placeholder: 'e.g. 0.0224' },
                { symbol: 'n', name: 'Amount', unit: 'mol', default: '1', placeholder: 'e.g. 1' },
                { symbol: 'R', name: 'Gas Constant', unit: 'J/(mol¬∑K)', default: '8.314', placeholder: '8.314' },
                { symbol: 'T', name: 'Temperature', unit: 'K', default: '273.15', placeholder: 'e.g. 273.15' }
            ]
        },
        {
            id: 'density',
            name: "Density Formula",
            formula: "œÅ = m / V",
            display: "œÅ = m / V",
            description: "Relates mass to volume for a substance.",
            variables: [
                { symbol: 'œÅ', name: 'Density', unit: 'kg/m¬≥', default: '', placeholder: 'e.g. 1000' },
                { symbol: 'm', name: 'Mass', unit: 'kg', default: '1', placeholder: 'e.g. 1' },
                { symbol: 'V', name: 'Volume', unit: 'm¬≥', default: '0.001', placeholder: 'e.g. 0.001' }
            ]
        }
    ],
    math: [
        {
            id: 'quadratic',
            name: "Quadratic Formula",
            formula: "x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a",
            display: "x = [-b ¬± ‚àö(b¬≤ - 4ac)] / 2a",
            description: "Solves quadratic equations of the form ax¬≤ + bx + c = 0.",
            variables: [
                { symbol: 'a', name: 'Coefficient a', unit: '', default: '1', placeholder: 'e.g. 1' },
                { symbol: 'b', name: 'Coefficient b', unit: '', default: '0', placeholder: 'e.g. 0' },
                { symbol: 'c', name: 'Coefficient c', unit: '', default: '-1', placeholder: 'e.g. -1' }
            ]
        },
        {
            id: 'pythagorean',
            name: "Pythagorean Theorem",
            formula: "a¬≤ + b¬≤ = c¬≤",
            display: "a¬≤ + b¬≤ = c¬≤",
            description: "Relates the sides of a right triangle.",
            variables: [
                { symbol: 'a', name: 'Side a', unit: '', default: '3', placeholder: 'e.g. 3' },
                { symbol: 'b', name: 'Side b', unit: '', default: '4', placeholder: 'e.g. 4' },
                { symbol: 'c', name: 'Hypotenuse', unit: '', default: '', placeholder: 'e.g. 5' }
            ]
        }
    ]
};

let flCurrentCategory = 'physics';
let flCurrentFormula = null;

function flSelectCategory(category) {
    flCurrentCategory = category;
    
    // Update button styles
    const categories = ['physics', 'chemistry', 'math', 'engineering', 'biology'];
    categories.forEach(cat => {
        const btn = document.getElementById(`fl-cat-${cat}`);
        if (cat === category) {
            btn.style.background = 'linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1))';
            btn.style.border = '2px solid var(--accent)';
            btn.style.color = 'var(--accent)';
            btn.style.fontWeight = '600';
        } else {
            btn.style.background = 'rgba(255,255,255,0.05)';
            btn.style.border = '1px solid rgba(255,255,255,0.1)';
            btn.style.color = 'rgba(230,250,255,0.8)';
            btn.style.fontWeight = '400';
        }
    });
    
    // Update formula dropdown
    const formulaSelect = document.getElementById('fl-formula');
    formulaSelect.innerHTML = '';
    
    const formulas = flFormulas[category] || [];
    formulas.forEach(formula => {
        const option = document.createElement('option');
        option.value = formula.id;
        option.textContent = formula.name;
        formulaSelect.appendChild(option);
    });
    
    // Load first formula
    if (formulas.length > 0) {
        flLoadFormula(formulas[0].id);
    }
}

function flLoadFormula(formulaId) {
    const category = flCurrentCategory;
    const formula = (flFormulas[category] || []).find(f => f.id === formulaId);
    flCurrentFormula = formula;
    
    if (!formula) return;
    
    // Update formula display
    document.getElementById('fl-formula-text').innerHTML = formula.display;
    
    // Update formula description
    const infoDiv = document.getElementById('fl-formula-info');
    const descDiv = document.getElementById('fl-formula-description');
    descDiv.textContent = formula.description;
    infoDiv.style.display = 'block';
    
    // Create input fields
    const inputsContainer = document.getElementById('fl-inputs-container');
    inputsContainer.innerHTML = '';
    
    formula.variables.forEach(variable => {
        const inputId = `fl-input-${variable.symbol}`;
        const inputDiv = document.createElement('div');
        inputDiv.style.display = 'flex';
        inputDiv.style.flexDirection = 'column';
        inputDiv.style.gap = '6px';
        
        inputDiv.innerHTML = `
            <label for="${inputId}" style="color:var(--accent);font-weight:500;font-size:0.9rem;">
                ${variable.symbol} (${variable.name})
            </label>
            <div style="position:relative;">
                <input id="${inputId}" type="number" step="any" 
                       placeholder="${variable.placeholder}" 
                       value="${variable.default || ''}"
                       style="width:100%;padding:12px;padding-right:60px;border-radius:8px;border:2px solid rgba(45,212,255,0.2);background:rgba(45,212,255,0.05);color:inherit;font-weight:500;" />
                <div style="position:absolute;right:12px;top:50%;transform:translateY(-50%);color:rgba(230,250,255,0.6);font-size:0.8rem;">
                    ${variable.unit}
                </div>
            </div>
        `;
        
        inputsContainer.appendChild(inputDiv);
    });
    
    // Update related formulas
    flUpdateRelatedFormulas(category, formulaId);
    
    // Clear previous results
    document.getElementById('fl-main-result').innerHTML = `
        <div style="text-align:center;color:rgba(230,250,255,0.5);">
            <div style="font-size:2rem;margin-bottom:8px;">üìê</div>
            <div>Enter values and click "Calculate" to see results</div>
        </div>
    `;
    
    // Hide containers
    document.getElementById('fl-steps-container').style.display = 'none';
    document.getElementById('fl-visualization-container').style.display = 'none';
}

function flUpdateRelatedFormulas(category, currentId) {
    const relatedContainer = document.getElementById('fl-related-container');
    const relatedDiv = document.getElementById('fl-related-formulas');
    
    const formulas = flFormulas[category] || [];
    const related = formulas.filter(f => f.id !== currentId).slice(0, 3);
    
    if (related.length === 0) {
        relatedContainer.style.display = 'none';
        return;
    }
    
    relatedDiv.innerHTML = '';
    related.forEach(formula => {
        const formulaDiv = document.createElement('div');
        formulaDiv.style.cssText = `
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.05);
            cursor: pointer;
            transition: all 0.2s ease;
        `;
        
        formulaDiv.innerHTML = `
            <div style="font-weight:600;color:var(--accent);margin-bottom:4px;">${formula.name}</div>
            <div style="font-size:0.9rem;color:rgba(230,250,255,0.7);margin-bottom:6px;">${formula.formula}</div>
            <div style="font-size:0.8rem;color:rgba(230,250,255,0.5);">${formula.description.substring(0, 60)}...</div>
        `;
        
        formulaDiv.addEventListener('click', () => {
            document.getElementById('fl-formula').value = formula.id;
            flLoadFormula(formula.id);
        });
        
        formulaDiv.addEventListener('mouseenter', () => {
            formulaDiv.style.transform = 'translateY(-4px)';
            formulaDiv.style.background = 'rgba(45,212,255,0.1)';
            formulaDiv.style.borderColor = 'rgba(45,212,255,0.3)';
        });
        
        formulaDiv.addEventListener('mouseleave', () => {
            formulaDiv.style.transform = 'translateY(0)';
            formulaDiv.style.background = 'rgba(0,0,0,0.2)';
            formulaDiv.style.borderColor = 'rgba(255,255,255,0.05)';
        });
        
        relatedDiv.appendChild(formulaDiv);
    });
    
    relatedContainer.style.display = 'block';
}

function flCalculate() {
    if (!flCurrentFormula) return;
    
    // Gather input values
    const values = {};
    const showUnits = document.getElementById('fl-show-units').checked;
    const showSteps = document.getElementById('fl-show-steps').checked;
    const showViz = document.getElementById('fl-show-visualization').checked;
    
    flCurrentFormula.variables.forEach(variable => {
        const input = document.getElementById(`fl-input-${variable.symbol}`);
        const value = parseFloat(input.value);
        if (!isNaN(value)) {
            values[variable.symbol] = value;
        }
    });
    
    // Calculate based on formula
    let result;
    switch(flCurrentFormula.id) {
        case 'newton2':
            if (values.m && values.a) {
                result = { F: values.m * values.a };
            } else if (values.F && values.m) {
                result = { a: values.F / values.m };
            } else if (values.F && values.a) {
                result = { m: values.F / values.a };
            }
            break;
            
        case 'ohm':
            if (values.I && values.R) {
                result = { V: values.I * values.R };
            } else if (values.V && values.R) {
                result = { I: values.V / values.R };
            } else if (values.V && values.I) {
                result = { R: values.V / values.I };
            }
            break;
            
        case 'wave-speed':
            if (values.f && values.Œª) {
                result = { v: values.f * values.Œª };
            } else if (values.v && values.Œª) {
                result = { f: values.v / values.Œª };
            } else if (values.v && values.f) {
                result = { Œª: values.v / values.f };
            }
            break;
            
        case 'kinetic-energy':
            if (values.m && values.v) {
                result = { KE: 0.5 * values.m * Math.pow(values.v, 2) };
            }
            break;
            
        case 'density':
            if (values.m && values.V) {
                result = { œÅ: values.m / values.V };
            } else if (values.œÅ && values.V) {
                result = { m: values.œÅ * values.V };
            } else if (values.œÅ && values.m) {
                result = { V: values.m / values.œÅ };
            }
            break;
            
        case 'pythagorean':
            if (values.a && values.b) {
                result = { c: Math.sqrt(Math.pow(values.a, 2) + Math.pow(values.b, 2)) };
            } else if (values.c && values.a) {
                result = { b: Math.sqrt(Math.pow(values.c, 2) - Math.pow(values.a, 2)) };
            } else if (values.c && values.b) {
                result = { a: Math.sqrt(Math.pow(values.c, 2) - Math.pow(values.b, 2)) };
            }
            break;
            
        default:
            result = null;
    }
    
    if (!result) {
        document.getElementById('fl-main-result').innerHTML = `
            <div style="text-align:center;color:#ff2d55;">
                <div style="font-size:2rem;margin-bottom:8px;">‚ö†Ô∏è</div>
                <div>Unable to calculate. Please provide sufficient values.</div>
            </div>
        `;
        return;
    }
    
    // Display main result
    const mainResult = document.getElementById('fl-main-result');
    let resultHTML = '<div style="text-align:center;">';
    
    Object.keys(result).forEach(key => {
        const variable = flCurrentFormula.variables.find(v => v.symbol === key);
        const unitText = showUnits ? ` ${variable.unit}` : '';
        resultHTML += `
            <div style="margin-bottom:12px;">
                <div style="font-size:1.2rem;color:rgba(230,250,255,0.7);">${key}</div>
                <div style="font-size:2.5rem;color:#39ff14;font-weight:700;">${result[key].toFixed(4)}</div>
                <div style="font-size:0.9rem;color:rgba(230,250,255,0.5);">${variable.name}${unitText}</div>
            </div>
        `;
    });
    
    resultHTML += '</div>';
    mainResult.innerHTML = resultHTML;
    
    // Generate steps if enabled
    if (showSteps) {
        const stepsContainer = document.getElementById('fl-steps-container');
        const stepsDiv = document.getElementById('fl-steps');
        
        let stepsHTML = '';
        switch(flCurrentFormula.id) {
            case 'newton2':
                if (values.m && values.a) {
                    stepsHTML = `
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">1.</div>
                            <div>Newton's Second Law states: F = m √ó a</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">2.</div>
                            <div>Given: m = ${values.m} kg, a = ${values.a} m/s¬≤</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">3.</div>
                            <div>Calculation: F = ${values.m} √ó ${values.a}</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">4.</div>
                            <div>Result: F = ${result.F.toFixed(4)} N</div>
                        </div>
                    `;
                }
                break;
                
            case 'pythagorean':
                if (values.a && values.b) {
                    stepsHTML = `
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">1.</div>
                            <div>Pythagorean Theorem: a¬≤ + b¬≤ = c¬≤</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">2.</div>
                            <div>Given: a = ${values.a}, b = ${values.b}</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">3.</div>
                            <div>Calculation: c = ‚àö(${values.a}¬≤ + ${values.b}¬≤) = ‚àö(${Math.pow(values.a, 2)} + ${Math.pow(values.b, 2)})</div>
                        </div>
                        <div style="margin-bottom:12px;padding-left:20px;position:relative;">
                            <div style="position:absolute;left:0;top:0;color:var(--accent);font-weight:600;">4.</div>
                            <div>Result: c = ${result.c.toFixed(4)}</div>
                        </div>
                    `;
                }
                break;
        }
        
        if (stepsHTML) {
            stepsDiv.innerHTML = stepsHTML;
            stepsContainer.style.display = 'block';
        }
    } else {
        document.getElementById('fl-steps-container').style.display = 'none';
    }
    
    // Show visualization if enabled
    if (showViz) {
        flCreateVisualization(values, result);
        document.getElementById('fl-visualization-container').style.display = 'block';
    } else {
        document.getElementById('fl-visualization-container').style.display = 'none';
    }
    
    // Animation
    mainResult.style.animation = 'flPulse 0.5s ease';
    setTimeout(() => {
        mainResult.style.animation = '';
    }, 500);
}

function flCreateVisualization(values, result) {
    const canvas = document.getElementById('fl-chart-canvas');
    const container = document.getElementById('fl-visualization');
    
    // Set canvas size
    canvas.width = container.clientWidth - 40;
    canvas.height = 200;
    
    const ctx = canvas.getContext('2d');
    
    // Clear canvas
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    // Draw based on current formula
    switch(flCurrentFormula.id) {
        case 'newton2':
            flDrawForceDiagram(ctx, canvas, values, result);
            break;
        case 'pythagorean':
            flDrawTriangle(ctx, canvas, values, result);
            break;
        default:
            flDrawGenericChart(ctx, canvas, values, result);
    }
}

function flDrawForceDiagram(ctx, canvas, values, result) {
    const centerX = canvas.width / 2;
    const centerY = canvas.height / 2;
    
    // Draw object
    const radius = 40;
    ctx.fillStyle = 'rgba(45,212,255,0.3)';
    ctx.strokeStyle = 'rgba(45,212,255,0.8)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(centerX, centerY, radius, 0, Math.PI * 2);
    ctx.fill();
    ctx.stroke();
    
    // Draw force arrow
    const force = result.F || 0;
    const arrowLength = Math.min(100, Math.max(20, force / 10));
    
    ctx.strokeStyle = '#39ff14';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(centerX + radius, centerY);
    ctx.lineTo(centerX + radius + arrowLength, centerY);
    ctx.stroke();
    
    // Draw arrowhead
    ctx.fillStyle = '#39ff14';
    ctx.beginPath();
    ctx.moveTo(centerX + radius + arrowLength, centerY);
    ctx.lineTo(centerX + radius + arrowLength - 10, centerY - 5);
    ctx.lineTo(centerX + radius + arrowLength - 10, centerY + 5);
    ctx.closePath();
    ctx.fill();
    
    // Draw labels
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    ctx.fillText('F = ' + (result.F?.toFixed(2) || '?') + ' N', centerX, centerY - radius - 20);
    ctx.fillText('m = ' + (values.m || '?') + ' kg', centerX, centerY + radius + 20);
    ctx.fillText('a = ' + (values.a || '?') + ' m/s¬≤', centerX, centerY + radius + 40);
}

function flDrawTriangle(ctx, canvas, values, result) {
    const padding = 40;
    const triangleHeight = canvas.height - 2 * padding;
    const triangleWidth = canvas.width - 2 * padding;
    
    // Draw triangle
    ctx.strokeStyle = 'rgba(45,212,255,0.8)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(padding, padding + triangleHeight);
    ctx.lineTo(padding, padding);
    ctx.lineTo(padding + triangleWidth, padding + triangleHeight);
    ctx.closePath();
    ctx.stroke();
    
    // Draw right angle indicator
    ctx.strokeStyle = 'rgba(57,255,20,0.8)';
    ctx.lineWidth = 2;
    const rightAngleSize = 15;
    ctx.beginPath();
    ctx.moveTo(padding, padding + triangleHeight - rightAngleSize);
    ctx.lineTo(padding, padding + triangleHeight);
    ctx.lineTo(padding + rightAngleSize, padding + triangleHeight);
    ctx.stroke();
    
    // Draw labels
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 14px Arial';
    ctx.textAlign = 'center';
    
    // Side a
    const aX = padding + triangleWidth / 2;
    const aY = padding + triangleHeight / 2;
    ctx.fillText('a = ' + (values.a || '?'), aX + 20, aY - 10);
    
    // Side b
    const bX = padding + triangleWidth / 4;
    const bY = padding + triangleHeight * 0.75;
    ctx.fillText('b = ' + (values.b || '?'), bX, bY + 20);
    
    // Hypotenuse c
    const cX = padding + triangleWidth / 2;
    const cY = padding + triangleHeight / 4;
    ctx.fillText('c = ' + (result.c?.toFixed(2) || '?'), cX, cY - 10);
    
    // Formula
    ctx.font = 'bold 16px Arial';
    ctx.fillStyle = 'var(--accent)';
    ctx.fillText('a¬≤ + b¬≤ = c¬≤', canvas.width / 2, padding - 10);
}

function flExample() {
    if (!flCurrentFormula) return;
    
    // Set example values based on current formula
    switch(flCurrentFormula.id) {
        case 'newton2':
            document.getElementById('fl-input-m').value = '10';
            document.getElementById('fl-input-a').value = '9.8';
            break;
        case 'ohm':
            document.getElementById('fl-input-I').value = '2';
            document.getElementById('fl-input-R').value = '6';
            break;
        case 'pythagorean':
            document.getElementById('fl-input-a').value = '3';
            document.getElementById('fl-input-b').value = '4';
            break;
        case 'density':
            document.getElementById('fl-input-m').value = '1';
            document.getElementById('fl-input-V').value = '0.001';
            break;
    }
    
    // Auto-calculate after setting values
    setTimeout(flCalculate, 300);
}

function flClearInputs() {
    if (!flCurrentFormula) return;
    
    flCurrentFormula.variables.forEach(variable => {
        const input = document.getElementById(`fl-input-${variable.symbol}`);
        if (input) {
            input.value = variable.default || '';
        }
    });
}

function flReset() {
    // Reset to default state
    flSelectCategory('physics');
    flClearInputs();
    
    // Clear results
    document.getElementById('fl-main-result').innerHTML = `
        <div style="text-align:center;color:rgba(230,250,255,0.5);">
            <div style="font-size:2rem;margin-bottom:8px;">üìê</div>
            <div>Enter values and click "Calculate" to see results</div>
        </div>
    `;
    
    // Hide containers
    document.getElementById('fl-steps-container').style.display = 'none';
    document.getElementById('fl-visualization-container').style.display = 'none';
}

function flCopyResult() {
    const mainResult = document.getElementById('fl-main-result').textContent;
    if (!mainResult || mainResult.includes('Enter values')) return;
    
    let text = `Formula: ${flCurrentFormula.name}\n`;
    text += `Result: ${mainResult}\n\n`;
    
    if (document.getElementById('fl-steps-container').style.display !== 'none') {
        text += 'Steps:\n' + document.getElementById('fl-steps').textContent;
    }
    
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const button = document.querySelector('[onclick="flCopyResult()"]');
        const original = button.innerHTML;
        button.innerHTML = '‚úÖ Copied!';
        button.style.color = '#39ff14';
        
        setTimeout(() => {
            button.innerHTML = original;
            button.style.color = '';
        }, 2000);
    });
}

function flSaveCalculation() {
    const mainResult = document.getElementById('fl-main-result').textContent;
    if (!mainResult || mainResult.includes('Enter values')) return;
    
    const data = {
        timestamp: new Date().toISOString(),
        formula: flCurrentFormula.name,
        result: mainResult,
        variables: {}
    };
    
    flCurrentFormula.variables.forEach(variable => {
        const input = document.getElementById(`fl-input-${variable.symbol}`);
        if (input && input.value) {
            data.variables[variable.symbol] = input.value;
        }
    });
    
    const dataStr = JSON.stringify(data, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
    
    const link = document.createElement('a');
    link.download = `formula-calc-${Date.now()}.json`;
    link.href = dataUri;
    link.click();
}

// Add keyboard shortcut (Enter to calculate)
document.addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.target.matches('textarea, input[type="text"]')) {
        e.preventDefault();
        flCalculate();
    }
});

// Initialize
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // Load default category
        flSelectCategory('physics');
        
        // Set default checkboxes
        document.getElementById('fl-show-steps').checked = true;
        document.getElementById('fl-show-units').checked = true;
        document.getElementById('fl-show-visualization').checked = false;
        
        console.log('Formula Library ready');
    });
}
</script>

<style>
@keyframes flPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

#formula-library-title {
    color: var(--accent);
    margin-top: 0;
    text-align: center;
    position: relative;
    padding-bottom: 12px;
}

#formula-library-title::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 25%;
    width: 50%;
    height: 2px;
    background: linear-gradient(90deg, transparent, var(--accent), #39ff14, transparent);
    border-radius: 2px;
}

select {
    transition: all 0.2s ease;
    cursor: pointer;
}

select:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45,212,255,0.1);
}

button {
    transition: all 0.2s ease;
}

button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

#fl-formula-display {
    font-family: 'Cambria Math', 'Times New Roman', serif;
    text-shadow: 0 0 10px rgba(45,212,255,0.3);
}

@media (max-width: 768px) {
    #fl-inputs-container {
        grid-template-columns: 1fr !important;
    }
    
    #fl-related-formulas {
        grid-template-columns: 1fr !important;
    }
    
    .actions button {
        padding: 12px !important;
        font-size: 0.9rem !important;
    }
}
</style>
