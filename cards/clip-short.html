<h2 id="clip-shorts-title" style="margin-top:0;">üé¨ Clip‚Äëto‚ÄëShorts Repackager</h2>

<form aria-describedby="clip-shorts-desc">
  <p id="clip-shorts-desc" class="small">
    Upload a gameplay clip, pick a segment, and export a perfectly framed vertical short (9:16) or other preset. Adds caption safe zone and optional watermark.
  </p>

  <!-- INPUT SECTION -->
  <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;margin-bottom:20px;">
    <div style="color:#2dd4ff;font-weight:600;margin-bottom:15px;">üìÅ Upload & Settings:</div>
    
    <!-- VIDEO UPLOAD -->
    <div style="margin-bottom:20px;">
      <label for="clip-file" style="display:block;margin-bottom:8px;color:rgba(230,250,255,0.8);font-size:14px;">
        <span style="color:#ffa500;">Video File Upload</span>
      </label>
      <div style="border:2px dashed rgba(255,165,0,0.3);border-radius:8px;padding:20px;text-align:center;background:rgba(255,165,0,0.05);">
        <input id="clip-file" type="file" accept="video/*" 
               style="display:none;" />
        <div style="margin-bottom:10px;">
          <button type="button" onclick="document.getElementById('clip-file').click()" 
                  style="background:rgba(255,165,0,0.2);color:#ffa500;border:1px solid rgba(255,165,0,0.4);padding:10px 20px;border-radius:6px;cursor:pointer;font-weight:500;">
            üìÅ Choose Video File
          </button>
        </div>
        <div id="clip-filename" style="color:rgba(255,165,0,0.8);font-size:14px;margin-top:8px;">
          No file selected (MP4, MOV, AVI, etc.)
        </div>
        <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
          Max recommended: 500MB, 5 minutes for best performance
        </div>
      </div>
    </div>
    
    <!-- OUTPUT SETTINGS -->
    <div style="margin-bottom:20px;">
      <div style="color:#2dd4ff;font-weight:600;margin-bottom:10px;font-size:14px;">üéØ Output Settings:</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div>
          <label for="clip-aspect" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#39ff14;">Aspect Ratio</span>
          </label>
          <select id="clip-aspect" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:#e6faff;font-size:16px;">
            <option value="9:16" selected>TikTok/Reels (9:16)</option>
            <option value="1:1">Instagram Post (1:1)</option>
            <option value="16:9">YouTube (16:9)</option>
            <option value="4:5">Instagram Story (4:5)</option>
            <option value="3:4">Facebook Feed (3:4)</option>
          </select>
        </div>
        
        <div>
          <label for="clip-scale" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#9d4edd;">Fit Mode</span>
          </label>
          <select id="clip-scale" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(157,78,221,0.3);background:rgba(157,78,221,0.05);color:#e6faff;font-size:16px;">
            <option value="cover" selected>Cover (crop to fill)</option>
            <option value="contain">Contain (letterbox)</option>
            <option value="stretch">Stretch (fill, no crop)</option>
          </select>
        </div>
      </div>
    </div>
    
    <!-- TIME SELECTION -->
    <div style="margin-bottom:20px;">
      <div style="color:#2dd4ff;font-weight:600;margin-bottom:10px;font-size:14px;">‚è±Ô∏è Segment Selection:</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div>
          <label for="clip-start" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#ffcc00;">Start Time (seconds)</span>
          </label>
          <input id="clip-start" type="number" min="0" step="0.1" placeholder="e.g. 12.5" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,204,0,0.3);background:rgba(255,204,0,0.05);color:#e6faff;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
            Beginning of clip
          </div>
        </div>
        
        <div>
          <label for="clip-end" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#e83e8c;">End Time (seconds)</span>
          </label>
          <input id="clip-end" type="number" min="0" step="0.1" placeholder="e.g. 42.0" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(232,62,140,0.3);background:rgba(232,62,140,0.05);color:#e6faff;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
            Max 60 seconds recommended
          </div>
        </div>
      </div>
      
      <!-- Time slider will be added here dynamically -->
      <div id="cs-time-slider-container" style="margin-top:15px;display:none;">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
          <span style="color:rgba(230,250,255,0.7);font-size:13px;">0s</span>
          <span style="color:#2dd4ff;font-size:13px;" id="cs-current-time">0:00</span>
          <span style="color:rgba(230,250,255,0.7);font-size:13px;" id="cs-total-time">0:00</span>
        </div>
        <input type="range" id="cs-time-slider" min="0" max="100" value="0" step="0.1"
               style="width:100%;height:6px;border-radius:3px;background:linear-gradient(to right, #ff4d4d, #ffa500, #39ff14);outline:none;">
        <div style="display:flex;justify-content:space-between;margin-top:8px;">
          <button type="button" id="cs-set-start" style="padding:4px 12px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:4px;color:#ffcc00;cursor:pointer;font-size:12px;">Set Start</button>
          <button type="button" id="cs-set-end" style="padding:4px 12px;background:rgba(232,62,140,0.1);border:1px solid rgba(232,62,140,0.3);border-radius:4px;color:#e83e8c;cursor:pointer;font-size:12px;">Set End</button>
          <button type="button" id="cs-play-segment" style="padding:4px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:4px;color:#2dd4ff;cursor:pointer;font-size:12px;">‚ñ∂Ô∏è Preview</button>
        </div>
      </div>
    </div>
    
    <!-- OVERLAY OPTIONS -->
    <div>
      <div style="color:#2dd4ff;font-weight:600;margin-bottom:10px;font-size:14px;">üé® Overlays & Branding:</div>
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;">
        <div>
          <label for="clip-caption" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#4dabf7;">Caption Text</span>
          </label>
          <input id="clip-caption" type="text" placeholder="Short caption to overlay" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(77,171,247,0.3);background:rgba(77,171,247,0.05);color:#e6faff;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
            Bottom safe zone
          </div>
        </div>
        
        <div>
          <label for="clip-watermark" style="display:block;margin-bottom:6px;color:rgba(230,250,255,0.8);font-size:14px;">
            <span style="color:#39ff14;">Watermark</span>
          </label>
          <input id="clip-watermark" type="file" accept="image/*" 
                 style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:#e6faff;font-size:16px;" />
          <div style="font-size:12px;color:rgba(230,250,255,0.6);margin-top:4px;">
            PNG with transparency recommended
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- QUICK PRESETS -->
  <div style="margin-bottom:25px;">
    <div style="color:rgba(230,250,255,0.8);margin-bottom:10px;font-size:14px;">Quick Presets:</div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button type="button" class="cs-preset-btn" data-aspect="9:16" data-scale="cover" data-caption="EPIC MOMENT"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        üéÆ Gaming Clip (9:16)
      </button>
      <button type="button" class="cs-preset-btn" data-aspect="1:1" data-scale="contain" data-caption="New Post"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        üì∏ Instagram Square
      </button>
      <button type="button" class="cs-preset-btn" data-aspect="16:9" data-scale="cover" data-caption="Gameplay Highlight"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        ‚ñ∂Ô∏è YouTube Short
      </button>
      <button type="button" class="cs-preset-btn" data-aspect="4:5" data-scale="cover" data-caption="Watch Full Video!"
              style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;cursor:pointer;color:#e6faff;font-size:13px;">
        üì± Story Preview
      </button>
    </div>
  </div>
  
  <!-- GENERATE BUTTON -->
  <div style="text-align:center;margin:25px 0;">
    <button id="cs-generate-btn" 
            style="background:#2dd4ff;color:#000;border:none;padding:14px 32px;border-radius:10px;cursor:pointer;font-size:16px;font-weight:600;box-shadow:0 4px 15px rgba(45,212,255,0.3);">
      üé¨ GENERATE SHORT
    </button>
    
    <button id="cs-reset-btn" 
            style="background:rgba(255,255,255,0.08);color:#e6faff;border:1px solid rgba(255,255,255,0.2);padding:14px 24px;border-radius:10px;cursor:pointer;font-size:16px;margin-left:12px;">
      Reset All
    </button>
  </div>
  
  <!-- RESULTS -->
  <div id="cs-results" style="display:none;">
    <div style="background:rgba(20,20,20,0.7);border-radius:10px;padding:25px;border:1px solid rgba(57,255,20,0.2);margin-bottom:25px;">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;">
        <div style="color:#39ff14;font-size:18px;font-weight:600;">üé• Output Preview</div>
        <button id="cs-copy-btn" 
                style="background:rgba(57,255,20,0.1);color:#39ff14;border:1px solid rgba(57,255,20,0.3);padding:8px 16px;border-radius:6px;cursor:pointer;font-size:14px;">
          üíæ Save Video
        </button>
      </div>
      
      <!-- PREVIEW -->
      <div style="background:rgba(0,0,0,0.3);border-radius:8px;padding:15px;margin-bottom:20px;">
        <div style="color:rgba(230,250,255,0.8);margin-bottom:8px;font-size:14px;">Preview:</div>
        <video id="clip-preview" controls 
               style="width:100%;border-radius:6px;background:#000;max-height:400px;"></video>
      </div>
      
      <!-- OUTPUT INFO -->
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin-bottom:20px;">
        <div style="background:rgba(45,212,255,0.1);padding:12px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);text-align:center;">
          <div style="color:#2dd4ff;font-size:12px;">Duration</div>
          <div style="font-size:16px;font-weight:600;color:#e6faff;" id="cs-output-duration">0s</div>
        </div>
        <div style="background:rgba(57,255,20,0.1);padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.2);text-align:center;">
          <div style="color:#39ff14;font-size:12px;">Resolution</div>
          <div style="font-size:16px;font-weight:600;color:#e6faff;" id="cs-output-resolution">0x0</div>
        </div>
        <div style="background:rgba(255,165,0,0.1);padding:12px;border-radius:8px;border:1px solid rgba(255,165,0,0.2);text-align:center;">
          <div style="color:#ffa500;font-size:12px;">Aspect Ratio</div>
          <div style="font-size:16px;font-weight:600;color:#e6faff;" id="cs-output-aspect">0:0</div>
        </div>
        <div style="background:rgba(157,78,221,0.1);padding:12px;border-radius:8px;border:1px solid rgba(157,78,221,0.2);text-align:center;">
          <div style="color:#9d4edd;font-size:12px;">Format</div>
          <div style="font-size:16px;font-weight:600;color:#e6faff;">MP4/WebM</div>
        </div>
      </div>
      
      <!-- STATUS -->
      <div style="padding:12px;background:rgba(45,212,255,0.1);border-radius:6px;border:1px solid rgba(45,212,255,0.3);">
        <div style="color:#2dd4ff;font-size:14px;display:flex;justify-content:space-between;">
          <span>Status: <span id="cs-status" style="color:#39ff14;">Ready</span></span>
          <span id="cs-hint" style="color:rgba(230,250,255,0.7);"></span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- TIPS -->
  <div id="cs-tips" style="margin-top:25px;display:block;">
    <div style="background:rgba(30,30,30,0.5);border-radius:10px;padding:20px;border:1px solid rgba(255,165,0,0.2);">
      <div style="color:#ffa500;font-weight:600;margin-bottom:15px;font-size:16px;">
        üí° Shorts Creation Tips
      </div>
      
      <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:15px;">
        <div style="background:rgba(255,165,0,0.05);padding:12px;border-radius:8px;border-left:3px solid #ffa500;">
          <div style="color:#ffa500;font-weight:600;margin-bottom:5px;">Optimal Length</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">
            ‚Ä¢ TikTok/Reels: 9-15 seconds<br>
            ‚Ä¢ YouTube Shorts: 15-60 seconds<br>
            ‚Ä¢ Instagram: 3-15 seconds<br>
            ‚Ä¢ Keep attention in first 3 seconds
          </div>
        </div>
        
        <div style="background:rgba(45,212,255,0.05);padding:12px;border-radius:8px;border-left:3px solid #2dd4ff;">
          <div style="color:#2dd4ff;font-weight:600;margin-bottom:5px;">Safe Zones</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">
            ‚Ä¢ Keep text in center 80%<br>
            ‚Ä¢ Avoid bottom 20% for captions<br>
            ‚Ä¢ Top corners for branding<br>
            ‚Ä¢ Middle for key action
          </div>
        </div>
        
        <div style="background:rgba(157,78,221,0.05);padding:12px;border-radius:8px;border-left:3px solid #9d4edd;">
          <div style="color:#9d4edd;font-weight:600;margin-bottom:5px;">Quality Tips</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">
            ‚Ä¢ Export at 1080x1920 for 9:16<br>
            ‚Ä¢ 30 FPS for most platforms<br>
            ‚Ä¢ H.264 codec for compatibility<br>
            ‚Ä¢ Keep file under 100MB
          </div>
        </div>
        
        <div style="background:rgba(57,255,20,0.05);padding:12px;border-radius:8px;border-left:3px solid #39ff14;">
          <div style="color:#39ff14;font-weight:600;margin-bottom:5px;">Engagement</div>
          <div style="color:rgba(230,250,255,0.8);font-size:14px;">
            ‚Ä¢ Hook in first second<br>
            ‚Ä¢ Add captions for silent viewing<br>
            ‚Ä¢ Use bold text overlays<br>
            ‚Ä¢ End with call-to-action
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- ERROR -->
  <div id="cs-error" style="margin-top:20px;padding:15px;background:rgba(255,77,77,0.1);border-radius:8px;border:1px solid rgba(255,77,77,0.3);display:none;">
    <div style="color:#ff4d4d;font-weight:600;margin-bottom:5px;">‚ö†Ô∏è Please check your input</div>
    <div id="cs-error-text" style="color:rgba(255,77,77,0.9);"></div>
  </div>
</form>

<style>
#clip-shorts-title { 
  color: #2dd4ff; 
  margin-top: 0;
  margin-bottom: 10px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .cs-preset-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
  
  #cs-generate-btn, #cs-reset-btn {
    width: 100%;
    margin: 5px 0 !important;
  }
}
</style>

<script>
/* clip-shorts.html
   - Complete Clip-to-Shorts repackager
   - Scoped with cs- prefix
*/

let csRecorder = null;
let csRecordedBlobs = [];
let csMediaStream = null;
let csRecordingInProgress = false;
let csSourceVideo = null;
let csSourceVideoURL = null;
let csIsPlayingSegment = false;

// Initialize
function csInit() {
    console.log("Clip-to-Shorts: Initializing...");
    
    // File upload handler
    const fileInput = document.getElementById('clip-file');
    const filenameDisplay = document.getElementById('clip-filename');
    
    fileInput.addEventListener('change', function() {
        if (this.files.length > 0) {
            const file = this.files[0];
            filenameDisplay.textContent = `üìÅ ${file.name} (${csFormatFileSize(file.size)})`;
            filenameDisplay.style.color = '#39ff14';
            
            // Preview video and setup timeline
            csPreviewVideo(file);
        } else {
            filenameDisplay.textContent = 'No file selected (MP4, MOV, AVI, etc.)';
            filenameDisplay.style.color = 'rgba(255,165,0,0.8)';
        }
    });
    
    // Preset buttons
    const presetBtns = document.querySelectorAll('.cs-preset-btn');
    presetBtns.forEach(btn => {
        btn.addEventListener('click', function() {
            document.getElementById('clip-aspect').value = this.dataset.aspect;
            document.getElementById('clip-scale').value = this.dataset.scale;
            document.getElementById('clip-caption').value = this.dataset.caption || '';
            
            // Visual feedback
            presetBtns.forEach(b => {
                b.style.background = 'rgba(255,255,255,0.05)';
                b.style.border = '1px solid rgba(255,255,255,0.1)';
            });
            this.style.background = 'rgba(45,212,255,0.15)';
            this.style.border = '1px solid #2dd4ff';
            
            csClearResults();
        });
    });
    
    // Generate button
    document.getElementById('cs-generate-btn').addEventListener('click', csGenerate);
    
    // Reset button
    document.getElementById('cs-reset-btn').addEventListener('click', csResetAll);
    
    // Save button
    document.getElementById('cs-copy-btn').addEventListener('click', csSaveVideo);
    
    console.log("‚úÖ Clip-to-Shorts ready!");
}

// Preview uploaded video
function csPreviewVideo(file) {
    if (csSourceVideoURL) {
        URL.revokeObjectURL(csSourceVideoURL);
    }
    
    csSourceVideoURL = URL.createObjectURL(file);
    csSourceVideo = document.createElement('video');
    csSourceVideo.src = csSourceVideoURL;
    csSourceVideo.muted = true;
    
    csSourceVideo.onloadedmetadata = function() {
        const duration = csSourceVideo.duration;
        const sliderContainer = document.getElementById('cs-time-slider-container');
        const slider = document.getElementById('cs-time-slider');
        const totalTimeDisplay = document.getElementById('cs-total-time');
        const startInput = document.getElementById('clip-start');
        const endInput = document.getElementById('clip-end');
        
        // Setup slider
        slider.max = Math.floor(duration);
        slider.value = 0;
        totalTimeDisplay.textContent = csFormatTime(duration);
        
        // Set default end time (max 60 seconds or duration)
        const defaultEnd = Math.min(duration, 60);
        startInput.value = '0';
        endInput.value = defaultEnd.toFixed(1);
        
        // Show slider container
        sliderContainer.style.display = 'block';
        
        // Update current time display when slider changes
        slider.addEventListener('input', function() {
            const time = parseFloat(this.value);
            document.getElementById('cs-current-time').textContent = csFormatTime(time);
            csSourceVideo.currentTime = time;
        });
        
        // Set start/end buttons
        document.getElementById('cs-set-start').addEventListener('click', function() {
            const currentTime = csSourceVideo.currentTime;
            startInput.value = currentTime.toFixed(1);
        });
        
        document.getElementById('cs-set-end').addEventListener('click', function() {
            const currentTime = csSourceVideo.currentTime;
            endInput.value = currentTime.toFixed(1);
        });
        
        // Preview segment button
        document.getElementById('cs-play-segment').addEventListener('click', function() {
            csPlaySegment();
        });
        
        console.log("Video loaded:", duration.toFixed(1) + "s");
    };
}

// Play selected segment
function csPlaySegment() {
    if (!csSourceVideo) return;
    
    const start = parseFloat(document.getElementById('clip-start').value) || 0;
    const end = parseFloat(document.getElementById('clip-end').value) || Math.min(csSourceVideo.duration, 60);
    
    csSourceVideo.currentTime = start;
    csSourceVideo.play();
    csIsPlayingSegment = true;
    
    // Stop at end time
    const checkEnd = setInterval(() => {
        if (csSourceVideo.currentTime >= end || csSourceVideo.paused) {
            csSourceVideo.pause();
            csIsPlayingSegment = false;
            clearInterval(checkEnd);
        }
    }, 100);
}

// Format file size
function csFormatFileSize(bytes) {
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

// Format time (seconds to MM:SS)
function csFormatTime(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
}

// Parse aspect ratio
function csParseAspect(aspect) {
    const [w, h] = aspect.split(':').map(Number);
    return { w, h };
}

// Reset all
function csResetAll() {
    document.getElementById('clip-file').value = '';
    document.getElementById('clip-filename').textContent = 'No file selected (MP4, MOV, AVI, etc.)';
    document.getElementById('clip-filename').style.color = 'rgba(255,165,0,0.8)';
    document.getElementById('clip-aspect').value = '9:16';
    document.getElementById('clip-scale').value = 'cover';
    document.getElementById('clip-start').value = '';
    document.getElementById('clip-end').value = '';
    document.getElementById('clip-caption').value = '';
    document.getElementById('clip-watermark').value = '';
    
    // Hide preview
    document.getElementById('cs-time-slider-container').style.display = 'none';
    
    // Clear results
    csClearResults();
    
    // Cleanup
    if (csSourceVideoURL) {
        URL.revokeObjectURL(csSourceVideoURL);
        csSourceVideoURL = null;
    }
    
    csStopRecording();
    
    // Reset preset buttons
    document.querySelectorAll('.cs-preset-btn').forEach(btn => {
        btn.style.background = 'rgba(255,255,255,0.05)';
        btn.style.border = '1px solid rgba(255,255,255,0.1)';
    });
    
    console.log("Clip-to-Shorts reset");
}

// Clear results
function csClearResults() {
    document.getElementById('cs-results').style.display = 'none';
    document.getElementById('cs-error').style.display = 'none';
    document.getElementById('cs-status').textContent = 'Ready';
    document.getElementById('cs-status').style.color = '#39ff14';
    document.getElementById('cs-hint').textContent = '';
}

// Show error
function csShowError(message) {
    document.getElementById('cs-error-text').textContent = message;
    document.getElementById('cs-error').style.display = 'block';
    document.getElementById('cs-status').textContent = 'Error';
    document.getElementById('cs-status').style.color = '#ff4d4d';
}

// Generate short
async function csGenerate() {
    console.log("Generating short...");
    
    // Hide previous results/errors
    csClearResults();
    
    // Get inputs
    const file = document.getElementById('clip-file').files[0];
    if (!file) {
        csShowError("Please upload a video file first");
        return;
    }
    
    const aspect = document.getElementById('clip-aspect').value;
    const fitMode = document.getElementById('clip-scale').value;
    const start = parseFloat(document.getElementById('clip-start').value) || 0;
    const end = parseFloat(document.getElementById('clip-end').value);
    const caption = document.getElementById('clip-caption').value.trim();
    const watermarkFile = document.getElementById('clip-watermark').files[0];
    
    // Validation
    if (!end || end <= start) {
        csShowError("End time must be greater than start time");
        return;
    }
    
    const duration = end - start;
    if (duration > 60) {
        csShowError("Segment cannot exceed 60 seconds for best performance");
        return;
    }
    
    document.getElementById('cs-status').textContent = "Processing...";
    document.getElementById('cs-status').style.color = "#ffa500";
    document.getElementById('cs-hint').textContent = "This may take a moment for longer clips";
    
    try {
        // Create source video
        if (!csSourceVideo || !csSourceVideoURL) {
            csSourceVideoURL = URL.createObjectURL(file);
            csSourceVideo = document.createElement('video');
            csSourceVideo.src = csSourceVideoURL;
            csSourceVideo.muted = true;
            
            await new Promise((resolve, reject) => {
                csSourceVideo.onloadedmetadata = resolve;
                csSourceVideo.onerror = reject;
            });
        }
        
        // Calculate output dimensions
        const aspectRatio = csParseAspect(aspect);
        const baseHeight = 1080; // Standard short height
        let outputWidth, outputHeight;
        
        if (aspectRatio.w / aspectRatio.h >= 1) {
            // Landscape or square
            outputWidth = 1080;
            outputHeight = Math.round(outputWidth * (aspectRatio.h / aspectRatio.w));
        } else {
            // Portrait
            outputHeight = baseHeight;
            outputWidth = Math.round(outputHeight * (aspectRatio.w / aspectRatio.h));
        }
        
        // Create canvas
        const canvas = document.createElement('canvas');
        canvas.width = outputWidth;
        canvas.height = outputHeight;
        const ctx = canvas.getContext('2d');
        
        // Load watermark if provided
        let watermarkImg = null;
        if (watermarkFile) {
            watermarkImg = await new Promise(resolve => {
                const reader = new FileReader();
                reader.onload = e => {
                    const img = new Image();
                    img.onload = () => resolve(img);
                    img.src = e.target.result;
                };
                reader.readAsDataURL(watermarkFile);
            });
        }
        
        // Set source video to start time
        csSourceVideo.currentTime = start;
        
        // Wait for seek to complete
        await new Promise(resolve => {
            csSourceVideo.onseeked = resolve;
        });
        
        // Create MediaRecorder
        csMediaStream = canvas.captureStream(30);
        csRecordedBlobs = [];
        
        // Try different mimeTypes
        const mimeTypes = [
            'video/webm;codecs=vp9',
            'video/webm;codecs=vp8',
            'video/webm'
        ];
        
        let recorder;
        for (const mimeType of mimeTypes) {
            try {
                recorder = new MediaRecorder(csMediaStream, { mimeType });
                break;
            } catch (e) {
                continue;
            }
        }
        
        if (!recorder) {
            recorder = new MediaRecorder(csMediaStream);
        }
        
        csRecorder = recorder;
        
        // Handle recording events
        csRecorder.ondataavailable = event => {
            if (event.data && event.data.size > 0) {
                csRecordedBlobs.push(event.data);
            }
        };
        
        csRecorder.onstop = () => {
            const blob = new Blob(csRecordedBlobs, { type: 'video/webm' });
            const url = URL.createObjectURL(blob);
            const preview = document.getElementById('clip-preview');
            preview.src = url;
            
            // Update output info
            document.getElementById('cs-output-duration').textContent = duration.toFixed(1) + 's';
            document.getElementById('cs-output-resolution').textContent = `${outputWidth}√ó${outputHeight}`;
            document.getElementById('cs-output-aspect').textContent = aspect;
            
            // Show results
            document
