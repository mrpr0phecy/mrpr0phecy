<h2 id="music-quiz-title" style="margin-top:0;">üéµ Ultimate Music Quiz</h2>

<!-- Manifest metadata -->
<!--
  id: music-quiz
  title: Ultimate Music Quiz
  path: cards/music-quiz.html
  category: Education & Entertainment
  version: 2.0
  viral_tags: [music, quiz, education, trivia, game, social]
  accessibility: [keyboard_nav, screen_reader, high_contrast]
  languages: [en, es, fr, de, zh, ja, pt]
  features: [interactive_quiz, score_tracking, multiplayer, sharing, leaderboard]
-->

<div id="music-quiz-desc" style="margin-bottom:20px;">
  <p style="margin:0 0 12px 0;color:var(--muted);font-size:14px;line-height:1.5;">
    <span style="color:var(--accent);font-weight:600;">Interactive music knowledge challenge</span>: Test your expertise across theory, history, instruments, and pop culture. Complete with scoring, explanations, and shareable results!
  </p>
  
  <!-- Quiz Stats -->
  <div style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:12px;">
    <div style="flex:1;min-width:200px;">
      <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
        <span style="color:var(--muted);font-size:13px;">Your Highest Score</span>
        <span id="mq-high-score" style="color:var(--accent);font-weight:600;">0</span>
      </div>
      <div style="height:8px;background:var(--glass);border-radius:4px;overflow:hidden;">
        <div id="mq-score-progress" style="height:100%;background:linear-gradient(90deg, var(--accent), #9d4edd);width:0%;transition:width 0.5s;"></div>
      </div>
    </div>
    
    <div style="display:flex;gap:12px;">
      <div style="text-align:center;">
        <div style="color:var(--muted);font-size:11px;">Quizzes</div>
        <div id="mq-stats-quizzes" style="color:var(--accent);font-size:18px;font-weight:600;">0</div>
      </div>
      <div style="text-align:center;">
        <div style="color:var(--muted);font-size:11px;">Accuracy</div>
        <div id="mq-stats-accuracy" style="color:#39ff14;font-size:18px;font-weight:600;">0%</div>
      </div>
      <div style="text-align:center;">
        <div style="color:var(--muted);font-size:11px;">Streak</div>
        <div id="mq-stats-streak" style="color:#ffcc00;font-size:18px;font-weight:600;">0</div>
      </div>
    </div>
  </div>
</div>

<!-- Quiz Mode Selection -->
<div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:20px;">
  
  <!-- Quick Play -->
  <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center;">
    <div style="color:var(--accent);font-size:16px;margin-bottom:8px;">‚ö° Quick Play</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">10 random questions</div>
    <button onclick="mqStartQuickPlay()" style="width:100%;padding:12px;background:linear-gradient(135deg, #9d4edd, #ff2d55);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
      Start Now
    </button>
  </div>
  
  <!-- Category Quiz -->
  <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center;">
    <div style="color:var(--accent);font-size:16px;margin-bottom:8px;">üéØ Category Quiz</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">Choose your specialty</div>
    <button onclick="mqShowCategories()" style="width:100%;padding:12px;background:linear-gradient(135deg, #0077cc, #2dd4ff);color:white;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
      Select Category
    </button>
  </div>
  
  <!-- Challenge Mode -->
  <div style="background:rgba(255,255,255,0.03);padding:16px;border-radius:8px;border:1px solid var(--border);text-align:center;">
    <div style="color:var(--accent);font-size:16px;margin-bottom:8px;">üèÜ Challenge</div>
    <div style="color:var(--muted);font-size:13px;margin-bottom:12px;">Beat the clock</div>
    <button onclick="mqStartChallenge()" style="width:100%;padding:12px;background:linear-gradient(135deg, #ff9500, #ffcc00);color:black;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
      60-Second Rush
    </button>
  </div>
</div>

<!-- Quiz Configuration -->
<div style="background:rgba(255,255,255,0.03);padding:20px;border-radius:8px;border:1px solid var(--border);margin-bottom:20px;">
  <h3 style="color:var(--accent);font-size:15px;margin:0 0 16px 0;display:flex;align-items:center;gap:6px;">
    ‚öôÔ∏è Quiz Settings
    <button onclick="mqRandomizeSettings()" style="margin-left:auto;padding:4px 8px;font-size:11px;background:var(--glass);border:1px solid var(--border);border-radius:4px;color:var(--accent);cursor:pointer;">
      Randomize
    </button>
  </h3>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;margin-bottom:16px;">
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Category</label>
      <select id="mq-category" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
        <option value="theory">üéº Music Theory</option>
        <option value="instruments">üéª Instruments</option>
        <option value="history">üìú Music History</option>
        <option value="pop">üé§ Pop Culture</option>
        <option value="genres">üé∏ Genres & Styles</option>
        <option value="composition">üéπ Composition</option>
        <option value="world">üåç World Music</option>
        <option value="mixed" selected>üé≤ Mixed Quiz</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Difficulty</label>
      <select id="mq-difficulty" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
        <option value="beginner" style="color:#39ff14;">üéØ Beginner</option>
        <option value="intermediate" selected style="color:#ffcc00;">üî• Intermediate</option>
        <option value="advanced" style="color:#ff2d55;">‚ö° Advanced</option>
        <option value="expert" style="color:#9d4edd;">üëë Expert</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Number of Questions</label>
      <select id="mq-question-count" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
        <option value="5">5 Questions</option>
        <option value="10" selected>10 Questions</option>
        <option value="15">15 Questions</option>
        <option value="20">20 Questions</option>
        <option value="25">25 Questions</option>
      </select>
    </div>
  </div>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:16px;">
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Question Types</label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input type="checkbox" id="mq-type-mc" checked style="accent-color:var(--accent);"> Multiple Choice
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input type="checkbox" id="mq-type-tf" checked style="accent-color:var(--accent);"> True/False
        </label>
        <label style="display:flex;align-items:center;gap:4px;font-size:13px;">
          <input type="checkbox" id="mq-type-fill" style="accent-color:var(--accent);"> Fill-in-Blank
        </label>
      </div>
    </div>
    
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Timer</label>
      <select id="mq-timer" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
        <option value="none">No Timer</option>
        <option value="30">30 Seconds per Question</option>
        <option value="20" selected>20 Seconds per Question</option>
        <option value="15">15 Seconds per Question</option>
        <option value="10">10 Seconds per Question</option>
      </select>
    </div>
    
    <div>
      <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Sound Effects</label>
      <select id="mq-sound" style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);">
        <option value="on" selected>On</option>
        <option value="off">Off</option>
        <option value="minimal">Minimal</option>
      </select>
    </div>
  </div>
  
  <div class="actions" style="display:flex;gap:10px;margin-top:20px;">
    <button onclick="mqGenerateQuiz()" style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:2px solid var(--accent);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;font-size:16px;">
      üöÄ Generate & Start Quiz
    </button>
    <button onclick="mqExportQuiz()" style="padding:14px 20px;background:var(--glass);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;">
      üì• Export Quiz
    </button>
    <button onclick="mqResetSettings()" style="padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;">
      üßπ Reset
    </button>
  </div>
</div>

<!-- Quiz Interface -->
<div id="mq-quiz-interface" style="display:none;">
  <!-- Quiz Header -->
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px;">
    <div>
      <h3 id="mq-quiz-title" style="color:var(--accent);font-size:18px;margin:0;">Music Quiz</h3>
      <div id="mq-quiz-subtitle" style="color:var(--muted);font-size:13px;">Loading questions...</div>
    </div>
    
    <div style="display:flex;gap:12px;align-items:center;">
      <!-- Timer -->
      <div id="mq-timer-display" style="padding:8px 12px;background:var(--glass);border-radius:6px;border:1px solid var(--border);display:none;">
        <span style="color:var(--accent);font-weight:600;font-family:monospace;">00:00</span>
      </div>
      
      <!-- Score -->
      <div style="text-align:center;">
        <div style="color:var(--muted);font-size:11px;">Score</div>
        <div id="mq-current-score" style="color:var(--accent);font-size:20px;font-weight:600;">0</div>
      </div>
      
      <!-- Progress -->
      <div style="text-align:center;">
        <div style="color:var(--muted);font-size:11px;">Question</div>
        <div id="mq-question-progress" style="color:#9d4edd;font-size:20px;font-weight:600;">0/0</div>
      </div>
    </div>
  </div>
  
  <!-- Question Container -->
  <div id="mq-question-container" style="border:2px solid var(--border);border-radius:12px;padding:24px;background:var(--panel);margin-bottom:20px;">
    <div id="mq-question-text" style="color:var(--text);font-size:18px;margin-bottom:24px;line-height:1.5;min-height:60px;">
      Loading question...
    </div>
    
    <!-- Answer Options -->
    <div id="mq-answer-options" style="display:grid;gap:12px;">
      <!-- Options will be inserted here -->
    </div>
    
    <!-- Fill-in-Blank Input -->
    <div id="mq-fill-container" style="display:none;margin-top:16px;">
      <input id="mq-fill-answer" type="text" placeholder="Type your answer here..." 
             style="width:100%;padding:12px;border-radius:8px;border:2px solid var(--accent);background:var(--glass);color:var(--text);font-size:16px;" />
      <button onclick="mqSubmitFillAnswer()" style="margin-top:12px;padding:12px 24px;background:var(--accent);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600;">
        Submit Answer
      </button>
    </div>
  </div>
  
  <!-- Quiz Controls -->
  <div style="display:flex;gap:10px;justify-content:center;margin-bottom:20px;">
    <button onclick="mqPreviousQuestion()" id="mq-prev-btn" disabled style="padding:12px 20px;background:var(--glass);border:1px solid var(--border);border-radius:8px;color:var(--text);cursor:pointer;min-width:120px;">
      ‚Üê Previous
    </button>
    <button onclick="mqSkipQuestion()" id="mq-skip-btn" style="padding:12px 20px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:8px;color:#ffcc00;cursor:pointer;min-width:120px;">
      ‚è≠Ô∏è Skip
    </button>
    <button onclick="mqNextQuestion()" id="mq-next-btn" style="padding:12px 20px;background:linear-gradient(135deg, #39ff14, #2dd4ff);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600;min-width:120px;">
      Next ‚Üí
    </button>
  </div>
  
  <!-- Quiz Footer -->
  <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:12px;">
    <div style="display:flex;gap:8px;">
      <button onclick="mqPauseQuiz()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;">
        ‚è∏Ô∏è Pause
      </button>
      <button onclick="mqHint()" id="mq-hint-btn" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:#ffcc00;cursor:pointer;">
        üí° Hint
      </button>
    </div>
    
    <div style="display:flex;gap:8px;">
      <button onclick="mqEndQuiz()" style="padding:8px 16px;background:rgba(255,45,85,0.1);border:1px solid rgba(255,45,85,0.3);border-radius:6px;color:#ff2d55;cursor:pointer;">
        üèÅ End Quiz
      </button>
    </div>
  </div>
</div>

<!-- Results Screen -->
<div id="mq-results-screen" style="display:none;">
  <div style="text-align:center;padding:40px 20px;">
    <div style="font-size:48px;margin-bottom:20px;" id="mq-results-emoji">üéâ</div>
    <h3 style="color:var(--accent);font-size:24px;margin:0 0 12px 0;" id="mq-results-title">Quiz Complete!</h3>
    <div style="color:var(--muted);font-size:16px;margin-bottom:30px;" id="mq-results-subtitle">You've completed the music quiz</div>
    
    <!-- Score Display -->
    <div style="background:var(--panel);border:2px solid var(--border);border-radius:12px;padding:30px;max-width:400px;margin:0 auto 30px;">
      <div style="font-size:72px;font-weight:800;color:var(--accent);margin-bottom:10px;" id="mq-final-score">0</div>
      <div style="color:var(--muted);font-size:14px;margin-bottom:20px;">FINAL SCORE</div>
      
      <div style="display:grid;grid-template-columns:repeat(2, 1fr);gap:20px;text-align:left;">
        <div>
          <div style="color:var(--muted);font-size:12px;">Correct</div>
          <div style="color:#39ff14;font-size:24px;font-weight:600;" id="mq-correct-count">0</div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:12px;">Accuracy</div>
          <div style="color:#ffcc00;font-size:24px;font-weight:600;" id="mq-accuracy-percent">0%</div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:12px;">Time</div>
          <div style="color:#9d4edd;font-size:24px;font-weight:600;" id="mq-time-taken">0s</div>
        </div>
        <div>
          <div style="color:var(--muted);font-size:12px;">Rank</div>
          <div style="color:#ff2d55;font-size:24px;font-weight:600;" id="mq-rank">Beginner</div>
        </div>
      </div>
    </div>
    
    <!-- Performance Graph -->
    <div style="background:var(--panel);border:2px solid var(--border);border-radius:12px;padding:20px;margin-bottom:30px;">
      <h4 style="color:var(--accent);font-size:16px;margin:0 0 16px 0;text-align:left;">Performance Breakdown</h4>
      <div id="mq-performance-chart" style="height:100px;display:flex;align-items:end;gap:8px;justify-content:center;">
        <!-- Chart bars will be inserted here -->
      </div>
    </div>
    
    <!-- Actions -->
    <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
      <button onclick="mqReviewAnswers()" style="padding:12px 24px;background:var(--glass);border:1px solid var(--border);border-radius:8px;color:var(--accent);cursor:pointer;min-width:140px;">
        üìù Review Answers
      </button>
      <button onclick="mqShareResults()" style="padding:12px 24px;background:linear-gradient(135deg, #1da1f2, #0d8bd9);color:white;border:none;border-radius:8px;cursor:pointer;min-width:140px;">
        üì§ Share Results
      </button>
      <button onclick="mqPlayAgain()" style="padding:12px 24px;background:linear-gradient(135deg, #39ff14, #2dd4ff);color:#000;border:none;border-radius:8px;cursor:pointer;font-weight:600;min-width:140px;">
        üîÑ Play Again
      </button>
    </div>
  </div>
</div>

<!-- Advanced Features -->
<details style="margin-bottom:20px;">
  <summary style="padding:14px;background:var(--glass);border:2px solid var(--border);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:500;list-style:none;display:flex;align-items:center;gap:8px;">
    üéõÔ∏è Advanced Features & Question Bank
  </summary>
  
  <div style="padding:20px;background:var(--panel);border:2px solid var(--border);border-radius:0 0 8px 8px;margin-top:-2px;">
    
    <!-- Custom Questions -->
    <div style="margin-bottom:24px;">
      <h4 style="color:var(--accent);font-size:15px;margin:0 0 12px 0;">‚úèÔ∏è Add Custom Questions</h4>
      <div style="display:grid;gap:12px;">
        <div>
          <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Question</label>
          <input id="mq-custom-question" type="text" placeholder="Enter your music question" 
                 style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
        </div>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
          <div>
            <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Correct Answer</label>
            <input id="mq-custom-correct" type="text" placeholder="Correct answer" 
                   style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
          </div>
          
          <div>
            <label style="display:block;font-size:12px;color:var(--accent);margin-bottom:6px;">Incorrect Answers (comma separated)</label>
            <input id="mq-custom-incorrect" type="text" placeholder="Wrong, Answers, Here" 
                   style="width:100%;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
          </div>
        </div>
        
        <div style="display:flex;gap:8px;">
          <button onclick="mqAddCustomQuestion()" style="padding:10px 20px;background:var(--accent);border:none;border-radius:6px;color:#000;cursor:pointer;font-weight:600;">
            Add Question
          </button>
          <button onclick="mqClearCustom()" style="padding:10px 20px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">
            Clear
          </button>
        </div>
      </div>
    </div>
    
    <!-- Question Bank Browser -->
    <div style="margin-bottom:24px;">
      <h4 style="color:var(--accent);font-size:15px;margin:0 0 12px 0;">üìö Question Bank Browser</h4>
      <div style="display:flex;gap:8px;margin-bottom:12px;">
        <input id="mq-search-questions" type="text" placeholder="Search questions..." 
               style="flex:1;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);" />
        <button onclick="mqSearchQuestions()" style="padding:10px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--accent);cursor:pointer;">
          Search
        </button>
      </div>
      
      <div id="mq-question-bank" style="max-height:300px;overflow-y:auto;padding-right:8px;">
        <!-- Questions will be loaded here -->
      </div>
    </div>
    
    <!-- Import/Export -->
    <div>
      <h4 style="color:var(--accent);font-size:15px;margin:0 0 12px 0;">üíæ Import & Export</h4>
      <div style="display:flex;gap:10px;flex-wrap:wrap;">
        <button onclick="mqExportQuestionBank()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;">
          üì§ Export Question Bank
        </button>
        <button onclick="mqImportQuestions()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;">
          üì• Import Questions
        </button>
        <button onclick="mqPrintQuiz()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;display:flex;align-items:center;gap:6px;">
          üñ®Ô∏è Print Quiz
        </button>
      </div>
    </div>
  </div>
</details>

<!-- Educational Resources -->
<div style="padding:16px;background:linear-gradient(135deg, rgba(157,78,221,0.05), rgba(45,212,255,0.02));border-radius:8px;border:1px solid rgba(157,78,221,0.1);">
  <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:12px;">
    <h3 style="color:#9d4edd;font-size:14px;margin:0;">üìö Music Learning Resources</h3>
    <button onclick="mqToggleResources()" style="background:transparent;border:none;color:#9d4edd;cursor:pointer;font-size:12px;">
      Hide
    </button>
  </div>
  
  <div id="mq-resources-content" style="display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:12px;">
    <div style="padding:12px;background:var(--glass);border-radius:6px;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:6px;">Music Theory</div>
      <div style="color:var(--muted);font-size:12px;">Scales, chords, harmony, rhythm, notation, intervals</div>
    </div>
    <div style="padding:12px;background:var(--glass);border-radius:6px;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:6px;">Instruments</div>
      <div style="color:var(--muted);font-size:12px;">Strings, woodwinds, brass, percussion, keyboards, voice</div>
    </div>
    <div style="padding:12px;background:var(--glass);border-radius:6px;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:6px;">History</div>
      <div style="color:var(--muted);font-size:12px;">Classical, jazz, rock, pop, world music, composers</div>
    </div>
    <div style="padding:12px;background:var(--glass);border-radius:6px;">
      <div style="color:var(--accent);font-weight:600;margin-bottom:6px;">Practice Tips</div>
      <div style="color:var(--muted);font-size:12px;">Ear training, sight-reading, technique, performance</div>
    </div>
  </div>
</div>

<script>
/* Ultimate Music Quiz
   Features:
   - Interactive quiz with multiple question types
   - Score tracking and statistics
   - Sound effects and timer
   - Question bank with search
   - Custom question creation
   - Results sharing
   - Mobile-friendly interface
   - Educational focus with explanations
*/

// ========== GLOBAL STATE ==========
const mq = {
  // Quiz state
  currentQuiz: null,
  currentQuestionIndex: 0,
  score: 0,
  correctAnswers: 0,
  totalQuestions: 0,
  startTime: null,
  endTime: null,
  timerInterval: null,
  timeRemaining: 0,
  selectedAnswer: null,
  quizCompleted: false,
  
  // User stats
  stats: {
    quizzesTaken: 0,
    totalCorrect: 0,
    totalQuestions: 0,
    highestScore: 0,
    currentStreak: 0,
    bestStreak: 0,
    averageAccuracy: 0
  },
  
  // Settings
  settings: {
    sound: true,
    showExplanations: true,
    saveProgress: true,
    difficulty: 'intermediate',
    questionCount: 10,
    timerEnabled: true,
    timerSeconds: 20
  },
  
  // Question bank
  questionBank: [],
  customQuestions: [],
  
  // Categories
  categories: {
    theory: {
      name: 'Music Theory',
      color: '#0077cc',
      icon: 'üéº'
    },
    instruments: {
      name: 'Instruments',
      color: '#ff9500',
      icon: 'üéª'
    },
    history: {
      name: 'Music History',
      color: '#39ff14',
      icon: 'üìú'
    },
    pop: {
      name: 'Pop Culture',
      color: '#ff2d55',
      icon: 'üé§'
    },
    genres: {
      name: 'Genres & Styles',
      color: '#9d4edd',
      icon: 'üé∏'
    },
    composition: {
      name: 'Composition',
      color: '#2dd4ff',
      icon: 'üéπ'
    },
    world: {
      name: 'World Music',
      color: '#ffcc00',
      icon: 'üåç'
    },
    mixed: {
      name: 'Mixed Quiz',
      color: '#ffffff',
      icon: 'üé≤'
    }
  },
  
  // Difficulties
  difficulties: {
    beginner: { name: 'Beginner', multiplier: 1 },
    intermediate: { name: 'Intermediate', multiplier: 1.5 },
    advanced: { name: 'Advanced', multiplier: 2 },
    expert: { name: 'Expert', multiplier: 2.5 }
  },
  
  // Current quiz questions
  questions: []
};

// ========== INITIALIZATION ==========
document.addEventListener('DOMContentLoaded', function() {
  // Load saved data
  mqLoadData();
  
  // Initialize question bank
  initializeQuestionBank();
  
  // Load question bank display
  loadQuestionBankDisplay();
  
  // Update stats display
  updateStatsDisplay();
  
  // Set up event listeners
  setupEventListeners();
  
  // Announce to screen reader
  announceToScreenReader('Ultimate Music Quiz loaded. Select your quiz settings and start playing!');
});

function setupEventListeners() {
  // Timer settings
  document.getElementById('mq-timer').addEventListener('change', function() {
    if (this.value === 'none') {
      mq.settings.timerEnabled = false;
    } else {
      mq.settings.timerEnabled = true;
      mq.settings.timerSeconds = parseInt(this.value);
    }
  });
  
  // Sound settings
  document.getElementById('mq-sound').addEventListener('change', function() {
    mq.settings.sound = this.value === 'on' || this.value === 'minimal';
  });
  
  // Enter key in custom question
  document.getElementById('mq-custom-question').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      mqAddCustomQuestion();
    }
  });
  
  // Search questions
  document.getElementById('mq-search-questions').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      mqSearchQuestions();
    }
  });
}

function initializeQuestionBank() {
  // This is a sample question bank - in a real app, this would be much larger
  mq.questionBank = [
    // Music Theory
    {
      question: "What is the formula for a major scale?",
      answers: [
        "W-W-H-W-W-W-H",
        "W-H-W-W-H-W-W", 
        "H-W-W-H-W-W-W",
        "W-W-W-H-W-W-H"
      ],
      correct: 0,
      explanation: "The major scale formula is: Whole, Whole, Half, Whole, Whole, Whole, Half",
      category: "theory",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "How many semitones are in a perfect fifth?",
      answers: ["6", "7", "8", "9"],
      correct: 1,
      explanation: "A perfect fifth consists of 7 semitones (e.g., C to G)",
      category: "theory",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "What notes make up a C major triad?",
      answers: ["C-E-G", "C-D-G", "C-F-A", "C-E-A"],
      correct: 0,
      explanation: "A major triad consists of the root, major third, and perfect fifth",
      category: "theory",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "What is the relative minor of C major?",
      answers: ["A minor", "E minor", "G minor", "D minor"],
      correct: 0,
      explanation: "A minor shares the same key signature as C major (no sharps or flats)",
      category: "theory",
      difficulty: "intermediate",
      type: "multiple-choice"
    },
    {
      question: "Define syncopation in rhythm.",
      answers: [
        "Emphasizing weak beats",
        "Playing faster tempo",
        "Using triple meter",
        "Repeating patterns"
      ],
      correct: 0,
      explanation: "Syncopation emphasizes normally weak beats or off-beats",
      category: "theory",
      difficulty: "intermediate",
      type: "multiple-choice"
    },
    
    // Instruments
    {
      question: "How many strings does a standard violin have?",
      answers: ["4", "5", "6", "7"],
      correct: 0,
      explanation: "Standard violins have 4 strings tuned to G, D, A, and E",
      category: "instruments",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "True or False: The trumpet is a woodwind instrument.",
      answers: ["True", "False"],
      correct: 1,
      explanation: "The trumpet is a brass instrument, not a woodwind",
      category: "instruments",
      difficulty: "beginner",
      type: "true-false"
    },
    {
      question: "Which instrument uses reeds to produce sound?",
      answers: ["Clarinet", "Trumpet", "Violin", "Piano"],
      correct: 0,
      explanation: "Clarinets use a single reed to produce sound",
      category: "instruments",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "What is the lowest string on a standard guitar tuned to EADGBE?",
      answers: ["E", "A", "D", "G"],
      correct: 0,
      explanation: "The thickest string is tuned to low E",
      category: "instruments",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    
    // History
    {
      question: "Who composed the 'Moonlight Sonata'?",
      answers: ["Beethoven", "Mozart", "Bach", "Chopin"],
      correct: 0,
      explanation: "Beethoven composed Piano Sonata No. 14, known as 'Moonlight Sonata'",
      category: "history",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "Which era featured composers like Bach and Handel?",
      answers: ["Baroque", "Classical", "Romantic", "Modern"],
      correct: 0,
      explanation: "The Baroque era (1600-1750) included Bach and Handel",
      category: "history",
      difficulty: "intermediate",
      type: "multiple-choice"
    },
    {
      question: "Who is known as the 'Father of the Symphony'?",
      answers: ["Haydn", "Mozart", "Beethoven", "Bach"],
      correct: 0,
      explanation: "Joseph Haydn composed 106 symphonies and established the form",
      category: "history",
      difficulty: "intermediate",
      type: "multiple-choice"
    },
    
    // Pop Culture
    {
      question: "Who is known as the 'Queen of Pop'?",
      answers: ["Madonna", "Beyonc√©", "Taylor Swift", "Lady Gaga"],
      correct: 0,
      explanation: "Madonna earned the title 'Queen of Pop' through her career",
      category: "pop",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "Which artist released the album 'Thriller'?",
      answers: ["Michael Jackson", "Prince", "Stevie Wonder", "David Bowie"],
      correct: 0,
      explanation: "Michael Jackson's 'Thriller' (1982) is the best-selling album of all time",
      category: "pop",
      difficulty: "beginner",
      type: "multiple-choice"
    },
    {
      question: "What band sang 'Bohemian Rhapsody'?",
      answers: ["Queen", "The Beatles", "Led Zeppelin", "Pink Floyd"],
      correct: 0,
      explanation: "Queen released 'Bohemian Rhapsody' in 1975",
      category: "pop",
      difficulty: "beginner",
      type: "multiple-choice"
    }
  ];
  
  // Add more sample questions
  for (let i = 0; i < 50; i++) {
    mq.questionBank.push(createSampleQuestion());
  }
  
  // Load custom questions from localStorage
  const savedCustom = localStorage.getItem('mqCustomQuestions');
  if (savedCustom) {
    try {
      mq.customQuestions = JSON.parse(savedCustom);
      mq.questionBank.push(...mq.customQuestions);
    } catch (e) {
      console.error('Failed to load custom questions:', e);
    }
  }
}

function createSampleQuestion() {
  const categories = Object.keys(mq.categories);
  const difficulties = ['beginner', 'intermediate', 'advanced'];
  const types = ['multiple-choice', 'true-false'];
  
  const category = categories[Math.floor(Math.random() * categories.length)];
  const difficulty = difficulties[Math.floor(Math.random() * difficulties.length)];
  const type = types[Math.floor(Math.random() * types.length)];
  
  return {
    question: `Sample question about ${mq.categories[category].name} (${difficulty})`,
    answers: type === 'true-false' ? ['True', 'False'] : ['Option A', 'Option B', 'Option C', 'Option D'],
    correct: type === 'true-false' ? Math.floor(Math.random() * 2) : Math.floor(Math.random() * 4),
    explanation: "This is a sample explanation for educational purposes",
    category: category,
    difficulty: difficulty,
    type: type
  };
}

// ========== QUIZ GENERATION ==========
function mqGenerateQuiz() {
  const category = document.getElementById('mq-category').value;
  const difficulty = document.getElementById('mq-difficulty').value;
  const questionCount = parseInt(document.getElementById('mq-question-count').value);
  
  // Get selected question types
  const types = [];
  if (document.getElementById('mq-type-mc').checked) types.push('multiple-choice');
  if (document.getElementById('mq-type-tf').checked) types.push('true-false');
  if (document.getElementById('mq-type-fill').checked) types.push('fill-in-blank');
  
  if (types.length === 0) {
    showNotification('Please select at least one question type', 'warning');
    return;
  }
  
  // Filter questions
  let filteredQuestions = mq.questionBank.filter(q => {
    if (category !== 'mixed' && q.category !== category) return false;
    if (q.difficulty !== difficulty) return false;
    if (!types.includes(q.type)) return false;
    return true;
  });
  
  // If not enough questions, relax filters
  if (filteredQuestions.length < questionCount) {
    filteredQuestions = mq.questionBank.filter(q => {
      if (category !== 'mixed' && q.category !== category) return false;
      if (!types.includes(q.type)) return false;
      return true;
    });
  }
  
  // Shuffle and select questions
  filteredQuestions = shuffleArray(filteredQuestions);
  mq.questions = filteredQuestions.slice(0, questionCount);
  
  if (mq.questions.length === 0) {
    showNotification('No questions found with current filters', 'error');
    return;
  }
  
  // Initialize quiz state
  mq.currentQuestionIndex = 0;
  mq.score = 0;
  mq.correctAnswers = 0;
  mq.totalQuestions = mq.questions.length;
  mq.selectedAnswer = null;
  mq.quizCompleted = false;
  mq.startTime = Date.now();
  
  // Set timer
  if (mq.settings.timerEnabled) {
    mq.timeRemaining = mq.settings.timerSeconds * 1000; // Convert to milliseconds
  }
  
  // Show quiz interface
  document.getElementById('mq-quiz-interface').style.display = 'block';
  document.getElementById('mq-results-screen').style.display = 'none';
  
  // Update UI
  updateQuizHeader();
  displayCurrentQuestion();
  startTimer();
  
  // Announce
  announceToScreenReader(`Quiz started. ${questionCount} questions about ${mq.categories[category].name}`);
  showNotification('Quiz started! Good luck!', 'success');
}

function mqStartQuickPlay() {
  // Set random settings
  const categories = Object.keys(mq.categories);
  const randomCategory = categories[Math.floor(Math.random() * categories.length)];
  
  document.getElementById('mq-category').value = randomCategory;
  document.getElementById('mq-difficulty').value = 'intermediate';
  document.getElementById('mq-question-count').value = '10';
  document.getElementById('mq-timer').value = '20';
  
  // Start quiz
  mqGenerateQuiz();
}

function mqShowCategories() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  let categoriesHTML = '';
  Object.entries(mq.categories).forEach(([key, cat]) => {
    categoriesHTML += `
      <button onclick="
        document.getElementById('mq-category').value = '${key}';
        this.parentElement.parentElement.parentElement.remove();
        mqGenerateQuiz();
      " style="
        padding: 16px;
        background: ${cat.color}20;
        border: 2px solid ${cat.color};
        border-radius: 8px;
        color: var(--text);
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 12px;
        width: 100%;
      ">
        <span style="font-size: 24px;">${cat.icon}</span>
        <div style="text-align: left; flex: 1;">
          <div>${cat.name}</div>
          <div style="font-size: 12px; color: var(--muted); font-weight: normal;">
            ${countQuestionsByCategory(key)} questions available
          </div>
        </div>
      </button>
    `;
  });
  
  modal.innerHTML = `
    <div style="background: var(--panel); padding: 24px; border-radius: 12px; max-width: 500px; width: 100%; max-height: 80vh; overflow-y: auto;">
      <h3 style="color: var(--accent); margin: 0 0 16px 0;">Select Quiz Category</h3>
      <div style="display: grid; gap: 12px; margin-bottom: 20px;">
        ${categoriesHTML}
      </div>
      <div style="display: flex; justify-content: flex-end;">
        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                style="padding: 10px 20px; background: var(--glass); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer;">
          Cancel
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function countQuestionsByCategory(category) {
  return mq.questionBank.filter(q => q.category === category).length;
}

function mqStartChallenge() {
  // Challenge mode: 60 seconds, as many questions as possible
  document.getElementById('mq-category').value = 'mixed';
  document.getElementById('mq-difficulty').value = 'intermediate';
  document.getElementById('mq-question-count').value = '25'; // Max questions
  document.getElementById('mq-timer').value = '10'; // Faster timer
  
  mqGenerateQuiz();
  
  // Override timer for challenge mode
  mq.timeRemaining = 60 * 1000; // 60 seconds
  updateTimerDisplay();
}

// ========== QUIZ INTERFACE ==========
function displayCurrentQuestion() {
  if (!mq.questions || mq.questions.length === 0) return;
  
  const question = mq.questions[mq.currentQuestionIndex];
  const questionNumber = mq.currentQuestionIndex + 1;
  
  // Update question text
  document.getElementById('mq-question-text').textContent = `${questionNumber}. ${question.question}`;
  
  // Update progress
  document.getElementById('mq-question-progress').textContent = 
    `${questionNumber}/${mq.totalQuestions}`;
  
  // Clear previous answer selection
  mq.selectedAnswer = null;
  
  // Show appropriate answer interface
  if (question.type === 'fill-in-blank') {
    displayFillInBlankQuestion(question);
  } else {
    displayMultipleChoiceQuestion(question);
  }
  
  // Update button states
  updateNavigationButtons();
  
  // Announce to screen reader
  announceToScreenReader(`Question ${questionNumber}: ${question.question}`);
}

function displayMultipleChoiceQuestion(question) {
  const container = document.getElementById('mq-answer-options');
  container.innerHTML = '';
  document.getElementById('mq-fill-container').style.display = 'none';
  container.style.display = 'grid';
  
  question.answers.forEach((answer, index) => {
    const button = document.createElement('button');
    button.className = 'mq-answer-btn';
    button.style.cssText = `
      padding: 16px;
      background: var(--glass);
      border: 2px solid var(--border);
      border-radius: 8px;
      color: var(--text);
      cursor: pointer;
      text-align: left;
      font-size: 16px;
      transition: all 0.2s;
    `;
    
    button.innerHTML = `
      <div style="display: flex; align-items: center; gap: 12px;">
        <div style="
          width: 24px;
          height: 24px;
          border-radius: 12px;
          border: 2px solid var(--accent);
          display: flex;
          align-items: center;
          justify-content: center;
          font-size: 12px;
          font-weight: 600;
          color: var(--accent);
        ">${String.fromCharCode(65 + index)}</div>
        <div>${answer}</div>
      </div>
    `;
    
    button.onclick = () => selectAnswer(index);
    container.appendChild(button);
  });
}

function displayFillInBlankQuestion(question) {
  const container = document.getElementById('mq-answer-options');
  container.innerHTML = '';
  container.style.display = 'none';
  
  const fillContainer = document.getElementById('mq-fill-container');
  fillContainer.style.display = 'block';
  
  // Clear previous answer
  document.getElementById('mq-fill-answer').value = '';
  document.getElementById('mq-fill-answer').focus();
}

function selectAnswer(answerIndex) {
  // Remove selection from all buttons
  document.querySelectorAll('.mq-answer-btn').forEach(btn => {
    btn.style.background = 'var(--glass)';
    btn.style.borderColor = 'var(--border)';
  });
  
  // Highlight selected button
  const selectedBtn = document.querySelectorAll('.mq-answer-btn')[answerIndex];
  if (selectedBtn) {
    selectedBtn.style.background = 'rgba(45,212,255,0.1)';
    selectedBtn.style.borderColor = 'var(--accent)';
  }
  
  mq.selectedAnswer = answerIndex;
  
  // Enable next button
  document.getElementById('mq-next-btn').disabled = false;
  
  // Play selection sound
  playSound('select');
}

function mqSubmitFillAnswer() {
  const answer = document.getElementById('mq-fill-answer').value.trim();
  if (!answer) {
    showNotification('Please enter an answer', 'warning');
    return;
  }
  
  mq.selectedAnswer = answer;
  document.getElementById('mq-next-btn').disabled = false;
  playSound('select');
}

function mqSubmitAnswer() {
  if (mq.selectedAnswer === null) {
    showNotification('Please select an answer', 'warning');
    return;
  }
  
  const question = mq.questions[mq.currentQuestionIndex];
  let isCorrect = false;
  
  if (question.type === 'fill-in-blank') {
    // For fill-in-blank, we need to check if answer is correct
    // This is simplified - in a real app, you'd have better matching
    isCorrect = mq.selectedAnswer.toLowerCase() === question.answers[0].toLowerCase();
  } else {
    isCorrect = mq.selectedAnswer === question.correct;
  }
  
  // Calculate score
  const difficultyMultiplier = mq.difficulties[question.difficulty].multiplier;
  const timeBonus = mq.timeRemaining > 0 ? Math.floor(mq.timeRemaining / 1000) : 0;
  const questionScore = isCorrect ? Math.round(100 * difficultyMultiplier) + timeBonus : 0;
  
  // Update score
  mq.score += questionScore;
  if (isCorrect) mq.correctAnswers++;
  
  // Update display
  document.getElementById('mq-current-score').textContent = mq.score;
  
  // Show feedback
  const feedback = isCorrect ? 'Correct! +' + questionScore : 'Incorrect';
  const color = isCorrect ? '#39ff14' : '#ff2d55';
  showNotification(feedback, isCorrect ? 'success' : 'error');
  
  // Play sound
  playSound(isCorrect ? 'correct' : 'incorrect');
  
  // Highlight correct answer
  highlightCorrectAnswer(question);
  
  // Show explanation if enabled
  if (mq.settings.showExplanations && question.explanation) {
    setTimeout(() => {
      showExplanation(question.explanation);
    }, 1000);
  }
  
  // Move to next question after delay
  setTimeout(() => {
    mqNextQuestion();
  }, 2000);
}

function highlightCorrectAnswer(question) {
  if (question.type === 'multiple-choice' || question.type === 'true-false') {
    document.querySelectorAll('.mq-answer-btn').forEach((btn, index) => {
      if (index === question.correct) {
        btn.style.background = 'rgba(57,255,20,0.2)';
        btn.style.borderColor = '#39ff14';
      } else if (mq.selectedAnswer !== null && index === mq.selectedAnswer && index !== question.correct) {
        btn.style.background = 'rgba(255,45,85,0.2)';
        btn.style.borderColor = '#ff2d55';
      }
      btn.style.cursor = 'default';
      btn.onclick = null;
    });
  }
}

function showExplanation(explanation) {
  const explanationDiv = document.createElement('div');
  explanationDiv.style.cssText = `
    margin-top: 16px;
    padding: 12px;
    background: rgba(45,212,255,0.1);
    border: 1px solid var(--accent);
    border-radius: 8px;
    color: var(--text);
    font-size: 14px;
    line-height: 1.5;
  `;
  explanationDiv.innerHTML = `<strong style="color:var(--accent);">Explanation:</strong> ${explanation}`;
  
  const questionContainer = document.getElementById('mq-question-container');
  questionContainer.appendChild(explanationDiv);
}

// ========== QUIZ NAVIGATION ==========
function mqPreviousQuestion() {
  if (mq.currentQuestionIndex > 0) {
    mq.currentQuestionIndex--;
    displayCurrentQuestion();
    playSound('navigation');
  }
}

function mqNextQuestion() {
  if (mq.currentQuestionIndex < mq.questions.length - 1) {
    mq.currentQuestionIndex++;
    displayCurrentQuestion();
    playSound('navigation');
  } else {
    mqCompleteQuiz();
  }
}

function mqSkipQuestion() {
  if (mq.currentQuestionIndex < mq.questions.length - 1) {
    mq.currentQuestionIndex++;
    displayCurrentQuestion();
    showNotification('Question skipped', 'info');
    playSound('skip');
  } else {
    mqCompleteQuiz();
  }
}

function updateNavigationButtons() {
  const prevBtn = document.getElementById('mq-prev-btn');
  const nextBtn = document.getElementById('mq-next-btn');
  
  prevBtn.disabled = mq.currentQuestionIndex === 0;
  nextBtn.disabled = mq.selectedAnswer === null;
}

function mqHint() {
  const question = mq.questions[mq.currentQuestionIndex];
  const hintBtn = document.getElementById('mq-hint-btn');
  
  if (question.type === 'multiple-choice' && question.answers.length >= 4) {
    // Eliminate two wrong answers
    const wrongAnswers = question.answers
      .map((answer, index) => index)
      .filter(index => index !== question.correct);
    
    const eliminated = shuffleArray(wrongAnswers).slice(0, 2);
    
    eliminated.forEach(index => {
      const btn = document.querySelectorAll('.mq-answer-btn')[index];
      if (btn) {
        btn.style.opacity = '0.3';
        btn.style.cursor = 'default';
        btn.onclick = null;
      }
    });
    
    hintBtn.disabled = true;
    hintBtn.style.opacity = '0.5';
    showNotification('Two wrong answers eliminated!', 'info');
    playSound('hint');
  } else {
    showNotification('No hint available for this question type', 'warning');
  }
}

function mqPauseQuiz() {
  clearInterval(mq.timerInterval);
  showNotification('Quiz paused. Click "Next" to resume.', 'info');
  playSound('pause');
}

function mqEndQuiz() {
  if (confirm('Are you sure you want to end the quiz? Your progress will be saved.')) {
    mqCompleteQuiz();
  }
}

// ========== QUIZ COMPLETION ==========
function mqCompleteQuiz() {
  clearInterval(mq.timerInterval);
  mq.quizCompleted = true;
  mq.endTime = Date.now();
  
  // Calculate final stats
  const timeTaken = Math.round((mq.endTime - mq.startTime) / 1000);
  const accuracy = mq.totalQuestions > 0 ? Math.round((mq.correctAnswers / mq.totalQuestions) * 100) : 0;
  
  // Update stats
  mq.stats.quizzesTaken++;
  mq.stats.totalCorrect += mq.correctAnswers;
  mq.stats.totalQuestions += mq.totalQuestions;
  mq.stats.averageAccuracy = Math.round(
    (mq.stats.totalCorrect / mq.stats.totalQuestions) * 100
  );
  
  if (mq.score > mq.stats.highestScore) {
    mq.stats.highestScore = mq.score;
  }
  
  // Update streak
  if (accuracy >= 70) {
    mq.stats.currentStreak++;
    if (mq.stats.currentStreak > mq.stats.bestStreak) {
      mq.stats.bestStreak = mq.stats.currentStreak;
    }
  } else {
    mq.stats.currentStreak = 0;
  }
  
  // Save stats
  mqSaveData();
  
  // Show results screen
  document.getElementById('mq-quiz-interface').style.display = 'none';
  document.getElementById('mq-results-screen').style.display = 'block';
  
  // Update results display
  updateResultsDisplay(timeTaken, accuracy);
  
  // Announce completion
  announceToScreenReader(`Quiz completed! Score: ${mq.score}, Accuracy: ${accuracy}%`);
  playSound('complete');
}

function updateResultsDisplay(timeTaken, accuracy) {
  // Update score
  document.getElementById('mq-final-score').textContent = mq.score;
  document.getElementById('mq-correct-count').textContent = `${mq.correctAnswers}/${mq.totalQuestions}`;
  document.getElementById('mq-accuracy-percent').textContent = `${accuracy}%`;
  document.getElementById('mq-time-taken').textContent = `${timeTaken}s`;
  
  // Determine rank
  let rank, emoji, color;
  if (accuracy >= 90) {
    rank = 'Music Maestro'; emoji = 'üëë'; color = '#ffcc00';
  } else if (accuracy >= 75) {
    rank = 'Virtuoso'; emoji = 'üéª'; color = '#9d4edd';
  } else if (accuracy >= 60) {
    rank = 'Apprentice'; emoji = 'üé∏'; color = '#2dd4ff';
  } else if (accuracy >= 40) {
    rank = 'Beginner'; emoji = 'üéØ'; color = '#39ff14';
  } else {
    rank = 'Novice'; emoji = 'üéì'; color = '#ff9500';
  }
  
  document.getElementById('mq-rank').textContent = rank;
  document.getElementById('mq-rank').style.color = color;
  document.getElementById('mq-results-emoji').textContent = emoji;
  document.getElementById('mq-results-title').textContent = `${rank}!`;
  document.getElementById('mq-results-subtitle').textContent = 
    `You scored ${mq.score} points with ${accuracy}% accuracy`;
  
  // Update stats display
  updateStatsDisplay();
  
  // Create performance chart
  createPerformanceChart();
}

function createPerformanceChart() {
  const container = document.getElementById('mq-performance-chart');
  container.innerHTML = '';
  
  // Simple bar chart showing correct/incorrect
  const correctWidth = (mq.correctAnswers / mq.totalQuestions) * 100;
  const incorrectWidth = 100 - correctWidth;
  
  container.innerHTML = `
    <div style="display:flex;align-items:end;gap:4px;height:100%;">
      <div style="
        width: ${correctWidth}%;
        height: 100%;
        background: linear-gradient(to top, #39ff14, #2dd4ff);
        border-radius: 4px 4px 0 0;
        position: relative;
      ">
        <div style="position:absolute;top:-20px;left:0;right:0;text-align:center;font-size:12px;color:#39ff14;">
          ${mq.correctAnswers} correct
        </div>
      </div>
      <div style="
        width: ${incorrectWidth}%;
        height: ${100 - correctWidth}%;
        background: linear-gradient(to top, #ff2d55, #ff9500);
        border-radius: 4px 4px 0 0;
        position: relative;
      ">
        <div style="position:absolute;top:-20px;left:0;right:0;text-align:center;font-size:12px;color:#ff2d55;">
          ${mq.totalQuestions - mq.correctAnswers} incorrect
        </div>
      </div>
    </div>
  `;
}

// ========== RESULTS ACTIONS ==========
function mqReviewAnswers() {
  const modal = document.createElement('div');
  modal.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0,0,0,0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    padding: 20px;
  `;
  
  let reviewHTML = '';
  mq.questions.forEach((question, index) => {
    const userAnswer = question.type === 'fill-in-blank' 
      ? mq.selectedAnswer 
      : question.answers[mq.selectedAnswer] || 'Not answered';
    const correctAnswer = question.type === 'fill-in-blank'
      ? question.answers[0]
      : question.answers[question.correct];
    const isCorrect = userAnswer === correctAnswer;
    
    reviewHTML += `
      <div style="margin-bottom: 16px; padding: 16px; background: var(--glass); border-radius: 8px; border: 1px solid ${isCorrect ? '#39ff14' : '#ff2d55'};">
        <div style="color: var(--text); font-weight: 600; margin-bottom: 8px;">Q${index + 1}: ${question.question}</div>
        <div style="display: grid; gap: 8px; font-size: 14px;">
          <div><span style="color: ${isCorrect ? '#39ff14' : '#ff2d55'};">Your answer:</span> ${userAnswer}</div>
          <div><span style="color: #39ff14;">Correct answer:</span> ${correctAnswer}</div>
          ${question.explanation ? `<div style="color: var(--muted); font-style: italic; margin-top: 8px;">üí° ${question.explanation}</div>` : ''}
        </div>
      </div>
    `;
  });
  
  modal.innerHTML = `
    <div style="background: var(--panel); padding: 24px; border-radius: 12px; max-width: 600px; width: 100%; max-height: 80vh; overflow-y: auto;">
      <h3 style="color: var(--accent); margin: 0 0 16px 0;">üìù Quiz Review</h3>
      <div style="margin-bottom: 20px; color: var(--muted); font-size: 14px;">
        Review your answers and learn from the explanations.
      </div>
      <div style="margin-bottom: 20px;">
        ${reviewHTML}
      </div>
      <div style="display: flex; justify-content: flex-end;">
        <button onclick="this.parentElement.parentElement.parentElement.remove()" 
                style="padding: 10px 20px; background: var(--accent); border: none; border-radius: 6px; color: #000; cursor: pointer; font-weight: 600;">
          Close Review
        </button>
      </div>
    </div>
  `;
  
  document.body.appendChild(modal);
}

function mqShareResults() {
  const accuracy = Math.round((mq.correctAnswers / mq.totalQuestions) * 100);
  const category = document.getElementById('mq-category').value;
  const categoryName = mq.categories[category].name;
  
  const shareText = `üéµ I scored ${mq.score} points with ${accuracy}% accuracy on the ${categoryName} Music Quiz!\n\nTake the quiz yourself at: ${window.location.href}`;
  
  // Try Web Share API first
  if (navigator.share) {
    navigator.share({
      title: 'My Music Quiz Results',
      text: shareText,
      url: window.location.href
    }).catch(console.error);
  } else {
    // Fallback to clipboard
    navigator.clipboard.writeText(shareText)
      .then(() => {
        showNotification('Results copied to clipboard!', 'success');
      })
      .catch(() => {
        // Show share dialog
        const shareDiv = document.createElement('div');
        shareDiv.innerHTML = `
          <div style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:var(--panel);padding:20px;border-radius:12px;border:2px solid var(--accent);z-index:10000;max-width:500px;">
            <h3 style="color:var(--accent);margin:0 0 10px 0;">Share Your Results</h3>
            <textarea style="width:100%;height:150px;padding:10px;border-radius:6px;border:1px solid var(--border);background:var(--glass);color:var(--text);margin-bottom:15px;font-family:monospace;font-size:12px;">${shareText}</textarea>
            <div style="display:flex;gap:10px;justify-content:flex-end;">
              <button onclick="this.parentElement.parentElement.parentElement.remove()" style="padding:8px 16px;background:var(--glass);border:1px solid var(--border);border-radius:6px;color:var(--text);cursor:pointer;">Close</button>
            </div>
          </div>
        `;
        document.body.appendChild(shareDiv);
      });
  }
}

function mqPlayAgain() {
  document.getElementById('mq-results-screen').style.display = 'none';
  mqGenerateQuiz();
}

// ========== TIMER FUNCTIONS ==========
function startTimer() {
  if (!mq.settings.timerEnabled) {
    document.getElementById('mq-timer-display').style.display = 'none';
    return;
  }
  
  document.getElementById('mq-timer-display').style.display = 'block';
  updateTimerDisplay();
  
  clearInterval(mq.timerInterval);
  mq.timerInterval = setInterval(() => {
    mq.timeRemaining -= 100;
    
    if (mq.timeRemaining <= 0) {
      mq.timeRemaining = 0;
      clearInterval(mq.timerInterval);
      timeUp();
    }
    
    updateTimerDisplay();
  }, 100);
}

function updateTimerDisplay() {
  const seconds = Math.ceil(mq.timeRemaining / 1000);
  const display = document.getElementById('mq-timer-display');
  
  if (display) {
    const timeString = seconds.toString().padStart(2, '0');
    display.innerHTML = `<span style="color:var(--accent);font-weight:600;font-family:monospace;">00:${timeString}</span>`;
    
    // Change color when time is running low
    if (seconds <= 10) {
      display.style.borderColor = '#ff2d55';
      display.querySelector('span').style.color = '#ff2d55';
    } else if (seconds <= 30) {
      display.style.borderColor = '#ffcc00';
      display.querySelector('span').style.color = '#ffcc00';
    }
  }
}

function timeUp() {
  showNotification('Time\'s up! Moving to next question...', 'warning');
  playSound('timeup');
  
  // Auto-submit if answer selected
  if (mq.selectedAnswer !== null) {
    mqSubmitAnswer();
  } else {
    // Auto-skip
    setTimeout(() => {
      if (mq.currentQuestionIndex < mq.questions.length - 1) {
        mqSkipQuestion();
      } else {
        mqCompleteQuiz();
      }
    }, 1500);
  }
}

// ========== CUSTOM QUESTIONS ==========
function mqAddCustomQuestion() {
  const question = document.getElementById('mq-custom-question').value.trim();
  const correct = document.getElementById('mq-custom-correct').value.trim();
  const incorrect = document.getElementById('mq-custom-incorrect').value.trim();
  
  if (!question || !correct || !incorrect) {
    showNotification('Please fill all fields', 'warning');
    return;
  }
  
  const incorrectAnswers = incorrect.split(',').map(a => a.trim()).filter(a => a);
  
  if (incorrectAnswers.length < 2) {
    showNotification('Please provide at least 2 incorrect answers (comma separated)', 'warning');
    return;
  }
  
  const customQuestion = {
    question: question,
    answers: [correct, ...incorrectAnswers],
    correct: 0, // First answer is correct
    explanation: "Custom question added by user",
    category: "mixed",
    difficulty: "intermediate",
    type: "multiple-choice",
    isCustom: true
  };
  
  mq.customQuestions.push(customQuestion);
  mq.questionBank.push(customQuestion);
  
  // Save to localStorage
  localStorage.setItem('mqCustomQuestions', JSON.stringify(mq.customQuestions));
  
  // Clear form
  document.getElementById('mq-custom-question').value = '';
  document.getElementById('mq-custom-correct').value = '';
  document.getElementById('mq-custom-incorrect').value = '';
  
  // Reload question bank display
  loadQuestionBankDisplay();
  
  showNotification('Custom question added successfully!', 'success');
  playSound('success');
}

function mqClearCustom() {
  document.getElementById('mq-custom-question').value = '';
  document.getElementById('mq-custom-correct').value = '';
  document.getElementById('mq-custom-incorrect').value = '';
}

function loadQuestionBankDisplay() {
  const container = document.getElementById('mq-question-bank');
  const recentQuestions = mq.questionBank.slice(-10); // Show 10 most recent
  
  if (recentQuestions.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-style:italic;text-align:center;padding:40px;">No questions in the bank yet</div>';
    return;
  }
  
  let html = '';
  recentQuestions.forEach((q, index) => {
    const cat = mq.categories[q.category] || mq.categories.mixed;
    html += `
      <div style="padding: 12px; border-bottom: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
          <div style="color: var(--text); font-size: 13px; flex: 1;">${q.question}</div>
          <span style="padding: 2px 6px; background: ${cat.color}20; color: ${cat.color}; border-radius: 4px; font-size: 11px; white-space: nowrap;">
            ${cat.icon} ${cat.name}
          </span>
        </div>
        <div style="color: var(--muted); font-size: 12px;">
          Type: ${q.type === 'multiple-choice' ? 'MCQ' : q.type === 'true-false' ? 'T/F' : 'Fill-in'} ‚Ä¢ 
          Difficulty: ${q.difficulty} ‚Ä¢ 
          Answers: ${q.answers.length}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function mqSearchQuestions() {
  const searchTerm = document.getElementById('mq-search-questions').value.toLowerCase().trim();
  if (!searchTerm) {
    loadQuestionBankDisplay();
    return;
  }
  
  const results = mq.questionBank.filter(q => 
    q.question.toLowerCase().includes(searchTerm) ||
    q.answers.some(a => a.toLowerCase().includes(searchTerm)) ||
    q.category.toLowerCase().includes(searchTerm) ||
    q.difficulty.toLowerCase().includes(searchTerm)
  ).slice(0, 20); // Limit results
  
  const container = document.getElementById('mq-question-bank');
  
  if (results.length === 0) {
    container.innerHTML = '<div style="color:var(--muted);font-style:italic;text-align:center;padding:40px;">No questions found</div>';
    return;
  }
  
  let html = `<div style="color:var(--muted);font-size:12px;margin-bottom:8px;">Found ${results.length} questions:</div>`;
  
  results.forEach(q => {
    const cat = mq.categories[q.category] || mq.categories.mixed;
    html += `
      <div style="padding: 12px; border-bottom: 1px solid var(--border);">
        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 4px;">
          <div style="color: var(--text); font-size: 13px; flex: 1;">${q.question}</div>
          <span style="padding: 2px 6px; background: ${cat.color}20; color: ${cat.color}; border-radius: 4px; font-size: 11px; white-space: nowrap;">
            ${cat.icon} ${cat.name}
          </span>
        </div>
        <div style="color: var(--muted); font-size: 12px;">
          Correct answer: ${q.answers[q.correct]} ‚Ä¢ 
          Type: ${q.type} ‚Ä¢ 
          Difficulty: ${q.difficulty}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// ========== IMPORT/EXPORT ==========
function mqExportQuiz() {
  const category = document.getElementById('mq-category').value;
  const difficulty = document.getElementById('mq-difficulty').value;
  const questionCount = parseInt(document.getElementById('mq-question-count').value);
  
  // Generate quiz text
  let quizText = `üéµ Music Quiz - ${mq.categories[category].name} (${difficulty})\n`;
  quizText += `Generated: ${new Date().toLocaleDateString()}\n\n`;
  
  // Get questions
  const questions = mq.questionBank
    .filter(q => {
      if (category !== 'mixed' && q.category !== category) return false;
      if (q.difficulty !== difficulty) return false;
      return true;
    })
    .slice(0, questionCount);
  
  questions.forEach((q, index) => {
    quizText += `${index + 1}. ${q.question}\n`;
    
    if (q.type === 'multiple-choice') {
      q.answers.forEach((a, i) => {
        quizText += `   ${String.fromCharCode(65 + i)}) ${a}\n`;
      });
    } else if (q.type === 'true-false') {
      quizText += `   A) True\n   B) False\n`;
    } else if (q.type === 'fill-in-blank') {
      quizText += `   Answer: _______________\n`;
    }
    
    quizText += `\n`;
  });
  
  quizText += `\nüéØ Educational Resource - Verify answers with a music teacher or reliable source.\n`;
  
  // Create download
  const blob = new Blob([quizText], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `music-quiz-${category}-${difficulty}.txt`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('Quiz exported as text file', 'success');
}

function mqExportQuestionBank() {
  const data = {
    questions: mq.questionBank,
    customQuestions: mq.customQuestions,
    stats: mq.stats,
    exportDate: new Date().toISOString()
  };
  
  const json = JSON.stringify(data, null, 2);
  const blob = new Blob([json], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `music-quiz-bank-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  
  showNotification('Question bank exported as JSON', 'success');
}

function mqImportQuestions() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = function(e) {
    const file = e.target.files[0];
    const reader = new FileReader();
    
    reader.onload = function(event) {
      try {
        const data = JSON.parse(event.target.result);
        
        if (!data.questions || !Array.isArray(data.questions)) {
          throw new Error('Invalid file format');
        }
        
        // Add imported questions to bank
        data.questions.forEach(q => {
          if (!mq.questionBank.some(existing => existing.question === q.question)) {
            mq.questionBank.push(q);
          }
        });
        
        // Update custom questions if present
        if (data.customQuestions && Array.isArray(data.customQuestions)) {
          mq.customQuestions = data.customQuestions;
          localStorage.setItem('mqCustomQuestions', JSON.stringify(mq.customQuestions));
        }
        
        // Reload display
        loadQuestionBankDisplay();
        
        showNotification(`${data.questions.length} questions imported successfully!`, 'success');
        announceToScreenReader('Question bank imported');
        
      } catch (error) {
        showNotification('Failed to import: ' + error.message, 'error');
      }
    };
    
    reader.readAsText(file);
  };
  
  input.click();
}

function mqPrintQuiz() {
  const printWindow = window.open('', '_blank');
  
  const category = document.getElementById('mq-category').value;
  const difficulty = document.getElementById('mq-difficulty').value;
  const questionCount = parseInt(document.getElementById('mq-question-count').value);
  
  // Get questions
  const questions = mq.questionBank
    .filter(q => {
      if (category !== 'mixed' && q.category !== category) return false;
      if (q.difficulty !== difficulty) return false;
      return true;
    })
    .slice(0, questionCount);
  
  let html = `
    <html>
      <head>
        <title>Music Quiz - ${mq.categories[category].name}</title>
        <style>
          body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
          h1 { color: #2dd4ff; border-bottom: 2px solid #2dd4ff; padding-bottom: 10px; }
          .question { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
          .answer { margin: 5px 0; padding-left: 20px; }
          .correct { color: #39ff14; font-weight: bold; }
          .info { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 20px 0; font-size: 14px; }
        </style>
      </head>
      <body>
        <h1>üéµ Music Quiz: ${mq.categories[category].name}</h1>
        <div class="info">
          <strong>Difficulty:</strong> ${difficulty}<br>
          <strong>Number of Questions:</strong> ${questions.length}<br>
          <strong>Print Date:</strong> ${new Date().toLocaleDateString()}
        </div>
  `;
  
  questions.forEach((q, index) => {
    html += `
      <div class="question">
        <strong>${index + 1}. ${q.question}</strong>
        <div style="margin-top: 10px;">
    `;
    
    if (q.type === 'multiple-choice') {
      q.answers.forEach((a, i) => {
        const isCorrect = i === q.correct;
        html += `<div class="answer ${isCorrect ? 'correct' : ''}">${String.fromCharCode(65 + i)}) ${a}</div>`;
      });
    } else if (q.type === 'true-false') {
      html += `<div class="answer ${q.correct === 0 ? 'correct' : ''}">A) True</div>`;
      html += `<div class="answer ${q.correct === 1 ? 'correct' : ''}">B) False</div>`;
    } else if (q.type === 'fill-in-blank') {
      html += `<div class="answer correct">Answer: ${q.answers[0]}</div>`;
    }
    
    if (q.explanation) {
      html += `<div style="margin-top: 10px; font-style: italic; color: #666;">üí° ${q.explanation}</div>`;
    }
    
    html += `</div></div>`;
  });
  
  html += `
        <div class="info">
          <strong>üéØ Educational Resource</strong><br>
          This quiz is for educational purposes only. Always verify answers with a qualified music teacher or reliable educational resource.
        </div>
      </body>
    </html>
  `;
  
  printWindow.document.write(html);
  printWindow.document.close();
  printWindow.print();
}

// ========== UTILITY FUNCTIONS ==========
function mqRandomizeSettings() {
  const categories = Object.keys(mq.categories);
  const difficulties = Object.keys(mq.difficulties);
  const counts = [5, 10, 15, 20, 25];
  const timers = ['none', '30', '20', '15', '10'];
  
  document.getElementById('mq-category').value = categories[Math.floor(Math.random() * categories.length)];
  document.getElementById('mq-difficulty').value = difficulties[Math.floor(Math.random() * difficulties.length)];
  document.getElementById('mq-question-count').value = counts[Math.floor(Math.random() * counts.length)];
  document.getElementById('mq-timer').value = timers[Math.floor(Math.random() * timers.length)];
  
  // Randomize question types
  const types = ['mc', 'tf', 'fill'];
  types.forEach(type => {
    document.getElementById(`mq-type-${type}`).checked = Math.random() > 0.5;
  });
  
  showNotification('Settings randomized!', 'info');
  playSound('randomize');
}

function mqResetSettings() {
  document.getElementById('mq-category').value = 'mixed';
  document.getElementById('mq-difficulty').value = 'intermediate';
  document.getElementById('mq-question-count').value = '10';
  document.getElementById('mq-timer').value = '20';
  document.getElementById('mq-sound').value = 'on';
  
  // Reset question types
  document.getElementById('mq-type-mc').checked = true;
  document.getElementById('mq-type-tf').checked = true;
  document.getElementById('mq-type-fill').checked = false;
  
  showNotification('Settings reset to defaults', 'info');
}

function mqToggleResources() {
  const resources = document.getElementById('mq-resources-content');
  const btn = document.querySelector('button[onclick="mqToggleResources()"]');
  
  if (resources.style.display === 'none') {
    resources.style.display = 'grid';
    btn.textContent = 'Hide';
  } else {
    resources.style.display = 'none';
    btn.textContent = 'Show';
  }
}

function updateStatsDisplay() {
  document.getElementById('mq-high-score').textContent = mq.stats.highestScore;
  document.getElementById('mq-stats-quizzes').textContent = mq.stats.quizzesTaken;
  document.getElementById('mq-stats-accuracy').textContent = mq.stats.averageAccuracy + '%';
  document.getElementById('mq-stats-streak').textContent = mq.stats.currentStreak;
  
  // Update progress bar based on highest score
  const maxScore = 2500; // Adjust based on your scoring system
  const progress = Math.min(100, (mq.stats.highestScore / maxScore) * 100);
  document.getElementById('mq-score-progress').style.width = `${progress}%`;
}

function updateQuizHeader() {
  const category = document.getElementById('mq-category').value;
  const difficulty = document.getElementById('mq-difficulty').value;
  
  const cat = mq.categories[category] || mq.categories.mixed;
  const diff = mq.difficulties[difficulty] || mq.difficulties.intermediate;
  
  document.getElementById('mq-quiz-title').textContent = `${cat.icon} ${cat.name} Quiz`;
  document.getElementById('mq-quiz-subtitle').textContent = 
    `${diff.name} ‚Ä¢ ${mq.totalQuestions} questions ‚Ä¢ ${mq.settings.timerEnabled ? mq.settings.timerSeconds + 's per question' : 'No timer'}`;
}

function shuffleArray(array) {
  const shuffled = [...array];
  for (let i = shuffled.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
  }
  return shuffled;
}

function playSound(type) {
  if (!mq.settings.sound) return;
  
  const sounds = {
    select: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    correct: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    incorrect: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    navigation: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    complete: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    timeup: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    hint: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    skip: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    pause: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    randomize: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ',
    success: 'data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEAQB8AAEAfAAABAAgAZGF0YQ'
  };
  
  try {
    const audio = new Audio(sounds[type] || sounds.select);
    audio.volume = 0.3;
    audio.play().catch(() => {});
  } catch (e) {
    // Sound playback failed, continue silently
  }
}

function showNotification(message, type = 'info') {
  // Remove existing notifications
  document.querySelectorAll('.mq-notification').forEach(el => el.remove());
  
  const notification = document.createElement('div');
  notification.className = 'mq-notification';
  notification.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 8px;
    background: ${type === 'error' ? '#ff2d55' : type === 'warning' ? '#ff9500' : type === 'success' ? '#39ff14' : 'var(--accent)'};
    color: #000;
    font-weight: 600;
    z-index: 10001;
    animation: slideIn 0.3s ease;
    max-width: 300px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  `;
  
  notification.textContent = message;
  document.body.appendChild(notification);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

function announceToScreenReader(message) {
  const liveRegion = document.getElementById('mq-screen-reader') || (() => {
    const region = document.createElement('div');
    region.id = 'mq-screen-reader';
    region.setAttribute('aria-live', 'polite');
    region.setAttribute('aria-atomic', 'true');
    region.style.cssText = 'position:absolute;left:-10000px;top:auto;width:1px;height:1px;overflow:hidden;';
    document.body.appendChild(region);
    return region;
  })();
  
  liveRegion.textContent = message;
  setTimeout(() => { liveRegion.textContent = ''; }, 1000);
}

// ========== DATA PERSISTENCE ==========
function mqSaveData() {
  const data = {
    stats: mq.stats,
    settings: mq.settings,
    customQuestions: mq.customQuestions,
    version: '2.0',
    lastUpdated: new Date().toISOString()
  };
  
  localStorage.setItem('musicQuizData', JSON.stringify(data));
}

function mqLoadData() {
  try {
    const saved = localStorage.getItem('musicQuizData');
    if (saved) {
      const data = JSON.parse(saved);
      
      mq.stats = data.stats || mq.stats;
      mq.settings = data.settings || mq.settings;
      mq.customQuestions = data.customQuestions || [];
      
      console.log('Music quiz data loaded:', mq.stats.quizzesTaken, 'quizzes taken');
    }
  } catch (error) {
    console.error('Failed to load music quiz data:', error);
  }
}

// ========== GLOBAL EXPORTS ==========
window.mqGenerateQuiz = mqGenerateQuiz;
window.mqStartQuickPlay = mqStartQuickPlay;
window.mqShowCategories = mqShowCategories;
window.mqStartChallenge = mqStartChallenge;
window.mqRandomizeSettings = mqRandomizeSettings;
window.mqResetSettings = mqResetSettings;
window.mqExportQuiz = mqExportQuiz;
window.mqPreviousQuestion = mqPreviousQuestion;
window.mqNextQuestion = mqNextQuestion;
window.mqSkipQuestion = mqSkipQuestion;
window.mqHint = mqHint;
window.mqPauseQuiz = mqPauseQuiz;
window.mqEndQuiz = mqEndQuiz;
window.mqSubmitFillAnswer = mqSubmitFillAnswer;
window.mqReviewAnswers = mqReviewAnswers;
window.mqShareResults = mqShareResults;
window.mqPlayAgain = mqPlayAgain;
window.mqAddCustomQuestion = mqAddCustomQuestion;
window.mqClearCustom = mqClearCustom;
window.mqSearchQuestions = mqSearchQuestions;
window.mqExportQuestionBank = mqExportQuestionBank;
window.mqImportQuestions = mqImportQuestions;
window.mqPrintQuiz = mqPrintQuiz;
window.mqToggleResources = mqToggleResources;

// Add CSS animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  
  @keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
  }
  
  .mq-answer-btn:hover {
    background: rgba(45,212,255,0.1) !important;
    transform: translateY(-1px);
  }
  
  #mq-question-bank::-webkit-scrollbar {
    width: 6px;
  }
  
  #mq-question-bank::-webkit-scrollbar-track {
    background: var(--glass);
    border-radius: 3px;
  }
  
  #mq-question-bank::-webkit-scrollbar-thumb {
    background: var(--accent);
    border-radius: 3px;
  }
  
  @media (max-width: 768px) {
    .dashboard .card {
      grid-template-columns: 1fr;
    }
    
    .row {
      grid-template-columns: 1fr !important;
    }
  }
`;
document.head.appendChild(style);

console.log('Ultimate Music Quiz loaded successfully!');
</script>
