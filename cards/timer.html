<h2 id="timer-title" style="margin-top:0;color:var(--accent);">‚è±Ô∏è Advanced Timer & Stopwatch</h2>

<!--
  Manifest metadata
  id: timer
  title: Timer & Stopwatch
  path: cards/timer.html
  category: Productivity
  version: 2.0
  description: Professional timer with countdown, stopwatch, intervals, and alarms
-->

<form aria-describedby="timer-desc" style="margin-bottom:20px;">
    <p id="timer-desc" class="small" style="margin-bottom:20px;color:rgba(var(--text-rgb, 230,250,255),0.9);">
        Advanced timer with countdown, stopwatch, intervals, lap times, and multiple alarms.
        <span style="color:var(--accent);">Perfect for workouts, cooking, study sessions, and productivity.</span>
    </p>
    
    <!-- MODE SELECTION -->
    <div class="field" style="margin-bottom:24px;">
        <label style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;">
            Timer Mode
        </label>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <button type="button" id="timer-mode-countdown" onclick="timerSetMode('countdown')"
                    style="flex:1;padding:12px;border-radius:10px;border:2px solid rgba(255,77,77,0.6);background:rgba(255,77,77,0.15);color:#ff4d4d;cursor:pointer;font-weight:600;min-width:120px;">
                ‚è∞ Countdown
            </button>
            <button type="button" id="timer-mode-stopwatch" onclick="timerSetMode('stopwatch')"
                    style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:var(--accent);cursor:pointer;min-width:120px;">
                ‚è±Ô∏è Stopwatch
            </button>
            <button type="button" id="timer-mode-interval" onclick="timerSetMode('interval')"
                    style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(57,255,20,0.3);background:rgba(57,255,20,0.05);color:#39ff14;cursor:pointer;min-width:120px;">
                üîÑ Interval
            </button>
        </div>
    </div>
    
    <!-- COUNTDOWN SETTINGS -->
    <div id="timer-countdown-settings" style="display:block;">
        <h4 style="color:#ff4d4d;margin-top:0;margin-bottom:16px;font-size:14px;font-weight:600;">‚è∞ Countdown Timer</h4>
        
        <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:20px;">
            <div>
                <label for="timer-hours" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Hours
                </label>
                <input id="timer-hours" type="number" min="0" max="99" value="0" step="1"
                       style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,77,77,0.2);background:rgba(255,77,77,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
            
            <div>
                <label for="timer-minutes" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Minutes
                </label>
                <input id="timer-minutes" type="number" min="0" max="59" value="1" step="1"
                       style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,77,77,0.2);background:rgba(255,77,77,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
            
            <div>
                <label for="timer-seconds" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Seconds
                </label>
                <input id="timer-seconds" type="number" min="0" max="59" value="0" step="1"
                       style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,77,77,0.2);background:rgba(255,77,77,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
            
            <div>
                <label style="display:block;margin-bottom:6px;color:rgba(var(--text-rgb, 230,250,255),0.7);font-size:13px;">
                    Quick Presets
                </label>
                <select id="timer-presets" 
                        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(255,77,77,0.2);background:rgba(255,77,77,0.05);color:inherit;font-size:14px;">
                    <option value="custom">Custom Time</option>
                    <option value="30">30 Seconds</option>
                    <option value="60">1 Minute</option>
                    <option value="300">5 Minutes</option>
                    <option value="600">10 Minutes</option>
                    <option value="900">15 Minutes</option>
                    <option value="1800">30 Minutes</option>
                    <option value="3600">1 Hour</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- INTERVAL TIMER SETTINGS -->
    <div id="timer-interval-settings" style="display:none;">
        <h4 style="color:#39ff14;margin-top:0;margin-bottom:16px;font-size:14px;font-weight:600;">üîÑ Interval Timer</h4>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:20px;">
            <div>
                <label for="interval-work" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Work Time (seconds)
                </label>
                <input id="interval-work" type="number" min="1" max="3600" value="30" step="1"
                       style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.2);background:rgba(57,255,20,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
            
            <div>
                <label for="interval-rest" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Rest Time (seconds)
                </label>
                <input id="interval-rest" type="number" min="0" max="3600" value="10" step="1"
                       style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.2);background:rgba(57,255,20,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
            
            <div>
                <label for="interval-rounds" style="display:block;margin-bottom:6px;color:var(--accent);font-size:13px;">
                    Rounds
                </label>
                <input id="interval-rounds" type="number" min="1" max="100" value="8" step="1"
                       style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(57,255,20,0.2);background:rgba(57,255,20,0.05);color:inherit;text-align:center;font-size:16px;" />
            </div>
        </div>
    </div>
    
    <!-- ALARM OPTIONS -->
    <div style="background:rgba(0,0,0,0.15);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);">
        <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;font-size:14px;font-weight:600;">üîî Alarm Options</h4>
        
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
            <div>
                <label for="timer-alarm-sound" style="display:block;margin-bottom:6px;color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                    Alarm Sound
                </label>
                <select id="timer-alarm-sound" 
                        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:14px;">
                    <option value="beep">Beep</option>
                    <option value="bell">Bell</option>
                    <option value="chime">Chime</option>
                    <option value="digital">Digital</option>
                    <option value="none" selected>None (Visual Only)</option>
                </select>
            </div>
            
            <div>
                <label for="timer-alarm-repeat" style="display:block;margin-bottom:6px;color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                    Auto-repeat
                </label>
                <select id="timer-alarm-repeat" 
                        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:14px;">
                    <option value="0" selected>No Repeat</option>
                    <option value="1">Repeat Once</option>
                    <option value="2">Repeat Twice</option>
                    <option value="5">Repeat 5 Times</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div class="actions" style="margin-top:24px;display:flex;gap:10px;justify-content:center;">
        <button type="button" id="timer-start-btn" onclick="timerStart()" 
                style="padding:14px 28px;background:linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1));border:1px solid rgba(57,255,20,0.4);border-radius:10px;color:#39ff14;cursor:pointer;font-weight:600;font-size:15px;">
            ‚ñ∂Ô∏è Start
        </button>
        <button type="button" id="timer-pause-btn" onclick="timerPause()" disabled
                style="padding:14px 28px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);color:#ffcc00;cursor:pointer;border-radius:10px;">
            ‚è∏Ô∏è Pause
        </button>
        <button type="button" id="timer-lap-btn" onclick="timerRecordLap()" disabled
                style="padding:14px 28px;background:rgba(var(--accent-rgb, 45,212,255),0.1);border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);color:var(--accent);cursor:pointer;border-radius:10px;">
            ‚è±Ô∏è Lap
        </button>
        <button type="button" onclick="timerResetAll()"
                style="padding:14px 28px;background:linear-gradient(135deg, rgba(255,77,77,0.1), rgba(255,77,77,0.05));border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;cursor:pointer;border-radius:10px;">
            üîÑ Reset
        </button>
    </div>
</form>

<!-- TIMER DISPLAY -->
<div class="results" aria-live="polite" style="margin-top:20px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:16px;font-weight:600;">‚è±Ô∏è Timer Display</h3>
    
    <!-- MAIN TIMER -->
    <div id="timer-main-display" style="background:linear-gradient(135deg, rgba(var(--accent-rgb, 45,212,255),0.1), rgba(var(--accent-rgb, 45,212,255),0.05));border:2px solid rgba(var(--accent-rgb, 45,212,255),0.3);border-radius:12px;padding:20px;margin-bottom:20px;text-align:center;">
        <div style="font-size:13px;color:rgba(255,255,255,0.8);margin-bottom:6px;" id="timer-mode-display">Countdown Timer</div>
        <div id="timer-display" style="font-size:72px;font-weight:700;color:var(--accent);line-height:1;margin-bottom:8px;font-family:monospace;">00:00:00</div>
        <div style="font-size:14px;color:rgba(255,255,255,0.7);" id="timer-status">Ready</div>
    </div>
    
    <!-- PROGRESS BAR -->
    <div style="margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="color:var(--accent);font-size:13px;">Progress</span>
            <span id="timer-progress-text" style="color:rgba(255,255,255,0.7);font-size:12px;">0%</span>
        </div>
        <div style="height:8px;background:rgba(255,255,255,0.1);border-radius:4px;overflow:hidden;">
            <div id="timer-progress-bar" style="height:100%;background:linear-gradient(90deg, var(--accent), #39ff14);width:0%;transition:width 0.3s ease;"></div>
        </div>
    </div>
    
    <!-- INTERVAL STATUS -->
    <div id="timer-interval-status" style="display:none;margin-bottom:20px;">
        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;">
            <div style="background:linear-gradient(135deg, rgba(255,77,77,0.08), rgba(255,77,77,0.04));border:1px solid rgba(255,77,77,0.2);border-radius:10px;padding:12px;text-align:center;">
                <div style="font-size:12px;color:rgba(255,77,77,0.9);margin-bottom:4px;">Current Round</div>
                <div id="interval-current-round" style="font-size:20px;font-weight:600;color:#ff4d4d;">1/8</div>
            </div>
            
            <div style="background:linear-gradient(135deg, rgba(var(--accent-rgb, 45,212,255),0.08), rgba(var(--accent-rgb, 45,212,255),0.04));border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);border-radius:10px;padding:12px;text-align:center;">
                <div style="font-size:12px;color:rgba(var(--accent-rgb, 45,212,255),0.9);margin-bottom:4px;">Phase</div>
                <div id="interval-phase" style="font-size:20px;font-weight:600;color:var(--accent);">Work</div>
            </div>
            
            <div style="background:linear-gradient(135deg, rgba(57,255,20,0.08), rgba(57,255,20,0.04));border:1px solid rgba(57,255,20,0.2);border-radius:10px;padding:12px;text-align:center;">
                <div style="font-size:12px;color:rgba(57,255,20,0.9);margin-bottom:4px;">Time Remaining</div>
                <div id="interval-phase-time" style="font-size:20px;font-weight:600;color:#39ff14;">30s</div>
            </div>
        </div>
    </div>
    
    <!-- LAP TIMES -->
    <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:16px;border:1px solid rgba(255,255,255,0.05);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h4 style="margin:0;color:var(--accent);font-size:14px;font-weight:600;">üìä Lap Times</h4>
            <button onclick="timerClearLaps()" 
                    style="padding:6px 12px;border-radius:6px;border:1px solid rgba(255,77,77,0.2);background:rgba(255,77,77,0.05);color:#ff4d4d;cursor:pointer;font-size:12px;">
                Clear
            </button>
        </div>
        <div id="timer-lap-times" style="min-height:60px;max-height:200px;overflow-y:auto;color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;">
            <div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px;">
                No lap times recorded yet
            </div>
        </div>
    </div>
</div>

<!-- TIMER USAGE GUIDE -->
<details style="margin-top:20px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;background:rgba(0,0,0,0.15);">
    <summary style="color:var(--accent);font-weight:600;cursor:pointer;outline:none;user-select:none;">üìö Timer Usage Guide</summary>
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);">
        
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;">
            <div>
                <div style="color:#ff4d4d;font-weight:600;margin-bottom:4px;">Countdown Timer</div>
                <div style="color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.5;">
                    ‚Ä¢ <strong>Cooking:</strong> Perfect for boiling eggs (6-12 min)<br>
                    ‚Ä¢ <strong>Workouts:</strong> Rest periods between sets<br>
                    ‚Ä¢ <strong>Presentations:</strong> Time limits for speakers<br>
                    ‚Ä¢ <strong>Pomodoro:</strong> 25 min work, 5 min break<br>
                    ‚Ä¢ <strong>Meditation:</strong> 10-20 minute sessions
                </div>
            </div>
            <div>
                <div style="color:#39ff14;font-weight:600;margin-bottom:4px;">Stopwatch Mode</div>
                <div style="color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.5;">
                    ‚Ä¢ <strong>Sports:</strong> Track lap times and sprints<br>
                    ‚Ä¢ <strong>Reading:</strong> Time reading sessions<br>
                    ‚Ä¢ <strong>Chores:</strong> Measure task completion time<br>
                    ‚Ä¢ <strong>Games:</strong> Speed runs and competitions<br>
                    ‚Ä¢ <strong>Meetings:</strong> Track discussion time
                </div>
            </div>
        </div>
        
        <div style="background:rgba(var(--accent-rgb, 45,212,255),0.05);border-radius:8px;padding:12px;border-left:3px solid var(--accent);margin-bottom:12px;">
            <strong style="color:var(--accent);">Interval Timer Workouts:</strong><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                ‚Ä¢ <strong>HIIT:</strong> 30s work, 10s rest √ó 8 rounds<br>
                ‚Ä¢ <strong>Tabata:</strong> 20s work, 10s rest √ó 8 rounds<br>
                ‚Ä¢ <strong>Boxing:</strong> 3 min rounds, 1 min rest √ó 5 rounds<br>
                ‚Ä¢ <strong>Yoga:</strong> 1 min poses, 15s transitions<br>
                ‚Ä¢ <strong>Circuit Training:</strong> 45s exercise, 15s rest
            </span>
        </div>
        
        <div style="background:rgba(255,77,77,0.05);border-radius:8px;padding:12px;border-left:3px solid #ff4d4d;">
            <strong style="color:#ff4d4d;">Pro Tips:</strong><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                ‚Ä¢ <strong>Lap Function:</strong> Use during stopwatch to record split times without stopping<br>
                ‚Ä¢ <strong>Visual Progress:</strong> Progress bar helps track completion percentage<br>
                ‚Ä¢ <strong>Interval Training:</strong> Perfect for HIIT, Tabata, and circuit workouts<br>
                ‚Ä¢ <strong>Custom Alarms:</strong> Set different sounds for different activities<br>
                ‚Ä¢ <strong>Fullscreen:</strong> For presentations, zoom in on the timer display<br>
                ‚Ä¢ <strong>Keyboard Shortcuts:</strong> Space = Start/Pause, R = Reset, L = Lap<br>
                ‚Ä¢ <strong>Accuracy:</strong> Uses high-precision timing for accurate results
            </span>
        </div>
        
        <p style="color:rgba(var(--text-rgb, 230,250,255),0.7);font-size:13px;line-height:1.5;margin-top:12px;">
            <span style="color:#ffcc00;">‚ö†Ô∏è Important:</span> This timer uses your browser's internal clock for timing. 
            For extremely precise timing needs (scientific experiments, professional sports), 
            use dedicated timing equipment. Browser timers can have minor variations 
            due to system load and browser optimizations.
        </p>
    </div>
</details>

<!-- SCRIPT -->
<script>
/* timer.html - Advanced Timer & Stopwatch
   - Prefix: timer
   - Features countdown, stopwatch, and interval timers
   - Lap times, progress bar, and multiple alarms
   - Perfect for workouts, cooking, study sessions
*/

// Timer state
let timerState = {
    mode: 'countdown', // 'countdown', 'stopwatch', 'interval'
    running: false,
    paused: false,
    startTime: 0,
    elapsed: 0,
    targetTime: 0,
    interval: null,
    lapTimes: [],
    intervalState: {
        currentRound: 1,
        totalRounds: 8,
        phase: 'work', // 'work' or 'rest'
        workTime: 30,
        restTime: 10,
        phaseEndTime: 0
    },
    alarm: {
        sound: 'none',
        repeat: 0
    }
};

// Format time as HH:MM:SS or MM:SS
function timerFormatTime(seconds, showHours = false) {
    if (seconds < 0) seconds = 0;
    
    const hrs = Math.floor(seconds / 3600);
    const mins = Math.floor((seconds % 3600) / 60);
    const secs = Math.floor(seconds % 60);
    
    if (showHours || hrs > 0) {
        return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    } else {
        return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
    }
}

// Format time with milliseconds for lap times
function timerFormatTimeWithMS(seconds) {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    const ms = Math.floor((seconds % 1) * 1000);
    
    if (mins > 0) {
        return `${mins}:${secs.toString().padStart(2, '0')}.${ms.toString().padStart(3, '0')}`;
    } else {
        return `${secs}.${ms.toString().padStart(3, '0')}s`;
    }
}

// Set timer mode
function timerSetMode(mode) {
    timerState.mode = mode;
    
    // Update button styles
    const modes = ['countdown', 'stopwatch', 'interval'];
    modes.forEach(m => {
        const btn = document.getElementById(`timer-mode-${m}`);
        if (btn) {
            if (m === mode) {
                btn.style.border = '2px solid';
                btn.style.fontWeight = '600';
                if (m === 'countdown') {
                    btn.style.borderColor = 'rgba(255,77,77,0.6)';
                    btn.style.background = 'rgba(255,77,77,0.15)';
                    btn.style.color = '#ff4d4d';
                } else if (m === 'stopwatch') {
                    btn.style.borderColor = 'rgba(var(--accent-rgb, 45,212,255),0.6)';
                    btn.style.background = 'rgba(var(--accent-rgb, 45,212,255),0.15)';
                    btn.style.color = 'var(--accent)';
                } else {
                    btn.style.borderColor = 'rgba(57,255,20,0.6)';
                    btn.style.background = 'rgba(57,255,20,0.15)';
                    btn.style.color = '#39ff14';
                }
            } else {
                btn.style.border = '1px solid';
                btn.style.fontWeight = '500';
                btn.style.background = btn.style.background.replace('0.15', '0.05');
                btn.style.borderColor = btn.style.borderColor.replace('0.6', '0.3');
            }
        }
    });
    
    // Show/hide settings
    document.getElementById('timer-countdown-settings').style.display = mode === 'countdown' ? 'block' : 'none';
    document.getElementById('timer-interval-settings').style.display = mode === 'interval' ? 'block' : 'none';
    document.getElementById('timer-interval-status').style.display = mode === 'interval' ? 'grid' : 'none';
    
    // Update mode display
    const modeNames = {
        'countdown': 'Countdown Timer',
        'stopwatch': 'Stopwatch',
        'interval': 'Interval Timer'
    };
    document.getElementById('timer-mode-display').textContent = modeNames[mode];
    
    // Reset timer display
    timerUpdateDisplay();
    
    console.log(`Timer mode set to: ${mode}`);
}

// Apply preset time
function timerApplyPreset() {
    const presetSelect = document.getElementById('timer-presets');
    const presetValue = presetSelect.value;
    
    if (presetValue === 'custom') return;
    
    const totalSeconds = parseInt(presetValue);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    
    document.getElementById('timer-hours').value = hours;
    document.getElementById('timer-minutes').value = minutes;
    document.getElementById('timer-seconds').value = seconds;
    
    console.log(`Preset applied: ${hours}h ${minutes}m ${seconds}s`);
}

// Calculate total seconds from inputs
function timerGetCountdownTime() {
    const hours = parseInt(document.getElementById('timer-hours').value) || 0;
    const minutes = parseInt(document.getElementById('timer-minutes').value) || 0;
    const seconds = parseInt(document.getElementById('timer-seconds').value) || 0;
    
    return (hours * 3600) + (minutes * 60) + seconds;
}

// Get interval settings
function timerGetIntervalSettings() {
    const workTime = parseInt(document.getElementById('interval-work').value) || 30;
    const restTime = parseInt(document.getElementById('interval-rest').value) || 10;
    const rounds = parseInt(document.getElementById('interval-rounds').value) || 8;
    
    return { workTime, restTime, rounds };
}

// Get alarm settings
function timerGetAlarmSettings() {
    const sound = document.getElementById('timer-alarm-sound').value;
    const repeat = parseInt(document.getElementById('timer-alarm-repeat').value) || 0;
    
    return { sound, repeat };
}

// Play alarm sound
function timerPlayAlarm() {
    const alarmSettings = timerGetAlarmSettings();
    
    if (alarmSettings.sound === 'none') {
        // Visual alert only
        const display = document.getElementById('timer-main-display');
        display.style.animation = 'pulse 1s infinite';
        setTimeout(() => {
            display.style.animation = '';
        }, 5000);
        return;
    }
    
    // Create audio context for beeps
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        // Different sounds for different alarm types
        switch (alarmSettings.sound) {
            case 'beep':
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1200, audioContext.currentTime + 0.1);
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.2);
                break;
            case 'bell':
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'sine';
                break;
            case 'chime':
                oscillator.frequency.setValueAtTime(523.25, audioContext.currentTime); // C5
                oscillator.frequency.setValueAtTime(659.25, audioContext.currentTime + 0.2); // E5
                oscillator.frequency.setValueAtTime(783.99, audioContext.currentTime + 0.4); // G5
                break;
            case 'digital':
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime);
                oscillator.type = 'square';
                break;
        }
        
        gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + 0.5);
        
        // Repeat if needed
        if (alarmSettings.repeat > 0) {
            for (let i = 1; i <= alarmSettings.repeat; i++) {
                setTimeout(() => {
                    timerPlayAlarm();
                }, i * 1000);
            }
        }
        
    } catch (error) {
        console.warn('Audio context not available:', error);
        // Fallback: visual alert
        const display = document.getElementById('timer-main-display');
        display.style.animation = 'pulse 1s infinite';
        setTimeout(() => {
            display.style.animation = '';
        }, 5000);
    }
}

// Update timer display
function timerUpdateDisplay() {
    const display = document.getElementById('timer-display');
    const status = document.getElementById('timer-status');
    const progressBar = document.getElementById('timer-progress-bar');
    const progressText = document.getElementById('timer-progress-text');
    
    if (timerState.running || timerState.paused) {
        if (timerState.mode === 'stopwatch') {
            const elapsed = timerState.paused ? timerState.elapsed : (Date.now() - timerState.startTime) / 1000 + timerState.elapsed;
            display.textContent = timerFormatTime(elapsed, true);
            
            if (!timerState.paused) {
                status.textContent = 'Running';
                status.style.color = '#39ff14';
            } else {
                status.textContent = 'Paused';
                status.style.color = '#ffcc00';
            }
            
            // No progress bar for stopwatch
            progressBar.style.width = '0%';
            progressText.textContent = '--';
            
        } else if (timerState.mode === 'countdown') {
            const remaining = timerState.paused ? timerState.elapsed : timerState.targetTime - ((Date.now() - timerState.startTime) / 1000);
            
            if (remaining <= 0) {
                display.textContent = '00:00:00';
                status.textContent = 'Time\'s Up!';
                status.style.color = '#ff4d4d';
                progressBar.style.width = '100%';
                progressText.textContent = '100%';
            } else {
                display.textContent = timerFormatTime(remaining, true);
                status.textContent = timerState.paused ? 'Paused' : 'Counting Down';
                status.style.color = timerState.paused ? '#ffcc00' : '#39ff14';
                
                // Update progress bar
                const progress = ((timerState.targetTime - remaining) / timerState.targetTime) * 100;
                progressBar.style.width = `${progress}%`;
                progressText.textContent = `${Math.round(progress)}%`;
            }
            
        } else if (timerState.mode === 'interval') {
            const now = Date.now() / 1000;
            const remaining = timerState.intervalState.phaseEndTime - now;
            
            if (remaining <= 0) {
                // Switch phase
                timerSwitchIntervalPhase();
                timerUpdateDisplay();
                return;
            }
            
            display.textContent = timerFormatTime(remaining);
            status.textContent = timerState.paused ? 'Paused' : `Round ${timerState.intervalState.currentRound}/${timerState.intervalState.totalRounds}`;
            status.style.color = timerState.paused ? '#ffcc00' : (timerState.intervalState.phase === 'work' ? '#ff4d4d' : '#39ff14');
            
            // Update progress bar based on phase
            const phaseTime = timerState.intervalState.phase === 'work' ? timerState.intervalState.workTime : timerState.intervalState.restTime;
            const progress = ((phaseTime - remaining) / phaseTime) * 100;
            progressBar.style.width = `${progress}%`;
            progressText.textContent = `${Math.round(progress)}%`;
            
            // Update interval status display
            document.getElementById('interval-current-round').textContent = 
                `${timerState.intervalState.currentRound}/${timerState.intervalState.totalRounds}`;
            document.getElementById('interval-phase').textContent = 
                timerState.intervalState.phase === 'work' ? 'Work' : 'Rest';
            document.getElementById('interval-phase-time').textContent = 
                `${Math.ceil(remaining)}s`;
        }
    } else {
        // Not running
        if (timerState.mode === 'countdown') {
            const totalTime = timerGetCountdownTime();
            display.textContent = timerFormatTime(totalTime, true);
            status.textContent = 'Ready';
            status.style.color = 'var(--accent)';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        } else if (timerState.mode === 'stopwatch') {
            display.textContent = '00:00:00';
            status.textContent = 'Ready';
            status.style.color = 'var(--accent)';
        } else if (timerState.mode === 'interval') {
            const settings = timerGetIntervalSettings();
            display.textContent = timerFormatTime(settings.workTime);
            status.textContent = 'Ready';
            status.style.color = 'var(--accent)';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
        }
    }
}

// Switch interval phase
function timerSwitchIntervalPhase() {
    if (timerState.intervalState.phase === 'work') {
        // Switch to rest
        timerState.intervalState.phase = 'rest';
        timerState.intervalState.phaseEndTime = Date.now() / 1000 + timerState.intervalState.restTime;
        
        // Play transition sound
        if (!timerState.paused) {
            timerPlayAlarm();
        }
        
    } else {
        // Switch to work for next round
        timerState.intervalState.phase = 'work';
        timerState.intervalState.currentRound++;
        
        if (timerState.intervalState.currentRound > timerState.intervalState.totalRounds) {
            // All rounds completed
            timerStop();
            timerPlayAlarm();
            return;
        }
        
        timerState.intervalState.phaseEndTime = Date.now() / 1000 + timerState.intervalState.workTime;
        
        // Play transition sound
        if (!timerState.paused) {
            timerPlayAlarm();
        }
    }
}

// Start timer
function timerStart() {
    if (timerState.running && !timerState.paused) {
        return; // Already running
    }
    
    const startBtn = document.getElementById('timer-start-btn');
    const pauseBtn = document.getElementById('timer-pause-btn');
    const lapBtn = document.getElementById('timer-lap-btn');
    
    if (timerState.paused) {
        // Resume from pause
        timerState.paused = false;
        timerState.startTime = Date.now();
        
        startBtn.textContent = '‚è∏Ô∏è Pause';
        startBtn.onclick = timerPause;
        startBtn.style.background = 'linear-gradient(135deg, rgba(255,204,0,0.2), rgba(255,204,0,0.1))';
        startBtn.style.borderColor = 'rgba(255,204,0,0.4)';
        startBtn.style.color = '#ffcc00';
        
        pauseBtn.disabled = false;
        lapBtn.disabled = false;
        
        console.log('Timer resumed');
        
    } else {
        // Start fresh
        timerState.running = true;
        timerState.paused = false;
        timerState.startTime = Date.now();
        timerState.elapsed = 0;
        timerState.lapTimes = [];
        timerClearLapDisplay();
        
        if (timerState.mode === 'countdown') {
            timerState.targetTime = timerGetCountdownTime();
            if (timerState.targetTime <= 0) {
                alert('Please set a countdown time greater than 0');
                return;
            }
            
        } else if (timerState.mode === 'interval') {
            const settings = timerGetIntervalSettings();
            timerState.intervalState = {
                currentRound: 1,
                totalRounds: settings.rounds,
                phase: 'work',
                workTime: settings.workTime,
                restTime: settings.restTime,
                phaseEndTime: Date.now() / 1000 + settings.workTime
            };
        }
        
        startBtn.textContent = '‚è∏Ô∏è Pause';
        startBtn.onclick = timerPause;
        startBtn.style.background = 'linear-gradient(135deg, rgba(255,204,0,0.2), rgba(255,204,0,0.1))';
        startBtn.style.borderColor = 'rgba(255,204,0,0.4)';
        startBtn.style.color = '#ffcc00';
        
        pauseBtn.disabled = false;
        lapBtn.disabled = timerState.mode === 'countdown';
        
        console.log(`Timer started: ${timerState.mode} mode`);
    }
    
    // Start update interval
    clearInterval(timerState.interval);
    timerState.interval = setInterval(timerUpdateDisplay, 100);
    
    timerUpdateDisplay();
}

// Pause timer
function timerPause() {
    if (!timerState.running || timerState.paused) {
        return;
    }
    
    timerState.paused = true;
    timerState.elapsed = timerState.mode === 'stopwatch' 
        ? (Date.now() - timerState.startTime) / 1000 + timerState.elapsed
        : timerState.targetTime - ((Date.now() - timerState.startTime) / 1000);
    
    clearInterval(timerState.interval);
    
    const startBtn = document.getElementById('timer-start-btn');
    const pauseBtn = document.getElementById('timer-pause-btn');
    
    startBtn.textContent = '‚ñ∂Ô∏è Resume';
    startBtn.onclick = timerStart;
    startBtn.style.background = 'linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1))';
    startBtn.style.borderColor = 'rgba(57,255,20,0.4)';
    startBtn.style.color = '#39ff14';
    
    pauseBtn.disabled = true;
    
    console.log('Timer paused');
    timerUpdateDisplay();
}

// Stop timer (internal function)
function timerStop() {
    timerState.running = false;
    timerState.paused = false;
    clearInterval(timerState.interval);
    
    const startBtn = document.getElementById('timer-start-btn');
    const pauseBtn = document.getElementById('timer-pause-btn');
    const lapBtn = document.getElementById('timer-lap-btn');
    
    startBtn.textContent = '‚ñ∂Ô∏è Start';
    startBtn.onclick = timerStart;
    startBtn.style.background = 'linear-gradient(135deg, rgba(57,255,20,0.2), rgba(57,255,20,0.1))';
    startBtn.style.borderColor = 'rgba(57,255,20,0.4)';
    startBtn.style.color = '#39ff14';
    
    pauseBtn.disabled = true;
    lapBtn.disabled = true;
    
    console.log('Timer stopped');
}

// Record lap time
function timerRecordLap() {
    if (!timerState.running || timerState.paused || timerState.mode !== 'stopwatch') {
        return;
    }
    
    const currentTime = (Date.now() - timerState.startTime) / 1000 + timerState.elapsed;
    const lapNumber = timerState.lapTimes.length + 1;
    
    let lapTime = currentTime;
    if (timerState.lapTimes.length > 0) {
        lapTime = currentTime - timerState.lapTimes[timerState.lapTimes.length - 1].total;
    }
    
    timerState.lapTimes.push({
        lap: lapNumber,
        time: lapTime,
        total: currentTime
    });
    
    timerUpdateLapDisplay();
    console.log(`Lap ${lapNumber} recorded: ${timerFormatTimeWithMS(lapTime)}`);
}

// Update lap display
function timerUpdateLapDisplay() {
    const lapContainer = document.getElementById('timer-lap-times');
    
    if (timerState.lapTimes.length === 0) {
        lapContainer.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px;">No lap times recorded yet</div>';
        return;
    }
    
    let html = '';
    
    // Find fastest and slowest laps
    let fastestLap = Infinity;
    let slowestLap = 0;
    timerState.lapTimes.forEach(lap => {
        if (lap.time < fastestLap) fastestLap = lap.time;
        if (lap.time > slowestLap) slowestLap = lap.time;
    });
    
    timerState.lapTimes.forEach(lap => {
        const isFastest = lap.time === fastestLap && timerState.lapTimes.length > 1;
        const isSlowest = lap.time === slowestLap && timerState.lapTimes.length > 1;
        
        html += `
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 12px;margin-bottom:4px;background:rgba(0,0,0,0.3);border-radius:6px;border-left:3px solid ${isFastest ? '#39ff14' : isSlowest ? '#ff4d4d' : 'var(--accent)'};">
                <div>
                    <strong style="color:var(--accent);">Lap ${lap.lap}</strong>
                    <div style="font-size:11px;color:rgba(255,255,255,0.5);">
                        Total: ${timerFormatTimeWithMS(lap.total)}
                    </div>
                </div>
                <div style="font-weight:600;color:${isFastest ? '#39ff14' : isSlowest ? '#ff4d4d' : 'inherit'};">
                    ${timerFormatTimeWithMS(lap.time)}
                </div>
            </div>
        `;
    });
    
    lapContainer.innerHTML = html;
    lapContainer.scrollTop = lapContainer.scrollHeight;
}

// Clear lap display
function timerClearLapDisplay() {
    const lapContainer = document.getElementById('timer-lap-times');
    lapContainer.innerHTML = '<div style="text-align:center;color:rgba(255,255,255,0.3);padding:20px;">No lap times recorded yet</div>';
}

// Clear laps
function timerClearLaps() {
    if (timerState.lapTimes.length === 0) return;
    
    if (confirm('Clear all lap times?')) {
        timerState.lapTimes = [];
        timerClearLapDisplay();
        console.log('Lap times cleared');
    }
}

// Reset all
function timerResetAll() {
    if (timerState.running && !confirm('Timer is running. Reset anyway?')) {
        return;
    }
    
    timerStop();
    
    // Reset inputs
    document.getElementById('timer-hours').value = 0;
    document.getElementById('timer-minutes').value = 1;
    document.getElementById('timer-seconds').value = 0;
    document.getElementById('timer-presets').value = 'custom';
    
    // Reset interval settings
    document.getElementById('interval-work').value = 30;
    document.getElementById('interval-rest').value = 10;
    document.getElementById('interval-rounds').value = 8;
    
    // Reset lap times
    timerState.lapTimes = [];
    timerClearLapDisplay();
    
    // Reset display
    timerUpdateDisplay();
    
    console.log('Timer completely reset');
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        // Set up event listeners
        document.getElementById('timer-presets').addEventListener('change', timerApplyPreset);
        
        // Set up keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
            
            switch (e.code) {
                case 'Space':
                    e.preventDefault();
                    if (timerState.running && !timerState.paused) {
                        timerPause();
                    } else {
                        timerStart();
                    }
                    break;
                case 'KeyR':
                    if (e.ctrlKey) {
                        e.preventDefault();
                        timerResetAll();
                    }
                    break;
                case 'KeyL':
                    if (timerState.running && !timerState.paused && timerState.mode === 'stopwatch') {
                        e.preventDefault();
                        timerRecordLap();
                    }
                    break;
            }
        });
        
        // Initialize
        timerSetMode('countdown');
        timerUpdateDisplay();
        
        console.log('Timer initialized');
    });
}
</script>

<!-- CARD-SPECIFIC STYLES -->
<style>
/* Pulse animation for timer */
@keyframes pulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.02); }
    100% { transform: scale(1); }
}

/* Timer display font */
#timer-display {
    font-feature-settings: "tnum";
    font-variant-numeric: tabular-nums;
}

/* Button hover effects */
button[onclick*="timerSetMode"]:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0,0,0,0.3);
    transition: all 0.2s ease;
}

/* Action button hover states */
#timer-start-btn:hover:not(:disabled),
#timer-pause-btn:hover:not(:disabled),
#timer-lap-btn:hover:not(:disabled) {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

/* Lap times scrollbar */
#timer-lap-times::-webkit-scrollbar {
    width: 6px;
}

#timer-lap-times::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.05);
    border-radius: 3px;
}

#timer-lap-times::-webkit-scrollbar-thumb {
    background: rgba(var(--accent-rgb, 45,212,255),0.3);
    border-radius: 3px;
}

/* Disabled button styling */
button:disabled {
    opacity: 0.5;
    cursor: not-allowed !important;
    transform: none !important;
    box-shadow: none !important;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    #timer-title {
        font-size: 1.3rem !important;
    }
    
    #timer-display {
        font-size: 48px !important;
    }
    
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        margin: 4px 0 !important;
    }
    
    /* Stack timer inputs */
    #timer-countdown-settings > div {
        grid-template-columns: 1fr 1fr !important;
    }
    
    /* Stack mode buttons */
    .field > div[style*="display:flex;gap:8px;flex-wrap:wrap;"] {
        flex-direction: column;
    }
    
    /* Stack interval status */
    #timer-interval-status {
        grid-template-columns: 1fr !important;
    }
}

/* Small screen adjustments */
@media (max-width: 480px) {
    #timer-title {
        font-size: 1.1rem !important;
    }
    
    #timer-display {
        font-size: 36px !important;
    }
    
    /* Stack all timer inputs */
    #timer-countdown-settings > div {
        grid-template-columns: 1fr !important;
    }
    
    /* Reduce padding */
    .actions button {
        padding: 12px 16px !important;
    }
    
    /* Adjust button text */
    button[style*="padding:14px 28px;"] {
        padding: 12px 16px !important;
        font-size: 14px !important;
    }
}
</style>
