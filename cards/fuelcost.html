<h2 id="fuel-cost-title" style="margin-top:0;color:var(--accent);">‚õΩ Fuel Cost Calculator Pro</h2>

<form aria-describedby="fuel-cost-desc">
  <p id="fuel-cost-desc" class="small" style="margin-bottom:20px;color:rgba(230,250,255,0.8);">
    Calculate trip fuel costs, compare vehicles, track carbon footprint, and find optimal routes.
    <span style="color:var(--accent);font-weight:500;">Real-time calculations with environmental impact!</span>
  </p>

  <!-- Trip Information -->
  <div style="background:rgba(45,212,255,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(45,212,255,0.2);">
    <h4 class="small" style="color:var(--accent);margin-bottom:16px;">üìç Trip Information</h4>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="fuel-trip-distance" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Trip Distance</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fuel-trip-distance" type="number" min="1" max="10000" value="100" step="1"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <select id="fuel-distance-unit" 
                  style="width:80px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="km">km</option>
            <option value="miles">miles</option>
          </select>
        </div>
      </div>
      
      <div class="field">
        <label for="fuel-trip-frequency" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Trip Frequency</label>
        <select id="fuel-trip-frequency" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="single">Single Trip</option>
          <option value="daily">Daily Commute</option>
          <option value="weekly" selected>Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="yearly">Yearly</option>
        </select>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field">
        <label for="fuel-return-trip" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Return Trip</label>
        <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
          <input type="checkbox" id="fuel-return-trip" checked style="width:18px;height:18px;cursor:pointer;" />
          <span>Include return journey</span>
        </label>
      </div>
      
      <div class="field">
        <label for="fuel-passengers" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Passengers</label>
        <input id="fuel-passengers" type="number" min="1" max="10" value="1" step="1"
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
      </div>
    </div>
  </div>

  <!-- Vehicle Information -->
  <div style="background:rgba(57,255,20,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(57,255,20,0.2);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h4 class="small" style="color:#39ff14;margin:0;">üöó Vehicle Information</h4>
      <button type="button" onclick="fuelLoadVehicleExample()" class="small-btn" style="font-size:11px;">Load Example</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="fuel-vehicle-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Vehicle Type</label>
        <select id="fuel-vehicle-type" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="custom">Custom</option>
          <option value="sedan">Sedan</option>
          <option value="suv" selected>SUV</option>
          <option value="truck">Truck</option>
          <option value="hybrid">Hybrid</option>
          <option value="electric">Electric</option>
          <option value="motorcycle">Motorcycle</option>
        </select>
      </div>
      
      <div class="field">
        <label for="fuel-efficiency" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Fuel Efficiency</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fuel-efficiency" type="number" min="1" max="100" value="15" step="0.1"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <select id="fuel-efficiency-unit" 
                  style="width:100px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="kmpl">km/L</option>
            <option value="mpg">MPG</option>
            <option value="l100km">L/100km</option>
          </select>
        </div>
      </div>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
      <div class="field">
        <label for="fuel-tank-capacity" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Tank Capacity</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fuel-tank-capacity" type="number" min="1" max="200" value="60" step="1"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <span style="color:var(--accent);">litres</span>
        </div>
      </div>
      
      <div class="field">
        <label for="fuel-current-fuel" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Current Fuel</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="fuel-current-fuel" type="number" min="0" max="200" value="30" step="1"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <span style="color:var(--accent);">% full</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Fuel Information -->
  <div style="background:rgba(255,165,0,0.05);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,165,0,0.2);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
      <h4 class="small" style="color:#ffa500;margin:0;">‚õΩ Fuel Information</h4>
      <button type="button" onclick="fuelFetchLivePrices()" class="small-btn" style="font-size:11px;">Fetch Live Prices</button>
    </div>
    
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div class="field">
        <label for="fuel-price" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Fuel Price</label>
        <div style="display:flex;gap:8px;align-items:center;">
          <select id="fuel-currency" 
                  style="width:80px;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="¬£">¬£</option>
            <option value="$" selected>$</option>
            <option value="‚Ç¨">‚Ç¨</option>
            <option value="¬•">¬•</option>
            <option value="‚Çπ">‚Çπ</option>
          </select>
          <input id="fuel-price" type="number" min="0.1" max="20" value="3.50" step="0.01"
                 style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;text-align:center;">
          <span style="color:var(--accent);">per unit</span>
        </div>
      </div>
      
      <div class="field">
        <label for="fuel-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Fuel Type</label>
        <select id="fuel-type" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
          <option value="petrol" selected>Petrol/Gasoline</option>
          <option value="diesel">Diesel</option>
          <option value="electric">Electricity</option>
          <option value="hybrid">Hybrid</option>
          <option value="cng">CNG</option>
          <option value="lpg">LPG</option>
        </select>
      </div>
    </div>
    
    <div id="fuel-price-trend" style="display:none;padding:10px;background:rgba(255,255,255,0.03);border-radius:6px;margin-top:8px;">
      <div class="small" style="color:#ffa500;">üìà Price trend: <span id="fuel-trend-text">Loading...</span></div>
    </div>
  </div>

  <!-- Advanced Options -->
  <div style="margin-bottom:20px;">
    <details>
      <summary style="color:var(--accent);font-weight:500;cursor:pointer;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;">‚öôÔ∏è Advanced Options</summary>
      <div style="margin-top:12px;display:grid;grid-template-columns:1fr 1fr;gap:12px;">
        <div class="field">
          <label for="fuel-traffic-factor" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Traffic Factor</label>
          <select id="fuel-traffic-factor" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="0.9">Light traffic (-10%)</option>
            <option value="1.0" selected>Normal traffic</option>
            <option value="1.1">Heavy traffic (+10%)</option>
            <option value="1.2">Severe traffic (+20%)</option>
          </select>
        </div>
        
        <div class="field">
          <label for="fuel-driving-style" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Driving Style</label>
          <select id="fuel-driving-style" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="0.9">Eco-friendly (-10%)</option>
            <option value="1.0" selected>Normal</option>
            <option value="1.1">Aggressive (+10%)</option>
            <option value="1.2">Very aggressive (+20%)</option>
          </select>
        </div>
        
        <div class="field">
          <label for="fuel-weather-factor" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Weather Conditions</label>
          <select id="fuel-weather-factor" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="0.95">Clear weather (-5%)</option>
            <option value="1.0" selected>Normal weather</option>
            <option value="1.05">Rainy (+5%)</option>
            <option value="1.15">Snow/ice (+15%)</option>
          </select>
        </div>
        
        <div class="field">
          <label for="fuel-road-type" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Road Type</label>
          <select id="fuel-road-type" 
                  style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.2);background:rgba(255,255,255,0.05);color:inherit;">
            <option value="0.95">Highway (-5%)</option>
            <option value="1.0" selected>Mixed roads</option>
            <option value="1.1">City traffic (+10%)</option>
            <option value="1.2">Mountain roads (+20%)</option>
          </select>
        </div>
      </div>
    </details>
  </div>

  <div class="actions" style="display:flex;gap:10px;">
    <button type="button" onclick="fuelCalculate(this)" 
            style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(57,255,20,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);font-weight:600;cursor:pointer;font-size:16px;">
      ‚õΩ Calculate All Costs
    </button>
    <button type="button" onclick="fuelReset(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset
    </button>
    <button type="button" onclick="fuelCompareVehicles()"
            style="padding:12px 16px;background:rgba(255,165,0,0.1);border:1px solid rgba(255,165,0,0.3);border-radius:8px;color:#ffa500;cursor:pointer;">
      Compare
    </button>
  </div>
</form>

<div id="fuel-results" aria-live="polite" style="margin-top:20px;display:none;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
    <h3 class="small" style="color:var(--accent);margin:0;">üìä Comprehensive Cost Analysis</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <div id="fuel-calculation-time" class="small" style="color:rgba(230,250,255,0.6);"></div>
    </div>
  </div>

  <div id="fuel-output-container" style="min-height:200px;">
    <!-- Results will be inserted here -->
  </div>

  <div id="fuel-breakdown-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìà Cost Breakdown</h4>
    <div id="fuel-breakdown-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">
      <!-- Breakdown will be inserted here -->
    </div>
  </div>

  <div id="fuel-savings-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:#39ff14;margin-bottom:12px;">üí° Potential Savings</h4>
    <div id="fuel-savings-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(57,255,20,0.2);">
      <!-- Savings tips will be inserted here -->
    </div>
  </div>

  <div id="fuel-charts-container" style="margin-top:20px;display:none;">
    <h4 class="small" style="color:var(--accent);margin-bottom:12px;">üìä Visual Comparison</h4>
    <div id="fuel-charts-content" style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);min-height:200px;">
      <!-- Charts will be inserted here -->
    </div>
  </div>

  <div style="margin-top:20px;">
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px;">
      <button onclick="fuelCopyResults()" 
              style="padding:10px;background:rgba(45,212,255,0.05);border:1px solid rgba(45,212,255,0.2);border-radius:8px;color:var(--accent);cursor:pointer;font-size:12px;">
        üìã Copy Results
      </button>
      <button onclick="fuelDownloadReport()" 
              style="padding:10px;background:rgba(57,255,20,0.05);border:1px solid rgba(57,255,20,0.2);border-radius:8px;color:#39ff14;cursor:pointer;font-size:12px;">
        üíæ Download Report
      </button>
      <button onclick="fuelShareResults()" 
              style="padding:10px;background:rgba(255,165,0,0.05);border:1px solid rgba(255,165,0,0.2);border-radius:8px;color:#ffa500;cursor:pointer;font-size:12px;">
        üì± Share
      </button>
    </div>

    <div style="margin-top:16px;display:flex;justify-content:space-between;align-items:center;">
      <div id="fuel-hint" class="small" style="color:#39ff14;"></div>
      <button onclick="fuelShowAlternativeRoutes()" 
              style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">
        üó∫Ô∏è Alternative Routes
      </button>
    </div>
  </div>
</div>

<script>
/* fuel-cost-calculator.html
   - Enhanced Fuel Cost Calculator with Carbon Footprint, Maintenance, and Route Optimization
   - Scoped with fuel- prefix
*/

// Vehicle database with average efficiency and maintenance rates
const fuelVehicles = {
  'sedan': { 
    efficiency: 15, 
    unit: 'kmpl', 
    tank: 55,
    maintenance: 0.10, // $ per km
    color: '#2dd4ff'
  },
  'suv': { 
    efficiency: 12, 
    unit: 'kmpl', 
    tank: 70,
    maintenance: 0.12,
    color: '#39ff14'
  },
  'truck': { 
    efficiency: 8, 
    unit: 'kmpl', 
    tank: 120,
    maintenance: 0.15,
    color: '#ffa500'
  },
  'hybrid': { 
    efficiency: 22, 
    unit: 'kmpl', 
    tank: 45,
    maintenance: 0.08,
    color: '#9d4edd'
  },
  'electric': { 
    efficiency: 6, 
    unit: 'kmpl', 
    tank: 0,
    maintenance: 0.06,
    color: '#ff2d55'
  },
  'motorcycle': { 
    efficiency: 30, 
    unit: 'kmpl', 
    tank: 15,
    maintenance: 0.05,
    color: '#ffcc00'
  }
};

// Carbon footprint data (kg CO2 per unit)
const carbonIntensity = {
  'petrol': 2.31,    // kg CO2 per liter
  'diesel': 2.68,    // kg CO2 per liter
  'electric': 0.12,  // kg CO2 per kWh (grid average)
  'cng': 1.87,       // kg CO2 per kg
  'lpg': 1.50,       // kg CO2 per liter
  'hybrid': 1.80     // kg CO2 per liter (average)
};

// Simulated fuel prices with trends
const fuelPrices = {
  'petrol': { price: 3.50, trend: 'stable' },
  'diesel': { price: 3.80, trend: 'rising' },
  'electric': { price: 0.15, trend: 'stable' },
  'cng': { price: 2.50, trend: 'falling' },
  'lpg': { price: 2.20, trend: 'stable' },
  'hybrid': { price: 3.50, trend: 'stable' }
};

// Initialize the tool
function fuelInit() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set up event listeners
  const vehicleSelect = card.querySelector('#fuel-vehicle-type');
  if (vehicleSelect) {
    vehicleSelect.addEventListener('change', fuelUpdateVehicle);
  }
  
  const fuelTypeSelect = card.querySelector('#fuel-type');
  if (fuelTypeSelect) {
    fuelTypeSelect.addEventListener('change', fuelUpdateFuelType);
  }
  
  // Set up real-time calculation
  const inputs = card.querySelectorAll('#fuel-trip-distance, #fuel-efficiency, #fuel-price');
  inputs.forEach(input => {
    input.addEventListener('input', () => {
      if (card.querySelector('#fuel-results').style.display === 'block') {
        setTimeout(() => fuelCalculate(document.querySelector('.actions button')), 500);
      }
    });
  });
  
  // Initialize vehicle and fuel type
  fuelUpdateVehicle();
  fuelUpdateFuelType();
  
  // Load any saved history
  fuelLoadHistory();
  
  console.log('Fuel Cost Calculator Pro initialized');
}

// Update vehicle settings based on selection
function fuelUpdateVehicle() {
  const card = document.currentScript?.closest('.card') || document;
  const vehicleType = card.querySelector('#fuel-vehicle-type').value;
  
  if (vehicleType !== 'custom' && fuelVehicles[vehicleType]) {
    const vehicle = fuelVehicles[vehicleType];
    card.querySelector('#fuel-efficiency').value = vehicle.efficiency;
    card.querySelector('#fuel-efficiency-unit').value = vehicle.unit;
    card.querySelector('#fuel-tank-capacity').value = vehicle.tank;
    
    // Update hint
    fuelShowMessage(`Loaded ${vehicleType} vehicle settings`, '#39ff14', 2000);
  }
}

// Update fuel price based on type
function fuelUpdateFuelType() {
  const card = document.currentScript?.closest('.card') || document;
  const fuelType = card.querySelector('#fuel-type').value;
  
  if (fuelPrices[fuelType]) {
    const priceInfo = fuelPrices[fuelType];
    card.querySelector('#fuel-price').value = priceInfo.price.toFixed(2);
    
    // Update price trend display
    const trendContainer = card.querySelector('#fuel-price-trend');
    const trendText = card.querySelector('#fuel-trend-text');
    
    trendContainer.style.display = 'block';
    trendText.textContent = `${priceInfo.trend} (simulated data)`;
    
    // Color code trend
    if (priceInfo.trend === 'rising') {
      trendText.style.color = '#ff2d55';
    } else if (priceInfo.trend === 'falling') {
      trendText.style.color = '#39ff14';
    } else {
      trendText.style.color = '#ffa500';
    }
  }
}

// Load vehicle example
function fuelLoadVehicleExample() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Set example values for a typical commute
  card.querySelector('#fuel-trip-distance').value = 25;
  card.querySelector('#fuel-distance-unit').value = 'km';
  card.querySelector('#fuel-vehicle-type').value = 'sedan';
  card.querySelector('#fuel-efficiency').value = 14;
  card.querySelector('#fuel-efficiency-unit').value = 'kmpl';
  card.querySelector('#fuel-price').value = 3.75;
  card.querySelector('#fuel-currency').value = '$';
  card.querySelector('#fuel-type').value = 'petrol';
  card.querySelector('#fuel-passengers').value = 1;
  card.querySelector('#fuel-trip-frequency').value = 'daily';
  
  fuelUpdateVehicle();
  fuelUpdateFuelType();
  
  fuelShowMessage('Example daily commute loaded', '#ffa500', 2000);
}

// Enhanced live price fetching with realistic simulation
async function fuelFetchLivePrices() {
  const card = document.currentScript?.closest('.card') || document;
  const fuelType = card.querySelector('#fuel-type').value;
  
  const hint = card.querySelector('#fuel-hint');
  fuelShowMessage('Fetching live prices...', '#2dd4ff', 1000);
  
  // Simulate API call with realistic daily patterns
  setTimeout(() => {
    const currentHour = new Date().getHours();
    let priceAdjustment = 0;
    
    // Simulate daily price fluctuations (realistic patterns)
    if (currentHour >= 7 && currentHour <= 9) priceAdjustment = 0.12;  // Morning rush hour premium
    if (currentHour >= 16 && currentHour <= 18) priceAdjustment = 0.15; // Evening rush hour premium
    if (currentHour >= 22 || currentHour <= 5) priceAdjustment = -0.10; // Late night discount
    
    // Weekend effect
    const day = new Date().getDay();
    if (day === 0 || day === 6) priceAdjustment += 0.08; // Weekend premium
    
    // Random market fluctuation
    const marketFluctuation = (Math.random() * 0.3 - 0.15); // -15% to +15%
    priceAdjustment += marketFluctuation;
    
    const currentPrice = parseFloat(card.querySelector('#fuel-price').value);
    const newPrice = currentPrice + priceAdjustment;
    
    // Keep within realistic bounds
    const boundedPrice = Math.max(2.50, Math.min(6.00, newPrice)).toFixed(2);
    
    card.querySelector('#fuel-price').value = boundedPrice;
    
    // Determine trend
    const trend = priceAdjustment > 0.1 ? 'rising' : 
                  priceAdjustment < -0.1 ? 'falling' : 'stable';
    
    // Update trend display
    const trendContainer = card.querySelector('#fuel-price-trend');
    const trendText = card.querySelector('#fuel-trend-text');
    trendContainer.style.display = 'block';
    trendText.textContent = `${trend} (simulated: ${priceAdjustment > 0 ? '+' : ''}${priceAdjustment.toFixed(2)})`;
    trendText.style.color = trend === 'rising' ? '#ff2d55' : trend === 'falling' ? '#39ff14' : '#ffa500';
    
    fuelShowMessage(`Price updated: $${boundedPrice} (${trend})`, 
                   trend === 'rising' ? '#ff2d55' : '#39ff14', 3000);
    
  }, 800);
}

// Convert efficiency to common unit (L/100km)
function fuelConvertToL100km(efficiency, unit) {
  switch (unit) {
    case 'kmpl': // km per litre
      return 100 / efficiency;
    case 'mpg': // miles per gallon
      return 235.215 / efficiency; // Convert MPG to L/100km
    case 'l100km': // litres per 100km
      return efficiency;
    default:
      return 100 / efficiency;
  }
}

// Convert distance to km
function fuelConvertToKm(distance, unit) {
  if (unit === 'miles') {
    return distance * 1.60934;
  }
  return distance;
}

// Calculate fuel consumption with proper unit handling
function fuelCalculateConsumption(distanceKm, efficiency, unit) {
  const l100km = fuelConvertToL100km(efficiency, unit);
  return (distanceKm * l100km) / 100;
}

// Calculate maintenance cost
function calculateMaintenanceCost(distanceKm, vehicleType) {
  const vehicle = fuelVehicles[vehicleType];
  if (!vehicle || !vehicle.maintenance) return 0;
  
  return distanceKm * vehicle.maintenance;
}

// Calculate carbon emissions
function calculateCarbonEmissions(consumption, fuelType) {
  const intensity = carbonIntensity[fuelType];
  if (!intensity) return 0;
  
  return consumption * intensity;
}

// Track fuel consumption history
function trackFuelHistory(data) {
  try {
    const history = JSON.parse(localStorage.getItem('fuel_history') || '[]');
    
    const entry = {
      date: new Date().toISOString(),
      distance: data.distance,
      consumption: data.consumption,
      cost: data.cost,
      efficiency: data.efficiency,
      vehicleType: document.querySelector('#fuel-vehicle-type').value,
      fuelType: data.fuelType,
      emissions: data.emissions
    };
    
    history.unshift(entry); // Add to beginning
    if (history.length > 100) history.pop(); // Keep only last 100 entries
    
    localStorage.setItem('fuel_history', JSON.stringify(history));
  } catch (e) {
    console.log('Could not save history:', e);
  }
}

// Load and display history
function fuelLoadHistory() {
  try {
    const history = JSON.parse(localStorage.getItem('fuel_history') || '[]');
    if (history.length > 0) {
      console.log(`Loaded ${history.length} historical fuel calculations`);
    }
  } catch (e) {
    console.log('Could not load history');
  }
}

// Main calculation function
function fuelCalculate(btn) {
  const startTime = performance.now();
  const card = btn.closest('.card') || document;
  
  // Get all inputs
  const distance = parseFloat(card.querySelector('#fuel-trip-distance').value);
  const distanceUnit = card.querySelector('#fuel-distance-unit').value;
  const efficiency = parseFloat(card.querySelector('#fuel-efficiency').value);
  const efficiencyUnit = card.querySelector('#fuel-efficiency-unit').value;
  const price = parseFloat(card.querySelector('#fuel-price').value);
  const currency = card.querySelector('#fuel-currency').value;
  const fuelType = card.querySelector('#fuel-type').value;
  const returnTrip = card.querySelector('#fuel-return-trip').checked;
  const passengers = parseInt(card.querySelector('#fuel-passengers').value) || 1;
  const frequency = card.querySelector('#fuel-trip-frequency').value;
  const vehicleType = card.querySelector('#fuel-vehicle-type').value;
  
  // Get advanced factors
  const trafficFactor = parseFloat(card.querySelector('#fuel-traffic-factor').value);
  const drivingFactor = parseFloat(card.querySelector('#fuel-driving-style').value);
  const weatherFactor = parseFloat(card.querySelector('#fuel-weather-factor').value);
  const roadFactor = parseFloat(card.querySelector('#fuel-road-type').value);
  
  // Validate inputs
  if (!distance || distance <= 0 || !efficiency || efficiency <= 0 || !price || price <= 0) {
    fuelShowMessage('Please enter valid distance, efficiency, and price values', '#ff2d55', 3000);
    return;
  }
  
  // Calculate total distance
  const totalDistanceKm = fuelConvertToKm(distance, distanceUnit) * (returnTrip ? 2 : 1);
  
  // Calculate base consumption
  const baseConsumption = fuelCalculateConsumption(totalDistanceKm, efficiency, efficiencyUnit);
  
  // Apply adjustment factors
  const adjustmentFactor = trafficFactor * drivingFactor * weatherFactor * roadFactor;
  const adjustedConsumption = baseConsumption * adjustmentFactor;
  
  // Calculate fuel cost
  const fuelCost = adjustedConsumption * price;
  
  // Calculate maintenance cost
  const maintenanceCost = calculateMaintenanceCost(totalDistanceKm, vehicleType);
  
  // Calculate carbon emissions
  const emissions = calculateCarbonEmissions(adjustedConsumption, fuelType);
  const treesNeeded = emissions / 21; // One tree absorbs ~21kg CO2 per year
  
  // Calculate total cost (fuel + maintenance)
  const totalCost = fuelCost + maintenanceCost;
  const costPerPassenger = totalCost / passengers;
  
  // Calculate frequency costs
  const frequencyMultipliers = {
    'single': 1,
    'daily': 365,
    'weekly': 52,
    'monthly': 12,
    'yearly': 1
  };
  
  const yearlyCost = totalCost * (frequencyMultipliers[frequency] || 1);
  
  // Calculate trip feasibility
  const tankCapacity = parseFloat(card.querySelector('#fuel-tank-capacity').value) || 60;
  const currentFuel = parseFloat(card.querySelector('#fuel-current-fuel').value) || 100;
  const currentFuelLitres = (currentFuel / 100) * tankCapacity;
  const canMakeTrip = currentFuelLitres >= adjustedConsumption;
  const fuelNeeded = Math.max(0, adjustedConsumption - currentFuelLitres);
  const refuelCost = fuelNeeded * price;
  
  // Prepare data object
  const data = {
    distance: totalDistanceKm,
    distanceUnit: 'km',
    consumption: adjustedConsumption,
    baseConsumption: baseConsumption,
    fuelCost: fuelCost,
    maintenanceCost: maintenanceCost,
    totalCost: totalCost,
    yearlyCost: yearlyCost,
    costPerPassenger: costPerPassenger,
    currency: currency,
    fuelType: fuelType,
    passengers: passengers,
    frequency: frequency,
    vehicleType: vehicleType,
    canMakeTrip: canMakeTrip,
    fuelNeeded: fuelNeeded,
    refuelCost: refuelCost,
    adjustmentFactor: adjustmentFactor,
    efficiency: efficiency,
    efficiencyUnit: efficiencyUnit,
    emissions: emissions,
    treesNeeded: treesNeeded
  };
  
  // Display results
  fuelDisplayResults(card, data);
  
  // Show additional sections
  fuelShowBreakdown(card, {
    baseConsumption: baseConsumption,
    adjustedConsumption: adjustedConsumption,
    fuelCost: fuelCost,
    maintenanceCost: maintenanceCost,
    totalCost: totalCost,
    factors: {
      traffic: trafficFactor,
      driving: drivingFactor,
      weather: weatherFactor,
      road: roadFactor
    }
  });
  
  fuelShowSavingsTips(card, data);
  
  // Track history
  trackFuelHistory(data);
  
  // Calculate and show execution time
  const endTime = performance.now();
  const timeTaken = (endTime - startTime).toFixed(2);
  card.querySelector('#fuel-calculation-time').textContent = `Calculated in ${timeTaken}ms`;
  
  // Show results section
  const resultsDiv = card.querySelector('#fuel-results');
  resultsDiv.style.display = 'block';
  resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  fuelShowMessage('Fuel cost calculated successfully!', '#39ff14', 2000);
}

// Display main results with all enhancements
function fuelDisplayResults(card, data) {
  const container = card.querySelector('#fuel-output-container');
  
  let html = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  
  // Main cost display
  html += `<div style="text-align:center;margin-bottom:24px;">`;
  html += `<div style="font-size:48px;font-weight:600;color:var(--accent);">${data.currency}${data.totalCost.toFixed(2)}</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.7);">Total ${data.frequency} cost (fuel + maintenance)</div>`;
  html += `</div>`;
  
  // Key metrics grid - 2x3 layout
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">`;
  
  html += `<div style="padding:12px;background:rgba(45,212,255,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:var(--accent);">üöó Fuel Cost</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.currency}${data.fuelCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(255,165,0,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#ffa500;">üîß Maintenance</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.currency}${data.maintenanceCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(57,255,20,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#39ff14;">üë• Per Passenger</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.currency}${data.costPerPassenger.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(255,77,77,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#ff4d4d;">üìè Distance</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.distance.toFixed(1)} km</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(157,78,221,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#9d4edd;">üåç CO‚ÇÇ Emissions</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.emissions.toFixed(1)} kg</div>`;
  html += `</div>`;
  
  html += `<div style="padding:12px;background:rgba(255,204,0,0.05);border-radius:8px;">`;
  html += `<div class="small" style="color:#ffcc00;">üìÖ Yearly Cost</div>`;
  html += `<div style="font-size:18px;font-weight:600;">${data.currency}${data.yearlyCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `</div>`;
  
  // Trip feasibility
  if (!data.canMakeTrip) {
    html += `<div style="margin-top:12px;padding:12px;background:rgba(255,77,77,0.1);border-radius:8px;border:1px solid rgba(255,77,77,0.3);">`;
    html += `<div style="color:#ff4d4d;font-weight:600;">‚ö†Ô∏è Need to Refuel</div>`;
    html += `<div class="small" style="color:rgba(230,250,255,0.8);">You'll need ${data.fuelNeeded.toFixed(2)}L more fuel (${data.currency}${data.refuelCost.toFixed(2)}) for this trip</div>`;
    html += `</div>`;
  } else {
    html += `<div style="margin-top:12px;padding:12px;background:rgba(57,255,20,0.1);border-radius:8px;border:1px solid rgba(57,255,20,0.3);">`;
    html += `<div style="color:#39ff14;font-weight:600;">‚úÖ Sufficient Fuel</div>`;
    html += `<div class="small" style="color:rgba(230,250,255,0.8);">You have enough fuel for this trip</div>`;
    html += `</div>`;
  }
  
  // Environmental impact
  html += `<div style="margin-top:16px;padding:12px;background:rgba(157,78,221,0.1);border-radius:8px;border:1px solid rgba(157,78,221,0.3);">`;
  html += `<div style="color:#9d4edd;font-weight:600;">üåç Environmental Impact</div>`;
  html += `<div class="small" style="color:rgba(230,250,255,0.8);">`;
  html += `Carbon footprint: <strong>${data.emissions.toFixed(1)} kg CO‚ÇÇ</strong><br>`;
  html += `Equivalent to <strong>${data.treesNeeded.toFixed(1)} trees</strong> absorbing for a year<br>`;
  html += `<small style="color:rgba(230,250,255,0.6);">Based on average carbon intensity for ${data.fuelType}</small>`;
  html += `</div>`;
  html += `</div>`;
  
  html += `</div>`;
  
  container.innerHTML = html;
  
  // Show breakdown container
  card.querySelector('#fuel-breakdown-container').style.display = 'block';
  card.querySelector('#fuel-savings-container').style.display = 'block';
  
  // Store data for copying
  container.dataset.fuelData = JSON.stringify(data);
}

// Enhanced cost breakdown
function fuelShowBreakdown(card, data) {
  const container = card.querySelector('#fuel-breakdown-content');
  
  let html = `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Base Consumption</div>`;
  html += `<div style="font-weight:600;">${data.baseConsumption.toFixed(2)} L</div>`;
  html += `</div>`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Adjusted Consumption</div>`;
  html += `<div style="font-weight:600;">${data.adjustedConsumption.toFixed(2)} L</div>`;
  html += `</div>`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Fuel Cost</div>`;
  html += `<div style="font-weight:600;">$${data.fuelCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Maintenance</div>`;
  html += `<div style="font-weight:600;">$${data.maintenanceCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Total Cost</div>`;
  html += `<div style="font-weight:600;color:#39ff14;">$${data.totalCost.toFixed(2)}</div>`;
  html += `</div>`;
  
  html += `<div>`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:4px;">Adjustment Factor</div>`;
  html += `<div style="font-weight:600;">${data.adjustmentFactor.toFixed(2)}x</div>`;
  html += `</div>`;
  html += `</div>`;
  
  // Factor breakdown
  html += `<div style="margin-top:16px;">`;
  html += `<div class="small" style="color:var(--accent);margin-bottom:8px;">Impact Factors:</div>`;
  html += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr;gap:8px;">`;
  
  const factors = [
    { name: 'Traffic', value: data.factors.traffic, color: '#2dd4ff' },
    { name: 'Driving', value: data.factors.driving, color: '#39ff14' },
    { name: 'Weather', value: data.factors.weather, color: '#ffa500' },
    { name: 'Road', value: data.factors.road, color: '#ff4d4d' }
  ];
  
  factors.forEach(factor => {
    const impact = ((factor.value - 1) * 100).toFixed(0);
    const sign = impact >= 0 ? '+' : '';
    
    html += `<div style="text-align:center;padding:8px;background:rgba(255,255,255,0.03);border-radius:6px;">`;
    html += `<div class="small" style="color:${factor.color};">${factor.name}</div>`;
    html += `<div style="font-weight:600;color:${impact >= 0 ? '#ff4d4d' : '#39ff14'};">${sign}${impact}%</div>`;
    html += `</div>`;
  });
  
  html += `</div>`;
  html += `</div>`;
  
  container.innerHTML = html;
}

// Enhanced savings tips with personalized suggestions
function fuelShowSavingsTips(card, data) {
  const container = card.querySelector('#fuel-savings-content');
  
  const tips = [];
  
  // Generate personalized tips based on data
  if (data.adjustmentFactor > 1.1) {
    tips.push(`üîÑ Improve driving habits - current factors increase cost by ${((data.adjustmentFactor-1)*100).toFixed(0)}%`);
  }
  
  if (data.efficiency < 15 && data.efficiencyUnit === 'kmpl') {
    tips.push(`üöó Consider a more fuel-efficient vehicle (aim for 15+ km/L)`);
  }
  
  if (data.passengers === 1) {
    tips.push(`üë• Carpooling could save ~${(data.totalCost * 0.5).toFixed(2)} per trip`);
  }
  
  if (data.fuelCost > 50) {
    tips.push(`‚õΩ Fuel-efficient routes could save 10-25% on long trips`);
  }
  
  tips.push(`üö¶ Avoid rush hour traffic to save ~10% on fuel`);
  tips.push(`‚ö° Maintain proper tire pressure for 3% better efficiency`);
  tips.push(`üîß Regular maintenance improves efficiency by 4-10%`);
  tips.push(`üì± Use apps to find cheaper fuel stations`);
  
  let html = `<div style="display:grid;gap:8px;">`;
  
  tips.forEach(tip => {
    html += `<div style="display:flex;align-items:start;gap:8px;">`;
    html += `<span style="color:#39ff14;">‚Ä¢</span>`;
    html += `<span style="flex:1;">${tip}</span>`;
    html += `</div>`;
  });
  
  // Calculate potential savings
  const potentialSavings = data.totalCost * 0.15; // Assume 15% savings possible
  const yearlySavings = data.yearlyCost * 0.15;
  
  html += `<div style="margin-top:12px;padding:10px;background:rgba(57,255,20,0.1);border-radius:6px;">`;
  html += `<div style="color:#39ff14;font-weight:600;">üí∞ Potential Savings</div>`;
  html += `<div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px;">`;
  html += `<div><small>Per trip:</small><br><strong>${data.currency}${potentialSavings.toFixed(2)}</strong></div>`;
  html += `<div><small>Yearly:</small><br><strong>${data.currency}${yearlySavings.toFixed(2)}</strong></div>`;
  html += `</div>`;
  html += `</div>`;
  
  html += `</div>`;
  container.innerHTML = html;
}

// Compare different vehicle types
function fuelCompareVehicles() {
  const card = document.currentScript?.closest('.card') || document;
  
  // Get current trip data
  const distance = parseFloat(card.querySelector('#fuel-trip-distance').value);
  const distanceUnit = card.querySelector('#fuel-distance-unit').value;
  const price = parseFloat(card.querySelector('#fuel-price').value);
  const currency = card.querySelector('#fuel-currency').value;
  const returnTrip = card.querySelector('#fuel-return-trip').checked;
  
  const totalDistanceKm = fuelConvertToKm(distance, distanceUnit) * (returnTrip ? 2 : 1);
  
  let comparison = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  comparison += `<h4 class="small" style="color:var(--accent);margin-bottom:16px;">üöó Vehicle Comparison</h4>`;
  comparison += `<div style="display:grid;gap:8px;">`;
  
  Object.entries(fuelVehicles).forEach(([type, vehicle]) => {
    if (type === 'electric') return; // Skip electric for now (different units)
    
    const consumption = fuelCalculateConsumption(totalDistanceKm, vehicle.efficiency, vehicle.unit);
    const fuelCost = consumption * price;
    const maintenanceCost = calculateMaintenanceCost(totalDistanceKm, type);
    const totalCost = fuelCost + maintenanceCost;
    const emissions = calculateCarbonEmissions(consumption, 'petrol');
    
    comparison += `<div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:6px;border-left:4px solid ${vehicle.color};">`;
    comparison += `<div>`;
    comparison += `<div style="font-weight:600;color:#fff;text-transform:capitalize;">${type}</div>`;
    comparison += `<div style="font-size:11px;color:rgba(230,250,255,0.6);">${vehicle.efficiency} ${vehicle.unit} ‚Ä¢ ${emissions.toFixed(1)}kg CO‚ÇÇ</div>`;
    comparison += `</div>`;
    comparison += `<div style="text-align:right;">`;
    comparison += `<div style="color:${vehicle.color};font-weight:600;">${currency}${totalCost.toFixed(2)}</div>`;
    comparison += `<div style="font-size:11px;color:rgba(230,250,255,0.6);">Fuel: ${currency}${fuelCost.toFixed(2)}</div>`;
    comparison += `</div>`;
    comparison += `</div>`;
  });
  
  comparison += `</div>`;
  comparison += `<div style="margin-top:12px;font-size:12px;color:rgba(230,250,255,0.6);">`;
  comparison += `üí° Tip: Switching to a more efficient vehicle can save 20-50% on fuel costs`;
  comparison += `</div>`;
  comparison += `</div>`;
  
  // Show charts container
  const chartsContainer = card.querySelector('#fuel-charts-container');
  const chartsContent = card.querySelector('#fuel-charts-content');
  chartsContent.innerHTML = comparison;
  chartsContainer.style.display = 'block';
  chartsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  fuelShowMessage('Vehicle comparison generated', '#ffa500', 3000);
}

// Show alternative routes with realistic simulation
function fuelShowAlternativeRoutes() {
  const card = document.currentScript?.closest('.card') || document;
  const distance = parseFloat(card.querySelector('#fuel-trip-distance').value);
  const unit = card.querySelector('#fuel-distance-unit').value;
  
  const baseDistanceKm = unit === 'miles' ? distance * 1.60934 : distance;
  
  // Simulate 3 route alternatives with realistic parameters
  const routes = [
    { 
      name: 'üöó Fastest Route', 
      distance: baseDistanceKm, 
      traffic: 'heavy', 
      time: `${Math.round(baseDistanceKm/40*60)} min`, 
      savings: 0,
      description: 'Direct but congested'
    },
    { 
      name: 'üîÑ Eco Route', 
      distance: baseDistanceKm * 1.15, 
      traffic: 'light', 
      time: `${Math.round(baseDistanceKm*1.15/50*60)} min`, 
      savings: 18,
      description: 'Slightly longer, much smoother'
    },
    { 
      name: 'üö≤ Scenic Route', 
      distance: baseDistanceKm * 1.35, 
      traffic: 'none', 
      time: `${Math.round(baseDistanceKm*1.35/60*60)} min`, 
      savings: 28,
      description: 'Long but efficient and pleasant'
    }
  ];
  
  // Create route comparison UI
  let routesHtml = `<div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:20px;border:1px solid rgba(45,212,255,0.2);">`;
  routesHtml += `<h4 class="small" style="color:var(--accent);margin-bottom:16px;">üó∫Ô∏è Route Alternatives Analysis</h4>`;
  routesHtml += `<div style="display:grid;gap:12px;">`;
  
  routes.forEach(route => {
    const efficiency = parseFloat(card.querySelector('#fuel-efficiency').value);
    const unit = card.querySelector('#fuel-efficiency-unit').value;
    const price = parseFloat(card.querySelector('#fuel-price').value);
    const currency = card.querySelector('#fuel-currency').value;
    
    const consumption = fuelCalculateConsumption(route.distance, efficiency, unit);
    const cost = consumption * price;
    const savingsAmount = (cost * route.savings) / 100;
    const emissions = calculateCarbonEmissions(consumption, card.querySelector('#fuel-type').value);
    
    routesHtml += `<div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;border-left:4px solid ${route.savings > 20 ? '#39ff14' : route.savings > 10 ? '#ffa500' : '#2dd4ff'};">`;
    routesHtml += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">`;
    routesHtml += `<span style="font-weight:600;color:#fff;">${route.name}</span>`;
    routesHtml += `<span style="color:var(--accent);font-weight:600;">${currency}${cost.toFixed(2)}</span>`;
    routesHtml += `</div>`;
    routesHtml += `<div style="font-size:12px;color:rgba(230,250,255,0.7);margin-bottom:6px;">${route.description}</div>`;
    routesHtml += `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;font-size:12px;color:rgba(230,250,255,0.7);">`;
    routesHtml += `<div>üìè ${route.distance.toFixed(1)} km</div>`;
    routesHtml += `<div>‚è±Ô∏è ${route.time}</div>`;
    routesHtml += `<div style="color:#39ff14;">üíµ Save ${route.savings}%</div>`;
    routesHtml += `</div>`;
    routesHtml += `<div style="font-size:11px;color:rgba(230,250,255,0.6);margin-top:4px;">`;
    routesHtml += `üåç ${emissions.toFixed(1)}kg CO‚ÇÇ ‚Ä¢ Traffic: ${route.traffic}`;
    routesHtml += `</div>`;
    routesHtml += `</div>`;
  });
  
  routesHtml += `</div>`;
  routesHtml += `<div style="margin-top:12px;padding:10px;background:rgba(57,255,20,0.1);border-radius:6px;">`;
  routesHtml += `<div style="color:#39ff14;font-size:12px;">üí° Best choice: Eco Route saves ~18% with only 15% extra distance</div>`;
  routesHtml += `</div>`;
  routesHtml += `</div>`;
  
  const chartsContent = card.querySelector('#fuel-charts-content');
  chartsContent.innerHTML = routesHtml;
  
  // Show the container
  const chartsContainer = card.querySelector('#fuel-charts-container');
  chartsContainer.style.display = 'block';
  chartsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  fuelShowMessage('Route alternatives calculated!', '#39ff14', 3000);
}

// Enhanced reset function
function fuelReset(btn) {
  const card = btn.closest('.card') || document;
  
  // Reset form to default values
  card.querySelector('#fuel-trip-distance').value = 100;
  card.querySelector('#fuel-distance-unit').value = 'km';
  card.querySelector('#fuel-efficiency').value = 15;
  card.querySelector('#fuel-efficiency-unit').value = 'kmpl';
  card.querySelector('#fuel-price').value = 3.50;
  card.querySelector('#fuel-currency').value = '$';
  card.querySelector('#fuel-type').value = 'petrol';
  card.querySelector('#fuel-return-trip').checked = true;
  card.querySelector('#fuel-passengers').value = 1;
  card.querySelector('#fuel-trip-frequency').value = 'weekly';
  card.querySelector('#fuel-vehicle-type').value = 'suv';
  card.querySelector('#fuel-tank-capacity').value = 60;
  card.querySelector('#fuel-current-fuel').value = 30;
  
  // Reset advanced options
  card.querySelector('#fuel-traffic-factor').value = '1.0';
  card.querySelector('#fuel-driving-style').value = '1.0';
  card.querySelector('#fuel-weather-factor').value = '1.0';
  card.querySelector('#fuel-road-type').value = '1.0';
  
  // Hide results
  const resultsDiv = card.querySelector('#fuel-results');
  resultsDiv.style.display = 'none';
  
  // Hide price trend
  const trendContainer = card.querySelector('#fuel-price-trend');
  trendContainer.style.display = 'none';
  
  // Clear hint
  const hint = card.querySelector('#fuel-hint');
  hint.textContent = '';
  
  fuelShowMessage('Calculator reset to defaults', '#ffa500', 2000);
}

// Copy results to clipboard
function fuelCopyResults() {
  const card = document.currentScript?.closest('.card') || document;
  const data = card.querySelector('#fuel-output-container').dataset.fuelData;
  
  if (!data) {
    fuelShowMessage('No results available to copy', '#ff2d55', 3000);
    return;
  }
  
  const fuelData = JSON.parse(data);
  const text = `Fuel Cost Calculation Report\n` +
               `=============================\n` +
               `Total Cost: ${fuelData.currency}${fuelData.totalCost.toFixed(2)}\n` +
               `- Fuel: ${fuelData.currency}${fuelData.fuelCost.toFixed(2)}\n` +
               `- Maintenance: ${fuelData.currency}${fuelData.maintenanceCost.toFixed(2)}\n` +
               `Distance: ${fuelData.distance.toFixed(1)} km\n` +
               `Consumption: ${fuelData.consumption.toFixed(2)} L\n` +
               `Cost per Passenger: ${fuelData.currency}${fuelData.costPerPassenger.toFixed(2)}\n` +
               `Yearly Cost: ${fuelData.currency}${fuelData.yearlyCost.toFixed(2)}\n` +
               `Carbon Footprint: ${fuelData.emissions.toFixed(1)} kg CO‚ÇÇ\n` +
               `Generated: ${new Date().toLocaleString()}`;
  
  navigator.clipboard.writeText(text).then(() => {
    fuelShowMessage('‚úÖ Results copied to clipboard!', '#39ff14', 3000);
  }).catch(err => {
    console.error('Copy failed:', err);
    fuelShowMessage('‚ùå Copy failed - try selecting text manually', '#ff2d55', 3000);
  });
}

// Download report as text file
function fuelDownloadReport() {
  const card = document.currentScript?.closest('.card') || document;
  const data = card.querySelector('#fuel-output-container').dataset.fuelData;
  
  if (!data) {
    fuelShowMessage('No results available to download', '#ff2d55', 3000);
    return;
  }
  
  const fuelData = JSON.parse(data);
  let text = `FUEL COST CALCULATION REPORT\n`;
  text += `=============================\n\n`;
  text += `GENERATED: ${new Date().toLocaleString()}\n\n`;
  text += `TRIP INFORMATION:\n`;
  text += `Distance: ${fuelData.distance.toFixed(1)} km\n`;
  text += `Passengers: ${fuelData.passengers}\n`;
  text += `Frequency: ${fuelData.frequency}\n`;
  text += `Vehicle: ${fuelData.vehicleType}\n`;
  text += `Fuel Type: ${fuelData.fuelType}\n\n`;
  text += `COST BREAKDOWN:\n`;
  text += `Total Cost: ${fuelData.currency}${fuelData.totalCost.toFixed(2)}\n`;
  text += `- Fuel Cost: ${fuelData.currency}${fuelData.fuelCost.toFixed(2)}\n`;
  text += `- Maintenance: ${fuelData.currency}${fuelData.maintenanceCost.toFixed(2)}\n`;
  text += `Cost per Passenger: ${fuelData.currency}${fuelData.costPerPassenger.toFixed(2)}\n`;
  text += `Yearly Cost: ${fuelData.currency}${fuelData.yearlyCost.toFixed(2)}\n\n`;
  text += `ENVIRONMENTAL IMPACT:\n`;
  text += `Carbon Emissions: ${fuelData.emissions.toFixed(1)} kg CO‚ÇÇ\n`;
  text += `Equivalent to ${fuelData.treesNeeded.toFixed(1)} trees absorbing for a year\n\n`;
  text += `ADDITIONAL INFO:\n`;
  text += `Fuel Consumption: ${fuelData.consumption.toFixed(2)} L\n`;
  text += `Efficiency: ${fuelData.efficiency} ${fuelData.efficiencyUnit}\n`;
  
  if (!fuelData.canMakeTrip) {
    text += `\nNOTICE: Need to refuel ${fuelData.fuelNeeded.toFixed(2)}L more\n`;
  }
  
  const blob = new Blob([text], { type: 'text/plain' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `fuel-cost-report-${new Date().toISOString().slice(0,10)}.txt`;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  fuelShowMessage('‚úÖ Report downloaded!', '#39ff14', 3000);
}

// Share results
function fuelShareResults() {
  const card = document.currentScript?.closest('.card') || document;
  const data = card.querySelector('#fuel-output-container').dataset.fuelData;
  
  if (!data) {
    fuelShowMessage('No results to share', '#ff2d55', 3000);
    return;
  }
  
  const fuelData = JSON.parse(data);
  const shareText = `My trip analysis: ${fuelData.currency}${fuelData.totalCost.toFixed(2)} total cost for ${fuelData.distance.toFixed(1)}km. ${fuelData.emissions.toFixed(1)}kg CO‚ÇÇ emitted. Calculated with The Most Useful Site!`;
  
  if (navigator.share) {
    navigator.share({
      title: 'Fuel Cost Analysis',
      text: shareText,
      url: window.location.href
    }).catch(console.error);
  } else {
    navigator.clipboard.writeText(shareText).then(() => {
      fuelShowMessage('‚úÖ Results copied to share!', '#39ff14', 3000);
    });
  }
}

// Helper function to show messages
function fuelShowMessage(message, color, duration = 3000) {
  const card = document.currentScript?.closest('.card') || document;
  const hint = card.querySelector('#fuel-hint');
  hint.textContent = message;
  hint.style.color = color;
  setTimeout(() => {
    if (hint.textContent === message) hint.textContent = '';
  }, duration);
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', fuelInit);
} else {
  fuelInit();
}

// Add keyboard shortcuts
document.addEventListener('keydown', function(e) {
  if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
    const calculateBtn = document.querySelector('.actions button');
    if (calculateBtn) calculateBtn.click();
  }
  if (e.key === 'Escape') {
    const resetBtn = document.querySelector('.actions button:nth-child(2)');
    if (resetBtn) resetBtn.click();
  }
});
</script>

<style>
#fuel-cost-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.3rem;
  margin-bottom: 4px;
}

.small-btn {
  background: rgba(255,255,255,0.05);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 6px;
  color: inherit;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 12px;
  padding: 4px 8px;
}

.small-btn:hover {
  background: rgba(45,212,255,0.1);
  border-color: rgba(45,212,255,0.3);
  transform: translateY(-1px);
}

details summary {
  list-style: none;
  cursor: pointer;
  user-select: none;
}

details summary::-webkit-details-marker {
  display: none;
}

details summary::after {
  content: '‚ñ∂';
  float: right;
  transition: transform 0.2s;
  color: var(--accent);
}

details[open] summary::after {
  transform: rotate(90deg);
}

/* Mobile responsiveness */
@media (max-width: 768px) {
  .field {
    grid-column: 1 / -1 !important;
  }
  
  .actions {
    flex-direction: column;
    gap: 8px !important;
  }
  
  .actions button {
    width: 100%;
    margin: 0 !important;
  }
  
  #fuel-charts-container,
  #fuel-breakdown-container,
  #fuel-savings-container {
    padding: 12px !important;
  }
  
  input, select {
    font-size: 16px !important; /* Prevents iOS zoom */
  }
  
  button {
    min-height: 44px !important; /* Touch-friendly */
  }
}

@media (max-width: 480px) {
  .fuel-section > div {
    grid-template-columns: 1fr !important;
  }
  
  #fuel-output-container > div {
    padding: 16px !important;
  }
  
  #fuel-trend-text {
    font-size: 11px !important;
  }
}

/* Print styles */
@media print {
  #fuel-results {
    display: block !important;
  }
  
  button, .actions, .small-btn {
    display: none !important;
  }
}
</style>
