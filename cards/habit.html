<h2 id="habit-tracker-title" style="margin-top:0;color:var(--accent);">ğŸ“ˆ Habit Tracker</h2>

<form aria-describedby="habit-tracker-desc">
  <p id="habit-tracker-desc" class="small" style="color:var(--muted);margin-bottom:20px;">
    Build consistent habits with visual streaks and daily tracking. 
    <span style="color:var(--accent);font-weight:500;">Save your progress automatically!</span>
  </p>

  <!-- Input Section -->
  <div style="background:rgba(255,255,255,0.03);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.06);">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px;">
      <div>
        <label for="ht-name" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Habit Name
        </label>
        <input id="ht-name" type="text" placeholder="e.g., Morning Meditation" 
               style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-size:14px;" />
      </div>
      <div>
        <label for="ht-category" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
          Category
        </label>
        <select id="ht-category" 
                style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;font-size:14px;">
          <option value="health">ğŸƒâ€â™‚ï¸ Health & Fitness</option>
          <option value="learning">ğŸ“š Learning</option>
          <option value="productivity">âš¡ Productivity</option>
          <option value="mindfulness">ğŸ§˜ Mindfulness</option>
          <option value="creative">ğŸ¨ Creative</option>
          <option value="other">ğŸ“‹ Other</option>
        </select>
      </div>
    </div>

    <div style="margin-bottom:12px;">
      <label style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Goal Frequency
      </label>
      <div style="display:flex;gap:8px;flex-wrap:wrap;">
        <button type="button" onclick="htSetFrequency('daily')" 
                style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:13px;">
          Daily
        </button>
        <button type="button" onclick="htSetFrequency('weekly')"
                style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:13px;">
          Weekly
        </button>
        <button type="button" onclick="htSetFrequency('weekdays')"
                style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:13px;">
          Weekdays
        </button>
        <button type="button" onclick="htSetFrequency('custom')"
                style="padding:8px 12px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:6px;color:inherit;cursor:pointer;font-size:13px;">
          Custom
        </button>
      </div>
    </div>

    <div>
      <label for="ht-date" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
        Log Date
      </label>
      <input id="ht-date" type="date" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;font-size:14px;" />
    </div>
  </div>

  <!-- Action Buttons -->
  <div style="display:flex;gap:10px;margin-bottom:20px;">
    <button type="button" onclick="htAddHabit(this)" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      âœ… Log Habit
    </button>
    <button type="button" onclick="htLogToday()"
            style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      Today
    </button>
  </div>
</form>

<!-- Quick Log Section -->
<div style="margin-bottom:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:8px;">Quick Log</h3>
  <div style="display:flex;gap:8px;flex-wrap:wrap;">
    <button type="button" onclick="htQuickLog('exercise')"
            style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
      ğŸ‹ï¸â€â™‚ï¸ Exercise
    </button>
    <button type="button" onclick="htQuickLog('read')"
            style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
      ğŸ“– Read 20 pages
    </button>
    <button type="button" onclick="htQuickLog('meditate')"
            style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
      ğŸ§˜ Meditate
    </button>
    <button type="button" onclick="htQuickLog('water')"
            style="padding:8px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;">
      ğŸ’§ Drink water
    </button>
  </div>
</div>

<!-- Habit Calendar -->
<div style="margin-bottom:20px;">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h3 class="small" style="color:var(--accent);margin:0;">ğŸ“… 30-Day Calendar</h3>
    <div id="ht-current-streak" style="font-size:12px;color:var(--muted);">Current streak: 0 days</div>
  </div>
  <div id="ht-calendar" style="display:grid;grid-template-columns:repeat(7, 1fr);gap:6px;padding:12px;background:rgba(0,0,0,0.2);border-radius:8px;border:1px solid rgba(255,255,255,0.1);">
    <!-- Calendar days will be generated by JavaScript -->
  </div>
</div>

<!-- Habit List -->
<div class="results" aria-live="polite">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
    <h3 class="small" style="color:var(--accent);margin:0;">ğŸ“‹ Your Habits</h3>
    <div id="ht-total-count" style="font-size:12px;color:var(--muted);">0 habits</div>
  </div>
  
  <div id="ht-habit-list" style="max-height:200px;overflow-y:auto;">
    <!-- Habits will be loaded here -->
    <div style="text-align:center;padding:20px;color:var(--muted);font-style:italic;">
      No habits tracked yet. Add your first habit above!
    </div>
  </div>
  
  <!-- Statistics -->
  <div id="ht-stats" style="display:none;margin-top:16px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.1);">
    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:var(--accent);">0</div>
        <div style="font-size:11px;color:var(--muted);">Total Days</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:#39ff14;">0</div>
        <div style="font-size:11px;color:var(--muted);">Completion %</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:#ffcc00;">0</div>
        <div style="font-size:11px;color:var(--muted);">Longest Streak</div>
      </div>
    </div>
  </div>
</div>

<!-- Action Buttons -->
<div style="display:flex;gap:10px;margin-top:20px;">
  <button type="button" onclick="htReset(this)" 
          style="flex:1;padding:12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);color:#ff4d4d;border-radius:8px;cursor:pointer;">
    ğŸ”„ Reset All
  </button>
  <button type="button" onclick="htExportData()"
          style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
    ğŸ’¾ Export
  </button>
</div>

<script>
/* habit-tracker.html
   - Enhanced habit tracker with calendar view, streaks, and statistics
   - Scoped with ht- prefix (habit tracker)
*/

// Initialize habits from localStorage
let htHabits = JSON.parse(localStorage.getItem('ht-habits')) || [];

// Update display on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    htUpdateDisplay();
    htGenerateCalendar();
    // Set default date to today
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('ht-date').value = today;
    console.log('Habit Tracker ready');
  });
} else {
  // Run immediately if already loaded
  htUpdateDisplay();
  htGenerateCalendar();
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('ht-date').value = today;
}

function htSetFrequency(freq) {
  const buttons = document.querySelectorAll('#habit-tracker-desc + form button[type="button"]');
  buttons.forEach(btn => {
    btn.style.background = 'rgba(255,255,255,0.05)';
    btn.style.borderColor = 'rgba(255,255,255,0.1)';
    btn.style.color = 'inherit';
  });
  
  const clickedBtn = event.target;
  clickedBtn.style.background = 'rgba(45,212,255,0.1)';
  clickedBtn.style.borderColor = 'rgba(45,212,255,0.3)';
  clickedBtn.style.color = 'var(--accent)';
  
  // Update frequency in a hidden field if needed
  console.log('Frequency set to:', freq);
}

function htAddHabit(btn) {
  const card = btn.closest('.card') || document;
  const name = card.querySelector('#ht-name').value.trim();
  const date = card.querySelector('#ht-date').value;
  const category = card.querySelector('#ht-category').value;
  
  if (!name || !date) {
    htShowMessage('Please enter both habit name and date', 'error');
    return;
  }
  
  const newHabit = {
    id: Date.now(),
    name: name,
    date: date,
    category: category,
    completed: true
  };
  
  htHabits.push(newHabit);
  htSaveHabits();
  htUpdateDisplay();
  
  // Clear form
  card.querySelector('#ht-name').value = '';
  htShowMessage(`"${name}" logged for ${date}!`, 'success');
}

function htLogToday() {
  const card = document.currentScript?.closest('.card') || document;
  const today = new Date().toISOString().split('T')[0];
  card.querySelector('#ht-date').value = today;
  
  // If there's a habit name, auto-submit
  const nameInput = card.querySelector('#ht-name');
  if (nameInput.value.trim()) {
    htAddHabit(nameInput);
  } else {
    htShowMessage('Date set to today. Now enter a habit name.', 'info');
  }
}

function htQuickLog(type) {
  const card = document.currentScript?.closest('.card') || document;
  const today = new Date().toISOString().split('T')[0];
  
  const habits = {
    'exercise': { name: 'Exercise', category: 'health' },
    'read': { name: 'Read 20 pages', category: 'learning' },
    'meditate': { name: 'Meditate', category: 'mindfulness' },
    'water': { name: 'Drink 8 glasses of water', category: 'health' }
  };
  
  const habit = habits[type];
  if (!habit) return;
  
  card.querySelector('#ht-name').value = habit.name;
  card.querySelector('#ht-category').value = habit.category;
  card.querySelector('#ht-date').value = today;
  
  // Auto-submit
  setTimeout(() => {
    htAddHabit(card.querySelector('button[onclick="htAddHabit(this)"]'));
  }, 100);
}

function htUpdateDisplay() {
  const card = document.currentScript?.closest('.card') || document;
  const habitList = card.querySelector('#ht-habit-list');
  const stats = card.querySelector('#ht-stats');
  const totalCount = card.querySelector('#ht-total-count');
  const currentStreak = card.querySelector('#ht-current-streak');
  
  if (htHabits.length === 0) {
    habitList.innerHTML = `
      <div style="text-align:center;padding:20px;color:var(--muted);font-style:italic;">
        No habits tracked yet. Add your first habit above!
      </div>
    `;
    stats.style.display = 'none';
    totalCount.textContent = '0 habits';
    currentStreak.textContent = 'Current streak: 0 days';
    return;
  }
  
  // Group habits by name
  const habitsByName = {};
  htHabits.forEach(habit => {
    if (!habitsByName[habit.name]) {
      habitsByName[habit.name] = {
        name: habit.name,
        category: habit.category,
        dates: [],
        total: 0
      };
    }
    habitsByName[habit.name].dates.push(habit.date);
    habitsByName[habit.name].total++;
  });
  
  // Update habit list
  let html = '';
  Object.values(habitsByName).forEach(habit => {
    const streak = htCalculateStreak(habit.dates);
    const latestDate = habit.dates.sort().reverse()[0];
    const daysAgo = htDaysBetween(new Date(latestDate), new Date());
    
    html += `
      <div style="background:rgba(255,255,255,0.03);border-radius:8px;padding:12px;margin-bottom:8px;border:1px solid rgba(255,255,255,0.05);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <div style="font-weight:500;color:var(--accent);">${habit.name}</div>
          <div style="font-size:12px;color:var(--muted);">${habit.category}</div>
        </div>
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div style="font-size:12px;color:var(--muted);">
            ${habit.total} logs â€¢ ${streak} day streak
          </div>
          <div style="font-size:11px;color:${daysAgo === 0 ? '#39ff14' : daysAgo <= 2 ? '#ffcc00' : '#ff4d4d'}">
            ${daysAgo === 0 ? 'Today' : daysAgo === 1 ? 'Yesterday' : `${daysAgo}d ago`}
          </div>
        </div>
        <div style="margin-top:8px;display:flex;gap:4px;flex-wrap:wrap;">
          ${habit.dates.slice(-5).reverse().map(date => `
            <div style="font-size:10px;padding:2px 6px;background:rgba(45,212,255,0.1);border-radius:4px;color:var(--accent);">
              ${new Date(date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}
            </div>
          `).join('')}
          ${habit.dates.length > 5 ? `<div style="font-size:10px;padding:2px 6px;background:rgba(255,255,255,0.05);border-radius:4px;color:var(--muted);">+${habit.dates.length - 5} more</div>` : ''}
        </div>
      </div>
    `;
  });
  
  habitList.innerHTML = html;
  
  // Update statistics
  const totalDays = htHabits.length;
  const longestStreak = htCalculateLongestStreak();
  const completionRate = Math.round((htHabits.length / (Object.keys(habitsByName).length * 30)) * 100) || 0;
  
  card.querySelector('#ht-stats').innerHTML = `
    <div style="display:grid;grid-template-columns:repeat(3, 1fr);gap:12px;">
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:var(--accent);">${totalDays}</div>
        <div style="font-size:11px;color:var(--muted);">Total Days</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:#39ff14;">${completionRate}%</div>
        <div style="font-size:11px;color:var(--muted);">Completion %</div>
      </div>
      <div style="text-align:center;">
        <div style="font-size:24px;font-weight:600;color:#ffcc00;">${longestStreak}</div>
        <div style="font-size:11px;color:var(--muted);">Longest Streak</div>
      </div>
    </div>
  `;
  stats.style.display = 'block';
  
  totalCount.textContent = `${Object.keys(habitsByName).length} habit${Object.keys(habitsByName).length !== 1 ? 's' : ''}`;
  
  // Update current streak (most recent habit)
  const mostRecentHabit = htHabits.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
  if (mostRecentHabit) {
    const streak = htCalculateStreak(habitsByName[mostRecentHabit.name].dates);
    currentStreak.textContent = `Current streak: ${streak} day${streak !== 1 ? 's' : ''}`;
  }
  
  // Update calendar
  htGenerateCalendar();
}

function htGenerateCalendar() {
  const calendar = document.querySelector('#ht-calendar');
  if (!calendar) return;
  
  // Generate last 30 days
  const days = [];
  const today = new Date();
  
  for (let i = 29; i >= 0; i--) {
    const date = new Date(today);
    date.setDate(date.getDate() - i);
    days.push(date.toISOString().split('T')[0]);
  }
  
  // Count habits per day
  const habitsByDate = {};
  htHabits.forEach(habit => {
    if (!habitsByDate[habit.date]) {
      habitsByDate[habit.date] = 0;
    }
    habitsByDate[habit.date]++;
  });
  
  // Generate calendar HTML
  let html = '';
  
  // Day labels
  ['S', 'M', 'T', 'W', 'T', 'F', 'S'].forEach(day => {
    html += `<div style="text-align:center;font-size:11px;color:var(--muted);padding:4px;">${day}</div>`;
  });
  
  // Calendar days
  days.forEach(date => {
    const dayNum = new Date(date).getDate();
    const isToday = date === today.toISOString().split('T')[0];
    const habitCount = habitsByDate[date] || 0;
    
    let backgroundColor = 'rgba(255,255,255,0.03)';
    let borderColor = 'transparent';
    let textColor = 'var(--muted)';
    
    if (habitCount > 0) {
      // Gradient based on number of habits
      const intensity = Math.min(0.2 + (habitCount * 0.15), 0.8);
      backgroundColor = `rgba(45,212,255,${intensity})`;
      textColor = '#ffffff';
    } else if (isToday) {
      backgroundColor = 'rgba(255,255,255,0.1)';
      borderColor = 'rgba(45,212,255,0.5)';
    }
    
    html += `
      <div style="
        aspect-ratio:1;
        display:flex;
        align-items:center;
        justify-content:center;
        border-radius:6px;
        background:${backgroundColor};
        border:1px solid ${borderColor};
        color:${textColor};
        font-size:12px;
        font-weight:${isToday ? '600' : '400'};
        position:relative;
        cursor:pointer;
        transition:all 0.2s;
      " 
      onclick="htShowDayHabits('${date}')"
      title="${date}: ${habitCount} habit${habitCount !== 1 ? 's' : ''}">
        ${dayNum}
        ${habitCount > 0 ? `<div style="position:absolute;bottom:2px;font-size:8px;">${habitCount}</div>` : ''}
      </div>
    `;
  });
  
  calendar.innerHTML = html;
}

function htShowDayHabits(date) {
  const habitsOnDate = htHabits.filter(h => h.date === date);
  
  if (habitsOnDate.length === 0) {
    htShowMessage(`No habits logged on ${date}`, 'info');
    return;
  }
  
  const habitNames = habitsOnDate.map(h => h.name).join(', ');
  htShowMessage(`${habitsOnDate.length} habit${habitsOnDate.length !== 1 ? 's' : ''} on ${date}: ${habitNames}`, 'info');
}

function htCalculateStreak(dates) {
  if (dates.length === 0) return 0;
  
  const sortedDates = [...dates].sort().reverse();
  let streak = 1;
  
  for (let i = 0; i < sortedDates.length - 1; i++) {
    const current = new Date(sortedDates[i]);
    const previous = new Date(sortedDates[i + 1]);
    
    // Check if previous day is exactly one day before current
    const expectedPrevious = new Date(current);
    expectedPrevious.setDate(expectedPrevious.getDate() - 1);
    
    if (expectedPrevious.toISOString().split('T')[0] === previous.toISOString().split('T')[0]) {
      streak++;
    } else {
      break;
    }
  }
  
  return streak;
}

function htCalculateLongestStreak() {
  if (htHabits.length === 0) return 0;
  
  // Group by habit name
  const habitsByName = {};
  htHabits.forEach(habit => {
    if (!habitsByName[habit.name]) {
      habitsByName[habit.name] = [];
    }
    habitsByName[habit.name].push(habit.date);
  });
  
  // Calculate longest streak among all habits
  let longest = 0;
  Object.values(habitsByName).forEach(dates => {
    const streak = htCalculateStreak(dates);
    if (streak > longest) longest = streak;
  });
  
  return longest;
}

function htDaysBetween(date1, date2) {
  const diffTime = Math.abs(date2 - date1);
  return Math.floor(diffTime / (1000 * 60 * 60 * 24));
}

function htShowMessage(message, type = 'info') {
  const card = document.currentScript?.closest('.card') || document;
  
  // Remove existing message
  const existingMsg = card.querySelector('.ht-message');
  if (existingMsg) existingMsg.remove();
  
  // Create message element
  const messageEl = document.createElement('div');
  messageEl.className = 'ht-message';
  messageEl.style.cssText = `
    position:fixed;
    top:20px;
    right:20px;
    padding:12px 16px;
    border-radius:8px;
    background:${type === 'error' ? 'rgba(255,77,77,0.9)' : type === 'success' ? 'rgba(57,255,20,0.9)' : 'rgba(45,212,255,0.9)'};
    color:#ffffff;
    z-index:10000;
    backdrop-filter:blur(4px);
    animation:slideIn 0.3s ease;
  `;
  
  // Add CSS animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    @keyframes fadeOut {
      from { opacity: 1; }
      to { opacity: 0; }
    }
  `;
  document.head.appendChild(style);
  
  messageEl.textContent = message;
  document.body.appendChild(messageEl);
  
  // Auto-remove after 3 seconds
  setTimeout(() => {
    messageEl.style.animation = 'fadeOut 0.3s ease';
    setTimeout(() => messageEl.remove(), 300);
  }, 3000);
}

function htSaveHabits() {
  localStorage.setItem('ht-habits', JSON.stringify(htHabits));
}

function htReset(btn) {
  if (confirm('Are you sure you want to reset all habit data? This cannot be undone.')) {
    htHabits = [];
    localStorage.removeItem('ht-habits');
    htUpdateDisplay();
    htShowMessage('All habit data has been reset', 'info');
  }
}

function htExportData() {
  if (htHabits.length === 0) {
    htShowMessage('No habit data to export', 'error');
    return;
  }
  
  const dataStr = JSON.stringify(htHabits, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `habit-tracker-${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  htShowMessage('Habit data exported successfully!', 'success');
}

// Initialize when script loads
htUpdateDisplay();
htGenerateCalendar();
</script>

<style>
#habit-tracker-title {
  color: var(--accent);
  margin-top: 0;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 8px;
}

@media (max-width: 768px) {
  #ht-calendar {
    grid-template-columns: repeat(7, 1fr) !important;
    gap: 4px !important;
  }
  
  .quick-log button {
    flex: 1;
    min-width: 0;
  }
  
  .field {
    grid-column: span 2;
  }
}
</style>
