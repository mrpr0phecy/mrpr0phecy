<!-- cards/event-reminder.html -->

<h2 id="event-reminder-title">ğŸ“… Event Reminder</h2>

<form aria-describedby="event-desc">
  <p id="event-desc" class="small">Set reminders for upcoming events with notifications, priorities, and recurrence options.</p>

  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:16px;">
    <div>
      <label for="er-name" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Event Name</label>
      <input id="er-name" type="text" placeholder="e.g. Doctor Appointment" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    </div>
    
    <div>
      <label for="er-date" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Date</label>
      <input id="er-date" type="date" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    </div>
    
    <div>
      <label for="er-time" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Time (Optional)</label>
      <input id="er-time" type="time" 
             style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;" />
    </div>
    
    <div>
      <label for="er-category" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Category</label>
      <select id="er-category" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <option value="appointment">ğŸ¥ Appointment</option>
        <option value="meeting">ğŸ‘¥ Meeting</option>
        <option value="birthday">ğŸ‚ Birthday</option>
        <option value="deadline">â° Deadline</option>
        <option value="travel">âœˆï¸ Travel</option>
        <option value="social">ğŸ‰ Social Event</option>
        <option value="work">ğŸ’¼ Work</option>
        <option value="personal">ğŸŒŸ Personal</option>
        <option value="education">ğŸ“š Education</option>
        <option value="health">ğŸŒ¿ Health</option>
      </select>
    </div>
  </div>

  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));gap:12px;margin-bottom:16px;">
    <div>
      <label for="er-priority" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Priority</label>
      <select id="er-priority" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <option value="low">ğŸ”µ Low</option>
        <option value="medium" selected>ğŸŸ¡ Medium</option>
        <option value="high">ğŸ”´ High</option>
        <option value="urgent">âš¡ Urgent</option>
      </select>
    </div>
    
    <div>
      <label for="er-reminder" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Reminder Before</label>
      <select id="er-reminder" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <option value="none">None</option>
        <option value="15min">15 minutes before</option>
        <option value="1hour" selected>1 hour before</option>
        <option value="1day">1 day before</option>
        <option value="3days">3 days before</option>
        <option value="1week">1 week before</option>
      </select>
    </div>
    
    <div>
      <label for="er-recurrence" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Recurrence</label>
      <select id="er-recurrence" 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(45,212,255,0.05);color:inherit;">
        <option value="none">None</option>
        <option value="daily">Daily</option>
        <option value="weekly">Weekly</option>
        <option value="monthly">Monthly</option>
        <option value="yearly">Yearly</option>
        <option value="weekdays">Weekdays</option>
        <option value="custom">Custom...</option>
      </select>
    </div>
  </div>

  <div style="margin-bottom:16px;">
    <label for="er-notes" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">Notes & Location</label>
    <textarea id="er-notes" rows="2" placeholder="Add details, location, or important notes..." 
              style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(45,212,255,0.3);background:rgba(255,255,255,0.05);color:inherit;resize:vertical;"></textarea>
  </div>

  <div style="margin-top:20px;display:flex;gap:10px;flex-wrap:wrap;">
    <button type="button" onclick="erAddEvent(this)" 
            style="flex:1;padding:12px;background:linear-gradient(135deg, rgba(45,212,255,0.2), rgba(45,212,255,0.1));border:1px solid rgba(45,212,255,0.4);border-radius:8px;color:var(--accent);cursor:pointer;font-weight:600;">
      â• Add Event
    </button>
    <button type="button" onclick="erResetForm(this)"
            style="padding:12px 16px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:inherit;cursor:pointer;">
      Reset Form
    </button>
    <button type="button" onclick="erClearCompleted()"
            style="padding:12px 16px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:8px;color:#39ff14;cursor:pointer;">
      Clear Completed
    </button>
    <button type="button" onclick="erExportEvents()"
            style="padding:12px 16px;background:rgba(157,78,221,0.1);border:1px solid rgba(157,78,221,0.3);border-radius:8px;color:#9d4edd;cursor:pointer;">
      Export Events
    </button>
  </div>
</form>

<div aria-live="polite" style="margin-top:20px;">
  <h3 class="small" style="color:var(--accent);margin-bottom:8px;">
    ğŸ“‹ Upcoming Events 
    <span id="er-stats" style="color:rgba(230,250,255,0.7);font-size:12px;font-weight:normal;"></span>
  </h3>
  
  <div style="margin-bottom:12px;display:flex;gap:8px;">
    <button onclick="erFilterEvents('all')" style="padding:6px 12px;background:rgba(45,212,255,0.1);border:1px solid rgba(45,212,255,0.3);border-radius:6px;color:var(--accent);cursor:pointer;font-size:12px;">All</button>
    <button onclick="erFilterEvents('today')" style="padding:6px 12px;background:rgba(57,255,20,0.1);border:1px solid rgba(57,255,20,0.3);border-radius:6px;color:#39ff14;cursor:pointer;font-size:12px;">Today</button>
    <button onclick="erFilterEvents('thisWeek')" style="padding:6px 12px;background:rgba(255,204,0,0.1);border:1px solid rgba(255,204,0,0.3);border-radius:6px;color:#ffcc00;cursor:pointer;font-size:12px;">This Week</button>
    <button onclick="erFilterEvents('highPriority')" style="padding:6px 12px;background:rgba(255,77,77,0.1);border:1px solid rgba(255,77,77,0.3);border-radius:6px;color:#ff4d4d;cursor:pointer;font-size:12px;">High Priority</button>
  </div>
  
  <div id="er-events-list" style="max-height:400px;overflow-y:auto;padding-right:8px;">
    <!-- Events will appear here -->
    <div style="padding:30px;text-align:center;color:rgba(230,250,255,0.5);font-style:italic;">
      No events scheduled. Add your first event above!
    </div>
  </div>
</div>

<div style="margin-top:20px;padding:16px;background:rgba(45,212,255,0.05);border-radius:8px;border:1px solid rgba(45,212,255,0.2);">
  <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;">ğŸ“Š Event Statistics</h4>
  
  <div style="display:grid;grid-template-columns:repeat(auto-fit, minmax(150px, 1fr));gap:12px;">
    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;">
      <div style="color:var(--accent);font-size:24px;font-weight:600;" id="er-total-events">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Total Events</div>
    </div>
    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;">
      <div style="color:#39ff14;font-size:24px;font-weight:600;" id="er-upcoming-events">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Upcoming</div>
    </div>
    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;">
      <div style="color:#ffcc00;font-size:24px;font-weight:600;" id="er-today-events">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">Today</div>
    </div>
    <div style="padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;text-align:center;">
      <div style="color:#ff6b9d;font-size:24px;font-weight:600;" id="er-high-priority">0</div>
      <div style="color:rgba(230,250,255,0.7);font-size:12px;">High Priority</div>
    </div>
  </div>
</div>

<div id="er-notification" style="position:fixed;top:20px;right:20px;padding:12px 16px;background:rgba(20,20,20,0.95);border-radius:8px;border:1px solid var(--accent);z-index:10000;display:none;box-shadow:0 4px 12px rgba(0,0,0,0.3);">
  <div style="display:flex;align-items:center;gap:8px;">
    <div style="color:var(--accent);font-size:18px;">ğŸ””</div>
    <div>
      <div style="color:var(--accent);font-weight:600;font-size:14px;">Upcoming Event!</div>
      <div id="er-notification-text" style="color:rgba(230,250,255,0.9);font-size:13px;"></div>
    </div>
    <button onclick="document.getElementById('er-notification').style.display='none'" 
            style="margin-left:12px;background:transparent;border:none;color:rgba(230,250,255,0.7);cursor:pointer;">âœ•</button>
  </div>
</div>

<script>
/* event-reminder.html
   - Event reminder and scheduling tool
   - Scoped with er- prefix
*/

// Category configurations
const eventCategories = {
  'appointment': { emoji: 'ğŸ¥', color: '#2dd4ff' },
  'meeting': { emoji: 'ğŸ‘¥', color: '#9d4edd' },
  'birthday': { emoji: 'ğŸ‚', color: '#ff6b9d' },
  'deadline': { emoji: 'â°', color: '#ff4d4d' },
  'travel': { emoji: 'âœˆï¸', color: '#39ff14' },
  'social': { emoji: 'ğŸ‰', color: '#ffcc00' },
  'work': { emoji: 'ğŸ’¼', color: '#8e44ad' },
  'personal': { emoji: 'ğŸŒŸ', color: '#ff9500' },
  'education': { emoji: 'ğŸ“š', color: '#00ff99' },
  'health': { emoji: 'ğŸŒ¿', color: '#1abc9c' }
};

// Priority configurations
const eventPriorities = {
  'low': { emoji: 'ğŸ”µ', color: '#2dd4ff', label: 'Low' },
  'medium': { emoji: 'ğŸŸ¡', color: '#ffcc00', label: 'Medium' },
  'high': { emoji: 'ğŸ”´', color: '#ff6b9d', label: 'High' },
  'urgent': { emoji: 'âš¡', color: '#ff2d55', label: 'Urgent' }
};

// Reminder options in milliseconds
const reminderOptions = {
  'none': 0,
  '15min': 15 * 60 * 1000,
  '1hour': 60 * 60 * 1000,
  '1day': 24 * 60 * 60 * 1000,
  '3days': 3 * 24 * 60 * 60 * 1000,
  '1week': 7 * 24 * 60 * 60 * 1000
};

let events = [];
const STORAGE_KEY = 'event-reminder-events';
let currentFilter = 'all';
let notificationCheckInterval;

// Load saved events
function erLoad() {
  try {
    const saved = localStorage.getItem(STORAGE_KEY);
    if (saved) {
      events = JSON.parse(saved);
      erRender();
      erUpdateStats();
      erStartNotificationChecker();
    }
  } catch (e) {
    console.error('Failed to load events:', e);
  }
}

// Save events
function erSave() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(events));
  } catch (e) {
    console.error('Failed to save events:', e);
  }
}

// Add an event
function erAddEvent(btn) {
  const card = btn.closest('.card') || document;
  const name = card.querySelector('#er-name').value.trim();
  const date = card.querySelector('#er-date').value;
  const time = card.querySelector('#er-time').value;
  const category = card.querySelector('#er-category').value;
  const priority = card.querySelector('#er-priority').value;
  const reminder = card.querySelector('#er-reminder').value;
  const recurrence = card.querySelector('#er-recurrence').value;
  const notes = card.querySelector('#er-notes').value.trim();

  if (!name || !date) {
    erShowMessage(card, 'Please enter event name and date', '#ff4d4d');
    return;
  }

  // Create datetime string
  const datetime = time ? `${date}T${time}:00` : date;
  
  const eventId = Date.now();
  const newEvent = {
    id: eventId,
    name: name,
    datetime: datetime,
    date: date,
    time: time,
    category: category,
    priority: priority,
    reminder: reminder,
    recurrence: recurrence,
    notes: notes,
    completed: false,
    created: new Date().toISOString()
  };
  
  events.push(newEvent);
  events.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
  
  erRender();
  erSave();
  erUpdateStats();
  
  // Reset form
  card.querySelector('#er-name').value = '';
  card.querySelector('#er-date').value = '';
  card.querySelector('#er-time').value = '';
  card.querySelector('#er-notes').value = '';
  card.querySelector('#er-name').focus();
  
  erShowMessage(card, `âœ… Event "${name}" added`, '#39ff14');
  
  // Schedule reminder if applicable
  erScheduleReminder(newEvent);
}

// Render events
function erRender() {
  const card = document.currentScript?.closest('.card') || document;
  const list = card.querySelector('#er-events-list');
  
  let filteredEvents = events;
  
  // Apply current filter
  switch(currentFilter) {
    case 'today':
      const today = new Date().toISOString().split('T')[0];
      filteredEvents = events.filter(e => e.date === today && !e.completed);
      break;
    case 'thisWeek':
      const todayDate = new Date();
      const weekStart = new Date(todayDate);
      weekStart.setDate(todayDate.getDate() - todayDate.getDay());
      const weekEnd = new Date(todayDate);
      weekEnd.setDate(todayDate.getDate() + (6 - todayDate.getDay()));
      filteredEvents = events.filter(e => {
        const eventDate = new Date(e.date);
        return eventDate >= weekStart && eventDate <= weekEnd && !e.completed;
      });
      break;
    case 'highPriority':
      filteredEvents = events.filter(e => (e.priority === 'high' || e.priority === 'urgent') && !e.completed);
      break;
    default:
      filteredEvents = events.filter(e => !e.completed);
  }
  
  if (filteredEvents.length === 0) {
    const messages = {
      'all': 'No upcoming events. Add your first event above!',
      'today': 'No events scheduled for today.',
      'thisWeek': 'No events scheduled for this week.',
      'highPriority': 'No high priority events.'
    };
    
    list.innerHTML = `
      <div style="padding:30px;text-align:center;color:rgba(230,250,255,0.5);font-style:italic;">
        ${messages[currentFilter] || messages.all}
      </div>
    `;
    return;
  }
  
  let html = '';
  filteredEvents.forEach(event => {
    const category = eventCategories[event.category] || eventCategories['personal'];
    const priority = eventPriorities[event.priority] || eventPriorities['medium'];
    const eventDate = new Date(event.datetime);
    const now = new Date();
    const timeDiff = eventDate - now;
    const daysUntil = Math.ceil(timeDiff / (1000 * 60 * 60 * 24));
    
    // Format date and time
    const dateStr = eventDate.toLocaleDateString('en-US', { 
      weekday: 'short', 
      month: 'short', 
      day: 'numeric' 
    });
    const timeStr = event.time ? eventDate.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit' 
    }) : 'All day';
    
    // Determine time indicator
    let timeIndicator = '';
    let indicatorColor = '';
    if (daysUntil < 0) {
      timeIndicator = 'Overdue';
      indicatorColor = '#ff4d4d';
    } else if (daysUntil === 0) {
      timeIndicator = 'Today';
      indicatorColor = '#39ff14';
    } else if (daysUntil === 1) {
      timeIndicator = 'Tomorrow';
      indicatorColor = '#ffcc00';
    } else if (daysUntil <= 7) {
      timeIndicator = `In ${daysUntil} days`;
      indicatorColor = '#2dd4ff';
    } else {
      timeIndicator = dateStr;
      indicatorColor = 'rgba(230,250,255,0.7)';
    }
    
    html += `
      <div class="event-item" data-id="${event.id}" 
           style="background:rgba(255,255,255,0.03);border-left:3px solid ${category.color};margin-bottom:12px;padding:12px;border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px;">
          <div style="flex:1;">
            <div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
              <span style="font-size:18px;">${category.emoji}</span>
              <div style="font-weight:600;color:var(--accent);">${event.name}</div>
              <span style="color:${priority.color};background:${priority.color}20;padding:2px 8px;border-radius:12px;font-size:11px;">
                ${priority.emoji} ${priority.label}
              </span>
            </div>
            <div style="display:flex;gap:12px;margin-top:4px;font-size:13px;">
              <span style="color:rgba(230,250,255,0.8);">
                ğŸ“… ${dateStr} ${event.time ? `at ${timeStr}` : ''}
              </span>
              <span style="color:${indicatorColor};">
                ${timeIndicator}
              </span>
            </div>
          </div>
          <div style="display:flex;gap:4px;">
            <button onclick="erToggleComplete('${event.id}')" style="background:transparent;border:none;color:#39ff14;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;">
              ${event.completed ? 'â†¶ Undo' : 'âœ“ Done'}
            </button>
            <button onclick="erEditEvent('${event.id}')" style="background:transparent;border:none;color:#ffcc00;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;">âœï¸ Edit</button>
            <button onclick="erDeleteEvent('${event.id}')" style="background:transparent;border:none;color:#ff4d4d;cursor:pointer;padding:4px 8px;border-radius:4px;font-size:12px;">ğŸ—‘ï¸</button>
          </div>
        </div>
        
        ${event.notes ? `
          <div style="margin-top:8px;padding:8px 12px;background:rgba(255,255,255,0.05);border-radius:6px;">
            <div style="color:rgba(230,250,255,0.8);font-size:12px;">ğŸ“ ${event.notes}</div>
          </div>
        ` : ''}
        
        <div style="margin-top:8px;display:flex;gap:8px;font-size:12px;">
          ${event.reminder !== 'none' ? `
            <span style="color:rgba(230,250,255,0.6);">â° Reminder: ${event.reminder}</span>
          ` : ''}
          ${event.recurrence !== 'none' ? `
            <span style="color:rgba(230,250,255,0.6);">ğŸ”„ ${event.recurrence}</span>
          ` : ''}
        </div>
      </div>
    `;
  });
  
  list.innerHTML = html;
}

// Filter events
function erFilterEvents(filter) {
  currentFilter = filter;
  erRender();
  
  // Update active filter button
  document.querySelectorAll('button[onclick^="erFilterEvents"]').forEach(btn => {
    const btnFilter = btn.getAttribute('onclick').match(/'([^']+)'/)[1];
    if (btnFilter === filter) {
      btn.style.background = 'rgba(45,212,255,0.2)';
      btn.style.border = '1px solid rgba(45,212,255,0.5)';
    } else {
      btn.style.background = '';
      btn.style.border = '';
    }
  });
}

// Toggle complete status
function erToggleComplete(eventId) {
  const event = events.find(e => e.id == eventId);
  if (event) {
    event.completed = !event.completed;
    erRender();
    erSave();
    erUpdateStats();
    
    const card = document.currentScript?.closest('.card') || document;
    const action = event.completed ? 'completed' : 'marked as incomplete';
    erShowMessage(card, `âœ… Event "${event.name}" ${action}`, '#39ff14');
  }
}

// Edit event
function erEditEvent(eventId) {
  const event = events.find(e => e.id == eventId);
  if (!event) return;
  
  const card = document.currentScript?.closest('.card') || document;
  card.querySelector('#er-name').value = event.name;
  card.querySelector('#er-date').value = event.date;
  card.querySelector('#er-time').value = event.time || '';
  card.querySelector('#er-category').value = event.category;
  card.querySelector('#er-priority').value = event.priority;
  card.querySelector('#er-reminder').value = event.reminder;
  card.querySelector('#er-recurrence').value = event.recurrence;
  card.querySelector('#er-notes').value = event.notes || '';
  
  // Change button to update
  const addBtn = card.querySelector('button[onclick="erAddEvent(this)"]');
  addBtn.textContent = 'ğŸ’¾ Update Event';
  addBtn.setAttribute('onclick', `erUpdateEvent('${eventId}')`);
  
  card.querySelector('#er-name').focus();
}

// Update event
function erUpdateEvent(eventId) {
  const card = document.currentScript?.closest('.card') || document;
  const name = card.querySelector('#er-name').value.trim();
  const date = card.querySelector('#er-date').value;
  const time = card.querySelector('#er-time').value;
  const category = card.querySelector('#er-category').value;
  const priority = card.querySelector('#er-priority').value;
  const reminder = card.querySelector('#er-reminder').value;
  const recurrence = card.querySelector('#er-recurrence').value;
  const notes = card.querySelector('#er-notes').value.trim();
  
  const eventIndex = events.findIndex(e => e.id == eventId);
  if (eventIndex === -1) return;
  
  const datetime = time ? `${date}T${time}:00` : date;
  
  events[eventIndex] = {
    ...events[eventIndex],
    name,
    datetime,
    date,
    time,
    category,
    priority,
    reminder,
    recurrence,
    notes
  };
  
  events.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
  
  erRender();
  erSave();
  erUpdateStats();
  
  // Reset button and form
  const addBtn = card.querySelector('button[onclick^="erUpdateEvent"]');
  addBtn.textContent = 'â• Add Event';
  addBtn.setAttribute('onclick', 'erAddEvent(this)');
  
  card.querySelector('#er-name').value = '';
  card.querySelector('#er-date').value = '';
  card.querySelector('#er-time').value = '';
  card.querySelector('#er-notes').value = '';
  
  erShowMessage(card, `âœ… Event "${name}" updated`, '#39ff14');
}

// Delete event
function erDeleteEvent(eventId) {
  if (!confirm('Are you sure you want to delete this event?')) return;
  
  events = events.filter(e => e.id != eventId);
  erRender();
  erSave();
  erUpdateStats();
  
  const card = document.currentScript?.closest('.card') || document;
  erShowMessage(card, 'âœ… Event deleted', '#39ff14');
}

// Reset form
function erResetForm(btn) {
  const card = btn.closest('.card') || document;
  card.querySelector('#er-name').value = '';
  card.querySelector('#er-date').value = '';
  card.querySelector('#er-time').value = '';
  card.querySelector('#er-notes').value = '';
  
  // Make sure button is in add mode
  const addBtn = card.querySelector('button[onclick^="erAddEvent"], button[onclick^="erUpdateEvent"]');
  if (addBtn) {
    addBtn.textContent = 'â• Add Event';
    addBtn.setAttribute('onclick', 'erAddEvent(this)');
  }
  
  card.querySelector('#er-name').focus();
}

// Clear completed events
function erClearCompleted() {
  const completedEvents = events.filter(e => e.completed);
  if (completedEvents.length === 0) {
    erShowMessage(null, 'No completed events to clear', '#ff4d4d');
    return;
  }
  
  if (confirm(`Clear ${completedEvents.length} completed events?`)) {
    events = events.filter(e => !e.completed);
    erRender();
    erSave();
    erUpdateStats();
    
    erShowMessage(null, `âœ… Cleared ${completedEvents.length} completed events`, '#39ff14');
  }
}

// Export events
function erExportEvents() {
  if (events.length === 0) {
    erShowMessage(null, 'No events to export', '#ff4d4d');
    return;
  }
  
  let csv = 'Event Name,Date,Time,Category,Priority,Reminder,Recurrence,Notes,Completed\n';
  events.forEach(event => {
    csv += `"${event.name}","${event.date}","${event.time || ''}","${event.category}","${event.priority}","${event.reminder}","${event.recurrence}","${event.notes || ''}","${event.completed}"\n`;
  });
  
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'events.csv';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
  
  erShowMessage(null, 'âœ… Events exported as CSV', '#39ff14');
}

// Update statistics
function erUpdateStats() {
  const now = new Date();
  const todayStr = now.toISOString().split('T')[0];
  
  const totalEvents = events.length;
  const upcomingEvents = events.filter(e => !e.completed).length;
  const todayEvents = events.filter(e => e.date === todayStr && !e.completed).length;
  const highPriorityEvents = events.filter(e => (e.priority === 'high' || e.priority === 'urgent') && !e.completed).length;
  
  document.getElementById('er-total-events').textContent = totalEvents;
  document.getElementById('er-upcoming-events').textContent = upcomingEvents;
  document.getElementById('er-today-events').textContent = todayEvents;
  document.getElementById('er-high-priority').textContent = highPriorityEvents;
  
  // Update stats in header
  const statsEl = document.getElementById('er-stats');
  if (statsEl) {
    statsEl.textContent = `(${upcomingEvents} upcoming, ${todayEvents} today)`;
  }
}

// Schedule reminder
function erScheduleReminder(event) {
  if (event.reminder === 'none' || event.completed) return;
  
  const eventTime = new Date(event.datetime);
  const reminderTime = eventTime - reminderOptions[event.reminder];
  const now = new Date();
  
  if (reminderTime > now) {
    setTimeout(() => {
      erShowNotification(event);
    }, reminderTime - now);
  }
}

// Show notification
function erShowNotification(event) {
  if (event.completed) return;
  
  const eventDate = new Date(event.datetime);
  const timeStr = event.time ? eventDate.toLocaleTimeString('en-US', { 
    hour: '2-digit', 
    minute: '2-digit' 
  }) : 'All day';
  
  const notification = document.getElementById('er-notification');
  const text = document.getElementById('er-notification-text');
  
  text.textContent = `${event.name} at ${timeStr}`;
  notification.style.display = 'block';
  
  // Auto-hide after 10 seconds
  setTimeout(() => {
    notification.style.display = 'none';
  }, 10000);
}

// Start notification checker
function erStartNotificationChecker() {
  if (notificationCheckInterval) {
    clearInterval(notificationCheckInterval);
  }
  
  notificationCheckInterval = setInterval(() => {
    const now = new Date();
    events.forEach(event => {
      if (!event.completed && event.reminder !== 'none') {
        const eventTime = new Date(event.datetime);
        const reminderTime = eventTime - reminderOptions[event.reminder];
        
        // Check if reminder time is within the last minute
        if (reminderTime <= now && reminderTime > now - 60000) {
          erShowNotification(event);
        }
      }
    });
  }, 60000); // Check every minute
}

function erShowMessage(card, message, color = '#2dd4ff') {
  const messageDiv = document.createElement('div');
  messageDiv.textContent = message;
  messageDiv.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(20,20,20,0.95);
    color: ${color};
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid ${color}40;
    z-index: 10000;
    font-weight: 500;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  `;
  
  document.body.appendChild(messageDiv);
  
  setTimeout(() => {
    messageDiv.style.opacity = '0';
    messageDiv.style.transform = 'translateX(20px)';
    setTimeout(() => {
      if (messageDiv.parentNode) {
        document.body.removeChild(messageDiv);
      }
    }, 300);
  }, 2000);
}

// Initialize on load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', function() {
    setTimeout(() => {
      erLoad();
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('er-date').value = today;
      // Set default time to next hour
      const nextHour = new Date();
      nextHour.setHours(nextHour.getHours() + 1);
      document.getElementById('er-time').value = nextHour.toTimeString().substring(0, 5);
    }, 100);
  });
} else {
  setTimeout(() => {
    erLoad();
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('er-date').value = today;
    const nextHour = new Date();
    nextHour.setHours(nextHour.getHours() + 1);
    document.getElementById('er-time').value = nextHour.toTimeString().substring(0, 5);
  }, 100);
}
</script>

<style>
#event-reminder-title {
  color: var(--accent);
  margin-top: 0;
  border-bottom: 1px solid rgba(45,212,255,0.2);
  padding-bottom: 10px;
  margin-bottom: 16px;
}

.event-item {
  transition: all 0.2s ease;
}

.event-item:hover {
  background: rgba(45,212,255,0.05) !important;
  transform: translateX(2px);
}

#er-events-list::-webkit-scrollbar {
  width: 6px;
}

#er-events-list::-webkit-scrollbar-track {
  background: rgba(255,255,255,0.05);
  border-radius: 3px;
}

#er-events-list::-webkit-scrollbar-thumb {
  background: rgba(45,212,255,0.3);
  border-radius: 3px;
}

@media (max-width: 768px) {
  div[style*="grid-template-columns:repeat(auto-fit"] {
    grid-template-columns: 1fr !important;
    gap: 10px !important;
  }
  
  .actions {
    flex-direction: column !important;
  }
  
  .actions button {
    width: 100% !important;
    margin-bottom: 8px;
  }
  
  .event-item > div:first-child {
    flex-direction: column !important;
    gap: 8px;
  }
  
  .event-item > div:first-child > div:last-child {
    align-self: flex-end;
  }
}
</style>
