<h2 id="tempo-map-title" style="margin-top:0;color:var(--accent);">üéµ Tempo Map & BPM Calculator</h2>

<form aria-describedby="tempo-map-desc" style="margin-bottom:20px;">
    <p id="tempo-map-desc" class="small" style="margin-bottom:20px;color:rgba(var(--text-rgb, 230,250,255),0.9);">
        Create tempo maps for musical compositions with BPM calculations and time conversions.
        <span style="color:var(--accent);">Educational tool for musicians and composers.</span>
    </p>
    
    <!-- SECTION INPUT -->
    <div class="field" style="margin-bottom:20px;">
        <label for="tempo-section" style="display:block;margin-bottom:8px;color:var(--accent);font-weight:500;">
            Section Name
        </label>
        <input id="tempo-section" type="text" placeholder="e.g., Intro, Verse, Chorus, Bridge, Outro"
               style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
        
        <!-- QUICK SECTION PRESETS -->
        <div style="display:flex;gap:8px;margin-top:12px;flex-wrap:wrap;">
            <button type="button" onclick="tempSetSection('Intro')" 
                    style="padding:6px 10px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:var(--accent);cursor:pointer;font-size:12px;">
                Intro
            </button>
            <button type="button" onclick="tempSetSection('Verse')" 
                    style="padding:6px 10px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:var(--accent);cursor:pointer;font-size:12px;">
                Verse
            </button>
            <button type="button" onclick="tempSetSection('Chorus')" 
                    style="padding:6px 10px;border-radius:6px;border:1px solid var(--accent);background:rgba(var(--accent-rgb, 45,212,255),0.15);color:var(--accent);cursor:pointer;font-weight:600;font-size:12px;">
                Chorus
            </button>
            <button type="button" onclick="tempSetSection('Bridge')" 
                    style="padding:6px 10px;border-radius:6px;border:1px solid rgba(255,204,0,0.3);background:rgba(255,204,0,0.1);color:#ffcc00;cursor:pointer;font-size:12px;">
                Bridge
            </button>
            <button type="button" onclick="tempSetSection('Outro')" 
                    style="padding:6px 10px;border-radius:6px;border:1px solid rgba(255,77,77,0.3);background:rgba(255,77,77,0.1);color:#ff4d4d;cursor:pointer;font-size:12px;">
                Outro
            </button>
        </div>
    </div>
    
    <!-- TEMPO & SETTINGS GRID -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:20px;">
        <!-- BPM INPUT -->
        <div>
            <label for="tempo-bpm" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Tempo (BPM)
            </label>
            <div style="display:flex;align-items:center;gap:8px;">
                <input id="tempo-bpm" type="number" min="20" max="300" value="120" step="1"
                       style="flex:1;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
                <div style="display:flex;gap:4px;">
                    <button type="button" onclick="tempAdjustBPM(-10)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">-10</button>
                    <button type="button" onclick="tempAdjustBPM(10)" 
                            style="width:32px;height:32px;border-radius:6px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.1);color:var(--accent);cursor:pointer;font-weight:bold;">+10</button>
                </div>
            </div>
            
            <!-- QUICK TEMPO PRESETS -->
            <div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap;">
                <button type="button" onclick="tempSetBPM(60)" 
                        style="padding:4px 8px;border-radius:4px;border:1px solid rgba(100,100,100,0.3);background:rgba(100,100,100,0.1);color:#999999;cursor:pointer;font-size:11px;">
                    Largo (60)
                </button>
                <button type="button" onclick="tempSetBPM(100)" 
                        style="padding:4px 8px;border-radius:4px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:var(--accent);cursor:pointer;font-size:11px;">
                    Andante (100)
                </button>
                <button type="button" onclick="tempSetBPM(120)" 
                        style="padding:4px 8px;border-radius:4px;border:1px solid var(--accent);background:rgba(var(--accent-rgb, 45,212,255),0.15);color:var(--accent);cursor:pointer;font-weight:600;font-size:11px;">
                    Allegro (120)
                </button>
                <button type="button" onclick="tempSetBPM(160)" 
                        style="padding:4px 8px;border-radius:4px;border:1px solid rgba(255,77,77,0.3);background:rgba(255,77,77,0.1);color:#ff4d4d;cursor:pointer;font-size:11px;">
                    Presto (160)
                </button>
            </div>
        </div>
        
        <!-- CHANGE TYPE -->
        <div>
            <label for="tempo-change" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Tempo Change
            </label>
            <select id="tempo-change" 
                    style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:15px;">
                <option value="steady" selected>Steady (no change)</option>
                <option value="accelerando">Accelerando (speed up gradually)</option>
                <option value="ritardando">Ritardando (slow down gradually)</option>
                <option value="rubato">Rubato (flexible tempo)</option>
                <option value="subito">Subito (sudden change)</option>
            </select>
        </div>
        
        <!-- MEASURES INPUT -->
        <div>
            <label for="tempo-measures" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Measures (bars)
            </label>
            <input id="tempo-measures" type="number" min="1" max="500" value="8" step="1"
                   style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:16px;" />
        </div>
        
        <!-- TIME SIGNATURE -->
        <div>
            <label for="tempo-timesig" style="display:block;margin-bottom:6px;color:var(--accent);font-weight:500;">
                Time Signature
            </label>
            <select id="tempo-timesig" 
                    style="width:100%;padding:12px;border-radius:10px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:15px;">
                <option value="4/4" selected>4/4 (Common Time)</option>
                <option value="3/4">3/4 (Waltz)</option>
                <option value="6/8">6/8 (Compound)</option>
                <option value="2/4">2/4 (March)</option>
                <option value="12/8">12/8 (Blues)</option>
            </select>
        </div>
    </div>
    
    <!-- SECTION OPTIONS -->
    <div style="background:rgba(0,0,0,0.15);border-radius:12px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);">
        <h4 style="color:var(--accent);margin-top:0;margin-bottom:12px;font-size:14px;font-weight:600;">‚öôÔ∏è Section Options</h4>
        
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;">
            <div>
                <label for="tempo-dynamic" style="display:block;margin-bottom:6px;color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                    Dynamic Marking
                </label>
                <select id="tempo-dynamic" 
                        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:14px;">
                    <option value="mf" selected>mf (Mezzo Forte)</option>
                    <option value="p">p (Piano)</option>
                    <option value="mp">mp (Mezzo Piano)</option>
                    <option value="f">f (Forte)</option>
                    <option value="ff">ff (Fortissimo)</option>
                    <option value="pp">pp (Pianissimo)</option>
                </select>
            </div>
            
            <div>
                <label for="tempo-articulation" style="display:block;margin-bottom:6px;color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                    Articulation
                </label>
                <select id="tempo-articulation" 
                        style="width:100%;padding:10px;border-radius:8px;border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);background:rgba(var(--accent-rgb, 45,212,255),0.05);color:inherit;font-size:14px;">
                    <option value="legato" selected>Legato</option>
                    <option value="staccato">Staccato</option>
                    <option value="marcato">Marcato</option>
                    <option value="tenuto">Tenuto</option>
                </select>
            </div>
        </div>
    </div>
    
    <!-- ACTION BUTTONS -->
    <div class="actions" style="margin-top:24px;display:flex;gap:10px;">
        <button type="button" onclick="tempAddSection(this)" 
                style="flex:1;padding:14px;background:linear-gradient(135deg, rgba(255,77,255,0.2), rgba(255,77,255,0.1));border:1px solid rgba(255,77,255,0.4);border-radius:10px;color:#ff4dff;cursor:pointer;font-weight:600;font-size:15px;">
            üéµ Add Section to Map
        </button>
        <button type="button" onclick="tempReset(this)"
                style="padding:14px 20px;background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:inherit;cursor:pointer;">
            Reset All
        </button>
        <button type="button" onclick="tempGenerateScore(this)"
                style="padding:14px 20px;background:linear-gradient(135deg, rgba(var(--accent-rgb, 45,212,255),0.1), rgba(var(--accent-rgb, 45,212,255),0.05));border:1px solid rgba(var(--accent-rgb, 45,212,255),0.3);border-radius:10px;color:var(--accent);cursor:pointer;">
            Generate Score
        </button>
    </div>
</form>

<!-- RESULTS SECTION -->
<div class="results" aria-live="polite" style="margin-top:20px;">
    <h3 class="small" style="color:var(--accent);margin-bottom:16px;font-weight:600;">üìù Tempo Map & Calculations</h3>
    
    <!-- MAIN OUTPUT -->
    <div id="temp-main-output" style="background:linear-gradient(135deg, rgba(255,77,255,0.1), rgba(255,77,255,0.05));border:2px solid rgba(255,77,255,0.3);border-radius:12px;padding:16px;margin-bottom:20px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
            <h4 style="margin:0;color:#ff4dff;font-size:14px;font-weight:600;">üéº Complete Tempo Map</h4>
            <button onclick="tempCopyMap(this)" 
                    style="padding:6px 12px;border-radius:6px;border:1px solid rgba(255,77,255,0.3);background:rgba(255,77,255,0.1);color:#ff4dff;cursor:pointer;font-size:12px;">
                üìã Copy Map
            </button>
        </div>
        <textarea id="temp-output" rows="6" 
                  style="width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,77,255,0.2);background:rgba(0,0,0,0.3);color:inherit;font-family:monospace;font-size:14px;resize:vertical;"></textarea>
    </div>
    
    <!-- CALCULATIONS GRID -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:20px;">
        <div style="background:linear-gradient(135deg, rgba(var(--accent-rgb, 45,212,255),0.08), rgba(var(--accent-rgb, 45,212,255),0.04));border:1px solid rgba(var(--accent-rgb, 45,212,255),0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(var(--accent-rgb, 45,212,255),0.9);margin-bottom:4px;">Beat Duration</div>
            <div id="temp-beat-duration" style="font-size:20px;font-weight:600;color:var(--accent);">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);">Seconds per beat</div>
        </div>
        
        <div style="background:linear-gradient(135deg, rgba(255,204,0,0.08), rgba(255,204,0,0.04));border:1px solid rgba(255,204,0,0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(255,204,0,0.9);margin-bottom:4px;">Section Duration</div>
            <div id="temp-section-duration" style="font-size:20px;font-weight:600;color:#ffcc00;">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);">Seconds for section</div>
        </div>
        
        <div style="background:linear-gradient(135deg, rgba(57,255,20,0.08), rgba(57,255,20,0.04));border:1px solid rgba(57,255,20,0.2);border-radius:10px;padding:12px;">
            <div style="font-size:12px;color:rgba(57,255,20,0.9);margin-bottom:4px;">Total Duration</div>
            <div id="temp-total-duration" style="font-size:20px;font-weight:600;color:#39ff14;">--</div>
            <div style="font-size:11px;color:rgba(255,255,255,0.6);">All sections combined</div>
        </div>
    </div>
    
    <!-- VISUAL TIMELINE -->
    <div style="background:rgba(0,0,0,0.2);border-radius:10px;padding:16px;margin-bottom:20px;border:1px solid rgba(255,255,255,0.05);">
        <h4 style="color:var(--accent);margin:0 0 12px 0;font-size:14px;font-weight:600;">üìä Tempo Timeline</h4>
        <div id="temp-timeline" style="height:60px;background:rgba(255,255,255,0.05);border-radius:8px;overflow:hidden;position:relative;">
            <!-- Timeline segments will be added here -->
            <div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);">
                Add sections to see timeline
            </div>
        </div>
    </div>
</div>

<!-- MUSICAL TERMS REFERENCE -->
<details style="margin-top:20px;border:1px solid rgba(255,255,255,0.1);border-radius:10px;padding:12px;background:rgba(0,0,0,0.15);">
    <summary style="color:var(--accent);font-weight:600;cursor:pointer;outline:none;user-select:none;">üéì Musical Terms Reference</summary>
    <div style="margin-top:12px;padding-top:12px;border-top:1px solid rgba(255,255,255,0.05);">
        
        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:16px;margin-bottom:16px;">
            <div>
                <div style="color:#ff4dff;font-weight:600;margin-bottom:4px;">Tempo Terms</div>
                <div style="color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.5;">
                    ‚Ä¢ <strong>Largo</strong>: Very slow (40-60 BPM)<br>
                    ‚Ä¢ <strong>Adagio</strong>: Slow (66-76 BPM)<br>
                    ‚Ä¢ <strong>Andante</strong>: Walking pace (76-108 BPM)<br>
                    ‚Ä¢ <strong>Allegro</strong>: Fast (120-168 BPM)<br>
                    ‚Ä¢ <strong>Presto</strong>: Very fast (168-200 BPM)
                </div>
            </div>
            <div>
                <div style="color:#ffcc00;font-weight:600;margin-bottom:4px;">Change Terms</div>
                <div style="color:rgba(var(--text-rgb, 230,250,255),0.8);font-size:13px;line-height:1.5;">
                    ‚Ä¢ <strong>Accelerando</strong>: Gradually faster<br>
                    ‚Ä¢ <strong>Ritardando</strong>: Gradually slower<br>
                    ‚Ä¢ <strong>Rubato</strong>: Flexible/expressive time<br>
                    ‚Ä¢ <strong>Subito</strong>: Sudden change<br>
                    ‚Ä¢ <strong>A tempo</strong>: Return to original tempo
                </div>
            </div>
        </div>
        
        <div style="background:rgba(var(--accent-rgb, 45,212,255),0.05);border-radius:8px;padding:12px;border-left:3px solid var(--accent);">
            <strong style="color:var(--accent);">Duration Calculations:</strong><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                ‚Ä¢ <strong>Beat Duration</strong> = 60 √∑ BPM (seconds)<br>
                ‚Ä¢ <strong>Section Duration</strong> = (Measures √ó Beats per measure) √ó Beat Duration<br>
                ‚Ä¢ <strong>Total Duration</strong> = Sum of all section durations
            </span>
        </div>
        
        <div style="background:rgba(255,77,255,0.05);border-radius:8px;padding:12px;margin-top:12px;border-left:3px solid #ff4dff;">
            <strong style="color:#ff4dff;">Dynamic Markings (Loudness):</strong><br>
            <span style="color:rgba(var(--text-rgb, 230,250,255),0.9);font-size:13px;">
                ‚Ä¢ <strong>pp</strong> (Pianissimo): Very soft<br>
                ‚Ä¢ <strong>p</strong> (Piano): Soft<br>
                ‚Ä¢ <strong>mp</strong> (Mezzo Piano): Moderately soft<br>
                ‚Ä¢ <strong>mf</strong> (Mezzo Forte): Moderately loud<br>
                ‚Ä¢ <strong>f</strong> (Forte): Loud<br>
                ‚Ä¢ <strong>ff</strong> (Fortissimo): Very loud
            </span>
        </div>
        
        <p style="color:rgba(var(--text-rgb, 230,250,255),0.7);font-size:13px;line-height:1.5;margin-top:12px;">
            <span style="color:#ffcc00;">‚ö†Ô∏è Educational Note:</span> This tool provides tempo calculations and planning assistance. 
            Actual musical performance requires artistic interpretation and should be guided by a qualified teacher or conductor.
            Use this as a starting point for composition and analysis.
        </p>
    </div>
</details>

<!-- SCRIPT -->
<script>
/* tempo-map.html - Tempo Map Planner for Musicians
   - Prefix: temp (since "tempo" might conflict)
   - Creates tempo maps with BPM calculations and duration estimates
   - Educational tool for composers and musicians
*/

let tempSections = [];
let tempCurrentId = 1;
let tempTotalDuration = 0;

// Set quick section
function tempSetSection(name) {
    const card = document.currentScript?.closest('.card') || document;
    const sectionInput = card.querySelector('#tempo-section');
    sectionInput.value = name;
    sectionInput.focus();
}

// Adjust BPM
function tempAdjustBPM(delta) {
    const card = document.currentScript?.closest('.card') || document;
    const bpmInput = card.querySelector('#tempo-bpm');
    let bpm = parseInt(bpmInput.value) || 120;
    bpm = Math.max(20, Math.min(300, bpm + delta));
    bpmInput.value = bpm;
    tempUpdateCalculations();
}

// Set BPM with preset
function tempSetBPM(bpm) {
    const card = document.currentScript?.closest('.card') || document;
    const bpmInput = card.querySelector('#tempo-bpm');
    bpmInput.value = bpm;
    tempUpdateCalculations();
}

// Calculate beat duration
function tempCalculateBeatDuration(bpm) {
    if (bpm <= 0) return 0;
    return 60 / bpm; // seconds per beat
}

// Calculate section duration
function tempCalculateSectionDuration(bpm, measures, timeSignature) {
    if (bpm <= 0 || measures <= 0) return 0;
    
    const [beatsPerMeasure, beatUnit] = timeSignature.split('/').map(Number);
    const beatDuration = tempCalculateBeatDuration(bpm);
    return measures * beatsPerMeasure * beatDuration;
}

// Update real-time calculations
function tempUpdateCalculations() {
    const card = document.currentScript?.closest('.card') || document;
    
    try {
        const bpm = parseInt(card.querySelector('#tempo-bpm').value) || 120;
        const measures = parseInt(card.querySelector('#tempo-measures').value) || 8;
        const timeSignature = card.querySelector('#tempo-timesig').value;
        
        // Calculate beat duration
        const beatDuration = tempCalculateBeatDuration(bpm);
        card.querySelector('#temp-beat-duration').textContent = beatDuration.toFixed(3) + 's';
        
        // Calculate section duration
        const sectionDuration = tempCalculateSectionDuration(bpm, measures, timeSignature);
        card.querySelector('#temp-section-duration').textContent = sectionDuration.toFixed(1) + 's';
        
        // Format for display
        const minutes = Math.floor(sectionDuration / 60);
        const seconds = Math.floor(sectionDuration % 60);
        if (minutes > 0) {
            card.querySelector('#temp-section-duration').textContent += ` (${minutes}:${seconds.toString().padStart(2, '0')})`;
        }
        
    } catch (error) {
        console.error('Calculation error:', error);
    }
}

// Add section to tempo map
function tempAddSection(btn) {
    const card = btn.closest('.card') || document;
    
    try {
        const sectionName = card.querySelector('#tempo-section').value.trim();
        const bpm = parseInt(card.querySelector('#tempo-bpm').value) || 0;
        const changeType = card.querySelector('#tempo-change').value;
        const measures = parseInt(card.querySelector('#tempo-measures').value) || 0;
        const timeSignature = card.querySelector('#tempo-timesig').value;
        const dynamic = card.querySelector('#tempo-dynamic').value;
        const articulation = card.querySelector('#tempo-articulation').value;
        
        // Validation
        if (!sectionName) {
            throw new Error('Please enter a section name');
        }
        
        if (bpm < 20 || bpm > 300) {
            throw new Error('BPM must be between 20 and 300');
        }
        
        if (measures < 1 || measures > 500) {
            throw new Error('Measures must be between 1 and 500');
        }
        
        // Calculate durations
        const beatDuration = tempCalculateBeatDuration(bpm);
        const sectionDuration = tempCalculateSectionDuration(bpm, measures, timeSignature);
        
        // Create section object
        const section = {
            id: tempCurrentId++,
            name: sectionName,
            bpm: bpm,
            changeType: changeType,
            measures: measures,
            timeSignature: timeSignature,
            dynamic: dynamic,
            articulation: articulation,
            beatDuration: beatDuration,
            duration: sectionDuration,
            timestamp: new Date().toISOString()
        };
        
        tempSections.push(section);
        tempTotalDuration += sectionDuration;
        
        // Update displays
        tempUpdateMapDisplay();
        tempUpdateTimeline();
        tempUpdateTotalDuration();
        
        // Reset inputs (keep BPM and settings for next section)
        card.querySelector('#tempo-section').value = '';
        card.querySelector('#tempo-section').focus();
        
        // Show success feedback
        const output = card.querySelector('#temp-output');
        const feedback = `‚úì Added "${sectionName}" (${bpm} BPM, ${measures} bars)\n`;
        output.value += feedback;
        
        // Scroll to bottom of textarea
        output.scrollTop = output.scrollHeight;
        
        console.log(`Tempo section added: "${sectionName}" at ${bpm} BPM`);
        
    } catch (error) {
        alert('Error: ' + error.message);
        console.error('Add section error:', error);
    }
}

// Update tempo map display
function tempUpdateMapDisplay() {
    const card = document.currentScript?.closest('.card') || document;
    const output = card.querySelector('#temp-output');
    
    if (tempSections.length === 0) {
        output.value = "üéµ Tempo Map üéµ\n" +
                      "================\n" +
                      "No sections added yet.\n" +
                      "Add sections to build your tempo map.\n\n" +
                      "‚ö†Ô∏è Educational tool - verify with teacher";
        return;
    }
    
    let mapText = "üéµ COMPLETE TEMPO MAP üéµ\n";
    mapText += "=".repeat(30) + "\n\n";
    
    let totalMeasures = 0;
    let totalTime = 0;
    
    tempSections.forEach((section, index) => {
        const durationFormatted = section.duration >= 60 ? 
            `${Math.floor(section.duration / 60)}:${Math.floor(section.duration % 60).toString().padStart(2, '0')}` :
            `${section.duration.toFixed(1)}s`;
        
        mapText += `[${index + 1}] ${section.name}\n`;
        mapText += `  BPM: ${section.bpm} (${tempGetTempoLabel(section.bpm)})\n`;
        mapText += `  Time: ${section.timeSignature}, Bars: ${section.measures}\n`;
        mapText += `  Duration: ${durationFormatted} (Beat: ${section.beatDuration.toFixed(3)}s)\n`;
        mapText += `  Change: ${tempGetChangeLabel(section.changeType)}\n`;
        mapText += `  Dynamics: ${section.dynamic.toUpperCase()}, Articulation: ${section.articulation}\n`;
        
        if (index < tempSections.length - 1) {
            const nextSection = tempSections[index + 1];
            const bpmChange = nextSection.bpm - section.bpm;
            if (bpmChange !== 0) {
                mapText += `  ‚Üí Next: ${bpmChange > 0 ? '‚Üë' : '‚Üì'} ${Math.abs(bpmChange)} BPM change\n`;
            }
        }
        
        mapText += "\n";
        
        totalMeasures += section.measures;
        totalTime += section.duration;
    });
    
    mapText += "=".repeat(30) + "\n";
    mapText += `TOTAL: ${tempSections.length} sections, ${totalMeasures} bars\n`;
    mapText += `TIME: ${Math.floor(totalTime / 60)}:${Math.floor(totalTime % 60).toString().padStart(2, '0')}\n\n`;
    mapText += "‚ö†Ô∏è Educational tool - verify tempo map with teacher or conductor";
    
    output.value = mapText;
}

// Get tempo label from BPM
function tempGetTempoLabel(bpm) {
    if (bpm < 40) return "Grave";
    if (bpm < 60) return "Largo";
    if (bpm < 66) return "Lento";
    if (bpm < 76) return "Adagio";
    if (bpm < 108) return "Andante";
    if (bpm < 120) return "Moderato";
    if (bpm < 168) return "Allegro";
    if (bpm < 200) return "Presto";
    return "Prestissimo";
}

// Get change type label
function tempGetChangeLabel(changeType) {
    const labels = {
        'steady': 'Steady tempo',
        'accelerando': 'Accelerando (speed up)',
        'ritardando': 'Ritardando (slow down)',
        'rubato': 'Rubato (flexible)',
        'subito': 'Subito (sudden change)'
    };
    return labels[changeType] || changeType;
}

// Update timeline visualization
function tempUpdateTimeline() {
    const card = document.currentScript?.closest('.card') || document;
    const timeline = card.querySelector('#temp-timeline');
    
    if (tempSections.length === 0) {
        timeline.innerHTML = '<div style="position:absolute;top:0;left:0;width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:rgba(255,255,255,0.3);">Add sections to see timeline</div>';
        return;
    }
    
    let html = '';
    let left = 0;
    
    tempSections.forEach((section, index) => {
        const width = (section.duration / tempTotalDuration) * 100;
        const color = section.bpm < 80 ? '#ff4d4d' : 
                     section.bpm < 120 ? '#ffcc00' : 
                     section.bpm < 160 ? '#39ff14' : '#ff4dff';
        
        html += `
            <div style="position:absolute;left:${left}%;width:${width}%;height:100%;background:${color};opacity:0.7;border-right:1px solid rgba(255,255,255,0.3);">
                <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:white;font-size:11px;font-weight:600;text-shadow:1px 1px 2px rgba(0,0,0,0.5);text-align:center;white-space:nowrap;">
                    ${section.name}<br>${section.bpm}
                </div>
            </div>
        `;
        left += width;
    });
    
    timeline.innerHTML = html;
}

// Update total duration display
function tempUpdateTotalDuration() {
    const card = document.currentScript?.closest('.card') || document;
    const totalDurationElement = card.querySelector('#temp-total-duration');
    
    if (tempTotalDuration === 0) {
        totalDurationElement.textContent = '--';
        return;
    }
    
    const minutes = Math.floor(tempTotalDuration / 60);
    const seconds = Math.floor(tempTotalDuration % 60);
    totalDurationElement.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
}

// Copy tempo map to clipboard
function tempCopyMap(btn) {
    const card = btn.closest('.card') || document;
    const output = card.querySelector('#temp-output');
    
    if (!output.value.trim()) {
        alert('No tempo map to copy');
        return;
    }
    
    navigator.clipboard.writeText(output.value).then(() => {
        const originalText = btn.textContent;
        btn.textContent = '‚úì Copied!';
        btn.style.background = 'rgba(57,255,20,0.2)';
        btn.style.borderColor = 'rgba(57,255,20,0.4)';
        btn.style.color = '#39ff14';
        
        setTimeout(() => {
            btn.textContent = originalText;
            btn.style.background = 'rgba(255,77,255,0.1)';
            btn.style.borderColor = 'rgba(255,77,255,0.3)';
            btn.style.color = '#ff4dff';
        }, 2000);
        
        console.log('Tempo map copied to clipboard');
    }).catch(err => {
        console.error('Copy failed:', err);
        alert('Copy failed. Please select and copy manually.');
    });
}

// Generate score preview
function tempGenerateScore(btn) {
    const card = btn.closest('.card') || document;
    const output = card.querySelector('#temp-output');
    
    if (tempSections.length === 0) {
        alert('Add sections first to generate a score preview');
        return;
    }
    
    // Add score header to output
    let scoreText = "\n\nüéº SCORE PREVIEW üéº\n";
    scoreText += "=".repeat(30) + "\n";
    scoreText += "Instrumentation: [Specify instruments]\n";
    scoreText += "Composer: [Your Name]\n";
    scoreText += "Date: " + new Date().toLocaleDateString() + "\n\n";
    
    tempSections.forEach((section, index) => {
        scoreText += `${index + 1}. ${section.name} | ‚ô© = ${section.bpm}\n`;
        scoreText += `   ${section.timeSignature} | ${section.dynamic.toUpperCase()} | ${section.articulation}\n`;
        scoreText += `   ${section.changeType === 'steady' ? '' : section.changeType + ' '}(${section.measures} bars)\n`;
        scoreText += "\n";
    });
    
    scoreText += "[Add musical notation here]\n";
    scoreText += "=".repeat(30) + "\n";
    
    output.value += scoreText;
    output.scrollTop = output.scrollHeight;
    
    // Visual feedback
    const originalText = btn.textContent;
    btn.textContent = '‚úì Generated!';
    setTimeout(() => {
        btn.textContent = originalText;
    }, 1500);
}

// Reset everything
function tempReset(btn) {
    if (tempSections.length > 0 && !confirm('Reset will delete all sections. Continue?')) {
        return;
    }
    
    const card = btn.closest('.card') || document;
    
    // Reset inputs
    card.querySelector('#tempo-section').value = '';
    card.querySelector('#tempo-bpm').value = 120;
    card.querySelector('#tempo-change').value = 'steady';
    card.querySelector('#tempo-measures').value = 8;
    card.querySelector('#tempo-timesig').value = '4/4';
    card.querySelector('#tempo-dynamic').value = 'mf';
    card.querySelector('#tempo-articulation').value = 'legato';
    
    // Reset data
    tempSections = [];
    tempCurrentId = 1;
    tempTotalDuration = 0;
    
    // Reset displays
    tempUpdateMapDisplay();
    tempUpdateTimeline();
    tempUpdateTotalDuration();
    tempUpdateCalculations();
    
    console.log('Tempo Map reset');
}

// Initialize on load
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
        const card = document.currentScript?.closest('.card') || document;
        
        // Set up auto-calculation on input changes
        const inputs = card.querySelectorAll('#tempo-bpm, #tempo-measures, #tempo-timesig');
        inputs.forEach(input => {
            input.addEventListener('input', tempUpdateCalculations);
        });
        
        // Initial display
        tempUpdateMapDisplay();
        tempUpdateCalculations();
        
        console.log('Tempo Map Planner initialized');
    });
} else {
    // Run immediately if already loaded
    tempUpdateCalculations();
}
</script>

<!-- CARD-SPECIFIC STYLES -->
<style>
/* Input focus effects */
#tempo-section:focus, #tempo-bpm:focus, select:focus {
    outline: none;
    border-color: var(--accent) !important;
    box-shadow: 0 0 0 2px rgba(var(--accent-rgb, 45,212,255),0.2);
    transition: all 0.2s ease;
}

/* Textarea styling */
#temp-output {
    font-family: 'Courier New', monospace;
    line-height: 1.4;
    transition: all 0.3s ease;
}

#temp-output:focus {
    border-color: #ff4dff !important;
    box-shadow: 0 0 0 2px rgba(255,77,255,0.2);
}

/* Timeline animation */
#temp-timeline div {
    transition: all 0.5s ease;
}

/* Button hover effects */
button[onclick*="tempSetSection"]:hover,
button[onclick*="tempSetBPM"]:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.2s ease;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
    #tempo-map-title {
        font-size: 1.3rem !important;
    }
    
    .actions {
        flex-direction: column;
    }
    
    .actions button {
        width: 100%;
        margin: 4px 0 !important;
    }
    
    /* Stack grids on mobile */
    form > div:nth-child(3) {
        grid-template-columns: 1fr !important;
        gap: 12px !important;
    }
    
    /* Stack options grid */
    div[style*="grid-template-columns:repeat(2,1fr)"] {
        grid-template-columns: 1fr !important;
    }
    
    /* Stack calculations grid */
    .results > div[style*="grid-template-columns:repeat(3,1fr)"] {
        grid-template-columns: 1fr 1fr !important;
    }
}

/* Small screen adjustments */
@media (max-width: 480px) {
    .results > div[style*="grid-template-columns:repeat(3,1fr)"] {
        grid-template-columns: 1fr !important;
    }
    
    #tempo-map-title {
        font-size: 1.1rem !important;
    }
    
    /* Adjust quick preset buttons */
    .field > div[style*="display:flex;gap:8px;margin-top:12px;"] {
        justify-content: center;
    }
    
    button[style*="padding:6px 10px;"] {
        padding: 4px 6px !important;
        font-size: 10px !important;
    }
}
</style>
