<!-- 
===========================================
FILE: cards/student-loan-calculator.html
DESCRIPTION: Calculate student loan payments, interest, and repayment timeline
FOLLOWS: Sacred Tool Template & Design Canon
STATUS: Perfected
===========================================
-->

<!-- ===== 1. TITLE & DESCRIPTION (Required per Sacred Template) ===== -->
<h2 id="tt-title">üí∞ Student Loan Calculator</h2>
<p id="tt-desc" class="small">
    Calculate student loan payments, total interest, and repayment timeline. 
    Compare different repayment plans and see how extra payments can save you money.
    <em>This site is supported by 
        <a href="#contributionsPanel" onclick="showContributionsPanel()">
            user contributions
        </a>.
    </em>
</p>

<!-- ===== 2. INPUT INTERFACE (Minimal, intuitive) ===== -->
<form id="tt-form" aria-labelledby="tt-title" style="margin-bottom: var(--space-major);">

    <!-- Important Notice -->
    <div style="background: rgba(255, 152, 0, 0.1); border-left: 3px solid #ff9800; padding: var(--space-minor); margin-bottom: var(--space-major); border-radius: var(--radius-sm);">
        <div style="display: flex; align-items: flex-start; gap: var(--space-micro);">
            <span style="color: #ff9800; font-size: 16px;">‚ö†Ô∏è</span>
            <div style="flex: 1;">
                <div style="font-size: var(--text-sm); font-weight: var(--weight-semibold); color: #ff9800;">
                    Important Notice
                </div>
                <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: 2px;">
                    This is an estimation tool. Consult with a financial advisor for specific advice.
                </div>
            </div>
        </div>
    </div>

    <!-- Loan Amount with Currency -->
    <div class="form-group" style="margin-bottom: var(--space-major);">
        <label for="tt-loan-amount" style="display: block; margin-bottom: var(--space-micro);">
            <span style="font-size: var(--text-sm); font-weight: var(--weight-medium); color: var(--text);">
                Loan Amount
            </span>
            <span style="display: block; font-size: var(--text-xs); color: var(--text-secondary);">
                Total amount borrowed
            </span>
        </label>
        
        <div style="display: grid; grid-template-columns: auto 1fr; gap: var(--space-minor);">
            <select 
                id="tt-currency"
                class="glass glass-md"
                style="
                    width: 100px;
                    height: 44px;
                    padding: 0 var(--space-minor);
                    border: 2px solid var(--border);
                    border-radius: var(--radius-md);
                    background: var(--bg-glass);
                    color: var(--text);
                    font-family: var(--font-primary);
                    font-size: var(--text-base);
                    appearance: none;
                    background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236a8ab3" viewBox="0 0 16 16"><path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>');
                    background-repeat: no-repeat;
                    background-position: right var(--space-minor) center;
                    background-size: 12px;
                    padding-right: calc(var(--space-minor) + 12px);
                "
                onchange="ttUpdateCurrency()"
            >
                <option value="GBP">¬£ GBP</option>
                <option value="USD">$ USD</option>
                <option value="EUR">‚Ç¨ EUR</option>
                <option value="CAD">$ CAD</option>
                <option value="AUD">$ AUD</option>
            </select>
            
            <input 
                type="number" 
                id="tt-loan-amount"
                class="glass glass-md"
                value="20000"
                min="0"
                step="1000"
                style="
                    width: 100%;
                    height: 44px;
                    padding: 0 var(--space-minor);
                    border: 2px solid var(--border);
                    border-radius: var(--radius-md);
                    background: var(--bg-glass);
                    color: var(--text);
                    font-family: var(--font-primary);
                    font-size: var(--text-base);
                    font-weight: var(--weight-semibold);
                    text-align: center;
                    transition: var(--transition-base);
                "
                oninput="ttUpdate()"
                aria-label="Loan amount"
            >
        </div>
        
        <!-- Amount Visualization -->
        <div style="margin-top: var(--space-micro);">
            <div style="display: flex; justify-content: space-between; font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 4px;">
                <span id="tt-currency-zero">¬£0</span>
                <span id="tt-amount-display">¬£20,000</span>
                <span id="tt-amount-max">¬£100,000</span>
            </div>
            <div style="height: 6px; background: var(--bg-glass); border-radius: 3px; overflow: hidden;">
                <div id="tt-amount-bar" style="height: 100%; background: linear-gradient(90deg, #2196f3, #64b5f6); width: 20%; transition: width 0.5s var(--ease-cubic);"></div>
            </div>
        </div>
    </div>

    <!-- Interest Rate & Term Grid -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-minor); margin-bottom: var(--space-major);">
        <div>
            <label for="tt-interest-rate" style="display: block; margin-bottom: var(--space-micro);">
                <span style="font-size: var(--text-sm); font-weight: var(--weight-medium); color: var(--text);">
                    Interest Rate
                </span>
                <span style="display: block; font-size: var(--text-xs); color: var(--text-secondary);">
                    Annual percentage rate
                </span>
            </label>
            
            <div style="position: relative;">
                <input 
                    type="number" 
                    id="tt-interest-rate"
                    class="glass glass-md"
                    value="5.5"
                    min="0"
                    max="20"
                    step="0.01"
                    style="
                        width: 100%;
                        height: 44px;
                        padding: 0 var(--space-minor);
                        border: 2px solid var(--border);
                        border-radius: var(--radius-md);
                        background: var(--bg-glass);
                        color: var(--text);
                        font-family: var(--font-primary);
                        font-size: var(--text-base);
                        font-weight: var(--weight-semibold);
                        text-align: center;
                        transition: var(--transition-base);
                        padding-right: 40px;
                    "
                    oninput="ttUpdate()"
                    aria-label="Annual interest rate percentage"
                >
                <span style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);">%</span>
            </div>
            
            <div style="margin-top: var(--space-micro);">
                <div style="font-size: var(--text-xs); color: var(--text-secondary);">
                    UK Plan 2: 5.5% ¬∑ US Federal: 4.99-7.54%
                </div>
            </div>
        </div>
        
        <div>
            <label for="tt-repayment-term" style="display: block; margin-bottom: var(--space-micro);">
                <span style="font-size: var(--text-sm); font-weight: var(--weight-medium); color: var(--text);">
                    Repayment Term
                </span>
                <span style="display: block; font-size: var(--text-xs); color: var(--text-secondary);">
                    Years to repay
                </span>
            </label>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: var(--space-micro);">
                <input 
                    type="number" 
                    id="tt-repayment-term"
                    class="glass glass-md"
                    value="10"
                    min="1"
                    max="40"
                    style="
                        width: 100%;
                        height: 44px;
                        padding: 0 var(--space-minor);
                        border: 2px solid var(--border);
                        border-radius: var(--radius-md);
                        background: var(--bg-glass);
                        color: var(--text);
                        font-family: var(--font-primary);
                        font-size: var(--text-base);
                        font-weight: var(--weight-semibold);
                        text-align: center;
                        transition: var(--transition-base);
                    "
                    oninput="ttUpdate()"
                    aria-label="Repayment term in years"
                >
                <div style="display: flex; align-items: center; padding: 0 8px; color: var(--text-tertiary); font-size: var(--text-sm);">
                    years
                </div>
            </div>
            
            <div style="margin-top: var(--space-micro);">
                <div style="font-size: var(--text-xs); color: var(--text-secondary);">
                    Standard: 10 years ¬∑ Extended: 20-25 years
                </div>
            </div>
        </div>
    </div>

    <!-- Repayment Plan -->
    <div class="form-group" style="margin-bottom: var(--space-major);">
        <label for="tt-repayment-plan" style="display: block; margin-bottom: var(--space-micro);">
            <span style="font-size: var(--text-sm); font-weight: var(--weight-medium); color: var(--text);">
                Repayment Plan
            </span>
            <span style="display: block; font-size: var(--text-xs); color: var(--text-secondary);">
                Choose your repayment strategy
            </span>
        </label>
        
        <select 
            id="tt-repayment-plan"
            class="glass glass-md"
            style="
                width: 100%;
                height: 44px;
                padding: 0 var(--space-minor);
                border: 2px solid var(--border);
                border-radius: var(--radius-md);
                background: var(--bg-glass);
                color: var(--text);
                font-family: var(--font-primary);
                font-size: var(--text-base);
                appearance: none;
                background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="%236a8ab3" viewBox="0 0 16 16"><path d="M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z"/></svg>');
                background-repeat: no-repeat;
                background-position: right var(--space-minor) center;
                background-size: 12px;
                padding-right: calc(var(--space-minor) + 12px);
            "
            onchange="ttUpdate()"
        >
            <option value="standard" selected>Standard Repayment (Fixed)</option>
            <option value="graduated">Graduated Repayment (Increasing)</option>
            <option value="income">Income-Based Repayment (10-15% of income)</option>
            <option value="extended">Extended Repayment (25+ years)</option>
            <option value="interestonly">Interest-Only (First 3 years)</option>
        </select>
        
        <div id="tt-plan-description" style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: 4px;">
            Fixed monthly payments for entire term
        </div>
    </div>

    <!-- Extra Monthly Payment -->
    <div class="form-group" style="margin-bottom: var(--space-major);">
        <label for="tt-extra-payment" style="display: block; margin-bottom: var(--space-micro);">
            <span style="font-size: var(--text-sm); font-weight: var(--weight-medium); color: var(--text);">
                Extra Monthly Payment
            </span>
            <span style="display: block; font-size: var(--text-xs); color: var(--text-secondary);">
                Pay extra to reduce principal faster
            </span>
        </label>
        
        <div style="position: relative;">
            <input 
                type="number" 
                id="tt-extra-payment"
                class="glass glass-md"
                value="0"
                min="0"
                style="
                    width: 100%;
                    height: 44px;
                    padding: 0 var(--space-minor) 0 32px;
                    border: 2px solid var(--border);
                    border-radius: var(--radius-md);
                    background: var(--bg-glass);
                    color: var(--text);
                    font-family: var(--font-primary);
                    font-size: var(--text-base);
                    font-weight: var(--weight-semibold);
                    text-align: right;
                    transition: var(--transition-base);
                "
                oninput="ttUpdate()"
                aria-label="Extra monthly payment amount"
            >
            <span id="tt-extra-symbol" style="position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--text-tertiary);">¬£</span>
        </div>
        
        <div id="tt-extra-impact" style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: 4px;">
            Add extra payments to save on interest
        </div>
    </div>

    <!-- Action Buttons -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-minor); margin-bottom: var(--space-major);">
        <button type="button" onclick="ttCalculate()" class="btn btn-secondary btn-sm" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
            <span>üî¢</span>
            <span>Calculate</span>
        </button>
        <button type="button" onclick="ttReset()" class="btn btn-secondary btn-sm" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
            <span>üîÑ</span>
            <span>Reset</span>
        </button>
        <button type="button" onclick="ttCopyResults()" class="btn btn-secondary btn-sm" style="display: flex; align-items: center; justify-content: center; gap: 4px;">
            <span>üìã</span>
            <span>Copy</span>
        </button>
    </div>
</form>

<!-- ===== 3. RESULTS (Clear, copyable, beautiful) ===== -->
<div class="results" id="tt-results" style="margin-top: var(--space-lg);">
    
    <!-- Main Results Grid -->
    <div class="result-grid" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: var(--space-minor); margin-bottom: var(--space-major);">
        
        <!-- Monthly Payment -->
        <div class="result-item" style="background: linear-gradient(145deg, rgba(33, 150, 243, 0.1), rgba(33, 150, 243, 0.05)); border: 1px solid #2196f3;">
            <div class="result-label" style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Monthly Payment</div>
            <div class="result-value" id="tt-monthly-payment" style="font-family: var(--font-mono); font-size: var(--text-xl); font-weight: var(--weight-bold); color: #2196f3; margin-bottom: var(--space-micro);">
                ¬£212.47
            </div>
            <div class="result-unit" id="tt-monthly-currency" style="font-size: var(--text-xs); color: var(--text-secondary);">
                GBP
            </div>
        </div>
        
        <!-- Total Interest -->
        <div class="result-item" style="background: var(--bg-card); border: 1px solid #f44336;">
            <div class="result-label" style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Interest</div>
            <div class="result-value" id="tt-total-interest" style="font-family: var(--font-mono); font-size: var(--text-xl); font-weight: var(--weight-bold); color: #f44336; margin-bottom: var(--space-micro);">
                ¬£5,496.40
            </div>
            <div class="result-unit" id="tt-interest-currency" style="font-size: var(--text-xs); color: var(--text-secondary);">
                GBP
            </div>
        </div>
        
        <!-- Total Repayment -->
        <div class="result-item" style="background: var(--bg-card); border: 1px solid #4caf50;">
            <div class="result-label" style="font-size: var(--text-xs); color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">Total Repayment</div>
            <div class="result-value" id="tt-total-repayment" style="font-family: var(--font-mono); font-size: var(--text-xl); font-weight: var(--weight-bold); color: #4caf50; margin-bottom: var(--space-micro);">
                ¬£25,496.40
            </div>
            <div class="result-unit" id="tt-total-currency" style="font-size: var(--text-xs); color: var(--text-secondary);">
                GBP
            </div>
        </div>
    </div>
    
    <!-- Repayment Timeline -->
    <div class="progress-section" style="margin-bottom: var(--space-major);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-minor);">
            <span style="font-size: var(--text-sm); font-weight: var(--weight-semibold); color: var(--accent);">
                üìÖ Repayment Timeline
            </span>
            <span style="font-size: var(--text-xs); color: var(--text-secondary);" id="tt-timeline">
                10 years (120 months)
            </span>
        </div>
        
        <!-- Progress Bars -->
        <div style="margin-bottom: var(--space-micro);">
            <div style="display: flex; justify-content: space-between; font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: 2px;">
                <span>Principal: <span id="tt-principal-display">¬£20,000</span></span>
                <span>Interest: <span id="tt-interest-display">¬£5,496</span></span>
            </div>
            <div style="height: 12px; background: var(--bg-glass); border-radius: 6px; overflow: hidden; position: relative;">
                <div id="tt-principal-bar" style="height: 100%; background: #2196f3; width: 78.4%; position: absolute; left: 0;"></div>
                <div id="tt-interest-bar" style="height: 100%; background: #f44336; width: 21.6%; position: absolute; left: 78.4%;"></div>
            </div>
        </div>
        
        <!-- Dates -->
        <div style="display: flex; justify-content: space-between; margin-top: var(--space-minor);">
            <div>
                <div style="font-size: var(--text-xs); color: var(--text-tertiary);">Start Date</div>
                <div style="font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text);" id="tt-start-date">Jun 2024</div>
            </div>
            <div style="text-align: center;">
                <div style="font-size: var(--text-xs); color: var(--text-tertiary);">Payoff Date</div>
                <div style="font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text);" id="tt-payoff-date">Jun 2034</div>
            </div>
            <div style="text-align: right;">
                <div style="font-size: var(--text-xs); color: var(--text-tertiary);">Time Saved</div>
                <div style="font-family: var(--font-mono); font-size: var(--text-sm); color: #4caf50;" id="tt-time-saved">0 months</div>
            </div>
        </div>
    </div>
    
    <!-- Additional Metrics -->
    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: var(--space-minor); margin-bottom: var(--space-major);">
        <div class="info-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-minor);">
            <div style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-micro);">First Year Interest</div>
            <div style="font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text);" id="tt-first-year-interest">
                ¬£1,100
            </div>
            <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: 2px;">
                Interest paid in year 1
            </div>
        </div>
        
        <div class="info-card" style="background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-minor);">
            <div style="font-size: var(--text-xs); color: var(--text-tertiary); margin-bottom: var(--space-micro);">Interest Ratio</div>
            <div style="font-family: var(--font-mono); font-size: var(--text-sm); color: var(--text);" id="tt-interest-ratio">
                27.5%
            </div>
            <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-top: 2px;">
                Interest as % of total
            </div>
        </div>
    </div>
    
    <!-- Amortization Preview -->
    <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-minor); margin-bottom: var(--space-major);">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-minor);">
            <span style="font-size: var(--text-sm); font-weight: var(--weight-semibold); color: var(--accent);">
                üìä Amortization Preview
            </span>
            <button type="button" onclick="ttToggleAmortization()" class="btn btn-ghost btn-sm" style="font-size: var(--text-xs);">
                <span id="tt-amortization-toggle">Show Details</span>
            </button>
        </div>
        
        <div id="tt-amortization-table" style="display: none;">
            <div style="overflow-x: auto;">
                <table style="width: 100%; font-size: var(--text-xs); border-collapse: collapse;">
                    <thead>
                        <tr style="border-bottom: 1px solid var(--border-light);">
                            <th style="text-align: left; padding: 4px 8px; color: var(--text-tertiary);">Month</th>
                            <th style="text-align: right; padding: 4px 8px; color: var(--text-tertiary);">Payment</th>
                            <th style="text-align: right; padding: 4px 8px; color: var(--text-tertiary);">Principal</th>
                            <th style="text-align: right; padding: 4px 8px; color: var(--text-tertiary);">Interest</th>
                            <th style="text-align: right; padding: 4px 8px; color: var(--text-tertiary);">Balance</th>
                        </tr>
                    </thead>
                    <tbody id="tt-amortization-body">
                        <!-- Will be populated by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <!-- Quick Copy Formats -->
    <div style="background: rgba(255, 255, 255, 0.02); border: 1px solid var(--border); border-radius: var(--radius-md); padding: var(--space-minor);">
        <div style="font-size: var(--text-xs); color: var(--text-secondary); margin-bottom: var(--space-micro);">
            Copy as:
        </div>
        <div style="display: flex; gap: var(--space-micro);">
            <button type="button" onclick="ttCopyText()" class="btn btn-ghost btn-sm" style="flex: 1;">
                Plain Text
            </button>
            <button type="button" onclick="ttCopyJSON()" class="btn btn-ghost btn-sm" style="flex: 1;">
                JSON
            </button>
            <button type="button" onclick="ttCopyCSV()" class="btn btn-ghost btn-sm" style="flex: 1;">
                CSV
            </button>
        </div>
    </div>
</div>

<!-- ===== 4. SHARING & EMBED (Always included) ===== -->
<div class="share-temple" style="margin-top: var(--space-lg); padding-top: var(--space-md); border-top: 1px solid var(--border-light);">
    <div style="display: flex; gap: var(--space-minor);">
        <button onclick="ttShare()" class="btn btn-secondary" style="flex: 1;">
            üì§ Share Tool
        </button>
        <button onclick="ttEmbed()" class="btn btn-secondary" style="flex: 1;">
            üîó Embed Tool
        </button>
    </div>
</div>

<!-- ===== 5. JAVASCRIPT (Self-contained, prefixed, robust) ===== -->
<script>
// TOOL-SPECIFIC FUNCTIONS (prefix with tt-)
const ttState = {
    currency: 'GBP',
    amount: 20000,
    rate: 5.5,
    term: 10,
    plan: 'standard',
    extraPayment: 0,
    startDate: new Date(),
    amortizationSchedule: [],
    
    // Currency symbols
    currencySymbols: {
        'GBP': '¬£',
        'USD': '$',
        'EUR': '‚Ç¨',
        'CAD': '$',
        'AUD': '$'
    },
    
    // Loan type configurations
    loanTypes: {
        'standard': {
            name: 'Standard Repayment',
            description: 'Fixed monthly payments for entire term',
            multiplier: 1.0
        },
        'graduated': {
            name: 'Graduated Repayment',
            description: 'Payments start low and increase every 2 years',
            multiplier: 0.8,
            increaseRate: 0.07
        },
        'income': {
            name: 'Income-Based Repayment',
            description: 'Payments capped at 10-15% of discretionary income',
            multiplier: 0.6
        },
        'extended': {
            name: 'Extended Repayment',
            description: 'Longer term (20-25 years), lower payments, more interest',
            multiplier: 0.7
        },
        'interestonly': {
            name: 'Interest-Only',
            description: 'Pay only interest for first 3 years',
            interestOnlyYears: 3,
            multiplier: 0.5
        }
    }
};

// Format currency
function ttFormatCurrency(amount) {
    const symbol = ttState.currencySymbols[ttState.currency] || '¬£';
    return `${symbol}${amount.toLocaleString('en-US', {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
    })}`;
}

// Format percentage
function ttFormatPercentage(amount) {
    return `${amount.toFixed(2)}%`;
}

// Update currency
function ttUpdateCurrency() {
    ttState.currency = document.getElementById('tt-currency').value;
    ttUpdate();
}

// Calculate amortization schedule
function ttCalculateAmortization() {
    const principal = ttState.amount;
    const monthlyRate = ttState.rate / 100 / 12;
    const months = ttState.term * 12;
    const schedule = [];
    
    let balance = principal;
    let totalInterest = 0;
    let totalPrincipal = 0;
    let paymentMultiplier = ttState.loanTypes[ttState.plan].multiplier || 1.0;
    let interestOnlyPeriod = 0;
    
    if (ttState.plan === 'interestonly') {
        interestOnlyPeriod = ttState.loanTypes.interestonly.interestOnlyYears * 12;
    }
    
    // Calculate base payment
    let basePayment = 0;
    if (monthlyRate === 0) {
        basePayment = principal / months;
    } else {
        basePayment = principal * monthlyRate / (1 - Math.pow(1 + monthlyRate, -months));
    }
    
    for (let month = 1; month <= months && balance > 0.01; month++) {
        // Adjust multiplier for graduated loans
        if (ttState.plan === 'graduated' && month > 1 && month % 24 === 1) {
            paymentMultiplier *= 1.07;
        }
        
        // Calculate interest
        const interest = balance * monthlyRate;
        totalInterest += interest;
        
        // Calculate payment
        let payment = basePayment * paymentMultiplier + ttState.extraPayment;
        let principalPaid = 0;
        
        if (ttState.plan === 'interestonly' && month <= interestOnlyPeriod) {
            // Interest-only period
            principalPaid = 0;
            payment = interest;
        } else {
            // Regular payment
            principalPaid = Math.min(balance, payment - interest);
            if (principalPaid < 0) principalPaid = 0;
        }
        
        totalPrincipal += principalPaid;
        balance -= principalPaid;
        
        if (balance < 0) balance = 0;
        
        schedule.push({
            month,
            payment,
            principal: principalPaid,
            interest,
            balance
        });
        
        // Break if paid off early
        if (balance <= 0.01) break;
    }
    
    return {
        schedule,
        totalInterest,
        totalPrincipal,
        totalPayments: totalInterest + totalPrincipal,
        actualMonths: schedule.length
    };
}

// Update UI based on current state
function ttUpdate() {
    // Update state from inputs
    ttState.amount = parseFloat(document.getElementById('tt-loan-amount').value) || 0;
    ttState.rate = parseFloat(document.getElementById('tt-interest-rate').value) || 0;
    ttState.term = parseInt(document.getElementById('tt-repayment-term').value) || 0;
    ttState.plan = document.getElementById('tt-repayment-plan').value;
    ttState.extraPayment = parseFloat(document.getElementById('tt-extra-payment').value) || 0;
    
    // Update currency symbol
    const currencySymbol = ttState.currencySymbols[ttState.currency] || '¬£';
    document.getElementById('tt-extra-symbol').textContent = currencySymbol;
    
    // Update loan type description
    const typeConfig = ttState.loanTypes[ttState.plan];
    document.getElementById('tt-plan-description').textContent = typeConfig.description;
    
    // Update amount visualization
    const amountPercent = Math.min((ttState.amount / 100000) * 100, 100);
    document.getElementById('tt-amount-bar').style.width = `${amountPercent}%`;
    document.getElementById('tt-amount-display').textContent = ttFormatCurrency(ttState.amount);
    document.getElementById('tt-amount-max').textContent = currencySymbol + '100,000';
    document.getElementById('tt-currency-zero').textContent = currencySymbol + '0';
    
    // Calculate amortization
    const result = ttCalculateAmortization();
    ttState.amortizationSchedule = result.schedule;
    
    // Calculate monthly payment (average of first 12 months)
    let avgMonthly = 0;
    if (result.schedule.length > 0) {
        const firstYear = result.schedule.slice(0, Math.min(12, result.schedule.length));
        avgMonthly = firstYear.reduce((sum, p) => sum + p.payment, 0) / firstYear.length;
    }
    
    // Update results
    document.getElementById('tt-monthly-payment').textContent = ttFormatCurrency(avgMonthly);
    document.getElementById('tt-total-interest').textContent = ttFormatCurrency(result.totalInterest);
    document.getElementById('tt-total-repayment').textContent = ttFormatCurrency(result.totalPayments);
    
    // Update currency labels
    document.getElementById('tt-monthly-currency').textContent = ttState.currency;
    document.getElementById('tt-interest-currency').textContent = ttState.currency;
    document.getElementById('tt-total-currency').textContent = ttState.currency;
    
    // Update timeline
    document.getElementById('tt-timeline').textContent = 
        `${Math.floor(result.actualMonths / 12)} years (${result.actualMonths} months)`;
    
    // Update progress bars
    const principalPercent = (ttState.amount / result.totalPayments) * 100;
    const interestPercent = (result.totalInterest / result.totalPayments) * 100;
    
    document.getElementById('tt-principal-bar').style.width = `${principalPercent}%`;
    document.getElementById('tt-interest-bar').style.width = `${interestPercent}%`;
    document.getElementById('tt-principal-display').textContent = ttFormatCurrency(ttState.amount);
    document.getElementById('tt-interest-display').textContent = ttFormatCurrency(result.totalInterest);
    
    // Update dates
    const startDate = ttState.startDate;
    const payoffDate = new Date(startDate);
    payoffDate.setMonth(payoffDate.getMonth() + result.actualMonths);
    
    document.getElementById('tt-start-date').textContent = 
        startDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
    document.getElementById('tt-payoff-date').textContent = 
        payoffDate.toLocaleDateString('en-GB', { month: 'short', year: 'numeric' });
    
    // Calculate time saved with extra payments
    const timeSaved = ttState.extraPayment > 0 ? (ttState.term * 12) - result.actualMonths : 0;
    if (timeSaved > 0) {
        document.getElementById('tt-time-saved').textContent = `${timeSaved} months`;
    } else {
        document.getElementById('tt-time-saved').textContent = '0 months';
    }
    
    // Update extra payment impact
    if (ttState.extraPayment > 0) {
        document.getElementById('tt-extra-impact').textContent = 
            `Extra payment saves ${ttFormatCurrency(result.totalInterest)} interest`;
    } else {
        document.getElementById('tt-extra-impact').textContent = 
            'Add extra payments to save on interest';
    }
    
    // Update quick stats
    const firstYearInterest = result.schedule
        .slice(0, Math.min(12, result.schedule.length))
        .reduce((sum, p) => sum + p.interest, 0);
    const interestRatio = (result.totalInterest / ttState.amount * 100).toFixed(1);
    
    document.getElementById('tt-first-year-interest').textContent = ttFormatCurrency(firstYearInterest);
    document.getElementById('tt-interest-ratio').textContent = `${interestRatio}%`;
    
    // Update amortization table if visible
    ttUpdateAmortizationTable();
}

// Update amortization table
function ttUpdateAmortizationTable() {
    const tbody = document.getElementById('tt-amortization-body');
    tbody.innerHTML = '';
    
    const previewMonths = Math.min(12, ttState.amortizationSchedule.length);
    const symbol = ttState.currencySymbols[ttState.currency] || '¬£';
    
    for (let i = 0; i < previewMonths; i++) {
        const row = ttState.amortizationSchedule[i];
        const tr = document.createElement('tr');
        
        tr.innerHTML = `
            <td style="padding:4px 8px;">${row.month}</td>
            <td style="text-align:right;padding:4px 8px;">${symbol}${row.payment.toFixed(2)}</td>
            <td style="text-align:right;padding:4px 8px;">${symbol}${row.principal.toFixed(2)}</td>
            <td style="text-align:right;padding:4px 8px;">${symbol}${row.interest.toFixed(2)}</td>
            <td style="text-align:right;padding:4px 8px;">${symbol}${row.balance.toFixed(2)}</td>
        `;
        
        tbody.appendChild(tr);
    }
}

// Toggle amortization table visibility
function ttToggleAmortization() {
    const table = document.getElementById('tt-amortization-table');
    const toggle = document.getElementById('tt-amortization-toggle');
    
    if (table.style.display === 'none') {
        table.style.display = 'block';
        toggle.textContent = 'Hide Details';
    } else {
        table.style.display = 'none';
        toggle.textContent = 'Show Details';
    }
}

// Reset to defaults
function ttReset() {
    document.getElementById('tt-currency').value = 'GBP';
    document.getElementById('tt-loan-amount').value = '20000';
    document.getElementById('tt-interest-rate').value = '5.5';
    document.getElementById('tt-repayment-term').value = '10';
    document.getElementById('tt-repayment-plan').value = 'standard';
    document.getElementById('tt-extra-payment').value = '0';
    
    // Set start date to next month
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    ttState.startDate = nextMonth;
    
    ttUpdate();
    showNotification('Reset to defaults', 'success');
}

// Calculate (alias for update)
function ttCalculate() {
    ttUpdate();
    showNotification('Calculation complete', 'success');
}

// Copy results to clipboard
function ttCopyResults() {
    const result = ttCalculateAmortization();
    const monthly = result.schedule.length > 0 ? result.schedule[0].payment : 0;
    const symbol = ttState.currencySymbols[ttState.currency] || '¬£';
    
    const text = `Student Loan Calculation:
Loan: ${symbol}${ttState.amount.toLocaleString()}
Rate: ${ttState.rate}%
Term: ${ttState.term} years
Monthly: ${symbol}${monthly.toFixed(2)}
Total Interest: ${symbol}${result.totalInterest.toFixed(2)}
Total Repayment: ${symbol}${result.totalPayments.toFixed(2)}`;
    
    navigator.clipboard.writeText(text).then(() => {
        showNotification('Results copied to clipboard', 'success');
    }).catch(err => {
        showNotification('Failed to copy results', 'error');
    });
}

// Copy as plain text
function ttCopyText() {
    ttCopyResults(); // Reuse the same function
}

// Copy as JSON
function ttCopyJSON() {
    const result = ttCalculateAmortization();
    const monthly = result.schedule.length > 0 ? result.schedule[0].payment : 0;
    
    const data = {
        loan: {
            amount: ttState.amount,
            currency: ttState.currency,
            rate: ttState.rate,
            term: ttState.term,
            plan: ttState.plan,
            extraPayment: ttState.extraPayment
        },
        results: {
            monthlyPayment: monthly,
            totalInterest: result.totalInterest,
            totalRepayment: result.totalPayments,
            actualTermMonths: result.actualMonths,
            actualTermYears: result.actualMonths / 12
        }
    };
    
    navigator.clipboard.writeText(JSON.stringify(data, null, 2)).then(() => {
        showNotification('JSON copied to clipboard', 'success');
    }).catch(err => {
        showNotification('Failed to copy JSON', 'error');
    });
}

// Copy as CSV
function ttCopyCSV() {
    const result = ttCalculateAmortization();
    const monthly = result.schedule.length > 0 ? result.schedule[0].payment : 0;
    const symbol = ttState.currencySymbols[ttState.currency] || '¬£';
    
    const csv = `Parameter,Value
Loan Amount,${symbol}${ttState.amount}
Interest Rate,${ttState.rate}%
Repayment Term,${ttState.term} years
Repayment Plan,${ttState.loanTypes[ttState.plan].name}
Extra Payment,${symbol}${ttState.extraPayment}
Monthly Payment,${symbol}${monthly.toFixed(2)}
Total Interest,${symbol}${result.totalInterest.toFixed(2)}
Total Repayment,${symbol}${result.totalPayments.toFixed(2)}
Actual Term,${result.actualMonths} months`;
    
    navigator.clipboard.writeText(csv).then(() => {
        showNotification('CSV copied to clipboard', 'success');
    }).catch(err => {
        showNotification('Failed to copy CSV', 'error');
    });
}

// Share tool
function ttShare() {
    const result = ttCalculateAmortization();
    const monthly = result.schedule.length > 0 ? result.schedule[0].payment : 0;
    const symbol = ttState.currencySymbols[ttState.currency] || '¬£';
    
    const shareText = `üí∞ Student Loan Calculator\n` +
                     `Loan: ${symbol}${ttState.amount.toLocaleString()}\n` +
                     `Rate: ${ttState.rate}%\n` +
                     `Term: ${ttState.term} years\n` +
                     `Monthly: ${symbol}${monthly.toFixed(2)}\n` +
                     `Total Interest: ${symbol}${result.totalInterest.toFixed(2)}\n\n` +
                     `From The Most Useful Site`;
    
    if (navigator.share) {
        navigator.share({
            title: 'Student Loan Calculator',
            text: shareText,
            url: window.location.href
        });
    } else {
        navigator.clipboard.writeText(shareText);
        showNotification('Calculation copied to clipboard!', 'success');
    }
}

// Embed tool
function ttEmbed() {
    const embedCode = `<iframe src="${window.location.origin}/cards/student-loan-calculator.html" width="100%" height="650" style="border:none;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);" title="Student Loan Calculator - The Most Useful Site"></iframe>`;
    
    navigator.clipboard.writeText(embedCode);
    showNotification('Embed code copied to clipboard!', 'success');
    
    // Track in analytics
    if (window.plausible) {
        window.plausible('Embed Generated', { props: { tool: 'student-loan-calculator' } });
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    console.log('üí∞ Student Loan Calculator loaded');
    
    // Set start date to next month
    const nextMonth = new Date();
    nextMonth.setMonth(nextMonth.getMonth() + 1);
    ttState.startDate = nextMonth;
    
    // Initial calculation
    ttUpdate();
    
    // Auto-update on input with debounce
    let updateTimer;
    ['tt-loan-amount', 'tt-interest-rate', 'tt-repayment-term', 'tt-extra-payment'].forEach(id => {
        document.getElementById(id).addEventListener('input', () => {
            clearTimeout(updateTimer);
            updateTimer = setTimeout(ttUpdate, 300);
        });
    });
    
    // Update on select changes
    document.getElementById('tt-currency').addEventListener('change', ttUpdateCurrency);
    document.getElementById('tt-repayment-plan').addEventListener('change', ttUpdate);
    
    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            ttReset();
        }
        if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            ttCalculate();
        }
        if (e.key === 'r' && (e.ctrlKey || e.metaKey)) {
            e.preventDefault();
            ttReset();
        }
    });
});
</script>

<!-- ===== 6. CARD-SCOPED STYLES (Only if absolutely necessary) ===== -->
<style>
/* Only add styles that MUST override global styles */
#tt-title { 
    color: var(--accent); 
    margin-bottom: var(--space-sm);
    font-size: var(--text-xl);
    font-weight: var(--weight-bold);
}

/* Enhanced result item styling */
.result-item {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: var(--radius-md);
    padding: var(--space-minor);
    text-align: center;
    transition: var(--transition-base);
}

.result-item:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-sm);
}

/* Info card styling */
.info-card:hover {
    border-color: var(--accent);
    transform: translateY(-1px);
}

/* Table styles */
table {
    width: 100%;
}

table th {
    color: var(--text-tertiary);
    font-weight: var(--weight-medium);
    text-transform: uppercase;
    letter-spacing: 0.5px;
    font-size: var(--text-xs);
}

table td {
    padding: 4px 8px;
    border-bottom: 1px solid var(--border-light);
    color: var(--text-secondary);
}

table tr:hover {
    background: rgba(255, 255, 255, 0.03);
}

/* Warning banner animation */
@keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.8; }
}

/* Progress bar animations */
.progress-bar {
    position: relative;
}

.progress-bar::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, 
        transparent 0%, 
        rgba(255, 255, 255, 0.1) 50%, 
        transparent 100%);
    background-size: 200% 100%;
    animation: shimmer 2s infinite linear;
    opacity: 0.5;
}

@keyframes shimmer {
    0% { background-position: -200% 0; }
    100% { background-position: 200% 0; }
}

/* Responsive adjustments */
@media (max-width: 480px) {
    .result-grid {
        grid-template-columns: 1fr !important;
        gap: var(--space-minor) !important;
    }
    
    .row {
        grid-template-columns: 1fr !important;
    }
    
    .info-cards {
        grid-template-columns: 1fr !important;
    }
}

@media (max-width: 360px) {
    .form-group > div {
        grid-template-columns: 1fr !important;
    }
}

/* Print styles */
@media print {
    button, .share-temple {
        display: none !important;
    }
    
    .result-item {
        break-inside: avoid;
        border: 1px solid #ccc !important;
        background: white !important;
    }
    
    .result-value {
        color: #000 !important;
    }
    
    .warning-banner {
        display: none !important;
    }
    
    table {
        background: white !important;
        color: black !important;
    }
}

/* Focus states for accessibility */
input:focus, select:focus, button:focus {
    outline: 2px solid var(--accent);
    outline-offset: 2px;
}

/* Loading state for calculations */
.calculating {
    position: relative;
    opacity: 0.7;
    pointer-events: none;
}

.calculating::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 20px;
    height: 20px;
    margin: -10px 0 0 -10px;
    border: 2px solid var(--accent);
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<!-- ===== 7. METADATA FOR CARD LOADER (Hidden) ===== -->
<div style="display: none;" data-card-metadata>
    <div data-title="Student Loan Calculator"></div>
    <div data-description="Calculate student loan payments, total interest, and repayment timeline. Compare different repayment plans and see how extra payments can save you money."></div>
    <div data-tags="finance, loan, student, calculator, debt, repayment, interest, amortization, education, financial planning"></div>
    <div data-category="Finance"></div>
    <div data-icon="üí∞"></div>
    <div data-version="2.0.0"></div>
    <div data-author="The Most Useful Site"></div>
    <div data-load-time="200ms"></div>
    <div data-financial-disclaimer="true"></div>
</div>
