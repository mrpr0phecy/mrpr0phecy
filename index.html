<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Most Useful Site in the World</title>
  <style>
    :root{
      --accent:#2dd4ff;
      --muted:#e6faff;
      --glass: rgba(255,255,255,0.06);
      --glass-strong: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.10);
      --panel: rgba(20,20,20,0.9);
    }

    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      background:linear-gradient(-45deg,#1a1a1a,#2a2a2a,#3a3a3a,#2a2a2a);
      background-size:400% 400%;
      animation:gradientShift 20s ease infinite;
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    @keyframes gradientShift {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    /* faint animated logo overlay */
    body::before{
      content:"";
      position:fixed; inset:0; pointer-events:none; z-index:0;
      background-image:url("/logo.png");
      background-repeat:no-repeat; background-position:center;
      background-size:min(50vw,520px);
      opacity:0.06; filter:blur(0.6px); mix-blend-mode:screen;
      animation:logoDrift 24s ease-in-out infinite;
    }
    @keyframes logoDrift {
      0%{transform:translate3d(0,0,0)}
      50%{transform:translate3d(0,-10px,0)}
      100%{transform:translate3d(0,0,0)}
    }

    /* only header: site title */
    header{position:relative; z-index:2; text-align:center; padding:28px 20px 10px}
    header h1{margin:0; font-size:1.8rem; letter-spacing:0.2px}

    /* toolbox toggle (small translucent square with plus) */
    .toolbox-toggle{
      position:fixed; top:18px; left:18px; z-index:10000;
      width:44px; height:44px; border-radius:10px;
      background:var(--glass-strong);
      border:1px solid var(--border);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; backdrop-filter: blur(6px);
      box-shadow:0 6px 18px rgba(0,0,0,0.45);
      transition:transform .18s ease;
    }
    .toolbox-toggle:active{ transform:scale(.96) }
    .toolbox-toggle .plus{ width:18px; height:18px; position:relative }
    .toolbox-toggle .plus::before, .toolbox-toggle .plus::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:var(--accent); border-radius:2px;
    }
    .toolbox-toggle .plus::before{ width:2px; height:14px }
    .toolbox-toggle .plus::after{ width:14px; height:2px }

    /* toolbox panel (pops out) */
    .toolbox-panel{
      position:fixed; top:18px; left:74px; z-index:9998;
      width:360px; max-width:calc(100% - 110px);
      background:var(--panel);
      border:1px solid rgba(255,255,255,0.06);
      border-radius:12px; padding:12px;
      box-shadow:0 12px 40px rgba(0,0,0,0.6);
      transform-origin:left top;
      transform:translateY(-8px) scale(.98);
      opacity:0; pointer-events:none;
      transition:opacity .26s, transform .26s;
      backdrop-filter: blur(8px) saturate(1.05);
    }
    .toolbox-panel.open{ transform:translateY(0) scale(1); opacity:1; pointer-events:auto }
    .toolbox-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px }
    .toolbox-header h3{ margin:0; color:var(--accent); font-size:1rem }
    .toolbox-list{ max-height:320px; overflow:auto; padding-right:6px }
    .toolbox-item{ display:flex; align-items:center; justify-content:space-between; gap:10px; padding:8px; border-radius:8px; background:rgba(255,255,255,0.06); margin-bottom:8px }
    .toolbox-item .meta{ display:flex; gap:10px; align-items:center }
    .toolbox-item .dot{ width:34px; height:34px; border-radius:8px; background:rgba(255,255,255,0.08); display:flex; align-items:center; justify-content:center; color:var(--accent); font-weight:700 }
    .toolbox-item .actions button{
      padding:6px 8px; border-radius:8px; border:1px solid rgba(255,255,255,0.08);
      background:transparent; color:var(--muted); cursor:pointer
    }

    /* banner (brief explanation, fades out) */
    .banner{
      position:fixed; top:0; left:0; right:0; z-index:9999;
      background:var(--accent); color:#0b0f1a; text-align:center;
      padding:10px 14px; font-weight:600;
      opacity:1; transition:opacity 2s ease
    }
    .banner.fade{ opacity:0; pointer-events:none }

    /* search bar */
    .search-bar{
      max-width:820px; margin:14px auto 16px; position:relative; z-index:2;
      display:flex; background:var(--glass); border-radius:12px; padding:12px 16px;
      border:1px solid rgba(255,255,255,0.08)
    }
    .search-bar input{ flex:1; border:none; background:transparent; color:var(--muted); font-size:1rem; outline:none }

    /* sort controls */
    .controls{ text-align:center; margin:0 auto 10px; position:relative; z-index:2 }
    .controls button{
      margin:0 6px; padding:8px 12px; border-radius:10px;
      border:1px solid rgba(255,255,255,0.06); background:transparent;
      color:var(--muted); cursor:pointer; transition:transform .12s ease, background .12s ease
    }
    .controls button:hover{ transform:translateY(-2px); background:rgba(255,255,255,0.02) }

    /* dashboards */
    .dashboard{
      position:relative; z-index:2;
      display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:20px;
      padding:20px
    }

    /* card */
    .card{
      position:relative;
      background:linear-gradient(135deg,rgba(255,255,255,0.04),rgba(255,255,255,0.07));
      border:1px solid rgba(255,255,255,0.10);
      border-radius:12px; padding:16px;
      backdrop-filter: blur(8px);
      opacity:0; transform:translateY(40px) scale(0.98);
      transition:opacity .6s cubic-bezier(.2,.9,.2,1), transform .6s cubic-bezier(.2,.9,.2,1)
    }
    .card.visible{ opacity:1; transform:translateY(0) scale(1) }

    .card h3{ margin:0 0 10px; color:var(--accent) }

    .add-to-toolbox{
      position:absolute; top:10px; right:10px;
      width:32px; height:32px; border-radius:8px;
      display:flex; align-items:center; justify-content:center;
      background:var(--glass-strong);
      border:1px solid var(--border);
      cursor:pointer; color:var(--accent)
    }
    .add-to-toolbox .plus{ width:14px; height:14px; position:relative }
    .add-to-toolbox .plus::before, .add-to-toolbox .plus::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      background:var(--accent); border-radius:1px
    }
    .add-to-toolbox .plus::before{ width:2px; height:12px }
    .add-to-toolbox .plus::after{ width:12px; height:2px }

    .status{ text-align:center; color:rgba(230,250,255,0.7); margin:6px 0 8px; font-size:.95rem }

    @media (max-width:640px){
      header{ padding-top:56px }
      .toolbox-panel{ left:12px; right:12px; width:auto; max-width:calc(100% - 24px) }
      .dashboard{ padding:16px }
    }
  </style>
</head>
<body>
  <!-- fade-out info banner -->
  <div id="banner" class="banner">Drag widgets to arrange them. Use the + to pin tools to your toolbox below.</div>

  <!-- toolbox toggle and panel -->
  <div class="toolbox-toggle" id="toolboxToggle" role="button" aria-label="Open toolbox" title="Open toolbox" tabindex="0">
    <span class="plus" aria-hidden="true"></span>
  </div>
  <div class="toolbox-panel" id="toolboxPanel" aria-hidden="true" role="region" aria-label="Toolbox">
    <div class="toolbox-header">
      <h3>Toolbox</h3>
      <div>
        <button id="clearToolboxBtn">Clear</button>
        <button id="closeToolboxBtn">Close</button>
      </div>
    </div>
    <div class="toolbox-list" id="toolboxList">
      <div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div>
    </div>
  </div>

  <!-- only header title -->
  <header>
    <h1>The Most Useful Site in the World</h1>
  </header>

  <!-- search and sort -->
  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search cards..." aria-label="Search cards" />
  </div>
  <div class="controls">
    <button id="sortAlphaBtn" title="Sort alphabetically">Sort A→Z</button>
    <button id="sortRandomBtn" title="Random order">Random</button>
  </div>
  <div class="status" id="status">Loading cards...</div>

  <!-- main dashboard -->
  <div id="gridContainer" class="dashboard" aria-live="polite" aria-busy="false"></div>

  <!-- pinned toolbox dashboard -->
  <h2 style="text-align:center;color:var(--accent);margin-top:12px">Pinned Toolbox Widgets</h2>
  <div id="toolboxDashboard" class="dashboard"></div>

  <!-- SortableJS for drag-and-drop -->
  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
  <script>
    /* configuration (internal only; never shown in UI) */
    const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
    const DEFAULT_BRANCH = 'main';

    /* banner fade */
    setTimeout(()=>document.getElementById('banner').classList.add('fade'), 6000);

    /* helpers */
    const qs = (s, ctx=document) => ctx.querySelector(s);
    const el = (tag, props={}, ...children) => {
      const e=document.createElement(tag);
      Object.entries(props||{}).forEach(([k,v])=>{
        if(k==='className') e.className=v;
        else if(k==='dataset') Object.entries(v).forEach(([dk,dv])=> e.dataset[dk]=dv);
        else e.setAttribute(k,v);
      });
      children.forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
      return e;
    };
    function setStatus(s){ qs('#status').textContent = s; }
    function parseOwnerRepo(str){ const p=str.split('/'); return {owner:p[0], repo:p[1]}; }
    function shuffleArray(a){ for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]]; } return a; }

    /* GitHub API: list card files under cards/ */
    async function fetchRepoTree(owner, repo, branch){
      const url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
      const r=await fetch(url);
      if(!r.ok) throw new Error('GitHub API error: '+r.status);
      return r.json();
    }
    async function getCardFiles(owner, repo, branch){
      const data = await fetchRepoTree(owner, repo, branch);
      return (data.tree||[])
        .filter(item => item.path && item.path.startsWith('cards/') && item.path.endsWith('.html'))
        .map(item => item.path.replace(/^cards\//,''));
    }

    /* card creation and loading */
    function createCardElement(file, {pinned=false}={}){
      const name = file.replace('.html','');
      const card = el('article', { className:'card', dataset:{ name, file } });
      const addBtn = el('div', { className:'add-to-toolbox', title:'Add to toolbox', role:'button' },
        el('span', { className:'plus', ariaHidden:'true' })
      );
      addBtn.addEventListener('click', (ev)=>{
        ev.stopPropagation(); addToToolbox(file);
      });
      const title = el('h3', {}, name);
      const content = el('div', { className:'content' }, 'Loading preview…');

      card.appendChild(addBtn);
      card.appendChild(title);
      card.appendChild(content);

      if(pinned){
        // load immediately for pinned tools
        loadCardContentInto(card, file).catch(()=>{ content.textContent='Preview unavailable.'; });
        // mark visible right away
        requestAnimationFrame(()=> card.classList.add('visible'));
      }else{
        // lazy load on scroll with animation
        const io = new IntersectionObserver(entries=>{
          entries.forEach(entry=>{
            if(entry.isIntersecting){
              // reveal
              card.classList.add('visible');
              // fetch preview
              loadCardContentInto(card, file).catch(()=>{ content.textContent='Preview unavailable.'; });
              io.unobserve(card);
            }
          });
        }, { threshold:0.12 });
        io.observe(card);
      }
      return card;
    }

    async function loadCardContentInto(card, file){
      if(card.dataset.loaded==='true') return;
      const url = `cards/${file}`;
      const r = await fetch(url);
      if(!r.ok) throw new Error('Failed to fetch card');
      const html = await r.text();
      const sanitized = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
      const content = card.querySelector('.content');
      if(content) content.innerHTML = sanitized;
      card.dataset.loaded = 'true';
    }

    /* render dashboard */
    let currentFiles = [];
    async function loadDashboard(){
      setStatus('Fetching file list...');
      const {owner, repo} = parseOwnerRepo(DEFAULT_REPO);
      try{
        const files = await getCardFiles(owner, repo, DEFAULT_BRANCH);
        if(!files.length){ setStatus('No cards found under cards/'); return; }
        // sort alphabetically by default
        files.sort((a,b)=> a.localeCompare(b, undefined, { sensitivity:'base', numeric:true }));
        currentFiles = files.slice();

        const grid = qs('#gridContainer'); grid.innerHTML='';
        files.forEach(f=>{
          const cardEl = createCardElement(f, { pinned:false });
          grid.appendChild(cardEl);
        });
        setStatus(`Loaded ${files.length} cards.`);
        applySearchFilter(qs('#searchInput').value);
      }catch(err){
        setStatus('Error loading cards. Try again.');
      }
    }

    /* search (filters both dashboards) */
    let currentQuery = '';
    function applySearchFilter(q){
      currentQuery = (q||'').trim().toLowerCase();
      // filter main grid
      document.querySelectorAll('#gridContainer .card').forEach(card=>{
        const name = (card.dataset.name||'').toLowerCase();
        const text = (card.textContent||'').toLowerCase();
        const show = !currentQuery || name.includes(currentQuery) || text.includes(currentQuery);
        card.style.display = show ? '' : 'none';
      });
      // filter pinned dashboard
      document.querySelectorAll('#toolboxDashboard .card').forEach(card=>{
        const name = (card.dataset.name||'').toLowerCase();
        const text = (card.textContent||'').toLowerCase();
        const show = !currentQuery || name.includes(currentQuery) || text.includes(currentQuery);
        card.style.display = show ? '' : 'none';
      });
      const visibleCount = Array.from(document.querySelectorAll('#gridContainer .card')).filter(c=>c.style.display!=='none').length;
      setStatus(`Showing ${visibleCount} of ${currentFiles.length} cards${currentQuery ? ' (filtered)' : ''}.`);
    }
    const debounce = (fn, wait=160)=>{ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; };
    qs('#searchInput').addEventListener('input', debounce(e=> applySearchFilter(e.target.value)));

    /* sort controls */
    qs('#sortAlphaBtn').addEventListener('click', ()=>{
      const grid = qs('#gridContainer');
      const nodes = Array.from(grid.children);
      nodes.sort((a,b)=> a.dataset.name.localeCompare(b.dataset.name, undefined, { sensitivity:'base', numeric:true }));
      nodes.forEach(n=> grid.appendChild(n));
      setStatus('Sorted alphabetically (A→Z).');
    });
    qs('#sortRandomBtn').addEventListener('click', ()=>{
      const grid = qs('#gridContainer');
      const nodes = Array.from(grid.children);
      shuffleArray(nodes);
      nodes.forEach(n=> grid.appendChild(n));
      setStatus('Shuffled cards (random order).');
    });

    /* toolbox state */
    const TOOLBOX_KEY = 'toolbox_items_v1';
    function loadToolboxStore(){ try{ return JSON.parse(localStorage.getItem(TOOLBOX_KEY) || '[]'); }catch(e){ return []; } }
    function saveToolboxStore(items){ try{ localStorage.setItem(TOOLBOX_KEY, JSON.stringify(items)); }catch(e){} }
    let toolboxItems = loadToolboxStore();

    /* render toolbox panel list */
    function renderToolboxPanel(){
      const list = qs('#toolboxList'); list.innerHTML='';
      if(!toolboxItems.length){
        list.innerHTML = '<div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div>';
        return;
      }
      toolboxItems.forEach((file, idx)=>{
        const name = file.replace('.html','');
        const item = el('div',{className:'toolbox-item'},
          el('div',{className:'meta'},
            el('div',{className:'dot'}, name.charAt(0).toUpperCase()),
            el('div',{}, el('div',{style:'font-weight:700'}, name), el('div',{style:'font-size:.82rem;color:rgba(230,250,255,0.7)'}, file))
          ),
          el('div',{className:'actions'},
            el('button',{onclick:()=> window.open('cards/'+file, '_blank')}, 'Open'),
            el('button',{onclick:()=>{
              removeFromToolbox(file);
            }}, 'Remove')
          )
        );
        list.appendChild(item);
      });
    }

    /* pinned toolbox dashboard rendering */
    function renderPinnedDashboard(){
      const dash = qs('#toolboxDashboard'); dash.innerHTML='';
      toolboxItems.forEach(file=>{
        const card = createCardElement(file, { pinned:true });
        dash.appendChild(card);
      });
      applySearchFilter(currentQuery);
    }

    /* add/remove toolbox items */
    function addToToolbox(file){
      if(toolboxItems.includes(file)) { openToolbox(); return; }
      toolboxItems.unshift(file);
      // cap
      if(toolboxItems.length > 80) toolboxItems.length = 80;
      saveToolboxStore(toolboxItems);
      renderToolboxPanel();
      // add to pinned dashboard immediately
      const pinnedCard = createCardElement(file, { pinned:true });
      qs('#toolboxDashboard').prepend(pinnedCard);
      openToolbox(); // pop the panel for immediate feedback
    }
    function removeFromToolbox(file){
      const idx = toolboxItems.indexOf(file);
      if(idx>=0){
        toolboxItems.splice(idx,1);
        saveToolboxStore(toolboxItems);
        renderToolboxPanel();
        renderPinnedDashboard();
      }
    }
    function clearToolbox(){
      if(!confirm('Clear toolbox?')) return;
      toolboxItems = [];
      saveToolboxStore(toolboxItems);
      renderToolboxPanel();
      renderPinnedDashboard();
    }

    /* toolbox panel open/close */
    function openToolbox(){ qs('#toolboxPanel').classList.add('open'); qs('#toolboxPanel').setAttribute('aria-hidden','false'); }
    function closeToolbox(){ qs('#toolboxPanel').classList.remove('open'); qs('#toolboxPanel').setAttribute('aria-hidden','true'); }
    function toggleToolbox(){ const p=qs('#toolboxPanel'); p.classList.toggle('open'); p.setAttribute('aria-hidden', p.classList.contains('open') ? 'false' : 'true'); }
    qs('#toolboxToggle').addEventListener('click', toggleToolbox);
    qs('#clearToolboxBtn').addEventListener('click', clearToolbox);
    qs('#closeToolboxBtn').addEventListener('click', closeToolbox);
    // accessibility
    qs('#toolboxToggle').addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleToolbox(); } });
    // close on outside click
    document.addEventListener('click', (e)=>{
      const panel = qs('#toolboxPanel');
      const toggle = qs('#toolboxToggle');
      if(!panel.classList.contains('open')) return;
      if(!panel.contains(e.target) && !toggle.contains(e.target)) closeToolbox();
    });

    /* drag-and-drop dashboards */
    new Sortable(document.getElementById('gridContainer'), {
      animation:150, ghostClass:'dragging'
    });
    new Sortable(document.getElementById('toolboxDashboard'), {
      animation:150, ghostClass:'dragging'
    });

    /* init */
    renderToolboxPanel();
    renderPinnedDashboard();
    loadDashboard();
  </script>
</body>
</html>
