<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Most Useful Site in the World â€” Auto Organized</title>
  <style>
    :root{--accent:#2dd4ff;--muted:#e6faff;}
    html,body{height:100%}
    body{
      margin:0;font-family:Inter,system-ui,sans-serif;
      background:linear-gradient(-45deg,#0b0f1a,#1a1f2b,#2a2f3b,#1a1f2b);
      background-size:400% 400%;animation:gradientShift 20s ease infinite;color:var(--muted);
    }
    @keyframes gradientShift{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    body::before{
      content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
      background-image:url("/logo.png");background-repeat:no-repeat;background-position:center;
      background-size:min(48vw,520px);opacity:0.06;filter:blur(0.6px);mix-blend-mode:screen;
      animation:logoDrift 24s ease-in-out infinite;
    }
    @keyframes logoDrift{0%{transform:translate3d(0,0,0)}50%{transform:translate3d(0,-10px,0)}100%{transform:translate3d(0,0,0)}}
    header,main,footer{position:relative;z-index:2}
    /* Toolbox toggle/panel (kept from previous) */
    .toolbox-toggle{position:fixed;top:18px;left:18px;width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(6px);box-shadow:0 6px 18px rgba(0,0,0,0.45);transition:transform .18s;z-index:6}
    .toolbox-toggle:active{transform:scale(.96)}
    .toolbox-toggle .plus{width:18px;height:18px;position:relative}
    .toolbox-toggle .plus::before,.toolbox-toggle .plus::after{content:"";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:var(--accent);border-radius:2px}
    .toolbox-toggle .plus::before{width:2px;height:14px}.toolbox-toggle .plus::after{width:14px;height:2px}
    .toolbox-panel{position:fixed;top:18px;left:74px;width:360px;max-width:calc(100% - 110px);background:linear-gradient(180deg,rgba(10,12,16,0.85),rgba(10,12,16,0.78));border:1px solid rgba(255,255,255,0.06);border-radius:12px;padding:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);transform-origin:left top;transform:translateY(-8px) scale(.98);opacity:0;pointer-events:none;transition:opacity .26s,transform .26s;z-index:5;backdrop-filter:blur(8px) saturate(1.05)}
    .toolbox-panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}
    .toolbox-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .toolbox-header h3{margin:0;color:var(--accent)}
    .toolbox-list{max-height:320px;overflow:auto;padding-right:6px}
    .toolbox-item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);margin-bottom:8px}
    header{text-align:center;padding:72px 20px 28px}
    header h1{margin:0;font-size:1.6rem}
    .search-bar{max-width:640px;margin:18px auto 0;display:flex;background:rgba(255,255,255,0.06);border-radius:12px;padding:12px 16px;border:1px solid rgba(255,255,255,0.08)}
    .search-bar input{flex:1;border:none;background:transparent;color:var(--muted);font-size:1rem;outline:none}
    main{max-width:1280px;margin:0 auto;padding:30px;position:relative;z-index:2}
    .controls-row{display:flex;gap:12px;align-items:center;justify-content:center;margin-bottom:18px}
    .controls-row input[type="text"]{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:rgba(255,255,255,0.02);color:var(--muted)}
    .controls-row button{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}
    section{margin-bottom:60px}
    .section-header{text-align:center;margin-bottom:18px;transition:opacity .4s,margin .4s,height .4s}
    .section-header h2{display:inline-block;background:rgba(255,255,255,0.06);padding:6px 14px;border-radius:10px;color:var(--accent)}
    .section-header.hidden{opacity:0;margin:0;height:0;overflow:hidden}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:20px}
    .card{position:relative;background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.06));border:1px solid rgba(255,255,255,0.08);border-radius:12px;padding:20px;backdrop-filter:blur(8px);opacity:0;transform:translateY(40px) scale(.96);transition:opacity .6s cubic-bezier(.2,.9,.2,1),transform .6s cubic-bezier(.2,.9,.2,1)}
    .card.visible{opacity:1;transform:translateY(0) scale(1)}
    .card.hidden{opacity:0;transform:translateY(40px) scale(.96)}
    .card h3{background:rgba(45,212,255,0.06);padding:8px 12px;border-radius:8px;margin:0 0 10px;color:var(--accent)}
    .card .meta{font-size:.9rem;color:rgba(230,250,255,0.9)}
    .card .add-to-toolbox{position:absolute;top:12px;right:12px;width:36px;height:36px;border-radius:8px;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);cursor:pointer;color:var(--accent)}
    .section-actions{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
    .section-actions button{padding:6px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}
    .extras-note{font-size:.9rem;color:rgba(230,250,255,0.7);text-align:center;margin-bottom:12px}
    .mapping-controls{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:8px}
    .mapping-controls button{padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}
    .status{font-size:.9rem;color:rgba(230,250,255,0.7);text-align:center;margin-top:10px}
    /* small responsive */
    @media(max-width:640px){header{padding-top:56px}.toolbox-panel{left:12px;right:12px;width:auto;max-width:calc(100% - 24px)}}
  </style>
</head>
<body>
  <!-- Toolbox toggle/panel -->
  <div class="toolbox-toggle" id="toolboxToggle" title="Open toolbox" role="button" tabindex="0"><span class="plus" aria-hidden="true"></span></div>
  <div class="toolbox-panel" id="toolboxPanel" aria-hidden="true" role="region" aria-label="Toolbox">
    <div class="toolbox-header"><h3>Toolbox</h3>
      <div style="display:flex;gap:8px">
        <button id="clearToolboxBtn">Clear</button>
        <button id="closeToolboxBtn">Close</button>
      </div>
    </div>
    <div class="toolbox-list" id="toolboxList"><div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div></div>
  </div>

  <header>
    <h1>The Most Useful Site in the World</h1>
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search calculators, tools, or topics..." aria-label="Search tools" />
    </div>
  </header>

  <main>
    <div class="controls-row">
      <input id="repoUrl" type="text" value="https://github.com/mrpr0phecy/mrpr0phecy" style="min-width:360px" />
      <input id="branch" type="text" value="main" style="width:120px" />
      <input id="token" type="text" placeholder="Optional GitHub token (for higher rate limits)" style="min-width:260px" />
      <button id="loadBtn">Load cards from GitHub</button>
    </div>

    <div class="status" id="status">Tip: paste your repo URL and press Load. Public repos work without a token.</div>

    <div id="sectionsContainer"></div>
  </main>

  <script>
  /************************************************************************
   * Overview:
   * - Fetches repo tree from GitHub and lists files under cards/
   * - Uses a built-in mapping (your original organized sections)
   * - Any files not in the mapping are placed into "Extras"
   * - UI allows moving files between sections and saves mapping to IndexedDB
   * - Keeps toolbox and animations from previous version
   ************************************************************************/

  // ---------- Utilities ----------
  function qs(sel, ctx=document) { return ctx.querySelector(sel); }
  function qsa(sel, ctx=document) { return Array.from(ctx.querySelectorAll(sel)); }
  function el(tag, props={}, ...children){ const e=document.createElement(tag); Object.assign(e,props); children.forEach(c=>{ if(typeof c==='string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); }); return e; }

  // Parse owner/repo from URL like https://github.com/owner/repo or owner/repo
  function parseRepo(input){
    if(!input) return null;
    input = input.trim();
    try{
      const u = new URL(input);
      const parts = u.pathname.split('/').filter(Boolean);
      if(parts.length >= 2) return { owner: parts[0], repo: parts[1] };
    }catch(e){
      // fallback: owner/repo
      const parts = input.split('/').filter(Boolean);
      if(parts.length === 2) return { owner: parts[0], repo: parts[1] };
    }
    return null;
  }

  // ---------- Default mapping (restored from your lists) ----------
  // This is the authoritative mapping we will use to organize files.
  // If a file from GitHub is not in any of these arrays, it will be placed into "Extras".
  const DEFAULT_SECTIONS = {
    "Finance & Money":[
      "mortgage.html","loan.html","investment.html","retirement.html","budget.html",
      "savings.html","currency.html","tipcalculator.html","compoundinterest.html","tax.html",
      "networth.html","debtpayoff.html","interest.html","salary.html","inflation.html",
      "creditcard.html","roi.html","break-even.html","lease.html","studentloan.html"
    ],
    "Health & Fitness":[
      "calorie.html","waterintake.html","sleep.html","heartrate.html","steps.html",
      "bmi.html","bodyfat.html","idealweight.html","bmr.html","macros.html",
      "tdee.html","onerepmax.html","vo2max.html","targetheartrate.html","bsa.html",
      "waisthip.html","leanbodymass.html","hydration.html","metabolicage.html","fitnessscore.html"
    ],
    "Productivity & Work":[
      "timer.html","unitconverter.html","datecalc.html","timezone.html","percentages.html",
      "discount.html","splitbill.html","workhours.html","projectdeadline.html","focus.html",
      "taskprioritizer.html","meetingplanner.html","salarycompare.html","productivityscore.html","reminder.html",
      "goaltracker.html","habit.html","resume.html","careerpath.html","collaboration.html"
    ],
    "Everyday Life":[
      "recipeconverter.html","shoppinglist.html","fuelcost.html","travel.html","packing.html",
      "mealplanner.html","grocerybudget.html","commute.html","petcare.html","childgrowth.html",
      "gardening.html","household.html","cleaning.html","laundry.html","energy.html",
      "rent.html","moving.html","party.html","gift.html","subscription.html"
    ],
    "Education & Learning":[
      "gpa.html","grade.html","studyplanner.html","quiz.html","equation.html",
      "readingtime.html","flashcards.html","essay.html","citation.html","plagiarism-check.html",
      "languages.html","memorization.html","science.html","maths.html","history.html",
      "geography.html","chemistry.html","physics.html","literature.html","exam.html"
    ],
    "English":[
      "grammar-proof.html","essay-templates.html","cv-builder.html","cover-letter.html","proofreading.html",
      "readingtime.html","summary-generator.html","vocabulary-trainer.html","spelling-check.html","punctuation-guide.html",
      "plagiarism-check.html","citation-helper.html","creative-writing.html","business-writing.html","email-templates.html",
      "seo-writing.html","translation-helper.html","readability-score.html","literature-analysis.html","public-speaking.html"
    ],
    "Maths":[
      "algebra.html","calculus.html","geometry.html","trigonometry.html","statistics.html",
      "probability.html","linear-algebra.html","differential-equations.html","number-theory.html","discrete-math.html",
      "graphing.html","equation-solver.html","fractions.html","percentages.html","matrices.html",
      "complex-numbers.html","sequences-series.html","math-practice.html","exam-prep-maths.html","maths-flashcards.html"
    ],
    "Science":[
      "physics-tools.html","chemistry.html","biology-tools.html","lab-planner.html","unit-converter-science.html",
      "formula-library.html","experiment-ideas.html","scientific-method.html","ecology.html","astronomy.html",
      "geology.html","anatomy.html","genetics.html","microbiology.html","thermodynamics.html",
      "optics.html","materials-science.html","environmental-science.html","science-quiz.html","lab-safety.html",
      "electricity.html"
    ],
    "Electricity":[
      "circuit-calculator.html","wire-gauge.html","voltage-drop.html","ohms-law.html","power-calculator.html",
      "resistor-color-code.html","capacitor-calculator.html","inductance-calculator.html","pcb-trace-width.html","load-calculator.html",
      "breaker-sizing.html","conduit-sizing.html","motor-startup.html","battery-sizing.html","solar-panel-calculator.html",
      "inverter-sizing.html","lighting-design.html","earthing-calculator.html","cable-length.html","electrical-standards.html"
    ],
    "Music":[
      "tuner.html","metronome.html","chord-finder.html","scale-trainer.html","ear-trainer.html",
      "practice-tracker.html","sheet-music.html","chord-progression.html","rhythm-generator.html","tempo-map.html",
      "music-theory.html","song-writer.html","bpm-counter.html","interval-trainer.html","transposer.html",
      "capo-calculator.html","instrument-care.html","recording-basics.html","mixing-basics.html","music-quiz.html"
    ]
  };

  // ---------- IndexedDB wrapper for saved mapping (so organization persists) ----------
  const DB_NAME = 'toolbox_org_db_v1';
  const DB_STORE = 'mappings';
  function openDB(){ return new Promise((resolve,reject)=>{
    const r = indexedDB.open(DB_NAME,1);
    r.onupgradeneeded = ()=> r.result.createObjectStore(DB_STORE,{keyPath:'id'});
    r.onsuccess = ()=> resolve(r.result);
    r.onerror = ()=> reject(r.error);
  });}
  async function saveMapping(id, mapping){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(DB_STORE,'readwrite');
      tx.objectStore(DB_STORE).put({id,mapping,ts:Date.now()});
      tx.oncomplete = ()=> res();
      tx.onerror = ()=> rej(tx.error);
    });
  }
  async function loadMapping(id){
    const db = await openDB();
    return new Promise((res,rej)=>{
      const tx = db.transaction(DB_STORE,'readonly');
      const req = tx.objectStore(DB_STORE).get(id);
      req.onsuccess = ()=> res(req.result ? req.result.mapping : null);
      req.onerror = ()=> rej(req.error);
    });
  }

  // ---------- GitHub tree fetch ----------
  async function fetchRepoTree(owner, repo, branch='main', token=''){
    const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
    const headers = token ? { Authorization: 'token '+token } : {};
    const r = await fetch(url, { headers });
    if(!r.ok) throw new Error('GitHub API error: '+r.status+' '+r.statusText);
    return r.json(); // contains .tree array
  }

  // ---------- Build sections from repo files ----------
  // Strategy:
  // 1. Get all files under cards/ from the repo tree
  // 2. Compare against DEFAULT_SECTIONS; if a file is listed in a default section, assign it there
  // 3. Any files not matched go into "Extras"
  // 4. If a saved mapping exists in IndexedDB for this repo, use that instead (user customizations)
  async function buildAndRender(owner, repo, branch, token){
    setStatus('Fetching repo tree...');
    try{
      const data = await fetchRepoTree(owner, repo, branch, token);
      const all = (data.tree || []).filter(i => i.path && i.path.startsWith('cards/') && i.path.endsWith('.html')).map(i => i.path.replace(/^cards\//,''));
      setStatus(`Found ${all.length} card files in cards/`);
      // load saved mapping if any
      const mapId = `${owner}/${repo}@${branch}`;
      const saved = await loadMapping(mapId);
      let sections = saved ? saved : JSON.parse(JSON.stringify(DEFAULT_SECTIONS)); // clone
      // ensure all default files are present in sections (we'll remove missing later)
      // create a set of assigned files
      const assigned = new Set();
      Object.values(sections).forEach(arr => arr.forEach(f => assigned.add(f)));
      // Add any repo files that are not assigned into Extras
      const extras = all.filter(f => !assigned.has(f));
      if(extras.length){
        sections['Extras'] = (sections['Extras'] || []).concat(extras);
      }
      // Remove any files from sections that are not present in repo (stale)
      Object.keys(sections).forEach(sec=>{
        sections[sec] = sections[sec].filter(f => all.includes(f));
      });
      // Render UI
      renderSections(sections, mapId);
      setStatus('Rendered sections. You can move files between sections and Save mapping.');
    }catch(err){
      console.error(err);
      setStatus('Error fetching repo tree: '+err.message);
    }
  }

  // ---------- Render sections UI ----------
  function renderSections(sectionsObj, mapId){
    const container = qs('#sectionsContainer');
    container.innerHTML = '';
    // top controls for mapping save/load
    const top = el('div',{className:'mapping-controls'},
      el('button',{onclick:()=> saveCurrentMapping(mapId)}, 'Save mapping locally'),
      el('button',{onclick:()=> loadSavedMapping(mapId)}, 'Reload saved mapping'),
      el('button',{onclick:()=> resetToDefault(mapId)}, 'Reset to default mapping')
    );
    container.appendChild(top);

    Object.entries(sectionsObj).forEach(([sectionName, files])=>{
      const sec = el('section');
      const header = el('div',{className:'section-header'}, el('h2',{}, sectionName));
      sec.appendChild(header);

      const actions = el('div',{className:'section-actions'},
        el('button',{onclick:()=> moveAllTo(sectionName, sectionsObj)}, 'Collect all'),
        el('button',{onclick:()=> downloadSectionList(sectionName, files)}, 'Export list')
      );
      sec.appendChild(actions);

      if(sectionName === 'Extras'){
        sec.appendChild(el('div',{className:'extras-note'}, 'Files not matched to any section are placed here. You can move them into sections.'));
      }

      const grid = el('div',{className:'grid'});
      files.forEach((file, idx)=>{
        const card = el('article',{className:'card hidden',dataset:{name:file,file:file}});
        const addBtn = el('div',{className:'add-to-toolbox',title:'Add to toolbox',onclick:(e)=>{ e.stopPropagation(); addToToolbox({name:file.replace('.html',''), file}); }}, el('span',{className:'plus'}));
        const title = el('h3',{}, file.replace('.html',''));
        const meta = el('div',{className:'meta'}, file);
        const moveBtn = el('button',{onclick:(e)=>{ e.stopPropagation(); promptMove(file, sectionName); }}, 'Move');
        const openBtn = el('button',{onclick:(e)=>{ e.stopPropagation(); window.open('cards/'+file,'_blank'); }}, 'Open');
        const controls = el('div',{}, moveBtn, openBtn);
        card.appendChild(addBtn);
        card.appendChild(title);
        card.appendChild(meta);
        card.appendChild(controls);
        grid.appendChild(card);

        // IntersectionObserver for fly-in
        const io = new IntersectionObserver(entries=>{
          entries.forEach(entry=>{
            if(entry.isIntersecting){ setTimeout(()=>card.classList.add('visible'), idx*40); card.classList.remove('hidden'); io.unobserve(card); }
          });
        },{threshold:0.1});
        io.observe(card);
      });

      sec.appendChild(grid);
      container.appendChild(sec);
    });

    // store current sections in a global for move operations
    window.__currentSections = sectionsObj;
  }

  // ---------- Move / mapping helpers ----------
  function promptMove(file, fromSection){
    // simple prompt UI to choose destination
    const sections = Object.keys(window.__currentSections || {});
    const dest = prompt('Move "'+file+'" from "'+fromSection+'" to which section? Available: '+sections.join(', '), sections[0] || '');
    if(!dest) return;
    moveFile(file, fromSection, dest);
  }
  function moveFile(file, from, to){
    const sections = window.__currentSections;
    if(!sections) return;
    if(!sections[to]) sections[to] = [];
    // remove from source
    sections[from] = sections[from].filter(f=>f!==file);
    // avoid duplicates
    if(!sections[to].includes(file)) sections[to].push(file);
    renderSections(sections, window.__mapId || 'local');
  }
  function moveAllTo(sectionName, sectionsObj){
    // collect all files from all sections into sectionName
    const all = [];
    Object.entries(sectionsObj).forEach(([k,arr])=>{ if(k!==sectionName) { all.push(...arr); sectionsObj[k]=[]; }});
    sectionsObj[sectionName] = (sectionsObj[sectionName]||[]).concat(all);
    renderSections(sectionsObj, window.__mapId || 'local');
  }
  function downloadSectionList(name, files){
    const blob = new Blob([files.join('\n')], {type:'text/plain'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download = name.replace(/\s+/g,'_') + '_list.txt'; a.click(); URL.revokeObjectURL(url);
  }

  // ---------- Save / load mapping to IndexedDB ----------
  async function saveCurrentMapping(mapId){
    const sections = window.__currentSections;
    if(!sections) return alert('Nothing to save');
    try{
      await saveMapping(mapId, sections);
      setStatus('Mapping saved locally.');
    }catch(e){ setStatus('Error saving mapping: '+e.message); }
  }
  async function loadSavedMapping(mapId){
    try{
      const saved = await loadMapping(mapId);
      if(!saved) return setStatus('No saved mapping found for this repo.');
      renderSections(saved, mapId);
      setStatus('Loaded saved mapping.');
    }catch(e){ setStatus('Error loading mapping: '+e.message); }
  }
  async function resetToDefault(mapId){
    if(!confirm('Reset mapping to default organization?')) return;
    const copy = JSON.parse(JSON.stringify(DEFAULT_SECTIONS));
    await saveMapping(mapId, copy);
    renderSections(copy, mapId);
    setStatus('Reset to default mapping and saved locally.');
  }

  // ---------- Status helper ----------
  function setStatus(s){ qs('#status').textContent = s; }

  // ---------- Toolbox (simple local version reused) ----------
  const TOOLBOX_KEY = 'custom_toolbox_v1';
  function loadToolbox(){ try{ return JSON.parse(localStorage.getItem(TOOLBOX_KEY) || '[]'); }catch(e){return [];} }
  function saveToolbox(items){ try{ localStorage.setItem(TOOLBOX_KEY, JSON.stringify(items)); }catch(e){} }
  let toolboxItems = loadToolbox();
  function renderToolbox(){
    const list = qs('#toolboxList'); list.innerHTML = '';
    if(!toolboxItems.length){ list.innerHTML = '<div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div>'; return; }
    toolboxItems.forEach((it, idx)=>{
      const item = el('div',{className:'toolbox-item'}, el('div',{}, el('div',{style:'width:36px;height:36px;border-radius:6px;background:rgba(255,255,255,0.02);display:flex;align-items:center;justify-content:center;color:var(--accent);font-weight:600'}, it.name.charAt(0).toUpperCase()), el('div',{}, el('div',{style:'font-weight:600'}, it.name), el('div',{style:'font-size:.82rem;color:rgba(230,250,255,0.65)'}, it.file) )), el('div',{}, el('button',{onclick:()=>window.open('cards/'+it.file,'_blank')}, 'Open'), el('button',{onclick:()=>{ toolboxItems.splice(idx,1); saveToolbox(toolboxItems); renderToolbox(); }}, 'Remove') ) );
      list.appendChild(item);
    });
  }
  function addToToolbox(item){
    if(toolboxItems.some(i=>i.file===item.file)){ flashToolbox(); return; }
    toolboxItems.unshift(item); if(toolboxItems.length>60) toolboxItems.length=60; saveToolbox(toolboxItems); renderToolbox(); openToolbox();
  }
  function clearToolbox(){ if(!confirm('Clear toolbox?')) return; toolboxItems=[]; saveToolbox(toolboxItems); renderToolbox(); }
  function openToolbox(){ qs('#toolboxPanel').classList.add('open'); qs('#toolboxPanel').setAttribute('aria-hidden','false'); }
  function closeToolbox(){ qs('#toolboxPanel').classList.remove('open'); qs('#toolboxPanel').setAttribute('aria-hidden','true'); }
  function toggleToolbox(){ qs('#toolboxPanel').classList.toggle('open'); qs('#toolboxPanel').setAttribute('aria-hidden', qs('#toolboxPanel').classList.contains('open') ? 'false' : 'true'); }
  function flashToolbox(){ openToolbox(); setTimeout(()=>closeToolbox(),900); }

  // wire toolbox UI
  qs('#toolboxToggle').addEventListener('click', toggleToolbox);
  qs('#clearToolboxBtn').addEventListener('click', clearToolbox);
  qs('#closeToolboxBtn').addEventListener('click', closeToolbox);
  renderToolbox();

  // ---------- Load button handler ----------
  qs('#loadBtn').addEventListener('click', async ()=>{
    const repoVal = qs('#repoUrl').value.trim();
    const branch = qs('#branch').value.trim() || 'main';
    const token = qs('#token').value.trim();
    const parsed = parseRepo(repoVal);
    if(!parsed) return setStatus('Invalid repo URL. Use https://github.com/owner/repo or owner/repo');
    setStatus('Loading repo tree...');
    window.__mapId = `${parsed.owner}/${parsed.repo}@${branch}`;
    try{
      await buildAndRender(parsed.owner, parsed.repo, branch, token);
    }catch(e){ setStatus('Error: '+e.message); }
  });

  // quick load default repo if user pasted earlier
  // (user provided https://github.com/mrpr0phecy/mrpr0phecy)
  (function tryAutoLoad(){
    const defaultRepo = 'https://github.com/mrpr0phecy/mrpr0phecy';
    qs('#repoUrl').value = defaultRepo;
    // do not auto-load; wait for user to press Load to avoid accidental API calls
  })();

  // search input filters displayed cards (client-side)
  const searchInput = qs('#searchInput');
  function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }
  const doFilter = debounce(()=>{
    const q = (searchInput.value||'').trim().toLowerCase();
    document.querySelectorAll('.card').forEach(c=>{
      const name = (c.dataset.name||'').toLowerCase();
      const text = (c.textContent||'').toLowerCase();
      const show = !q || name.includes(q) || text.includes(q);
      c.style.display = show ? '' : 'none';
    });
    // collapse empty sections
    document.querySelectorAll('section').forEach(sec=>{
      const visible = Array.from(sec.querySelectorAll('.card')).some(c=>c.style.display !== 'none');
      const header = sec.querySelector('.section-header');
      if(header) header.classList.toggle('hidden', !visible);
    });
  },160);
  searchInput.addEventListener('input', doFilter);
  searchInput.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ searchInput.value=''; doFilter(); } });

  // small helpers for open/close outside clicks
  document.addEventListener('click', (e)=>{ if(!qs('#toolboxPanel').contains(e.target) && !qs('#toolboxToggle').contains(e.target)) closeToolbox(); });

  // helper to set status initially
  setStatus('Ready. Paste your repo URL and press Load to organize cards. Any unmatched files will appear in Extras.');

  </script>
</body>
</html>
