<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Most Useful Site in the World</title>
  <style>
    :root{
      --accent:#2dd4ff;
      --muted:#e6faff;
      --panel-bg: rgba(255,255,255,0.04);
    }
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,sans-serif;
      background:linear-gradient(-45deg,#0b0f1a,#1a1f2b,#2a2f3b,#1a1f2b);
      background-size:400% 400%;
      animation:gradientShift 20s ease infinite;
      color:var(--muted);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    @keyframes gradientShift {
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    /* faint background logo overlay */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      z-index:0;
      background-image:url("/logo.png");
      background-repeat:no-repeat;
      background-position:center;
      background-size:min(48vw,520px);
      opacity:0.06;
      filter:blur(0.6px);
      mix-blend-mode:screen;
      animation:logoDrift 24s ease-in-out infinite;
    }
    @keyframes logoDrift {
      0%{transform:translate3d(0,0,0)}
      50%{transform:translate3d(0,-10px,0)}
      100%{transform:translate3d(0,0,0)}
    }

    header, main, footer { position: relative; z-index: 2; }

    /* Toolbox toggle and panel */
    .toolbox-toggle{
      position:fixed; top:18px; left:18px;
      width:44px; height:44px; border-radius:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.02));
      border:1px solid rgba(255,255,255,0.08);
      display:flex; align-items:center; justify-content:center;
      cursor:pointer; backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(0,0,0,0.45);
      transition:transform .18s ease; z-index:6;
    }
    .toolbox-toggle:active{ transform:scale(.96) }
    .toolbox-toggle .plus{ width:18px; height:18px; position:relative; }
    .toolbox-toggle .plus::before, .toolbox-toggle .plus::after{
      content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:var(--accent); border-radius:2px;
    }
    .toolbox-toggle .plus::before{ width:2px; height:14px; }
    .toolbox-toggle .plus::after{ width:14px; height:2px; }

    .toolbox-panel{
      position:fixed; top:18px; left:74px;
      width:360px; max-width:calc(100% - 110px);
      background: linear-gradient(180deg, rgba(10,12,16,0.88), rgba(10,12,16,0.78));
      border:1px solid rgba(255,255,255,0.06); border-radius:12px; padding:12px;
      box-shadow: 0 12px 40px rgba(0,0,0,0.6);
      transform-origin:left top; transform:translateY(-8px) scale(.98);
      opacity:0; pointer-events:none; transition:opacity .26s, transform .26s; z-index:5;
      backdrop-filter: blur(8px) saturate(1.05);
    }
    .toolbox-panel.open{ transform:translateY(0) scale(1); opacity:1; pointer-events:auto; }
    .toolbox-header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
    .toolbox-header h3{ margin:0; color:var(--accent); font-size:0.95rem; }
    .toolbox-list{ max-height:320px; overflow:auto; padding-right:6px; }
    .toolbox-item{ display:flex; align-items:center; justify-content:space-between; padding:8px; border-radius:8px; background:var(--panel-bg); margin-bottom:8px; font-size:0.92rem; color:var(--muted); }
    .toolbox-item .meta{ display:flex; gap:10px; align-items:center; }
    .toolbox-item .dot{ width:36px; height:36px; border-radius:8px; background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.03)); display:flex; align-items:center; justify-content:center; color:var(--accent); font-weight:600; }
    .toolbox-actions button{ background:transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted); padding:6px 8px; border-radius:8px; cursor:pointer; }

    /* Header & search */
    header{ text-align:center; padding:72px 20px 28px; }
    header h1{ margin:0; font-size:1.6rem; letter-spacing:0.2px; }
    .search-bar{ max-width:820px; margin:18px auto 0; display:flex; background:rgba(255,255,255,0.06); border-radius:12px; padding:12px 16px; border:1px solid rgba(255,255,255,0.08); }
    .search-bar input{ flex:1; border:none; background:transparent; color:var(--muted); font-size:1rem; outline:none; }

    main{ max-width:1280px; margin:0 auto; padding:30px; position:relative; z-index:2; }
    .controls{ display:flex; gap:10px; justify-content:center; margin-bottom:12px; flex-wrap:wrap; }
    .controls input[type="text"]{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:rgba(255,255,255,0.02); color:var(--muted); }
    .controls button{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--muted); cursor:pointer; }

    /* Grid of cards (flat) */
    .grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(300px,1fr)); gap:22px; align-items:start; }
    .card{
      position:relative;
      background:linear-gradient(135deg,rgba(255,255,255,0.03),rgba(255,255,255,0.06));
      background-size:200% 200%;
      animation:cardGradientShift 12s ease infinite;
      border:1px solid rgba(255,255,255,0.08);
      border-radius:12px;
      padding:20px;
      backdrop-filter:blur(8px);
      overflow:hidden;
      opacity:0;
      transform:translateY(40px) scale(0.96);
      transition:opacity .7s cubic-bezier(.2,.9,.2,1), transform .7s cubic-bezier(.2,.9,.2,1);
    }
    .card.visible{ opacity:1; transform:translateY(0) scale(1); }
    .card.hidden{ opacity:0; transform:translateY(40px) scale(0.96); }
    @keyframes cardGradientShift { 0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%} }

    .card h3{ background:rgba(45,212,255,0.06); padding:8px 12px; border-radius:8px; margin:0 0 10px; color:var(--accent); display:inline-block; }
    .card .meta{ font-size:.9rem; color:rgba(230,250,255,0.9); margin-bottom:10px; }
    .card .add-to-toolbox{ position:absolute; top:12px; right:12px; width:36px; height:36px; border-radius:8px; display:flex; align-items:center; justify-content:center; background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06); cursor:pointer; color:var(--accent); }
    .card .add-to-toolbox .plus{ width:14px; height:14px; position:relative; }
    .card .add-to-toolbox .plus::before, .card .add-to-toolbox .plus::after{ content:""; position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:var(--accent); border-radius:1px; }
    .card .add-to-toolbox .plus::before{ width:2px; height:12px; } .card .add-to-toolbox .plus::after{ width:12px; height:2px; }

    .card .actions{ display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .card .actions button{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--muted); cursor:pointer; }

    .status{ text-align:center; color:rgba(230,250,255,0.7); margin-top:12px; font-size:.95rem; }

    @media (max-width:640px){
      header{ padding-top:56px; }
      .toolbox-panel{ left:12px; right:12px; width:auto; max-width:calc(100% - 24px); }
    }
  </style>
</head>
<body>
  <!-- Toolbox toggle and panel -->
  <div class="toolbox-toggle" id="toolboxToggle" role="button" aria-label="Open toolbox" title="Open toolbox" tabindex="0">
    <span class="plus" aria-hidden="true"></span>
  </div>

  <div class="toolbox-panel" id="toolboxPanel" aria-hidden="true" role="region" aria-label="Toolbox">
    <div class="toolbox-header">
      <h3>Toolbox</h3>
      <div class="toolbox-actions">
        <button id="clearToolboxBtn" title="Clear toolbox">Clear</button>
        <button id="closeToolboxBtn" title="Close">Close</button>
      </div>
    </div>
    <div class="toolbox-list" id="toolboxList">
      <div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div>
    </div>
  </div>

  <header>
    <h1>The Most Useful Site in the World</h1>
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search any card (name or loaded content)..." aria-label="Search tools" />
    </div>
  </header>

  <main>
    <div class="controls">
      <!-- repo is kept only in JS; no visible repo string on the page -->
      <input id="branch" type="text" value="main" style="width:120px" />
      <input id="token" type="text" placeholder="Optional GitHub token (for higher rate limits)" style="min-width:260px" />
      <button id="loadBtn">Load all cards</button>
      <button id="sortAlphaBtn" title="Sort alphabetically">Sort A→Z</button>
      <button id="sortRandomBtn" title="Random order">Random</button>
    </div>

    <div class="status" id="status">Initializing and auto-loading cards from the configured source...</div>

    <div id="gridContainer" class="grid" aria-live="polite" aria-busy="false"></div>
  </main>

  <script>
    /* ---------- Configuration (hidden from UI) ----------
       DEFAULT_REPO is used internally to fetch the cards list.
       It is not displayed anywhere on the page.
    */
    const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy'; // owner/repo (kept internal)

    /* ---------- Utilities ---------- */
    const qs = (s, ctx=document) => ctx.querySelector(s);
    const qsa = (s, ctx=document) => Array.from(ctx.querySelectorAll(s));
    const el = (tag, props={}, ...children) => {
      const e = document.createElement(tag);
      Object.entries(props||{}).forEach(([k,v])=>{
        if(k === 'className') e.className = v;
        else if(k === 'dataset') Object.entries(v).forEach(([dk,dv])=> e.dataset[dk]=dv);
        else e.setAttribute(k, v);
      });
      children.forEach(c => { if(typeof c === 'string') e.appendChild(document.createTextNode(c)); else if(c) e.appendChild(c); });
      return e;
    };

    function parseOwnerRepo(str){
      const parts = (str||'').split('/').filter(Boolean);
      if(parts.length === 2) return { owner: parts[0], repo: parts[1] };
      return null;
    }

    function shuffleArray(a){
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i],a[j]] = [a[j],a[i]];
      }
      return a;
    }

    function setStatus(msg){
      qs('#status').textContent = msg;
    }

    /* ---------- GitHub tree fetch (internal only) ---------- */
    async function fetchRepoTree(owner, repo, branch='main', token=''){
      const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
      const headers = token ? { Authorization: 'token '+token } : {};
      const r = await fetch(url, { headers });
      if(!r.ok) throw new Error('GitHub API error: '+r.status+' '+r.statusText);
      return r.json();
    }

    async function getCardFilesFromRepo(owner, repo, branch='main', token=''){
      const data = await fetchRepoTree(owner, repo, branch, token);
      const files = (data.tree || [])
        .filter(item => item.path && item.path.startsWith('cards/') && item.path.endsWith('.html'))
        .map(item => item.path.replace(/^cards\//,''));
      return files;
    }

    /* ---------- Render flat grid ---------- */
    const grid = qs('#gridContainer');

    function clearGrid(){
      grid.innerHTML = '';
    }

    // create a card element (loads preview from relative path when available)
    function createCardElement(file){
      const card = el('article', { className: 'card', dataset: { name: file.replace('.html',''), file } });
      card.innerHTML = `
        <div class="add-to-toolbox" title="Add to toolbox" role="button" aria-label="Add ${file.replace('.html','')} to toolbox">
          <span class="plus" aria-hidden="true"></span>
        </div>
        <h3>${escapeHtml(file.replace('.html',''))}</h3>
        <div class="meta">${escapeHtml(file)}</div>
        <div class="actions">
          <button class="open">Open</button>
          <button class="load">Load preview</button>
        </div>
      `;
      // add handlers
      const addBtn = card.querySelector('.add-to-toolbox');
      addBtn.addEventListener('click', (ev) => { ev.stopPropagation(); addToToolbox({ name: file.replace('.html',''), file }); });

      card.querySelector('.open').addEventListener('click', (ev) => {
        ev.stopPropagation();
        // open relative path so repo name is not shown on the page
        window.open('cards/' + file, '_blank');
      });

      card.querySelector('.load').addEventListener('click', async (ev) => {
        ev.stopPropagation();
        await loadCardContentInto(card, file);
      });

      // lazy load preview when card enters viewport (but keep load button too)
      const io = new IntersectionObserver(entries=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            // staggered reveal
            setTimeout(()=>card.classList.add('visible'), 40);
            io.unobserve(card);
            // attempt to fetch a small preview automatically (non-blocking)
            loadCardContentInto(card, file, { auto: true }).catch(()=>{});
          }
        });
      }, { threshold: 0.08 });
      io.observe(card);

      return card;
    }

    async function loadCardContentInto(card, file, opts={ auto:false }){
      // if already loaded, skip
      if(card.dataset.loaded === 'true') return;
      const relativeUrl = 'cards/' + file;
      try{
        const r = await fetch(relativeUrl);
        if(!r.ok) throw new Error('Failed to fetch card preview from cards/' + file);
        const html = await r.text();
        // sanitize minimal: strip <script> tags to avoid execution
        const sanitized = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
        const contentWrapper = document.createElement('div');
        contentWrapper.className = 'card-content';
        contentWrapper.innerHTML = sanitized;
        const existing = card.querySelector('.card-content');
        if(existing) existing.remove();
        card.appendChild(contentWrapper);
        card.dataset.loaded = 'true';
        // re-run search filter so newly loaded text is considered
        applySearchFilter(currentQuery);
      }catch(err){
        // If relative fetch fails, do not expose repo; show a neutral message
        if(!opts.auto){
          alert('Could not load card preview. The file may not be available locally.');
        }
      }
    }

    /* ---------- Search ---------- */
    let currentFiles = []; // current displayed filenames
    let currentQuery = '';

    function applySearchFilter(q){
      currentQuery = (q||'').trim().toLowerCase();
      grid.querySelectorAll('.card').forEach(card=>{
        const name = (card.dataset.name||'').toLowerCase();
        const text = (card.textContent||'').toLowerCase();
        const matches = !currentQuery || name.includes(currentQuery) || text.includes(currentQuery);
        card.style.display = matches ? '' : 'none';
      });
      // update status
      const visible = Array.from(grid.querySelectorAll('.card')).filter(c=>c.style.display !== 'none').length;
      setStatus(`Showing ${visible} of ${currentFiles.length} cards${currentQuery ? ' (filtered)' : ''}.`);
    }

    const debouncedSearch = debounce((e)=>{
      applySearchFilter(e.target.value);
    }, 160);

    qs('#searchInput').addEventListener('input', debouncedSearch);
    qs('#searchInput').addEventListener('keydown', (e)=>{ if(e.key === 'Escape'){ qs('#searchInput').value=''; applySearchFilter(''); } });

    /* ---------- Load & render flow (alphabetical by default) ----------
       Uses DEFAULT_REPO internally; the repo string is not shown anywhere in the UI.
    */
    async function loadAndRenderAll(branch, token, sortMode='alpha'){
      const parsed = parseOwnerRepo(DEFAULT_REPO);
      if(!parsed) return setStatus('Configuration error: source not available.');
      setStatus('Fetching file list...');
      qs('#gridContainer').setAttribute('aria-busy','true');
      try{
        const files = await getCardFilesFromRepo(parsed.owner, parsed.repo, branch, token);
        if(!files.length) { setStatus('No cards/*.html files found under cards/'); qs('#gridContainer').setAttribute('aria-busy','false'); return; }

        // sort according to mode
        if(sortMode === 'alpha'){
          files.sort((a,b)=> a.localeCompare(b, undefined, { sensitivity: 'base', numeric: true }));
        } else {
          shuffleArray(files);
        }

        currentFiles = files.slice();
        clearGrid();
        // create elements and append
        files.forEach((file, idx) => {
          const cardEl = createCardElement(file);
          grid.appendChild(cardEl);
        });
        setStatus(`Loaded ${files.length} cards.`);
        applySearchFilter(qs('#searchInput').value);
      }catch(err){
        console.error(err);
        setStatus('Error loading cards. Check network or token and try again.');
      } finally {
        qs('#gridContainer').setAttribute('aria-busy','false');
      }
    }

    qs('#loadBtn').addEventListener('click', ()=>{
      const branch = qs('#branch').value.trim() || 'main';
      const token = qs('#token').value.trim();
      loadAndRenderAll(branch, token, 'alpha');
    });

    qs('#sortAlphaBtn').addEventListener('click', ()=>{
      const nodes = Array.from(grid.children);
      nodes.sort((a,b)=> a.dataset.name.localeCompare(b.dataset.name, undefined, { sensitivity: 'base', numeric: true }));
      nodes.forEach(n => grid.appendChild(n));
      setStatus('Sorted alphabetically (A→Z).');
    });

    qs('#sortRandomBtn').addEventListener('click', ()=>{
      const nodes = Array.from(grid.children);
      shuffleArray(nodes);
      nodes.forEach(n => grid.appendChild(n));
      setStatus('Shuffled cards (random order).');
    });

    /* ---------- Toolbox (localStorage simple) ---------- */
    const TOOLBOX_KEY = 'custom_toolbox_v1';
    function loadToolbox(){ try{ return JSON.parse(localStorage.getItem(TOOLBOX_KEY) || '[]'); }catch(e){ return []; } }
    function saveToolbox(items){ try{ localStorage.setItem(TOOLBOX_KEY, JSON.stringify(items)); }catch(e){} }
    let toolboxItems = loadToolbox();

    function renderToolbox(){
      const list = qs('#toolboxList'); list.innerHTML = '';
      if(!toolboxItems.length){ list.innerHTML = '<div class="toolbox-empty">No items yet. Add tools by pressing the + on any card.</div>'; return; }
      toolboxItems.forEach((it, idx)=>{
        const item = el('div', { className: 'toolbox-item' },
          el('div', { className: 'meta' },
            el('div', { className: 'dot' }, it.name.charAt(0).toUpperCase()),
            el('div', {}, el('div', { style: 'font-weight:600' }, it.name), el('div', { style: 'font-size:.82rem;color:rgba(230,250,255,0.65)' }, it.file))
          ),
          el('div', {},
            // open relative path so repo name is not shown on the page
            el('button', { onclick: ()=> window.open('cards/' + it.file, '_blank') }, 'Open'),
            el('button', { onclick: ()=> { toolboxItems.splice(idx,1); saveToolbox(toolboxItems); renderToolbox(); } }, 'Remove')
          )
        );
        list.appendChild(item);
      });
    }

    function addToToolbox(item){
      if(toolboxItems.some(i=>i.file === item.file)){ flashToolbox(); return; }
      toolboxItems.unshift(item);
      if(toolboxItems.length > 80) toolboxItems.length = 80;
      saveToolbox(toolboxItems);
      renderToolbox();
      openToolbox();
    }

    function clearToolbox(){ if(!confirm('Clear toolbox?')) return; toolboxItems = []; saveToolbox(toolboxItems); renderToolbox(); }

    function openToolbox(){ qs('#toolboxPanel').classList.add('open'); qs('#toolboxPanel').setAttribute('aria-hidden','false'); }
    function closeToolbox(){ qs('#toolboxPanel').classList.remove('open'); qs('#toolboxPanel').setAttribute('aria-hidden','true'); }
    function toggleToolbox(){ qs('#toolboxPanel').classList.toggle('open'); qs('#toolboxPanel').setAttribute('aria-hidden', qs('#toolboxPanel').classList.contains('open') ? 'false' : 'true'); }
    function flashToolbox(){ openToolbox(); setTimeout(()=> closeToolbox(), 900); }

    qs('#toolboxToggle').addEventListener('click', toggleToolbox);
    qs('#clearToolboxBtn').addEventListener('click', clearToolbox);
    qs('#closeToolboxBtn').addEventListener('click', closeToolbox);
    renderToolbox();

    // close toolbox when clicking outside
    document.addEventListener('click', (e)=>{
      const panel = qs('#toolboxPanel');
      const toggle = qs('#toolboxToggle');
      if(!panel.classList.contains('open')) return;
      if(!panel.contains(e.target) && !toggle.contains(e.target)) closeToolbox();
    });

    /* ---------- Helpers ---------- */
    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function debounce(fn, wait=160){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }; }

    /* ---------- Auto-load on page load (alphabetical by default) ----------
       This attempts to fetch the cards list automatically using DEFAULT_REPO.
       If it fails (network, rate limit), the user can press Load manually or provide a token.
    */
    (function autoLoadDefaultRepo(){
      const defaultBranch = qs('#branch').value.trim() || 'main';
      const token = qs('#token').value.trim();
      loadAndRenderAll(defaultBranch, token, 'alpha').catch(err=>{
        console.warn('Auto-load failed:', err);
        setStatus('Auto-load failed. Press Load to try again or add a token for higher rate limits.');
      });
    })();

    // keyboard accessibility for toolbox toggle
    qs('#toolboxToggle').addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggleToolbox(); } });

  </script>
</body>
</html>
