<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Most Useful Site in the World</title>
<meta name="description" content="The Most Useful Site in the World" />

<style>
  :root{
    /* core */
    --accent: #2dd4ff;
    --muted: #e6faff;
    --text: #e6faff;

    /* background */
    --bg-1: #0f1720;
    --bg-2: #1b2630;

    /* glass / panels */
    --glass: rgba(255,255,255,0.06);
    --glass-strong: rgba(255,255,255,0.08);
    --panel: rgba(20,20,20,0.9);

    /* cards */
    --card-grad-1: rgba(255,255,255,0.04);
    --card-grad-2: rgba(255,255,255,0.07);

    --border: rgba(255,255,255,0.10);
    --shadow: 0 14px 40px rgba(0,0,0,0.6);

    --card-min: 300px;
    --toolbox-width: 360px;
    --toolbox-height: 420px;
  }

  /* base */
  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
    color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  /* static logo */
  body::before{
    content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
    background:url("/logo.png") no-repeat center;background-size:min(50vw,520px);
    opacity:0.06;filter:blur(0.6px);mix-blend-mode:screen;
  }

  header{padding:28px 20px 10px;text-align:center;position:relative;z-index:2}
  header h1{margin:0;font-size:1.8rem;color:var(--accent);letter-spacing:0.2px}

  /* controls */
  .control-btn{position:fixed;bottom:18px;z-index:10000;width:48px;height:48px;border-radius:12px;
    background:var(--glass-strong);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;backdrop-filter:blur(8px);box-shadow:0 6px 20px rgba(0,0,0,0.45);transition:transform .18s,background .18s;
    color:var(--accent);line-height:1;border-radius:10px;}
  .control-btn:hover{transform:scale(1.06)}
  #toolboxToggle{left:18px} #readerToggle{left:78px} #paletteToggle{left:138px}

  /* panels: toolbox is resizable and draggable */
  .panel {
    position:fixed;bottom:74px;z-index:9998;background:var(--panel);border:1px solid var(--border);border-radius:12px;
    padding:10px;box-shadow:var(--shadow);backdrop-filter:blur(12px);transition:opacity .18s ease,transform .18s ease;
    opacity:0;pointer-events:none;
  }
  .panel.open{opacity:1;pointer-events:auto}
  /* toolbox specific */
  #toolboxPanel{
    left:18px;
    width:var(--toolbox-width);
    height:var(--toolbox-height);
    display:flex;
    flex-direction:column;
    resize: both; /* allow native resize as fallback */
    overflow:auto;
  }
  /* draggable titlebar for toolbox */
  .panel-title{
    display:flex;align-items:center;justify-content:space-between;gap:8px;padding:6px 8px;border-radius:8px;margin-bottom:8px;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    cursor:grab;
  }
  .panel-title:active{cursor:grabbing}

  /* palette panel */
  #palettePanel{left:138px;width:420px;padding:12px}

  /* search / controls */
  .search-bar{max-width:920px;margin:14px auto 16px;display:flex;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border-radius:12px;padding:12px 16px;border:1px solid rgba(255,255,255,0.04)}
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}
  .controls{text-align:center;margin-bottom:20px}
  .controls button{margin:0 6px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer;transition:all .18s ease}
  .controls button:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.35)}

  /* grid & cards */
  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--card-min),1fr));gap:20px;padding:20px;align-items:start}
  .card{
    position:relative;perspective:900px;
    min-width:0;
  }

  /* flip container */
  .card-inner{
    position:relative;width:100%;height:100%;
    transform-style:preserve-3d;transition:transform .42s ease;will-change:transform,opacity;
  }
  .card-front,.card-back{
    position:relative;border-radius:12px;padding:16px;
    backface-visibility:hidden; -webkit-backface-visibility:hidden;
    background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
    border:1px solid var(--border);box-shadow:0 6px 18px rgba(0,0,0,0.35);
  }
  .card-front{transform:rotateY(0deg)}
  .card-back{position:absolute;inset:0;transform:rotateY(180deg);display:flex;flex-direction:column;overflow:auto}
  .card.flipped .card-inner{transform:rotateY(180deg)}
  .card.hidden{opacity:0;transform:translateY(8px) scale(.995)}

  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}
  .card .content{contain:layout paint}

  .status{text-align:center;color:rgba(230,250,255,0.85);margin:6px 0 8px;font-size:.95rem}

  /* palette UI */
  .palette-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:10px}
  .palette-role{margin-bottom:8px;font-size:.9rem;color:var(--muted)}
  .swatch{width:36px;height:36px;border-radius:8px;border:2px solid var(--border);cursor:pointer;box-sizing:border-box}
  .swatch.active{outline:2px solid rgba(255,255,255,0.12);transform:scale(1.03)}

  /* toolbox inner layout: allow windows inside toolbox to be resized and dragged */
  .tool-window{
    background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
    border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:12px;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
    resize: both; overflow:auto; min-width:160px; min-height:80px;
    position:relative;
  }
  .tool-window .tw-title{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:8px;cursor:grab}
  .tool-window .tw-title:active{cursor:grabbing}

  /* small helpers */
  .muted{color:var(--muted);font-size:.9rem}
  .tiny{font-size:.82rem;color:rgba(255,255,255,0.6)}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
</style>
</head>
<body>
  <!-- controls -->
  <button id="toolboxToggle" class="control-btn" title="Toolbox"> 
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.4"/><path d="M7 8h10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M7 12h10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
  </button>

  <button id="readerToggle" class="control-btn" title="Reader Mode"> 
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M3 12a3 3 0 0 1 6 0v1a3 3 0 0 0 6 0v-1a3 3 0 0 1 6 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 12v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/><path d="M18 12v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/></svg>
  </button>

  <button id="paletteToggle" class="control-btn" title="Theme"> 
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden><path d="M12 3a9 9 0 1 0 9 9c0-1.1-.9-2-2-2-.9 0-1.6.6-1.9 1.4A3.5 3.5 0 0 1 14 11c-1.9 0-3.5 1.6-3.5 3.5S12.1 18 14 18c.6 0 1.2-.2 1.7-.5.5-.3 1.1-.5 1.8-.5 1.7 0 3 1.3 3 3 0 1.1-.9 2-2 2A9 9 0 0 0 12 3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/><circle cx="9" cy="9" r="1" fill="currentColor"/><circle cx="7" cy="14" r="1" fill="currentColor"/><circle cx="14" cy="7" r="1" fill="currentColor"/></svg>
  </button>

  <!-- palette panel -->
  <div id="palettePanel" class="panel" role="dialog" aria-label="Theme palette">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
      <div style="font-weight:600;color:var(--accent)">Theme editor</div>
      <div class="tiny">Refined palettes for each role</div>
    </div>

    <!-- role selectors -->
    <div style="display:flex;gap:8px;margin-bottom:8px;align-items:center">
      <label class="palette-role">Role</label>
      <select id="paletteRole" style="flex:1;padding:6px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
        <option value="accent">Accent (buttons, headings)</option>
        <option value="background">Background gradient</option>
        <option value="glass">Glass tint</option>
        <option value="panel">Panel tint</option>
        <option value="card">Card highlights</option>
      </select>
    </div>

    <!-- swatches -->
    <div id="roleSwatches" class="palette-grid" aria-hidden="false"></div>

    <!-- custom color input -->
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="customColorInput" type="color" value="#2dd4ff" style="width:44px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent">
      <button id="applyCustom" class="btn-ghost">Apply to role</button>
      <div class="muted">Pick a color and apply it to the selected role</div>
    </div>

    <hr style="border:none;border-top:1px solid rgba(255,255,255,0.04);margin:12px 0">

    <div style="display:flex;gap:8px;align-items:center;justify-content:flex-end">
      <button id="resetTheme" class="btn-ghost">Reset</button>
    </div>
  </div>

  <!-- toolbox panel (draggable + resizable) -->
  <div id="toolboxPanel" class="panel" role="dialog" aria-label="Toolbox">
    <div class="panel-title" id="toolboxTitle">
      <div style="font-weight:600;color:var(--accent)">Toolbox</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="addSampleTool" class="btn-ghost">Add window</button>
        <button id="closeToolbox" class="btn-ghost">Close</button>
      </div>
    </div>

    <div id="toolboxContent" style="padding:6px;display:flex;flex-direction:column;gap:8px">
      <!-- tool windows injected here -->
    </div>
  </div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main role="main">
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search cards..." aria-label="Search cards" />
    </div>

    <div class="controls">
      <button id="sortAlphaBtn">Sort A→Z</button>
      <button id="sortRandomBtn">Random</button>
      <button id="shuffleDealBtn">Re‑deal</button>
    </div>

    <div class="status" id="status">Loading cards...</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
  /* ---------------------------
     THEME: refined palettes per role
     --------------------------- */
  (function(){
    const roleSwatches = document.getElementById('roleSwatches');
    const roleSelect = document.getElementById('paletteRole');
    const customInput = document.getElementById('customColorInput');
    const applyCustom = document.getElementById('applyCustom');
    const resetTheme = document.getElementById('resetTheme');

    // curated swatches for each role (expandable)
    const SWATCHES = {
      accent: ['#2dd4ff','#00bcd4','#7c4dff','#ff6b6b','#ffb86b','#00d084','#ff3b8a','#ffd54f','#00a3ff','#8e44ad','#1abc9c','#f39c12'],
      background: ['#0f1720','#071226','#08131a','#0b1b2a','#071a1f','#08121a','#0b1220','#102030','#081824','#0a1b2b'],
      glass: ['rgba(255,255,255,0.04)','rgba(255,255,255,0.06)','rgba(0,0,0,0.06)','rgba(255,240,230,0.04)','rgba(200,220,255,0.04)'],
      panel: ['rgba(20,20,20,0.9)','rgba(10,12,20,0.92)','rgba(30,18,18,0.9)','rgba(8,12,20,0.92)'],
      card: ['rgba(255,255,255,0.03)','rgba(255,255,255,0.06)','rgba(0,0,0,0.03)','rgba(255,240,230,0.03)']
    };

    // apply a color to a role by updating CSS variables
    function applyRoleColor(role, color){
      const root = document.documentElement;
      switch(role){
        case 'accent':
          root.style.setProperty('--accent', color);
          break;
        case 'background':
          // for background we derive two stops: use color and a darker variant
          root.style.setProperty('--bg-1', color);
          // darken slightly for second stop
          root.style.setProperty('--bg-2', shade(color, -18));
          document.body.style.background = `linear-gradient(135deg, var(--bg-1), var(--bg-2))`;
          break;
        case 'glass':
          root.style.setProperty('--glass', color);
          // stronger glass
          root.style.setProperty('--glass-strong', color.replace('0.','0.12').replace('rgba(','rgba(') || color);
          break;
        case 'panel':
          root.style.setProperty('--panel', color);
          break;
        case 'card':
          // card gradients: two stops derived from color
          root.style.setProperty('--card-grad-1', color);
          root.style.setProperty('--card-grad-2', shade(color, 8));
          break;
      }
      // persist theme fragment
      const saved = JSON.parse(localStorage.getItem('site_theme_v2') || '{}');
      saved[role] = color;
      localStorage.setItem('site_theme_v2', JSON.stringify(saved));
    }

    // small utility to shade hex or rgba (basic)
    function shade(hexOrRgba, percent){
      // handle rgba strings quickly
      if(hexOrRgba.startsWith('rgba')){
        // parse rgba(r,g,b,a)
        const m = hexOrRgba.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
        if(!m) return hexOrRgba;
        let r = parseInt(m[1]), g = parseInt(m[2]), b = parseInt(m[3]);
        r = Math.max(0, Math.min(255, Math.round(r*(100+percent)/100)));
        g = Math.max(0, Math.min(255, Math.round(g*(100+percent)/100)));
        b = Math.max(0, Math.min(255, Math.round(b*(100+percent)/100)));
        return `rgba(${r},${g},${b},${m[4]})`;
      }
      // hex
      let hex = hexOrRgba.replace('#','');
      if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      const num = parseInt(hex,16);
      let r = (num>>16)&255, g=(num>>8)&255, b=num&255;
      r = Math.max(0, Math.min(255, Math.round(r*(100+percent)/100)));
      g = Math.max(0, Math.min(255, Math.round(g*(100+percent)/100)));
      b = Math.max(0, Math.min(255, Math.round(b*(100+percent)/100)));
      return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
    }

    function renderSwatchesForRole(role){
      roleSwatches.innerHTML = '';
      const list = SWATCHES[role] || [];
      list.forEach(c=>{
        const s = document.createElement('div');
        s.className = 'swatch';
        s.style.background = c;
        s.dataset.color = c;
        s.addEventListener('click', ()=> {
          // mark active
          roleSwatches.querySelectorAll('.swatch').forEach(x=>x.classList.remove('active'));
          s.classList.add('active');
          applyRoleColor(role, c);
        });
        roleSwatches.appendChild(s);
      });
    }

    roleSelect.addEventListener('change', ()=> renderSwatchesForRole(roleSelect.value));
    applyCustom.addEventListener('click', ()=> {
      const role = roleSelect.value;
      const color = customInput.value;
      // add to swatches for convenience
      if(!SWATCHES[role]) SWATCHES[role] = [];
      if(!SWATCHES[role].includes(color)) SWATCHES[role].unshift(color);
      renderSwatchesForRole(role);
      // auto-select the new swatch
      const el = roleSwatches.querySelector(`[data-color="${color}"]`);
      if(el){ el.classList.add('active'); }
      applyRoleColor(role, color);
    });

    resetTheme.addEventListener('click', ()=>{
      localStorage.removeItem('site_theme_v2');
      location.reload();
    });

    // load saved theme
    (function loadSaved(){
      const saved = JSON.parse(localStorage.getItem('site_theme_v2') || '{}');
      Object.keys(saved).forEach(role => applyRoleColor(role, saved[role]));
      renderSwatchesForRole(roleSelect.value);
      // mark active if saved
      const savedRole = Object.keys(saved)[0];
      if(savedRole){
        roleSelect.value = savedRole;
        renderSwatchesForRole(savedRole);
        const el = roleSwatches.querySelector(`[data-color="${saved[savedRole]}"]`);
        if(el) el.classList.add('active');
      }
    })();

    // initial render
    renderSwatchesForRole(roleSelect.value);
  })();
  </script>

  <script>
  /* ---------------------------
     MAIN: lazy loading + flip-over sequential reveal + toolbox windows resizable/draggable
     --------------------------- */
  (function(){
    const DEFAULT_REPO='mrpr0phecy/mrpr0phecy';
    const DEFAULT_BRANCH='main';
    const grid = document.getElementById('gridContainer');
    const status = document.getElementById('status');

    function parseOwnerRepo(str){const p=str.split('/');return {owner:p[0],repo:p[1]};}
    async function fetchRepoTree(owner,repo,branch){
      const url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
      const r=await fetch(url); if(!r.ok) throw new Error('GitHub API error: '+r.status); return r.json();
    }
    async function getCardFiles(owner,repo,branch){
      const data=await fetchRepoTree(owner,repo,branch);
      return (data.tree||[]).filter(i=>i.path.startsWith('cards/') && i.path.endsWith('.html')).map(i=>i.path.replace(/^cards\//,''));
    }

    function makeImagesLazy(html){
      return html.replace(/<img\b([^>]*?)>/gi, (match, attrs)=>{
        if(/loading\s*=/.test(attrs)) return `<img${attrs}>`;
        return `<img loading="lazy"${attrs}>`;
      });
    }

    // create flip card structure
    function createCardElement(file){
      const name = file.replace('.html','');
      const wrapper = document.createElement('div');
      wrapper.className = 'card hidden';
      wrapper.dataset.file = file;
      wrapper.dataset.name = name;

      const inner = document.createElement('div');
      inner.className = 'card-inner';

      const front = document.createElement('div');
      front.className = 'card-front';
      front.innerHTML = `<div class="card-header"><h3>${name}</h3><div class="tiny">${file}</div></div><div class="muted tiny">Tap to flip or wait for deal</div>`;

      const back = document.createElement('div');
      back.className = 'card-back';
      back.innerHTML = `<div class="card-header"><h3>${name}</h3><div class="tiny">Details</div></div><div class="content">Loading…</div>`;

      inner.appendChild(front);
      inner.appendChild(back);
      wrapper.appendChild(inner);

      // click to flip manually
      wrapper.addEventListener('click', (e)=>{
        if(wrapper.classList.contains('flipped')) return;
        flipCard(wrapper);
      });

      // lazy load when near viewport
      const io = new IntersectionObserver(entries=>{
        entries.forEach(entry=>{
          if(entry.isIntersecting){
            // prefetch content but do not flip yet
            loadCardContentInto(wrapper, file).catch(()=>{ back.querySelector('.content').textContent = 'Preview unavailable.'; });
            io.unobserve(wrapper);
          }
        });
      },{threshold:0.08, rootMargin:'200px 0px 200px 0px'});
      io.observe(wrapper);

      return wrapper;
    }

    async function loadCardContentInto(wrapper,file){
      if(wrapper.dataset.loaded==='true') return;
      const url = `cards/${file}`;
      try{
        const r = await fetch(url);
        if(!r.ok){ wrapper.querySelector('.card-back .content').textContent = 'Failed to load'; return; }
        let html = await r.text();
        html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
        html = makeImagesLazy(html);
        const content = wrapper.querySelector('.card-back .content');
        content.innerHTML = html;
        wrapper.dataset.loaded = 'true';
      }catch(e){
        wrapper.querySelector('.card-back .content').textContent = 'Failed to load';
      }
    }

    // flip animation: add flipped class and fade-in back content
    function flipCard(wrapper){
      if(wrapper.classList.contains('flipped')) return;
      wrapper.classList.add('flipped');
      // small fade-in for back content
      const backContent = wrapper.querySelector('.card-back .content');
      if(backContent){
        backContent.style.opacity = '0';
        backContent.style.transition = 'opacity .28s ease';
        requestAnimationFrame(()=> backContent.style.opacity = '1');
      }
    }

    // sequential deal: flip one card at a time (short) and reveal
    async function sequentialDeal(){
      const cards = Array.from(grid.querySelectorAll('.card'));
      // ensure all cards are hidden and not flipped
      cards.forEach(c=>{ c.classList.remove('flipped'); c.classList.add('hidden'); });
      // small initial pause
      await wait(80);
      for(let i=0;i<cards.length;i++){
        const c = cards[i];
        // ensure content loaded before flip (prefetch if not)
        const file = c.dataset.file;
        await loadCardContentInto(c, file);
        // remove hidden to allow CSS transitions
        c.classList.remove('hidden');
        // flip
        flipCard(c);
        // wait for flip duration + small pause
        await wait(260); // flip duration ~ 220-260ms
      }
    }

    function wait(ms){ return new Promise(res=>setTimeout(res, ms)); }

    // load dashboard files and render cards
    async function loadDashboard(){
      status.textContent = 'Loading cards…';
      try{
        const {owner,repo} = parseOwnerRepo(DEFAULT_REPO);
        const files = await getCardFiles(owner,repo,DEFAULT_BRANCH);
        if(!files.length){ status.textContent = 'No cards found.'; return; }
        files.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base',numeric:true}));
        grid.innerHTML = '';
        files.forEach(f => grid.appendChild(createCardElement(f)));
        status.textContent = `Loaded ${files.length} cards.`;
        // automatically run a quick sequential deal once
        await wait(120);
        sequentialDeal();
      }catch(e){
        status.textContent = 'Error loading cards.';
      }
    }

    // search/filter
    const searchInput = document.getElementById('searchInput');
    let searchTimer = null;
    searchInput.addEventListener('input', ()=>{
      clearTimeout(searchTimer);
      searchTimer = setTimeout(()=> {
        const q = searchInput.value.trim().toLowerCase();
        const cards = grid.querySelectorAll('.card');
        let visible = 0;
        cards.forEach(c=>{
          const name = (c.dataset.name||'').toLowerCase();
          const text = (c.textContent||'').toLowerCase();
          const show = !q || name.includes(q) || text.includes(q);
          c.style.display = show ? '' : 'none';
          if(show) visible++;
        });
        status.textContent = visible ? `Showing ${visible} cards.` : 'No cards match your search.';
      }, 160);
    });

    // sort & re-deal
    document.getElementById('sortAlphaBtn').addEventListener('click', async ()=>{
      const nodes = Array.from(grid.children);
      nodes.sort((a,b)=>a.dataset.name.localeCompare(b.dataset.name,undefined,{sensitivity:'base',numeric:true}));
      nodes.forEach(n=>grid.appendChild(n));
      await sequentialDeal();
      status.textContent = 'Sorted alphabetically.';
    });
    document.getElementById('sortRandomBtn').addEventListener('click', async ()=>{
      const nodes = Array.from(grid.children);
      for(let i=nodes.length-1;i>0;i--){ const j = Math.floor(Math.random()*(i+1)); [nodes[i],nodes[j]]=[nodes[j],nodes[i]]; }
      nodes.forEach(n=>grid.appendChild(n));
      await sequentialDeal();
      status.textContent = 'Shuffled cards.';
    });
    document.getElementById('shuffleDealBtn').addEventListener('click', sequentialDeal);

    // init
    loadDashboard();

    /* ---------------------------
       Toolbox: add resizable/draggable windows inside toolbox
       --------------------------- */
    const toolboxPanel = document.getElementById('toolboxPanel');
    const toolboxToggle = document.getElementById('toolboxToggle');
    const toolboxTitle = document.getElementById('toolboxTitle');
    const toolboxContent = document.getElementById('toolboxContent');
    const addSampleTool = document.getElementById('addSampleTool');
    const closeToolbox = document.getElementById('closeToolbox');

    toolboxToggle.addEventListener('click', ()=> toolboxPanel.classList.toggle('open'));
    closeToolbox.addEventListener('click', ()=> toolboxPanel.classList.remove('open'));

    // make toolbox draggable by titlebar
    (function makeDraggable(el, handle){
      let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
      handle.addEventListener('pointerdown', e=>{
        dragging=true; handle.setPointerCapture(e.pointerId);
        startX = e.clientX; startY = e.clientY;
        const rect = el.getBoundingClientRect();
        startLeft = rect.left; startTop = rect.top;
        el.style.transition = 'none';
      });
      window.addEventListener('pointermove', e=>{
        if(!dragging) return;
        const dx = e.clientX - startX, dy = e.clientY - startY;
        el.style.left = Math.max(8, startLeft + dx) + 'px';
        el.style.top = Math.max(8, startTop + dy) + 'px';
        el.style.right = 'auto';
        el.style.bottom = 'auto';
      });
      window.addEventListener('pointerup', e=>{
        if(!dragging) return;
        dragging=false;
        el.style.transition = '';
      });
    })(toolboxPanel, toolboxTitle);

    // add a sample tool window
    function createToolWindow(titleText, contentHtml){
      const win = document.createElement('div');
      win.className = 'tool-window';
      win.innerHTML = `<div class="tw-title"><strong>${titleText}</strong><div><button class="btn-ghost tw-close">✕</button></div></div><div class="tw-body">${contentHtml}</div>`;
      // close handler
      win.querySelector('.tw-close').addEventListener('click', ()=> win.remove());
      // make inner title draggable to reorder within toolbox (simple)
      const twTitle = win.querySelector('.tw-title');
      makeDragWithinContainer(win, twTitle, toolboxContent);
      return win;
    }

    // allow dragging windows within toolbox to reorder
    function makeDragWithinContainer(win, handle, container){
      let dragging=false, placeholder=null, startY=0, startIndex=0;
      handle.addEventListener('pointerdown', e=>{
        dragging=true; handle.setPointerCapture(e.pointerId);
        startY = e.clientY;
        placeholder = document.createElement('div');
        placeholder.style.height = win.offsetHeight + 'px';
        placeholder.style.border = '1px dashed rgba(255,255,255,0.06)';
        placeholder.style.marginBottom = '8px';
        startIndex = Array.from(container.children).indexOf(win);
        win.style.opacity = '0.9';
        win.style.position = 'relative';
        win.style.zIndex = 9999;
      });
      window.addEventListener('pointermove', e=>{
        if(!dragging) return;
        const y = e.clientY;
        // find element under pointer
        const children = Array.from(container.children).filter(c=>c!==win);
        let insertBefore = null;
        for(const c of children){
          const r = c.getBoundingClientRect();
          if(y < r.top + r.height/2){ insertBefore = c; break; }
        }
        if(insertBefore) container.insertBefore(placeholder, insertBefore);
        else container.appendChild(placeholder);
      });
      window.addEventListener('pointerup', e=>{
        if(!dragging) return;
        dragging=false;
        win.style.opacity = '';
        win.style.position = '';
        win.style.zIndex = '';
        if(placeholder){
          container.insertBefore(win, placeholder);
          placeholder.remove();
          placeholder = null;
        }
      });
    }

    // add sample tool on click
    addSampleTool.addEventListener('click', ()=>{
      const id = 'Tool ' + (toolboxContent.children.length + 1);
      const win = createToolWindow(id, `<div class="muted">This window is resizable and draggable within the toolbox. Resize by dragging the corner. Content is arbitrary HTML.</div>`);
      toolboxContent.appendChild(win);
    });

    // restore some sample windows if none exist
    if(toolboxContent.children.length === 0){
      toolboxContent.appendChild(createToolWindow('Notes', '<div class="muted">Quick notes window</div>'));
      toolboxContent.appendChild(createToolWindow('Calculator', '<div class="muted">Tiny calculator placeholder</div>'));
    }

    // sortable for grid and toolbox content (reordering)
    new Sortable(grid, {animation:120});
    new Sortable(toolboxContent, {animation:120});

  })();
  </script>
</body>
</html>
