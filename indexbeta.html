<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>The Most Useful Site in the World</title>
<style>
  :root{
    --accent:#2dd4ff;
    --bg-1:#0f1720;
    --bg-2:#1b2630;
    --text:#e6faff;
    --glass: rgba(255,255,255,0.06);
    --border: rgba(255,255,255,0.10);
    --card-grad-1: rgba(255,255,255,0.04);
    --card-grad-2: rgba(255,255,255,0.07);
    --blur:8px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:var(--text);-webkit-font-smoothing:antialiased}
  header{padding:20px;text-align:center}
  header h1{margin:0;color:var(--accent);font-size:1.6rem}
  .control-btn{
    position:fixed;bottom:18px;z-index:14000;width:48px;height:48px;border-radius:10px;
    background:var(--glass);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;backdrop-filter:blur(var(--blur));box-shadow:0 8px 30px rgba(0,0,0,0.45);color:var(--accent);font-size:1.4rem;
  }
  .control-btn:hover{transform:scale(1.06)}
  #toolboxToggle{left:18px}
  #paletteToggle{left:78px}
  #readerToggle{left:138px}
  .palette-panel{
    position:fixed;left:18px;bottom:74px;z-index:13900;background:var(--glass);border:1px solid var(--border);border-radius:12px;
    padding:16px;width:340px;box-shadow:0 16px 40px rgba(0,0,0,0.7);backdrop-filter:blur(var(--blur));
    display:none;color:var(--text);
  }
  .palette-panel.open{display:block}
  .toolbox{
    position:fixed;right:18px;bottom:18px;width:540px;height:440px;z-index:13700;background:var(--glass);
    border:1px solid var(--border);border-radius:12px;box-shadow:0 18px 48px rgba(0,0,0,0.6);display:flex;flex-direction:column;
    overflow:hidden;resize:both;min-width:300px;min-height:200px;backdrop-filter:blur(var(--blur));
  }
  .toolbox.hidden{display:none}
  .toolbox .titlebar{padding:10px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);cursor:grab}
  .toolbox .content{flex:1;position:relative;overflow:auto}
  .widget-wrap{
    position:absolute;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.06);border-radius:10px;
    min-width:180px;min-height:120px;overflow:hidden;resize:both;box-shadow:0 8px 20px rgba(0,0,0,0.4);
    --scale:1;
  }
  .widget-titlebar{padding:8px 10px;display:flex;justify-content:space-between;background:rgba(255,255,255,0.02);cursor:move;user-select:none}
  .widget-titlebar strong{color:var(--accent)}
  .widget-body{padding:12px;font-size:calc(1rem * var(--scale))}
  .widget-close{background:none;border:0;color:#888;cursor:pointer;font-size:1.2rem}
  .search-bar{max-width:1100px;margin:14px auto 16px;display:flex;background:var(--glass);border-radius:12px;padding:12px 16px;border:1px solid var(--border);backdrop-filter:blur(var(--blur))}
  .search-bar input{flex:flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}
  .controls{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .controls button{padding:8px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text);cursor:pointer}
  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;padding:20px}
  .card{
    background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));border:1px solid var(--border);
    border-radius:12px;padding:16px;backdrop-filter:blur(var(--blur));box-shadow:0 8px 24px rgba(0,0,0,0.35);
    opacity:0;transform:translateY(18px);transition:opacity .4s,transform .4s;
  }
  .card.visible{opacity:1;transform:translateY(0)}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}
  .add-to-toolbox{
    width:28px;height:28px;border-radius:8px;background:rgba(255,255,255,0.12);display:flex;align-items:center;justify-content:center;
    font-weight:bold;color:var(--accent);cursor:pointer;font-size:1.1rem;
  }
  .add-to-toolbox:hover{background:rgba(255,255,255,0.22)}
  body.reader-mode .dashboard{grid-template-columns:1fr}
  body.reader-mode .card{padding:24px;background:rgba(0,0,0,0,0.3)}
</style>
</head>
<body>

<!-- Controls -->
<button id="toolboxToggle" class="control-btn" title="Toolbox">Toolbox</button>
<button id="paletteToggle" class="control-btn" title="Theme">Palette</button>
<button id="readerToggle" class="control-btn" title="Reader mode">Reader</button>

<!-- Theme Panel -->
<div id="palettePanel" class="palette-panel">
  <div style="font-weight:700;color:var(--accent);margin-bottom:12px">Theme Studio</div>
  <div style="margin-bottom:14px"><strong>Accent</strong><div style="display:grid;grid-template-columns:repeat(7,1fr);gap:7px;margin-top:6px">
    <div class="palette-color active" data-accent="#2dd4ff" style="background:#2dd4ff;height:34px;border-radius:8px;cursor:pointer"></div>
    <div class="palette-color" data-accent="#ff2d55" style="background:#ff2d55;height:34px;border-radius:8px"></div>
    <div class="palette-color" data-accent="#00ff99" style="background:#00ff99;height:34px;border-radius:8px"></div>
    <div class="palette-color" data-accent="#ffcc00" style="background:#ffcc00;height:34px;border-radius:8px"></div>
    <div class="palette-color" data-accent="#9d4edd" style="background:#9d4edd;height:34px;border-radius:8px"></div>
    <div class="palette-color" data-accent="#ff6ec7" style="background:#ff6ec7;height:34px;border-radius:8px"></div>
    <div class="palette-color" data-accent="#00d4ff" style="background:#00d4ff;height:34px;border-radius:8px"></div>
  </div></div>
  <div style="margin-bottom:14px"><strong>Background</strong><div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:6px">
    <button class="theme-btn active" data-theme="dark">Dark Nebula</button>
    <button class="theme-btn" data-theme="midnight">Midnight</button>
    <button class="theme-btn" data-theme="purple">Purple Void</button>
    <button class="theme-btn" data-theme="matrix">Matrix</button>
    <button class="theme-btn" data-theme="sunset">Sunset</button>
    <button class="theme-btn" data-theme="ocean">Ocean</button>
  </div></div>
  <div style="margin-bottom:14px"><strong>Glass Blur</strong><input type="range" id="glassBlur" min="0" max="30" value="8" style="width:100%"></div>
  <button id="saveThemeBtn" style="width:100%;padding:10px;background:var(--accent);color:#000;border:none;border-radius:8px;font-weight:600;cursor:pointer">Save Theme</button>
</div>

<!-- Toolbox -->
<div id="toolbox" class="toolbox hidden">
  <div class="titlebar" id="toolboxTitle">
    <div style="font-weight:600;color:var(--accent)">Toolbox</div>
    <button id="toolboxClose">X</button>
  </div>
  <div class="content" id="toolboxContent"></div>
</div>

<header><h1>The Most Useful Site in the World</h1></header>
<main>
  <div class="search-bar"><input id="searchInput" placeholder="Search cards..."></div>
  <div class="controls">
    <button id="sortAlphaBtn">A to Z</button>
    <button id="sortRandomBtn">Random</button>
  </div>
  <div id="status" style="text-align:center;color:#888;margin:10px">Loading cards...</div>
  <div id="gridContainer" class="dashboard"></div>
</main>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
const DEFAULT_BRANCH = 'main';
const grid = document.getElementById('gridContainer');
let allCardElements = [];
let filesList = [];
let toolboxItems = [];

// ======================
// CARD LOADING (your original perfect system – untouched)
// ======================
async function fetchRepoTree(o,r,b){const u=`https://api.github.com/repos/${o}/${r}/git/trees/${b}?recursive=1`;const res=await fetch(u);if(!res.ok)throw new Error(res.status);return res.json();}
async function getCardFiles(o,r,b){const d=await fetchRepoTree(o,r,b);return(d.tree||[]).filter(i=>i.path.startsWith('cards/')&&i.path.endsWith('.html')).map(i=>i.path.slice(6));}
function createCardElement(f){
  const name=f.replace('.html','');
  const card=document.createElement('div');card.className='card';card.dataset.file=f;card.dataset.name=name;
  card.innerHTML=`<div class="card-header"><h3>${name}</h3><div class="add-to-toolbox" title="Pin to toolbox">+</div></div><div class="content">Loading…</div>`;
  card.querySelector('.add-to-toolbox').onclick=e=>{e.stopPropagation();addToToolbox(f);};
  return card;
}
async function loadCardContent(card,file){
  try{
    const r=await fetch(`cards/${file}`);if(!r.ok){card.querySelector('.content').textContent='Not found';return;}
    let html=await r.text();
    html=html.replace(/<script[\s\S]*?<\/script>/gi,'');
    html=html.replace(/<img\b([^>]*?)>/gi,(m,a)=>a.includes('loading=')?m:`<img loading="lazy"${a}>`);
    card.querySelector('.content').innerHTML=html;
  }catch{card.querySelector('.content').textContent='Failed';}
}

// Lazy loading (your original bulletproof version – kept 100%)
const observer=new IntersectionObserver(es=>{es.forEach(e=>{if(e.isIntersecting){loadCardContent(e.target,e.target.dataset.file);observer.unobserve(e.target);}})},{rootMargin:'600px'});
function observeCards(){allCardElements.forEach(c=>observer.observe(c));}

// ======================
// TOOLBOX – UNLIMITED CARDS
// ======================
const toolbox=document.getElementById('toolbox');
const toolboxContent=document.getElementById('toolboxContent');
const toolboxToggle=document.getElementById('toolboxToggle');
const toolboxClose=document.getElementById('toolboxClose');

toolboxToggle.onclick(()=>toolbox.classList.toggle('hidden'));
toolboxClose.onclick(()=>toolbox.classList.add('hidden'));

function addToToolbox(file){
  if(toolboxItems.includes(file)) {toolbox.classList.remove('hidden');return;}
  toolboxItems.unshift(file);
  if(toolboxItems.length>50)toolboxItems.pop();
  localStorage.setItem('toolbox_v2',JSON.stringify(toolboxItems));
  renderToolbox();
  toolbox.classList.remove('hidden');
}
function removeFromToolbox(file){
  toolboxItems=toolboxItems.filter(x=>x!==file);
  localStorage.setItem('toolbox_v2',JSON.stringify(toolboxItems));
  renderToolbox();
}
function renderToolbox(){
  toolboxContent.innerHTML='';
  const saved=JSON.parse(localStorage.getItem('toolbox_v2')||'[]');
  toolboxItems=saved;
  if(!toolboxItems.length){
    toolboxContent.innerHTML='<div style="padding:20px;color:#666">Click + on any card to pin it here</div>';
    return;
  }
  toolboxItems.forEach(async file=>{
    const wrap=document.createElement('div');wrap.className='widget-wrap';
    wrap.style.cssText='left:20px;top:20px;width:360px;height:240px';
    wrap.innerHTML=`<div class="widget-titlebar"><strong>${file.replace('.html','')}</strong><button class="widget-close">X</button></div><div class="widget-body">Loading…</div>`;
    wrap.querySelector('.widget-close').onclick=e=>{e.stopPropagation();removeFromToolbox(file);};
    toolboxContent.appendChild(wrap);
    const body=wrap.querySelector('.widget-body');
    const r=await fetch(`cards/${file}`);
    if(r.ok){let h=await r.text();h=h.replace(/<script[\s\S]*?<\/script>/gi,'');body.innerHTML=h;}
    else body.textContent='Failed';
    makeDraggable(wrap,wrap.firstChild);
  });
}
function makeDraggable(el,handle){
  let ox=0,oy=0;
  handle.onpointerdown=e=>{
    if(e.target.tagName==='BUTTON')return;
    ox=e.clientX-parseFloat(el.style.left||0);
    oy=e.clientY-parseFloat(el.style.top||0);
    const move=e=>el.style.cssText+=`;left:${e.clientX-ox}px;top:${e.clientY-oy}px`;
    const up=()=>{window.removeEventListener('pointermove',move);window.removeEventListener('pointerup',up)};
    window.addEventListener('pointermove',move);
    window.addEventListener('pointerup',up);
  };
}

// ======================
// THEME SYSTEM (NEW & BEAUTIFUL)
// ======================
function setAccent(hex){
  document.documentElement.style.setProperty('--accent',hex);
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  document.documentElement.style.setProperty('--glass',`rgba(${r},${g},${b},0.06)`);
  document.documentElement.style.setProperty('--card-grad-1',`rgba(${r+30},${g+30},${b+30},0.04)`);
  document.documentElement.style.setProperty('--card-grad-2',`rgba(${r+60},${g+60},${b+60},0.07)`);
  document.querySelectorAll('.palette-color').forEach(c=>c.classList.toggle('active',c.dataset.accent===hex));
}
document.querySelectorAll('.palette-color').forEach(c=>c.onclick=()=>setAccent(c.dataset.accent));

const themes={
  dark:{bg1:'#0f1720',bg2:'#1b2630'},
  midnight:{bg1:'#0a0e17',bg2:'#16213e'},
  purple:{bg1:'#1a0b2e',bg2:'#2d1b69'},
  matrix:{bg1:'#001a00',bg2:'#003300'},
  sunset:{bg1:'#2c1810',bg2:'#4a1a1a'},
  ocean:{bg1:'#0b1e2d',bg2:'#162b4a'}
};
document.querySelectorAll('.theme-btn').forEach(b=>b.onclick=()=>{
  const t=themes[b.dataset.theme];
  document.documentElement.style.setProperty('--bg-1',t.bg1);
  document.documentElement.style.setProperty('--bg-2',t.bg2);
  document.querySelectorAll('.theme-btn').forEach(x=>x.classList.toggle('active',x===b));
});

document.getElementById('glassBlur').oninput=e=>{
  const v=e.target.value+'px';
  document.documentElement.style.setProperty('--blur',v);
  document.querySelectorAll('.card,.toolbox,.search-bar,.palette-panel').forEach(el=>el.style.backdropFilter=`blur(${v})`);
};

document.getElementById('saveThemeBtn').onclick=()=>{
  const t={
    accent:getComputedStyle(document.documentElement).getPropertyValue('--accent').trim(),
    bg1:getComputedStyle(document.documentElement).getPropertyValue('--bg-1').trim(),
    bg2:getComputedStyle(document.documentElement).getPropertyValue('--bg-2').trim(),
    blur:document.getElementById('glassBlur').value
  };
  localStorage.setItem('mytheme',JSON.stringify(t));
  alert('Theme saved!');
};

// Load saved theme
const saved=localStorage.getItem('mytheme');
if(saved){const t=JSON.parse(saved);setAccent(t.accent||'#2dd4ff');
  document.documentElement.style.setProperty('--bg-1',t.bg1);document.documentElement.style.setProperty('--bg-2',t.bg2);
  document.getElementById('glassBlur').value=t.blur||8;
  document.documentElement.style.setProperty('--blur',(t.blur||8)+'px');
}

// Reader mode
document.getElementById('readerToggle').onclick=()=>document.body.classList.toggle('reader-mode');

// Search
document.getElementById('searchInput').oninput=e=>{
  const q=e.target.value.toLowerCase();
  allCardElements.forEach(c=>c.style.display = c.dataset.name.toLowerCase().includes(q)||c.textContent.toLowerCase().includes(q)?'':'none');
};

// Sort buttons
document.getElementById('sortAlphaBtn').onclick=()=>{ const a=[...grid.children];a.sort((x,y)=>x.dataset.name.localeCompare(y.dataset.name));a.forEach(c=>grid.append(c)); };
document.getElementById('sortRandomBtn').onclick=()=>{ const a=[...grid.children];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}a.forEach(c=>grid.append(c)); };

// ======================
// LOAD EVERYTHING
// ======================
(async()=>{
  try{
    filesList = await getCardFiles(...DEFAULT_REPO.split('/'), DEFAULT_BRANCH);
    filesList.sort();
    filesList.forEach(f=>{const c=createCardElement(f);grid.appendChild(c);allCardElements.push(c);});
    document.getElementById('status').textContent=`${filesList.length} tools loaded`;
    observeCards();
    setTimeout(()=>{allCardElements.forEach((c,i)=>setTimeout(()=>c.classList.add('visible'),i*50))},200);
    renderToolbox();
  }catch(e){
    document.getElementById('status').textContent='Error loading cards – check repo name';
    console.error(e);
  }
})();
</script>
</body>
</html>
