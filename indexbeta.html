<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Most Useful Site in the World</title>
<meta name="description" content="Toolbox with resizable widgets, sequential card reveal, palette and mini slider." />
<style>
  :root{
    --accent:#2dd4ff; --muted:#e6faff; --text:#e6faff;
    --bg-1:#0f1720; --bg-2:#1b2630;
    --glass: rgba(255,255,255,0.06);
    --panel: rgba(20,20,20,0.92);
    --card-grad-1: rgba(255,255,255,0.04);
    --card-grad-2: rgba(255,255,255,0.07);
    --border: rgba(255,255,255,0.10);
    --card-min: 260px;
    --card-scale: 1;
    --card-translateY: 18px;
    --toolbox-width: 420px;
    --toolbox-height: 420px;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:var(--text);-webkit-font-smoothing:antialiased}
  body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;background:url('/logo.png') no-repeat center;background-size:min(50vw,520px);opacity:0.06;filter:blur(.6px);mix-blend-mode:screen}

  header{padding:20px;text-align:center;z-index:2}
  header h1{margin:0;color:var(--accent);font-size:1.6rem}

  /* Controls */
  .control-btn{
    position:fixed;bottom:18px;z-index:13000;width:48px;height:48px;border-radius:10px;
    background:var(--glass);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.45);color:var(--accent);
  }
  .control-btn:hover{transform:scale(1.06)}
  #toolboxToggle{left:18px}
  #miniSliderToggle{left:78px}
  #paletteToggle{left:138px}
  #readerToggle{left:198px}

  /* Mini slider popout */
  .mini-panel{
    position:fixed;left:78px;bottom:74px;z-index:12900;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;box-shadow:0 12px 36px rgba(0,0,0,0.6);backdrop-filter:blur(8px);
    display:none;pointer-events:auto;
  }
  .mini-panel.open{display:block}

  /* Palette panel */
  .palette-panel{
    position:fixed;left:138px;bottom:74px;z-index:12800;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:12px;box-shadow:0 12px 36px rgba(0,0,0,0.6);backdrop-filter:blur(8px);
    display:none;pointer-events:none;
  }
  .palette-panel.open{display:block;pointer-events:auto}

  /* Detachable toolbox window */
  .toolbox {
    position:fixed;
    right:18px;
    bottom:18px;
    width:var(--toolbox-width);
    height:var(--toolbox-height);
    z-index:12700;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 18px 48px rgba(0,0,0,0.6);
    display:flex;
    flex-direction:column;
    overflow:hidden;
  }
  .toolbox.hidden{display:none}

  .toolbox .titlebar{
    display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);cursor:grab;
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);
  }
  .toolbox .titlebar:active{cursor:grabbing}

  /* IMPORTANT: toolbox content uses CSS grid so widgets reflow */
  .toolbox .content{
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
    gap:12px;
    align-content:start;
    padding:12px;
    overflow:auto;
  }

  /* Widgets inside toolbox: constrained wrappers */
  .widget-wrap{
    box-sizing:border-box;
    width:100%;
    min-width:160px;
    max-width:100%;
    min-height:100px;
    max-height:calc(100vh - 220px);
    background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));
    border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    padding:8px;resize:both;overflow:auto;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
  }

  .widget-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .widget-close{background:transparent;border:0;color:#ff6b6b;cursor:pointer;font-size:16px}

  /* Grid / cards */
  main{position:relative;z-index:2}
  .search-bar{max-width:1100px;margin:14px auto 16px;display:flex;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border-radius:12px;padding:12px 16px;border:1px solid rgba(255,255,255,0.04)}
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}

  .controls{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .controls button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}

  .dashboard{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(var(--card-min), 1fr));
    gap:20px;
    padding:20px;
    align-items:start;
    box-sizing:border-box;
  }

  .card{
    box-sizing:border-box;
    background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    backdrop-filter:blur(8px);
    width:100%;
    max-width:100%;
    opacity:0;
    transform: translateY(var(--card-translateY)) scale(var(--card-scale));
    transition:opacity .36s ease, transform .36s ease;
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
    overflow:hidden;
  }
  .card.visible{opacity:1; transform: translateY(0) scale(var(--card-scale));}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}

  /* Reader mode */
  body.reader-mode{font-size:1.12rem;line-height:1.6}
  body.reader-mode .dashboard{grid-template-columns:1fr;gap:18px}
  body.reader-mode .card{padding:20px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.04));border-color:rgba(255,255,255,0.06)}

  .muted{color:var(--muted);font-size:.9rem}
  .mini-square{
    position:fixed;left:18px;bottom:18px;z-index:13100;width:44px;height:44px;border-radius:8px;background:var(--glass);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 8px 30px rgba(0,0,0,0.45)
  }

  /* Panels only accept pointer events when open */
  .palette-panel, .mini-panel { pointer-events: none; }
  .palette-panel.open, .mini-panel.open { pointer-events: auto; }
</style>
</head>
<body>

  <!-- controls -->
  <button id="toolboxToggle" class="control-btn" title="Open toolbox">ðŸ§°</button>
  <button id="miniSliderToggle" class="control-btn" title="Card size quick access">â—§</button>
  <button id="paletteToggle" class="control-btn" title="Theme">ðŸŽ¨</button>
  <button id="readerToggle" class="control-btn" title="Reader mode">ðŸ‘“</button>

  <!-- mini slider popout -->
  <div id="miniPanel" class="mini-panel" aria-hidden="true">
    <div style="display:flex;align-items:center;gap:8px;margin-bottom:8px">
      <div style="color:var(--accent);font-weight:600">Card size</div>
      <button id="miniClose" style="background:transparent;border:0;color:var(--muted);cursor:pointer">âœ•</button>
    </div>
    <input id="miniCardSlider" type="range" min="70" max="140" value="100" step="5" style="width:220px">
    <div class="muted" style="margin-top:8px">Adjust card scale</div>
  </div>

  <!-- palette -->
  <div id="palettePanel" class="palette-panel" aria-hidden="true">
    <div style="color:var(--accent);font-weight:600;margin-bottom:8px">Accent color</div>
    <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
      <div class="palette-color active" data-accent="#2dd4ff" style="background:#2dd4ff;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#ff2d55" style="background:#ff2d55;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#00ff99" style="background:#00ff99;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#ffcc00" style="background:#ffcc00;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#9d4edd" style="background:#9d4edd;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#ff006e" style="background:#ff006e;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#00d4ff" style="background:#00d4ff;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#ff9500" style="background:#ff9500;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#32d74b" style="background:#32d74b;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
      <div class="palette-color" data-accent="#ff5e3a" style="background:#ff5e3a;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent"></div>
    </div>
  </div>

  <!-- detachable toolbox -->
  <div id="toolbox" class="toolbox hidden" role="dialog" aria-hidden="true">
    <div class="titlebar" id="toolboxTitle">
      <div style="font-weight:600;color:var(--accent)">Toolbox</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="dockBtn" title="Dock/undock" style="background:transparent;border:0;color:var(--muted);cursor:pointer">â‡±</button>
        <button id="toolboxClose" title="Close" style="background:transparent;border:0;color:var(--muted);cursor:pointer">âœ•</button>
      </div>
    </div>
    <div class="content" id="toolboxContent" aria-live="polite"></div>
  </div>

  <!-- mini square -->
  <div id="miniSquare" class="mini-square" title="Card size quick access">â—§</div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main>
    <div class="search-bar"><input id="searchInput" placeholder="Search cards..." /></div>

    <div class="controls">
      <button id="sortAlphaBtn">Sort Aâ†’Z</button>
      <button id="sortRandomBtn">Random</button>
      <button id="reDealBtn">Reâ€‘deal</button>
    </div>

    <div id="status" class="muted" style="text-align:center;margin-bottom:6px">Loading cards...</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
/* Repo and loader */
const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
const DEFAULT_BRANCH = 'main';
function parseOwnerRepo(str){ const p = str.split('/'); return { owner: p[0], repo: p[1] }; }
async function fetchRepoTree(owner, repo, branch){
  const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
  const r = await fetch(url);
  if(!r.ok) throw new Error('GitHub API error: ' + r.status);
  return r.json();
}
async function getCardFiles(owner, repo, branch){
  const data = await fetchRepoTree(owner, repo, branch);
  return (data.tree || []).filter(item => item.path.startsWith('cards/') && item.path.endsWith('.html')).map(item => item.path.replace(/^cards\//,''));
}

/* Cards */
function createCardElement(file){
  const name = file.replace('.html','');
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.file = file;
  card.dataset.name = name;

  const header = document.createElement('div');
  header.className = 'card-header';
  const title = document.createElement('h3');
  title.textContent = name;
  const btnWrap = document.createElement('div');
  btnWrap.style.display = 'flex';
  btnWrap.style.gap = '8px';

  const addBtn = document.createElement('div');
  addBtn.className = 'add-to-toolbox';
  addBtn.title = 'Add to toolbox';
  addBtn.textContent = '+';
  addBtn.style.cursor = 'pointer';
  addBtn.addEventListener('click', (e) => { e.stopPropagation(); addToToolbox(file); });

  btnWrap.appendChild(addBtn);
  header.appendChild(title);
  header.appendChild(btnWrap);
  card.appendChild(header);

  const content = document.createElement('div');
  content.className = 'content';
  content.textContent = 'Loadingâ€¦';
  card.appendChild(content);

  const obs = new IntersectionObserver(entries => {
    entries.forEach(entry => {
      if(entry.isIntersecting){
        loadCardContentInto(card, file);
        obs.unobserve(card);
      }
    });
  }, { threshold: 0.08, rootMargin: '160px 0px 160px 0px' });
  obs.observe(card);

  setTimeout(() => card.classList.add('visible'), Math.random() * 220 + 80);
  return card;
}
async function loadCardContentInto(card, file){
  if(card.dataset.loaded) return;
  try{
    const r = await fetch(`cards/${file}`);
    if(!r.ok){ card.querySelector('.content').textContent = 'Preview unavailable'; return; }
    let html = await r.text();
    html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
    html = html.replace(/<img\b([^>]*?)>/gi, (m, attrs) => /loading\s*=/.test(attrs) ? `<img${attrs}>` : `<img loading="lazy"${attrs}>`);
    card.querySelector('.content').innerHTML = html;
    card.dataset.loaded = 'true';
  }catch(e){
    card.querySelector('.content').textContent = 'Failed to load';
  }
}

/* Toolbox (detachable) and widgets */
const toolbox = document.getElementById('toolbox');
const toolboxToggle = document.getElementById('toolboxToggle');
const toolboxClose = document.getElementById('toolboxClose');
const toolboxTitle = document.getElementById('toolboxTitle');
const toolboxContent = document.getElementById('toolboxContent');
const dockBtn = document.getElementById('dockBtn');

let toolboxDocked = true;
let toolboxPos = { right: 18, bottom: 18, width: 420, height: 420 };

toolboxToggle.addEventListener('click', () => {
  toolbox.classList.toggle('hidden');
  toolbox.classList.contains('hidden') ? toolbox.setAttribute('aria-hidden','true') : toolbox.setAttribute('aria-hidden','false');
});
toolboxClose.addEventListener('click', ()=> { toolbox.classList.add('hidden'); toolbox.setAttribute('aria-hidden','true'); });

(function makeToolboxDraggable(){
  let dragging = false, startX=0, startY=0, startLeft=0, startTop=0;
  toolboxTitle.addEventListener('pointerdown', (e) => {
    if(toolboxDocked) return;
    dragging = true;
    startX = e.clientX; startY = e.clientY;
    const rect = toolbox.getBoundingClientRect();
    startLeft = rect.left; startTop = rect.top;
    toolbox.style.transition = 'none';
    toolbox.setPointerCapture(e.pointerId);
  });
  window.addEventListener('pointermove', (e) => {
    if(!dragging) return;
    const dx = e.clientX - startX, dy = e.clientY - startY;
    toolbox.style.left = Math.max(8, startLeft + dx) + 'px';
    toolbox.style.top = Math.max(8, startTop + dy) + 'px';
    toolbox.style.right = 'auto'; toolbox.style.bottom = 'auto';
  });
  window.addEventListener('pointerup', (e) => {
    if(!dragging) return;
    dragging = false;
    toolbox.style.transition = '';
  });
})();

dockBtn.addEventListener('click', () => {
  toolboxDocked = !toolboxDocked;
  if(toolboxDocked){
    toolbox.style.left = 'auto';
    toolbox.style.top = 'auto';
    toolbox.style.right = (toolboxPos.right || 18) + 'px';
    toolbox.style.bottom = (toolboxPos.bottom || 18) + 'px';
    toolbox.style.width = (toolboxPos.width || 420) + 'px';
    toolbox.style.height = (toolboxPos.height || 420) + 'px';
    dockBtn.textContent = 'â‡±';
  } else {
    const rect = toolbox.getBoundingClientRect();
    toolbox.style.left = (window.innerWidth - rect.width - 18) + 'px';
    toolbox.style.top = (window.innerHeight - rect.height - 120) + 'px';
    toolbox.style.right = 'auto';
    toolbox.style.bottom = 'auto';
    dockBtn.textContent = 'â‡²';
  }
});

/* Widgets */
function createWidget(file){
  const wrap = document.createElement('div');
  wrap.className = 'widget-wrap';
  wrap.dataset.file = file;

  const header = document.createElement('div');
  header.className = 'widget-header';
  const title = document.createElement('div');
  title.textContent = file.replace('.html','');
  const close = document.createElement('button');
  close.className = 'widget-close';
  close.innerHTML = 'âœ•';
  close.addEventListener('click', ()=> removeFromToolbox(file));

  header.appendChild(title);
  header.appendChild(close);
  wrap.appendChild(header);

  const body = document.createElement('div');
  body.className = 'widget-body';
  body.style.minHeight = '80px';
  body.style.maxHeight = '40vh';
  body.style.overflow = 'auto';
  body.textContent = 'Loadingâ€¦';
  wrap.appendChild(body);

  (async function loadIntoWidget(f, container){
    try{
      const r = await fetch(`cards/${f}`);
      if(!r.ok){ container.textContent = 'Preview unavailable'; return; }
      let html = await r.text();
      html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      html = html.replace(/<img\b([^>]*?)>/gi, (m, attrs) => /loading\s*=/.test(attrs) ? `<img${attrs}>` : `<img loading="lazy"${attrs}>`);
      container.innerHTML = html;
    }catch(e){
      container.textContent = 'Failed to load';
    }
  })(file, body);

  // clamp while resizing using ResizeObserver (observer attached later)
  return wrap;
}

function clampWidgetSize(widget){
  const contentRect = toolboxContent.getBoundingClientRect();
  const wRect = widget.getBoundingClientRect();
  const maxW = Math.max(120, contentRect.right - wRect.left - 12);
  const maxH = Math.max(80, contentRect.bottom - wRect.top - 12);
  if(wRect.width > maxW) widget.style.width = Math.max(120, maxW) + 'px';
  if(wRect.height > maxH) widget.style.height = Math.max(80, maxH) + 'px';
}

/* Toolbox storage */
const TOOLBOX_KEY = 'toolbox_items_v1';
function loadToolboxStore(){ try { return JSON.parse(localStorage.getItem(TOOLBOX_KEY) || '[]'); } catch(e) { return []; } }
function saveToolboxStore(items){ localStorage.setItem(TOOLBOX_KEY, JSON.stringify(items)); }
let toolboxItems = loadToolboxStore();

function addToToolbox(file){
  if(toolboxItems.includes(file)){ openToolbox(); return; }
  toolboxItems.unshift(file);
  if(toolboxItems.length > 80) toolboxItems.length = 80;
  saveToolboxStore(toolboxItems);
  renderToolboxPanel();
  openToolbox();
}
function removeFromToolbox(file){
  const idx = toolboxItems.indexOf(file);
  if(idx >= 0){ toolboxItems.splice(idx,1); saveToolboxStore(toolboxItems); renderToolboxPanel(); }
}
function openToolbox(){ toolbox.classList.remove('hidden'); toolbox.setAttribute('aria-hidden','false'); }

function renderToolboxPanel(){
  toolboxContent.innerHTML = '';
  if(!toolboxItems.length){
    const empty = document.createElement('div');
    empty.className = 'muted';
    empty.textContent = 'No widgets pinned. Click + on a card to pin it here.';
    toolboxContent.appendChild(empty);
    return;
  }
  for(const file of toolboxItems){
    const w = createWidget(file);
    toolboxContent.appendChild(w);
  }
  // attach ResizeObserver to clamp sizes and prevent overflow/overlap
  attachWidgetResizeObserver();
}

/* ResizeObserver to clamp widget sizes and keep them inside toolbox grid */
let widgetRO = null;
function attachWidgetResizeObserver(){
  if(widgetRO) widgetRO.disconnect();
  const contentEl = toolboxContent;
  if(!contentEl) return;
  widgetRO = new ResizeObserver(entries => {
    for(const entry of entries){
      const widget = entry.target;
      clampWidgetSize(widget);
    }
  });
  contentEl.querySelectorAll('.widget-wrap').forEach(w => {
    widgetRO.observe(w);
    clampWidgetSize(w);
  });
}

/* Mini slider popout wiring */
const miniSquare = document.getElementById('miniSquare');
const miniPanel = document.getElementById('miniPanel');
const miniSlider = document.getElementById('miniCardSlider');
const miniClose = document.getElementById('miniClose');
const miniToggleBtn = document.getElementById('miniSliderToggle');

miniSquare.addEventListener('click', () => miniPanel.classList.toggle('open'));
miniToggleBtn.addEventListener('click', () => miniPanel.classList.toggle('open'));
miniSlider.addEventListener('input', (e) => {
  const scale = (parseInt(e.target.value,10) || 100) / 100;
  document.documentElement.style.setProperty('--card-scale', scale);
  localStorage.setItem('cardSize', e.target.value + '%');
});
miniClose.addEventListener('click', () => miniPanel.classList.remove('open'));
(function restoreCardSize(){
  const saved = localStorage.getItem('cardSize');
  if(saved){
    const n = parseInt(saved.replace('%','')) || 100;
    miniSlider.value = n;
    document.documentElement.style.setProperty('--card-scale', n/100);
  }
})();

/* Palette */
document.getElementById('paletteToggle').addEventListener('click', () => {
  const p = document.getElementById('palettePanel');
  p.classList.toggle('open');
  p.classList.contains('open') ? p.setAttribute('aria-hidden','false') : p.setAttribute('aria-hidden','true');
});
document.querySelectorAll('.palette-color').forEach(c => {
  c.addEventListener('click', () => {
    document.querySelectorAll('.palette-color').forEach(x => x.classList.remove('active'));
    c.classList.add('active');
    const col = c.dataset.accent;
    applyAccent(col);
    localStorage.setItem('accent', col);
  });
});
function applyAccent(hex){
  document.documentElement.style.setProperty('--accent', hex);
  const rgb = hexToRgb(hex);
  if(rgb){
    document.documentElement.style.setProperty('--glass', `rgba(${rgb.r},${rgb.g},${rgb.b},0.06)`);
    document.documentElement.style.setProperty('--card-grad-1', `rgba(${Math.min(255,rgb.r+18)},${Math.min(255,rgb.g+18)},${Math.min(255,rgb.b+18)},0.04)`);
    document.documentElement.style.setProperty('--card-grad-2', `rgba(${Math.min(255,rgb.r+36)},${Math.min(255,rgb.g+36)},${Math.min(255,rgb.b+36)},0.07)`);
  }
}
function hexToRgb(hex){
  try{ hex = hex.replace('#',''); if(hex.length===3) hex = hex.split('').map(c=>c+c).join(''); const n = parseInt(hex,16); return { r:(n>>16)&255, g:(n>>8)&255, b:n&255 }; }catch(e){ return null; }
}
if(localStorage.getItem('accent')){
  const saved = localStorage.getItem('accent');
  document.documentElement.style.setProperty('--accent', saved);
  document.querySelector(`.palette-color[data-accent="${saved}"]`)?.classList.add('active');
  applyAccent(saved);
}

/* Reader mode */
const readerToggle = document.getElementById('readerToggle');
readerToggle.addEventListener('click', ()=>{
  document.body.classList.toggle('reader-mode');
  if(document.body.classList.contains('reader-mode')) localStorage.setItem('readerMode','on'); else localStorage.removeItem('readerMode');
});
if(localStorage.getItem('readerMode') === 'on') document.body.classList.add('reader-mode');

/* Search / sort / deal */
document.getElementById('searchInput').addEventListener('input', (e) => {
  const q = (e.target.value || '').trim().toLowerCase();
  document.querySelectorAll('#gridContainer .card').forEach(card => {
    const name = (card.dataset.name || '').toLowerCase();
    const text = (card.textContent || '').toLowerCase();
    const show = !q || name.includes(q) || text.includes(q);
    card.style.display = show ? '' : 'none';
  });
});
document.getElementById('sortAlphaBtn').addEventListener('click', () => {
  const grid = document.getElementById('gridContainer');
  const nodes = Array.from(grid.children);
  nodes.sort((a,b) => a.dataset.name.localeCompare(b.dataset.name, undefined, {sensitivity:'base', numeric:true}));
  nodes.forEach(n => grid.appendChild(n));
  triggerDeal();
});
document.getElementById('sortRandomBtn').addEventListener('click', () => {
  const grid = document.getElementById('gridContainer');
  const nodes = Array.from(grid.children);
  for(let i = nodes.length - 1; i > 0; i--){
    const j = Math.floor(Math.random() * (i + 1));
    [nodes[i], nodes[j]] = [nodes[j], nodes[i]];
  }
  nodes.forEach(n => grid.appendChild(n));
  triggerDeal();
});
document.getElementById('reDealBtn').addEventListener('click', triggerDeal);
function triggerDeal(){
  const cards = Array.from(document.querySelectorAll('#gridContainer .card'));
  cards.forEach((c, i) => {
    c.classList.remove('visible');
    setTimeout(() => c.classList.add('visible'), i * 60);
  });
}

/* Sortable */
new Sortable(document.getElementById('gridContainer'), { animation: 150 });
new Sortable(document.getElementById('toolboxContent'), { animation: 150 });

/* Load dashboard */
async function loadDashboard(){
  const { owner, repo } = parseOwnerRepo(DEFAULT_REPO);
  try{
    const files = await getCardFiles(owner, repo, DEFAULT_BRANCH);
    if(!files.length){ document.getElementById('status').textContent = 'No cards folder found'; return; }
    files.sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base', numeric:true}));
    const grid = document.getElementById('gridContainer');
    grid.innerHTML = '';
    files.forEach(f => grid.appendChild(createCardElement(f)));
    document.getElementById('status').textContent = `${files.length} tools loaded â€” dealingâ€¦`;
    setTimeout(triggerDeal, 200);
    renderToolboxPanel();
  }catch(e){
    document.getElementById('status').textContent = 'Check repo name or cards/ folder';
    console.error(e);
  }
}

/* Init */
renderToolboxPanel();
loadDashboard();
</script>
</body>
</html>
