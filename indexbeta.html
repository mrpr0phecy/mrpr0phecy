<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Most Useful Site in the World</title>
<style>
  html,body{
    height:100%;
    margin:0;
    font-family:Inter,system-ui,Segoe UI,Roboto,Arial;
    background:linear-gradient(135deg, #0a0f14, #141e28);
    color:#e6faff;
    -webkit-font-smoothing:antialiased;
    background-attachment: fixed;
    background-size: cover;
  }
  
  :root{
    --accent:#2dd4ff; 
    --muted:#e6faff; 
    --text:#e6faff;
    --glass: rgba(255,255,255,0.06);
    --panel: rgba(20,20,20,0.92);
    --card-grad-1: rgba(255,255,255,0.02);
    --card-grad-2: rgba(255,255,255,0.04);
    --border: rgba(255,255,255,0.10);
    --card-min: 260px;
    --card-scale: 1;
    --card-translateY: 18px;
    --toolbox-width: 520px;
    --toolbox-height: 420px;
    --global-font-scale: 1;
    --snap-size: 20px;
  }

  @keyframes widgetEnter {
    from { opacity: 0; transform: scale(0.9) translateY(20px); }
    to { opacity: 1; transform: scale(1) translateY(0); }
  }
  
  @keyframes pulseAccent {
    0%, 100% { box-shadow: 0 0 0 0 rgba(45,212,255,0.4); }
    50% { box-shadow: 0 0 0 8px rgba(45,212,255,0); }
  }
  
  @keyframes flyToToolbox {
    0% { transform: scale(1); opacity: 1; }
    100% { transform: scale(0.3); opacity: 0; }
  }
  
  .fly-animation {
    position: fixed;
    pointer-events: none;
    z-index: 15000;
    animation: flyToToolbox 0.4s ease-out forwards;
  }

  header{padding:20px;text-align:center;z-index:2}
  header h1{margin:0;color:var(--accent);font-size:1.6rem}

  .control-btn{
    position:fixed;bottom:18px;z-index:14000;width:48px;height:48px;border-radius:10px;
    background:var(--glass);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;backdrop-filter:blur(6px);box-shadow:0 8px 30px rgba(0,0,0,0.45);color:var(--accent);
    transition: all 0.2s ease;
  }
  .control-btn:hover{transform:scale(1.06); background: rgba(255,255,255,0.1);}
  .control-btn.active{background: rgba(45,212,255,0.15); border-color: var(--accent);}
  #toolboxToggle{left:18px}
  #paletteToggle{left:78px}
  #readerToggle{left:138px}
  #shortcutsToggle{left:198px}

  .palette-panel{
    position:fixed;left:78px;bottom:74px;z-index:13900;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 12px 36px rgba(0,0,0,0.6);backdrop-filter:blur(12px);
    display:none;pointer-events:none;min-width: 320px; max-height: 70vh; overflow-y: auto;
  }
  .palette-panel.open{display:block;pointer-events:auto}

  .palette-section{margin-bottom: 16px; padding-bottom: 16px; border-bottom: 1px solid rgba(255,255,255,0.05);}
  .palette-section:last-child{border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
  .palette-section-title{color:var(--accent);font-weight:600;margin-bottom:12px;font-size:13px;text-transform:uppercase;letter-spacing:0.5px;}

  .font-scale-container{display:flex;align-items:center;gap:12px;margin-top:8px;}
  .font-scale-slider{flex:1;-webkit-appearance:none;height:6px;border-radius:3px;background:rgba(255,255,255,0.1);outline:none;}
  .font-scale-slider::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent);cursor:pointer;}
  .font-scale-value{min-width:40px;text-align:right;font-size:12px;color:var(--muted);}

  .custom-theme-row{display:flex;gap:8px;align-items:center;margin-top:8px;}
  .color-picker-wrapper{flex:1;}
  .color-picker-wrapper input[type="color"]{width:100%;height:36px;border:none;border-radius:8px;cursor:pointer;background:transparent;}

  .workspace-list{display:flex;flex-direction:column;gap:6px;}
  .workspace-item{display:flex;align-items:center;gap:8px;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.03);border:1px solid var(--border);cursor:pointer;transition:all 0.2s;}
  .workspace-item:hover{background:rgba(255,255,255,0.06);}
  .workspace-item.active{border-color:var(--accent);background:rgba(45,212,255,0.08);}
  .workspace-item span{flex:1;font-size:13px;}
  .workspace-item .ws-shortcut{font-size:11px;color:var(--muted);opacity:0.6;background:rgba(255,255,255,0.1);padding:2px 6px;border-radius:4px;}
  .workspace-actions{display:flex;gap:4px;}
  .workspace-actions button{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px 6px;border-radius:4px;font-size:12px;}
  .workspace-actions button:hover{background:rgba(255,255,255,0.1);color:var(--accent);}

  .toolbox {
    position:fixed;
    right:18px;
    bottom:18px;
    width:var(--toolbox-width);
    height:var(--toolbox-height);
    z-index:13700;
    background:var(--panel);
    border:1px solid var(--border);
    border-radius:12px;
    box-shadow:0 18px 48px rgba(0,0,0,0.6);
    display:flex;
    flex-direction:column;
    overflow:hidden;
    resize:both;
    min-width:300px;
    min-height:200px;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  .toolbox.hidden{display:none; transform: scale(0.95); opacity: 0;}
  .toolbox.minimized{height: 50px !important; min-height: 50px !important; resize: none;}
  .toolbox.minimized .content,
  .toolbox.minimized .toolbox-tabs{display:none !important;}
  .toolbox.minimized .titlebar{border-bottom:none;}

  .toolbox-tabs{display:flex;gap:4px;padding:4px 10px 0;background:rgba(255,255,255,0.02);border-bottom:1px solid rgba(255,255,255,0.03);overflow-x:auto;}
  .toolbox-tab{flex-shrink:0;padding:6px 12px;border-radius:6px 6px 0 0;font-size:12px;cursor:pointer;white-space:nowrap;transition:all 0.2s;border:1px solid transparent;border-bottom:none;}
  .toolbox-tab:hover{background:rgba(255,255,255,0.05);}
  .toolbox-tab.active{background:var(--glass);border-color:var(--border);color:var(--accent);}
  .toolbox-tab .tab-close{margin-left:6px;opacity:0;transition:opacity 0.2s;}
  .toolbox-tab:hover .tab-close{opacity:1;}
  .toolbox-tab .tab-close:hover{color:#ff6b6b;}

  .toolbox .titlebar{
    display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);cursor:grab;z-index:13750;
  }
  .toolbox .titlebar:active{cursor:grabbing;}

  .toolbox .content{
    position:relative;
    flex:1;
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    overflow:auto;
    min-height:100px;
  }

  .widget-search{padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03);}
  .widget-search input{width:100%;padding:6px 10px;border-radius:6px;border:1px solid var(--border);background:rgba(255,255,255,0.05);color:var(--text);font-size:12px;outline:none;}
  .widget-search input::placeholder{color:rgba(230,250,255,0.4);}

  .widget-wrap{
    position:absolute;
    box-sizing:border-box;
    background:linear-gradient(135deg, rgba(255,255,255,0.02), rgba(255,255,255,0.04));
    border-radius:10px;border:1px solid rgba(255,255,255,0.04);
    min-width:120px; min-height:80px;
    max-width:calc(100% - 20px);
    max-height:calc(100% - 20px);
    overflow:hidden;
    resize:both;
    z-index:1;
    box-shadow:0 8px 20px rgba(0,0,0,0.35);
    animation: widgetEnter 0.3s ease;
    --widget-font-size: 14px;
    --widget-font-scale: 1;
    --widget-min-font: 8px;
    --widget-max-font: 32px;
    --widget-ideal-area: 30000;
    transition: box-shadow 0.2s, border-color 0.2s;
  }
  
  .widget-wrap.pinned{border-color: rgba(255,193,7,0.4); box-shadow: 0 0 0 1px rgba(255,193,7,0.2), 0 8px 20px rgba(0,0,0,0.35);}
  .widget-wrap.pinned::after{content:'üìå';position:absolute;top:4px;right:28px;font-size:10px;opacity:0.7;}
  .widget-wrap.minimized{height: 36px !important; min-height: 36px !important; resize: none; animation: none;}
  .widget-wrap.minimized .widget-body{display:none;}
  .widget-wrap.minimized .widget-scale-controls{display:none;}
  .widget-wrap.duplicate-warning{animation: pulseAccent 1s ease;}
  .widget-wrap.dragging{opacity:0.8;z-index:1000;box-shadow:0 12px 40px rgba(0,0,0,0.5);}
  .widget-wrap.snap-guide{transition: left 0.15s ease, top 0.15s ease;}

  .widget-titlebar{
    display:flex;align-items:center;justify-content:space-between;padding:8px 10px;border-bottom:1px solid rgba(255,255,255,0.03);
    background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    cursor:move;
    user-select:none;
    gap: 8px;
  }
  
  .widget-titlebar .title-section{display:flex;align-items:center;gap:6px;flex:1;min-width:0;}
  .widget-titlebar strong{
    color:var(--accent);
    font-size: calc(var(--widget-font-size) * 1.1);
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  .widget-body{
    padding:10px;
    overflow:auto;
    max-height:60vh;
    font-size: calc(var(--widget-font-size) * var(--global-font-scale));
    line-height: calc(var(--widget-font-size) * var(--global-font-scale) * 1.4);
    transition: font-size 0.2s ease;
  }

  .widget-controls{display:flex;gap:4px;align-items:center;}
  .widget-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:4px 6px;border-radius:4px;transition:all 0.2s;line-height:1;}
  .widget-btn:hover{background:rgba(255,255,255,0.1);color:var(--accent);}
  .widget-btn.pin-btn:hover{color:#ffc107;}
  .widget-btn.minimize-btn:hover{color:#4caf50;}
  .widget-btn.pin-btn.pinned{color:#ffc107;}

  .widget-scale-controls{display:flex;gap:3px;align-items:center;background:rgba(255,255,255,0.03);padding:2px 6px;border-radius:6px;margin-left:auto;}
  .scale-btn{background:transparent;border:none;color:var(--muted);cursor:pointer;font-size:11px;padding:2px 5px;border-radius:3px;transition:all 0.2s;line-height:1;}
  .scale-btn:hover{background:rgba(255,255,255,0.1);color:var(--accent);}
  .scale-display{font-size:10px;color:var(--muted);min-width:32px;text-align:center;}

  .widget-close, #toolboxClose { 
    z-index: 13800; 
    position: relative; 
    background:transparent;
    border:0;
    color:var(--muted);
    cursor:pointer;
    font-size: var(--widget-font-size);
  }

  main{
    position:relative;
    z-index:2;
    scroll-margin-top: 0;
  }
  
  .search-bar{
    max-width:1100px;
    margin:14px auto 16px;
    display:flex;
    background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));
    border-radius:12px;
    padding:12px 16px;
    border:1px solid rgba(255,255,255,0.04);
    scroll-margin-top: 20px;
  }
  
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}

  .controls{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .controls button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer;transition:all 0.2s;}
  .controls button:hover{background:rgba(255,255,255,0.05);color:var(--accent);}

  .dashboard{
    display:grid;
    grid-template-columns: repeat(auto-fit, minmax(var(--card-min), 1fr));
    gap:20px;
    padding:20px;
    align-items:start;
    box-sizing:border-box;
  }

  .card{
    box-sizing:border-box;
    background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
    border:1px solid var(--border);
    border-radius:12px;
    padding:16px;
    min-height:120px;
    width:100%;
    max-width:100%;
    opacity:0;
    transform: translateY(var(--card-translateY)) scale(var(--card-scale));
    transition:opacity .36s ease, transform .36s ease;
    box-shadow:0 8px 24px rgba(0,0,0,0.35);
    overflow:hidden;
  }
  .card.visible{opacity:1; transform: translateY(0) scale(var(--card-scale));}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}

  .embed-section {
    margin-top: 16px;
    padding-top: 12px;
    border-top: 1px solid rgba(255,255,255,0.06);
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
  }
  
  .embed-section span {
    color: rgba(230,250,255,0.7);
    white-space: nowrap;
  }
  
  .embed-btn {
    background: rgba(45,212,255,0.1);
    color: var(--accent);
    border: 1px solid rgba(45,212,255,0.3);
    padding: 4px 10px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    white-space: nowrap;
    transition: all 0.2s;
    display: inline-flex;
    align-items: center;
    gap: 4px;
  }
  
  .embed-btn:hover {
    background: rgba(45,212,255,0.2);
    transform: translateY(-1px);
  }
  
  .embed-btn.copied {
    background: rgba(57,255,20,0.1);
    color: #39ff14;
    border-color: rgba(57,255,20,0.3);
  }

  body.reader-mode{font-size:1.12rem;line-height:1.6}
  body.reader-mode .dashboard{grid-template-columns:1fr;gap:18px}
  body.reader-mode .card{padding:20px;background:linear-gradient(135deg,rgba(255,255,255,0.02),rgba(255,255,255,0.04));border-color:rgba(255,255,255,0.06)}
  body.reader-mode .card.reader-expanded{padding:28px;max-width:800px;margin:0 auto;}

  .reader-card-toggle{cursor:pointer;padding:4px 8px;border-radius:6px;font-size:12px;background:rgba(255,255,255,0.05);border:1px solid var(--border);color:var(--muted);transition:all 0.2s;}
  .reader-card-toggle:hover{background:rgba(255,255,255,0.1);color:var(--accent);}
  .reader-card-toggle.active{background:rgba(45,212,255,0.1);color:var(--accent);border-color:rgba(45,212,255,0.3);}

  .shortcuts-panel{
    position:fixed;left:198px;bottom:74px;z-index:13900;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 12px 36px rgba(0,0,0,0.6);backdrop-filter:blur(12px);
    display:none;pointer-events:none;min-width: 280px;
  }
  .shortcuts-panel.open{display:block;pointer-events:auto;}
  .shortcuts-title{color:var(--accent);font-weight:600;margin-bottom:12px;font-size:13px;text-transform:uppercase;}
  .shortcut-row{display:flex;justify-content:space-between;align-items:center;padding:6px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
  .shortcut-row:last-child{border-bottom:none;}
  .shortcut-key{font-family:monospace;font-size:11px;background:rgba(255,255,255,0.1);padding:2px 8px;border-radius:4px;color:var(--muted);}

  .toast-container{position:fixed;top:20px;right:20px;z-index:20000;display:flex;flex-direction:column;gap:8px;}
  .toast{background:var(--panel);border:1px solid var(--border);border-radius:8px;padding:12px 16px;box-shadow:0 8px 32px rgba(0,0,0,0.4);backdrop-filter:blur(8px);display:flex;align-items:center;gap:10px;animation:toastEnter 0.3s ease;max-width:320px;}
  .toast.exit{animation:toastExit 0.3s ease forwards;}
  @keyframes toastEnter{from{transform:translateX(100%);opacity:0;}}
  @keyframes toastExit{to{transform:translateX(100%);opacity:0;}}
  .toast-icon{font-size:16px;}
  .toast-content{flex:1;}
  .toast-title{font-weight:600;font-size:13px;color:var(--accent);margin-bottom:2px;}
  .toast-message{font-size:12px;color:var(--muted);}

  @media (max-width: 768px) {
    .card {touch-action: pan-y; -webkit-overflow-scrolling: touch;}
    .dashboard {gap: 16px;}
    .card-header h3 {padding: 4px 0;}
    .search-bar input {font-size: 16px;}
    .toolbox{right:10px;left:10px;width:auto;}
    .palette-panel{left:10px;right:10px;bottom:80px;}
    .shortcuts-panel{left:10px;right:10px;bottom:80px;}
  }

  @media (prefers-reduced-motion: reduce) {
    *, *::before, *::after {
      animation-duration: 0.01ms !important;
      animation-iteration-count: 1 !important;
      transition-duration: 0.01ms !important;
    }
  }
</style>
</head>
<body>

  <div class="toast-container" id="toastContainer"></div>

  <button id="toolboxToggle" class="control-btn" title="Open toolbox (Ctrl+Shift+T)">üß∞</button>
  <button id="paletteToggle" class="control-btn" title="Theme settings">üé®</button>
  <button id="readerToggle" class="control-btn" title="Reader mode">üëì</button>
  <button id="shortcutsToggle" class="control-btn" title="Keyboard shortcuts">‚å®Ô∏è</button>

  <div id="shortcutsPanel" class="shortcuts-panel">
    <div class="shortcuts-title">Keyboard Shortcuts</div>
    <div class="shortcut-row"><span>Toggle Toolbox</span><span class="shortcut-key">Ctrl+Shift+T</span></div>
    <div class="shortcut-row"><span>Focus Search</span><span class="shortcut-key">Ctrl+K</span></div>
    <div class="shortcut-row"><span>Close/Cancel</span><span class="shortcut-key">Esc</span></div>
    <div class="shortcut-row"><span>Minimize Toolbox</span><span class="shortcut-key">Ctrl+M</span></div>
    <div class="shortcut-row"><span>Workspace 1-5</span><span class="shortcut-key">Ctrl+1..5</span></div>
    <div class="shortcut-row"><span>Save Workspace</span><span class="shortcut-key">Ctrl+S</span></div>
    <div class="shortcut-row"><span>New Workspace</span><span class="shortcut-key">Ctrl+N</span></div>
  </div>

  <div id="palettePanel" class="palette-panel" aria-hidden="true">
    <div class="palette-section">
      <div class="palette-section-title">Accent Color</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
        <div class="palette-color active" data-accent="#2dd4ff" style="background:#2dd4ff;height:34px;border-radius:8px;cursor:pointer"></div>
        <div class="palette-color" data-accent="#ff2d55" style="background:#ff2d55;height:34px;border-radius:8px;cursor:pointer"></div>
        <div class="palette-color" data-accent="#00ff99" style="background:#00ff99;height:34px;border-radius:8px;cursor:pointer"></div>
        <div class="palette-color" data-accent="#ffcc00" style="background:#ffcc00;height:34px;border-radius:8px;cursor:pointer"></div>
        <div class="palette-color" data-accent="#9d4edd" style="background:#9d4edd;height:34px;border-radius:8px;cursor:pointer"></div>
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title">Custom Gradient</div>
      <div class="custom-theme-row">
        <div class="color-picker-wrapper">
          <input type="color" id="customColor1" value="#0a0f14" title="Gradient start">
        </div>
        <div class="color-picker-wrapper">
          <input type="color" id="customColor2" value="#141e28" title="Gradient end">
        </div>
        <button id="applyCustomTheme" class="embed-btn" style="padding:6px 12px;">Apply</button>
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title">Presets</div>
      <div style="display:grid;grid-template-columns:repeat(5,1fr);gap:8px">
        <button class="theme-btn active" data-color="default" style="background:linear-gradient(135deg, #0a0f14, #141e28);height:34px;border-radius:8px;cursor:pointer;border:2px solid var(--accent)"></button>
        <button class="theme-btn" data-color="deep-blue" style="background:linear-gradient(135deg, #05080c, #0f151f);height:34px;border-radius:8px;cursor:pointer;border:1px solid var(--border)"></button>
        <button class="theme-btn" data-color="deep-purple" style="background:linear-gradient(135deg, #12081a, #1f1229);height:34px;border-radius:8px;cursor:pointer;border:1px solid var(--border)"></button>
        <button class="theme-btn" data-color="deep-teal" style="background:linear-gradient(135deg, #061616, #0f2525);height:34px;border-radius:8px;cursor:pointer;border:1px solid var(--border)"></button>
        <button class="theme-btn" data-color="deep-red" style="background:linear-gradient(135deg, #160606, #251010);height:34px;border-radius:8px;cursor:pointer;border:1px solid var(--border)"></button>
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title">Global Widget Font Scale</div>
      <div class="font-scale-container">
        <span style="font-size:11px;">A‚Åª</span>
        <input type="range" class="font-scale-slider" id="globalFontScale" min="0.5" max="2" step="0.1" value="1">
        <span style="font-size:15px;">A‚Å∫</span>
        <span class="font-scale-value" id="fontScaleValue">100%</span>
      </div>
    </div>

    <div class="palette-section">
      <div class="palette-section-title" style="display:flex;justify-content:space-between;align-items:center;">
        Workspaces
        <button id="newWorkspaceBtn" class="embed-btn" style="padding:4px 10px;font-size:11px;">+ New</button>
      </div>
      <div class="workspace-list" id="workspaceList"></div>
    </div>

    <div class="palette-section">
      <div style="display:flex;align-items:center;gap:10px;">
        <input type="checkbox" id="snapToGrid" style="accent-color:var(--accent);">
        <label for="snapToGrid" style="font-size:13px;cursor:pointer;">Snap widgets to grid</label>
      </div>
    </div>
  </div>

  <div id="toolbox" class="toolbox hidden" role="dialog" aria-hidden="true">
    <div class="toolbox-tabs" id="toolboxTabs"></div>
    
    <div class="titlebar" id="toolboxTitle">
      <div style="font-weight:600;color:var(--accent);display:flex;align-items:center;gap:8px;">
        <span id="workspaceIndicator">Toolbox</span>
        <span id="widgetCount" style="font-size:11px;opacity:0.6;font-weight:normal;">(0)</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="minimizeToolboxBtn" class="widget-btn" title="Minimize">üóï</button>
        <button id="saveWorkspaceBtn" class="widget-btn" title="Save workspace">üíæ</button>
        <button id="clearWidgetsBtn" class="widget-btn" title="Clear all widgets">üóëÔ∏è</button>
        <button id="dockBtn" title="Dock/undock" style="background:transparent;border:0;color:var(--muted);cursor:pointer">‚á±</button>
        <button id="toolboxClose" title="Close">‚úï</button>
      </div>
    </div>
    
    <div class="widget-search">
      <input type="text" id="widgetSearch" placeholder="Search widgets...">
    </div>
    
    <div class="content" id="toolboxContent" aria-live="polite"></div>
  </div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main>
    <div class="search-bar"><input id="searchInput" placeholder="Search cards..." autofocus /></div>

    <div class="controls">
      <button id="sortAlphaBtn">Sort A‚ÜíZ</button>
      <button id="sortRandomBtn">Random</button>
    </div>

    <div id="status" class="muted" style="text-align:center;margin-bottom:6px">Loading cards...</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
console.log("=== ENHANCED APP STARTING ===");

const AppState = {
  currentWorkspace: 0,
  workspaces: [],
  widgets: [],
  snapToGrid: false,
  snapSize: 20,
  globalFontScale: 1,
  toolboxDocked: false,
  toolboxMinimized: false,
  pinnedWidgets: new Set(),
  minimizedWidgets: new Set(),
  customThemes: {},
  
  init() {
    const saved = localStorage.getItem('appState');
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        this.workspaces = parsed.workspaces || [{ name: 'Default', widgets: [] }];
        this.currentWorkspace = parsed.currentWorkspace || 0;
        this.snapToGrid = parsed.snapToGrid || false;
        this.globalFontScale = parsed.globalFontScale || 1;
        this.customThemes = parsed.customThemes || {};
      } catch (e) {
        console.error('Failed to parse saved state:', e);
        this.workspaces = [{ name: 'Default', widgets: [] }];
      }
    } else {
      this.workspaces = [{ name: 'Default', widgets: [] }];
    }
    this.widgets = this.workspaces[this.currentWorkspace]?.widgets || [];
  },
  
  save() {
    try {
      localStorage.setItem('appState', JSON.stringify({
        workspaces: this.workspaces,
        currentWorkspace: this.currentWorkspace,
        snapToGrid: this.snapToGrid,
        globalFontScale: this.globalFontScale,
        customThemes: this.customThemes
      }));
    } catch (e) {
      console.error('Failed to save state:', e);
    }
  },
  
  get current() {
    return this.workspaces[this.currentWorkspace];
  },
  
  setWorkspace(index) {
    this.workspaces[this.currentWorkspace].widgets = [...this.widgets];
    this.currentWorkspace = index;
    this.widgets = [...(this.workspaces[index]?.widgets || [])];
    this.save();
    return this.widgets;
  },
  
  addWorkspace(name) {
    this.workspaces.push({ name, widgets: [] });
    this.save();
    return this.workspaces.length - 1;
  },
  
  deleteWorkspace(index) {
    if (this.workspaces.length <= 1) return false;
    this.workspaces.splice(index, 1);
    if (this.currentWorkspace >= index) {
      this.currentWorkspace = Math.max(0, this.currentWorkspace - 1);
    }
    this.widgets = [...(this.workspaces[this.currentWorkspace]?.widgets || [])];
    this.save();
    return true;
  },
  
  renameWorkspace(index, name) {
    if (this.workspaces[index]) {
      this.workspaces[index].name = name;
      this.save();
    }
  }
};

const themes = {
  'default': { bg1: '#0a0f14', bg2: '#141e28' },
  'deep-blue': { bg1: '#05080c', bg2: '#0f151f' },
  'deep-purple': { bg1: '#12081a', bg2: '#1f1229' },
  'deep-teal': { bg1: '#061616', bg2: '#0f2525' },
  'deep-red': { bg1: '#160606', bg2: '#251010' }
};

function applyTheme(themeName, custom = null) {
  console.log("Applying theme:", themeName);
  let gradient;
  
  if (custom) {
    gradient = `linear-gradient(135deg, ${custom.c1}, ${custom.c2})`;
  } else {
    const theme = themes[themeName];
    if (!theme) return;
    gradient = `linear-gradient(135deg, ${theme.bg1}, ${theme.bg2})`;
  }
  
  document.documentElement.style.background = gradient;
  document.body.style.background = gradient;
  localStorage.setItem('theme', themeName);
}

function showToast(title, message, icon = '‚ÑπÔ∏è', duration = 3000) {
  const container = document.getElementById('toastContainer');
  const toast = document.createElement('div');
  toast.className = 'toast';
  toast.innerHTML = `
    <span class="toast-icon">${icon}</span>
    <div class="toast-content">
      <div class="toast-title">${title}</div>
      <div class="toast-message">${message}</div>
    </div>
  `;
  container.appendChild(toast);
  
  setTimeout(() => {
    toast.classList.add('exit');
    setTimeout(() => toast.remove(), 300);
  }, duration);
}

let widgetIdCounter = 0;

function createWidget(name, contentHTML, options = {}) {
  if (!options.allowDuplicate) {
    const existing = AppState.widgets.find(w => w.name === name);
    if (existing) {
      const existingEl = document.getElementById(existing.id);
      if (existingEl) {
        existingEl.classList.add('duplicate-warning');
        setTimeout(() => existingEl.classList.remove('duplicate-warning'), 1000);
        showToast('Widget already open', `"${name}" is already in your toolbox. Click the toolbox to see it.`, 'üìå');
        return null;
      }
    }
  }
  
  const widgetId = options.id || `widget-${Date.now()}-${++widgetIdCounter}`;
  const widget = document.createElement('div');
  widget.className = 'widget-wrap';
  widget.id = widgetId;
  widget.dataset.name = name;
  widget.dataset.created = Date.now();
  
  const toolboxContent = document.getElementById('toolboxContent');
  const tRect = toolboxContent.getBoundingClientRect();
  
  let x = options.x || Math.random() * Math.max(50, tRect.width - 200);
  let y = options.y || Math.random() * Math.max(50, tRect.height - 150);
  let width = options.width || '200px';
  let height = options.height || '150px';
  
  if (AppState.snapToGrid) {
    x = Math.round(x / AppState.snapSize) * AppState.snapSize;
    y = Math.round(y / AppState.snapSize) * AppState.snapSize;
  }
  
  widget.style.left = typeof x === 'number' ? `${x}px` : x;
  widget.style.top = typeof y === 'number' ? `${y}px` : y;
  widget.style.width = width;
  widget.style.height = height;
  
  const isPinned = options.pinned || AppState.pinnedWidgets.has(widgetId);
  const isMinimized = options.minimized || AppState.minimizedWidgets.has(widgetId);
  const userScale = options.userScale || 1;
  
  if (isPinned) {
    widget.classList.add('pinned');
    AppState.pinnedWidgets.add(widgetId);
  }
  if (isMinimized) {
    widget.classList.add('minimized');
    AppState.minimizedWidgets.add(widgetId);
  }
  
  widget.innerHTML = `
    <div class="widget-titlebar">
      <div class="title-section">
        <strong>${name}</strong>
      </div>
      <div class="widget-controls">
        <button class="widget-btn pin-btn ${isPinned ? 'pinned' : ''}" title="${isPinned ? 'Unpin' : 'Pin'}">üìå</button>
        <button class="widget-btn minimize-btn" title="${isMinimized ? 'Restore' : 'Minimize'}">${isMinimized ? 'üóó' : 'üóï'}</button>
        <div class="widget-scale-controls">
          <button class="scale-btn scale-down" title="Smaller">A‚Åª</button>
          <span class="scale-display">${Math.round(userScale * 100)}%</span>
          <button class="scale-btn scale-up" title="Larger">A‚Å∫</button>
          <button class="scale-btn scale-reset" title="Reset">‚ü≤</button>
        </div>
        <button class="widget-close" title="Close">‚úï</button>
      </div>
    </div>
    <div class="widget-body">${contentHTML}</div>
  `;
  
  toolboxContent.appendChild(widget);
  
  widget.dataset.userScale = userScale;
  updateWidgetFontScale(widget);
  
  makeWidgetDraggable(widget);
  makeWidgetResizable(widget);
  setupWidgetControls(widget, name, contentHTML);
  
  const widgetData = {
    id: widgetId,
    name: name,
    content: contentHTML,
    x: widget.style.left,
    y: widget.style.top,
    width: widget.style.width,
    height: widget.style.height,
    userScale: userScale,
    pinned: isPinned,
    minimized: isMinimized,
    created: Date.now()
  };
  
  AppState.widgets.push(widgetData);
  updateWidgetCount();
  saveCurrentWorkspace();
  
  showToast('Widget added', `"${name}" added to toolbox`, '‚ûï', 2000);
  
  return widgetId;
}

function setupWidgetControls(widget, name, contentHTML) {
  const pinBtn = widget.querySelector('.pin-btn');
  pinBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    widget.classList.toggle('pinned');
    const isPinned = widget.classList.contains('pinned');
    pinBtn.classList.toggle('pinned', isPinned);
    pinBtn.title = isPinned ? 'Unpin' : 'Pin';
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) w.pinned = isPinned;
    
    if (isPinned) {
      AppState.pinnedWidgets.add(widget.id);
      showToast('Widget pinned', `"${name}" will stay in toolbox`, 'üìå', 2000);
    } else {
      AppState.pinnedWidgets.delete(widget.id);
    }
    saveCurrentWorkspace();
  });
  
  const minBtn = widget.querySelector('.minimize-btn');
  minBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    widget.classList.toggle('minimized');
    const isMin = widget.classList.contains('minimized');
    minBtn.innerHTML = isMin ? 'üóó' : 'üóï';
    minBtn.title = isMin ? 'Restore' : 'Minimize';
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) w.minimized = isMin;
    
    if (isMin) {
      AppState.minimizedWidgets.add(widget.id);
    } else {
      AppState.minimizedWidgets.delete(widget.id);
    }
    saveCurrentWorkspace();
  });
  
  const scaleDown = widget.querySelector('.scale-down');
  const scaleUp = widget.querySelector('.scale-up');
  const scaleReset = widget.querySelector('.scale-reset');
  const scaleDisplay = widget.querySelector('.scale-display');
  
  scaleDown.addEventListener('click', (e) => {
    e.stopPropagation();
    const current = parseFloat(widget.dataset.userScale || 1);
    const newScale = Math.max(0.5, current * 0.8);
    updateWidgetFontScale(widget, newScale);
    scaleDisplay.textContent = `${Math.round(newScale * 100)}%`;
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) { w.userScale = newScale; saveCurrentWorkspace(); }
  });
  
  scaleUp.addEventListener('click', (e) => {
    e.stopPropagation();
    const current = parseFloat(widget.dataset.userScale || 1);
    const newScale = Math.min(2.0, current * 1.2);
    updateWidgetFontScale(widget, newScale);
    scaleDisplay.textContent = `${Math.round(newScale * 100)}%`;
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) { w.userScale = newScale; saveCurrentWorkspace(); }
  });
  
  scaleReset.addEventListener('click', (e) => {
    e.stopPropagation();
    updateWidgetFontScale(widget, 1);
    scaleDisplay.textContent = '100%';
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) { w.userScale = 1; saveCurrentWorkspace(); }
  });
  
  widget.querySelector('.widget-close').addEventListener('click', (e) => {
    e.stopPropagation();
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w?.pinned) {
      showToast('Widget is pinned', 'Unpin before closing', 'üìå');
      return;
    }
    removeWidget(widget.id);
  });
}

function updateWidgetFontScale(widget, userScale = null) {
  const width = parseInt(widget.style.width) || widget.offsetWidth;
  const height = parseInt(widget.style.height) || widget.offsetHeight;
  const area = width * height;
  
  const areaRatio = area / 30000;
  const areaScale = Math.pow(areaRatio, 0.25);
  
  const userScaleFactor = userScale !== null ? userScale : (widget.dataset.userScale || 1);
  widget.dataset.userScale = userScaleFactor;
  
  const combinedScale = areaScale * userScaleFactor * AppState.globalFontScale;
  
  const baseSize = 14;
  let fontSize = baseSize * combinedScale;
  const minFont = 8;
  const maxFont = 32;
  fontSize = Math.max(minFont, Math.min(maxFont, fontSize));
  
  widget.style.setProperty('--widget-font-size', `${fontSize}px`);
  widget.style.setProperty('--widget-font-scale', AppState.globalFontScale);
  
  const body = widget.querySelector('.widget-body');
  if (body) {
    body.style.lineHeight = `${fontSize * 1.4}px`;
  }
}

function makeWidgetDraggable(widget) {
  const titlebar = widget.querySelector('.widget-titlebar');
  let isDragging = false;
  let dragOffset = { x: 0, y: 0 };
  let hasMoved = false;
  
  titlebar.addEventListener('mousedown', startDrag);
  
  function startDrag(e) {
    if (e.target.closest('.widget-controls')) return;
    
    isDragging = true;
    hasMoved = false;
    const rect = widget.getBoundingClientRect();
    const parentRect = widget.parentElement.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    widget.classList.add('dragging');
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
  }
  
  function onDrag(e) {
    if (!isDragging) return;
    e.preventDefault();
    hasMoved = true;
    
    const parentRect = widget.parentElement.getBoundingClientRect();
    let x = e.clientX - parentRect.left - dragOffset.x;
    let y = e.clientY - parentRect.top - dragOffset.y;
    
    const maxX = parentRect.width - widget.offsetWidth;
    const maxY = parentRect.height - widget.offsetHeight;
    
    x = Math.max(0, Math.min(x, maxX));
    y = Math.max(0, Math.min(y, maxY));
    
    if (AppState.snapToGrid) {
      x = Math.round(x / AppState.snapSize) * AppState.snapSize;
      y = Math.round(y / AppState.snapSize) * AppState.snapSize;
      widget.classList.add('snap-guide');
    }
    
    widget.style.left = `${x}px`;
    widget.style.top = `${y}px`;
  }
  
  function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    widget.classList.remove('dragging', 'snap-guide');
    
    if (hasMoved) {
      const w = AppState.widgets.find(w => w.id === widget.id);
      if (w) {
        w.x = widget.style.left;
        w.y = widget.style.top;
        saveCurrentWorkspace();
      }
    }
  }
}

function makeWidgetResizable(widget) {
  const resizeHandle = document.createElement('div');
  resizeHandle.style.cssText = 'position:absolute;right:0;bottom:0;width:16px;height:16px;cursor:se-resize;background:transparent;z-index:10;';
  resizeHandle.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16" style="opacity:0.3;"><path d="M8 8L16 16M12 16L16 12M16 8L8 16" stroke="currentColor" fill="none"/></svg>';
  widget.appendChild(resizeHandle);
  
  let isResizing = false;
  let startWidth, startHeight, startX, startY;
  
  resizeHandle.addEventListener('mousedown', startResize);
  
  function startResize(e) {
    e.stopPropagation();
    isResizing = true;
    startWidth = parseInt(getComputedStyle(widget).width);
    startHeight = parseInt(getComputedStyle(widget).height);
    startX = e.clientX;
    startY = e.clientY;
    
    document.addEventListener('mousemove', onResize);
    document.addEventListener('mouseup', stopResize);
  }
  
  function onResize(e) {
    if (!isResizing) return;
    e.preventDefault();
    
    const dx = e.clientX - startX;
    const dy = e.clientY - startY;
    
    let newWidth = Math.max(120, startWidth + dx);
    let newHeight = Math.max(80, startHeight + dy);
    
    if (AppState.snapToGrid) {
      newWidth = Math.round(newWidth / AppState.snapSize) * AppState.snapSize;
      newHeight = Math.round(newHeight / AppState.snapSize) * AppState.snapSize;
    }
    
    widget.style.width = `${newWidth}px`;
    widget.style.height = `${newHeight}px`;
    updateWidgetFontScale(widget);
  }
  
  function stopResize() {
    isResizing = false;
    document.removeEventListener('mousemove', onResize);
    document.removeEventListener('mouseup', stopResize);
    
    const w = AppState.widgets.find(w => w.id === widget.id);
    if (w) {
      w.width = widget.style.width;
      w.height = widget.style.height;
      saveCurrentWorkspace();
    }
  }
}

function removeWidget(widgetId) {
  const widget = document.getElementById(widgetId);
  const w = AppState.widgets.find(w => w.id === widgetId);
  
  if (widget) {
    widget.style.animation = 'widgetEnter 0.2s ease reverse';
    setTimeout(() => widget.remove(), 200);
  }
  
  AppState.widgets = AppState.widgets.filter(w => w.id !== widgetId);
  AppState.pinnedWidgets.delete(widgetId);
  AppState.minimizedWidgets.delete(widgetId);
  
  updateWidgetCount();
  saveCurrentWorkspace();
  
  if (w) {
    showToast('Widget removed', `"${w.name}" closed`, 'üóëÔ∏è', 2000);
  }
}

function updateWidgetCount() {
  const count = AppState.widgets.length;
  const pinned = AppState.widgets.filter(w => w.pinned).length;
  document.getElementById('widgetCount').textContent = `(${count}${pinned > 0 ? `, ${pinned}üìå` : ''})`;
}

function saveCurrentWorkspace() {
  AppState.workspaces[AppState.currentWorkspace].widgets = [...AppState.widgets];
  AppState.save();
  renderToolboxTabs();
}

function renderToolboxTabs() {
  const tabsContainer = document.getElementById('toolboxTabs');
  tabsContainer.innerHTML = '';
  
  AppState.workspaces.forEach((ws, index) => {
    const tab = document.createElement('div');
    tab.className = 'toolbox-tab';
    if (index === AppState.currentWorkspace) tab.classList.add('active');
    
    const widgetCount = ws.widgets?.length || 0;
    tab.innerHTML = `
      <span>${ws.name}</span>
      ${widgetCount > 0 ? `<small style="opacity:0.6;margin-left:4px;">(${widgetCount})</small>` : ''}
      ${AppState.workspaces.length > 1 ? `<span class="tab-close" data-index="${index}">√ó</span>` : ''}
    `;
    
    tab.addEventListener('click', (e) => {
      if (e.target.classList.contains('tab-close')) {
        e.stopPropagation();
        deleteWorkspace(index);
      } else {
        switchWorkspace(index);
      }
    });
    
    tabsContainer.appendChild(tab);
  });
}

function switchWorkspace(index) {
  // FIX: Use AppState instead of this
  AppState.workspaces[AppState.currentWorkspace].widgets = [...AppState.widgets];
  
  document.getElementById('toolboxContent').innerHTML = '';
  
  AppState.currentWorkspace = index;
  AppState.widgets = [...(AppState.workspaces[index]?.widgets || [])];
  
  AppState.widgets.forEach(w => {
    const widget = document.createElement('div');
    widget.className = 'widget-wrap';
    if (w.pinned) widget.classList.add('pinned');
    if (w.minimized) widget.classList.add('minimized');
    widget.id = w.id;
    widget.dataset.name = w.name;
    widget.dataset.userScale = w.userScale || 1;
    widget.dataset.created = w.created || Date.now();
    
    widget.style.left = w.x;
    widget.style.top = w.y;
    widget.style.width = w.width;
    widget.style.height = w.height;
    
    widget.innerHTML = `
      <div class="widget-titlebar">
        <div class="title-section">
          <strong>${w.name}</strong>
        </div>
        <div class="widget-controls">
          <button class="widget-btn pin-btn ${w.pinned ? 'pinned' : ''}" title="${w.pinned ? 'Unpin' : 'Pin'}">üìå</button>
          <button class="widget-btn minimize-btn" title="${w.minimized ? 'Restore' : 'Minimize'}">${w.minimized ? 'üóó' : 'üóï'}</button>
          <div class="widget-scale-controls">
            <button class="scale-btn scale-down" title="Smaller">A‚Åª</button>
            <span class="scale-display">${Math.round((w.userScale || 1) * 100)}%</span>
            <button class="scale-btn scale-up" title="Larger">A‚Å∫</button>
            <button class="scale-btn scale-reset" title="Reset">‚ü≤</button>
          </div>
          <button class="widget-close" title="Close">‚úï</button>
        </div>
      </div>
      <div class="widget-body">${w.content}</div>
    `;
    
    document.getElementById('toolboxContent').appendChild(widget);
    
    updateWidgetFontScale(widget, w.userScale || 1);
    makeWidgetDraggable(widget);
    makeWidgetResizable(widget);
    setupWidgetControls(widget, w.name, w.content);
  });
  
  document.getElementById('workspaceIndicator').textContent = AppState.current.name;
  updateWidgetCount();
  renderToolboxTabs();
  AppState.save();
  
  showToast('Workspace switched', `Now on "${AppState.current.name}"`, 'üóÇÔ∏è');
}

function deleteWorkspace(index) {
  if (!AppState.deleteWorkspace(index)) {
    showToast('Cannot delete', 'Keep at least one workspace', '‚ö†Ô∏è');
    return;
  }
  renderWorkspaceList();
  switchWorkspace(AppState.currentWorkspace);
  showToast('Workspace deleted', 'Switched to previous workspace', 'üóëÔ∏è');
}

function renderWorkspaceList() {
  const list = document.getElementById('workspaceList');
  list.innerHTML = '';
  
  AppState.workspaces.forEach((ws, index) => {
    const item = document.createElement('div');
    item.className = 'workspace-item';
    if (index === AppState.currentWorkspace) item.classList.add('active');
    
    item.innerHTML = `
      <span>${ws.name}</span>
      <span class="ws-shortcut">Ctrl+${index + 1}</span>
      <div class="workspace-actions">
        <button class="rename-ws" data-index="${index}" title="Rename">‚úèÔ∏è</button>
        ${AppState.workspaces.length > 1 ? `<button class="delete-ws" data-index="${index}" title="Delete">üóëÔ∏è</button>` : ''}
      </div>
    `;
    
    item.addEventListener('click', () => {
      switchWorkspace(index);
      document.getElementById('palettePanel').classList.remove('open');
    });
    
    list.appendChild(item);
  });
  
  list.querySelectorAll('.rename-ws').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const idx = parseInt(btn.dataset.index);
      const newName = prompt('Rename workspace:', AppState.workspaces[idx].name);
      if (newName) {
        AppState.renameWorkspace(idx, newName);
        renderWorkspaceList();
        renderToolboxTabs();
      }
    });
  });
  
  list.querySelectorAll('.delete-ws').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      deleteWorkspace(parseInt(btn.dataset.index));
    });
  });
}

function initToolbox() {
  const toolbox = document.getElementById('toolbox');
  const toolboxTitle = document.getElementById('toolboxTitle');
  
  let isDragging = false;
  let dragOffset = { x: 0, y: 0 };
  
  toolboxTitle.addEventListener('mousedown', (e) => {
    if (e.target.closest('button')) return;
    
    isDragging = true;
    const rect = toolbox.getBoundingClientRect();
    dragOffset.x = e.clientX - rect.left;
    dragOffset.y = e.clientY - rect.top;
    
    document.addEventListener('mousemove', onDrag);
    document.addEventListener('mouseup', stopDrag);
    toolboxTitle.style.cursor = 'grabbing';
  });
  
  function onDrag(e) {
    if (!isDragging) return;
    e.preventDefault();
    
    toolbox.style.left = 'auto';
    toolbox.style.right = 'auto';
    toolbox.style.top = `${e.clientY - dragOffset.y}px`;
    toolbox.style.left = `${e.clientX - dragOffset.x}px`;
    AppState.toolboxDocked = false;
  }
  
  function stopDrag() {
    isDragging = false;
    document.removeEventListener('mousemove', onDrag);
    document.removeEventListener('mouseup', stopDrag);
    toolboxTitle.style.cursor = '';
  }
  
  document.getElementById('dockBtn').addEventListener('click', () => {
    AppState.toolboxDocked = !AppState.toolboxDocked;
    const btn = document.getElementById('dockBtn');
    
    if (AppState.toolboxDocked) {
      toolbox.style.left = 'auto';
      toolbox.style.top = 'auto';
      toolbox.style.right = '18px';
      toolbox.style.bottom = '18px';
      btn.textContent = '‚á≤';
      showToast('Toolbox docked', 'Reset to corner position', 'üìç');
    } else {
      btn.textContent = '‚á±';
    }
  });
  
  document.getElementById('minimizeToolboxBtn').addEventListener('click', () => {
    toolbox.classList.toggle('minimized');
    AppState.toolboxMinimized = toolbox.classList.contains('minimized');
    showToast(AppState.toolboxMinimized ? 'Toolbox minimized' : 'Toolbox restored', '', AppState.toolboxMinimized ? 'üóï' : 'üóó', 2000);
  });
  
  document.getElementById('saveWorkspaceBtn').addEventListener('click', () => {
    saveCurrentWorkspace();
    showToast('Workspace saved', `"${AppState.current.name}" saved with ${AppState.widgets.length} widgets`, 'üíæ');
  });
  
  document.getElementById('clearWidgetsBtn').addEventListener('click', () => {
    const pinned = AppState.widgets.filter(w => w.pinned);
    const unpinned = AppState.widgets.filter(w => !w.pinned);
    
    if (unpinned.length === 0) {
      showToast('Nothing to clear', pinned.length > 0 ? `${pinned.length} widgets are pinned` : 'Toolbox is empty', '‚ÑπÔ∏è');
      return;
    }
    
    if (confirm(`Clear ${unpinned.length} unpinned widgets?`)) {
      unpinned.forEach(w => {
        const el = document.getElementById(w.id);
        if (el) el.remove();
      });
      AppState.widgets = pinned;
      updateWidgetCount();
      saveCurrentWorkspace();
      showToast('Widgets cleared', `Kept ${pinned.length} pinned widgets`, 'üóëÔ∏è');
    }
  });
  
  document.getElementById('widgetSearch').addEventListener('input', (e) => {
    const q = e.target.value.toLowerCase();
    document.querySelectorAll('.widget-wrap').forEach(w => {
      const name = w.dataset.name.toLowerCase();
      w.style.opacity = name.includes(q) ? '1' : '0.3';
    });
  });
}

function animateToToolbox(element) {
  const rect = element.getBoundingClientRect();
  const clone = element.cloneNode(true);
  clone.classList.add('fly-animation');
  clone.style.left = `${rect.left}px`;
  clone.style.top = `${rect.top}px`;
  clone.style.width = `${rect.width}px`;
  clone.style.height = `${rect.height}px`;
  
  document.body.appendChild(clone);
  setTimeout(() => clone.remove(), 400);
}

function addEmbedSectionToCard(card, fileName) {
  const cardName = fileName.replace('.html', '');
  const displayName = cardName.replace(/-/g, ' ');
  
  const embedHTML = `
    <div class="embed-section">
      <span>Share this tool:</span>
      <button class="embed-btn" data-card="${cardName}" data-file="${fileName}">
        üîó Copy Embed Code
      </button>
    </div>
  `;
  
  const contentDiv = card.querySelector('.content');
  if (contentDiv) {
    contentDiv.insertAdjacentHTML('beforeend', embedHTML);
    
    const embedBtn = contentDiv.querySelector('.embed-btn');
    if (embedBtn) {
      embedBtn.addEventListener('click', () => {
        copyEmbedCode(cardName, fileName, displayName);
      });
    }
  }
}

function copyEmbedCode(cardName, fileName, displayName) {
  const embedCode = `<iframe src="https://mrpr0phecy.github.io/mrpr0phecy/cards/${fileName}" width="100%" height="400" style="border:none;border-radius:12px;box-shadow:0 8px 32px rgba(0,0,0,0.3);" title="${displayName} - The Most Useful Site"></iframe>`;
  
  navigator.clipboard.writeText(embedCode).then(() => {
    const embedBtn = document.querySelector(`.embed-btn[data-card="${cardName}"]`);
    if (embedBtn) {
      embedBtn.textContent = '‚úÖ Copied!';
      embedBtn.classList.add('copied');
      setTimeout(() => {
        embedBtn.textContent = 'üîó Copy Embed Code';
        embedBtn.classList.remove('copied');
      }, 2000);
    }
  }).catch(() => {
    const textArea = document.createElement('textarea');
    textArea.value = embedCode;
    document.body.appendChild(textArea);
    textArea.select();
    document.execCommand('copy');
    document.body.removeChild(textArea);
  });
}

function initPalette() {
  document.getElementById('paletteToggle').addEventListener('click', () => {
    document.getElementById('palettePanel').classList.toggle('open');
    document.getElementById('shortcutsPanel').classList.remove('open');
  });
  
  document.querySelectorAll('.palette-color').forEach(c => {
    c.addEventListener('click', function() {
      document.querySelectorAll('.palette-color').forEach(x => x.classList.remove('active'));
      this.classList.add('active');
      const col = this.dataset.accent;
      document.documentElement.style.setProperty('--accent', col);
      localStorage.setItem('accent', col);
    });
  });
  
  document.querySelectorAll('.theme-btn').forEach(btn => {
    btn.addEventListener('click', function() {
      document.querySelectorAll('.theme-btn').forEach(b => {
        b.classList.remove('active');
        b.style.border = '1px solid var(--border)';
      });
      this.classList.add('active');
      this.style.border = '2px solid var(--accent)';
      
      applyTheme(this.dataset.color);
    });
  });
  
  document.getElementById('applyCustomTheme').addEventListener('click', () => {
    const c1 = document.getElementById('customColor1').value;
    const c2 = document.getElementById('customColor2').value;
    applyTheme('custom', { c1, c2 });
    
    const customName = `custom-${Date.now()}`;
    AppState.customThemes[customName] = { c1, c2 };
    AppState.save();
    
    showToast('Custom theme applied', `${c1} ‚Üí ${c2}`, 'üé®');
  });
  
  const scaleSlider = document.getElementById('globalFontScale');
  const scaleValue = document.getElementById('fontScaleValue');
  
  scaleSlider.addEventListener('input', () => {
    const val = parseFloat(scaleSlider.value);
    AppState.globalFontScale = val;
    scaleValue.textContent = `${Math.round(val * 100)}%`;
    document.documentElement.style.setProperty('--global-font-scale', val);
    
    document.querySelectorAll('.widget-wrap').forEach(w => {
      updateWidgetFontScale(w);
    });
    
    AppState.save();
  });
  
  document.getElementById('snapToGrid').addEventListener('change', (e) => {
    AppState.snapToGrid = e.target.checked;
    AppState.save();
    showToast(e.target.checked ? 'Snap enabled' : 'Snap disabled', 'Widgets will ' + (e.target.checked ? 'snap to grid' : 'move freely'), e.target.checked ? 'üß≤' : 'üîì');
  });
  
  document.getElementById('newWorkspaceBtn').addEventListener('click', () => {
    const name = prompt('Workspace name:', `Workspace ${AppState.workspaces.length + 1}`);
    if (name) {
      const idx = AppState.addWorkspace(name);
      renderWorkspaceList();
      switchWorkspace(idx);
      showToast('Workspace created', `"${name}" is now active`, '‚ú®');
    }
  });
}

function initShortcuts() {
  document.getElementById('shortcutsToggle').addEventListener('click', () => {
    document.getElementById('shortcutsPanel').classList.toggle('open');
    document.getElementById('palettePanel').classList.remove('open');
  });
}

function initKeyboardShortcuts() {
  document.addEventListener('keydown', (e) => {
    if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
      e.preventDefault();
      document.getElementById('searchInput').focus();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.shiftKey && e.key === 'T') {
      e.preventDefault();
      document.getElementById('toolboxToggle').click();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'm') {
      e.preventDefault();
      document.getElementById('minimizeToolboxBtn').click();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 's') {
      e.preventDefault();
      document.getElementById('saveWorkspaceBtn').click();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
      e.preventDefault();
      document.getElementById('newWorkspaceBtn').click();
    }
    
    if ((e.ctrlKey || e.metaKey) && e.key >= '1' && e.key <= '5') {
      const idx = parseInt(e.key) - 1;
      if (idx < AppState.workspaces.length) {
        e.preventDefault();
        switchWorkspace(idx);
      }
    }
    
    if (e.key === 'Escape') {
      const palette = document.getElementById('palettePanel');
      const shortcuts = document.getElementById('shortcutsPanel');
      const toolbox = document.getElementById('toolbox');
      
      if (palette.classList.contains('open')) {
        palette.classList.remove('open');
      } else if (shortcuts.classList.contains('open')) {
        shortcuts.classList.remove('open');
      } else if (!toolbox.classList.contains('minimized') && !toolbox.classList.contains('hidden')) {
        document.getElementById('minimizeToolboxBtn').click();
      }
    }
  });
}

function initReaderMode() {
  document.getElementById('readerToggle').addEventListener('click', () => {
    document.body.classList.toggle('reader-mode');
    const isOn = document.body.classList.contains('reader-mode');
    localStorage.setItem('readerMode', isOn ? 'on' : 'off');
    document.getElementById('readerToggle').classList.toggle('active', isOn);
  });
}

function initSearch() {
  let debounceTimer;
  const searchInput = document.getElementById('searchInput');
  
  searchInput.addEventListener('input', (e) => {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      const q = e.target.value.toLowerCase();
      document.querySelectorAll('.card').forEach(card => {
        const name = card.dataset.name.toLowerCase();
        const text = card.textContent.toLowerCase();
        card.style.display = name.includes(q) || text.includes(q) ? '' : 'none';
      });
    }, 150);
  });
}

function initSortButtons() {
  document.getElementById('sortAlphaBtn').addEventListener('click', () => {
    const grid = document.getElementById('gridContainer');
    const cards = Array.from(grid.children);
    cards.sort((a,b) => a.dataset.name.localeCompare(b.dataset.name));
    cards.forEach(card => grid.appendChild(card));
  });
  
  document.getElementById('sortRandomBtn').addEventListener('click', () => {
    const grid = document.getElementById('gridContainer');
    const cards = Array.from(grid.children);
    for (let i = cards.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [cards[i], cards[j]] = [cards[j], cards[i]];
    }
    cards.forEach(card => grid.appendChild(card));
  });
}

function initToolboxToggle() {
  const toolbox = document.getElementById('toolbox');
  
  document.getElementById('toolboxToggle').addEventListener('click', () => {
    toolbox.classList.toggle('hidden');
    document.getElementById('toolboxToggle').classList.toggle('active', !toolbox.classList.contains('hidden'));
    
    if (!toolbox.classList.contains('hidden') && AppState.toolboxMinimized) {
      toolbox.classList.add('minimized');
    }
  });
  
  document.getElementById('toolboxClose').addEventListener('click', (e) => {
    e.stopPropagation();
    toolbox.classList.add('hidden');
    document.getElementById('toolboxToggle').classList.remove('active');
  });
}

let cardQueue = [];
let isCardLoading = false;
const BATCH_SIZE = 5;
const BATCH_DELAY = 50;

function loadCardBatch() {
  if (isCardLoading || cardQueue.length === 0) return;
  
  isCardLoading = true;
  const batch = cardQueue.splice(0, BATCH_SIZE);
  let loadedCount = 0;
  
  batch.forEach((cardData, index) => {
    setTimeout(() => {
      const { card, file, name } = cardData;
      const content = card.querySelector('.content');
      
      fetch(`cards/${file}`)
        .then(r => r.ok ? r.text() : Promise.reject())
        .then(html => {
          content.innerHTML = html;
          addEmbedSectionToCard(card, file);
          
          const scripts = content.querySelectorAll('script');
          scripts.forEach(script => {
            const newScript = document.createElement('script');
            if (script.src) newScript.src = script.src;
            else newScript.textContent = script.textContent;
            [...script.attributes].forEach(attr => newScript.setAttribute(attr.name, attr.value));
            script.parentNode.replaceChild(newScript, script);
          });
        })
        .catch(() => {
          content.textContent = 'Preview unavailable';
          addEmbedSectionToCard(card, file);
        })
        .finally(() => {
          loadedCount++;
          
          setTimeout(() => card.classList.add('visible'), index * 30);
          
          const totalCards = document.querySelectorAll('.card').length;
          const loadedCards = document.querySelectorAll('.card.visible').length;
          document.getElementById('status').textContent = `Loaded ${loadedCards} of ${totalCards} tools`;
          
          if (loadedCount === batch.length) {
            isCardLoading = false;
            if (cardQueue.length > 0) {
              setTimeout(loadCardBatch, BATCH_DELAY);
            } else {
              document.getElementById('status').textContent = `${totalCards} tools loaded`;
            }
          }
        });
    }, index * 20);
  });
}

async function loadDashboard() {
  try {
    const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
    const DEFAULT_BRANCH = 'main';
    const [owner, repo] = DEFAULT_REPO

.split('/');
plain
Copy

document.getElementById('status').textContent = 'Fetching card list...';

const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${DEFAULT_BRANCH}?recursive=1`;
const response = await fetch(url);
const data = await response.json();

const cardFiles = (data.tree || [])
  .filter(item => item.path.startsWith('cards/') && item.path.endsWith('.html'))
  .map(item => item.path.replace(/^cards\//, ''));

console.log("Found", cardFiles.length, "cards");

const grid = document.getElementById('gridContainer');

if (!cardFiles.length) {
  document.getElementById('status').textContent = 'No cards found';
  return;
}

grid.innerHTML = '';
cardQueue = [];

cardFiles.sort().forEach(file => {
  const name = file.replace('.html', '');
  const card = document.createElement('div');
  card.className = 'card';
  card.dataset.file = file;
  card.dataset.name = name;
  
  const header = document.createElement('div');
  header.className = 'card-header';
  header.innerHTML = `
    <h3>${name}</h3>
    <div style="display:flex;gap:8px;align-items:center;">
      <button class="reader-card-toggle" title="Expand in reader mode">üìÑ</button>
      <div class="add-to-toolbox" title="Add to toolbox" style="cursor:pointer;font-weight:bold;color:var(--accent);font-size:18px;">+</div>
    </div>
  `;
  
  const content = document.createElement('div');
  content.className = 'content';
  content.textContent = 'Loading‚Ä¶';
  
  card.appendChild(header);
  card.appendChild(content);
  grid.appendChild(card);
  
  cardQueue.push({ card, file, name });
  
  header.querySelector('.reader-card-toggle').addEventListener('click', () => {
    card.classList.toggle('reader-expanded');
    header.querySelector('.reader-card-toggle').classList.toggle('active');
  });
});

document.getElementById('status').textContent = `Loading 0 of ${cardFiles.length} tools...`;
setTimeout(loadCardBatch, 300);

} catch (error) {
console.error("Error loading dashboard:", error);
document.getElementById('status').textContent = 'Error loading cards: ' + error.message;
}
}
function initAddToToolbox() {
document.addEventListener('click', (e) => {
const addBtn = e.target.closest('.add-to-toolbox');
if (!addBtn) return;
plain
Copy

const card = addBtn.closest('.card');
if (!card) return;

const cardName = card.dataset.name;
const contentElement = card.querySelector('.content');
const contentHTML = contentElement.innerHTML;

animateToToolbox(card);

const widgetId = createWidget(cardName, contentHTML);

if (widgetId) {
  const toolbox = document.getElementById('toolbox');
  toolbox.classList.remove('hidden');
  document.getElementById('toolboxToggle').classList.add('active');
  
  addBtn.textContent = '‚úì';
  addBtn.style.color = 'var(--accent)';
  setTimeout(() => {
    addBtn.textContent = '+';
    addBtn.style.color = '';
  }, 1000);
}

});
}
// Wrap initialization in try-catch to catch any errors
document.addEventListener('DOMContentLoaded', () => {
try {
console.log("=== DOM READY ===");
plain
Copy

window.scrollTo(0, 0);

AppState.init();

const savedTheme = localStorage.getItem('theme') || 'default';
applyTheme(savedTheme);

const savedAccent = localStorage.getItem('accent') || '#2dd4ff';
document.documentElement.style.setProperty('--accent', savedAccent);

if (localStorage.getItem('readerMode') === 'on') {
  document.body.classList.add('reader-mode');
  document.getElementById('readerToggle').classList.add('active');
}

document.getElementById('globalFontScale').value = AppState.globalFontScale;
document.getElementById('fontScaleValue').textContent = `${Math.round(AppState.globalFontScale * 100)}%`;
document.documentElement.style.setProperty('--global-font-scale', AppState.globalFontScale);
document.getElementById('snapToGrid').checked = AppState.snapToGrid;

initToolbox();
initToolboxToggle();
initPalette();
initShortcuts();
initKeyboardShortcuts();
initReaderMode();
initSearch();
initSortButtons();
initAddToToolbox();

renderWorkspaceList();
renderToolboxTabs();

// Only restore workspace if we have saved widgets, otherwise start fresh
if (AppState.widgets.length > 0) {
  switchWorkspace(AppState.currentWorkspace);
} else {
  document.getElementById('workspaceIndicator').textContent = AppState.current.name;
  updateWidgetCount();
}

// Load cards last
loadDashboard();

new Sortable(document.getElementById('gridContainer'), { animation: 150 });

setTimeout(() => {
  const searchBar = document.querySelector('.search-bar');
  if (searchBar) searchBar.scrollIntoView({ behavior: 'smooth', block: 'start' });
  document.getElementById('searchInput')?.focus();
}, 100);

} catch (err) {
console.error("Initialization error:", err);
document.getElementById('status').textContent = 'Error initializing app: ' + err.message;
}
});
window.addEventListener('load', () => {
window.scrollTo(0, 0);
});
if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
document.documentElement.style.setProperty('--card-min', '280px');
const toolbox = document.getElementById('toolbox');
if (toolbox) {
toolbox.style.minWidth = '280px';
toolbox.style.minHeight = '300px';
}
}
console.log("=== ENHANCED APP INITIALIZED ===");
</body>
</html>
