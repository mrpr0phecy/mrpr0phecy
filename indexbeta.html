<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Most Useful Site in the World</title>
<meta name="description" content="The Most Useful Site in the World" />
<style>
  :root{
    --accent:#2dd4ff;
    --muted:#e6faff;
    --text:#e6faff;
    --bg-1:#0f1720;
    --bg-2:#1b2630;
    --glass: rgba(255,255,255,0.06);
    --glass-strong: rgba(255,255,255,0.08);
    --panel: rgba(20,20,20,0.9);
    --card-grad-1: rgba(255,255,255,0.04);
    --card-grad-2: rgba(255,255,255,0.07);
    --border: rgba(255,255,255,0.10);
    --shadow: 0 14px 40px rgba(0,0,0,0.6);
    --card-size: 100%;
    --card-min: 300px;
  }

  html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:var(--text);-webkit-font-smoothing:antialiased}
  /* static background logo */
  body::before{
    content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
    background:url("/logo.png") no-repeat center;background-size:min(50vw,520px);
    opacity:0.06;filter:blur(0.6px);mix-blend-mode:screen;
  }

  header{padding:20px;text-align:center;z-index:2}
  header h1{margin:0;color:var(--accent);font-size:1.6rem}

  /* bottom-left controls */
  .control-btn{position:fixed;bottom:18px;z-index:10000;width:48px;height:48px;border-radius:12px;background:var(--glass-strong);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(8px);box-shadow:0 6px 20px rgba(0,0,0,0.45);color:var(--accent)}
  .control-btn:hover{transform:scale(1.06)}
  #toolboxToggle{left:18px}
  #paletteToggle{left:78px}
  #readerToggle{left:138px}

  .panel{position:fixed;bottom:74px;z-index:9998;background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:var(--shadow);backdrop-filter:blur(12px);transform:translateY(8px) scale(.98);opacity:0;pointer-events:none;transition:transform .18s,opacity .18s}
  .panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}

  .palette-panel{left:78px;width:320px}
  .toolbox-panel{left:18px;min-width:300px;max-width:60vw;max-height:65vh;overflow:auto}

  .search-bar{max-width:920px;margin:14px auto 16px;display:flex;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border-radius:12px;padding:12px 16px;border:1px solid rgba(255,255,255,0.04)}
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}

  .controls{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .controls button{padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}

  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--card-min),1fr));gap:20px;padding:20px;align-items:start}
  .card{position:relative;background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));border:1px solid var(--border);border-radius:12px;padding:16px;backdrop-filter:blur(8px);width:var(--card-size);opacity:0;transform:translateY(24px) scale(.98);transition:opacity .45s cubic-bezier(.2,.9,.2,1),transform .45s cubic-bezier(.2,.9,.2,1);box-shadow:0 8px 24px rgba(0,0,0,0.35);overflow:hidden;min-width:0}
  .card.visible{opacity:1;transform:none}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}
  .add-to-toolbox,.remove-from-toolbox{width:30px;height:30px;border-radius:8px;background:var(--glass-strong);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer}
  .add-to-toolbox{color:var(--accent)}
  .remove-from-toolbox{color:#ff4d4d}

  .palette-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin-top:8px}
  .palette-color{width:34px;height:34px;border-radius:8px;cursor:pointer;border:2px solid transparent;transition:border .18s}
  .palette-color.active{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,0.28)}

  .toolbox-controls{display:flex;align-items:center;gap:12px;margin-bottom:12px}
  .toolbox-controls label{color:var(--muted);font-size:.95rem}

  .resize-row{display:flex;align-items:center;gap:8px;margin-top:10px}
  .resize-row input[type="range"]{flex:1}

  .status{text-align:center;color:var(--muted);margin:6px 0 8px;font-size:.95rem}

  body.reader-mode {font-size:1.12rem;line-height:1.6}
  body.reader-mode .card{padding:20px}
</style>
</head>
<body>
  <button id="toolboxToggle" class="control-btn" title="Toolbox">â˜°</button>
  <button id="paletteToggle" class="control-btn" title="Theme">ðŸŽ¨</button>
  <button id="readerToggle" class="control-btn" title="Reader Mode">ðŸ‘“</button>

  <!-- Palette panel -->
  <div class="panel palette-panel" id="palettePanel" aria-hidden="true">
    <div style="color:var(--accent);font-weight:600;margin-bottom:8px">Accent color</div>
    <div class="palette-grid" id="paletteGrid">
      <div class="palette-color active" data-accent="#2dd4ff" style="background:#2dd4ff"></div>
      <div class="palette-color" data-accent="#ff2d55" style="background:#ff2d55"></div>
      <div class="palette-color" data-accent="#00ff99" style="background:#00ff99"></div>
      <div class="palette-color" data-accent="#ffcc00" style="background:#ffcc00"></div>
      <div class="palette-color" data-accent="#9d4edd" style="background:#9d4edd"></div>
      <div class="palette-color" data-accent="#ff006e" style="background:#ff006e"></div>
      <div class="palette-color" data-accent="#00d4ff" style="background:#00d4ff"></div>
      <div class="palette-color" data-accent="#ff9500" style="background:#ff9500"></div>
      <div class="palette-color" data-accent="#32d74b" style="background:#32d74b"></div>
      <div class="palette-color" data-accent="#ff5e3a" style="background:#ff5e3a"></div>
    </div>
  </div>

  <!-- Toolbox panel -->
  <div class="panel toolbox-panel" id="toolboxPanel" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px">
      <div style="color:var(--accent);font-weight:600">Toolbox</div>
      <div style="color:var(--muted);font-size:.9rem">Customize cards</div>
    </div>

    <div class="toolbox-controls">
      <label for="cardSizeSlider">Cards size</label>
      <input id="cardSizeSlider" type="range" min="70" max="140" value="100" step="5" />
      <div id="sizeValue">100%</div>
    </div>

    <div id="toolboxList" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px"></div>
  </div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main>
    <div class="search-bar"><input id="searchInput" type="text" placeholder="Search cards..." /></div>

    <div class="controls">
      <button id="sortAlphaBtn">Sort Aâ†’Z</button>
      <button id="sortRandomBtn">Random</button>
      <button id="reDealBtn">Reâ€‘deal</button>
    </div>

    <div class="status" id="status">Loading cards...</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
  // Simple, stable loader that worked previously
  const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
  const DEFAULT_BRANCH = 'main';

  function parseOwnerRepo(str){ const p = str.split('/'); return { owner: p[0], repo: p[1] }; }

  async function fetchRepoTree(owner, repo, branch){
    const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('GitHub API error: ' + r.status);
    return r.json();
  }

  async function getCardFiles(owner, repo, branch){
    const data = await fetchRepoTree(owner, repo, branch);
    return (data.tree || []).filter(item => item.path.startsWith('cards/') && item.path.endsWith('.html')).map(item => item.path.replace(/^cards\//,''));
  }

  function createCardElement(file){
    const name = file.replace('.html','');
    const card = document.createElement('div');
    card.className = 'card';
    card.dataset.file = file;
    card.dataset.name = name;

    const header = document.createElement('div');
    header.className = 'card-header';
    const title = document.createElement('h3');
    title.textContent = name;
    const btnWrap = document.createElement('div');
    btnWrap.style.display = 'flex';
    btnWrap.style.gap = '8px';

    const addBtn = document.createElement('div');
    addBtn.className = 'add-to-toolbox';
    addBtn.title = 'Add to toolbox';
    addBtn.textContent = '+';
    addBtn.addEventListener('click', (e) => { e.stopPropagation(); addToToolbox(file); });

    btnWrap.appendChild(addBtn);
    header.appendChild(title);
    header.appendChild(btnWrap);
    card.appendChild(header);

    const content = document.createElement('div');
    content.className = 'content';
    content.textContent = 'Loadingâ€¦';
    card.appendChild(content);

    // lazy load content when card is near viewport
    const obs = new IntersectionObserver(entries => {
      entries.forEach(entry => {
        if(entry.isIntersecting){
          loadCardContentInto(card, file);
          obs.unobserve(card);
        }
      });
    }, { threshold: 0.08, rootMargin: '160px 0px 160px 0px' });
    obs.observe(card);

    // small reveal timing to avoid uniform jerkiness
    setTimeout(() => card.classList.add('visible'), Math.random() * 220 + 80);

    return card;
  }

  async function loadCardContentInto(card, file){
    if(card.dataset.loaded) return;
    try{
      const r = await fetch(`cards/${file}`);
      if(!r.ok){ card.querySelector('.content').textContent = 'Preview unavailable'; return; }
      let html = await r.text();
      // strip scripts for safety
      html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi, '');
      // make images lazy
      html = html.replace(/<img\b([^>]*?)>/gi, (m, attrs) => /loading\s*=/.test(attrs) ? `<img${attrs}>` : `<img loading="lazy"${attrs}>`);
      card.querySelector('.content').innerHTML = html;
      card.dataset.loaded = 'true';
    }catch(e){
      card.querySelector('.content').textContent = 'Failed to load';
    }
  }

  // toolbox storage
  const TOOLBOX_KEY = 'toolbox_items_v1';
  function loadToolboxStore(){ try { return JSON.parse(localStorage.getItem(TOOLBOX_KEY) || '[]'); } catch(e) { return []; } }
  function saveToolboxStore(items){ localStorage.setItem(TOOLBOX_KEY, JSON.stringify(items)); }
  let toolboxItems = loadToolboxStore();

  function renderToolboxPanel(){
    const list = document.getElementById('toolboxList');
    list.innerHTML = '';
    if(!toolboxItems.length){
      list.innerHTML = '<div style="color:var(--muted)">No items in toolbox. Add tools by pressing + on any card.</div>';
      return;
    }
    toolboxItems.forEach(file => {
      const el = document.createElement('div');
      el.className = 'card visible';
      el.style.padding = '10px';
      el.style.minWidth = '180px';
      el.style.display = 'flex';
      el.style.flexDirection = 'column';
      el.style.gap = '8px';
      el.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${file.replace('.html','')}</strong><button class="btn-remove" style="background:transparent;border:0;color:#ff6b6b;cursor:pointer">âœ•</button></div><div style="color:var(--muted);font-size:.9rem">Pinned tool</div>`;
      el.querySelector('.btn-remove').addEventListener('click', ()=> removeFromToolbox(file));
      list.appendChild(el);
    });
  }

  function addToToolbox(file){
    if(toolboxItems.includes(file)){ openToolbox(); return; }
    toolboxItems.unshift(file);
    if(toolboxItems.length > 80) toolboxItems.length = 80;
    saveToolboxStore(toolboxItems);
    renderToolboxPanel();
    openToolbox();
  }

  function removeFromToolbox(file){
    const idx = toolboxItems.indexOf(file);
    if(idx >= 0){ toolboxItems.splice(idx,1); saveToolboxStore(toolboxItems); renderToolboxPanel(); }
  }

  // palette handling (changes multiple page vars)
  document.querySelectorAll('.palette-color').forEach(c => {
    c.addEventListener('click', () => {
      document.querySelectorAll('.palette-color').forEach(x => x.classList.remove('active'));
      c.classList.add('active');
      const col = c.dataset.accent;
      applyAccent(col);
      localStorage.setItem('accent', col);
    });
  });

  function applyAccent(hex){
    document.documentElement.style.setProperty('--accent', hex);
    // derive subtle variations for other parts
    // simple approach: set glass and card gradients using rgba mixes
    const rgb = hexToRgb(hex);
    if(rgb){
      document.documentElement.style.setProperty('--glass', `rgba(${rgb.r},${rgb.g},${rgb.b},0.06)`);
      document.documentElement.style.setProperty('--glass-strong', `rgba(${rgb.r},${rgb.g},${rgb.b},0.10)`);
      document.documentElement.style.setProperty('--card-grad-1', `rgba(${Math.min(255,rgb.r+18)},${Math.min(255,rgb.g+18)},${Math.min(255,rgb.b+18)},0.04)`);
      document.documentElement.style.setProperty('--card-grad-2', `rgba(${Math.min(255,rgb.r+36)},${Math.min(255,rgb.g+36)},${Math.min(255,rgb.b+36)},0.07)`);
    }
  }
  function hexToRgb(hex){
    try{
      hex = hex.replace('#','');
      if(hex.length === 3) hex = hex.split('').map(c=>c+c).join('');
      const n = parseInt(hex,16);
      return { r: (n>>16)&255, g: (n>>8)&255, b: n&255 };
    }catch(e){ return null; }
  }
  // restore saved accent
  if(localStorage.getItem('accent')){
    const saved = localStorage.getItem('accent');
    document.documentElement.style.setProperty('--accent', saved);
    document.querySelector(`.palette-color[data-accent="${saved}"]`)?.classList.add('active');
    applyAccent(saved);
  }

  // card size slider (global)
  const cardSizeSlider = document.getElementById('cardSizeSlider');
  const sizeValue = document.getElementById('sizeValue');
  cardSizeSlider.addEventListener('input', (e) => {
    const v = e.target.value + '%';
    document.documentElement.style.setProperty('--card-size', v);
    sizeValue.textContent = v;
    localStorage.setItem('cardSize', v);
  });
  const savedSize = localStorage.getItem('cardSize');
  if(savedSize){ document.documentElement.style.setProperty('--card-size', savedSize); sizeValue.textContent = savedSize; cardSizeSlider.value = savedSize.replace('%',''); }

  // panel toggles
  document.getElementById('paletteToggle').addEventListener('click', ()=> document.getElementById('palettePanel').classList.toggle('open'));
  document.getElementById('toolboxToggle').addEventListener('click', ()=> document.getElementById('toolboxPanel').classList.toggle('open'));
  document.getElementById('readerToggle').addEventListener('click', ()=> document.body.classList.toggle('reader-mode'));

  // search and sort
  document.getElementById('searchInput').addEventListener('input', (e) => {
    const q = (e.target.value || '').trim().toLowerCase();
    document.querySelectorAll('#gridContainer .card').forEach(card => {
      const name = (card.dataset.name || '').toLowerCase();
      const text = (card.textContent || '').toLowerCase();
      const show = !q || name.includes(q) || text.includes(q);
      card.style.display = show ? '' : 'none';
    });
  });

  document.getElementById('sortAlphaBtn').addEventListener('click', () => {
    const grid = document.getElementById('gridContainer');
    const nodes = Array.from(grid.children);
    nodes.sort((a,b) => a.dataset.name.localeCompare(b.dataset.name, undefined, {sensitivity:'base', numeric:true}));
    nodes.forEach(n => grid.appendChild(n));
    triggerDeal();
  });

  document.getElementById('sortRandomBtn').addEventListener('click', () => {
    const grid = document.getElementById('gridContainer');
    const nodes = Array.from(grid.children);
    for(let i = nodes.length - 1; i > 0; i--){
      const j = Math.floor(Math.random() * (i + 1));
      [nodes[i], nodes[j]] = [nodes[j], nodes[i]];
    }
    nodes.forEach(n => grid.appendChild(n));
    triggerDeal();
  });

  document.getElementById('reDealBtn').addEventListener('click', triggerDeal);

  function triggerDeal(){
    const cards = Array.from(document.querySelectorAll('#gridContainer .card'));
    cards.forEach((c, i) => {
      c.classList.remove('visible');
      // staggered but quick
      setTimeout(() => c.classList.add('visible'), i * 60);
    });
  }

  // Sortable for drag reorder
  new Sortable(document.getElementById('gridContainer'), { animation: 150 });
  new Sortable(document.getElementById('toolboxList'), { animation: 150 });

  // load dashboard
  async function loadDashboard(){
    const { owner, repo } = parseOwnerRepo(DEFAULT_REPO);
    try{
      const files = await getCardFiles(owner, repo, DEFAULT_BRANCH);
      if(!files.length){ document.getElementById('status').textContent = 'No cards folder found'; return; }
      files.sort((a,b) => a.localeCompare(b, undefined, {sensitivity:'base', numeric:true}));
      const grid = document.getElementById('gridContainer');
      grid.innerHTML = '';
      files.forEach(f => grid.appendChild(createCardElement(f)));
      document.getElementById('status').textContent = `${files.length} tools loaded â€” dealingâ€¦`;
      setTimeout(triggerDeal, 200);
    }catch(e){
      document.getElementById('status').textContent = 'Check repo name or cards/ folder';
      console.error(e);
    }
  }

  // initial toolbox render
  renderToolboxPanel();

  // start
  loadDashboard();
</script>
</body>
</html>
