<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>The Most Useful Site in the World</title>
<meta name="description" content="The Most Useful Site in the World" />

<style>
  :root{
    --accent:#2dd4ff;
    --muted:#e6faff;
    --text:#e6faff;
    --bg-1:#0f1720;
    --bg-2:#1b2630;
    --glass: rgba(255,255,255,0.06);
    --glass-strong: rgba(255,255,255,0.08);
    --panel: rgba(20,20,20,0.9);
    --card-grad-1: rgba(255,255,255,0.04);
    --card-grad-2: rgba(255,255,255,0.07);
    --border: rgba(255,255,255,0.10);
    --shadow: 0 14px 40px rgba(0,0,0,0.6);
    --card-min: 300px;

    /* animation defaults */
    --deal-duration: 220ms;
    --deal-delay: 0ms;
    --start-rot: -8deg;
    --mid-rot: 4deg;
  }

  html,body{height:100%}
  body{
    margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;
    background:linear-gradient(135deg,var(--bg-1),var(--bg-2));
    color:var(--text);-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;
  }

  /* Static background logo (no movement) */
  body::before{
    content:"";position:fixed;inset:0;pointer-events:none;z-index:0;
    background:url("/logo.png") no-repeat center;background-size:min(50vw,520px);
    opacity:0.06;filter:blur(0.6px);mix-blend-mode:screen;animation:none!important;transform:none!important;
  }

  header{padding:28px 20px 10px;text-align:center;position:relative;z-index:2}
  header h1{margin:0;font-size:1.8rem;color:var(--accent);letter-spacing:0.2px}

  .control-btn{position:fixed;bottom:18px;z-index:10000;width:48px;height:48px;border-radius:12px;
    background:var(--glass-strong);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;
    cursor:pointer;backdrop-filter:blur(8px);box-shadow:0 6px 20px rgba(0,0,0,0.45);transition:transform .18s,background .18s;
    color:var(--accent);line-height:1;border-radius:10px;}
  .control-btn:hover{transform:scale(1.06)}
  #toolboxToggle{left:18px} #readerToggle{left:78px} #paletteToggle{left:138px}

  .toolbox-panel,.palette-panel{
    position:fixed;bottom:74px;z-index:9998;background:var(--panel);border:1px solid var(--border);border-radius:14px;
    padding:14px;box-shadow:var(--shadow);backdrop-filter:blur(12px);transition:transform .18s ease,opacity .18s ease;
    transform:translateY(8px) scale(.98);opacity:0;pointer-events:none;
  }
  .toolbox-panel{left:18px;min-width:300px;max-width:60vw;max-height:65vh;overflow-y:auto}
  .palette-panel{left:138px;width:320px}
  .toolbox-panel.open,.palette-panel.open{transform:translateY(0) scale(1);opacity:1;pointer-events:auto}

  .search-bar{max-width:920px;margin:14px auto 16px;display:flex;background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border-radius:12px;padding:12px 16px;border:1px solid rgba(255,255,255,0.04)}
  .search-bar input{flex:1;border:none;background:transparent;color:var(--text);font-size:1rem;outline:none}
  .controls{text-align:center;margin-bottom:20px}
  .controls button{margin:0 6px;padding:8px 12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer;transition:all .18s ease}
  .controls button:hover{transform:translateY(-2px);box-shadow:0 6px 18px rgba(0,0,0,0.35)}

  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--card-min),1fr));gap:20px;padding:20px;align-items:start}
  .card{
    position:relative;background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));
    border:1px solid var(--border);border-radius:12px;padding:16px;backdrop-filter:blur(8px);
    opacity:0;transform:translateY(40px) scale(0.98) rotate(0deg);
    transition:box-shadow .18s,transform .36s cubic-bezier(.2,.9,.2,1),opacity .36s cubic-bezier(.2,.9,.2,1);
    box-shadow:0 6px 18px rgba(0,0,0,0.35);
    overflow:hidden;min-width:0;will-change:transform,opacity;
  }
  .card.visible{opacity:1;transform:none}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.05rem}
  .card .content{contain:layout paint}

  .status{text-align:center;color:rgba(230,250,255,0.85);margin:6px 0 8px;font-size:.95rem}

  /* Deal animation: shorter and controlled by CSS vars */
  .card.deal{
    animation-name:casinoDeal;
    animation-duration: var(--deal-duration, 220ms);
    animation-delay: var(--deal-delay, 0ms);
    animation-timing-function: cubic-bezier(.22,.9,.28,1);
    animation-fill-mode:forwards;
  }
  @keyframes casinoDeal{
    0%{opacity:0;transform:translateY(120vh) rotate(var(--start-rot,-8deg)) scale(.6)}
    60%{opacity:1;transform:translateY(-8px) rotate(var(--mid-rot,4deg)) scale(1.04)}
    100%{opacity:1;transform:translateY(0) rotate(0deg) scale(1)}
  }

  .palette-title{color:var(--accent);font-weight:600;margin-bottom:8px}
  .palette-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .palette-color{width:34px;height:34px;border-radius:10px;cursor:pointer;border:2px solid var(--border);transition:border .14s}
  .palette-color.active{border-color:#fff;box-shadow:0 0 12px rgba(255,255,255,0.28)}

  .resize-row{display:flex;align-items:center;gap:8px;margin-top:10px}
  .resize-row input[type="number"]{width:72px;padding:6px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
  .resize-row input[type="range"]{flex:1}

  body.reader-mode {font-size: 1.18rem;line-height: 1.6;}
  body.reader-mode .dashboard {grid-template-columns: 1fr !important;}
  body.reader-mode .card {font-size: 1.05rem;padding: 20px;}
  body.reader-mode input,body.reader-mode select,body.reader-mode textarea,body.reader-mode button {font-size: 1.05rem;padding: 10px;}
</style>
</head>
<body>
  <button id="toolboxToggle" class="control-btn" aria-label="Toolbox" title="Toolbox">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden>
      <rect x="3" y="4" width="18" height="14" rx="2" stroke="currentColor" stroke-width="1.4" />
      <path d="M7 8h10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
      <path d="M7 12h10" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
    </svg>
  </button>

  <button id="readerToggle" class="control-btn" aria-label="Reader Mode" title="Reader Mode">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden>
      <path d="M3 12a3 3 0 0 1 6 0v1a3 3 0 0 0 6 0v-1a3 3 0 0 1 6 0" stroke="currentColor" stroke-width="1.4" stroke-linecap="round" stroke-linejoin="round"/>
      <path d="M6 12v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
      <path d="M18 12v4" stroke="currentColor" stroke-width="1.4" stroke-linecap="round"/>
    </svg>
  </button>

  <button id="paletteToggle" class="control-btn" aria-label="Theme" title="Theme">
    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden>
      <path d="M12 3a9 9 0 1 0 9 9c0-1.1-.9-2-2-2-.9 0-1.6.6-1.9 1.4A3.5 3.5 0 0 1 14 11c-1.9 0-3.5 1.6-3.5 3.5S12.1 18 14 18c.6 0 1.2-.2 1.7-.5.5-.3 1.1-.5 1.8-.5 1.7 0 3 1.3 3 3 0 1.1-.9 2-2 2A9 9 0 0 0 12 3z" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/>
      <circle cx="9" cy="9" r="1" fill="currentColor"/>
      <circle cx="7" cy="14" r="1" fill="currentColor"/>
      <circle cx="14" cy="7" r="1" fill="currentColor"/>
    </svg>
  </button>

  <div class="palette-panel" id="palettePanel" aria-label="Theme palette">
    <div class="palette-title">Accent color</div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px">
      <input id="customColorInput" type="color" value="#2dd4ff" title="Pick custom color" style="width:44px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent">
      <button id="addCustomColor" style="padding:6px 8px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer">Add</button>
      <div style="color:var(--muted);font-size:.9rem;margin-left:8px">Unique palette only</div>
    </div>
    <div class="palette-grid" id="paletteGrid"></div>
  </div>

  <div class="toolbox-panel" id="toolboxPanel" role="navigation">
    <h3 style="color:var(--accent);margin:0 0 10px;">Toolbox</h3>
    <div style="color:var(--muted);font-size:.9rem;margin-bottom:10px">Resize each toolbox card freely</div>
    <div id="toolboxList" class="dashboard" style="grid-template-columns:repeat(auto-fill,minmax(300px,1fr));"></div>
  </div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main role="main">
    <div class="search-bar">
      <input id="searchInput" type="text" placeholder="Search cards..." aria-label="Search cards" />
    </div>

    <div class="controls">
      <button id="sortAlphaBtn">Sort A→Z</button>
      <button id="sortRandomBtn">Random</button>
      <button id="shuffleDealBtn">Re‑deal</button>
    </div>

    <div class="status" id="status">Loading cards...</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

  <script>
  /* THEME + UNIQUE PALETTE (unchanged) */
  (function(){
    const DEFAULT_PALETTE = ['#2dd4ff','#ff4d4d','#4dff88','#ffd84d','#9d4edd','#ff006e','#00d4ff','#ff9500','#32d74b','#ff5e3a'];
    const PALETTE_KEY = 'site_palette_v1';
    const ACCENT_KEY = 'site_accent_v1';
    const paletteGrid = document.getElementById('paletteGrid');
    const customInput = document.getElementById('customColorInput');
    const addBtn = document.getElementById('addCustomColor');

    let palette = JSON.parse(localStorage.getItem(PALETTE_KEY) || 'null') || DEFAULT_PALETTE.slice();

    function addUniqueColor(hex){
      hex = hex.toLowerCase();
      if(!/^#([0-9a-f]{6})$/.test(hex)) return false;
      if(palette.includes(hex)) return false;
      palette.push(hex);
      localStorage.setItem(PALETTE_KEY, JSON.stringify(palette));
      renderPalette();
      return true;
    }

    function renderPalette(){
      paletteGrid.innerHTML = '';
      palette.forEach(hex=>{
        const sw = document.createElement('div');
        sw.className = 'palette-color';
        sw.dataset.accent = hex;
        sw.style.background = hex;
        sw.title = hex;
        sw.addEventListener('click', ()=> {
          document.querySelectorAll('.palette-color').forEach(x=>x.classList.remove('active'));
          sw.classList.add('active');
          applyTheme(hex);
        });
        paletteGrid.appendChild(sw);
      });
      const saved = localStorage.getItem(ACCENT_KEY);
      if(saved){
        const el = paletteGrid.querySelector(`[data-accent="${saved}"]`);
        if(el) el.classList.add('active');
      } else {
        paletteGrid.querySelector('.palette-color')?.classList.add('active');
      }
    }

    addBtn.addEventListener('click', ()=>{
      const hex = customInput.value.trim().toLowerCase();
      if(addUniqueColor(hex)){
        const el = paletteGrid.querySelector(`[data-accent="${hex}"]`);
        if(el){ el.click(); }
      } else {
        addBtn.textContent = 'Duplicate';
        setTimeout(()=> addBtn.textContent = 'Add', 900);
      }
    });

    function hexToRgb(hex){
      hex = hex.replace('#','');
      if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
      const n = parseInt(hex,16);
      return {r:(n>>16)&255, g:(n>>8)&255, b:n&255};
    }
    function rgbToHex(r,g,b){ return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join(''); }
    function luminance(r,g,b){
      const srgb = [r,g,b].map(v=>{
        v /= 255;
        return v <= 0.03928 ? v/12.92 : Math.pow((v+0.055)/1.055,2.4);
      });
      return 0.2126*srgb[0] + 0.7152*srgb[1] + 0.0722*srgb[2];
    }
    function contrastRatio(hexA, hexB){
      const a = hexToRgb(hexA), b = hexToRgb(hexB);
      const L1 = luminance(a.r,a.g,a.b), L2 = luminance(b.r,b.g,b.b);
      const bright = Math.max(L1,L2), dark = Math.min(L1,L2);
      return (bright + 0.05) / (dark + 0.05);
    }
    function clamp(v){ return Math.max(0, Math.min(255, Math.round(v))); }

    function deriveTheme(accentHex){
      const a = hexToRgb(accentHex);
      const bg1 = rgbToHex(clamp(a.r*0.06), clamp(a.g*0.06), clamp(a.b*0.08));
      const bg2 = rgbToHex(clamp(a.r*0.10), clamp(a.g*0.12), clamp(a.b*0.16));
      const glass = `rgba(${a.r},${a.g},${a.b},0.06)`;
      const glassStrong = `rgba(${a.r},${a.g},${a.b},0.10)`;
      const cardGrad1 = `rgba(${Math.min(255,a.r+18)},${Math.min(255,a.g+18)},${Math.min(255,a.b+18)},0.04)`;
      const cardGrad2 = `rgba(${Math.min(255,a.r+36)},${Math.min(255,a.g+36)},${Math.min(255,a.b+36)},0.07)`;
      const panel = `rgba(${Math.max(0,Math.round(a.r*0.06))},${Math.max(0,Math.round(a.g*0.06))},${Math.max(0,Math.round(a.b*0.06))},0.92)`;
      const whiteContrast = contrastRatio('#ffffff', accentHex);
      const muted = whiteContrast > 3.2 ? '#ffffff' : '#e6faff';
      const accentContrast = (luminance(a.r,a.g,a.b) > 0.5) ? '#071018' : '#ffffff';
      return {bg1,bg2,glass,glassStrong,cardGrad1,cardGrad2,panel,muted,accentContrast};
    }

    function applyTheme(accentHex){
      const root = document.documentElement;
      root.style.setProperty('--accent', accentHex);
      const d = deriveTheme(accentHex);
      root.style.setProperty('--accent-contrast', d.accentContrast);
      root.style.setProperty('--bg-1', d.bg1);
      root.style.setProperty('--bg-2', d.bg2);
      root.style.setProperty('--glass', d.glass);
      root.style.setProperty('--glass-strong', d.glassStrong);
      root.style.setProperty('--card-grad-1', d.cardGrad1);
      root.style.setProperty('--card-grad-2', d.cardGrad2);
      root.style.setProperty('--panel', d.panel);
      root.style.setProperty('--muted', d.muted);
      root.style.setProperty('--text', d.muted);
      document.body.style.background = `linear-gradient(135deg, ${d.bg1}, ${d.bg2})`;
      localStorage.setItem(ACCENT_KEY, accentHex);
    }

    renderPalette();
    const savedAccent = localStorage.getItem(ACCENT_KEY);
    if(savedAccent && palette.includes(savedAccent)){
      applyTheme(savedAccent);
      const el = paletteGrid.querySelector(`[data-accent="${savedAccent}"]`);
      if(el) { document.querySelectorAll('.palette-color').forEach(x=>x.classList.remove('active')); el.classList.add('active'); }
    } else {
      const first = palette[0];
      applyTheme(first);
      paletteGrid.querySelector('.palette-color')?.classList.add('active');
    }
  })();
  </script>

  <script>
  /* MAIN: lazy loading + sequential quick dealing */
  const DEFAULT_REPO='mrpr0phecy/mrpr0phecy';
  const DEFAULT_BRANCH='main';

  function parseOwnerRepo(str){const p=str.split('/');return {owner:p[0],repo:p[1]};}
  async function fetchRepoTree(owner,repo,branch){
    const url=`https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
    const r=await fetch(url); if(!r.ok) throw new Error('GitHub API error: '+r.status); return r.json();
  }
  async function getCardFiles(owner,repo,branch){
    const data=await fetchRepoTree(owner,repo,branch);
    return (data.tree||[]).filter(i=>i.path.startsWith('cards/') && i.path.endsWith('.html')).map(i=>i.path.replace(/^cards\//,''));
  }

  function makeImagesLazy(html){
    return html.replace(/<img\b([^>]*?)>/gi, (match, attrs)=>{
      if(/loading\s*=/.test(attrs)) return `<img${attrs}>`;
      return `<img loading="lazy"${attrs}>`;
    });
  }

  function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

  function createCardElement(file,{pinned=false}={}){
    const name=file.replace('.html','');
    const card=document.createElement('div');
    card.className='card';
    card.dataset.name=name;
    card.dataset.file=file;

    // small, consistent rotation seeds (not random jitter)
    card.style.setProperty('--start-rot','-8deg');
    card.style.setProperty('--mid-rot','4deg');

    const header=document.createElement('div'); header.className='card-header';
    const title=document.createElement('h3'); title.textContent=name;
    const btnWrap=document.createElement('div'); btnWrap.style.display='flex'; btnWrap.style.gap='6px';

    const addBtn=document.createElement('button'); addBtn.className='add-to-toolbox'; addBtn.title='Add to toolbox'; addBtn.textContent='➕';
    addBtn.addEventListener('click',e=>{e.stopPropagation(); addToToolbox(file);});
    btnWrap.appendChild(addBtn);

    if(pinned){
      const remBtn=document.createElement('button'); remBtn.className='remove-from-toolbox'; remBtn.title='Remove from toolbox'; remBtn.textContent='➖';
      remBtn.addEventListener('click',e=>{e.stopPropagation(); removeFromToolbox(file);});
      btnWrap.appendChild(remBtn);
    }

    header.appendChild(title); header.appendChild(btnWrap); card.appendChild(header);

    const content=document.createElement('div'); content.className='content'; content.textContent='Loading…'; card.appendChild(content);

    // IntersectionObserver for lazy loading with prefetch margin
    const io = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          // set short, consistent timing for this card
          card.style.setProperty('--deal-delay','0ms');
          card.style.setProperty('--deal-duration','220ms');
          // trigger a quick deal animation when first loaded
          // but do not overwhelm — only animate this single card now
          card.classList.add('deal');
          setTimeout(()=>card.classList.add('visible'), 80);
          loadCardContentInto(card,file).catch(()=>{content.textContent='Preview unavailable.';});
          io.unobserve(card);
        }
      });
    },{threshold:0.08, rootMargin: '160px 0px 160px 0px'});
    io.observe(card);

    return card;
  }

  async function loadCardContentInto(card,file){
    if(card.dataset.loaded==='true') return;
    const url=`cards/${file}`;
    try{
      const r = await fetch(url);
      if(!r.ok){ card.querySelector('.content').textContent='Failed to load'; return; }
      let html = await r.text();
      html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
      html = makeImagesLazy(html);
      const wrapper = document.createElement('div');
      wrapper.style.opacity = '0';
      wrapper.style.transition = 'opacity .28s ease';
      wrapper.innerHTML = html;
      const content = card.querySelector('.content');
      content.innerHTML = '';
      content.appendChild(wrapper);
      requestAnimationFrame(()=>{ wrapper.style.opacity = '1'; });
      card.dataset.loaded='true';
    }catch(e){
      card.querySelector('.content').textContent='Failed to load';
    }
  }

  const TOOLBOX_KEY='toolbox_items_v1';
  const CARD_SIZE_KEY = 'card_size_';
  function loadToolboxStore(){try{return JSON.parse(localStorage.getItem(TOOLBOX_KEY)||'[]');}catch(e){return[];}}
  function saveToolboxStore(items){localStorage.setItem(TOOLBOX_KEY,JSON.stringify(items));}
  let toolboxItems = loadToolboxStore();

  function renderToolboxPanel(){
    const list=document.getElementById('toolboxList'); list.innerHTML='';
    if(!toolboxItems.length){list.innerHTML='<div class="toolbox-empty" style="color:var(--muted)">No items yet. Add tools by pressing ➕ on any card.</div>'; return;}
    toolboxItems.forEach(file=>{
      const card = createCardElement(file,{pinned:true});
      const resizeRow = document.createElement('div'); resizeRow.className='resize-row';
      const label = document.createElement('div'); label.textContent='Width'; label.style.color='var(--muted)'; label.style.fontSize='0.9rem';
      const number = document.createElement('input'); number.type='number'; number.min=160; number.max=900; number.step=1;
      const range = document.createElement('input'); range.type='range'; range.min=160; range.max=900; range.step=1;
      const saved = localStorage.getItem(CARD_SIZE_KEY + file);
      const initial = saved ? parseInt(saved,10) : 300;
      number.value = initial; range.value = initial;
      card.style.minWidth = initial + 'px';
      card.style.maxWidth = initial + 'px';
      function applySize(v){
        const px = Math.max(160, Math.min(900, parseInt(v,10)||160));
        number.value = px; range.value = px;
        card.style.minWidth = px + 'px';
        card.style.maxWidth = px + 'px';
        localStorage.setItem(CARD_SIZE_KEY + file, px);
      }
      number.addEventListener('input', e=> applySize(e.target.value));
      range.addEventListener('input', e=> applySize(e.target.value));
      resizeRow.appendChild(label); resizeRow.appendChild(number); resizeRow.appendChild(range);
      card.appendChild(resizeRow);
      list.appendChild(card);
    });
  }

  function addToToolbox(file){
    if(toolboxItems.includes(file)){ openToolbox(); return; }
    toolboxItems.unshift(file);
    if(toolboxItems.length>80) toolboxItems.length=80;
    saveToolboxStore(toolboxItems);
    renderToolboxPanel();
    openToolbox();
  }
  function removeFromToolbox(file){
    const idx = toolboxItems.indexOf(file);
    if(idx>=0){ toolboxItems.splice(idx,1); saveToolboxStore(toolboxItems); renderToolboxPanel(); }
  }

  // Sequential reDeal: animate one card at a time, short duration, small pause
  async function reDeal(){
    const cards = Array.from(document.querySelectorAll('#gridContainer .card'));
    // remove classes to reset
    cards.forEach(c=>{ c.classList.remove('visible','deal'); });
    for(let i=0;i<cards.length;i++){
      const c = cards[i];
      // set consistent short timing
      c.style.setProperty('--deal-duration','220ms');
      c.style.setProperty('--deal-delay','0ms');
      c.style.setProperty('--start-rot','-8deg');
      c.style.setProperty('--mid-rot','4deg');

      // ensure animationend is awaited
      await new Promise(resolve=>{
        const onEnd = (ev)=>{
          // only resolve for this animation name
          if(ev.animationName !== 'casinoDeal') return;
          c.removeEventListener('animationend', onEnd);
          // mark visible after animation completes
          c.classList.add('visible');
          // small pause before next card
          setTimeout(resolve, 80);
        };
        c.addEventListener('animationend', onEnd);
        // trigger animation
        // small timeout to ensure CSS vars applied
        requestAnimationFrame(()=> {
          c.classList.add('deal');
        });
      });
    }
  }

  // dashboard load + search + sort
  let currentFiles=[];
  async function loadDashboard(){
    const {owner,repo}=parseOwnerRepo(DEFAULT_REPO);
    try{
      const files=await getCardFiles(owner,repo,DEFAULT_BRANCH);
      if(!files.length){document.getElementById('status').textContent='No cards found.';return;}
      files.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base',numeric:true}));
      currentFiles=files.slice();
      const grid=document.getElementById('gridContainer'); grid.innerHTML='';
      files.forEach(f=>grid.appendChild(createCardElement(f)));
      document.getElementById('status').textContent=`Loaded ${files.length} cards.`;
      applySearchFilter(document.getElementById('searchInput').value);
    }catch(err){
      document.getElementById('status').textContent='Error loading cards.';
    }
  }

  let currentQuery=''; let searchTimer=null;
  function applySearchFilter(q){
    currentQuery=(q||'').trim().toLowerCase();
    let visibleCount=0;
    document.querySelectorAll('#gridContainer .card').forEach(card=>{
      const name=(card.dataset.name||'').toLowerCase();
      const text=(card.textContent||'').toLowerCase();
      const show=!currentQuery||name.includes(currentQuery)||text.includes(currentQuery);
      card.style.display=show?'':'none';
      if(show) visibleCount++;
    });
    document.getElementById('status').textContent =
      visibleCount?`Showing ${visibleCount} of ${currentFiles.length} cards${currentQuery?' (filtered)':''}.`
      :'No cards match your search.';
  }
  document.getElementById('searchInput').addEventListener('input',e=>{
    clearTimeout(searchTimer); const val=e.target.value;
    searchTimer=setTimeout(()=>applySearchFilter(val),180);
  });

  document.getElementById('sortAlphaBtn').addEventListener('click', async ()=>{
    const grid=document.getElementById('gridContainer'); const nodes=[...grid.children];
    nodes.sort((a,b)=>a.dataset.name.localeCompare(b.dataset.name,undefined,{sensitivity:'base',numeric:true}));
    nodes.forEach(n=>grid.appendChild(n));
    await reDeal();
    document.getElementById('status').textContent='Sorted alphabetically.';
  });

  document.getElementById('sortRandomBtn').addEventListener('click', async ()=>{
    const grid=document.getElementById('gridContainer'); const nodes=[...grid.children];
    for(let i=nodes.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[nodes[i],nodes[j]]=[nodes[j],nodes[i]];}
    nodes.forEach(n=>grid.appendChild(n));
    await reDeal();
    document.getElementById('status').textContent='Shuffled cards.';
  });

  document.getElementById('shuffleDealBtn').addEventListener('click', reDeal);

  function openToolbox(){document.getElementById('toolboxPanel').classList.add('open');}
  function toggleToolbox(){document.getElementById('toolboxPanel').classList.toggle('open');}
  document.getElementById('toolboxToggle').addEventListener('click', toggleToolbox);

  function togglePalette(){document.getElementById('palettePanel').classList.toggle('open');}
  document.getElementById('paletteToggle').addEventListener('click', togglePalette);

  document.getElementById('readerToggle').addEventListener('click', ()=>{
    document.body.classList.toggle('reader-mode');
    if(document.body.classList.contains('reader-mode')) localStorage.setItem('readerMode','on'); else localStorage.removeItem('readerMode');
  });
  if(localStorage.getItem('readerMode')==='on') document.body.classList.add('reader-mode');

  document.addEventListener('click', e=>{
    if(!e.target.closest('.toolbox-panel') && !e.target.closest('#toolboxToggle')) document.getElementById('toolboxPanel').classList.remove('open');
    if(!e.target.closest('.palette-panel') && !e.target.closest('#paletteToggle')) document.getElementById('palettePanel').classList.remove('open');
  });

  new Sortable(document.getElementById('gridContainer'),{animation:120});
  new Sortable(document.getElementById('toolboxList'),{animation:120});

  // init
  renderToolboxPanel();
  loadDashboard();
  </script>
</body>
</html>
