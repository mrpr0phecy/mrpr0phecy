<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>The Most Useful Site in the World</title>
    <style>
        /* ===== RESET & BASE ===== */
        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --accent: #2dd4ff;
            --accent-dark: #1aa3cc;
            --text: #e6faff;
            --text-secondary: rgba(230, 250, 255, 0.7);
            --bg-primary: #0a0f14;
            --bg-secondary: #141e28;
            --border: rgba(255, 255, 255, 0.08);
            --success: #39ff14;
            --error: #ff4d4d;
            --card-radius: 12px;
            --space-sm: 8px;
            --space-md: 12px;
            --space-lg: 16px;
            --space-xl: 20px;
        }

        html, body {
            height: 100%;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary), var(--bg-secondary));
            color: var(--text);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* ===== LOADING SCREEN ===== */
        #loadingScreen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            transition: opacity 0.5s ease;
        }

        #loadingScreen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 3px solid rgba(45, 212, 255, 0.1);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            margin-top: 20px;
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ===== STICKY HEADER ===== */
        .sticky-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: rgba(10, 15, 20, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 var(--space-lg);
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }

        .sticky-header.visible {
            transform: translateY(0);
        }

        .sticky-search {
            flex: 1;
            max-width: 400px;
            margin: 0 auto;
        }

        .sticky-search input {
            width: 100%;
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 14px;
        }

        .sticky-actions {
            display: flex;
            gap: var(--space-sm);
            margin-left: auto;
        }

        .sticky-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .sticky-btn:hover, .sticky-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(45, 212, 255, 0.1);
        }

        /* ===== MAIN HEADER ===== */
        .main-header {
            padding: 100px 20px 40px;
            text-align: center;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(90deg, var(--accent), #fff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 10px;
        }

        .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto 30px;
        }

        .main-search {
            max-width: 600px;
            margin: 0 auto;
            display: flex;
            gap: 10px;
        }

        .main-search input {
            flex: 1;
            padding: 12px 20px;
            border-radius: var(--card-radius);
            border: 1px solid var(--border);
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
            font-size: 16px;
        }

        .main-search button {
            padding: 12px 24px;
            border-radius: var(--card-radius);
            border: 1px solid var(--accent);
            background: rgba(45, 212, 255, 0.1);
            color: var(--accent);
            cursor: pointer;
            font-weight: 600;
        }

        /* ===== DASHBOARD ===== */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: var(--space-xl);
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* ===== CARDS ===== */
        .card {
            background: linear-gradient(145deg, rgba(255,255,255,0.03), rgba(255,255,255,0.05));
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            min-height: 300px;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
        }

        .card.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }

        .card-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(0,0,0,0.2);
        }

        .card-header h3 {
            color: var(--accent);
            font-size: 1.1rem;
            margin: 0;
        }

        .card-actions {
            display: flex;
            gap: 8px;
        }

        .card-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .card-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Shadow DOM container - THIS IS THE KEY FIX */
        .card-shadow-host {
            flex: 1;
            position: relative;
            min-height: 200px;
            background: rgba(0,0,0,0.1);
        }

        .card-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: var(--text-secondary);
        }

        .card-footer {
            padding: var(--space-sm) var(--space-md);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: var(--space-md);
            background: rgba(0,0,0,0.3);
        }

        .rating-bar {
            width: 60px;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }

        .rating-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s;
        }

        /* ===== TOOLBOX ===== */
        #toolbox {
            position: fixed;
            right: 20px;
            bottom: 20px;
            width: 600px;
            height: 500px;
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            display: none;
            flex-direction: column;
            z-index: 9999;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }

        #toolbox.open {
            display: flex;
        }

        .toolbox-header {
            padding: var(--space-md);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: move;
        }

        .toolbox-content {
            flex: 1;
            overflow: auto;
            padding: var(--space-md);
        }

        /* ===== PANELS ===== */
        .panel {
            position: fixed;
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid var(--border);
            border-radius: var(--card-radius);
            padding: 20px;
            display: none;
            z-index: 9998;
        }

        .panel.open {
            display: block;
        }

        /* ===== NOTIFICATIONS ===== */
        #notifications {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 10001;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .notification {
            background: rgba(20, 20, 20, 0.98);
            border: 1px solid var(--border);
            border-left: 3px solid var(--accent);
            padding: 16px;
            border-radius: 8px;
            min-width: 300px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* ===== RESPONSIVE ===== */
        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            #toolbox {
                right: 10px;
                left: 10px;
                width: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Screen -->
    <div id="loadingScreen">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading tools...</div>
    </div>

    <!-- Sticky Header -->
    <div class="sticky-header" id="stickyHeader">
        <div class="sticky-search">
            <input type="text" id="stickySearch" placeholder="Search tools...">
        </div>
        <div class="sticky-actions">
            <button class="sticky-btn" id="btnToolbox" title="Toolbox">üß∞</button>
            <button class="sticky-btn" id="btnTheme" title="Theme">üé®</button>
            <button class="sticky-btn" id="btnReader" title="Reader Mode">üëì</button>
        </div>
    </div>

    <!-- Main Header -->
    <header class="main-header">
        <h1>The Most Useful Site in the World</h1>
        <p class="subtitle">Essential tools for productivity, creativity, and problem-solving. All free, no sign-ups required.</p>
        <div class="main-search">
            <input type="text" id="mainSearch" placeholder="üîç Search tools, calculators, converters...">
            <button id="searchBtn">Search</button>
        </div>
    </header>

    <!-- Dashboard -->
    <div id="dashboard" class="dashboard"></div>

    <!-- Toolbox -->
    <div id="toolbox">
        <div class="toolbox-header">
            <span style="color: var(--accent); font-weight: 600;">Toolbox</span>
            <button class="card-btn" id="closeToolbox">‚úï</button>
        </div>
        <div class="toolbox-content" id="toolboxContent">
            <p style="color: var(--text-secondary); text-align: center;">Add cards to your toolbox</p>
        </div>
    </div>

    <!-- Theme Panel -->
    <div class="panel" id="themePanel" style="top: 70px; right: 20px;">
        <h3 style="color: var(--accent); margin-bottom: 15px;">Theme Settings</h3>
        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px;">
            <button class="card-btn" data-theme="default" style="background: linear-gradient(135deg, #0a0f14, #141e28); height: 40px;"></button>
            <button class="card-btn" data-theme="blue" style="background: linear-gradient(135deg, #05080c, #0f151f); height: 40px;"></button>
            <button class="card-btn" data-theme="purple" style="background: linear-gradient(135deg, #12081a, #1f1229); height: 40px;"></button>
            <button class="card-btn" data-theme="teal" style="background: linear-gradient(135deg, #061616, #0f2525); height: 40px;"></button>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications"></div>

    <script>
    // ===== CONFIG =====
    const CONFIG = {
        REPO: 'mrpr0phecy/mrpr0phecy',
        PATH: 'cards',
        BATCH_SIZE: 3
    };

    // ===== STATE =====
    let cards = [];
    let toolboxCards = [];
    let ratings = JSON.parse(localStorage.getItem('ratings') || '{}');

    // ===== INIT =====
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('üöÄ Initializing...');
        
        // Load cards automatically
        await loadCards();
        
        // Hide loading screen
        document.getElementById('loadingScreen').classList.add('hidden');
        
        // Setup UI
        setupEventListeners();
        setupStickyHeader();
        
        // Show welcome notification
        notify('Welcome! üéâ', 'All tools loaded and ready.');
    });

    // ===== CARD LOADING WITH SHADOW DOM ISOLATION =====
    async function loadCards() {
        try {
            const [owner, repo] = CONFIG.REPO.split('/');
            const url = `https://api.github.com/repos/${owner}/${repo}/contents/${CONFIG.PATH}`;
            
            const response = await fetch(url);
            if (!response.ok) throw new Error(`GitHub API: ${response.status}`);
            
            const data = await response.json();
            const cardFiles = data
                .filter(item => item.type === 'file' && item.name.endsWith('.html'))
                .map(item => item.name.replace('.html', ''))
                .sort();
            
            console.log(`Found ${cardFiles.length} cards`);
            
            const dashboard = document.getElementById('dashboard');
            
            // Create cards with Shadow DOM hosts
            for (let i = 0; i < cardFiles.length; i++) {
                const cardName = cardFiles[i];
                const displayName = cardName.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.name = cardName;
                card.style.animationDelay = `${i * 0.05}s`;
                
                card.innerHTML = `
                    <div class="card-header">
                        <h3>${displayName}</h3>
                        <div class="card-actions">
                            <button class="card-btn" onclick="addToToolbox('${cardName}')" title="Add to Toolbox">+</button>
                            <button class="card-btn" onclick="openCard('${cardName}')" title="Open">‚Üó</button>
                        </div>
                    </div>
                    <div class="card-shadow-host" id="host-${cardName}">
                        <div class="card-loading">
                            <div>Loading ${displayName}...</div>
                        </div>
                    </div>
                `;
                
                dashboard.appendChild(card);
                
                // Load content into Shadow DOM for isolation
                await loadCardIntoShadowDOM(cardName, i);
                
                // Add footer after content loads
                addCardFooter(card, cardName);
                
                // Show card
                setTimeout(() => card.classList.add('visible'), 50);
            }
            
        } catch (error) {
            console.error('Failed to load cards:', error);
            notify('Error', 'Failed to load cards: ' + error.message, 'error');
        }
    }

    // ===== SHADOW DOM LOADING - THIS PREVENTS STYLE BLEEDING =====
    async function loadCardIntoShadowDOM(cardName, index) {
        const host = document.getElementById(`host-${cardName}`);
        if (!host) return;
        
        try {
            // Remove loading indicator
            host.innerHTML = '';
            
            // Create shadow root with closed mode for true isolation [^16^]
            const shadow = host.attachShadow({ mode: 'closed' });
            
            // Fetch card content
            const response = await fetch(`cards/${cardName}.html`);
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            
            const html = await response.text();
            
            // Parse the HTML
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Remove any script tags for security
            doc.querySelectorAll('script').forEach(s => s.remove());
            
            // Create isolated styles for the shadow DOM
            const style = document.createElement('style');
            style.textContent = `
                :host {
                    display: block;
                    padding: 16px;
                    color: #e6faff;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    font-size: 14px;
                    line-height: 1.6;
                }
                
                * {
                    max-width: 100%;
                    box-sizing: border-box;
                }
                
                img, video, canvas, svg {
                    max-width: 100%;
                    height: auto;
                }
                
                table {
                    width: 100%;
                    border-collapse: collapse;
                    overflow-x: auto;
                    display: block;
                }
                
                pre, code {
                    white-space: pre-wrap;
                    word-wrap: break-word;
                    overflow-x: auto;
                    max-width: 100%;
                }
                
                input, textarea, select, button {
                    max-width: 100%;
                    font-family: inherit;
                }
                
                /* Prevent any global styles from affecting parent */
                :host(*) {
                    all: initial;
                }
            `;
            
            shadow.appendChild(style);
            
            // Add the content
            const content = document.createElement('div');
            content.innerHTML = doc.body.innerHTML;
            shadow.appendChild(content);
            
            console.log(`Loaded ${cardName} into Shadow DOM`);
            
        } catch (error) {
            console.error(`Failed to load ${cardName}:`, error);
            host.innerHTML = `<div style="padding: 40px; text-align: center; color: #ff6b6b;">Failed to load ${cardName}</div>`;
        }
    }

    function addCardFooter(card, cardName) {
        const rating = ratings[cardName] || { up: 0, down: 0 };
        const total = rating.up + rating.down;
        const percent = total === 0 ? 0 : Math.round((rating.up / total) * 100);
        
        const footer = document.createElement('div');
        footer.className = 'card-footer';
        footer.innerHTML = `
            <span style="font-size: 12px; color: var(--text-secondary);">Useful:</span>
            <div class="rating-bar">
                <div class="rating-fill" style="width: ${percent}%"></div>
            </div>
            <span style="font-size: 12px; color: var(--accent);">${percent}%</span>
            <button class="card-btn" onclick="rate('${cardName}', 'up')">üëç</button>
            <button class="card-btn" onclick="rate('${cardName}', 'down')">üëé</button>
            <button class="card-btn" onclick="embed('${cardName}')" style="margin-left: auto;">üîó</button>
        `;
        
        card.appendChild(footer);
    }

    // ===== TOOLBOX =====
    function addToToolbox(cardName) {
        if (toolboxCards.find(c => c === cardName)) {
            notify('Already added', `${cardName} is already in your toolbox.`);
            return;
        }
        
        toolboxCards.push(cardName);
        updateToolbox();
        openToolbox();
        notify('Added', `${cardName} added to toolbox.`);
    }

    function updateToolbox() {
        const content = document.getElementById('toolboxContent');
        if (toolboxCards.length === 0) {
            content.innerHTML = '<p style="color: var(--text-secondary); text-align: center;">Your toolbox is empty. Add cards from the grid above.</p>';
            return;
        }
        
        content.innerHTML = toolboxCards.map(name => `
            <div style="padding: 10px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
                <span>${name}</span>
                <button class="card-btn" onclick="removeFromToolbox('${name}')">‚úï</button>
            </div>
        `).join('');
    }

    function removeFromToolbox(cardName) {
        toolboxCards = toolboxCards.filter(c => c !== cardName);
        updateToolbox();
    }

    function openToolbox() {
        document.getElementById('toolbox').classList.add('open');
        document.getElementById('btnToolbox').classList.add('active');
    }

    function closeToolbox() {
        document.getElementById('toolbox').classList.remove('open');
        document.getElementById('btnToolbox').classList.remove('active');
    }

    // ===== EVENTS =====
    function setupEventListeners() {
        // Search
        const searchHandler = (e) => {
            const query = e.target.value.toLowerCase();
            document.querySelectorAll('.card').forEach(card => {
                const name = card.dataset.name.toLowerCase();
                card.style.display = name.includes(query) ? '' : 'none';
            });
        };
        
        document.getElementById('mainSearch').addEventListener('input', searchHandler);
        document.getElementById('stickySearch').addEventListener('input', searchHandler);
        
        // Toolbox
        document.getElementById('btnToolbox').addEventListener('click', () => {
            const toolbox = document.getElementById('toolbox');
            toolbox.classList.contains('open') ? closeToolbox() : openToolbox();
        });
        
        document.getElementById('closeToolbox').addEventListener('click', closeToolbox);
        
        // Theme panel
        document.getElementById('btnTheme').addEventListener('click', () => {
            document.getElementById('themePanel').classList.toggle('open');
        });
        
        // Theme buttons
        document.querySelectorAll('[data-theme]').forEach(btn => {
            btn.addEventListener('click', () => {
                const theme = btn.dataset.theme;
                const themes = {
                    default: ['#0a0f14', '#141e28'],
                    blue: ['#05080c', '#0f151f'],
                    purple: ['#12081a', '#1f1229'],
                    teal: ['#061616', '#0f2525']
                };
                const [c1, c2] = themes[theme];
                document.body.style.background = `linear-gradient(135deg, ${c1}, ${c2})`;
                document.getElementById('themePanel').classList.remove('open');
            });
        });
        
        // Reader mode
        document.getElementById('btnReader').addEventListener('click', () => {
            document.body.classList.toggle('reader-mode');
            document.getElementById('btnReader').classList.toggle('active');
        });
        
        // Close panels on outside click
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.panel') && !e.target.closest('.sticky-btn')) {
                document.getElementById('themePanel').classList.remove('open');
            }
            if (!e.target.closest('#toolbox') && !e.target.closest('#btnToolbox')) {
                closeToolbox();
            }
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey || e.metaKey) {
                if (e.key === 't') {
                    e.preventDefault();
                    document.getElementById('btnToolbox').click();
                } else if (e.key === 'k') {
                    e.preventDefault();
                    document.getElementById('mainSearch').focus();
                }
            }
            if (e.key === 'Escape') {
                closeToolbox();
                document.getElementById('themePanel').classList.remove('open');
            }
        });
    }

    function setupStickyHeader() {
        const header = document.getElementById('stickyHeader');
        let lastScroll = 0;
        
        window.addEventListener('scroll', () => {
            const current = window.pageYOffset;
            if (current > 100) {
                header.classList.add('visible');
            } else {
                header.classList.remove('visible');
            }
            lastScroll = current;
        }, { passive: true });
    }

    // ===== UTILITIES =====
    function rate(cardName, type) {
        if (!ratings[cardName]) ratings[cardName] = { up: 0, down: 0 };
        ratings[cardName][type]++;
        localStorage.setItem('ratings', JSON.stringify(ratings));
        
        // Update UI
        const card = document.querySelector(`.card[data-name="${cardName}"]`);
        if (card) {
            const footer = card.querySelector('.card-footer');
            if (footer) footer.remove();
            addCardFooter(card, cardName);
        }
        
        notify('Thanks!', `You rated this ${type === 'up' ? 'üëç' : 'üëé'}`);
    }

    function embed(cardName) {
        const code = `<iframe src="${window.location.origin}/cards/${cardName}.html" width="100%" height="400" style="border:none;border-radius:12px;"></iframe>`;
        navigator.clipboard.writeText(code).then(() => {
            notify('Copied!', 'Embed code copied to clipboard.');
        });
    }

    function openCard(cardName) {
        window.open(`cards/${cardName}.html`, '_blank');
    }

    function notify(title, message, type = 'info') {
        const container = document.getElementById('notifications');
        const notif = document.createElement('div');
        notif.className = 'notification';
        notif.innerHTML = `
            <div style="font-weight: 600; color: var(--accent); margin-bottom: 4px;">${title}</div>
            <div style="font-size: 14px; color: var(--text-secondary);">${message}</div>
        `;
        container.appendChild(notif);
        
        setTimeout(() => {
            notif.style.opacity = '0';
            setTimeout(() => notif.remove(), 300);
        }, 4000);
    }

    // Make functions global for onclick handlers
    window.addToToolbox = addToToolbox;
    window.openCard = openCard;
    window.rate = rate;
    window.embed = embed;
    window.removeFromToolbox = removeFromToolbox;
    </script>
</body>
</html>
