<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>The Most Useful Site in the World</title>
<style>
  :root{
    --accent:#2dd4ff; --muted:#e6faff; --text:#e6faff;
    --bg-1:#0f1720; --bg-2:#1b2630;
    --glass: rgba(255,255,255,0.06); --panel: rgba(20,20,20,0.9);
    --card-grad-1: rgba(255,255,255,0.04); --card-grad-2: rgba(255,255,255,0.07);
    --border: rgba(255,255,255,0.10);
    --card-min: 300px;
    --toolbox-width: 360px; --toolbox-height: 420px;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(135deg,var(--bg-1),var(--bg-2));color:var(--text);-webkit-font-smoothing:antialiased}
  body::before{content:"";position:fixed;inset:0;pointer-events:none;z-index:0;background:url('/logo.png') no-repeat center;background-size:min(50vw,520px);opacity:0.06;filter:blur(.6px);mix-blend-mode:screen}
  header{padding:24px 16px;text-align:center;z-index:2}
  header h1{margin:0;color:var(--accent);font-size:1.6rem}
  .control-btn{position:fixed;bottom:18px;z-index:10000;width:44px;height:44px;border-radius:10px;background:var(--glass);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;backdrop-filter:blur(6px);color:var(--accent)}
  #toolboxToggle{left:18px} #readerToggle{left:74px} #paletteToggle{left:130px}
  .panel{position:fixed;z-index:9998;background:var(--panel);border:1px solid var(--border);border-radius:10px;padding:10px;box-shadow:0 12px 36px rgba(0,0,0,0.6);backdrop-filter:blur(10px);opacity:0;pointer-events:none;transition:opacity .18s,transform .18s}
  .panel.open{opacity:1;pointer-events:auto}
  #palettePanel{left:130px;bottom:74px;width:420px}
  #toolboxPanel{left:18px;bottom:74px;width:var(--toolbox-width);height:var(--toolbox-height);display:flex;flex-direction:column;resize:both;overflow:auto}
  .panel-title{display:flex;align-items:center;justify-content:space-between;padding:6px;border-radius:8px;margin-bottom:8px;cursor:grab;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
  .search-bar{max-width:920px;margin:12px auto;display:flex;background:var(--glass);border-radius:10px;padding:10px;border:1px solid rgba(255,255,255,0.04)}
  .search-bar input{flex:1;border:0;background:transparent;color:var(--text);outline:none;padding:6px}
  .controls{display:flex;gap:8px;justify-content:center;margin-bottom:12px}
  .controls button{padding:8px 12px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--muted);cursor:pointer}
  .dashboard{display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--card-min),1fr));gap:18px;padding:18px}
  .card{perspective:900px;min-width:0}
  .card-inner{position:relative;transform-style:preserve-3d;transition:transform .42s ease}
  .card-front,.card-back{border-radius:10px;padding:14px;background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));border:1px solid var(--border);box-shadow:0 8px 20px rgba(0,0,0,0.35);backface-visibility:hidden}
  .card-front{transform:rotateY(0deg)}
  .card-back{position:absolute;inset:0;transform:rotateY(180deg);display:flex;flex-direction:column;overflow:auto}
  .card.flipped .card-inner{transform:rotateY(180deg)}
  .card.hidden{opacity:0;transform:translateY(8px) scale(.995)}
  .card-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
  .card-header h3{margin:0;color:var(--accent);font-size:1.02rem}
  .palette-grid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-bottom:10px}
  .swatch{width:36px;height:36px;border-radius:8px;border:2px solid var(--border);cursor:pointer}
  .swatch.active{outline:2px solid rgba(255,255,255,0.12);transform:scale(1.03)}
  .toolbox-content{display:flex;flex-direction:column;gap:8px;padding:6px}
  .tool-window{background:linear-gradient(135deg,var(--card-grad-1),var(--card-grad-2));border-radius:8px;padding:8px;border:1px solid var(--border);resize:both;overflow:auto;min-width:160px;min-height:80px;box-shadow:0 8px 20px rgba(0,0,0,0.35)}
  .tw-title{display:flex;justify-content:space-between;align-items:center;cursor:grab;margin-bottom:6px}
  .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:6px 8px;border-radius:8px;color:var(--muted);cursor:pointer}
  .muted{color:var(--muted);font-size:.9rem}
  .tiny{font-size:.82rem;color:rgba(255,255,255,0.6)}
</style>
</head>
<body>
  <button id="toolboxToggle" class="control-btn" title="Toolbox">ðŸ“¦</button>
  <button id="readerToggle" class="control-btn" title="Reader Mode">ðŸ‘“</button>
  <button id="paletteToggle" class="control-btn" title="Theme">ðŸŽ¨</button>

  <div id="palettePanel" class="panel" role="dialog" aria-label="Theme palette" aria-hidden="true">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div style="font-weight:600;color:var(--accent)">Theme editor</div>
      <div class="tiny">Pick role â†’ swatch â†’ apply</div>
    </div>
    <div style="display:flex;gap:8px;align-items:center;margin-bottom:8px">
      <label style="color:var(--muted)">Role</label>
      <select id="paletteRole" style="flex:1;padding:6px;border-radius:8px;border:1px solid var(--border);background:transparent;color:var(--text)">
        <option value="accent">Accent</option>
        <option value="background">Background</option>
        <option value="glass">Glass</option>
        <option value="panel">Panel</option>
        <option value="card">Card</option>
      </select>
    </div>
    <div id="roleSwatches" class="palette-grid" aria-hidden="false"></div>
    <div style="display:flex;gap:8px;align-items:center;margin-top:10px">
      <input id="customColorInput" type="color" value="#2dd4ff" style="width:44px;height:36px;border-radius:8px;border:1px solid var(--border);background:transparent">
      <button id="applyCustom" class="btn-ghost">Apply to role</button>
      <div class="muted">Custom color</div>
    </div>
    <div style="display:flex;justify-content:flex-end;margin-top:10px">
      <button id="resetTheme" class="btn-ghost">Reset</button>
    </div>
  </div>

  <div id="toolboxPanel" class="panel" role="dialog" aria-label="Toolbox" aria-hidden="true">
    <div class="panel-title" id="toolboxTitle">
      <div style="font-weight:600;color:var(--accent)">Toolbox</div>
      <div style="display:flex;gap:8px;align-items:center">
        <button id="addSampleTool" class="btn-ghost">Add window</button>
        <button id="closeToolbox" class="btn-ghost">Close</button>
      </div>
    </div>
    <div id="toolboxContent" class="toolbox-content"></div>
  </div>

  <header><h1>The Most Useful Site in the World</h1></header>

  <main>
    <div class="search-bar"><input id="searchInput" placeholder="Search cards..." /></div>
    <div class="controls">
      <button id="sortAlphaBtn">Sort Aâ†’Z</button>
      <button id="sortRandomBtn">Random</button>
      <button id="shuffleDealBtn">Reâ€‘deal</button>
    </div>
    <div id="status" class="muted" style="text-align:center;margin-bottom:6px">Loading cardsâ€¦</div>
    <div id="gridContainer" class="dashboard" aria-live="polite"></div>
  </main>

<script>
document.addEventListener('DOMContentLoaded', ()=> {
  const qs = s => document.querySelector(s);
  const qsa = s => Array.from(document.querySelectorAll(s));
  const grid = qs('#gridContainer');
  const status = qs('#status');

  /* Palette data and UI */
  const SWATCHES = {
    accent: ['#2dd4ff','#00bcd4','#7c4dff','#ff6b6b','#ffb86b','#00d084','#ff3b8a','#ffd54f','#00a3ff','#8e44ad','#1abc9c','#f39c12'],
    background: ['#0f1720','#071226','#08131a','#0b1b2a','#071a1f','#08121a','#0b1220','#102030','#081824','#0a1b2b'],
    glass: ['rgba(255,255,255,0.04)','rgba(255,255,255,0.06)','rgba(0,0,0,0.06)','rgba(255,240,230,0.04)','rgba(200,220,255,0.04)'],
    panel: ['rgba(20,20,20,0.9)','rgba(10,12,20,0.92)','rgba(30,18,18,0.9)','rgba(8,12,20,0.92)'],
    card: ['rgba(255,255,255,0.03)','rgba(255,255,255,0.06)','rgba(0,0,0,0.03)','rgba(255,240,230,0.03)']
  };
  const roleSelect = qs('#paletteRole');
  const roleSwatches = qs('#roleSwatches');
  const customInput = qs('#customColorInput');
  const applyCustom = qs('#applyCustom');
  const resetTheme = qs('#resetTheme');

  function renderSwatches(role){
    roleSwatches.innerHTML = '';
    (SWATCHES[role] || []).forEach(c=>{
      const d = document.createElement('div');
      d.className = 'swatch';
      d.style.background = c;
      d.dataset.color = c;
      d.addEventListener('click', ()=> {
        roleSwatches.querySelectorAll('.swatch').forEach(x=>x.classList.remove('active'));
        d.classList.add('active');
        applyRoleColor(role, c);
      });
      roleSwatches.appendChild(d);
    });
  }
  function shade(hexOrRgba, pct){
    if(hexOrRgba.startsWith('rgba')){
      const m = hexOrRgba.match(/rgba\((\d+),\s*(\d+),\s*(\d+),\s*([\d.]+)\)/);
      if(!m) return hexOrRgba;
      let r=+m[1], g=+m[2], b=+m[3], a=m[4];
      r = Math.max(0, Math.min(255, Math.round(r*(100+pct)/100)));
      g = Math.max(0, Math.min(255, Math.round(g*(100+pct)/100)));
      b = Math.max(0, Math.min(255, Math.round(b*(100+pct)/100)));
      return `rgba(${r},${g},${b},${a})`;
    }
    let hex = hexOrRgba.replace('#','');
    if(hex.length===3) hex = hex.split('').map(c=>c+c).join('');
    const n = parseInt(hex,16);
    let r=(n>>16)&255, g=(n>>8)&255, b=n&255;
    r = Math.max(0, Math.min(255, Math.round(r*(100+pct)/100)));
    g = Math.max(0, Math.min(255, Math.round(g*(100+pct)/100)));
    b = Math.max(0, Math.min(255, Math.round(b*(100+pct)/100)));
    return '#'+[r,g,b].map(v=>v.toString(16).padStart(2,'0')).join('');
  }
  function applyRoleColor(role, color){
    const root = document.documentElement;
    if(role === 'accent') root.style.setProperty('--accent', color);
    else if(role === 'background'){ root.style.setProperty('--bg-1', color); root.style.setProperty('--bg-2', shade(color,-18)); document.body.style.background = `linear-gradient(135deg,var(--bg-1),var(--bg-2))`; }
    else if(role === 'glass'){ root.style.setProperty('--glass', color); root.style.setProperty('--glass-strong', color); }
    else if(role === 'panel'){ root.style.setProperty('--panel', color); }
    else if(role === 'card'){ root.style.setProperty('--card-grad-1', color); root.style.setProperty('--card-grad-2', shade(color,8)); }
    const saved = JSON.parse(localStorage.getItem('site_theme_v2')||'{}'); saved[role]=color; localStorage.setItem('site_theme_v2', JSON.stringify(saved));
  }
  roleSelect.addEventListener('change', ()=> renderSwatches(roleSelect.value));
  applyCustom.addEventListener('click', ()=> {
    const role = roleSelect.value, color = customInput.value;
    if(!SWATCHES[role]) SWATCHES[role]=[];
    if(!SWATCHES[role].includes(color)) SWATCHES[role].unshift(color);
    renderSwatches(role);
    const el = roleSwatches.querySelector(`[data-color="${color}"]`);
    if(el) el.classList.add('active');
    applyRoleColor(role, color);
  });
  resetTheme.addEventListener('click', ()=> { localStorage.removeItem('site_theme_v2'); location.reload(); });
  (function loadSaved(){ const saved = JSON.parse(localStorage.getItem('site_theme_v2')||'{}'); Object.keys(saved).forEach(r => applyRoleColor(r, saved[r])); renderSwatches(roleSelect.value); const savedRole = Object.keys(saved)[0]; if(savedRole){ roleSelect.value = savedRole; renderSwatches(savedRole); const el = roleSwatches.querySelector(`[data-color="${saved[savedRole]}"]`); if(el) el.classList.add('active'); } })();

  /* ---------- Card loading: local-first, then GitHub fallback ---------- */
  const DEFAULT_REPO = 'mrpr0phecy/mrpr0phecy';
  const DEFAULT_BRANCH = 'main';

  function makeImagesLazy(html){
    return html.replace(/<img\b([^>]*?)>/gi, (m,attrs)=> /loading\s*=/.test(attrs) ? `<img${attrs}>` : `<img loading="lazy"${attrs}>`);
  }

  async function listLocalCards(){
    // Try to fetch an index file (cards/index.json) if present to avoid directory listing issues.
    try{
      const r = await fetch('cards/index.json', {cache:'no-store'});
      if(!r.ok) throw new Error('no local index');
      const arr = await r.json();
      if(Array.isArray(arr) && arr.length) return arr.filter(p=>p.endsWith('.html'));
    }catch(e){
      // fallback: attempt to fetch a known sample file to detect local folder presence
      try{
        const probe = await fetch('cards/sample.html', {method:'HEAD'});
        if(probe.ok) return ['sample.html'];
      }catch(_){}
    }
    return null;
  }

  async function fetchRepoTree(owner,repo,branch){
    const url = `https://api.github.com/repos/${owner}/${repo}/git/trees/${branch}?recursive=1`;
    const r = await fetch(url);
    if(!r.ok) throw new Error('GitHub API error: '+r.status);
    return r.json();
  }
  async function listRepoCards(owner,repo,branch){
    const data = await fetchRepoTree(owner,repo,branch);
    return (data.tree||[]).filter(i=>i.path.startsWith('cards/') && i.path.endsWith('.html')).map(i=>i.path.replace(/^cards\//,''));
  }

  function createCardElement(file){
    const name = file.replace('.html','');
    const wrapper = document.createElement('div');
    wrapper.className = 'card hidden';
    wrapper.dataset.file = file;
    wrapper.dataset.name = name;

    const inner = document.createElement('div'); inner.className = 'card-inner';
    const front = document.createElement('div'); front.className = 'card-front';
    front.innerHTML = `<div class="card-header"><h3>${name}</h3><div class="tiny">${file}</div></div><div class="muted tiny">Click to flip</div>`;
    const back = document.createElement('div'); back.className = 'card-back';
    back.innerHTML = `<div class="card-header"><h3>${name}</h3><div class="tiny">Details</div></div><div class="content">Loadingâ€¦</div>`;

    inner.appendChild(front); inner.appendChild(back); wrapper.appendChild(inner);

    wrapper.addEventListener('click', ()=> {
      if(!wrapper.classList.contains('flipped')) flipCard(wrapper);
    });

    const io = new IntersectionObserver(entries=>{
      entries.forEach(entry=>{
        if(entry.isIntersecting){
          loadCardContentInto(wrapper, file).catch(()=> { back.querySelector('.content').textContent = 'Preview unavailable.'; });
          io.unobserve(wrapper);
        }
      });
    }, {threshold:0.08, rootMargin:'200px 0px 200px 0px'});
    io.observe(wrapper);

    return wrapper;
  }

  async function loadCardContentInto(wrapper,file){
    if(wrapper.dataset.loaded === 'true') return;
    try{
      // prefer local path first
      const localUrl = `cards/${file}`;
      const r = await fetch(localUrl);
      if(!r.ok) throw new Error('local fetch failed');
      let html = await r.text();
      html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
      html = makeImagesLazy(html);
      const content = wrapper.querySelector('.card-back .content');
      content.innerHTML = html;
      wrapper.dataset.loaded = 'true';
    }catch(localErr){
      // local failed â€” try GitHub raw URL fallback
      try{
        const raw = `https://raw.githubusercontent.com/${DEFAULT_REPO}/${DEFAULT_BRANCH}/cards/${file}`;
        const r2 = await fetch(raw);
        if(!r2.ok) throw new Error('raw fetch failed: '+r2.status);
        let html = await r2.text();
        html = html.replace(/<script[\s\S]*?>[\s\S]*?<\/script>/gi,'');
        html = makeImagesLazy(html);
        const content = wrapper.querySelector('.card-back .content');
        content.innerHTML = html;
        wrapper.dataset.loaded = 'true';
      }catch(gErr){
        console.error('Both local and GitHub fetch failed for', file, localErr, gErr);
        wrapper.querySelector('.card-back .content').textContent = 'Failed to load';
      }
    }
  }

  function flipCard(wrapper){
    if(wrapper.classList.contains('flipped')) return;
    wrapper.classList.add('flipped');
    const backContent = wrapper.querySelector('.card-back .content');
    if(backContent){ backContent.style.opacity = '0'; backContent.style.transition = 'opacity .28s ease'; requestAnimationFrame(()=> backContent.style.opacity = '1'); }
  }

  async function sequentialDeal(){
    const cards = Array.from(grid.querySelectorAll('.card'));
    cards.forEach(c=>{ c.classList.remove('flipped'); c.classList.add('hidden'); });
    await new Promise(r=>setTimeout(r,80));
    for(const c of cards){
      const file = c.dataset.file;
      await loadCardContentInto(c, file);
      c.classList.remove('hidden');
      flipCard(c);
      await new Promise(r=>setTimeout(r,260));
    }
  }

  async function loadDashboard(){
    status.textContent = 'Looking for local cardsâ€¦';
    try{
      const localList = await listLocalCards();
      let files = null;
      if(Array.isArray(localList) && localList.length){
        files = localList;
        console.log('Using local cards list:', files);
        status.textContent = `Found ${files.length} local card(s).`;
      } else {
        status.textContent = 'No local index; trying GitHub repoâ€¦';
        try{
          const {owner,repo} = parseOwnerRepo(DEFAULT_REPO);
          const repoFiles = await listRepoCards(owner,repo,DEFAULT_BRANCH);
          if(repoFiles && repoFiles.length){
            files = repoFiles;
            status.textContent = `Loaded ${files.length} cards from GitHub.`;
            console.log('Using GitHub cards list:', files);
          } else {
            status.textContent = 'No cards found in repo.';
            console.warn('No cards found in repo tree.');
            return;
          }
        }catch(repoErr){
          status.textContent = 'Failed to list cards from GitHub.';
          console.error('GitHub listing failed:', repoErr);
          return;
        }
      }

      // render
      grid.innerHTML = '';
      files.sort((a,b)=>a.localeCompare(b,undefined,{sensitivity:'base',numeric:true}));
      files.forEach(f => grid.appendChild(createCardElement(f)));
      status.textContent = `Rendered ${files.length} cards. Dealingâ€¦`;
      await new Promise(r=>setTimeout(r,120));
      sequentialDeal();
    }catch(e){
      status.textContent = 'Error loading cards.';
      console.error('loadDashboard error:', e);
    }
  }

  /* Toolbox UI */
  const toolboxPanel = qs('#toolboxPanel');
  const toolboxToggle = qs('#toolboxToggle');
  const toolboxTitle = qs('#toolboxTitle');
  const toolboxContent = qs('#toolboxContent');
  const addSampleTool = qs('#addSampleTool');
  const closeToolbox = qs('#closeToolbox');

  toolboxToggle.addEventListener('click', ()=> toolboxPanel.classList.toggle('open'));
  closeToolbox.addEventListener('click', ()=> toolboxPanel.classList.remove('open'));

  (function makeDraggable(el, handle){
    let dragging=false, startX=0, startY=0, startLeft=0, startTop=0;
    handle.addEventListener('pointerdown', e=>{
      dragging=true; handle.setPointerCapture(e.pointerId);
      const rect = el.getBoundingClientRect();
      startX = e.clientX; startY = e.clientY; startLeft = rect.left; startTop = rect.top;
      el.style.transition = 'none';
    });
    window.addEventListener('pointermove', e=>{
      if(!dragging) return;
      const dx = e.clientX - startX, dy = e.clientY - startY;
      el.style.left = Math.max(8, startLeft + dx) + 'px';
      el.style.top = Math.max(8, startTop + dy) + 'px';
      el.style.right = 'auto'; el.style.bottom = 'auto';
    });
    window.addEventListener('pointerup', ()=>{ if(dragging){ dragging=false; el.style.transition=''; } });
  })(toolboxPanel, toolboxTitle);

  function createToolWindow(title, html){
    const win = document.createElement('div'); win.className = 'tool-window';
    win.innerHTML = `<div class="tw-title"><strong>${title}</strong><div><button class="btn-ghost tw-close">âœ•</button></div></div><div class="tw-body">${html}</div>`;
    win.querySelector('.tw-close').addEventListener('click', ()=> win.remove());
    makeDragWithinContainer(win, win.querySelector('.tw-title'), toolboxContent);
    return win;
  }
  function makeDragWithinContainer(win, handle, container){
    let dragging=false, placeholder=null;
    handle.addEventListener('pointerdown', e=>{
      dragging=true; handle.setPointerCapture(e.pointerId);
      placeholder = document.createElement('div'); placeholder.style.height = win.offsetHeight + 'px'; placeholder.style.border = '1px dashed rgba(255,255,255,0.06)'; placeholder.style.marginBottom='8px';
      win.style.opacity = '0.9'; win.style.position = 'relative'; win.style.zIndex = 9999;
    });
    window.addEventListener('pointermove', e=>{
      if(!dragging) return;
      const y = e.clientY;
      const children = Array.from(container.children).filter(c=>c!==win);
      let insertBefore = null;
      for(const c of children){
        const r = c.getBoundingClientRect();
        if(y < r.top + r.height/2){ insertBefore = c; break; }
      }
      if(insertBefore) container.insertBefore(placeholder, insertBefore);
      else container.appendChild(placeholder);
    });
    window.addEventListener('pointerup', ()=>{
      if(!dragging) return;
      dragging=false;
      win.style.opacity=''; win.style.position=''; win.style.zIndex='';
      if(placeholder){ container.insertBefore(win, placeholder); placeholder.remove(); placeholder=null; }
    });
  }

  addSampleTool.addEventListener('click', ()=> {
    const id = 'Window ' + (toolboxContent.children.length + 1);
    toolboxContent.appendChild(createToolWindow(id, '<div class="muted">Resizable, draggable window content</div>'));
  });
  if(toolboxContent.children.length === 0){
    toolboxContent.appendChild(createToolWindow('Notes', '<div class="muted">Quick notes</div>'));
    toolboxContent.appendChild(createToolWindow('Calculator', '<div class="muted">Calculator placeholder</div>'));
  }

  // sortable
  new Sortable(grid, {animation:120});
  new Sortable(toolboxContent, {animation:120});

  // start
  loadDashboard();
});
</script>
</body>
</html>
