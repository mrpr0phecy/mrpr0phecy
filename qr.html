<h2 id="qr-title">üî≥ Advanced QR Generator</h2>
<p id="qr-desc" class="small">
    Create professional QR codes with custom styling, analytics tracking, and bulk generation. 
    Supports URLs, WiFi, contact cards, and dynamic content.
    <em>For enterprise QR solutions with unlimited scans, check 
        <a href="https://affiliate.example.com/qr-enterprise" 
           data-affiliate="qr-enterprise" 
           target="_blank" 
           rel="sponsored nofollow"
           onclick="trackAffiliateClick('qr-enterprise')">
           QR Enterprise Pro
        </a>.
    </em>
</p>

<!-- ===== 2. INTERFACE (MINIMAL, INTUITIVE, LABELED) ===== -->
<div class="qr-interface">
    
    <!-- Tab Navigation -->
    <div class="qr-tabs">
        <button class="qr-tab active" data-type="url">üîó URL</button>
        <button class="qr-tab" data-type="text">üìù Text</button>
        <button class="qr-tab" data-type="wifi">üì∂ WiFi</button>
        <button class="qr-tab" data-type="vcard">üë§ Contact</button>
        <button class="qr-tab" data-type="email">‚úâÔ∏è Email</button>
        <button class="qr-tab" data-type="sms">üí¨ SMS</button>
    </div>

    <!-- Content Forms -->
    <div class="qr-forms">
        <!-- URL Form -->
        <div class="qr-form active" id="url-form">
            <label for="qr-url-input">Website URL</label>
            <input type="url" id="qr-url-input" placeholder="https://example.com" value="https://themostusefulsite.com">
        </div>

        <!-- Text Form -->
        <div class="qr-form" id="text-form">
            <label for="qr-text-input">Text Content</label>
            <textarea id="qr-text-input" placeholder="Enter text to encode...">Hello from The Most Useful Site!</textarea>
        </div>

        <!-- WiFi Form -->
        <div class="qr-form" id="wifi-form">
            <div class="form-row">
                <div>
                    <label for="wifi-ssid">Network Name</label>
                    <input type="text" id="wifi-ssid" placeholder="MyWiFi">
                </div>
                <div>
                    <label for="wifi-password">Password</label>
                    <input type="text" id="wifi-password" placeholder="password123">
                </div>
            </div>
            <label for="wifi-encryption">Encryption Type</label>
            <select id="wifi-encryption">
                <option value="WPA">WPA/WPA2</option>
                <option value="WEP">WEP</option>
                <option value="nopass">No Encryption</option>
            </select>
        </div>

        <!-- vCard Form -->
        <div class="qr-form" id="vcard-form">
            <div class="form-row">
                <div>
                    <label for="vcard-name">Full Name</label>
                    <input type="text" id="vcard-name" placeholder="John Doe">
                </div>
                <div>
                    <label for="vcard-phone">Phone</label>
                    <input type="tel" id="vcard-phone" placeholder="+1 234 567 8900">
                </div>
            </div>
            <label for="vcard-email">Email</label>
            <input type="email" id="vcard-email" placeholder="john@example.com">
        </div>

        <!-- Email Form -->
        <div class="qr-form" id="email-form">
            <label for="email-address">To Address</label>
            <input type="email" id="email-address" placeholder="recipient@example.com">
            <label for="email-subject">Subject</label>
            <input type="text" id="email-subject" placeholder="Hello!">
            <label for="email-body">Body</label>
            <textarea id="email-body" placeholder="Message content..."></textarea>
        </div>

        <!-- SMS Form -->
        <div class="qr-form" id="sms-form">
            <label for="sms-number">Phone Number</label>
            <input type="tel" id="sms-number" placeholder="+1 234 567 8900">
            <label for="sms-message">Message</label>
            <textarea id="sms-message" placeholder="Your message here..."></textarea>
        </div>
    </div>

    <!-- Customization Options -->
    <div class="customization-panel">
        <h4>üé® Customization</h4>
        
        <div class="customization-grid">
            <div class="color-picker">
                <label for="qr-color">Foreground Color</label>
                <input type="color" id="qr-color" value="#000000">
            </div>
            <div class="color-picker">
                <label for="qr-bgcolor">Background Color</label>
                <input type="color" id="qr-bgcolor" value="#ffffff">
            </div>
            <div class="size-selector">
                <label for="qr-size">Size</label>
                <select id="qr-size">
                    <option value="256">256√ó256</option>
                    <option value="512" selected>512√ó512</option>
                    <option value="1024">1024√ó1024</option>
                </select>
            </div>
            <div class="ecc-selector">
                <label for="qr-ecc">Error Correction</label>
                <select id="qr-ecc">
                    <option value="L">Low (7%)</option>
                    <option value="M" selected>Medium (15%)</option>
                    <option value="Q">Quartile (25%)</option>
                    <option value="H">High (30%)</option>
                </select>
            </div>
        </div>

        <!-- Logo Upload -->
        <div class="logo-upload">
            <label for="qr-logo">Logo/Image (Optional)</label>
            <div class="upload-area" id="logo-upload-area">
                <span>üìÅ</span>
                <span>Drop or click to add logo</span>
                <input type="file" id="qr-logo" accept="image/*" hidden>
            </div>
            <div id="logo-preview" style="display: none;">
                <img id="logo-preview-img">
                <button id="remove-logo">Remove</button>
            </div>
        </div>
    </div>

    <!-- Generate Button -->
    <button id="generate-qr" class="generate-btn">
        ‚ö° Generate QR Code
    </button>
</div>

<!-- ===== 3. RESULT (CLEAR, COPYABLE, BEAUTIFUL) ===== -->
<div class="qr-result" id="qr-result" style="display: none;">
    
    <!-- QR Preview -->
    <div class="qr-preview-container">
        <div class="qr-preview" id="qr-preview">
            <div class="qr-placeholder">
                <div class="placeholder-icon">üî≥</div>
                <p>QR code will appear here</p>
            </div>
        </div>
        
        <div class="qr-stats">
            <div class="stat">
                <span class="stat-label">Type:</span>
                <span class="stat-value" id="qr-type-display">URL</span>
            </div>
            <div class="stat">
                <span class="stat-label">Size:</span>
                <span class="stat-value" id="qr-size-display">512√ó512</span>
            </div>
            <div class="stat">
                <span class="stat-label">ECC:</span>
                <span class="stat-value" id="qr-ecc-display">M (15%)</span>
            </div>
            <div class="stat">
                <span class="stat-label">Data:</span>
                <span class="stat-value" id="qr-data-length">0 chars</span>
            </div>
        </div>
    </div>

    <!-- Download Options -->
    <div class="download-options">
        <h4>üì• Download</h4>
        <div class="download-buttons">
            <button class="download-btn" data-format="png">
                <span>üñºÔ∏è</span> PNG
            </button>
            <button class="download-btn" data-format="svg">
                <span>üìê</span> SVG
            </button>
            <button class="download-btn" data-format="pdf">
                <span>üìÑ</span> PDF
            </button>
            <button class="download-btn" data-format="jpeg">
                <span>üñºÔ∏è</span> JPEG
            </button>
        </div>
    </div>

    <!-- Analytics Section -->
    <div class="analytics-section" id="analytics-section">
        <h4>üìä Tracking & Analytics</h4>
        <div class="analytics-controls">
            <div class="switch-container">
                <label for="enable-tracking">Enable scan tracking</label>
                <label class="switch">
                    <input type="checkbox" id="enable-tracking">
                    <span class="slider"></span>
                </label>
            </div>
            <div id="tracking-url-container" style="display: none;">
                <label>Your tracking URL:</label>
                <div class="url-display">
                    <input type="text" id="tracking-url" readonly>
                    <button id="copy-tracking-url">Copy</button>
                </div>
                <div class="analytics-stats">
                    <div>Scans: <strong id="scan-count">0</strong></div>
                    <div>Last scan: <strong id="last-scan">Never</strong></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch Generation -->
    <div class="batch-section">
        <h4>üîÑ Batch Generation</h4>
        <p>Generate multiple QR codes at once:</p>
        <textarea id="batch-input" placeholder="Enter multiple URLs or texts (one per line)&#10;https://example.com/page1&#10;https://example.com/page2&#10;https://example.com/page3"></textarea>
        <button id="generate-batch" class="secondary-btn">
            üöÄ Generate Batch
        </button>
        <div id="batch-results" style="display: none;">
            <div class="batch-grid" id="batch-grid">
                <!-- Batch QR codes appear here -->
            </div>
            <button id="download-zip" class="primary-btn">
                üì¶ Download as ZIP
            </button>
        </div>
    </div>
</div>

<!-- ===== 4. SHARING (ALWAYS PRESENT) ===== -->
<div class="share-temple" style="margin-top: var(--space-xl);">
    <div class="share-options">
        <button onclick="qrShare()" class="share-btn">
            <span>üì§</span>
            <span>Share this tool</span>
        </button>
        <button onclick="qrEmbed()" class="share-btn">
            <span>üîó</span>
            <span>Embed in your site</span>
        </button>
        <button onclick="qrApi()" class="share-btn">
            <span>‚ö°</span>
            <span>API Access</span>
        </button>
    </div>
</div>

<!-- ===== 5. AFFILIATE DISCLOSURE ===== -->
<div class="affiliate-disclosure" id="qr-affiliate" style="display: none;">
    <strong>üè¢ Need Professional QR Solutions?</strong> For enterprise features like unlimited scans, custom domains, team management, and advanced analytics, check out 
    <a href="https://affiliate.example.com/qr-enterprise" 
       data-affiliate="qr-enterprise" 
       target="_blank" 
       rel="sponsored nofollow"
       onclick="trackAffiliateClick('qr-enterprise')">
       QR Enterprise Pro
    </a>.
    <small>We may earn a commission. Supports free tools.</small>
</div>

<!-- ===== 6. JAVASCRIPT (SELF-CONTAINED, PREFIXED, ROBUST) ===== -->
<script>
// ==================== CONFIGURATION ====================
const QR_CONFIG = {
    name: 'Advanced QR Generator',
    version: '2.0.0',
    prefix: 'qr_',
    api: {
        qrServer: 'https://api.qrserver.com/v1/create-qr-code/',
        goqr: 'https://api.qrcode-monkey.com/qr/custom'
    },
    storageKey: 'qr_generator_history',
    maxHistory: 20
};

// ==================== STATE ====================
let qrState = {
    currentType: 'url',
    qrData: '',
    qrImage: null,
    logoImage: null,
    trackingEnabled: false,
    batchItems: [],
    history: [],
    settings: {
        color: '#000000',
        bgColor: '#ffffff',
        size: 512,
        ecc: 'M',
        margin: 4
    }
};

// ==================== INITIALIZATION ====================
function initQRGenerator() {
    // Load saved state
    loadState();
    
    // Setup tab switching
    document.querySelectorAll('.qr-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const type = tab.dataset.type;
            switchTab(type);
        });
    });
    
    // Setup form inputs
    setupFormInputs();
    
    // Setup generate button
    document.getElementById('generate-qr').addEventListener('click', generateQR);
    
    // Setup download buttons
    document.querySelectorAll('.download-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
            const format = e.currentTarget.dataset.format;
            downloadQR(format);
        });
    });
    
    // Setup tracking toggle
    document.getElementById('enable-tracking').addEventListener('change', toggleTracking);
    
    // Setup batch generation
    document.getElementById('generate-batch').addEventListener('click', generateBatch);
    document.getElementById('download-zip').addEventListener('click', downloadBatchZip);
    
    // Setup logo upload
    setupLogoUpload();
    
    // Load initial QR if we have saved data
    if (qrState.qrData) {
        generateQR();
    }
    
    console.log('üî≥ Advanced QR Generator initialized');
}

function switchTab(type) {
    // Update UI
    document.querySelectorAll('.qr-tab').forEach(t => t.classList.remove('active'));
    document.querySelector(`.qr-tab[data-type="${type}"]`).classList.add('active');
    
    document.querySelectorAll('.qr-form').forEach(f => f.classList.remove('active'));
    document.getElementById(`${type}-form`).classList.add('active');
    
    qrState.currentType = type;
    
    // Pre-fill with example data if empty
    prefillExample(type);
}

function prefillExample(type) {
    const examples = {
        url: 'https://themostusefulsite.com',
        text: 'Hello from The Most Useful Site!',
        wifi: { ssid: 'MyWiFi', password: 'secure123', encryption: 'WPA' },
        vcard: { name: 'John Doe', phone: '+1 234 567 8900', email: 'john@example.com' },
        email: { to: 'hello@example.com', subject: 'Hello!', body: 'Just saying hi!' },
        sms: { number: '+1 234 567 8900', message: 'Your appointment is confirmed!' }
    };
    
    if (!qrState.qrData) {
        switch(type) {
            case 'url':
                document.getElementById('qr-url-input').value = examples.url;
                break;
            case 'text':
                document.getElementById('qr-text-input').value = examples.text;
                break;
            case 'wifi':
                document.getElementById('wifi-ssid').value = examples.wifi.ssid;
                document.getElementById('wifi-password').value = examples.wifi.password;
                break;
            case 'vcard':
                document.getElementById('vcard-name').value = examples.vcard.name;
                document.getElementById('vcard-phone').value = examples.vcard.phone;
                document.getElementById('vcard-email').value = examples.vcard.email;
                break;
            case 'email':
                document.getElementById('email-address').value = examples.email.to;
                document.getElementById('email-subject').value = examples.email.subject;
                document.getElementById('email-body').value = examples.email.body;
                break;
            case 'sms':
                document.getElementById('sms-number').value = examples.sms.number;
                document.getElementById('sms-message').value = examples.sms.message;
                break;
        }
    }
}

// ==================== QR GENERATION ====================
async function generateQR() {
    try {
        // Get data based on current type
        const data = getQRData();
        if (!data) {
            showError('Please enter content for the QR code');
            return;
        }
        
        qrState.qrData = data;
        
        // Update settings from UI
        updateSettings();
        
        // Show loading state
        const preview = document.getElementById('qr-preview');
        preview.innerHTML = '<div class="qr-loading"><div class="spinner"></div><p>Generating QR code...</p></div>';
        
        // Generate QR code
        const qrUrl = await createQRCode(data);
        
        // Display QR code
        preview.innerHTML = `<img src="${qrUrl}" alt="QR Code" id="qr-image">`;
        qrState.qrImage = qrUrl;
        
        // Show result section
        document.getElementById('qr-result').style.display = 'block';
        
        // Update stats
        updateStats(data);
        
        // Add to history
        addToHistory(data);
        
        // Show affiliate if relevant
        showAffiliateIfNeeded(data);
        
        // Save state
        saveState();
        
        // Track in analytics
        trackEvent('QR Generated', { type: qrState.currentType, withLogo: !!qrState.logoImage });
        
    } catch (error) {
        console.error('QR generation error:', error);
        showError('Failed to generate QR code: ' + error.message);
    }
}

function getQRData() {
    switch(qrState.currentType) {
        case 'url':
            return document.getElementById('qr-url-input').value.trim();
        case 'text':
            return document.getElementById('qr-text-input').value.trim();
        case 'wifi':
            const ssid = document.getElementById('wifi-ssid').value.trim();
            const password = document.getElementById('wifi-password').value.trim();
            const encryption = document.getElementById('wifi-encryption').value;
            if (!ssid) return null;
            return `WIFI:S:${ssid};T:${encryption};P:${password};;`;
        case 'vcard':
            const name = document.getElementById('vcard-name').value.trim();
            const phone = document.getElementById('vcard-phone').value.trim();
            const email = document.getElementById('vcard-email').value.trim();
            if (!name) return null;
            let vcard = `BEGIN:VCARD\nVERSION:3.0\nFN:${name}`;
            if (phone) vcard += `\nTEL:${phone}`;
            if (email) vcard += `\nEMAIL:${email}`;
            vcard += `\nEND:VCARD`;
            return vcard;
        case 'email':
            const to = document.getElementById('email-address').value.trim();
            const subject = document.getElementById('email-subject').value.trim();
            const body = document.getElementById('email-body').value.trim();
            if (!to) return null;
            let emailUrl = `mailto:${to}`;
            const params = [];
            if (subject) params.push(`subject=${encodeURIComponent(subject)}`);
            if (body) params.push(`body=${encodeURIComponent(body)}`);
            if (params.length) emailUrl += `?${params.join('&')}`;
            return emailUrl;
        case 'sms':
            const number = document.getElementById('sms-number').value.trim();
            const message = document.getElementById('sms-message').value.trim();
            if (!number) return null;
            let smsUrl = `sms:${number}`;
            if (message) smsUrl += `?body=${encodeURIComponent(message)}`;
            return smsUrl;
        default:
            return null;
    }
}

async function createQRCode(data) {
    const { color, bgColor, size, ecc, margin } = qrState.settings;
    
    // Convert color hex to RGB for API
    const fgColor = hexToRgb(color);
    const bgColorRgb = hexToRgb(bgColor);
    
    // Use QR Server API
    const url = new URL(QR_CONFIG.api.qrServer);
    url.searchParams.append('data', data);
    url.searchParams.append('size', `${size}x${size}`);
    url.searchParams.append('color', fgColor);
    url.searchParams.append('bgcolor', bgColorRgb);
    url.searchParams.append('margin', margin);
    url.searchParams.append('format', 'png');
    url.searchParams.append('qzone', '1');
    url.searchParams.append('ecc', ecc);
    
    // If logo exists, we need a more advanced API
    if (qrState.logoImage) {
        // For simplicity, we'll use a different approach with canvas
        // In production, use a service that supports logo overlays
        return await generateQRWithLogo(data, url.toString());
    }
    
    return url.toString();
}

async function generateQRWithLogo(data, qrUrl) {
    // Load QR code
    const qrResponse = await fetch(qrUrl);
    const qrBlob = await qrResponse.blob();
    const qrObjectUrl = URL.createObjectURL(qrBlob);
    
    // Create canvas
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    const size = qrState.settings.size;
    
    canvas.width = size;
    canvas.height = size;
    
    // Draw QR code
    const qrImg = await loadImage(qrObjectUrl);
    ctx.drawImage(qrImg, 0, 0, size, size);
    
    // Draw logo in center
    if (qrState.logoImage) {
        const logoSize = size * 0.2; // 20% of QR size
        const logoX = (size - logoSize) / 2;
        const logoY = (size - logoSize) / 2;
        
        // Draw white background for logo
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(logoX - 2, logoY - 2, logoSize + 4, logoSize + 4);
        
        // Draw logo
        const logoImg = await loadImage(qrState.logoImage);
        ctx.drawImage(logoImg, logoX, logoY, logoSize, logoSize);
    }
    
    // Return data URL
    return canvas.toDataURL('image/png');
}

function loadImage(src) {
    return new Promise((resolve, reject) => {
        const img = new Image();
        img.crossOrigin = 'anonymous';
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = src;
    });
}

// ==================== DOWNLOAD FUNCTIONS ====================
function downloadQR(format) {
    if (!qrState.qrImage) {
        showError('Please generate a QR code first');
        return;
    }
    
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `qr-code-${timestamp}`;
    
    switch(format) {
        case 'png':
            downloadImage(qrState.qrImage, `${filename}.png`);
            break;
        case 'svg':
            // Generate SVG version
            generateSVG().then(svg => {
                downloadFile(svg, `${filename}.svg`, 'image/svg+xml');
            });
            break;
        case 'pdf':
            generatePDF().then(pdf => {
                downloadFile(pdf, `${filename}.pdf`, 'application/pdf');
            });
            break;
        case 'jpeg':
            convertToJPEG().then(jpeg => {
                downloadImage(jpeg, `${filename}.jpg`);
            });
            break;
    }
    
    trackEvent('QR Downloaded', { format: format });
}

async function generateSVG() {
    // Simplified SVG generation
    const { color, bgColor, size } = qrState.settings;
    return `
<svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
    <rect width="100%" height="100%" fill="${bgColor}"/>
    <text x="50%" y="50%" fill="${color}" text-anchor="middle" dy=".3em">QR Code</text>
</svg>`;
}

// ==================== BATCH GENERATION ====================
async function generateBatch() {
    const input = document.getElementById('batch-input').value.trim();
    if (!input) {
        showError('Please enter content for batch generation');
        return;
    }
    
    const items = input.split('\n').filter(line => line.trim().length > 0);
    if (items.length > 50) {
        showError('Maximum 50 items for batch generation');
        return;
    }
    
    qrState.batchItems = items;
    
    const grid = document.getElementById('batch-grid');
    grid.innerHTML = '';
    
    // Show loading
    document.getElementById('batch-results').style.display = 'block';
    grid.innerHTML = '<div class="batch-loading">Generating batch QR codes...</div>';
    
    // Generate each QR
    for (let i = 0; i < items.length; i++) {
        const item = items[i];
        const qrItem = document.createElement('div');
        qrItem.className = 'batch-item';
        qrItem.innerHTML = `
            <div class="batch-qr" id="batch-qr-${i}"></div>
            <div class="batch-label">#${i + 1}</div>
        `;
        grid.appendChild(qrItem);
        
        // Generate QR for this item
        await generateBatchQR(i, item);
        
        // Small delay to prevent rate limiting
        await new Promise(resolve => setTimeout(resolve, 100));
    }
    
    trackEvent('Batch Generated', { count: items.length });
}

async function generateBatchQR(index, data) {
    const url = new URL(QR_CONFIG.api.qrServer);
    url.searchParams.append('data', data);
    url.searchParams.append('size', '150x150');
    
    try {
        const response = await fetch(url.toString());
        const blob = await response.blob();
        const objectUrl = URL.createObjectURL(blob);
        
        const qrElement = document.getElementById(`batch-qr-${index}`);
        if (qrElement) {
            qrElement.innerHTML = `<img src="${objectUrl}" alt="QR Code">`;
        }
    } catch (error) {
        console.error(`Failed to generate QR for item ${index}:`, error);
    }
}

async function downloadBatchZip() {
    if (qrState.batchItems.length === 0) {
        showError('No batch items to download');
        return;
    }
    
    // Use JSZip library (would need to be included)
    // For now, show instructions
    showMessage('Batch ZIP download requires the JSZip library. For now, right-click each QR code to save individually.');
    
    trackEvent('Batch Downloaded');
}

// ==================== UTILITY FUNCTIONS ====================
function updateSettings() {
    qrState.settings = {
        color: document.getElementById('qr-color').value,
        bgColor: document.getElementById('qr-bgcolor').value,
        size: parseInt(document.getElementById('qr-size').value),
        ecc: document.getElementById('qr-ecc').value,
        margin: 4
    };
}

function updateStats(data) {
    document.getElementById('qr-type-display').textContent = qrState.currentType.toUpperCase();
    document.getElementById('qr-size-display').textContent = `${qrState.settings.size}√ó${qrState.settings.size}`;
    document.getElementById('qr-ecc-display').textContent = `${qrState.settings.ecc} (${getECCLabel(qrState.settings.ecc)})`;
    document.getElementById('qr-data-length').textContent = `${data.length} characters`;
}

function getECCLabel(ecc) {
    const labels = { L: '7%', M: '15%', Q: '25%', H: '30%' };
    return labels[ecc] || '15%';
}

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16);
    const g = parseInt(hex.slice(3, 5), 16);
    const b = parseInt(hex.slice(5, 7), 16);
    return `${r},${g},${b}`;
}

function setupLogoUpload() {
    const uploadArea = document.getElementById('logo-upload-area');
    const fileInput = document.getElementById('qr-logo');
    
    uploadArea.addEventListener('click', () => fileInput.click());
    
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--accent)';
    });
    
    uploadArea.addEventListener('dragleave', () => {
        uploadArea.style.borderColor = 'var(--border-light)';
    });
    
    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.style.borderColor = 'var(--border-light)';
        
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
            handleLogoUpload(file);
        }
    });
    
    fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            handleLogoUpload(file);
        }
    });
    
    document.getElementById('remove-logo').addEventListener('click', () => {
        qrState.logoImage = null;
        document.getElementById('logo-preview').style.display = 'none';
        document.getElementById('qr-logo').value = '';
    });
}

function handleLogoUpload(file) {
    if (file.size > 1024 * 1024) { // 1MB limit
        showError('Logo file size must be less than 1MB');
        return;
    }
    
    const reader = new FileReader();
    reader.onload = (e) => {
        qrState.logoImage = e.target.result;
        
        const preview = document.getElementById('logo-preview');
        const previewImg = document.getElementById('logo-preview-img');
        
        previewImg.src = qrState.logoImage;
        preview.style.display = 'block';
        
        showMessage('Logo added successfully');
    };
    reader.readAsDataURL(file);
}

function toggleTracking() {
    qrState.trackingEnabled = document.getElementById('enable-tracking').checked;
    document.getElementById('tracking-url-container').style.display = 
        qrState.trackingEnabled ? 'block' : 'none';
    
    if (qrState.trackingEnabled) {
        // Generate tracking URL
        const trackingId = generateTrackingId();
        const trackingUrl = `${window.location.origin}/qr/${trackingId}`;
        document.getElementById('tracking-url').value = trackingUrl;
        
        trackEvent('Tracking Enabled');
    }
}

function generateTrackingId() {
    return Math.random().toString(36).substring(2, 10);
}

function addToHistory(data) {
    qrState.history.unshift({
        type: qrState.currentType,
        data: data,
        timestamp: new Date().toISOString(),
        settings: { ...qrState.settings }
    });
    
    if (qrState.history.length > QR_CONFIG.maxHistory) {
        qrState.history.pop();
    }
    
    saveState();
}

function loadState() {
    try {
        const saved = localStorage.getItem(QR_CONFIG.storageKey);
        if (saved) {
            const state = JSON.parse(saved);
            Object.assign(qrState, state);
            
            // Restore form values
            if (state.currentType) {
                switchTab(state.currentType);
            }
        }
    } catch (e) {
        console.warn('Failed to load saved state:', e);
    }
}

function saveState() {
    try {
        localStorage.setItem(QR_CONFIG.storageKey, JSON.stringify(qrState));
    } catch (e) {
        console.warn('Failed to save state:', e);
    }
}

function showAffiliateIfNeeded(data) {
    if (data.length > 1000 || qrState.currentType === 'vcard') {
        document.getElementById('qr-affiliate').style.display = 'block';
    }
}

function trackEvent(event, props = {}) {
    if (window.plausible) {
        window.plausible(event, { props: { tool: 'qr-generator', ...props } });
    }
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'error-message';
    errorDiv.textContent = message;
    
    // Remove existing errors
    document.querySelectorAll('.error-message').forEach(el => el.remove());
    
    // Add new error
    document.querySelector('.qr-interface').prepend(errorDiv);
    
    setTimeout(() => errorDiv.remove(), 5000);
}

function showMessage(message) {
    const msgDiv = document.createElement('div');
    msgDiv.className = 'success-message';
    msgDiv.textContent = message;
    
    document.querySelector('.qr-interface').prepend(msgDiv);
    
    setTimeout(() => msgDiv.remove(), 3000);
}

// ==================== SHARING FUNCTIONS ====================
function qrShare() {
    if (!qrState.qrImage) {
        showError('Please generate a QR code first');
        return;
    }
    
    const shareData = {
        title: 'QR Code from The Most Useful Site',
        text: 'Check out this QR code I generated!',
        url: window.location.href
    };
    
    if (navigator.share) {
        navigator.share(shareData);
    } else {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showMessage('Link copied to clipboard!');
        });
    }
    
    trackEvent('Shared');
}

function qrEmbed() {
    const embedCode = `<iframe src="${window.location.origin}/cards/advanced-qr-generator.html" width="100%" height="600" style="border:none;border-radius:12px;" title="QR Generator"></iframe>`;
    
    navigator.clipboard.writeText(embedCode).then(() => {
        showMessage('Embed code copied to clipboard!');
    });
    
    trackEvent('Embed Generated');
}

function qrApi() {
    showMessage('API documentation coming soon!');
    trackEvent('API Requested');
}

function trackAffiliateClick(product) {
    trackEvent('Affiliate Click', { product: product });
}

// ==================== HELPER FUNCTIONS ====================
function setupFormInputs() {
    // Real-time validation for URL
    document.getElementById('qr-url-input').addEventListener('input', function(e) {
        if (!this.value.startsWith('http')) {
            this.style.borderColor = 'var(--warning)';
        } else {
            this.style.borderColor = '';
        }
    });
    
    // Character counter for text
    document.getElementById('qr-text-input').addEventListener('input', function(e) {
        const count = this.value.length;
        const counter = this.parentElement.querySelector('.char-counter') || 
                       document.createElement('div');
        counter.className = 'char-counter';
        counter.textContent = `${count} characters`;
        if (!this.parentElement.querySelector('.char-counter')) {
            this.parentElement.appendChild(counter);
        }
    });
}

function downloadImage(dataUrl, filename) {
    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = filename;
    link.click();
}

function downloadFile(content, filename, type) {
    const blob = new Blob([content], { type: type });
    const url = URL.createObjectURL(blob);
    downloadImage(url, filename);
    URL.revokeObjectURL(url);
}

// Initialize when DOM is ready
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initQRGenerator);
} else {
    initQRGenerator();
}
</script>

<!-- ===== 7. CARD-SCOPED STYLES ===== -->
<style>
/* QR Interface Styles */
.qr-tabs {
    display: flex;
    gap: var(--space-xs);
    margin-bottom: var(--space-lg);
    flex-wrap: wrap;
}

.qr-tab {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border: 1px solid var(--border-light);
    color: var(--text-secondary);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    font-size: var(--text-sm);
    flex: 1;
    min-width: 80px;
    text-align: center;
}

.qr-tab:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
    color: var(--accent);
}

.qr-tab.active {
    background: rgba(45, 212, 255, 0.15);
    border-color: var(--accent);
    color: var(--accent);
    font-weight: 600;
}

.qr-form {
    display: none;
    margin-bottom: var(--space-lg);
}

.qr-form.active {
    display: block;
    animation: fadeIn 0.3s ease;
}

.qr-form label {
    display: block;
    color: var(--text-secondary);
    margin-bottom: var(--space-xs);
    font-size: var(--text-sm);
    font-weight: 500;
}

.qr-form input,
.qr-form textarea,
.qr-form select {
    width: 100%;
    padding: var(--space-sm);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-size: var(--text-base);
    margin-bottom: var(--space-md);
}

.qr-form textarea {
    min-height: 100px;
    resize: vertical;
    font-family: inherit;
}

.form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
    margin-bottom: var(--space-md);
}

@media (max-width: 768px) {
    .form-row {
        grid-template-columns: 1fr;
    }
}

/* Customization Panel */
.customization-panel {
    background: rgba(255, 255, 255, 0.02);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-lg);
}

.customization-panel h4 {
    color: var(--accent);
    margin-bottom: var(--space-md);
    font-size: var(--text-base);
}

.customization-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: var(--space-md);
    margin-bottom: var(--space-lg);
}

.color-picker,
.size-selector,
.ecc-selector {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
}

.color-picker input[type="color"] {
    width: 100%;
    height: 40px;
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    cursor: pointer;
    background: transparent;
}

.logo-upload {
    margin-top: var(--space-md);
}

.upload-area {
    border: 2px dashed var(--border-light);
    border-radius: var(--radius-md);
    padding: var(--space-xl);
    text-align: center;
    cursor: pointer;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-md);
}

.upload-area:hover {
    border-color: var(--accent);
    background: rgba(45, 212, 255, 0.05);
}

.upload-area span:first-child {
    font-size: 32px;
    display: block;
    margin-bottom: var(--space-sm);
}

#logo-preview {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding: var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
}

#logo-preview-img {
    width: 60px;
    height: 60px;
    object-fit: contain;
    border-radius: var(--radius-sm);
    border: 1px solid var(--border-light);
}

#remove-logo {
    padding: var(--space-xs) var(--space-sm);
    background: rgba(255, 77, 77, 0.1);
    border: 1px solid rgba(255, 77, 77, 0.3);
    color: #ff4d4d;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--text-sm);
}

/* Generate Button */
.generate-btn {
    width: 100%;
    padding: var(--space-md);
    background: linear-gradient(135deg, rgba(45, 212, 255, 0.2), rgba(45, 212, 255, 0.1));
    border: 1px solid var(--border-accent);
    color: var(--accent);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-base);
    font-weight: 600;
    transition: all var(--transition-fast);
    margin-bottom: var(--space-xl);
}

.generate-btn:hover {
    background: linear-gradient(135deg, rgba(45, 212, 255, 0.3), rgba(45, 212, 255, 0.2));
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

/* QR Result Styles */
.qr-preview-container {
    text-align: center;
    margin-bottom: var(--space-xl);
}

.qr-preview {
    display: inline-block;
    padding: 20px;
    background: white;
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-md);
    margin-bottom: var(--space-lg);
    min-width: 300px;
    min-height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
}

.qr-placeholder {
    color: var(--text-secondary);
    text-align: center;
}

.placeholder-icon {
    font-size: 64px;
    margin-bottom: var(--space-md);
    opacity: 0.3;
}

.qr-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
    gap: var(--space-md);
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
    padding: var(--space-md);
    margin-top: var(--space-lg);
}

.stat {
    text-align: center;
}

.stat-label {
    display: block;
    color: var(--text-secondary);
    font-size: var(--text-sm);
    margin-bottom: 2px;
}

.stat-value {
    display: block;
    color: var(--accent);
    font-weight: 600;
    font-size: var(--text-base);
}

/* Download Options */
.download-options {
    margin-bottom: var(--space-xl);
}

.download-buttons {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-sm);
}

.download-btn {
    padding: var(--space-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-xs);
}

.download-btn:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
    transform: translateY(-2px);
}

/* Analytics Section */
.analytics-section {
    background: rgba(45, 212, 255, 0.05);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}

.switch-container {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-md);
}

.switch {
    position: relative;
    display: inline-block;
    width: 50px;
    height: 26px;
}

.switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(255, 255, 255, 0.1);
    transition: .4s;
    border-radius: 34px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 18px;
    width: 18px;
    left: 4px;
    bottom: 4px;
    background-color: var(--text-secondary);
    transition: .4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: var(--accent);
}

input:checked + .slider:before {
    transform: translateX(24px);
}

.url-display {
    display: flex;
    gap: var(--space-sm);
    margin-bottom: var(--space-md);
}

.url-display input {
    flex: 1;
    padding: var(--space-sm);
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'SF Mono', monospace;
    font-size: var(--text-sm);
}

#copy-tracking-url {
    padding: var(--space-sm) var(--space-md);
    background: rgba(45, 212, 255, 0.1);
    border: 1px solid var(--border-accent);
    color: var(--accent);
    border-radius: var(--radius-sm);
    cursor: pointer;
    white-space: nowrap;
}

.analytics-stats {
    display: flex;
    gap: var(--space-lg);
    color: var(--text-secondary);
    font-size: var(--text-sm);
}

/* Batch Section */
.batch-section {
    background: rgba(255, 255, 255, 0.03);
    border-radius: var(--radius-md);
    padding: var(--space-lg);
    margin-bottom: var(--space-xl);
}

#batch-input {
    width: 100%;
    min-height: 120px;
    padding: var(--space-md);
    background: rgba(0, 0, 0, 0.3);
    border: 1px solid var(--border-light);
    border-radius: var(--radius-sm);
    color: var(--text);
    font-family: 'SF Mono', monospace;
    font-size: var(--text-sm);
    margin-bottom: var(--space-md);
    resize: vertical;
}

.secondary-btn {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    color: var(--text);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 500;
    transition: all var(--transition-fast);
}

.secondary-btn:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
}

.primary-btn {
    padding: var(--space-sm) var(--space-md);
    background: rgba(45, 212, 255, 0.1);
    border: 1px solid var(--border-accent);
    color: var(--accent);
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-weight: 600;
    transition: all var(--transition-fast);
    margin-top: var(--space-md);
}

.primary-btn:hover {
    background: rgba(45, 212, 255, 0.2);
}

.batch-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: var(--space-md);
    max-height: 300px;
    overflow-y: auto;
    padding: var(--space-sm);
    margin-top: var(--space-md);
}

.batch-item {
    text-align: center;
}

.batch-qr {
    width: 150px;
    height: 150px;
    background: white;
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto;
    border: 1px solid var(--border-light);
}

.batch-qr img {
    max-width: 140px;
    max-height: 140px;
}

.batch-label {
    font-size: var(--text-xs);
    color: var(--text-secondary);
    margin-top: var(--space-xs);
}

/* Share Temple */
.share-options {
    display: flex;
    gap: var(--space-sm);
    flex-wrap: wrap;
}

.share-btn {
    padding: var(--space-sm) var(--space-md);
    background: rgba(255, 255, 255, 0.05);
    border: 1px solid var(--border-light);
    color: var(--text);
    border-radius: var(--radius-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    gap: var(--space-xs);
    flex: 1;
    min-width: 150px;
    justify-content: center;
}

.share-btn:hover {
    background: rgba(45, 212, 255, 0.1);
    border-color: var(--border-accent);
}

/* Loading Animation */
.qr-loading {
    text-align: center;
    padding: var(--space-xl);
}

.spinner {
    width: 40px;
    height: 40px;
    border: 3px solid rgba(45, 212, 255, 0.3);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin: 0 auto var(--space-md);
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Error and Success Messages */
.error-message {
    background: rgba(255, 77, 77, 0.1);
    border: 1px solid rgba(255, 77, 77, 0.3);
    color: #ff4d4d;
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    animation: fadeIn 0.3s ease;
}

.success-message {
    background: rgba(57, 255, 20, 0.1);
    border: 1px solid rgba(57, 255, 20, 0.3);
    color: var(--success);
    padding: var(--space-md);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-md);
    animation: fadeIn 0.3s ease;
}

/* Responsive Design */
@media (max-width: 768px) {
    .qr-tabs {
        grid-template-columns: repeat(3, 1fr);
    }
    
    .qr-tab {
        min-width: 70px;
        padding: var(--space-sm);
        font-size: var(--text-xs);
    }
    
    .customization-grid {
        grid-template-columns: 1fr 1fr;
    }
    
    .download-buttons {
        grid-template-columns: 1fr 1fr;
    }
    
    .share-btn {
        min-width: 120px;
    }
    
    .batch-grid {
        grid-template-columns: repeat(2, 1fr);
    }
}

@media (max-width: 480px) {
    .qr-tabs {
        grid-template-columns: repeat(2, 1fr);
    }
    
    .customization-grid {
        grid-template-columns: 1fr;
    }
    
    .download-buttons {
        grid-template-columns: 1fr;
    }
    
    .share-options {
        flex-direction: column;
    }
    
    .share-btn {
        min-width: 100%;
    }
    
    .batch-grid {
        grid-template-columns: 1fr;
    }
}
</style>
